{"componentChunkName":"component---src-templates-post-js","path":"/posts/roez38wngtuk1gkg/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/roez38wngtuk1gkg","relativePath":"posts/roez38wngtuk1gkg","frontmatter":{"title":"网络应用防火墙（WAF）防机器刷流量的工作原理，以登录举例","stackbit_url_path":"posts/roez38wngtuk1gkg","date":"2023-04-20T13:07:52","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p>网络应用防火墙（WAF）可以保护网络应用，免受各种攻击。这些攻击包括但不限于跨站脚本攻击、SQL注入攻击、Cookie污染等等。对于访问量特别大的应用，最要防的是机器人流量。这些流量哪怕并不直接攻击，但是会占用服务器资源，导致不能正常响应真实人类用户的请求。比如，电商的爆品，在某一时刻开启购买，就得防止技术黄牛的流量。</p>\n<p>这具体怎么做呢？一般都是购买了 WAF 来完成这件事。各大云厂商（阿里云盾、AWS CloudFront）、CDN 服务商（Cloudflare、Akamai）等都提供这种 WAF 服务。由于流量在到达真正的服务之前，会被 CDN 和 WAF 连接器进行过滤，就可以有效防止机器人刷流量。以下是用登录场景做为例子的一个序列图：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8035f723db79c6207ebe44c47ab8f646/11b93/1681995775132-2c258784-cb0c-44d8-8947-e753afe5ccd7.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 120.94594594594594%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,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'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/8035f723db79c6207ebe44c47ab8f646/fcda8/1681995775132-2c258784-cb0c-44d8-8947-e753afe5ccd7.png\"\n        srcset=\"/static/8035f723db79c6207ebe44c47ab8f646/12f09/1681995775132-2c258784-cb0c-44d8-8947-e753afe5ccd7.png 148w,\n/static/8035f723db79c6207ebe44c47ab8f646/e4a3f/1681995775132-2c258784-cb0c-44d8-8947-e753afe5ccd7.png 295w,\n/static/8035f723db79c6207ebe44c47ab8f646/fcda8/1681995775132-2c258784-cb0c-44d8-8947-e753afe5ccd7.png 590w,\n/static/8035f723db79c6207ebe44c47ab8f646/efc66/1681995775132-2c258784-cb0c-44d8-8947-e753afe5ccd7.png 885w,\n/static/8035f723db79c6207ebe44c47ab8f646/11b93/1681995775132-2c258784-cb0c-44d8-8947-e753afe5ccd7.png 1124w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>其中授权服务，比如之前介绍过的 Keycloak、Duende IdentityServer 等，是多个应用依赖的服务，如果不被保护，裸奔在网络上，很容易被机器人流量挤爆，影响所有系统的登录。</p>\n<p>可以看到 WAF 会在原始的 html 请求里添加一些脚本，来收集浏览器指纹信息，并对流量做过滤。对于识别出的机器人流量，会在打到授权服务前被拦截阻止，达到保护认证服务的目的。</p>\n<p>最后，附上这个序列图的源码（使用 mermaid js 画的）：</p>\n<p>sequenceDiagram\nautonumber</p>\n<p>participant UA as 用户\nparticipant C as CDN\nparticipant AS as 连接器\nparticipant RS as 授权服务</p>\n<p>activate UA\nUA ->> RS:  GET id6.azurewebsite.net/login\nnote left of UA: 用户请求授权\nRS -->> UA: html</p>\n<p>UA ->> C: GET /obfuscated\nC ->> AS: GET /v6/challenge/APIKEYID\nnote left of UA: 页面上包含了一段脚本，<br />对用户进行进行验证\nAS -->> C: JavaScript challenge 代码\nC -->> UA: JavaScript challenge 代码</p>\n<p>UA ->> C: POST /obfuscated\nC ->> AS: POST /v6/challenge/APIKEYID\nnote left of UA: 浏览器上传自己的指纹<br />并请求令牌\nAS -->> C: 令牌\nC -->> UA: 令牌\nnote left of UA: 存储令牌到 Cookie 中\ndeactivate UA</p>\n<p>alt 生物人\nactivate UA\nUA ->> C: POST /api/v1/account/login\nC ->> AS: POST /v6/challenge/APIKEYID\nAS -->> C: 允许访问，放行\nC ->> RS: POST /api/v1/account/login\nRS -->> UA: 200 OK\ndeactivate UA\nelse 机器人\nactivate UA\nUA ->> C: POST /api/v1/account/login\nC ->> AS: POST /v6/challenge/APIKEYID\nAS -->> C: 拒绝访问，阻止\nC -->> UA: 403 Forbidden 禁止访问\ndeactivate UA\nend</p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}}}},"staticQueryHashes":[],"slicesMap":{}}