{"componentChunkName":"component---src-templates-post-js","path":"/posts/va02icumaumqfsih/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/va02icumaumqfsih","relativePath":"posts/va02icumaumqfsih","frontmatter":{"title":"Pulumi 惊艳到我了（还可以无限免费薅 AI 羊毛）","stackbit_url_path":"posts/va02icumaumqfsih","date":"2024-03-01T12:18:15","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p>做为程序员，总想着将一切变成代码，于是有各种 xxx as code 方案。就连画图，都喜欢用代码来完成，于是就有了 diagram as code，我以前在《<a href=\"%5Bhttps://zhuanlan.zhihu.com/p/389745846%5D(https://zhuanlan.zhihu.com/p/389745846)\">使用 tplant 快速概览代码的领域模型 - Jeff Tian的文章 - 知乎</a> 》里提到过一些相关的内容。<br />这还没完，我们还希望将密码都放在代码仓库里！Secret as code。当然，肯定不能明文存储，所以 SOPS 是一个非常好用的工具，让我们可以使用 git 来跟踪密码的变化，详见《<a href=\"%5Bhttps://zhuanlan.zhihu.com/p/351520284%5D(https://zhuanlan.zhihu.com/p/351520284)\">加密 Kubernetes 集群中的敏感信息 - Jeff Tian的文章 - 知乎</a> 》。<br />这样就够了吗？没有！我们还希望能够将基础设施也通过代码来完成分配并对其变化使用 git 跟踪，所谓 GitOps，或者 Infrastructure as code，简称 IaC。<br />IaC，你们是怎么做的呢？欢迎留言分享。<br />我先说我们是怎么做的。<br />一开始比较土，使用 shell 或者 PowerShell 脚本来完成，这是一种纯命令式的做法，一边改脚本一边实际验证，来来回回非常麻烦。头不只一个大。<br />后来使用 Terraform，以及主要用了 AWS 云，所以用了 Cloudformation。这是一种声明式的做法，虽然好了很多，但是在自动化测试方面差了点。而且，写声明文件也比较乏味，毕竟不是在做“编程”工作，而是像在十几年写 HTML 一样的。严格来说，HTML 只是一种标记语言而并不是编程语言。<br />最近呢，团队经过多种方案比较，最终选择了使用 Pulumi 来做 IaC。虽然还不太懂，但体验下来还是很惊艳的，主要在以下几个方面。\n<a name=Poxqj></a></p>\n<h1>Secret as Code 比 SOPS 更香</h1>\n<p>详见《<a href=\"%5Bhttps://zhuanlan.zhihu.com/p/351520284%5D(https://zhuanlan.zhihu.com/p/351520284)\">加密 Kubernetes 集群中的敏感信息 - Jeff Tian的文章 - 知乎</a> 》，我了解到 SOPS 之后，就用在好几个实际的项目中了。但是用多了之后，发现一个很大的问题，就是经常在提交代码之前，会忘记加密码加密，导致提交了明文到代码仓库。虽然有一些办法可以规避，但是却留下了犯错的空间。<br />用 Pulumi，没想到可以不使用 SOPS。它有和 SOPS 同样的功能，即会对代码里的密码加密，而不是保存明文。但是用起来比 SOPS 更简单，并且没有犯错空间。因为它提供了获取明文密码的其他方式，而不是在文件里显示它。\n<a name=y3kIa></a></p>\n<h1>自动化测试</h1>\n<p>没想到 IaC 也可以像写业务代码一下，写自动化测试了！就是说，你也可以在 IaC 项目中进行 TDD 了！<br />比如，你在 secrets.json文件里定义了这样的密码信息：\njson\n{\nsecrets: [\n{\npulumiSecretName: rds-credentials,\nawsSecretName: /rds/{env}-{region},\ncreateAwsSecret: true,\nkmsKeyIdOrAlias: null,\nkeys: [\n{ name: username, value: master, configKey: null },\n{ name: password, value: null, configKey: rds-password }\n],\ndescription: Secret storing credentials to RDS used by human users to access the database,\ntags: {\nfrom: passwordstate,\n}\n},...]\n}</p>\n<p>以上的密码定义中，我们添加了一个 tag。你在真正部署到线上环境前，可以通过自动化测试来验证最终生成的资源包含了预期的 tag：\ncsharp\n[Theory]\n[ClassData(typeof(StackTestData))]\npublic async Task Should_CreateSecretsWithProperTags(string stackName)\n{\n// act\nvar resources = await RunDeployment(stackName);\nvar names = GetService<ManagedSecretsResourceNames>();</p>\n<pre><code>// assert\nvar secrets = resources.OfType&#x3C;Secret>().ToList();\nvar expectedSecretsCount = Config.SecretsConfig.Secrets.Count * Config.DeploymentEnvironment.Environments.Count;\nsecrets.Count.Should().Be(expectedSecretsCount);\n\nforeach (var secret in secrets)\n{\n    var secretName = await secret.Name.GetValue();\n    // ignore created secrets for different environments\n    if (!secretName!.Contains(Config.DeploymentEnvironment.CurrentEnvironment.Name))\n    {\n        continue;\n    }\n\n    var secretConfig = Config.SecretsConfig.Secrets.Single(x => names.SecretName(x.AwsSecretName) == secretName);\n\n    var secretTags = await secret.Tags.GetValue();\n    secretTags.Should().NotBeNull();\n    foreach (var tag in Config.DefaultResourceTags)\n    {\n        secretTags.Should().Contain(secretTag => secretTag.Key == tag.Key &#x26;&#x26; secretTag.Value == tag.Value);\n    }\n\n    foreach (var tag in secretConfig.Tags)\n    {\n        secretTags.Should().Contain(secretTag => secretTag.Key == tag.Key &#x26;&#x26; secretTag.Value == tag.Value);\n    }\n\n    secretTags.Should().Contain(secretTag => secretTag.Key == pulumi-secret-name &#x26;&#x26; secretTag.Value == secretConfig.PulumiSecretName);\n}\n</code></pre>\n<p>}</p>\n<p><a name=Boobu></a></p>\n<h1>彩蛋：意想不到的 AI 功能</h1>\n<p>团队决定使用 Pulumi 的 C# 版本，这让我有点畏难。不过我发现 Pulumi 提供了 AI 功能，凡是不懂的，我就问它。从 AI 的引导来看，它专注于写代码，写得实在太靠谱了，没有让我在团队中露陷（35+ 岁了还没被开除）。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b9895e6ea208dfbd803b639687e02630/2b727/1709295126284-3d3d1463-a5ae-43d7-bab8-bb853fb2cccf.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 57.432432432432435%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAACdklEQVR42k2SWW/TUBCF84xQGztus9RLHCeN4yR2vCZNanejbbrSsr0gxAsvSCUJbUmgiD+AEH/5Q3Zb4OFo5l5pPp2jmdzs8zXTyYzpdMZkMuP2ZsHVpymfJjNmn2+Yzq65vvnCz1+/ufv+g9vbOfP5NxZfv7NY3DFf3PFl/pX54hs3kyk5SVqhUbdwvYROd4Bluei1FlW9SbW6TlU3qTc6HBye4/Qi1ps2mqajyAqyrKAoKrIsoygKq8USuUJBolypomot1mQDQZAQxRVE8b5K0mrWP3nyFEEoIElF0hlVq1JvNEgNCYKY/aV9Ln2oqorn+5mCICQII6JogOv6mGYLPwgZDkdYVhvDqGeA/b093r19x3AY/wWmyoCKqtFzfXo9j07XyeQ4Li2rg9mysJ0eruej1wyMeiMbPDs+4urjFScn5w/O01QFckI+j1ZvEu+PiTcT/CAijAb0BxuZsxRutbuZ2h2b/mCIomisrBSprMkUSyXKFZViSb4H5pfz6OsmybNn7O5sEycJo1FMnGwx2owJggin52UJ0mo7LuXKGrWaQbdr02yarMkKxWLpAZgXqOoGXn+AH7rYjoPVsbHa92rbDh27R9fuZbAUWqnIlMsqqtZAlnVWV4v/IqfAhtEgjrfZ3dljb2efJE5IkpjRaIOtfszmxogw6uP6AV4QIisaklSiVE5PpYIoihksW8rS8jK21eXF5WvGR6dcPH/J+OiYw6MxBweHvB684WTnlPPxJe9PPvD+7ANNo8XS8hIFsZDBHjd871AQMDSdyI/wvRC7Y5N42/TtIabZzra8bppE1gYX4SvOwpdolRrp3P+gx7P5A/EHVOaBLuBmAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"WX20240229-142711@2x.png\"\n        title=\"WX20240229-142711@2x.png\"\n        src=\"/static/b9895e6ea208dfbd803b639687e02630/fcda8/1709295126284-3d3d1463-a5ae-43d7-bab8-bb853fb2cccf.png\"\n        srcset=\"/static/b9895e6ea208dfbd803b639687e02630/12f09/1709295126284-3d3d1463-a5ae-43d7-bab8-bb853fb2cccf.png 148w,\n/static/b9895e6ea208dfbd803b639687e02630/e4a3f/1709295126284-3d3d1463-a5ae-43d7-bab8-bb853fb2cccf.png 295w,\n/static/b9895e6ea208dfbd803b639687e02630/fcda8/1709295126284-3d3d1463-a5ae-43d7-bab8-bb853fb2cccf.png 590w,\n/static/b9895e6ea208dfbd803b639687e02630/efc66/1709295126284-3d3d1463-a5ae-43d7-bab8-bb853fb2cccf.png 885w,\n/static/b9895e6ea208dfbd803b639687e02630/c83ae/1709295126284-3d3d1463-a5ae-43d7-bab8-bb853fb2cccf.png 1180w,\n/static/b9895e6ea208dfbd803b639687e02630/2b727/1709295126284-3d3d1463-a5ae-43d7-bab8-bb853fb2cccf.png 3392w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><br />更棒的是，虽然界面上看它好像只会写代码，但其实这个 AI 可以做任何事情。比如我看到不认识的英文，就让它翻译：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2ba40e1e96bccf4096e629f9a49251f4/683cf/1709295278789-1b92d1d0-2ef4-4e1e-a5da-e4b931051e15.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 59.45945945945946%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAACi0lEQVR42mWSy3IbVRCG9QBOoZk5Go+kM/f7TXcbW7Js4VJi5+YF3rCERSoLWLBlAW8BhQXGl4SwSRY84UfNUeIqKou/uqtP1dd/d5/W1eaa36+2utr8xeaPG379baPi9c0b/ry+4/b+He8//Mv9m3+4uX3L7d3fqnZ3/05FVbt/y+3VhpYtJVkc4/s+SZySJjm2tJWktOn1eqRpxsuLC+qqJgxDkiQhiiLiOFba1lJcz6fV7dm4XoZtR0g7wrIkhiEQovMgXTfY2XmEpukPb54fEMWJavqp1umYtIQwsR0fzw9xvQDH9ZG2g227SNvFdlzVuQE0eV/aqsGgHrCYLwiCSAE/qSUMQRonVEVJkeUqlnlBVVQqz5KUwA0IPB+nWcGuhdbW+Obykl9++pnvvn2FaZq029oWaAvBIMuY1AOGRcGoKBmXFdN6wKgsGZUVo0lMlSTUacG4yPF2d9U0VVUTBCG9vkOv5yrnLSkEVZwwzAvqNGWQ5Qo8yHOlKs6ZLSMOnkeM6pLU8ekbOo7rEccJQRDQ7fYxd7tboGgcVjWT8YTxcMRsMlP5bDJlOp6qOK6mTA5q9p9mZFWI0E3lMEkKwnB7GMv6CDSMDlI6uI6H5/p4XoDbHKbffBlJ35V0mh09MjCEoJtpmI6GZTn0ZUC35ymQ/vEHtIQuOD484nx9znq15mx9zslyxfxgwWLviGfJC473ViwOl8z3liz2T4gKH83QMHTxvwsrh5ZpsTg44qv1Gccnp6xO15yePOFoueJwvuR09pgvD+dcHH/N92c/8vrsByIn44t2+wHS6AHYESaxFzKshhRJThkXzPM5VTTAVyvw8Ryf2EsZFzOG+ZSuJdF0/TN3zcj/Aayxcp463OzWAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"WX20240229-142802@2x.png\"\n        title=\"WX20240229-142802@2x.png\"\n        src=\"/static/2ba40e1e96bccf4096e629f9a49251f4/fcda8/1709295278789-1b92d1d0-2ef4-4e1e-a5da-e4b931051e15.png\"\n        srcset=\"/static/2ba40e1e96bccf4096e629f9a49251f4/12f09/1709295278789-1b92d1d0-2ef4-4e1e-a5da-e4b931051e15.png 148w,\n/static/2ba40e1e96bccf4096e629f9a49251f4/e4a3f/1709295278789-1b92d1d0-2ef4-4e1e-a5da-e4b931051e15.png 295w,\n/static/2ba40e1e96bccf4096e629f9a49251f4/fcda8/1709295278789-1b92d1d0-2ef4-4e1e-a5da-e4b931051e15.png 590w,\n/static/2ba40e1e96bccf4096e629f9a49251f4/efc66/1709295278789-1b92d1d0-2ef4-4e1e-a5da-e4b931051e15.png 885w,\n/static/2ba40e1e96bccf4096e629f9a49251f4/c83ae/1709295278789-1b92d1d0-2ef4-4e1e-a5da-e4b931051e15.png 1180w,\n/static/2ba40e1e96bccf4096e629f9a49251f4/683cf/1709295278789-1b92d1d0-2ef4-4e1e-a5da-e4b931051e15.png 3322w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><br />看到没？不仅可以翻译，甚至比其他我试过的 AI 都更加贴心：那就是给予了非常多的解释，并且还标注了汉语拼音！<br />当然，英语不好也是可以直接使用它的，因为它也会中文：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e8b79ea928c8d72fdd2b856fb5476b02/53948/1709295322391-9926273e-ca81-43eb-8840-6ab91212fd19.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.64864864864865%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB4ElEQVR42m2RSW7bQBBFeQJZM8lmcyZFDaQ4U6IsJE7sbYAERpBbGLn/5hndkZUssvj41V1VvybjNAyM48gwDAzDict4oe962rblcnnker1SliXH41+ot0JRFDRNy/XTZ749PelcozjknPqB4lhSVx3n0yNFXpKmKV++vvD29pvn5xe6rud8HnVRxeN4oW07XbQsK/rTWRczHMcljGLCMCaOE+I4JU0zpPQwTZP12sQ0Lc3/QggH1/VwHIltC8y1iWXZGPP5guVyxWKx1PyRoN7K9z/MZnN8PyTPC3a7vY5Xf8pnrNc2lu1iCx/LknchxYvF6oblHaqoSk7iRI+/3x+wbefuN5SQ625wnBhbBEynMx4epppns9mN53dWf5PJlL5p+fX6kx/fXxnHK5PJwx9B1e5mk932l5BlW7Jsp+0oijWCICRJNvhBqH2r1RopJdvtVserfa5W5q1DW9C0PXXdUtUtddNRFKU+ku8HeJ6vl/9hK6hOPT8hSQ9aTB1QOB7z+RLDsgXFsWK72+NIF+FI3YEtHDw/wPV8hJRIz0O6nhZQ4wdBxG530EdRE3zs3XCF5FR39FVHU9S0ZUtzbDSqvKLKa+qsocpqyryhKXssU2iRTbYlihLCMNJTqIO9AymuGSPaVb4rAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/e8b79ea928c8d72fdd2b856fb5476b02/fcda8/1709295322391-9926273e-ca81-43eb-8840-6ab91212fd19.png\"\n        srcset=\"/static/e8b79ea928c8d72fdd2b856fb5476b02/12f09/1709295322391-9926273e-ca81-43eb-8840-6ab91212fd19.png 148w,\n/static/e8b79ea928c8d72fdd2b856fb5476b02/e4a3f/1709295322391-9926273e-ca81-43eb-8840-6ab91212fd19.png 295w,\n/static/e8b79ea928c8d72fdd2b856fb5476b02/fcda8/1709295322391-9926273e-ca81-43eb-8840-6ab91212fd19.png 590w,\n/static/e8b79ea928c8d72fdd2b856fb5476b02/efc66/1709295322391-9926273e-ca81-43eb-8840-6ab91212fd19.png 885w,\n/static/e8b79ea928c8d72fdd2b856fb5476b02/c83ae/1709295322391-9926273e-ca81-43eb-8840-6ab91212fd19.png 1180w,\n/static/e8b79ea928c8d72fdd2b856fb5476b02/53948/1709295322391-9926273e-ca81-43eb-8840-6ab91212fd19.png 2720w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><br />最最关键的是，不像 OpenAI 的 ChatGPT，也不像其他很多国外的 AI 助手，不让国内用户访问，它是可以<strong>直接从国内访问的！</strong><br />另外一个令人发指的彩蛋就是：<strong>不需要登录</strong>即可使用！这你敢信？<br />最后，它没有任何限额限制！这真是大方到家了，我用了差不多一个月了，从没拒绝过回答我的问题！连登录都不用，更别说收钱了。<br />一个字：绝！</p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}},"menus":{}}},"staticQueryHashes":[],"slicesMap":{}}