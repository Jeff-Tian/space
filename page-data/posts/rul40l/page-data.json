{"componentChunkName":"component---src-templates-post-js","path":"/posts/rul40l/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/rul40l","relativePath":"posts/rul40l","frontmatter":{"title":"在小程序里接入 GraphQL","stackbit_url_path":"posts/rul40l","date":"2021-10-03T12:09:46","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p><a name=CNqB0></a></p>\n<h1>背景</h1>\n<p>在前几篇文章里，一直在讲 GraphQL。分别是：</p>\n<ul>\n<li>《<a href=\"https://zhuanlan.zhihu.com/p/412196725\">一顿操作猛如虎，部署一个万能 BFF</a>》，利用 Gatsjs 开发用的 GraphQL 服务器，结合其丰富的数据源插件，部署了一个几乎万能的 BFF 层。</li>\n<li>《<a href=\"https://zhuanlan.zhihu.com/p/415577362\">使用万能 BFF，将语雀文章 GraphQL 服务化</a>》，万能 BFF 层的实例，利用现有插件，直接把语雀的服务 GraphQL 化了。</li>\n</ul>\n<p>BFF 是 Backend For Frontend 的简称，是为前端服务的后端。要发挥真正的用处，还得通过前端体现。现在就给个实例，讲解如何在小程序里集成万能 BFF。</p>\n<p>前端主要有 Web、小程序以及 Native App 等。要在前端集成 GraphQL，一般采用 Apollo Client。为什么本文选择小程序作为例子呢？因为小程序是中国特色，国外没有。对于如何在 Web 端或者 Native App 端集成 GraphQL，只需要按照 <a href=\"https://www.apollographql.com/docs/\">https://www.apollographql.com/docs/</a> 官方文档的指导去做即可。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4e9761248e9b8a506a2c24e4236d9735/d8fc6/1633257522698-d87487fc-eb23-4fa5-8db7-6a4bbf88f02a.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 54.05405405405405%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB8UlEQVR42lWT227cIBRF/f9fV6kveUg7yUwz9thgc8eYy2rNRGmLtCWE4GjvdQ5DOg5ijAi5cR8npseMXDdcCHgf8SGitMEqSfIObwwheNSoicoQYsQYi1aKI1gG6xzOBYzKlEJfrUEDjEtoG3A+4kIi7pkQD9JRqK1R6v/KpTGEcCBl6JePnPE+4X2mHQlx/cX09sZ0uSBuN4rRVO/I1pKNoVj9PHOG5i3NO4azmPcHrbWnausuo9h4+TYjFoFcBMtjJoQIdmV8ufPzVSDFzDzNWK05UuJQK4O1nk1prHW94DMsFGtIe2aRCiF1v7MaRxQz1RjcnnksG5s2qPP8yCStGbSxzItg3VTncgI8S54xICNnz3z31OMJuGwS7EbNmftFI0ZHNBFqpVnNkHMhxp1S6mdDng6z2rCXG/52w75fCb9u5McIy0gUCt+1EqSC4CH6zndwzrGuG1obvA9fDqPcePm+8HEfGceJ6/WDxyKpwTC+G15/rEzLA7EpjAvoExkw+BB63H1PfxvTI9vOU64ebSLnvPo9EY2BcrCnxOMh0Np2I6fOt8O5kavqw5nS8VWw6A1SRC2OdXLksEMtnVNLO7lUPm4Oow/+XcM5Cmdjzt9wsuSzzzWG7rIFR3G262RUremFa214lzv7r2R/HP4GKgRSRl0A228AAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/4e9761248e9b8a506a2c24e4236d9735/fcda8/1633257522698-d87487fc-eb23-4fa5-8db7-6a4bbf88f02a.png\"\n        srcset=\"/static/4e9761248e9b8a506a2c24e4236d9735/12f09/1633257522698-d87487fc-eb23-4fa5-8db7-6a4bbf88f02a.png 148w,\n/static/4e9761248e9b8a506a2c24e4236d9735/e4a3f/1633257522698-d87487fc-eb23-4fa5-8db7-6a4bbf88f02a.png 295w,\n/static/4e9761248e9b8a506a2c24e4236d9735/fcda8/1633257522698-d87487fc-eb23-4fa5-8db7-6a4bbf88f02a.png 590w,\n/static/4e9761248e9b8a506a2c24e4236d9735/efc66/1633257522698-d87487fc-eb23-4fa5-8db7-6a4bbf88f02a.png 885w,\n/static/4e9761248e9b8a506a2c24e4236d9735/c83ae/1633257522698-d87487fc-eb23-4fa5-8db7-6a4bbf88f02a.png 1180w,\n/static/4e9761248e9b8a506a2c24e4236d9735/d8fc6/1633257522698-d87487fc-eb23-4fa5-8db7-6a4bbf88f02a.png 2052w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>采用小程序作为例子，不仅弥补了官方文档的空白，而且由于小程序的一些限制，在集成 GraphQL 的过程中，还面临一些额外的挑战。因为更困难，所以更加符合本专栏（哈德韦，即 Hard Way 的音译）的初衷。</p>\n<p><a name=rvtHw></a></p>\n<h1>最终成果演示</h1>\n<ul>\n<li>Web 版： <a href=\"https://taro.pa-ca.me/\">https://taro.pa-ca.me/</a></li>\n<li>微信小程序（体验版）： <br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 472px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cbef713d4f7d43cdc2a6862497f6e989/c6f8e/1633264280024-9d767294-7d06-49e6-83bc-1f101f827c4b.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsTAAALEwEAmpwYAAAEcUlEQVR42j2U3U/aDBTG+Uv2B+zCxKsl3mCciRsh6JjG4EaRQJkMSm0VLRYo0rWkFAiWCVTAoaJOps6vbbrsK2TJluzGa+Od0aF8qWgFg3Qvbnmf+995npyT80jq9XqhUCgWi6VS6fT09PDwsFqtiqJYqVRyudz5+Xm5XK7VaicnJ4IgVCoVQRDy+XyhUKjX65JisWi1WgcGBlZWViKRCEVRHz58CAaDHMfF4/G1tTWCIEKhkMlkGh8fZ1n2zZs3JpNpdHS0UChISqUSiqIAAIRCoaGhoc3NTQzDOjs729vb5XK5xWKRSqXRaBQAABAEURTd3t7u6ekxm82np6eSSqVC0zRBEJOTk2azGcOwVCrFsuzCwoLb7e7t7W1ra4vFYh6Ph6Zpm822tbX18uXLZDLZcK5Wqz6f7+HDhxRFaTSagYEBlmV3d3e/fPnS19dHUZRarQ6Hw0qlcnFx0e/3u93uQCCQyWRyuZykXq9PTEzEYjGapjs6OnQ6nUwm83g8P3/+9Hq9JEl++vRJr9cPDg4iCBIKhSKRSDAY/P79+/X1tUQURbVaPT8/n0qlhoaGGIbZ2dlxOBytra3t7e0ejweCII1GMz4+TtO0xWJZWlpyuVwkSQqC0IATiQSO4yzL7uzsuN3urq4uhmHkcvnTp085jkskEhqN5vHjx/F4HEGQ58+fAwCQyWRubm4kx8fHqVQKAIC5uTmn06lSqVwuF8MwDx48WF5enpmZ4Xne6/VarVae51taWmAYHhkZ8fv91WpVUqvVEokEDMN2ux2G4bW1NbPZrNfrWZaFYbinp0epVE5PT7e1tRkMhidPnpAkqVKprFbrP1gqld6/f5/jOJ7n/X5/f3+/TCZTKBR6vT4cDvM8b7fbOzo6DAZDOp3GcdxoNCII0jiVKIpfv35lWZam6dnZ2ebmZp1Op1AotFqt0Wi8c+cOCILPnj1zOBzT09M8zxMEodfr7Xb75eVlA97Y2IjFYgzDeDweAAD6+vpGR0c3Njb29vbwW83Pz9M0/erVq2g0iuP42NiY3W5vxBZF0e/322y21dXVFy9evH37tqWlBQTB9+/f8zwfj8eDwSAEQSAIQhBEkiSGYSiKvnv37p+zwWD4O9Lr9X779k2n0xmNRovFYjKZkslkd3c3iqI4jiMI0tnZqdVq7927x7KsKIqScrlMkmTiViAIfvz4cWpqSi6XRyKRqakpn89HUVQgEPj8+XMqlXr06BEEQQaDgWGYs7OzxrbT6fTS0pLX6717965CoVDf6vXr1w6HgyCI7e3tcDgcjUbT6TTHcU6nk2GYubm5crnceEkYhgEAQBBkcnKSoqi//MLCgs/ngyAIw7CxsTEURVdWVjiOc7lcVqv1169fjdjFYnFkZGRwcHBiYoKm6a2trfX19f39fQzDksmkz+drampyOBwqlWp4eFgmkymVSpvN9uPHjwb8t4by+bwgCEdHRwcHB8Vi8fr6OpvN/t9E2Wz24uLi6urq5OTk9+/fZ2dnoij+V0N/AGJ3vkMyC/B6AAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"basicprofile.jpeg\"\n        title=\"basicprofile.jpeg\"\n        src=\"/static/cbef713d4f7d43cdc2a6862497f6e989/c6f8e/1633264280024-9d767294-7d06-49e6-83bc-1f101f827c4b.jpg\"\n        srcset=\"/static/cbef713d4f7d43cdc2a6862497f6e989/a80bd/1633264280024-9d767294-7d06-49e6-83bc-1f101f827c4b.jpg 148w,\n/static/cbef713d4f7d43cdc2a6862497f6e989/1c91a/1633264280024-9d767294-7d06-49e6-83bc-1f101f827c4b.jpg 295w,\n/static/cbef713d4f7d43cdc2a6862497f6e989/c6f8e/1633264280024-9d767294-7d06-49e6-83bc-1f101f827c4b.jpg 472w\"\n        sizes=\"(max-width: 472px) 100vw, 472px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><br />可以微信扫码打开小程序体验版（由于还没有发布，因此只能以体验的形式），申请体验。我看到申请请求后会第一时间通过，有 100 名的限制哦，如果因为人数超限不能体验，那么请等待我的下一篇文章，如果哈德韦微信小程序正式发布上线，我会再发文通知大家。</li>\n</ul>\n<p><a name=CAFR0></a></p>\n<h1>项目源代码</h1>\n<ul>\n<li><a href=\"https://github.com/Jeff-Tian/weapp\">https://github.com/Jeff-Tian/weapp</a></li>\n</ul>\n<p><a name=uWdZq></a></p>\n<h1>Taro Js</h1>\n<p>尽管这里只做了微信小程序，但是采用了多端统一开发框架 Taro Js，从而可以打包到不同的平台。</p>\n<p><a name=Klsy5></a></p>\n<h1>挑战一：在小程序里生成 Apollo Client 实例</h1>\n<p>基本可以参考官方文档的 React 示例，但是对于小程序，却不能照搬。如果只做 Web 端，可以完全参考官网文档的 React 示例，只需要传入一个 GraphQL 服务的 url 即可。但是对于小程序，只穿 url 会报错，原因是，对于小程序，缺少默认的全局 fetch 函数，因此在生成 GraphQL 客户端实例时，要额外传递自定义的 fetch。当然，对于使用了 Taro js 的项目，只需要将 Taro.request 封装一下就好。</p>\n<p>从而最终的 GraphQL 客户端实例的生成是这样的：</p>\n<p>typescript\nimport {ApolloClient, HttpLink, InMemoryCache} from @apollo/client\nimport Taro from @tarojs/taro</p>\n<p>export const client = new ApolloClient({</p>\n<p>link: new HttpLink({\nuri: <a href=\"https://uniheart.pa-ca.me/proxy?url=$%7BencodeURIComponent(https://jqp5j170i6.execute-api.us-east-1.amazonaws.com/dev/gatsby/graphql)%7D\">https://uniheart.pa-ca.me/proxy?url=${encodeURIComponent(https://jqp5j170i6.execute-api.us-east-1.amazonaws.com/dev/gatsby/graphql)}</a>,</p>\n<pre><code>async fetch(url, options) {\n  const res = await Taro.request({\n    url: url.toString(),\n    method: POST,\n    header: {\n      content-type: application/json\n    },\n    data: options?.body,\n    success: console.log\n  })\n\n  return {text: async () => JSON.stringify(res.data)} as any\n}\n</code></pre>\n<p>}),\ncache: new InMemoryCache()\n})</p>\n<p><a name=wTsRo></a></p>\n<h1>挑战二： 允许小程序访问 GraphQL 服务</h1>\n<p>从上面的代码中可以看到这个 URL： <a href=\"https://jqp5j170i6.execute-api.us-east-1.amazonaws.com/dev/gatsby/graphql\">https://jqp5j170i6.execute-api.us-east-1.amazonaws.com/dev/gatsby/graphql</a>，这就是上一篇文章《<a href=\"https://zhuanlan.zhihu.com/p/415577362\">使用万能 BFF，将语雀文章 GraphQL 服务化</a><br />》的最终成果，它将语雀博客作为数据源，通过 AWS lambda 暴露成为一个 GraphQL 服务。而这个长长的 URL <br /><a href=\"https://jqp5j170i6.execute-api.us-east-1.amazonaws.com/dev/gatsby/graphql\">https://jqp5j170i6.execute-api.us-east-1.amazonaws.com/dev/gatsby/graphql</a> 就是利用 serverless 自动创建的 AWS API Gateway 的默认 URL。</p>\n<p>直接使用 Taro.request 访问它，在打包成为小程序后，执行到这里就会报错，原因是没有把这个域名配置在白名单里。</p>\n<p>这可以尝试通过小程序后台配置 request 合法域名解决：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/caf2eb9c531bf918ff2e2e3f92063f4f/c3fd4/1633260950771-8a09d7fe-c8e7-4ab8-9dec-6c90b17e3a82.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 110.8108108108108%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsTAAALEwEAmpwYAAADi0lEQVR42p2UbWsjVRiG88v8AX4QxcXFIrJ18aVq07xMZpJ5T9NCF7KsrYuyTVr8ol9EaFq1bdqkdfGziCAu3YXCKhYWxXazmcnMJHPJOZNJ29WVxQM3Zzhznmvu+5k5k6kXstzIzbCo5FjOvc/N/CyWaaBaNpVKBdMwME3zmTJME8uysG0b07LIWIaOUcjjqgq2XqGen+WzmWvcmn0PRdUoWXYCFfsM47JME103JkDLtsmUdZ1SuUzFtNBNUzqzDYM72Xf54u0plvMfUrYdNMfFuuAqlXBlmAa6kYAzYrGoKKialmwydLmpUp3HURXWrk/x1VtX+biYpVKtYVTncW0Lx7axbQfHcSTIMhOXmYpwqKqIWUYQ8SwLRzzZsihXa9zQSnx5/Sqt6SvcKuUozy9guFVcKwEnTs0EWK5UJDCNkALFTV3XcUWB46I6Lh8Vs3z75stsXXuVulZEqy1iVGtoepmyWU6AApLGFSAh0VzXdaVEJCHXsdHnaxjzNVbnZjicepGvp6+wrMxRrS6wUF3EssaRC8Ui2bk5lFJJ9lPM+XyeXC5HqVRCURQ5l8SsKGS1Cjm1zOdvvMLBSy/wzuw0r3/wGpqukhFxl1dWaO/tsb29zX6nQ/fggHa7ze7uLt1ul45Y63YTiev9fTqdLu2739M9vMtWewPnpoGiFcnM5XK0NjcRw/M8/u847HyHqmpk8oUCGxsbcnE0GhHHEMexVBRFBEHAcDjECz3+8k/xQ1/uSyXuibG9s42qqmRE/1qtllwUxb2zM/q9Hv2+xxMvYDAICMNQ3vP9AG8ssT4YDCZA0Z4EWCjQ2toCYryff+Txg3t4x/d5/NMPnD16RAwSKNwOhyMGQQIajeKJy8vA4jkwuP8Lwe+/Ep38RvDgHk/+/GPiXABFsYALpW35F+B55CgMGTzpEfk+wzBkFMcy0unpGb1ebxLvYp//EygKRKQwiuh7HicnJ7Lg6OiI4+Njomg4AT2fwyiaRBLXaRHjPoZhJN2J/iWw5wTG46hBEI6VvIj0rZ67ewZw4wJQfNzpN+j7Pr6XqN/vSz0dOwXu7OzI43nJYfoZpJuHoyGDKGAQDeQDLrbhaaA4tufA8dFL+5WOYTzkm4cdNh/u4fk+nuf/48ilNZPI4n+4tLREc22N1UZDqtFs0mg0uLO6ysqnt1n55La8XpVK9jTXmjSbidbX16nX6/IX+DeiV23BlQqNVwAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/caf2eb9c531bf918ff2e2e3f92063f4f/fcda8/1633260950771-8a09d7fe-c8e7-4ab8-9dec-6c90b17e3a82.png\"\n        srcset=\"/static/caf2eb9c531bf918ff2e2e3f92063f4f/12f09/1633260950771-8a09d7fe-c8e7-4ab8-9dec-6c90b17e3a82.png 148w,\n/static/caf2eb9c531bf918ff2e2e3f92063f4f/e4a3f/1633260950771-8a09d7fe-c8e7-4ab8-9dec-6c90b17e3a82.png 295w,\n/static/caf2eb9c531bf918ff2e2e3f92063f4f/fcda8/1633260950771-8a09d7fe-c8e7-4ab8-9dec-6c90b17e3a82.png 590w,\n/static/caf2eb9c531bf918ff2e2e3f92063f4f/c3fd4/1633260950771-8a09d7fe-c8e7-4ab8-9dec-6c90b17e3a82.png 854w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><a name=Hn6dG></a></p>\n<h1>挑战三： 域名备案</h1>\n<p>一个偷懒的做法，就是将 AWS API Gateway 的默认域名填进去，结果发现通不过域名备案检查！</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c69755be75a9008d139b3cca922b1692/c6720/1633261047344-092fc182-3987-4c11-b33a-fcf5ae391468.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 76.35135135135135%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAABpklEQVR42o2U23KjMAyG8/4vtld9gb3ozXYGAgHio3yS/46cmpBtk13PaLBs6+O3JDg55zAMA9Z1Ra0VMvrz2Tjuy7z74zjixMwopTTrm92O67FE+EwIJX4714HzPOP0SkkHyhCgTQ5U6KniBuwOEUFrDWMMnPfQLkBZQsoZFCNCjKCQ4XyCcQTrY4vx3u8vnY7AEEKDkfegZYEZBqTlgrwuKNuCvF6an5YZeVtRrhs4ELhWSNoacDoAZTHLFVMEbwuK1kjXDVlp2KtGcB4cIwoRWPKaEtgo1K/Yb1fuxWEuTVWYz01VvEww0wQ7zyhGga0BWw1WG9i7B+A0T3egwKIoEGitSCmhiuqUmkkqclsrN4XMe4V/VNiBSSzlluycM7Ztgzam+bJfD733X8CuUioYQtzB4jfVDXCE3YEf4587UA5LUO+93kJKqdYB1tq9RZ4pPE/jo0KB9gLJXJR11WIC/lvlUeHDlSVYAvobZS5GntpT1Dl3u76E/DOHfWM/yBWFC2KOSCW3vZvV10V59feYacGv8xt+q3d4T7iqWyMDFfXJt/wJDwyZEUtdAW4AAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/c69755be75a9008d139b3cca922b1692/fcda8/1633261047344-092fc182-3987-4c11-b33a-fcf5ae391468.png\"\n        srcset=\"/static/c69755be75a9008d139b3cca922b1692/12f09/1633261047344-092fc182-3987-4c11-b33a-fcf5ae391468.png 148w,\n/static/c69755be75a9008d139b3cca922b1692/e4a3f/1633261047344-092fc182-3987-4c11-b33a-fcf5ae391468.png 295w,\n/static/c69755be75a9008d139b3cca922b1692/fcda8/1633261047344-092fc182-3987-4c11-b33a-fcf5ae391468.png 590w,\n/static/c69755be75a9008d139b3cca922b1692/efc66/1633261047344-092fc182-3987-4c11-b33a-fcf5ae391468.png 885w,\n/static/c69755be75a9008d139b3cca922b1692/c83ae/1633261047344-092fc182-3987-4c11-b33a-fcf5ae391468.png 1180w,\n/static/c69755be75a9008d139b3cca922b1692/c6720/1633261047344-092fc182-3987-4c11-b33a-fcf5ae391468.png 1922w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><a name=Okwvg></a></p>\n<h1>挑战四： Serverless 自定义域名</h1>\n<p>当然没有办法给 AWS 生成的域名去备案，但是可以不要用 AWS API Gateway 自动生成的域名，而是指定一个自定义域名，将这个自定义域名备案。</p>\n<p>由于我们的 lambda 使用了 serverless 框架自动化，要使用自定义域名，可以简单地通过增加一个 serverless 插件：serverless-domain-manager 来帮助我们自动关联这个自定义域名。利用这个插件，可以自动生成 AWS Route 53，以及关联相应的 Gateway。</p>\n<p>然而，真要这样做，需要去 AWS 上购买域名，或者将自己的域名过户到 AWS 的控制台。这……</p>\n<p>总之看起来要使用自定义域名，不那么友好，可能还需要产生额外的费用，那这个就没意思了。</p>\n<p><a name=Bl1Wn></a></p>\n<h1>挑战五： 转发 GraphQL 请求</h1>\n<p>出于节省成本的考虑，以及尽可能最大化复用已有服务，决定使用转发 GraqphQL 请求的方式。这里介绍下前情提要，我早些年备案了一个域名： pa-ca.me，并且在这上面部署了一个服务： <a href=\"https://uniheart.pa-ca.me\">https://uniheart.pa-ca.me</a> ，该项目源代码在这里： <a href=\"https://github.com/Jeff-Tian/alpha\">https://github.com/Jeff-Tian/alpha</a>。</p>\n<p>听说有的大神，可以盲写代码直接上线一次过，没有 BUG。这真令人羡慕，不过我今天也感受了一次一把过，即给已有项目 <a href=\"https://github.com/Jeff-Tian/alpha\">https://github.com/Jeff-Tian/alpha</a> 添加了一个转发 GraqphQL 请求的新功能，一次提交，自动发布后就可以使用了，效率实在令自己满意： <a href=\"https://github.com/Jeff-Tian/alpha/commit/e58dcf0e7f80643b192561e795bbb3cf050993fd\">https://github.com/Jeff-Tian/alpha/commit/e58dcf0e7f80643b192561e795bbb3cf050993fd</a>。至今没有发现 BUG，是真的很神吗？其实不是，只是有一个好习惯而已：</p>\n<p><a name=mVHJM></a></p>\n<h2>测试先行</h2>\n<p>这个已有项目是基于 eggjs 的，eggjs 其实还是有些坑的，即在发送请求时，有一个 contentType 选项，对于发送 POST 请求（GraphQL 查询本质上是一个 HTTP Post 请求），我相信多数开发都会自然设置 contentType = application/json，但是在 eggjs 生态里，这样设置是没有效果的，会导致 GraphQL 服务收不到请求 body。只一次新功能的添加，之所以一次部署就能过，其实是因为在改代码前，先写好了自动化测试。即先写好了一个期待的转发功能的正确表现，然后运行，让测试失败。然后写实现代码，再次运行测试，直到测试通过。这其中并没有想象中的那么顺利，需要尝试各种请求选项的设置，知道找到一个（或者几个）能够工作的设置组合。自动化测试的好处是让我的尝试可以很快得到验证。</p>\n<p><a name=qdawB></a></p>\n<h2>测试用例</h2>\n<p>typescript</p>\n<p>const graphql = async () => {\nconst res = await app.httpRequest()\n.post(/proxy?url=${encodeURIComponent(<a href=\"https://jqp5j170i6.execute-api.us-east-1.amazonaws.com/dev/gatsby/graphql)%7D\">https://jqp5j170i6.execute-api.us-east-1.amazonaws.com/dev/gatsby/graphql)}</a>)\n.type(application/json)\n.send({ query: { n  yuque(id: 53296538) {n    idn    titlen    descriptionn    n  }n  n  allYuque {n    nodes {n      idn      titlen    }n  }n}, variables: null })\n.expect(200);</p>\n<pre><code>assert.strictEqual(res.body.errors, undefined);\nassert(res.body.data.yuque.title === 快速下载 GitHub 上项目下的子目录);\n</code></pre>\n<p>};</p>\n<p>it(should proxy graphql, graphql);</p>\n<p><a name=O6H3E></a></p>\n<h2>最终实现</h2>\n<p>typescript\nsubRouter.post(/, controller.proxy.proxy.post);</p>\n<p>public async post() {\nconst { ctx } = this;</p>\n<pre><code>const { data } = (await ctx.curl(ctx.query.url, {\n  streaming: false,\n  retry: 3,\n  timeout: [ 3000, 30000 ],\n  method: POST,\n  type: POST,\n  contentType: json,\n  data: ctx.request.body,\n  dataType: json,\n}));\n\nctx.body = data;\n</code></pre>\n<p>}</p>\n<p>可见这个 contentType 必须设置成 json，才能触发 ctx.curl 以及其底层的 urlib 自动将 header 中的 content-type 设置成 application/json ！</p>\n<p>至此，就解释清楚了挑战一中，为什么生成 apollo 客户端实例时，会有一个 proxy 的 url 出现了。这一切弯弯绕绕都是因为小程序的限制，如果你足够有钱，可以接受在 AWS Route 53 里再申请一个域名，那么这一切可以得到一些简化。</p>\n<p><a name=loTkE></a></p>\n<h1>总结</h1>\n<p>本文给万能 BFF 最终在前端的使用举了一个例子，详解了如何在小程序中接入 GraphQL。因为利用了 TaroJs，所以同步部署了一个 Web 端： <a href=\"https://taro.pa-ca.me\">https://taro.pa-ca.me</a>。Web 端的集成只需要参考 Apollo 官方文档，因此没有赘述其实现，而是找了一个相对更难的实现方案：微信小程序。这不仅弥补了官方示例的空白，而且体现了中国特色。</p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}},"menus":{}}},"staticQueryHashes":[],"slicesMap":{}}