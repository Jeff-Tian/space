{"componentChunkName":"component---src-templates-post-js","path":"/posts/vvdmqy3wopho0z95/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/vvdmqy3wopho0z95","relativePath":"posts/vvdmqy3wopho0z95","frontmatter":{"title":"修改 node_modules 的三种方式，隆重推荐 patch-package","stackbit_url_path":"posts/vvdmqy3wopho0z95","date":"2023-11-21T12:08:25","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p><a name=lXgme></a></p>\n<h1>相关文章</h1>\n<p>之前提过两种方式，详见：<br />ChatGPT 教我如何修改 node_modules 里的代码 - Jeff Tian的文章 - 知乎<br /><a href=\"https://zhuanlan.zhihu.com/p/642937928\">https://zhuanlan.zhihu.com/p/642937928</a></p>\n<p>今天再重新梳理一下，并隆重推荐我新学会的一种方式，那就是使用 patch-package。为什么会有修改 node_modules 的情况呢？因为不想重新造轮子，但是现有的轮子又不太好用，就不得不基于不太好用的轮子，做一些修改和适配。\n<a name=WMdPD></a></p>\n<h1>一、发私包</h1>\n<p>这是最简单直接的，如果直接依赖一个包，而需要对这个包进行修改，那么可以将 package.json 里的 name 修改一个名字，做了其他修改之后，直接 yarn publish一个新的，然后在项目中引入这个新的包即可。\n<a name=R2m4G></a></p>\n<h2>案例一：vitepress</h2>\n<p>代码改动见：<a href=\"https://github.com/vuejs/vitepress/commit/b35de817436d57dee84cc369bb28b7ae1bef0493\">https://github.com/vuejs/vitepress/commit/b35de817436d57dee84cc369bb28b7ae1bef0493</a><br />最初发现 vitepress 是一个令人惊艳的静态网站生成器，但是使用时，发现不支持嵌套包含。虽然给官方提了 PR，并且最终很快得到了合并。但我当时想立即使用嵌套包含的功能，所以就发了一个自己的私包，直接使用了，从而不用等待官方的发版。\n<a name=pbDal></a></p>\n<h2>案例二：umi-plugin-oauth2</h2>\n<p><a href=\"https://github.com/Jeff-Tian/umi-plugin-oauth2\">https://github.com/Jeff-Tian/umi-plugin-oauth2</a><br />因为工作中有几个项目都是基于 umijs 开发，并且需要对接身份认证平台，为了省事，就需要一个 umi 插件来做这件事儿。从网上找到了一个 umi-plugin-oauth2-client，但是实际使用下来有一些问题。于是我就基于它做了一些修改，也给原作者提了 PR，但是一直没有回音，可能是没有维护了。为了不用等待，就直接将修改后的版本，改了个名字发到 npm registry，其他项目都直接引用这个被修改过的版本。<br />通过发私包，不仅可以解决自己的问题，还能让别人受益，这就很有趣了。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 57.432432432432435%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABmElEQVR42oWR3WvTUBjGwxQhCTnJOU0aVto0cdlHadp8rM5atunonLd2bIgwhyJ4IXrhrYKC//hPEppQum5e/DjnwHve93mfR9vZG+C6Lq1WayPttofv+7ieh1IKx3GQUt6L9u7LLYNhQjLKSMYpyThjlOaMxhnJKGWc5uzEuzi2/WCjpuHl54+k6QFtz0WpzSprZTVSSWRL3aGs0+LdDr7fRq58WKUs8jyvoryXKoRhYW3p2I+MBvHERNd1NCGc//rSoCRCt4he7TP4Oaf7/YTg2zHdHyc8vXnB/M0FmqHrCCGwLKs6a+p32ahUVqlTCtsUdPKQ8P0h25cZnUXK9nVO9zyhKA7RjudnhGFIFEUEQVDR7/erd6/XqzxcX9k2BNaWgf14yXJlwzDQ3n665fl0ysvTU54dHTGdTplMJhRFwXA43Ojrg6EsPlxTFHnVJMsyZrMZcRxjmmaz8ipOyT0BlmhK6o1Pm4JYX7kJsFa2VFsP0hxZFt2dKpcF6yk7psArQsLf5/R/zYn+vCb4e8He1zMWV1f8AyX5Hp4/izvEAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/2ce2f76a0247d8bdb8cd9601454b5ea5/fcda8/1700566425916-d1f55a20-e5a8-4eb4-ae3e-347cea33dd67.png\"\n        srcset=\"/static/2ce2f76a0247d8bdb8cd9601454b5ea5/12f09/1700566425916-d1f55a20-e5a8-4eb4-ae3e-347cea33dd67.png 148w,\n/static/2ce2f76a0247d8bdb8cd9601454b5ea5/e4a3f/1700566425916-d1f55a20-e5a8-4eb4-ae3e-347cea33dd67.png 295w,\n/static/2ce2f76a0247d8bdb8cd9601454b5ea5/fcda8/1700566425916-d1f55a20-e5a8-4eb4-ae3e-347cea33dd67.png 590w,\n/static/2ce2f76a0247d8bdb8cd9601454b5ea5/efc66/1700566425916-d1f55a20-e5a8-4eb4-ae3e-347cea33dd67.png 885w,\n/static/2ce2f76a0247d8bdb8cd9601454b5ea5/c83ae/1700566425916-d1f55a20-e5a8-4eb4-ae3e-347cea33dd67.png 1180w,\n/static/2ce2f76a0247d8bdb8cd9601454b5ea5/799f3/1700566425916-d1f55a20-e5a8-4eb4-ae3e-347cea33dd67.png 1642w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p><a name=yzDYj></a></p>\n<h1>二、postinstall 大法</h1>\n<p>发私包虽然好，但并不是银弹。假如项目不是直接依赖该库，而是需要修改依赖链条上很深的一个依赖，那么通过发私包的方式就不可行了。如果非要用发私包的方式的话，就得将依赖链条上的每一个库都发一个私包，并且对所有涉及到的库的依赖进行连环修改，工作量非常大，不值得。<br />这时候就可以通过 postinstall 脚本来对最根本的依赖直接做修改。\n<a name=N0wQE></a></p>\n<h2>案例：vuejs/core</h2>\n<p>我在使用 vitepress 的过程中，发现了一个问题（<a href=\"https://github.com/vuejs/vitepress/issues/2596\">https://github.com/vuejs/vitepress/issues/2596</a>）：如果 markdown 里引用了一个文件名中带有空格的图片，开发模式下发现不了问题。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAABxUlEQVR42mOYM3fh1OmzevsnTZg0rbd/cv/EKb19E0Gof/LkKdOmz5g1bfrsSVOmt7R2NjS1NTS1NTW3t3f2dnT1dXX3MygqaSooqEnLKIuJy4qKyUpKaUjIaUjIqotKK0nJKgmLyomIyotKyDk4ukdExEZExIaHR0dGxkZGxUVHxzPY2Ltb2rgYmNjo6lhr6phouMmp6uipa5moaRkqq+vKaSuKy8vzC8ju3LHn////f/78+Y8EGPTNnSwdfLR1LAzsjW3zVPWiJOVV1ZXUtZU1tRVUNJXMFFQcpaV0Jbbt2vHv7/+vX798//79379/UM3KalrGplaGFkY6ntLKhopCwgoiEnIQJCwuJyotp2Aho+Qpsnrf1M8f3r5+8/bly1dw+xk0NPRsLax09I3lZDRkZTREJEA+hCAxCTkxcRCSMpZct6/g/99HYBv/IZytrWlga+2gpW2kqKQup6gmIiEvJiELR+KSsuIScoKCUpu3rfr////fv//gbgZp1tTUNzO30dM3UVTSkFNA1wzWLycsKrljx26wZtQAU1XXVVBUV1BUx6NZUFhyw4aN//79+/v3LxbNikoaSrg18wuKbd6yFTOqAEGS9oxAXUm+AAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/2fe626c542409ad81ef8c59718d40fef/fcda8/1700567463620-4ee91ffe-48f6-4baa-a43b-cf0580bb977e.png\"\n        srcset=\"/static/2fe626c542409ad81ef8c59718d40fef/12f09/1700567463620-4ee91ffe-48f6-4baa-a43b-cf0580bb977e.png 148w,\n/static/2fe626c542409ad81ef8c59718d40fef/e4a3f/1700567463620-4ee91ffe-48f6-4baa-a43b-cf0580bb977e.png 295w,\n/static/2fe626c542409ad81ef8c59718d40fef/fcda8/1700567463620-4ee91ffe-48f6-4baa-a43b-cf0580bb977e.png 590w,\n/static/2fe626c542409ad81ef8c59718d40fef/efc66/1700567463620-4ee91ffe-48f6-4baa-a43b-cf0580bb977e.png 885w,\n/static/2fe626c542409ad81ef8c59718d40fef/c83ae/1700567463620-4ee91ffe-48f6-4baa-a43b-cf0580bb977e.png 1180w,\n/static/2fe626c542409ad81ef8c59718d40fef/88820/1700567463620-4ee91ffe-48f6-4baa-a43b-cf0580bb977e.png 2564w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>但是在上生产时却会出现编译失败。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e44bc4c2294b60edca08b2342b24af2d/db7ce/1700567470430-d298628a-70f9-4e5e-bd81-f25b7083d61b.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 68.24324324324324%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsTAAALEwEAmpwYAAACYUlEQVR42l3OXW/UOBTG8XwDtswkseO3YzuOHcdx3mZogFLYFay6d7vSXq32ik9EpzNMKQWKkPicaBgECOmn5+6vc5IPHz9/uPu02V7v9je71zeXV/vN1f7yav9qs7vcvN7u3tzevn97e3f95t1mu99s91e76812v9u/vbm9S4yNStdcGMo0xsChBNMU3GBWIqaFskwYTBQmKsfwXUE1JjKZH/9+9vTFuD6Lw9y0a1l6pnzdze30xLUrU3eI6hRDiiErICvkcXOi7mcsmeY/zv/8d3zwNPSP+tW5NC1m2vhQNdGGaOpYcLNE4hcphnsLkjg/NMM8rR6CtFLaguolFgvEFzk7yFiKRIbhF3khT5YkqVw3DsP88FwqJ5VjoiKiyolCRCGqMyyXuUgLOH7+XXaMXd2frefV+pGASioH0jkfjW2ErARYFQEBWS5ZhlmGfsgxP1mgxNf9fHp2Op8rVUvlhLS17yobysqDsgUX+jGilizv85/7b7HzfRuncZp16Q9vgzE+qKqmskwRTVOaIWae52LAaXrI0mOP+W/HmAvDRQXKKeWoKJkxVJcHQhMiipwRJMIFBsUpEoICLQQngNLiEEtZKX0oQTmjXOe7uhnrumvj1IShdgEo0FQoIhjmeU4RYhjzxeFymKCehIlcewpWSzvEsQ6DbTofJxuG0rVlVYM0Ar6SFeEKE1hkJGmmJ+HZP9r2lOp0WRRM+6aL3dT1q35Yt3FsQh/iGPtViGNoh358EOLofFTaJa6b2cX/1d8v5V//nZxeFGCltrry2nhjGw6GCc1ESfmPZaLkYDCBL3Hejt/QyKq3AAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/e44bc4c2294b60edca08b2342b24af2d/fcda8/1700567470430-d298628a-70f9-4e5e-bd81-f25b7083d61b.png\"\n        srcset=\"/static/e44bc4c2294b60edca08b2342b24af2d/12f09/1700567470430-d298628a-70f9-4e5e-bd81-f25b7083d61b.png 148w,\n/static/e44bc4c2294b60edca08b2342b24af2d/e4a3f/1700567470430-d298628a-70f9-4e5e-bd81-f25b7083d61b.png 295w,\n/static/e44bc4c2294b60edca08b2342b24af2d/fcda8/1700567470430-d298628a-70f9-4e5e-bd81-f25b7083d61b.png 590w,\n/static/e44bc4c2294b60edca08b2342b24af2d/efc66/1700567470430-d298628a-70f9-4e5e-bd81-f25b7083d61b.png 885w,\n/static/e44bc4c2294b60edca08b2342b24af2d/c83ae/1700567470430-d298628a-70f9-4e5e-bd81-f25b7083d61b.png 1180w,\n/static/e44bc4c2294b60edca08b2342b24af2d/db7ce/1700567470430-d298628a-70f9-4e5e-bd81-f25b7083d61b.png 2404w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>这让人很沮丧，对问题跟踪了一番，发现竟然是一个存在了 2 年多的 vuejs/core 的问题导致的。由于非常底层，所以不适合通过发私包来解决。比如我发一个 vuejs-core-2 来修复这个问题，就还得再发一个 vuejs-2，还得再发一个 vuepress-2，如此下去。<br />于是我想到了使用 postinstall，通过亲测验证，效果非常好。我将这个方案分享到了 <a href=\"https://github.com/vuejs/vitepress/issues/573#issuecomment-1629971757\">https://github.com/vuejs/vitepress/issues/573#issuecomment-1629971757</a>。<br />即在项目中创建 postinstall.js 文件：\njavascript\nconst fs = require(fs);</p>\n<p>const filePath = node_modules/@vue/compiler-sfc/dist/compiler-sfc.cjs.js;</p>\n<p>fs.readFile(filePath, utf8, (err, data) => {\nif (err) {\nconsole.error(err);\nreturn;\n}</p>\n<pre><code>const modifiedData = data.replace(\n    /context.imports.push({s*exp,s*path:s*path2s*});/g,\n    context.imports.push({ exp, path: path2 &#x26;&#x26; path2[0] === / ? decodeURIComponent(path2) : path2 });\n);\n\nfs.writeFile(filePath, modifiedData, utf8, (err) => {\n    if (err) {\n        console.error(err);\n        return;\n    }\n\n    console.log(File modified successfully!);\n});\n</code></pre>\n<p>});</p>\n<p>并在 package.json 里增加 postinstall 命令：\ndiff</p>\n<ul>\n<li>\n<pre><code>postinstall: node postinstall.js\n</code></pre>\n</li>\n</ul>\n<p>尽管我同时也提交了一个 PR 给到 vuejs/core，并且最终被尤雨溪大佬亲自合并了这个 PR，并且最终在 3.3.6 版本中带上了这个修复，但是这个版本要求 esmodule，而我的项目中还没有这个改造计划，所以直到如今，我还在使用上述的 postinstall 方案，实在是非常香。\n<a name=zl1UQ></a></p>\n<h1>三、patch-package</h1>\n<p>虽然 postinstall 大法非常好用，并且 patch-package 从根本上也是使用了 postinstall 方法，但是我仍然强烈推荐使用它来进行 node_modules 修改！<br />我们再来仔细审视一下 postinstall 方案：首先，需要在本地的 node_modules 目录下找到目标库，并且进行实际的修改和验证。在验证通过后，然后就得将手动定位、修改的过程，用代码写出来。这非常啰嗦，并且不能规模化。<br />在上面的案例中，它之所以香，是因为只改动了一个文件的一个位置，如果需要改动多个地方，在手动改完后，还需要记住这些位置，并且再将手动改完的步骤用代码表达一遍，相当于每个改动得做 2 次，并且很容易在第 2 次用代码表达时出现错误。<br />而使用 patch-package，则只需要手动修改目标文件，再执行 yarn patch-package target-package-1 target-package-2就可以了！<br />并且，在后续要向目标库提交 PR 或者提 Issue 时，可以直接使用 yarn patch-package target-package --create-issue的方式，省心！</p>\n<p><a name=KS34i></a></p>\n<h2>案例</h2>\n<p>最近用它解决了一个非常大的问题，可惜目前还在私有库里，不便公开展示。不如留给读者朋友们，在后续使用了它之后留言分享更多的案例吧！</p>\n<p><a name=UUN14></a></p>\n<h1>总结</h1>\n<p>发私包和朴素的 postinstall 方案，没有其他依赖，简单直接，但不是以一种工程化的方式来完成的。而 patch-package 则是一种工程化、科学的对 node_modules 里的包做修改的优雅方式，推荐你在碰到需要修改 node_modules 里的包时采用。</p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}}}},"staticQueryHashes":[],"slicesMap":{}}