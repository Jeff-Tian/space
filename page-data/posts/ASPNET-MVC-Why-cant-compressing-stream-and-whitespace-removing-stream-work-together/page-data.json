{"componentChunkName":"component---src-templates-post-js","path":"/posts/ASPNET-MVC-Why-cant-compressing-stream-and-whitespace-removing-stream-work-together/","result":{"data":{"sitePage":{"id":"SitePage /posts/ASPNET-MVC-Why-cant-compressing-stream-and-whitespace-removing-stream-work-together/"}},"pageContext":{"url":"/posts/ASPNET-MVC-Why-cant-compressing-stream-and-whitespace-removing-stream-work-together/","relativePath":"posts/ASPNET-MVC-Why-cant-compressing-stream-and-whitespace-removing-stream-work-together.md","relativeDir":"posts","base":"ASPNET-MVC-Why-cant-compressing-stream-and-whitespace-removing-stream-work-together.md","name":"ASPNET-MVC-Why-cant-compressing-stream-and-whitespace-removing-stream-work-together","frontmatter":{"title":"ASP.NET MVC: Why can’t compressing stream and whitespace removing stream work together?","stackbit_url_path":"posts/ASPNET-MVC-Why-cant-compressing-stream-and-whitespace-removing-stream-work-together","date":"2013-09-02 07:53:00","excerpt":"","comments_count":0,"positive_reactions_count":0,"tags":["Compress","Stream"],"canonical_url":"https://be-net.azurewebsites.net/post/2013/09/02/ASPNET-MVC-Why-cant-compressing-stream-and-whitespace-removing-stream-work-together","template":"post"},"html":"<h2><span style=\"color: #9b00d3;\">Problem:</span></h2>\n<p>The other day, I wanted to employ some ActionFilterAttributes to totally compress my dynamically generated HTML before sending it to the client for network bandwidth saving and so improving the Page Load Time. So I searched on the internet and implemented 2 ActionFilterAttributes – RemoveWhitespacesAttribute and CompressContentAttribute. Both override the OnActionExecuted() method, the 1st one intercepts the filterContext that passed in and removes all the unnecessary whitespaces that contained in it, and the 2nd one intercepts the filterContext that passed in and gzips it. Very straight forward, I applied them to my controllers.</p>\n<pre class=\"brush: csharp\">...\n    [CompressContent]\n    [RemoveWhitespaces]\n    public class HomeController : Controller\n...</pre>\n<p>The result astonished me that the page only shows as blank! I used Fiddler the inspect the response, and the fiddler detected the response seemed Gzip enabled, but when trying to decompress the stream, it said that the Gzip magic number is not valid!</p>\n<p>Then I tried only apply one of the ActionFilterAttributes, and both scenarios worked. But if I applied them at the same time, the response would be a invalid stream and the web page can’t be displayed.</p>\n<h2><span style=\"color: #9b00d3;\">Analyzing:</span></h2>\n<p>At first I couldn’t understand why can’t the 2 ActionFilterAttributes work together, after a while, I looked into the constructors of the 2 streams that the 2 ActionFilterAttributes use and finally I figured out why.</p>\n<pre class=\"brush: csharp\">...\npublic class GZipStream : Stream {\n\tpublic GZipStream(Stream stream, CompressionMode mode);\n...\npublic class HtmlWhitespaceRemovingHelper : Stream {\n\tpublic HtmlWhitespaceRemovingHelper(Stream responseStream)\n...</pre>\n<p>Both streams take a stream as the parameter, and they both are derived from Stream class, and they both override the Stream’s Write() method. So here implements a decorator pattern. Both streams add extra logic to the original stream’s Write() method. And unfortunately, when they were working together in the manner as the above shows, or as the following way:</p>\n<pre class=\"brush: csharp\">...\n    [CompressContent]\n    [RemoveWhitespaces]\n    public class HomeController : Controller\n...</pre>\n<p>The Gzip stream firstly took in the original response stream, and gzipped it and then passed out the new wrapped stream. And then the HtmlWhitespaceRemovingHelper stream caught the Gzip wrapped stream, and removed the characters that smells like extra whitespaces, and then passed out the wrapped again stream, so oops, the gzipped stream were polluted and finally the client side received an invalid stream.</p>\n<h2><span style=\"color: #9b00d3;\">Conclusion:</span></h2>\n<p>To make them can be working together, we have to make sure that the HtmlWhitespaceRemovingHelper stream firstly catch the original clean response stream, after it removing the redundant whitespaces, then pass the sanitized stream to the Gzip stream. Finally the client side would receive a valid gzipped stream, and after it ungzipped the stream, it would see a valid compact html without extra whitespaces. In a word, the rough picture should be like this:</p>\n<p><a href=\"https://raw.githubusercontent.com/Jeff-Tian/blogengine.net/master/Source/BlogEngine/BlogEngine.NET/App_Data/files/WP_000249%20(1).jpg\"><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 72.2972972972973%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAA7EAAAOxAGVKw4bAAADBklEQVR42gXBW4vjVAAA4PwaX/SHCD74IoiPggiCCIo+7oo++CSy4gXRVQRltjsymKa3tElzv5zknFybpLm0aTPNtk06nU5vM5uZnWG/Dzsu1/e7m4d9dbs7bMrFZZlfH4r7h+3dq6vq9uK2WlUvi+qmuD6ubq9X1aFcz2ezND1PkjQMsVfb3f32+uFQVVfb8nz6IguT2C7X2cv7zfGuPFblTVXsD4tlMVnM04siO4/jdBiOg2Ho2dhuvjwWVzer3X51ORul5SKfZpET6PllWhxmWZm6keFHBoRSOLSjge1B5BtWPPDCgYuZnOJKyBKRA6x8ku33m+PdNt9M0lUk2gIpkQygNUuESJhkQ5mjhG7HN4zAMH0LYS6vaF1ep2WdA57lLooX2+pqXMSCyYg27UzRdJOgQJM1Ic3CoQdtXbUU1dc1C8jYzIuWUbZK8zyZeJY7Go3QwDITJ1oOJ5skWUfjdSJADm/gLNdrEWdIkSwVDHTVkAVsFaXLcLqMp5HtCRQbhiNeUsblOQghjLSoDIO51+XbqqHQDNUi6oFjQUn0TQg5Bst9/2Iyv8jy1SwHokJTrKDIqqOJptRgG4LN0RrFAga5kOySPMM4BoSi6Gqa3O9jEQSLeJTHyTSKLGhqQFOhClydVphTolanznjEsKAvyIwkcUhTFZZ3IdJ4QaT6GGK7szDIAt/TUex56SgO48gfhcg1GLHfl3qc3Ot0G1SvhZ89p9pNQ1U0hukTBE+2MQZ/lgXO2DVtWQxtc2jbvmMNXNsfDgxT1zRF10UIRQ1wUOMcU6Mbz3989NEvjz/++dGHWOOfX6eeFRogMHULKHSz02s0240mQ/dMBGwEkK4YumgiESi0yFInf3z/5QdvffX+m5+/9wZWe/J1akAfKD4Ejg5UjuUoqk92Wjiu8KwuC0DiZa7PdNsMiQtUi6j9/t0X73776TuPP3kbe/rNZypZl1q4SBJirylQLa7XYntNulsnif9aeK35/7MmXusQpyRx0q2f1E//rP39079Pn/z12w+vAWx5mqh6/Ee0AAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"ASP.NET MVC: Why can’t compressing stream and whitespace removing stream work together?\" title=\"ASP.NET MVC: Why can’t compressing stream and whitespace removing stream work together?\" src=\"/static/c87533030e29028d95893976f7b42f3f/1c72d/WP_000249%20(1)_thumb.jpg\" srcset=\"/static/c87533030e29028d95893976f7b42f3f/a80bd/WP_000249%20(1)_thumb.jpg 148w,\n/static/c87533030e29028d95893976f7b42f3f/1c91a/WP_000249%20(1)_thumb.jpg 295w,\n/static/c87533030e29028d95893976f7b42f3f/1c72d/WP_000249%20(1)_thumb.jpg 590w,\n/static/c87533030e29028d95893976f7b42f3f/b9214/WP_000249%20(1)_thumb.jpg 663w\" sizes=\"(max-width: 590px) 100vw, 590px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\" loading=\"lazy\">\n    </span></a>&nbsp;</p>\n<h2><span style=\"color: #9b00d3;\">Solution:</span></h2>\n<p>We can make them working together by applying them with specifying an execution order:</p>\n<pre class=\"brush: csharp\">...\n    [CompressContent(Order = 9999)]\n    [RemoveWhitespaces(Order = -1)]\n    public class HomeController : Controller\n...</pre>\n<p>The Order = –1 makes RemoveWhitespace ActionFilterAttribte executes firstly and then other filters comes next, and finally the CompressContent ActionFilterAttribute by Order = 9999 which gzip the stream it gets.</p>\n<p>The source code of the 2 ActionFilterAttributes are pasted in the last part. One thing worth noticing is in the code, I make the 2 streams detect the type of the stream they get, and only do their actions if the stream they get is the pure original response stream. The intent is to make sure to either gzip it or remove its unnecessary whitespaces. So finally I realized that I don’t need to let both of them working together at all, because if the server has already enabled Gzip, then there is no need to do compressing nor whitespace removing any more. In other words, it is worthless of removing whitespaces if the stream would be gzipped before sending to client side. However, the whitespace removing can be regarded as kind of a failsafe option. So whatever happened, the client side would receive either a gzip compressed stream or a normal stream with whitespaces removed.</p>\n<h2><span style=\"color: #9b00d3;\">Source code:</span></h2>\n<p><strong>RemoveWhitespacesAttribute.cs:</strong></p>\n<pre class=\"brush: csharp\">using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Web;\nusing System.Web.Mvc;\nusing zizhujy.Utility;</pre>\n<p>namespace zizhujy.Attributes\n{\npublic class RemoveWhitespacesAttribute : ActionFilterAttribute\n{\npublic override void OnActionExecuted(ActionExecutedContext filterContext)\n{\nvar response = filterContext.HttpContext.Response;</p>\n<pre><code>        if (string.Equals(response.ContentType, \"text/html\", StringComparison.InvariantCultureIgnoreCase) &#x26;amp;&#x26;amp; response.Filter != null)\n        {\n            if (!(response.Filter is System.IO.Compression.GZipStream)\n                &#x26;amp;&#x26;amp; !(response.Filter is System.IO.Compression.DeflateStream)\n                &#x26;amp;&#x26;amp; !(response.Filter is zizhujy.Utility.HtmlWhitespaceRemovingHelper))\n            {\n                response.Filter = new HtmlWhitespaceRemovingHelper(response.Filter);\n            }\n        }\n\n        //base.OnActionExecuted(filterContext);\n    }\n\n    //public override void OnActionExecuting(ActionExecutingContext filterContext)\n    //{\n    //    ZiZhuJY.Helpers.Log.Info(\"Removing whitespaces\");\n\n    //    var response = filterContext.HttpContext.Response;\n\n    //    if (string.Equals(response.ContentType, \"text/html\", StringComparison.InvariantCultureIgnoreCase) &#x26;amp;&#x26;amp; response.Filter != null)\n    //    {\n    //        response.Filter = new HtmlWhitespaceRemovingHelper(response.Filter);\n    //    }\n\n    //    ZiZhuJY.Helpers.Log.Info(\"Removed whitespaces\");\n    //}\n}\n</code></pre>\n<p>}</pre></p>\n<p><strong>HtmlWhitespaceRemovingHelper.cs</strong></p>\n<pre class=\"brush: csharp\">using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Web;\nusing System.IO;\nusing System.Text;\nusing System.Text.RegularExpressions;\n<p>namespace zizhujy.Utility\n{\npublic class HtmlWhitespaceRemovingHelper : Stream\n{\nprivate Stream @base;\nprivate StringBuilder sb = new StringBuilder();</p>\n<pre><code>    public HtmlWhitespaceRemovingHelper(Stream responseStream)\n    {\n        if (responseStream == null)\n            throw new ArgumentNullException(\"responseStream\");\n\n        this.@base = responseStream;\n    }\n\n    public override void Write(byte[] buffer, int offset, int count)\n    {\n        string html = Encoding.UTF8.GetString(buffer, offset, count);\n\n        //Thanks to Qtax\n        //http://stackoverflow.com/questions/8762993/remove-white-space-from-entire-html-but-inside-pre-with-regular-expressions\n        Regex regex = new Regex(@\"(?&#x26;lt;=\\s)\\s+(?![^&#x26;lt;&#x26;gt;]*&#x26;lt;/textarea&#x26;gt;|[^&#x26;lt;&#x26;gt;]*&#x26;lt;/pre&#x26;gt;)\", RegexOptions.IgnoreCase | RegexOptions.Singleline);\n        //html = regex.Replace(html, match =&#x26;gt; string.Format(\"{0}\", new string('_', match.Groups[0].Value.Length)));\n        html = regex.Replace(html, string.Empty);\n\n        buffer = Encoding.UTF8.GetBytes(html);\n        this.@base.Write(buffer, 0, buffer.Length);\n    }\n\n    #region Other Members\n    public override int Read(byte[] buffer, int offset, int count)\n    {\n        throw new NotSupportedException();\n    }\n\n    public override bool CanRead\n    {\n        get { return false; }\n    }\n\n    public override bool CanSeek\n    {\n        get { return false; }\n    }\n\n    public override bool CanWrite\n    {\n        get { return true; }\n    }\n\n    public override long Length\n    {\n        get { throw new NotSupportedException(); }\n    }\n\n    public override long Position\n    {\n        get\n        {\n            throw new NotSupportedException();\n        }\n        set\n        {\n            throw new NotSupportedException();\n        }\n    }\n\n    public override void Flush()\n    {\n        this.@base.Flush();\n    }\n\n    public override long Seek(long offset, SeekOrigin origin)\n    {\n        throw new NotSupportedException();\n    }\n\n    public override void SetLength(long value)\n    {\n        throw new NotSupportedException();\n    }\n    #endregion\n}\n</code></pre>\n<p>}</pre></p>\n<p><strong>CompressContentAttribute.cs</strong></p>\n<pre class=\"brush: csharp\">using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Web;\nusing System.Web.Mvc;\nusing zizhujy.Utility;\n<p>namespace zizhujy.Attributes\n{\npublic class CompressContentAttribute : ActionFilterAttribute\n{\npublic override void OnActionExecuted(ActionExecutedContext filterContext)\n{\nCompressResponse(filterContext);</p>\n<pre><code>        //base.OnActionExecuted(filterContext);\n    }\n\n    public static void CompressResponse(ActionExecutedContext filterContext)\n    {\n        ZiZhuJY.Helpers.Log.Info(\"Compressing Response\");\n\n        HttpResponse response = HttpContext.Current.Response;\n\n        string acceptEncoding = HttpContext.Current.Request.Headers[\"Accept-Encoding\"];\n\n        if (!string.IsNullOrEmpty(acceptEncoding))\n        {\n            if (!(response.Filter is System.IO.Compression.GZipStream)\n                &#x26;amp;&#x26;amp; !(response.Filter is System.IO.Compression.DeflateStream)\n                &#x26;amp;&#x26;amp; !(response.Filter is zizhujy.Utility.HtmlWhitespaceRemovingHelper))\n            {\n                if (acceptEncoding.Contains(\"gzip\", StringComparison.InvariantCultureIgnoreCase))\n                {\n                    response.Filter = new System.IO.Compression.GZipStream(response.Filter, System.IO.Compression.CompressionMode.Compress);\n                    try\n                    {\n                        response.Headers.Remove(\"Content-Encoding\");\n                        response.AppendHeader(\"Content-Encoding\", \"gzip\");\n                    }\n                    catch\n                    {\n                        try\n                        {\n                            response.AppendHeader(\"Content-Encoding\", \"gzip\");\n                            response.Headers[\"Content-Encoding\"] = \"gzip\";\n                        }\n                        catch\n                        {\n                        }\n                        finally\n                        {\n                            //filterContext.Exception = null;\n                            //filterContext.ExceptionHandled = false;\n                        }\n                    }\n                    finally { }\n\n                    return;\n                }\n\n                if (acceptEncoding.Contains(\"deflate\", StringComparison.InvariantCultureIgnoreCase))\n                {\n                    response.Filter = new System.IO.Compression.DeflateStream(response.Filter, System.IO.Compression.CompressionMode.Compress);\n                    try\n                    {\n                        response.Headers.Remove(\"Content-Encoding\");\n                        response.AppendHeader(\"Content-Encoding\", \"deflate\");\n                    }\n                    catch\n                    {\n                        try\n                        {\n                            response.AppendHeader(\"Content-Encoding\", \"gzip\");\n                            response.Headers[\"Content-Encoding\"] = \"deflate\";\n                        }\n                        catch\n                        {\n                        }\n                        finally\n                        {\n                        }\n                    }\n                    finally { }\n\n                    return;\n                }\n            }\n        }\n\n    }\n}\n</code></pre>\n<p>}</pre></p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}}}},"staticQueryHashes":[],"slicesMap":{}}