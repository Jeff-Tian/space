{"componentChunkName":"component---src-templates-post-js","path":"/posts/mmun2rf0z6pbgpzp/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/mmun2rf0z6pbgpzp","relativePath":"posts/mmun2rf0z6pbgpzp","frontmatter":{"title":"解决 Keycloak 部署到 Okteto 后的 CSP 错误","stackbit_url_path":"posts/mmun2rf0z6pbgpzp","date":"2023-04-06T09:18:52","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p>在《<a href=\"https://zhuanlan.zhihu.com/p/611823061\">【免费架构】Heroku 不免费了，何去何从之 Keycloak 的容器化部署之路 - Jeff Tian的文章 - 知乎 </a> 》中，我记录了如何将 Keycloak 部署到 Okteto。的确运行起来了，但是在尝试打开 Admin Console（<a href=\"https://keycloak-jeff-tian.cloud.okteto.net/admin/master/console\">https://keycloak-jeff-tian.cloud.okteto.net/admin/master/console</a> ） 时，发现页面白屏，F12 进入开发者工具，看到如下错误：\njava\nRefused to frame <a href=\"http://keycloak-jeff-tian.cloud.okteto.net/\">http://keycloak-jeff-tian.cloud.okteto.net/</a> because it violates the following Content Security Policy directive: frame-src self.</p>\n<p>看起来，Keycloak 里的某个页面部分是通过 iframe 加载的，而链接是服务器端传给前端的，但是服务器端认为自己处于 http 协议之下，所以传给了前端一个 http 的 url。尽管我是通过 https 访问的 Keycloak，但是这个信息没有最终给到 k8s 里的 pod。</p>\n<p>在 ChatGPT 的指导下走了很多弯路，最后从官网上看到一个关于代理的配置，最终解决了这个问题。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6c504872f083cd0c591c62aa4ba51e98/26781/1680772609411-ee9ea901-b24d-45b8-b0b9-f2119abde6d8.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 336.4864864864865%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,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'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/6c504872f083cd0c591c62aa4ba51e98/fcda8/1680772609411-ee9ea901-b24d-45b8-b0b9-f2119abde6d8.png\"\n        srcset=\"/static/6c504872f083cd0c591c62aa4ba51e98/12f09/1680772609411-ee9ea901-b24d-45b8-b0b9-f2119abde6d8.png 148w,\n/static/6c504872f083cd0c591c62aa4ba51e98/e4a3f/1680772609411-ee9ea901-b24d-45b8-b0b9-f2119abde6d8.png 295w,\n/static/6c504872f083cd0c591c62aa4ba51e98/fcda8/1680772609411-ee9ea901-b24d-45b8-b0b9-f2119abde6d8.png 590w,\n/static/6c504872f083cd0c591c62aa4ba51e98/efc66/1680772609411-ee9ea901-b24d-45b8-b0b9-f2119abde6d8.png 885w,\n/static/6c504872f083cd0c591c62aa4ba51e98/c83ae/1680772609411-ee9ea901-b24d-45b8-b0b9-f2119abde6d8.png 1180w,\n/static/6c504872f083cd0c591c62aa4ba51e98/26781/1680772609411-ee9ea901-b24d-45b8-b0b9-f2119abde6d8.png 2664w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>解决方法是在启动 Keycloak 时传入 --proxy=passthrough 参数。当然，为了确保能够正常工作，还顺便在 Dockerfile 里加了两行环境变量的设置：</p>\n<p>shell\nENV PROXY_ADDRESS_FORWARDING true\nENV FRONTEND_URL <a href=\"https://keycloak-jeff-tian.cloud.okteto.net\">https://keycloak-jeff-tian.cloud.okteto.net</a></p>\n<p>最终的 Dockerfile 如下：\ndockerfile\nFROM quay.io/keycloak/keycloak:latest</p>\n<p>COPY idps/wechat-mobile/keycloak-services-social-weixin.jar\n/opt/keycloak/providers/\nCOPY idps/wechat-mobile/templates/realm-identity-provider-weixin-ext.html\n/opt/keycloak/themes/base/admin/resources/partials\nCOPY idps/wechat-mobile/templates/realm-identity-provider-weixin.html\n/opt/keycloak/themes/base/admin/resources/partials\nCOPY idps/wecom/keycloak-services-social-wechat-work.jar\n/opt/keycloak/providers/\nCOPY idps/wecom/templates/realm-identity-provider-wechat-work.html\n/opt/keycloak/themes/base/admin/resources/partials\nCOPY idps/wecom/templates/realm-identity-provider-wechat-work-ext.html\n/opt/keycloak/themes/base/admin/resources/partials\n#COPY  temp/* /opt/keycloak/themes/base/admin/resources/partials\nCOPY  ui/font_iconfont /opt/keycloak/themes/keycloak/common/resources/lib/font_iconfont\nCOPY  ui/theme.properties /opt/keycloak/themes/keycloak/login/\nCOPY  target/keycloak-justauth-12.0.1-jar-with-dependencies.jar /opt/keycloak/providers/\nCOPY  target/keycloak-justauth-12.0.1-jar-with-dependencies.jar /opt/keycloak/deployments/</p>\n<p>ENV PROXY_ADDRESS_FORWARDING true\nENV FRONTEND_URL <a href=\"https://keycloak-jeff-tian.cloud.okteto.net\">https://keycloak-jeff-tian.cloud.okteto.net</a></p>\n<p>CMD [start-dev, --hostname-strict=false, --proxy=passthrough]</p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}}}},"staticQueryHashes":[],"slicesMap":{}}