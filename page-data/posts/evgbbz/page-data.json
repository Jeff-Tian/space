{"componentChunkName":"component---src-templates-post-js","path":"/posts/evgbbz/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/evgbbz","relativePath":"posts/evgbbz","frontmatter":{"title":"在 eggjs 中集成 Keycloak 用户认证","stackbit_url_path":"posts/evgbbz","date":"2021-03-22T10:28:41","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<blockquote>\n<p>Keycloak 是一个优秀的开源身份与访问管理系统，旨在为现代的应用程序和服务提供包含身份管理和访问管理功能。不少企业包含红帽公司，都将其作为其站点的单点登录工具，通过使用 Keycloak，只需要少量编码甚至不用编码，就能很容易地使应用程序和服务更安全。</p>\n</blockquote>\n<p>今天以 eggjs 为例子，展示只需要少量代码，便可以利用 Keycloak 来保护你的 eggjs 服务。eggjs 是一个基于 NodeJs 的优秀企业级应用框架，不少企业使用它构建自己的服务（我曾经服务过的一个创业公司，基本上所有服务都是一个 eggjs 实例）。</p>\n<p><a name=rXAzh></a></p>\n<h2>效果演示</h2>\n<p>请访问 <a href=\"https://uniheart.pa-ca.me/keycloak/login\">https://uniheart.pa-ca.me/keycloak/login</a> 体验。（<strong>请忍受比较慢的响应速度，因为服务器端使用了免费的服务，并且部署在国外</strong>）</p>\n<p><strong>打开 <a href=\"https://uniheart.pa-ca.me/keycloak/login\">https://uniheart.pa-ca.me/keycloak/login</a> 链接，会自动跳转到 Keycloak 登录页面：</strong><br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/52837a3e1fcc34dcf00e30b29fa2fbbd/161ec/1616407284550-318d0e4f-ce1a-4bba-b1ac-a54a27718203.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 68.91891891891892%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACsUlEQVR42nWUSUscQRTH+1v4HbyJHlwQFR1FYSKKiB5cxwUMgiKiiAYPhpBbIPccPAlREZfgxRwSD1kOOeQQg5qJGSfq6NjjtL1Wd/9C1egwIabgTz3q1fu/peo9bWxsjJGREUZHRxkcHGRgYIChoSH6+/vp6+tjeHhYncdiMbq7u2ltbaWlpYXm5ub83tTURF1dHdXV1WjSuLe3VxlLg66uLjo7O2lra6Ojo0M5kHqJaDRKfX09DQ0NiqC2tlaRVFVVUVFRoXZtenqapaUlFhcXmZ+fZ2Fhgbm5OWZmZpidnWVqaorJyUkmJyYYHx/P47HKbFhlMxSLKcfSgba9vY1cvu8TBMFfCMNQQemAsACB1AGeEHjC5yqdVhloOzs7ecL/LV3XcbI3YN4SmgbhrZHbTYPgNgu2Rfr8jEhjI9rW1pYychznnwjz8Dy8qxT2TQY7o2NldPTLy7wssjekjg+pj0TQNjY2FKHruirKhxBKUsskMLIEtoU4O8X++I5Q2mQzKsLL30lqampyhML3ce4IRQFydc3VNiwogUzV+/IhJweB2mUN1bdZW1vPRWhb99fvIOsaYNieIixcoXR2nszfVoRXV5SXl6Otrr5Wh6msjW4JMhK2UHLa9NBNT72wf3mOd/AV8eM7fvIE//QnIn6Id/QNEnFSv5OUlpahba6vsndk8GTzgOe7x7zYi/PybZxnu0c8fXPEq/1fOcJEHOfTe5zP+4hEHD91hq+n8U5P4CLJReIXpWVlaCsrKypk4QcEYcFfu5NlLV1P4LoCfAHCe/Brpa+vKSkpQVteXlYHtmXhuo76PvdwHQfLsjCMWwzLxnacHGxb3Zc60zQRnkcikaC4uBitvb1dNb4cBj09PflevofsZzkQHkWjahjcD4RIJKJ6WkK2XGVlJUVFRfwBSWOJktkBv/MAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/52837a3e1fcc34dcf00e30b29fa2fbbd/fcda8/1616407284550-318d0e4f-ce1a-4bba-b1ac-a54a27718203.png\"\n        srcset=\"/static/52837a3e1fcc34dcf00e30b29fa2fbbd/12f09/1616407284550-318d0e4f-ce1a-4bba-b1ac-a54a27718203.png 148w,\n/static/52837a3e1fcc34dcf00e30b29fa2fbbd/e4a3f/1616407284550-318d0e4f-ce1a-4bba-b1ac-a54a27718203.png 295w,\n/static/52837a3e1fcc34dcf00e30b29fa2fbbd/fcda8/1616407284550-318d0e4f-ce1a-4bba-b1ac-a54a27718203.png 590w,\n/static/52837a3e1fcc34dcf00e30b29fa2fbbd/efc66/1616407284550-318d0e4f-ce1a-4bba-b1ac-a54a27718203.png 885w,\n/static/52837a3e1fcc34dcf00e30b29fa2fbbd/c83ae/1616407284550-318d0e4f-ce1a-4bba-b1ac-a54a27718203.png 1180w,\n/static/52837a3e1fcc34dcf00e30b29fa2fbbd/161ec/1616407284550-318d0e4f-ce1a-4bba-b1ac-a54a27718203.png 1840w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>以上“微信”按钮，是按照《<a href=\"https://zhuanlan.zhihu.com/p/349504145\">基于 keycloak 的关注公众号即登录功能的设计与实现</a>》一文的介绍，实现的关注公众号即登录功能。推荐使用，因为更方便，但是仅对前 100 名用户有效，因为这是一个测试公众号，受此限制。</p>\n<p><strong>无论是通过邮箱/密码的方式，还是关注公众号的方式，登录完成后，会跳转回 <strong><a href=\"https://uniheart.pa-ca.me/keycloak/login\"><strong>https://uniheart.pa-ca.me/keycloak/login</strong></a></strong> 页面，目前这个页面只返回认证通过的 Keycloak 信息，比如：</strong><br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8911e861a388c4c41618b8d3d6727e25/94774/1616407601445-c9115200-bc00-45d0-b94c-3a97abfba8da.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.810810810810814%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAACAUlEQVR42q2R21LbQAyG/f4PAm1CD0xCDO3QdwBCTgTiQ2zvyetz7NgJP7NyKNz1pjvzjbT6pR2tZA2G33B2PoCxw4vvODv/ivMvAwyHFxgML3D54yfsiY1r+xfskY3R6Arj8QQT+xrjKxsT+wajyzF+2zf4c3sLCwAOhw7/61hMbeCyKbZiCZ/PEcgV+Q6bUtwXfczjM2zFAlvZ54VqTXnvcV8swLUDi+sX+HKGrZzDF70N1JKswROPCNXqpD/CE1O4/J5yjObyB6o3mkw9WCJxqYDFawRqcXpoQX4UP5E1iNRFWjJklUBeSeS7uLeVIrJKot6XsFQssXqaI5YCdVWg7Wq0XfOJmugOexyPh3/PUKVbmomZQSCX1K2BJy9g+pm67Fn3WnxCLRHpNUTinPLWSIoIlkpCeNEKTK8R5wFU5iErBao6RVknRNWkqJoMuyZDsdOEuTdthcOx+4v5gSV1AC9cQRchPZgUjGZlfIPOQ+LdN13oPEBacrrLzIPKfIjUoflaPNnAl1PansentLkNu6PtueyBYi7vNYfdn7iDy+5JN5pZpPlyWgpYcRZhy58QqWckRYBsx5CUIXThI6sYilqhPVTYdyWarkDd5kTT5ji+tgCOAF4/lvKy2WA2n+HZWcLxV/BDB2HkI4hcCMmhdQqtk0+kH7E4QRzrEzHxBuucefYUxgYuAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/8911e861a388c4c41618b8d3d6727e25/fcda8/1616407601445-c9115200-bc00-45d0-b94c-3a97abfba8da.png\"\n        srcset=\"/static/8911e861a388c4c41618b8d3d6727e25/12f09/1616407601445-c9115200-bc00-45d0-b94c-3a97abfba8da.png 148w,\n/static/8911e861a388c4c41618b8d3d6727e25/e4a3f/1616407601445-c9115200-bc00-45d0-b94c-3a97abfba8da.png 295w,\n/static/8911e861a388c4c41618b8d3d6727e25/fcda8/1616407601445-c9115200-bc00-45d0-b94c-3a97abfba8da.png 590w,\n/static/8911e861a388c4c41618b8d3d6727e25/efc66/1616407601445-c9115200-bc00-45d0-b94c-3a97abfba8da.png 885w,\n/static/8911e861a388c4c41618b8d3d6727e25/c83ae/1616407601445-c9115200-bc00-45d0-b94c-3a97abfba8da.png 1180w,\n/static/8911e861a388c4c41618b8d3d6727e25/94774/1616407601445-c9115200-bc00-45d0-b94c-3a97abfba8da.png 3074w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><a name=l89aI></a></p>\n<h2>将 Keycloak 集成到 eggjs 的步骤</h2>\n<p><a name=iIXoN></a></p>\n<h3>首先在 Keycloak 中新建一个 Realm</h3>\n<p>只需要取个名字就好：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 29.72972972972973%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABJElEQVR42qWP30rCABSHvahE2kwSlTFNlIlYaKkokVfVu+j+vVMiXUT0Hr1BBBYUGAuCMsncptsXWxSFdNWBjx+/c+CDE9lrtCiXKyhKiWJRIZXKIAhxRHEDQYyHrEVjrKxGiQsiciZNLpsjnZbIZwokE5vI2S0SiSSSJBPZbe1TKleQ5ByxdZHDo2MMw6Db7aLreohpmhimgabrqJpGT1VRVZWe2kMLeu8zg12k2e7QaHeotw4olHY4O7/gPxOpVBts15rU6m3kfImT/iA8OJNXXm6HjO/vsK6vmFkj7McHZgHWCGf6huO6OI7zi29hNRQq9AenodB1XRb2O9fWhMubJ/DmeJ6H/4Uf4C/xp3C+WIT5PJ0ztMY4th12/+d/vr/08geyE1DxpqEj+gAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/216b3af39ac58ac1c88344cc7d86bc91/fcda8/1616408010616-a74120da-a9e3-439c-9c67-81d68fc6be01.png\"\n        srcset=\"/static/216b3af39ac58ac1c88344cc7d86bc91/12f09/1616408010616-a74120da-a9e3-439c-9c67-81d68fc6be01.png 148w,\n/static/216b3af39ac58ac1c88344cc7d86bc91/e4a3f/1616408010616-a74120da-a9e3-439c-9c67-81d68fc6be01.png 295w,\n/static/216b3af39ac58ac1c88344cc7d86bc91/fcda8/1616408010616-a74120da-a9e3-439c-9c67-81d68fc6be01.png 590w,\n/static/216b3af39ac58ac1c88344cc7d86bc91/efc66/1616408010616-a74120da-a9e3-439c-9c67-81d68fc6be01.png 885w,\n/static/216b3af39ac58ac1c88344cc7d86bc91/c83ae/1616408010616-a74120da-a9e3-439c-9c67-81d68fc6be01.png 1180w,\n/static/216b3af39ac58ac1c88344cc7d86bc91/ab98c/1616408010616-a74120da-a9e3-439c-9c67-81d68fc6be01.png 2356w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n<a name=M5hFC></a></p>\n<h3>然后在这个 Realm 中创建一个客户端</h3>\n<p>取一个名字，后面要用到。然后配置好你的 eggjs 服务所公开的终端节点（域名+路径），可以使用通配符。比如：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 77.70270270270271%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAACkUlEQVR42nWUWVPbMBSF/VdKKQSysCQsIRBCybCkQCYsaac/vC99KkOAENuJJdnWYvt0rrI0QPHMGcmLPunee66d1XwJuZUC8oUSCsU17NcbOLA6xGHjCPVDUgO1Wh2nzWO0L9s4b31D5/IWreY5Ts7O0WpdoNk8Rbt9DWe9vItcYQOfvqzion2D/sCF73lwXRciDBHFMWKSlHZOz8IwhAgFwihCFEX2fjwKOBtbVaxXqlhcKaFz+wP+iGHEBAQLIBiDlhKJ1pNRIUkSGGOQJKkdjUmglEaapnZ0Gs0zVA+OkCtu4Kb7E1JpIMsgeveI3Bew50cEjz1I34V0X6CiEIo2UApqTpqeaQ1nr36M8k4Nn5cLuLru2pd0cc9FHIyQRQKSBVCcQQluQdPFb0WndGr1Y9S/nmAxV8Rl524GZIyBhxF+ezF0kiIDkGakzC78n7Isg0P529zew8JSAVedO7sT5cb3PVuMnhfY3NBFC8aan2d2s+ncKW/XkF+rvALSbr7v29NmRluwMRpGfyCjZwdxqvtHKG3uYGEpb4EEISDZJopi9IccTITQJoWiin4gqQ00ASs7+yiub42B111IKcE5x9D3EUYxfj0GUNq8DxlvlI3lVHYPUJgCO10wxjEajSbGjibAuRzOANk7EdFZLZUnOZyckHMknGH0/ITQ99B7eILbewAf9GEEh+EMJo6tscnkU1H+rG1eAW++WwPrYAgxHEKHAsFLH8/3f+A+PUJxbv0ovYEtwrypqf2oeHPAsbGl4ICWMKH4JyGgxRimyORC2DTMAyn3tsoz4PLYNtMCDFzXNj/l0R8OwYWASVMY6uFJiG9lQ14pbr4GTjqFQqCP6C9CXWPvP2g5+o7ClVLhLxIGLmg244LsAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/e2d10594716156b7938480793e062f7c/fcda8/1616407827840-05b8e780-76e8-4317-8a23-3dd48d23c6b4.png\"\n        srcset=\"/static/e2d10594716156b7938480793e062f7c/12f09/1616407827840-05b8e780-76e8-4317-8a23-3dd48d23c6b4.png 148w,\n/static/e2d10594716156b7938480793e062f7c/e4a3f/1616407827840-05b8e780-76e8-4317-8a23-3dd48d23c6b4.png 295w,\n/static/e2d10594716156b7938480793e062f7c/fcda8/1616407827840-05b8e780-76e8-4317-8a23-3dd48d23c6b4.png 590w,\n/static/e2d10594716156b7938480793e062f7c/efc66/1616407827840-05b8e780-76e8-4317-8a23-3dd48d23c6b4.png 885w,\n/static/e2d10594716156b7938480793e062f7c/c83ae/1616407827840-05b8e780-76e8-4317-8a23-3dd48d23c6b4.png 1180w,\n/static/e2d10594716156b7938480793e062f7c/a5120/1616407827840-05b8e780-76e8-4317-8a23-3dd48d23c6b4.png 2380w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n<a name=UzH7x></a></p>\n<h3>然后，在你的 eggjs 项目根目录下添加一个 keycloak.json 文件</h3>\n<p>内容如下，注意相关字段要和 Keycloak 对应。realm 对应于刚刚创建的 Realm，resource 对应于刚刚创建的客户端名称。\njson\n{\nrealm: UniHeart,\nauth-server-url: <a href=\"https://keycloak.jiwai.win/auth\">https://keycloak.jiwai.win/auth</a>,\nssl-required: external,\nresource: UniHeart-Client\n}</p>\n<p><a name=a5mcg></a></p>\n<h3>随后，添加 @jeff-tian/egg-keycloak 插件</h3>\n<p>shell\nnpm install --save @jeff-tian/egg-keycloak</p>\n<p><a name=aQE6s></a></p>\n<h3>在 config/plugin.ts 文件中，增加如下配置：</h3>\n<p>typescript\n...\nkeycloak: {\nenable: true,\npackage: @jeff-tian/egg-keycloak,\n},\n...</p>\n<p><a name=4KvGd></a></p>\n<h3>最后，在你想要保护的路由前，增加 Keycloak 中间件：</h3>\n<p>比如，在 /app/router/keycloak/index.ts 文件中，这样保护 /keycloak/login 路由（正如示例所做的）。<strong>关键就在于添加的 keycloak.protect() 中间件。</strong>\ntypescript\nimport { Application } from egg</p>\n<p>export default (app: Application) => {\nconst { router } = app</p>\n<p>const subRouter = router.namespace(/keycloak)</p>\n<p>subRouter.get(\nkeycloak.login,\n/login,\napp.keycloak.protect(),\nasync ctx => {\nctx.body = ctx.session[keycloak-token]\n},\n)\n}</p>\n<p><a name=MOP4Q></a></p>\n<h3>完成！</h3>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}},"menus":{}}},"staticQueryHashes":[],"slicesMap":{}}