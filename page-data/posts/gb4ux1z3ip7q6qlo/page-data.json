{"componentChunkName":"component---src-templates-post-js","path":"/posts/gb4ux1z3ip7q6qlo/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/gb4ux1z3ip7q6qlo","relativePath":"posts/gb4ux1z3ip7q6qlo","frontmatter":{"title":"Free Arch: 在 Okteto 上部署 backstage （第一部分： PostgreSQL）","stackbit_url_path":"posts/gb4ux1z3ip7q6qlo","date":"2022-12-08T12:09:41","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p><a name=CumRj></a></p>\n<h1>前情提要</h1>\n<p>在《<a href=\"https://zhuanlan.zhihu.com/p/571009896\">Free Arch: 使用 OAM 摆脱厂商锁定 - Jeff Tian的文章 - 知乎</a> 》里提到了如何切薅 Okteto 的羊毛。今天介绍如何将 backstage 部署到 Okteto。</p>\n<p><a name=mXZia></a></p>\n<h1>backstage</h1>\n<p>backstage 是 CNCF 下的一个项目，是一个构建开发入口站点的开放平台。包含中心化的软件目录，从而可以让整个组织在一个地方管理所有的软件。和 Swagger 的区别是，它不仅可以集中放置 API 文档，也可以放置前端组件，比如 Storybook。</p>\n<p>它有多种部署方式，比如部署到 Heroku，可以参考其官方文档： <a href=\"https://backstage.io/docs/deployment/heroku\">https://backstage.io/docs/deployment/heroku</a>。官方文档也有 Kubernetes 的部署方式，但只是拿本地的 minikube 做为示例，不太方便实际使用。因此本文拿 Okteto 做为目标集群，将 backstage 部署在真正的 Kubernetes 集群上。步骤严重参考了官方的步骤，但是基于 Okteto 的限制，做了一些调整。并且额外提供了使用 GitHub Actions 来自动化部署的方式介绍，以及提供了一个现成的 GitHub 仓库： <a href=\"https://github.com/brick-verse/backstage/actions\">https://github.com/brick-verse/backstage/actions</a> 。</p>\n<p><a name=dosA3></a></p>\n<h1>创建命名空间</h1>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8fc82249d4661ba308ac475a555a41ca/a2b88/1670497417511-775bccf2-c220-4c58-a96c-8f338fc007e5.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.27027027027027%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAACQElEQVR42lWS3UuTcRTHn4vA5svc5mwvbnOvz16ezb08U9NtbtM9TsWQpIyCLoSuhK6K6Lqgf6GLCCSqP6GwJOi2m+6izHLOrXyBbtqU1twn9hiCBz4czvlxvnzP4ScUlFlyeYV0Js/M7CXS6RyRaIJ0JsvUlIKiFMlPFsjmJhkdHScWl4knksTjSWIxWa0T8jByckTNgk+UMFscmK0OvKJEQErg9UcQA1GC4QRSJIk0dILPP4Q/FPtPHDEYRQzGzmShs1vPlavXmZtf4HynDoc7TDieIZrM4g3KmG0ipgEfJpsPvyRjdQTot3iwOvzYnCEV62BArdtvglbXz4OHj7h77z4dml7C0Yus3L7DtRvLLN9aYX5hicTIBFJ0lMdPVllcuokyt0hh9jKp7DRjGYXxjEJqYppUtohgMFro6daj1fbR2WNgIj/D7u4epdI2lUqVavUH5fIOpZ0Kexuf2Xq/zsHHD7xcfaY6c3ojZxD6jBZ0djeGgUE0XXoKxQXasfntO+WdClulbf40GmqP8iY/gU+tBu9Wn2J2hdUTneJpC2r76FaK9I6l0JzrIpMvqrP1w0OVWr1Os9nkuNWCyha/q2Uav/Z4/eI5RqsHp0fC4Q5hcQex2H0IerdIz8gYusQwHQaT+n3aUavVVZdfNr6yv3+g9lqtFsf7bY9NXq29RW+0EorIhKPDmANDXLA4EQw2J712F3qXD43BTG5qTh1uNBrUajVV+PDo6FTw78nyrL1Zx2QTsbvD2F2SSnvtf6BOghjI7ayNAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/8fc82249d4661ba308ac475a555a41ca/fcda8/1670497417511-775bccf2-c220-4c58-a96c-8f338fc007e5.png\"\n        srcset=\"/static/8fc82249d4661ba308ac475a555a41ca/12f09/1670497417511-775bccf2-c220-4c58-a96c-8f338fc007e5.png 148w,\n/static/8fc82249d4661ba308ac475a555a41ca/e4a3f/1670497417511-775bccf2-c220-4c58-a96c-8f338fc007e5.png 295w,\n/static/8fc82249d4661ba308ac475a555a41ca/fcda8/1670497417511-775bccf2-c220-4c58-a96c-8f338fc007e5.png 590w,\n/static/8fc82249d4661ba308ac475a555a41ca/efc66/1670497417511-775bccf2-c220-4c58-a96c-8f338fc007e5.png 885w,\n/static/8fc82249d4661ba308ac475a555a41ca/a2b88/1670497417511-775bccf2-c220-4c58-a96c-8f338fc007e5.png 908w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/67f8f43e27c542c03f5f764505a6339c/d9199/1670497443669-1ec2bdec-895c-45a8-a5b7-be021be6464a.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.08108108108109%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB5klEQVR42pWQy08TURTGZ22MJMZdaZG40MS4duNCoglbULD4N7jwuXBh4mMedWZaNvjPEDduJIWiRoWJiRTaKcVpM9OZYsvM3Hl85p5WoUqMnuSX7zvn3nty7hFOnBxDZnwCudwkxrNnkR3qUXiNn2ePkJsYzTmnxk5DuHp9GpZlwXEcuK4L27bRcV3ynucR/KzVbqN9DLxuWS2EYYj7Dx5CmMvfBo+3K2W8//ARlco7lMsV8qur61hbW0ezuYe/Ra1WIy2WFiHMzOUp6XhdtJ0O3P190pbtoL7bRGPvG9XCOEYQRSOwOKa3QRCQipIMYXbY0PMDdHt9eEPCJAG/HgHk/Sj6gx5jOPB9eF6XeshKAcLMzVuUWK6HnbqJ7bqJr9VthFGEKEloCq6/EycJnO89fNowsLVVpR6SpBxOeMAi+PxbcULK8z5jo4QDekFI03f7fTQau792SRPOzucPt5um+NewbQebxhfi84ZBNeXnl9M0BWNsAF/2cTAG0zSxaRhI4hhPRQ1nMudx+co0MpOXUN2pQy+WINyYX8D/BG/MY/n1G9y5+xjPpCLuPXpCtaWlVxDOXbiI56IMuaBCVnUoqk5e0YoQ5QJeSANESYGm6VA1HYWXKnldL0JVNdJSaRFTU9fwA/BG2KHQw5RqAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/67f8f43e27c542c03f5f764505a6339c/fcda8/1670497443669-1ec2bdec-895c-45a8-a5b7-be021be6464a.png\"\n        srcset=\"/static/67f8f43e27c542c03f5f764505a6339c/12f09/1670497443669-1ec2bdec-895c-45a8-a5b7-be021be6464a.png 148w,\n/static/67f8f43e27c542c03f5f764505a6339c/e4a3f/1670497443669-1ec2bdec-895c-45a8-a5b7-be021be6464a.png 295w,\n/static/67f8f43e27c542c03f5f764505a6339c/fcda8/1670497443669-1ec2bdec-895c-45a8-a5b7-be021be6464a.png 590w,\n/static/67f8f43e27c542c03f5f764505a6339c/efc66/1670497443669-1ec2bdec-895c-45a8-a5b7-be021be6464a.png 885w,\n/static/67f8f43e27c542c03f5f764505a6339c/d9199/1670497443669-1ec2bdec-895c-45a8-a5b7-be021be6464a.png 960w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><a name=SMs5b></a></p>\n<h1>创建 PostgreSQL 数据库</h1>\n<p>生产环境的 Backstage 使用了 PostgreSQL 做为数据库。为了将数据库从 Backstage 应用部署隔离开，我们可以为其单独创建 Kubernetes deployment。</p>\n<p><a name=JNj5R></a></p>\n<h2>创建 PostgreSQL secret</h2>\n<p>这里和官方文档中的示例有些区别，第一是没有采用 base64 编码敏感信息，第二是因为要将代码放在公开的仓库里，所以使用 sops 来加密。</p>\n<p>明文的 secret 文件如下：</p>\n<p>yaml\napiVersion: v1\nkind: Secret\nmetadata:\nname: postgres-secrets\nnamespace: backstage-jeff-tian\ntype: Opaque\nstringData:\nPOSTGRES_USER: xxx\nPOSTGRES_PASSWORD: yyy</p>\n<p><a name=CoeuF></a></p>\n<h3>sops</h3>\n<p>它是一个开源工具，可以使用 AWS KMS 等来对文件进行加密。由于它能“理解”诸如 yaml 这样的格式文档，因此，可以在不泄露敏感信息的同时，保留文件的结构。之前写过一篇文章《<a href=\"https://zhuanlan.zhihu.com/p/351520284\">加密 Kubernetes 集群中的敏感信息 - Jeff Tian的文章 - 知乎</a> 》，可以参考一下。</p>\n<p>这里采用 AWS KMS 的方式来加密 secret，首先在 backstage 项目的根目录下创建一个文件： .sops.yaml，指定要加密的文件路径模式。由于准备将项目的目录结构设置为：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0a29afa498fd79aa2114903728a8c5aa/31198/1670498025392-3b6b653f-3644-4bc7-8659-1f7b31bf5cf4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 107.43243243243244%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAABYlAAAWJQFJUiTwAAADDUlEQVR42n2UyW7bSBCGlUNymFuAJOPB2BJ3dnMTRZmSuDQpbpIo+5RbECAzhpMAAQIkrxAEee5/UC1Lo7GlOfzoheyvq6qrauA4LvJcYLu9QdM0qKoaq9Uats2gqhp03YCm6TAMU85nszmm02vM5wtMJhHCMJTnOXdwefknBszmsCwbURRhvd6gLJfyAI2bTY++38o5Y/wAPSW6/OrqCgOyhKDTKIYQBbIsl7fTGARjjMchwnAiLyWgaVonRV4cgLbF4fExhBAoilK6TG7QT3vtYY+h+/V/gOS/5/nSMoqpoqjyh8dWnLLwJHAXw+khuLSm/eMDxjk9ATIHjDtIM4FlVWM4VDBSVAxHCjTdhGHa52EH2f8CuWmAFDgMbVVKrZoKfdci9ByYqgLb0GDr56SCGRoMVdkBL+IeF9MVLhe3CPr38NfvEGzeY3L7F/6YbfF60uFNtJKi+VO1eBWtceGlGBLwefUVL8rPeNl/w/X9T0R3P5B8/oXfb79jEH/AILnbafE3Buk9nolPeJYf6yMGxRf8Fr/FaHiFgelF0J0QzJsjSpZI6w2Sao152UF0W4h2i1jUyNse4VxgZHlQmC+l8TFUHkDjIRST71xmlgWSz3xcRxHKQiBLE2RJApFnKESOPEuRp6n8zm0bLudwGIOp6zANHZZhQNfU/StzmSIuHyNZpKjqGl23kuWWJCk2/RZV3ciEpz3Szc3tQ+IbZyrFtmWlzGcLLJcV6gcAAcuylHtUigRL00zW7uPKeQJ0WYDZbCHruaoIkCGOZ9ISgpAISN2GgHvYCSA/WEgu13WNtu0O1tAooVmGpmml1cdl+QToBWN4foDJeIYsL9C0HVbrjYybKErUbYu6adF2q10sl0vQGe56cDz/MFq2vQO6fgBS4E8gRCkPE7SgR0kzZLlASXFtWuSiwCJJJYA5LvhergfTegBS47QcD3Ecy65N7pKLruthOBzJxkndZzRSoCqqXO9jdyaGTD5INJkeUoWANB63KepApxrrSSCzHNmZKT12qbKUL/x/Hfoc8B+lAofDWNwQzwAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/0a29afa498fd79aa2114903728a8c5aa/fcda8/1670498025392-3b6b653f-3644-4bc7-8659-1f7b31bf5cf4.png\"\n        srcset=\"/static/0a29afa498fd79aa2114903728a8c5aa/12f09/1670498025392-3b6b653f-3644-4bc7-8659-1f7b31bf5cf4.png 148w,\n/static/0a29afa498fd79aa2114903728a8c5aa/e4a3f/1670498025392-3b6b653f-3644-4bc7-8659-1f7b31bf5cf4.png 295w,\n/static/0a29afa498fd79aa2114903728a8c5aa/fcda8/1670498025392-3b6b653f-3644-4bc7-8659-1f7b31bf5cf4.png 590w,\n/static/0a29afa498fd79aa2114903728a8c5aa/31198/1670498025392-3b6b653f-3644-4bc7-8659-1f7b31bf5cf4.png 694w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>所以要加密的文件目录就是 k8s 子目录下的以 secrets 结尾的 yaml 文件。另外，又指定了 kms 的 arn，以及 aws_profile 的名字。</p>\n<p>yaml\ncreation_rules:</p>\n<h1>If assuming roles for another account use arn+role_arn.</h1>\n<h1>See Advanced usage</h1>\n<ul>\n<li>path_regex: k8s/.+/.+-secrets.yaml$\nkms: arn:aws:kms:us-east-1:443862765029:key/b1739688-ec15-407d-895d-d05ca1217a2f\naws_profile: lambda-doc-rotary</li>\n</ul>\n<p>如上所示，我将要使用的 aws_profile 命名为 lambda-doc-rotary，就需要建立这样的配置文件，在 ~/.aws/config位置：</p>\n<p>shell\n[default]\naws_access_key_id = xxxx\naws_secret_access_key = yyy\naws_session_token = zzz\noutput = json\nregion = cn-northwest-1</p>\n<p>[lambda-doc-rotary]\naws_access_key_id = xxxx\naws_secret_access_key = yyyyy</p>\n<p>这样，要加密文件时，就可以使用命令：</p>\n<p>shell\nsops -e -i k8s/postgres/postgres-secrets.yaml --aws-profile lambda-doc-rotary</p>\n<p>对应的，要解密时，就用：</p>\n<p>shell\nsops -d -i k8s/postgres/postgres-secrets.yaml --aws-profile lambda-doc-rotary</p>\n<p><a name=n1HSD></a></p>\n<h3>k8ss</h3>\n<p>k8ss 是我写的一个命令行小工具，可以方便地在多个集群之间进行切换。目前只是一些命令的转换，但是以后可以扩展得更方便的使用（比如打通用户系统，从而可以将多个集群的配置文件在云上存储）。目前它是通过额外的 github 仓库，k8s-config 里保存了多个配置文件后，从而自动切换选中的配置。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a3a4c43dfe86ba6b702891d03cd776ee/daed9/1670498596984-71864e5d-c93f-425a-95b2-737e29f37d56.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 106.75675675675676%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAABYlAAAWJQFJUiTwAAACsUlEQVR42nVUWXajMBDkJDOOzY4WJMQOdmwnTmb7mPsfpuZ1Y2zwOB/1WmgpdXWX8KpmRNXu0fQnKFOj6Y8omxG6aKFyB6kLCGnghymCKENwi8vxfc7bRQqhHhAUb4jsEVH5gaj8RNz8RiQrhJnFJpB4CZ8gUusYSni7WMNPDSLpENyiRSgKxNLxt5/kHGmO9sSqRJgV8BPDe+h8LEtEooDnJxpGlyhdhzC1SPOaDxFJljcQpuVxokokuuK1zDS8jwhTXWMX50yY6mrKcEvpBgKbQCCSJarxgv70C5lpOZOZaLrM4vsuxcbPeD/JrIZ3dMefkG6YCGlyGynekKgKtnmFqV8hi56/Y0bJY5JO0iLhrmUpodwAXY4QtlsTfvMFrOvw/vYB057QHj5Qj5cp7i98AUEUHR++o2U1/xG+hIIllt0Z58+/CAU1xCJICwaNCVneIs0bmPrANd4lOZeE4O1itZJMUkzzima8cLE3Aa1PoD0EasScEREvk/Kq7sBES0JNNXEdVNFiG8kbESPWXEtqEHWbfLpc9/aH44qQrFIOF8j2B/LxDzJ3YDtQJkRCMa8PLJcaMc3d4Qll113WFYruDN2cYYdPCDciyOytqxSpMdTZ2VbU9fAKb/tgm1myMDUUyXY95j0zSDJdTAQvVy+unt6KUDqWIm3HWZDP2PzXGtE40TWDX0mSr2v4JWHRcaS3ujywm5uip3pGD+tPCdn5JNu2/Ia/IqQu0/6lpf4nFHdCGs8OWNomvhIS8bIcTwlj7aCrAbrqkZpqdfucYXz14aPcO2FEfxuFwCUQg0Fx7OFOPbJeI7AZtuFjU6YMqSSk4jmhrxDWMcQ+hz21KE4NxF4hqjK+7H5IX03e8B+IXLBdyL5LZmkSgVSIjUXe9jBdz6aeM1s2Za4fn6W1K/4BpZiA03DcOWcAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/a3a4c43dfe86ba6b702891d03cd776ee/fcda8/1670498596984-71864e5d-c93f-425a-95b2-737e29f37d56.png\"\n        srcset=\"/static/a3a4c43dfe86ba6b702891d03cd776ee/12f09/1670498596984-71864e5d-c93f-425a-95b2-737e29f37d56.png 148w,\n/static/a3a4c43dfe86ba6b702891d03cd776ee/e4a3f/1670498596984-71864e5d-c93f-425a-95b2-737e29f37d56.png 295w,\n/static/a3a4c43dfe86ba6b702891d03cd776ee/fcda8/1670498596984-71864e5d-c93f-425a-95b2-737e29f37d56.png 590w,\n/static/a3a4c43dfe86ba6b702891d03cd776ee/efc66/1670498596984-71864e5d-c93f-425a-95b2-737e29f37d56.png 885w,\n/static/a3a4c43dfe86ba6b702891d03cd776ee/c83ae/1670498596984-71864e5d-c93f-425a-95b2-737e29f37d56.png 1180w,\n/static/a3a4c43dfe86ba6b702891d03cd776ee/daed9/1670498596984-71864e5d-c93f-425a-95b2-737e29f37d56.png 1426w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>在以上的 secrets 建立好之后，就可以将它应用到 Okteto 集群中去，注意，由于 secrets 文件已经被加密，所以在应用前需要先解密。</p>\n<p>shell\nk8ss switch --cluster=okteto --namespace=backstage-jeff-tian\nsops -d k8s/postgres/postgres-secrets.yaml --aws-profile lambda-doc-rotary | kubectl apply -f -</p>\n<p>应用之后，可以检查一下：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/78e2bd13ed39956a3a1552f6fac35a77/fa63f/1670498722914-a95ab955-5b97-46aa-9f6f-ef9ffaf12bfa.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 18.91891891891892%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA3UlEQVR42lWH23KCMBQAjxJIIBdAFISkYr2MOtqOD/3/X9vOWF/6sLO74nYzJk7otkfrDUNl2TYrYhxxtiR497YlV0tE5B8qV3jvybIlpjRIYwO1DbR1S/ABpXK0HwjjBdPO6DBimg9MkyibhO32L0y7I3MjOte4ymOKkl2akcN94viInL4S/b5GBWE6D1x/LqRbpJsbtqee8TzQH9evjteJMDmKLsduFGa1wA8Fh0dChueR9fdMd050MbJda273PZfnJ2IEZYWsEpbVn7P3KyfkXtD1gqIWiiCUbcYvYoxfForJ7C4AAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/78e2bd13ed39956a3a1552f6fac35a77/fcda8/1670498722914-a95ab955-5b97-46aa-9f6f-ef9ffaf12bfa.png\"\n        srcset=\"/static/78e2bd13ed39956a3a1552f6fac35a77/12f09/1670498722914-a95ab955-5b97-46aa-9f6f-ef9ffaf12bfa.png 148w,\n/static/78e2bd13ed39956a3a1552f6fac35a77/e4a3f/1670498722914-a95ab955-5b97-46aa-9f6f-ef9ffaf12bfa.png 295w,\n/static/78e2bd13ed39956a3a1552f6fac35a77/fcda8/1670498722914-a95ab955-5b97-46aa-9f6f-ef9ffaf12bfa.png 590w,\n/static/78e2bd13ed39956a3a1552f6fac35a77/efc66/1670498722914-a95ab955-5b97-46aa-9f6f-ef9ffaf12bfa.png 885w,\n/static/78e2bd13ed39956a3a1552f6fac35a77/c83ae/1670498722914-a95ab955-5b97-46aa-9f6f-ef9ffaf12bfa.png 1180w,\n/static/78e2bd13ed39956a3a1552f6fac35a77/fa63f/1670498722914-a95ab955-5b97-46aa-9f6f-ef9ffaf12bfa.png 2298w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><a name=XRoLT></a></p>\n<h2>kustomization</h2>\n<p>除了 secrets 独立应用之外，其他的资源，准备使用 kustomization 来应用，于是先建立如下的 kustomization.yaml。</p>\n<p>yaml\napiVersion: kustomize.config.k8s.io/v1beta1\nkind: Kustomization</p>\n<p>bases: []\nresources:</p>\n<ul>\n<li>postgres-deployment.yaml</li>\n<li>postgres-service.yaml</li>\n<li>postgres-storage.yaml</li>\n</ul>\n<p><a name=Rgspc></a></p>\n<h2>创建 PostgreSQL deployment</h2>\n<p>和官网的 Kubernetes 示例一样：</p>\n<p>yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\nname: postgres\nnamespace: backstage-jeff-tian\nspec:\nreplicas: 1\nselector:\nmatchLabels:\napp: postgres\ntemplate:\nmetadata:\nlabels:\napp: postgres\nspec:\ncontainers:\n- name: postgres\nimage: postgres:13.2-alpine\nimagePullPolicy: IfNotPresent\nports:\n- containerPort: 5432\nenvFrom:\n- secretRef:\nname: postgres-secrets\nvolumeMounts:\n- mountPath: /var/lib/postgresql/data\nname: postgresdb\nsubPath: postgres\nvolumes:\n- name: postgresdb\npersistentVolumeClaim:\nclaimName: postgres-storage-claim</p>\n<p>上面通过 metadata 让 Kubernetes 知道我们要部署的一个或者多个应用实例的信息，这里指定了名称和命名空间。其中 spec 块描述了预期的状态，即请求 Kubernetes 创建一个副本（运行的 PostgreSQL 实例），并且通过指定的 pod template来创建这个副本。在这个 template里又指定了一些元信息和预期的状态。在这个模板里的 spec指定了需要一个容器，这个容器需要从公开的 postgres:13.2-alpine Docker 镜像中创建出来。</p>\n<p>注意其中的 envFrom和 secretRef，它们告诉 Kubernetes 从我们刚才创建的 secrets 中读取秘密值，并且填充到容器的环境变量里。</p>\n<p>另外，要注意 volumeMounts下的 subPath，这是官方文档里没有提及的，可能在 minikube 中不需要它，但是在 Okteto 环境里，必要要加 subPath，否则会出现这样的错误：</p>\n<p>yaml\n2022-12-08 11:54:33.07 UTCpostgres-84db9b4d44-tjvt9postgresinitdb: error: directory /var/lib/postgresql/data exists but is not empty\n2022-12-08 11:54:33.07 UTCpostgres-84db9b4d44-tjvt9postgresIf you want to create a new database system, either remove or empty\n2022-12-08 11:54:33.07 UTCpostgres-84db9b4d44-tjvt9postgresthe directory /var/lib/postgresql/data or run initdb\n2022-12-08 11:54:33.07 UTCpostgres-84db9b4d44-tjvt9postgreswith an argument other than /var/lib/postgresql/data.</p>\n<p>这可能是由于 Okteto 环境里的磁盘特性导致的。\n<a name=kIfkm></a></p>\n<h2>创建 PostgreSQL service</h2>\n<p>当数据库 pod 运行起来时，我们怎么让其他的 pod 来连接它呢？</p>\n<p>Kubernetes pods 可以被停止、重启以及动态创建。所以我们不能直接去连接 pod，而是应该创建 Kubernetes service，再连接 service。Service 会跟踪 pod，并且将流量导入到正确的地方。这个 service 定义如下：</p>\n<p>yaml\napiVersion: v1\nkind: Service\nmetadata:\nname: postgres\nnamespace: backstage-jeff-tian\nspec:\nselector:\napp: postgres\nports:\n- port: 5432</p>\n<p><a name=T2WWy></a></p>\n<h2><br /></h2>\n<p><a name=jaQb2></a></p>\n<h2>创建 PostgreSQL 存储卷</h2>\n<p>PostgreSQL 需要一个持久化存储卷来保存数据，遗憾的是，在 Okteto 环境里，是不允许创建集群范围的资源（如 Persistent volumes）的。因此这一步，不能参考 backstage 官方的文档，参考 <a href=\"https://stackoverflow.com/questions/59221434/creating-a-persistentvolume-on-okteto-cloud\">https://stackoverflow.com/questions/59221434/creating-a-persistentvolume-on-okteto-cloud</a>，最终适配了 Okteto 环境的存储卷定义 postgres-storage.yaml 如下：</p>\n<p>yaml\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\nname: postgres-pv-claim\nnamespace: backstage-jeff-tian\nspec:\nstorageClassName: manual\naccessModes:\n- ReadWriteOnce\nresources:\nrequests:\nstorage: 2G</p>\n<p><a name=PZu2E></a></p>\n<h2>部署到 Okteto</h2>\n<p>手动部署：\nshell\nkubectl apply -k k8s/postgres</p>\n<p>检查一下 Okteto 的面板：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a7f583ab3ccc721d55d52787c3353c57/10686/1670501069874-7348ef47-422f-4fdb-8bf0-72fd4030ce75.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABzklEQVR42m2R23KbMBRF+YTW8QUjBBISuoC5GPAkcdI2fer/f9FqjdPMdNKHNQftGZa2pKQfF8b5ynR5pe0vdMMjTTfTnGa0bTHuRFWf1ml9d8d1GHf/vuV1HOmnK/PzG8nBRob5lcoNSN2iw4l2fKE9fyMO15VmfMF3Tyh3RrsJtXJG1XdumfYTOi4klT8xLD/WH7SfscPM9PNK7J+xYUHVA9qNqHqkMB2l7Vf+5tqfsXHBnx6xzYVESLPuWIUFEy9UbmG6PmEng8g0WtYcjppUKGRpyHJNmhWIdZYcMsX+WN5zoUm2+/xDtgrDjJAe3Xjai6c3E4VsKE2gMgFVefT7LFWN0o5jVvKwy9hsjyQP/xEWVSQvPK6OLI8tsojkpeMoSrZ7wT7N2ady5bb+sjl88FnoZwodkdpjRMtgR9yTRWiDlDVSWYp3slytwt0hXxt+fUhJNjvxuaEOa6PaNHRmoLCB8KapnEOVAV0FZGEReUV6VBzSYpWuwjRT/whvL11WkVLf7qnGBcchs0hT4b9LyqioYk3VWEqnEUayzwTbnVhbJqZuPx+5ikgVCKGl7zpyHbF1T9N3jL8cYWhxp4jvGnSw7I6Cr5uUzR/hb7E4HasdjEh8AAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/a7f583ab3ccc721d55d52787c3353c57/fcda8/1670501069874-7348ef47-422f-4fdb-8bf0-72fd4030ce75.png\"\n        srcset=\"/static/a7f583ab3ccc721d55d52787c3353c57/12f09/1670501069874-7348ef47-422f-4fdb-8bf0-72fd4030ce75.png 148w,\n/static/a7f583ab3ccc721d55d52787c3353c57/e4a3f/1670501069874-7348ef47-422f-4fdb-8bf0-72fd4030ce75.png 295w,\n/static/a7f583ab3ccc721d55d52787c3353c57/fcda8/1670501069874-7348ef47-422f-4fdb-8bf0-72fd4030ce75.png 590w,\n/static/a7f583ab3ccc721d55d52787c3353c57/efc66/1670501069874-7348ef47-422f-4fdb-8bf0-72fd4030ce75.png 885w,\n/static/a7f583ab3ccc721d55d52787c3353c57/c83ae/1670501069874-7348ef47-422f-4fdb-8bf0-72fd4030ce75.png 1180w,\n/static/a7f583ab3ccc721d55d52787c3353c57/10686/1670501069874-7348ef47-422f-4fdb-8bf0-72fd4030ce75.png 3834w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><a name=gp5mr></a></p>\n<h1>创建 backstage 应用</h1>\n<p>今天成功在 Okteto 里部署了 PostgreSQL，先到此为止。 最终可以使用的产品 backstage，明天再继续。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a6128155da57ec461b7a20e4da296dc9/1e5d2/1670501053394-1f1ce9bc-992f-4d5d-8446-568979fe457d.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 77.70270270270271%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABYlAAAWJQFJUiTwAAACPklEQVR42n1T2VLbQBDc7yABW7bOlbRarW7rsgGDy5AU4TX//x2dmpEFooA8dPXMStXbPSOJtr9FvRuRpCWqpkdRtVA6hzYlI0kLRMrwGdXEtiuxdQLYTjDxpXe8EOLp9S9MNSCrB5iyQ6hLuDKFG2XwVYGivcNw/IVmPKEeH1H2RxxOL2j2J/T3zxgffr/VKu8gZLqDND2k6RBmA2Q2wtMti7FonCPUNQJVIkhKPpe6YqZ+WbuhgXDiGk56gKMHZq86w82PcEKDjZ/gxg5xvZVYOxFWtsTKDj/ghp+FWG2nZ8INU0iVgzjSJZxAca/ylt0pU8OU/VRnLQJ2M7ny4wJxtoMjDaeIzQ7CDlJ2Qg4sV2HtxLDcGBtPwXIi+H6MMNSwfQU70Nj6yQfMZ8QEUZwP6A5PKLt7HnrVH1EPD6iGI5rxER0Nu+h5BBZfGv8XwlMZ26XhJkXHESgucWR2zF6Uswt2fXH/HUSSd8h3t7wlW6bshCFTHsPajXlG1BPTJina5iLMkQP9dpFY3j5jng/NVMYZqvYAXY7QZY/INCATntnD8g0vi75V0iEDImqm7VDMKG0QZ+2naHM9XTwvRHNNmBfDDt1oirjc3NKt5Smk1Qhflbhaufhp+Rd4zD/W3huoF+SIYqzt8NPGSHD+gOllElxiFlmKCtpk1ux5KV/FJDHLV1M8/x0Umf6iWXSG+Epk2W+DBO35jMPpFfvTH4yPL4zu7hlulONq5Xwt+B3Tv3q9CSaesZkwx10K/gNC9OWrl01HsQAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/a6128155da57ec461b7a20e4da296dc9/fcda8/1670501053394-1f1ce9bc-992f-4d5d-8446-568979fe457d.png\"\n        srcset=\"/static/a6128155da57ec461b7a20e4da296dc9/12f09/1670501053394-1f1ce9bc-992f-4d5d-8446-568979fe457d.png 148w,\n/static/a6128155da57ec461b7a20e4da296dc9/e4a3f/1670501053394-1f1ce9bc-992f-4d5d-8446-568979fe457d.png 295w,\n/static/a6128155da57ec461b7a20e4da296dc9/fcda8/1670501053394-1f1ce9bc-992f-4d5d-8446-568979fe457d.png 590w,\n/static/a6128155da57ec461b7a20e4da296dc9/efc66/1670501053394-1f1ce9bc-992f-4d5d-8446-568979fe457d.png 885w,\n/static/a6128155da57ec461b7a20e4da296dc9/c83ae/1670501053394-1f1ce9bc-992f-4d5d-8446-568979fe457d.png 1180w,\n/static/a6128155da57ec461b7a20e4da296dc9/1e5d2/1670501053394-1f1ce9bc-992f-4d5d-8446-568979fe457d.png 1630w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}},"menus":{}}},"staticQueryHashes":[],"slicesMap":{}}