{"componentChunkName":"component---src-templates-post-js","path":"/posts/sycunq/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/sycunq","relativePath":"posts/sycunq","frontmatter":{"title":"Free Arch：将 Koa 服务部署到 Vercel","stackbit_url_path":"posts/sycunq","date":"2022-07-15T11:40:07","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p>多年前写的 Koa Js 服务，本来跑在服务器上，要一点花销。后来决定薅各大云厂商的羊毛，就将它容器化了，跑在免费的 Okteto 提供的 K8S 环境里。但是最近 Okteto 提供的 url 访问不了了，虽然发了邮件请 Okteto 帮忙协助，但是本着狡兔三窟的原则，决定再部署一个实例到其他的服务上。</p>\n<p>于是将目光瞄准到 Vercel，Vercel 提供免费的 Serverless Function，虽然类似 AWS Lambda，但又不太一样，所以记录一下。如果只是将 koa 服务部署到 AWS lambda，那么只需要使用一个 serverless-http 的框架转化一下就好。关于薅 AWS Lambda 羊毛的文章已经写过多篇，参见：</p>\n<p><a href=\"https://zhuanlan.zhihu.com/p/415577362\">https://zhuanlan.zhihu.com/p/415577362</a></p>\n<p><a href=\"https://zhuanlan.zhihu.com/p/351889768\">https://zhuanlan.zhihu.com/p/351889768</a></p>\n<p><a name=cAIQv></a></p>\n<h1>Koa Js</h1>\n<p>Koa Js 是由 Express Js 的原班人马设计的 Web 框架，更小巧但是不再捆绑任何中间件，这一点也是我在将它部署到 Vercel 时碰到坑的原因。尽管它比 Express 新，但 Express.js 仍然更加流行，也许这也是 Vercel 内置对 Express.js 的支持的原因吧。</p>\n<p>Express Js 目前的星标数在 57.6 K，而 koa 的星标数大约是它的一半多一点：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1915dac6588dca937188efca117fe9ac/720e3/1657882249908-9d4e4afc-7394-4cf7-9c91-d0b067f0af37.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 31.08108108108108%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABRElEQVR42k2QSXLbMBBFeRXJDgmCBEAAHCBSk0uWU175BD6my4kdDZaHHOulgGSRxavq/tX9e8ief/7i6fmFH6/HxMvhzPn9i8P5ncPpkjhdPnn7+J30yP/x8e2D4+WLU+KTzC9uUH5kWN8RVnuk7tAuUNSOuWi4lhblJ9pxR9NvaPo17bSjGTbEXqF7SjulGtdNZEJ3zHLNN2nJ7ZrC3SDaWwq7oag980In7LClW96iu1Uy7Vd7TL9G+WXS45DS9GSzvE4NV8IgTaBQPdKOVG4irxyl7ih1Txxc2ZDIa49yI0J1SZc6IOvAlWjIotEsV+TS4tsRZUPaLCJUS+3Gf0YLpOmpTKDUAWEGCtUi9YAIHrlrmQtNFreLhvFXzbBNZ0gzJEy7xIXt3/+EbcqrZsQNO/zqezp73NyzeNizfLxjXmr+AIpD3ys9y4aSAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/1915dac6588dca937188efca117fe9ac/fcda8/1657882249908-9d4e4afc-7394-4cf7-9c91-d0b067f0af37.png\"\n        srcset=\"/static/1915dac6588dca937188efca117fe9ac/12f09/1657882249908-9d4e4afc-7394-4cf7-9c91-d0b067f0af37.png 148w,\n/static/1915dac6588dca937188efca117fe9ac/e4a3f/1657882249908-9d4e4afc-7394-4cf7-9c91-d0b067f0af37.png 295w,\n/static/1915dac6588dca937188efca117fe9ac/fcda8/1657882249908-9d4e4afc-7394-4cf7-9c91-d0b067f0af37.png 590w,\n/static/1915dac6588dca937188efca117fe9ac/efc66/1657882249908-9d4e4afc-7394-4cf7-9c91-d0b067f0af37.png 885w,\n/static/1915dac6588dca937188efca117fe9ac/c83ae/1657882249908-9d4e4afc-7394-4cf7-9c91-d0b067f0af37.png 1180w,\n/static/1915dac6588dca937188efca117fe9ac/720e3/1657882249908-9d4e4afc-7394-4cf7-9c91-d0b067f0af37.png 1962w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/72f4325e33941217ff413250a4bbd8fd/99e81/1657882236183-0cc43e29-7de2-45e9-81f0-159a95833e21.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 29.72972972972973%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABMElEQVR42kVQ7U7CQBDsm6iF9u7au157vR60VIiAiQ9qNBKNllK+fLgxt0D8Mcnszu7sR/D6vsHbxyc2Xx263RHb4YKffo/v7UDw8XD8Rb8/o9+fiO8OZ0K3O6AbTlTTD0cEQk+gygb14gXldAGuLBI9wYjnuIsk7mOFtKhh6idktiV4rqs58skCsbSI9QyymEKXNYKQa4RMIZIOrFyCywquWVGxb6zaNZnYZolqtoY0DeVts4IyNVwzh2vXcO0zknyKIGQZwliCmzlY8YgwVoiSAiORY3zFiGvEqbnkuUZ040Ij8kj+tcBv503HPEOaWRJE5sDUlWtH8VgU4Kqil/ghLLWIRUmaHxbLknxowweWgacGhakhsopEb8bk5Z++iXA158pBNBZsZmjQ7Rpv+AcYlNivcW1nSAAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/72f4325e33941217ff413250a4bbd8fd/fcda8/1657882236183-0cc43e29-7de2-45e9-81f0-159a95833e21.png\"\n        srcset=\"/static/72f4325e33941217ff413250a4bbd8fd/12f09/1657882236183-0cc43e29-7de2-45e9-81f0-159a95833e21.png 148w,\n/static/72f4325e33941217ff413250a4bbd8fd/e4a3f/1657882236183-0cc43e29-7de2-45e9-81f0-159a95833e21.png 295w,\n/static/72f4325e33941217ff413250a4bbd8fd/fcda8/1657882236183-0cc43e29-7de2-45e9-81f0-159a95833e21.png 590w,\n/static/72f4325e33941217ff413250a4bbd8fd/efc66/1657882236183-0cc43e29-7de2-45e9-81f0-159a95833e21.png 885w,\n/static/72f4325e33941217ff413250a4bbd8fd/c83ae/1657882236183-0cc43e29-7de2-45e9-81f0-159a95833e21.png 1180w,\n/static/72f4325e33941217ff413250a4bbd8fd/99e81/1657882236183-0cc43e29-7de2-45e9-81f0-159a95833e21.png 1946w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>看了一下 koa 的贡献者列表，我居然也名列其中呢：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 101.35135135135135%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAABYlAAAWJQFJUiTwAAADRElEQVR42m1Uy47cRBT1l8AMbZftergetsvudrd7Jj3pEUEZwoKXAAmBZgELfoENYsGSBQt+BYXJPBRBQphkxP8cdMtuMySzOLrVXefeKp976kbXr27w6uYfXL+8wdM/nuG3x0/w+OwCZ+eXODu/wu/nV7g6v8DlxSWeXD7Fn8//xvMXL/HsxfWb+Osa0SwzSJVHquoQs4LQjNEj1i3m0uCQS8yKFlngvQniJqJExE0D1x6iqFcwvodt1iiqJUyzhvU9eN3jwHmcWAcx38DQnl8HEI/4lKfrFaRbIEpVBeE6cF1Dmgaq7CDsPMSi7JDaBTpd4gORI9MNBPFsO/Go6G6da4+IFyXaboXU9mCmxyzTE95JC8TcIuMGn/kGevsxErMG04uwFzgjL+EWqawQGVdhu+mhuweQ7TGYskjz/4oybvF2bvHdwQHuf/otePsuZLNBrDSEsIhDQR0ODgVJUG7mENpDGA9VLoIWOyg3R2wW+DqfYSE1MuMnaW7zCLluEOWFH3UYtCBxKe6gyw6x6/CREvjQOSRVH7R9nUc1SMcoK+pJ2LtAyTPX4aGUODUS+2UPXS7u5ArTDrapFpvhNqNtaB3s0KzHGy7xoND43uWIqx7O92Ev8NqDYJvphmTsPVaAbkqmJQmo/Ttw3YAVHjov8EUWIyVe8RovrJuQHx2/9wg//PgTWHmEzB8PNmAK+0xhL5FDt7lDv97g4ckJkmqL3G8x4yX2Eznx4twMBef9ET7/8hTcdVD1GqmtwVWJVJRIhAMTJWa5RduusL23Qe5WkOUSmamRyzI8NzbyKEZJSKygRotQ96auV8uwJkswksPMg62IG7o87v+vy/T9uqakwVdqJEw+HJ8VaVlU3cQr7uJRl4eC/XTK7RNvv1NyA7ngLp4aIWy78+EqfEaYMmMSxd2aCtJ4Gm4/fO5uupC9diYPN8xUhWp+gETWYMqDiSq8y4S7ACaH5tCEqReHiHkJJuugO/1/m0eICtegv3cE2b0PffgJWLlEmkrM0gJ7TIUp8lYs8NXpN/j5l1+RlFsU/SPkzX3M2GCbfTbYhkZhxEZ7CNMEcOuhbAuhm2BWagZNEWpcszoKv4VtwI2fODse+fBfaw6e5A8RVMgAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/48647da7ed97f8dd1894288d1bed2b69/fcda8/1657882020421-27b0ac7f-5a80-4294-a08e-57505ad1d63b.png\"\n        srcset=\"/static/48647da7ed97f8dd1894288d1bed2b69/12f09/1657882020421-27b0ac7f-5a80-4294-a08e-57505ad1d63b.png 148w,\n/static/48647da7ed97f8dd1894288d1bed2b69/e4a3f/1657882020421-27b0ac7f-5a80-4294-a08e-57505ad1d63b.png 295w,\n/static/48647da7ed97f8dd1894288d1bed2b69/fcda8/1657882020421-27b0ac7f-5a80-4294-a08e-57505ad1d63b.png 590w,\n/static/48647da7ed97f8dd1894288d1bed2b69/efc66/1657882020421-27b0ac7f-5a80-4294-a08e-57505ad1d63b.png 885w,\n/static/48647da7ed97f8dd1894288d1bed2b69/c83ae/1657882020421-27b0ac7f-5a80-4294-a08e-57505ad1d63b.png 1180w,\n/static/48647da7ed97f8dd1894288d1bed2b69/1e093/1657882020421-27b0ac7f-5a80-4294-a08e-57505ad1d63b.png 1376w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n<a name=UAjpv></a></p>\n<h1>Vercel</h1>\n<p>Vercel 是一个用来部署前端应用的云平台，但也可以用来构建轻量级的事件驱动 API，并部署到它们的全球边缘网络。\n<a name=jdBuo></a></p>\n<h1>Vercel 的 Serverless Function 有些特别</h1>\n<p>传统 API 托管在运行着的服务器上。当应用需要扩展时，希望更低成本、更灵活、更安全、资源快速分配并启动等等，使用传统服务器很难做到。但是用 Serverless 就比较容易，因为仅仅是一些后端代码片段在无状态环境中运行着，它们由事件（比如 http 请求）触发并只在一次调用中存活。这可以全部自动化并且在毫秒级扩展。更好的是，不用再维护服务器了。开发者只需要关注业务逻辑——返回值的函数。</p>\n<p>如果我们部署一个服务器程序到 Serverless Function，我们就为每个请求执行了一个完整的服务器实现，这是一个反模式，因为 Serverless 函数仍然是函数，只应服务于一个目的。将服务器程序部署在 Serverless Function 上，相当于强行将庞大的逻辑混杂在一个函数里。虽然这是一个反模式，但是羊毛在那里，不得不薅。对于有钱的企业级服务器程序，还是建议绕道。</p>\n<p>Vercel 的 Serverless Function 和 AWS Lambda 很像，比如都是一个对外暴露 handler 函数的模块，但是特别之处在于其 handler 签名不一样。AWS Lambda 的 handler：</p>\n<p>javascript\nexport default const handler = (event, context) => Hello World</p>\n<p>但是 Vercel 的 handler 接收一个 req 和 res 参数（<a href=\"https://github.com/Jeff-Tian/v/blob/master/api/test.js\">https://github.com/Jeff-Tian/v/blob/master/api/test.js</a>）：\njavascript\nexport default function handler(req, res) {\nconst { name = World } = req.query;\nreturn res.send(Hello ${name}!);\n}</p>\n<p><a href=\"https://v.pa-pa.me/api/test?name=Jeff\">https://v.pa-pa.me/api/test?name=Jeff</a>：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 31.08108108108108%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAwklEQVR42qWQzUrDQBSF5/1fpNjqA7gSHUs3wSyFLFJpRelMZqbTJG1+OvNJExF/Vq0HLudwuHxcrlBK0/c9MUbquuLd7Fm9aR6fCyb3S24Wa6byhcldxtVDzvV8xUwumc7X3D69cugC+/b4NSLPc4y1lGWFMYayqil2HWrbsHEHNq75zKMr346+bdC+HXYL342+6xBSSpIkIcsy0jRFa8V/JLz3f8oQ4/CCS0ZYawkh/ChP+p7PutA5NwB/Qy6BnYAf33TPlaW85iQAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/8a7c1f7ac6a673d69f38ce08b887d966/fcda8/1657883584815-5c5e5cc9-16ea-4e3b-bf85-ffa72c68a420.png\"\n        srcset=\"/static/8a7c1f7ac6a673d69f38ce08b887d966/12f09/1657883584815-5c5e5cc9-16ea-4e3b-bf85-ffa72c68a420.png 148w,\n/static/8a7c1f7ac6a673d69f38ce08b887d966/e4a3f/1657883584815-5c5e5cc9-16ea-4e3b-bf85-ffa72c68a420.png 295w,\n/static/8a7c1f7ac6a673d69f38ce08b887d966/fcda8/1657883584815-5c5e5cc9-16ea-4e3b-bf85-ffa72c68a420.png 590w,\n/static/8a7c1f7ac6a673d69f38ce08b887d966/3f3b9/1657883584815-5c5e5cc9-16ea-4e3b-bf85-ffa72c68a420.png 870w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>这签名看起来很像是 Express.js 中间件，有意思的是，它真的支持完整的 Express.js 应用，只需要将入口文件放在 /api/index.js 里即可。</p>\n<p><a name=OlbX1></a></p>\n<h1>Vercel Serverless Function 对 Koa 的支持</h1>\n<p>经过实验，Vercel Serverless Function 是不支持 Koa.js 应用的。因为它的签名和 (ctx, next) => ctx.body = Hello 这种 Koa.js 风格就不相容。</p>\n<p><a name=On49w></a></p>\n<h1>koa-to-express</h1>\n<p>想将 Koa 应用搬到 Vercel Serverless Function，但是不希望改已有的 Koa 代码，最自然的方式莫过于增加一个 adapter，将 koa 风格的中间件函数适配成 express.js 的中间件函数。于是找到了 koa-to-express 这个库。</p>\n<p><a name=EMQew></a></p>\n<h2>增加 /api/index.js 文件</h2>\n<p>该 index.js 引用 Koa 应用的入口文件，并将它的中间件做个转换，伪装成一个 Express.js 应用。这样，原来的 Koa 应用在服务器环境中仍然照常运行，同时又可以在 Vercel Serverless Function 环境里运行。如果再使用 serverless-http，再在 AWS Lambda 里部署一个适配，那么就是名副其实的“狡兔三窟”了。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1ef813c16212003ba6536793d07710fd/f6f78/1657884240097-87917261-4f4b-46c8-abc1-5c67490544a6.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 168.24324324324326%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,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'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/1ef813c16212003ba6536793d07710fd/fcda8/1657884240097-87917261-4f4b-46c8-abc1-5c67490544a6.png\"\n        srcset=\"/static/1ef813c16212003ba6536793d07710fd/12f09/1657884240097-87917261-4f4b-46c8-abc1-5c67490544a6.png 148w,\n/static/1ef813c16212003ba6536793d07710fd/e4a3f/1657884240097-87917261-4f4b-46c8-abc1-5c67490544a6.png 295w,\n/static/1ef813c16212003ba6536793d07710fd/fcda8/1657884240097-87917261-4f4b-46c8-abc1-5c67490544a6.png 590w,\n/static/1ef813c16212003ba6536793d07710fd/efc66/1657884240097-87917261-4f4b-46c8-abc1-5c67490544a6.png 885w,\n/static/1ef813c16212003ba6536793d07710fd/f6f78/1657884240097-87917261-4f4b-46c8-abc1-5c67490544a6.png 932w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><a name=a44cG></a></p>\n<h2>修复 koa-to-express 的一个 BUG</h2>\n<p>其实没有那么顺利，由于原 Koa 应用使用了  koa-router 这个中间件，触发了 koa-to-express 的一个 BUG。于是只能 Fork 了 koa-to-express ，在自己的版本中做了修复。虽然给原作者提交了 PR，但在他合并并发新版之前，我得临时使用自己的版本，于是要对 package.json 做个修改，在安装 koa-to-express 时，从自己的仓库里下载代码：</p>\n<p><a href=\"https://github.com/Jeff-Tian/v/commit/cd11bf4f7100fd61ef9dda98397eb255b764a396#diff-7ae45ad102eab3b6d7e7896acd08c427a9b25b346470d7bc6507b6481575d519\">https://github.com/Jeff-Tian/v/commit/cd11bf4f7100fd61ef9dda98397eb255b764a396#diff-7ae45ad102eab3b6d7e7896acd08c427a9b25b346470d7bc6507b6481575d519</a></p>\n<p>package.json:\ndiff</p>\n<ul>\n<li>koa-to-express: ^3.1.4,</li>\n</ul>\n<ul>\n<li>koa-to-express: git+<a href=\"https://github.com/jeff-tian/koa-to-express.git\">https://github.com/jeff-tian/koa-to-express.git</a>,</li>\n</ul>\n<p>给它们的 PR 链接：<a href=\"https://github.com/xingxingted/koa-to-express/pull/10/files\">https://github.com/xingxingted/koa-to-express/pull/10/files</a></p>\n<p><a name=ZL0DR></a></p>\n<h2>完成 /api/index.js</h2>\n<p>最终的 /api/index.js 文件如下：<br /><a href=\"https://github.com/Jeff-Tian/v/blob/cd11bf4f7100fd61ef9dda98397eb255b764a396/api/index.js\">https://github.com/Jeff-Tian/v/blob/cd11bf4f7100fd61ef9dda98397eb255b764a396/api/index.js</a>\njavascript\nconst k2e = require(koa-to-express);</p>\n<p>process.env.ROUTER_PREFIX = /api;</p>\n<p>const app = require(../app);</p>\n<p>const expressApp = require(express)();</p>\n<p>app.middleware.map(m => {\nexpressApp.use(k2e(m));\n})</p>\n<p>module.exports = expressApp;</p>\n<p><a name=yG9jp></a></p>\n<h2>重定向</h2>\n<p>Vercel Serverless Function 默认将 /api/xxx 路由到 /api/xxx.js，所以 /api/xy/z，就不会被 /api/index 处理，所以需要增加一个 vercel.json 文件，将所有 /api/ 下的请求，重定向到 index.js：</p>\n<p>json\n{\nrewrites: [{ source: /api/(.*), destination: /api }]\n}</p>\n<p><a name=OUec1></a></p>\n<h1>完成</h1>\n<p>效果和在服务器上运行 koa 一模一样：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4eb1ee2db6bb60bc237117fe213f567b/4719e/1657885170477-54f5c498-3e02-49ee-9361-dedb2ecd3a9e.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50.67567567567568%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABHklEQVR42qWR3UrDMBzF+2B6ZS9WNt1QYchAL3xd30DtTLfVtNbRJs3HmqRHGtzFxLaCB34Ekv85nCTBJJohii5xNb9FOLvD7OYBi+Ujptf3mMxXiBYrhNMlzsOF5+xiPkhACEFVMezeM7ysE2xTiphsQfMCjHGUFTtBCAmlFKRSfv1JkGUZnHOQ6gBeSzTGoJYKQirUQoELCVYLT8VrWOcwpCBNU2it4ZyFtRZN0wDt8fh3c9u2vfjArmHXNI5jJBuCHX2D0Htk5Su4/IRqOIQuPZ3pGNrbsFOSJEjIBlznWOdPoOUzCkZQ6z24KlAJCiY/xgMppf6axhg/ZJ2BsQdPn6lv3wcWReHDvkf/9F6DDbvA7jPGzEOtRgP/oy8mteZA4tYrpgAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/4eb1ee2db6bb60bc237117fe213f567b/fcda8/1657885170477-54f5c498-3e02-49ee-9361-dedb2ecd3a9e.png\"\n        srcset=\"/static/4eb1ee2db6bb60bc237117fe213f567b/12f09/1657885170477-54f5c498-3e02-49ee-9361-dedb2ecd3a9e.png 148w,\n/static/4eb1ee2db6bb60bc237117fe213f567b/e4a3f/1657885170477-54f5c498-3e02-49ee-9361-dedb2ecd3a9e.png 295w,\n/static/4eb1ee2db6bb60bc237117fe213f567b/fcda8/1657885170477-54f5c498-3e02-49ee-9361-dedb2ecd3a9e.png 590w,\n/static/4eb1ee2db6bb60bc237117fe213f567b/efc66/1657885170477-54f5c498-3e02-49ee-9361-dedb2ecd3a9e.png 885w,\n/static/4eb1ee2db6bb60bc237117fe213f567b/c83ae/1657885170477-54f5c498-3e02-49ee-9361-dedb2ecd3a9e.png 1180w,\n/static/4eb1ee2db6bb60bc237117fe213f567b/4719e/1657885170477-54f5c498-3e02-49ee-9361-dedb2ecd3a9e.png 1330w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}},"menus":{}}},"staticQueryHashes":[],"slicesMap":{}}