{"componentChunkName":"component---src-templates-post-js","path":"/posts/tpisf7","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/tpisf7","relativePath":"posts/tpisf7","frontmatter":{"title":"利用 openssl 安全地恢复出 GitHub Actions 中的 secrets 原始明文值","stackbit_url_path":"posts/tpisf7","date":"2022-08-19T10:56:28","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p><a name=DZUvV></a></p>\n<h1>问题</h1>\n<p>几年前的 GitHub 论文仓库，设置了一个 GitHub Actions，使用 texlive 编译成最终的论文 pdf 文件，通过企业微信机器人 webhook 发送到我的手机上。这个 GitHub Action，使用到的企业微信机器人 webhook 相关的配置，通过 repository secrets 传入：</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2022/png/221736/1660887225927-8fa10392-38da-435f-bc5d-6f773808a4fd.png#clientId=u0e5ede32-05a3-4&#x26;crop=0&#x26;crop=0&#x26;crop=1&#x26;crop=1&#x26;from=paste&#x26;height=693&#x26;id=u8246327b&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=1386&#x26;originWidth=1664&#x26;originalType=binary%E2%88%B6=1&#x26;rotation=0&#x26;showTitle=false&#x26;size=220935&#x26;status=done&#x26;style=none&#x26;taskId=u7651b249-c019-4312-a6ca-a79e73a9109&#x26;title=&#x26;width=832\" alt=\"image.png\"></p>\n<p>现在想配置到另外的地方，但是找不到原始的值了，而 GitHub 并没有提供查看原始值的方式。</p>\n<p><a name=uM0xT></a></p>\n<h1>尝试</h1>\n<p>一个很自然的想法是，把这些秘密值在日志中打印出来，但是失败了，因为直接 echo，加密值会被 GitHub Action 打码：</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2022/png/221736/1660887586643-352fab13-70c4-4f42-b13f-b2e3ec02a0e3.png#clientId=u0e5ede32-05a3-4&#x26;crop=0&#x26;crop=0&#x26;crop=1&#x26;crop=1&#x26;from=paste&#x26;height=889&#x26;id=ua4d3ab17&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=1778&#x26;originWidth=1944&#x26;originalType=binary%E2%88%B6=1&#x26;rotation=0&#x26;showTitle=false&#x26;size=404790&#x26;status=done&#x26;style=none&#x26;taskId=u1859fea7-623c-46d3-8837-8e83cfe8d7c&#x26;title=&#x26;width=972\" alt=\"image.png\"><br />其实，如果 GitHub 真的在日志中明文输出秘密值，那么一旦仓库是公开的，就会泄密。\n<a name=hJtZQ></a></p>\n<h1>思考 🤔</h1>\n<p>既然直接 echo 不工作，就想到将它们 base64 之后输出： echo xxx | base64，但是这样，又不安全，因为一旦仓库公开，就会泄密。毕竟任何人看到了 base64 的输出，都能解码查看明文。有没有办法既能绕过 GitHub Action 的打码机制，又能保证安全呢？</p>\n<p>base64 只是编码，要保证内容安全，还需要加密才行。使用一个密钥，将秘密值输出为密文，而只有我有密钥，在本地解密查看秘密值即可。</p>\n<p><a name=XcloQ></a></p>\n<h1>如何加密？</h1>\n<p>怎样使用命令行加密呢？可以使用 openssl 这个命令。在输出秘密前，用它加密；在本地，用它解密。注意，openssl 在不同的机器上运行表现不一样，如果在 GitHub Actions 上是使用 Ubuntu 进行 openssl 加密的话，在本地解密时也需要用 Ubuntu 来运行 openssl，没有 Ubuntu 机器，可以使用 docker 下载一个。</p>\n<p><a name=QY6La></a></p>\n<h2>加密命令</h2>\n<p>以上面的 TARGET_URL 为例：\nshell\necho ${TARGET_URL} | openssl enc -e -aes-256-cbc -a -pbkdf2 -iter ${MY_OPENSSL_ITER} -k ${MY_OPENSSL_PASSWORD}</p>\n<p>注意，这里在加密时使用了额外的两个参数： MY_OPENSSL_ITER 和 MY_OPENSSL_PASSWORD。后者是密钥，可以存放在 GitHub Actions 的 SECRETS 里，在执行时将它注入环境变量；前者是一个数字，越大则让暴力碰解的难度越大，注意这个变量建议“不要”存放在 SECRETS 里，比如这个值如果为 5，那么会导致以上命令的输出中，任何的 5 这个文本都会被替换成 ***，三个星号，带来不必要的麻烦。</p>\n<p>比如使用了 upload.sh 来执行对企业微信 API 的调用，那么这一步的 GitHub Actions yml 内容如下：</p>\n<p>yaml\n...\n- name: send to wechat\nif: ${{ always() }}\nenv:\nMY_OPENSSL_ITER: 5\nMY_OPENSSL_PASSWORD: ${{ secrets.MY_OPENSSL_PASSWORD }}\nTARGET_URL: ${{ secrets.TARGET_URL }}\nFILE_UPLOAD_URL: ${{ secrets.FILE_UPLOAD_URL }}\nSECRET_KEY: ${{ secrets.SECRET_KEY }}\nINPUT_ARGS: *.pdf\nrun: |\nsh ./tools/upload.sh</p>\n<p>这样改造后，执行后的 GitHub Actions 日志输出如下：</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2022/png/221736/1660905539867-78872c5f-3c52-413c-ac53-e79d53509081.png#clientId=ub83de44d-07b6-4&#x26;crop=0&#x26;crop=0&#x26;crop=1&#x26;crop=1&#x26;from=paste&#x26;height=686&#x26;id=u8543a604&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=1372&#x26;originWidth=2338&#x26;originalType=binary%E2%88%B6=1&#x26;rotation=0&#x26;showTitle=false&#x26;size=408958&#x26;status=done&#x26;style=none&#x26;taskId=ud745a81f-ac3b-4e3c-ae2a-a80d36aab09&#x26;title=&#x26;width=1169\" alt=\"image.png\"></p>\n<p><a name=apz5D></a></p>\n<h1>如何解密？</h1>\n<p><a name=FiolC></a></p>\n<h2>解密命令</h2>\n<p>shell\necho ENCRYPTED_TEXT | openssl base64 -d | openssl enc -d -pbkdf2 -iter $MY_OPENSSL_ITER -aes-256-cbc -k $MY_OPENSSL_PASSWORD</p>\n<p>正如之前所说的，如果 GitHub Actions 运行时的镜像是 Ubuntu，则以上解密命令也得在 Ubuntu 上运行。如果本地电脑是 Mac，直接运行会报错。可以运行一个 docker 镜像，进行镜像分别执行以上命令，便依次解密了 GitHub Actions 中的 SECRETS，如下截图所示：</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2022/png/221736/1660905990310-92db1e12-8c56-46e0-8b1a-f73933c63cd6.png#clientId=ub83de44d-07b6-4&#x26;crop=0&#x26;crop=0&#x26;crop=1&#x26;crop=1&#x26;from=paste&#x26;height=481&#x26;id=u7cd5329e&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=962&#x26;originWidth=2964&#x26;originalType=binary%E2%88%B6=1&#x26;rotation=0&#x26;showTitle=false&#x26;size=396268&#x26;status=done&#x26;style=none&#x26;taskId=ud74e92f8-f08d-488e-a062-da3c362d7e9&#x26;title=&#x26;width=1482\" alt=\"image.png\"></p>\n<p>现在，就可以愉快地拷贝这些值，配置到其他需要重用它们的地方了。\n<a name=alSol></a></p>\n<h1>openssl 的其他用途</h1>\n<p>在用 openssl 解决了这个问题后，想起来另一个用法，就是用来生成哈希值。之前有人在 StackOverflow 问如何用 python 计算哈希值，我由于兴趣原因，不仅给他提供了 python 脚本，还提供了对应的 nodejs 和 shell 脚本，它们都是一行脚本，非常实用。其中的 shell 脚本也是用了 openssl：<br /><a href=\"https://stackoverflow.com/questions/9594125/salt-and-hash-a-password-in-python/71422369#71422369\">https://stackoverflow.com/questions/9594125/salt-and-hash-a-password-in-python/71422369#71422369</a></p>\n<p>比如想将 password 生成一个哈希后的值，并给这串哈希值加上盐值 salt，对应的 shell 脚本非常简单（使用了 openssl，并且可以直接在 Mac 上运行。）：</p>\n<p>shell\necho -n password | openssl sha256 -hmac salt</p>\n<p>而如果安装了 nodejs，那么也可以这样执行：\nshell\necho console.log(require(crypto).createHmac(sha256, salt).update(password).digest(hex)) | node</p>\n<p>如果安装了 python，也可以使用 python 生成：</p>\n<p>shell\npython3 -c import hashlib;import base64;import hmac;print(hmac.new(bsalt, password.encode(), hashlib.sha256).hexdigest())</p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}},"menus":{}}},"staticQueryHashes":[]}