{"componentChunkName":"component---src-templates-post-js","path":"/posts/gg71dd3df3fdb4ag/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/gg71dd3df3fdb4ag","relativePath":"posts/gg71dd3df3fdb4ag","frontmatter":{"title":"通过 Keycloak 的自定义属性打通多个系统中的用户体系","stackbit_url_path":"posts/gg71dd3df3fdb4ag","date":"2022-12-01T07:44:27","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p><a name=nkosL></a></p>\n<h1>【问题与需求重述】</h1>\n<p>现有多个系统，其分别拥有自己的用户数据库，希望将所有系统中的用户体系去掉，统一使用 Keycloak 来管理。将单个系统的用户登录改造成使用 Keycloak，已经完成。首先，参考《(使用 Keycloak 接管 SpringBoot 应用的用户认证功能 - Jeff Tian的文章 - 知乎)[<a href=\"https://zhuanlan.zhihu.com/p/587831808\">https://zhuanlan.zhihu.com/p/587831808</a>] 》，使用一个用户，验证了端到端的可行性；然后，参考《<a href=\"https://zhuanlan.zhihu.com/p/588264077\">往 Keycloak 里批量添加用户 - Jeff Tian的文章 - 知乎</a> 》将系统一中的所有用户都迁移到了 Keycloak。</p>\n<p>现在面临的问题是，对于第二个系统，以及后续更多的其他系统，不能直接迁移用户了，因为本质上，还是同一批用户，他们已经从系统一中，迁移到了 Keycloak。只是这同一批用户，在系统二中的用户名，和在系统一中的用户名不一样而已。即，系统二的用户，其实已经在 Keycloak 里了，只是不能通过用户名关联上。也就是说，在系统二中做登录改造时，需要使用另一种方式来查找用户。</p>\n<p>登录本质上分两步，第一步根据某种方式查找用户是否存在，第二步验证提供的凭据是否匹配。对于目前的情况，第一步不能使用用户名，但第二步还是一样的。</p>\n<p><a name=nDlQw></a></p>\n<h1>思路</h1>\n<p>虽然同一个用户在系统一和系统二中用户名不相同，但这两个系统中都保存了用户的手机号。我们可以根据用户的手机号来做关联。即，在系统二做登录时，根据用户输入的用户名，查找到手机号。然后，去 Keycloak 中，用手机号查找到该用户，然后，就可以取到该用户在 Keycloak 中的用户名了。后面就是和用户名密码登录一样了。</p>\n<p><a name=btpBg></a></p>\n<h1>Keycloak 冷知识</h1>\n<p><a name=BioF6></a></p>\n<h2>自定义属性</h2>\n<p>Keycloak 为用户定义了自定义属性字典，可以存储自定义的键值对。我们可以利用该知识，在做批量迁移用户时，将用户的手机号存储在这个自定义属性字典里。当然，迁移完毕后，也可以继续向已有用户插入任意的自定义属性。如果通过界面来查看，是这样的：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/71bd2344d1ef2537ed83dd27358a3291/bc43a/1669878768309-5911f332-caca-4797-bcd9-06fc57975559.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.83783783783784%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB3klEQVR42qWRT2sTURTFsxPxE0gV4sLahW7cdGFRLC78AKJLW0y0WNN/tpUU0kkkguCXEDeKtkW/gLhQXIobUTRtYjMzaeZPZubNmzevNfOTxCK49sDhXO7ics65uUePn7C4WuHWnTluFmaZvl1iqnhvOA90ujjHdLF0yDmmCn+0MLNI8e4SM7PzzC8ssFwqsVIskjs+cpIjR49x7foN6vU65QerGOsVHtaqVKvrrBnLrBkrf1k27g93ZWOJilHGWDeoVCpUazVq9Tq58YlJ8qPnePvuPQNoNP+D3IVLVxjJj/JyYxPVj2j6TazgJ73AJxQBUShwYpMvwQeEiAlFSCQiPN8jiAISJUnTFCklSZIMHF7mRH6MZxtPCfs2VtSgI3boxC2saBsr2sESDWzVwE1N3LSNp01a3jda3lc6cRMRC/a6e7iuS+7i5FXyp8+ysfUapRSmZWLbNrZt4Thdut0ujuMgZUKaKpRK0KnG933au20s06Jru3iOj+d5hw5PjfFqa5OMPiKQyDghkQkH+oB9vY/W+8NYWuvhMaUlYdyjFw1i99iOPvMj+IQIJbnz4xOM5M/w4s1zQnb5rj4SZBYy6xH1HVQWkWbxP8WnmSTJAhQCiU8va/OLg+FTfgN4awe5mVOX+gAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/71bd2344d1ef2537ed83dd27358a3291/fcda8/1669878768309-5911f332-caca-4797-bcd9-06fc57975559.png\"\n        srcset=\"/static/71bd2344d1ef2537ed83dd27358a3291/12f09/1669878768309-5911f332-caca-4797-bcd9-06fc57975559.png 148w,\n/static/71bd2344d1ef2537ed83dd27358a3291/e4a3f/1669878768309-5911f332-caca-4797-bcd9-06fc57975559.png 295w,\n/static/71bd2344d1ef2537ed83dd27358a3291/fcda8/1669878768309-5911f332-caca-4797-bcd9-06fc57975559.png 590w,\n/static/71bd2344d1ef2537ed83dd27358a3291/efc66/1669878768309-5911f332-caca-4797-bcd9-06fc57975559.png 885w,\n/static/71bd2344d1ef2537ed83dd27358a3291/c83ae/1669878768309-5911f332-caca-4797-bcd9-06fc57975559.png 1180w,\n/static/71bd2344d1ef2537ed83dd27358a3291/bc43a/1669878768309-5911f332-caca-4797-bcd9-06fc57975559.png 2676w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><a name=pI9cg></a></p>\n<h2>使用自定义属性查询用户</h2>\n<p>Keycloak 的 Admin API 提供了查询用户接口，文档见： <a href=\"https://www.keycloak.org/docs-api/15.1/rest-api/index.html#_users_resource\">https://www.keycloak.org/docs-api/15.1/rest-api/index.html#_users_resource</a>。查询方式有很多，比如根据 email 查询、根据用户的姓氏来查等等。该接口还提供了一个 url 查询字符串 q，可以根据自定义属性来查询用户：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.27027027027027%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABsUlEQVR42k2S6W7kIBCE/f7vtn82K62UKOOZZHxhG2wuAz6+FUSJtqVScxTVTamrfjb8uc+81DO/M255Lfn1Kvh7nxDSMq+hQChHK1a6UdMMC63QSGVQamFpO1zfUzWDQq0G5xzHHtjTxn541DIwTh2PZ43xKz5a5Drxfn8rZ23/xHqND4ZRDvRjiw8b1Wf/JbhtnhBCIakw4KJh9RJlJ7bDEi+PCQuN+GCQLYNsEKpl9TN+t/hrIZ2BqhGKflqLqDYOu2lMlKx6xViNtpr9SMCF3xwfnw/avuXZPumHrtxZa/G7IV3hq8OMRycZpSaE3IlCuZFJdzxFzbpN6CCRZuDevlE3b9yer4ilYfEjygnWbSamQPX+OfH6GIuodY4QNlJMjGJkGie6tsU7T4oRozX17YYYBpRUzNOMXjVylnjnSClS1c3MRyeRy5ePGTEGcpznUQrEGDmvs+RpGpFKIuVMiIHrOosd53kWftWIpTzaU/hPMLIsS0Fd3zHGlALee+q6pmmaH+TpyB4ex1k4xcPs3fd3s2Bufd93juPgui6+I6VUJiGf5Y5yzpzj2H/2/wAyuq9Swed9owAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/0bfe161e498b9b0721218c091ae125d1/fcda8/1669878978835-d6f02967-1a74-4332-b7d7-f361bbe598ce.png\"\n        srcset=\"/static/0bfe161e498b9b0721218c091ae125d1/12f09/1669878978835-d6f02967-1a74-4332-b7d7-f361bbe598ce.png 148w,\n/static/0bfe161e498b9b0721218c091ae125d1/e4a3f/1669878978835-d6f02967-1a74-4332-b7d7-f361bbe598ce.png 295w,\n/static/0bfe161e498b9b0721218c091ae125d1/fcda8/1669878978835-d6f02967-1a74-4332-b7d7-f361bbe598ce.png 590w,\n/static/0bfe161e498b9b0721218c091ae125d1/efc66/1669878978835-d6f02967-1a74-4332-b7d7-f361bbe598ce.png 885w,\n/static/0bfe161e498b9b0721218c091ae125d1/c83ae/1669878978835-d6f02967-1a74-4332-b7d7-f361bbe598ce.png 1180w,\n/static/0bfe161e498b9b0721218c091ae125d1/6f969/1669878978835-d6f02967-1a74-4332-b7d7-f361bbe598ce.png 2518w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>该接口返回的数据如下：</p>\n<p>json\n[\n{\nid: 71792e89-1d72-4509-b19f-ab19b35adb61,\ncreatedTimestamp: 1590325541253,\nusername: <a href=\"mailto:jeff.tian@outlook.com\">jeff.tian@outlook.com</a>,\nenabled: true,\ntotp: false,\nemailVerified: true,\nfirstName: Jeff,\nlastName: Tian,\nemail: <a href=\"mailto:jeff.tian@outlook.com\">jeff.tian@outlook.com</a>,\nattributes: {\nsaml.persistent.name.id.for.jeff-tian-gitlab-wq766wrh9r57-8929.githubpreview.dev: [\nG-6533c9f6-0700-4dce-9080-50ea65ed5b72\n],\nphone: [\n12345678901\n],\nsaml.persistent.name.id.for.jeff-tian-gitlab-vjv44x636w5v-8929.githubpreview.dev: [\nG-214ff264-b530-49da-8181-a23f6fb2d09d\n],\nsaml.persistent.name.id.for.uniheart-gitlab: [\nG-28155cbf-3d55-4226-8851-42e7d7f0806d\n]\n},\ndisableableCredentialTypes: [],\nrequiredActions: [],\nnotBefore: 0,\naccess: {\nmanageGroupMembership: true,\nview: true,\nmapRoles: true,\nimpersonate: true,\nmanage: true\n}\n}\n]</p>\n<p><a name=x1QR2></a></p>\n<h1>实现</h1>\n<p>在前面两篇文章的基础上，最主要的是在示例 SpringBoot 项目中的 /login-by-username-password�接口基础上，增加一个 /login-by-attribute方法，模拟系统二的登录改造。</p>\n<p><a name=jG6gt></a></p>\n<h2>接口设计</h2>\n<p>在系统二中，用户输入的是系统二中的用户名和密码。系统二在自己的库中查找到手机号后，后续的步骤，我们使用 /login-by-attribute接口模拟，它使用上面介绍的自定义属性去 Keycloak 里查找用户，并取出用户名，然后复用前面的用户名密码登录。所以该接口接收两个参数：attr和 password。为了简单，接口使用了 GET 方法，在真实项目里，不要这样做！</p>\n<p><a name=cU4Nu></a></p>\n<h2>入口</h2>\n<p>java\n@GetMapping(value=/login-by-attribute)\n@ResponseBody\npublic KeycloakAccessTokenPayload loginByAttribute(String attr, String password) throws IOException {\nreturn new KeycloakHelper(new OkHttpClient().newBuilder().build()).getUserTokenByAttributeAndPassword(attr, password);\n}</p>\n<p><a name=etlUg></a></p>\n<h2>关键代码</h2>\n<p>java\npublic KeycloakAccessTokenPayload getUserTokenByAttributeAndPassword(String attr, String password) throws IOException {\nvar url = <a href=\"https://keycloak.jiwai.win/auth/admin/realms/UniHeart/users?q=\">https://keycloak.jiwai.win/auth/admin/realms/UniHeart/users?q=</a> + attr;\nvar request = new Request.Builder().url(url).method(GET, null).addHeader(Authorization, java.lang.String.format(Bearer %s, getAdminAccessToken().access_token)).build();\nvar response = client.newCall(request).execute();\nvar s = Objects.requireNonNull(response.body()).string();\nvar users = JsonHelper.parseUsersFrom(s);</p>\n<pre><code>if(users.length == 0) {\n    return null;\n}\n\nreturn getUserTokenByPassword(users[0].username, password);\n</code></pre>\n<p>}</p>\n<p>完整提交见： <a href=\"https://github.com/Jeff-Tian/keycloak-springboot/commit/c6dfbbadf809fa575fcad462a7dd8b9bf4ea2e5d\">https://github.com/Jeff-Tian/keycloak-springboot/commit/c6dfbbadf809fa575fcad462a7dd8b9bf4ea2e5d</a>。</p>\n<p><a name=ZFmeu></a></p>\n<h1>测试效果</h1>\n<p>以上面的测试用户为例，其有一个自定义属性，phone，其值为 12345678901 。调用新加的 /login-by-attribute，结果如下：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/aafed1af979293f9cfe343937299f8e0/809bc/1669880628289-e96ee78a-5090-443e-a360-30e156d74ff8.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 54.05405405405405%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABuElEQVR42l2SWW7cMBBEdflcK8hXDpCPAHZswx6PNKONFPdNZCXdmoEdE3joFpfqYlOdNgZSSgghPlgFlDBYV4Ft2xBjREoJpZQv7LBG4yocfjxoDDKiU9sGay0fFPIQkFLgt/iJWY7QSnMRrTWL3sWJECLanvCyJHz7HvBrSOi8NbxIo7bKUbcJSzlhLxUN/4/WGnwI7JDy2mhHBYoHakZHlkMI8MEjhQyVJ1zzI+9pXKB9giWRYkQuCblkjj4VrDqh1obOGANnDKzS0DqhVwNetgd4V+FSgYsFJmTGhiP3aef5mHd2SZBjMtZRzZgKzpPF+0x4nOeIt8ngfbI4TRZvNzgfj/g6GuY44/A2Uq8lCTau+DQYPF80HnuFP73CU685cj5ohvLnQbPIXZih76uG3BQ6shtDQj8p9IvFsDosKkC5DO0yx4MEadIx72/c9hhfoGzERoL0SkEbrJcZozCYNo9VRwjCJI6zCjxHLOqA1oynvh69JUGl9dFD7wJOlw2v460fn3p1nh1f8Z6fF8fxIjwL34tQ3GtFV2pD1gpWbuyEHJnbdeh3SHnn1yQoT+WDr6P+E/wLQopNzoclJq8AAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/aafed1af979293f9cfe343937299f8e0/fcda8/1669880628289-e96ee78a-5090-443e-a360-30e156d74ff8.png\"\n        srcset=\"/static/aafed1af979293f9cfe343937299f8e0/12f09/1669880628289-e96ee78a-5090-443e-a360-30e156d74ff8.png 148w,\n/static/aafed1af979293f9cfe343937299f8e0/e4a3f/1669880628289-e96ee78a-5090-443e-a360-30e156d74ff8.png 295w,\n/static/aafed1af979293f9cfe343937299f8e0/fcda8/1669880628289-e96ee78a-5090-443e-a360-30e156d74ff8.png 590w,\n/static/aafed1af979293f9cfe343937299f8e0/efc66/1669880628289-e96ee78a-5090-443e-a360-30e156d74ff8.png 885w,\n/static/aafed1af979293f9cfe343937299f8e0/c83ae/1669880628289-e96ee78a-5090-443e-a360-30e156d74ff8.png 1180w,\n/static/aafed1af979293f9cfe343937299f8e0/809bc/1669880628289-e96ee78a-5090-443e-a360-30e156d74ff8.png 2612w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>成功拿到用户的登录结果。</p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}}}},"staticQueryHashes":[],"slicesMap":{}}