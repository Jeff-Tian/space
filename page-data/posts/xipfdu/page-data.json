{"componentChunkName":"component---src-templates-post-js","path":"/posts/xipfdu","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/xipfdu","relativePath":"posts/xipfdu","frontmatter":{"title":"扫清 Cloud Native 开发时的 TDD 障碍","stackbit_url_path":"posts/xipfdu","date":"2022-08-18T06:53:11","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p>在云计算普及的今天，Cloud Native 开发越来越流行。所谓云原生开发，就是从开发的第一天开始，就依赖云环境和云资源，不再有本地开发环境。这给 TDD 普及度本就很低的现状，又带来了更多的挑战，甚至导致了资深的开发人员，在云原生开发中也放弃了 TDD 实践。</p>\n<p>本文以一个非常具体的例子，来戳破云原生这个纸老虎，让 TDD 的实践者更有信心，在云原生开发中，不再有 TDD 很难的错觉和心理恐惧。\n<a name=YrztN></a></p>\n<h1>问题</h1>\n<p>在使用 jest 写测试时，如果待测试对象中引用了 aws sdk，那么在直接运行测试时会碰到这个问题：</p>\n<p>shell\nConfigError: Missing region in config</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2022/png/221736/1660803374691-62873d86-a6b0-4c47-ae22-856fac288e53.png#clientId=u73c2ff79-c897-4&#x26;crop=0&#x26;crop=0&#x26;crop=1&#x26;crop=1&#x26;from=paste&#x26;height=644&#x26;id=u9ab7e7ad&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=1288&#x26;originWidth=2170&#x26;originalType=binary%E2%88%B6=1&#x26;rotation=0&#x26;showTitle=false&#x26;size=397583&#x26;status=done&#x26;style=none&#x26;taskId=uda7945c6-67f2-45ab-82fa-0450d49c814&#x26;title=&#x26;width=1085\" alt=\"image.png\">\n<a name=rY7Om></a></p>\n<h1>原因</h1>\n<p>待测试对象中的方法，使用 aws sdk 时，会向 AWS 服务发送 HTTP 调用请求，由于没有传递 region，导致 AWS 服务报错，最终响应到了客户端这个错误信息。\n<a name=lGQbu></a></p>\n<h1>解决方案</h1>\n<p>可以通过 jest 将 aws-sdk mock 掉，以避免在测试过程中真正去调用 AWS api。</p>\n<p><a name=pZhcC></a></p>\n<h2>具体做法</h2>\n<p>首先，要将 aws-sdk 整个地 mock 掉：</p>\n<p>typescript\nexport const mockAwsSdk = {\nDynamoDb: jest.fn(),\nCloudWatchLogs: jest.fn(),\nSQS: jest.fn()\nLambda: jest.fn()\n}</p>\n<p>jest.mock(aws-sdk, () => mockAwsSdk)</p>\n<p>然后，针对待测对象的实际调用，提供针对性的 mock。比如待测对象使用了 DynamoDb 中的几乎所有方法，那么在 mock 时，可以使用一个数组来做为 DynamoDb 的一个替代。于是，可以实现以下的 mockDynamoDb（注意，使用了 items: [] 做为初始表格）：</p>\n<p>typescript\n// 自定义一个查询函数，在后面模拟搜索时可以用到。注意这里是一个示例，具体的实现可以根据待测对象使用到的 DynamoDb 的具体 Schema 任意改写\nconst queryByOperationKeyAndScenarioType = (opKey, scType) => (item) =>\n(item.operationKey.S === opKey.S || item.operationKey.S === opKey.S.split(|)[0] + |*) &#x26;&#x26;\n(scType ? item.scenarioType.S === scType.S : true)</p>\n<p>export const mockDynamoDB = {\ncreateTable: jest.fn().mockImplementation(() => {\nreturn {\npromise: () => {\nreturn Promise.resolve()\n},\n}\n}),\nupdateTimeToLive: jest.fn().mockImplementation(() => {\nreturn {\npromise: () => {\nreturn Promise.resolve()\n},\n}\n}),\nitems: [],\nputItem: jest.fn().mockImplementation((params) => {\n// 假定params至多前4个Key是主键\nconst existed = mockDynamoDB.items.findIndex((item) => {\nconst [pk1, pk2, pk3, pk4] = Object.keys(params.Item)</p>\n<pre><code>        return [pk1, pk2, pk3, pk4]\n            .filter((pk) => !!pk)\n            .reduce((prev, next) => prev &#x26;&#x26; JSON.stringify(item[next]) === JSON.stringify(params.Item[next]), true)\n    })\n\n    if (existed === -1) {\n        mockDynamoDB.items.push(params.Item)\n    } else {\n        mockDynamoDB.items[existed] = params.Item\n    }\n    \n    return mockDynamoDB\n}),\ngetItem: jest.fn().mockImplementation((params) => {\n    // 根据传入的参数从数组中筛选出符合条件的第一条记录\n    const [res] = mockDynamoDB.items.filter((item) =>\n        Object.keys(params.Key).reduce(\n            (prev, next) => prev &#x26;&#x26; JSON.stringify(params.Key[next]) === JSON.stringify(item[next]),\n            true\n        )\n    )\n\n    return { promise: () => Promise.resolve({ Item: res }) }\n}),\nquery: jest.fn().mockImplementation((params) => {\n    return {\n        promise: () => {\n            return Promise.resolve({\n                // 用自定义的筛选函数，当然，你也可以定义多个，根据需要使用不同的筛选函数\n                Items: mockDynamoDB.items.filter(\n                    queryByOperationKeyAndScenarioType(\n                        params.ExpressionAttributeValues[:opKey],\n                        params.ExpressionAttributeValues[:scType]\n                    )\n                ),\n            })\n        },\n    }\n}),\nscan: jest.fn().mockImplementation((params) => {\n    return {\n        promise: () => {\n            // 可以直接返回 items，或者不直接依赖它的结果的话，直接 resolve\n            return Promise.resolve()\n        },\n    }\n}),\npromise: jest.fn().mockReturnValue(Promise.resolve()),\nbatchWriteItem: jest.fn().mockImplementation((params) => {\n    // 根据需要将传入的参数写入数组\n    for (const table in params.RequestItems) {\n        const item = params.RequestItems[table]\n        mockDynamoDB.items.push(item[0].PutRequest.Item)\n    }\n\n    return {\n        promise: () => {\n            return Promise.resolve({})\n        },\n    }\n}),\n</code></pre>\n<p>}</p>\n<p>以上是一个待测对象使用了 DynamoDb 的例子，如果使用了 SQS，也可以类似地 mock 一个 SQS。在有了 mockDynamoDb 后，就可以把这个 mock 对象灌入最早的 jest mock 过的 aws-sdk 了：</p>\n<p>typescript\nmockAwsSdk.DynamoDb = jest.fn(() => mockDynamoDb)</p>\n<p><a name=PxnhJ></a></p>\n<h2>注意事项</h2>\n<p>jest.mock(aws-sdk, ...) 这一行，需要放在引入待测对象之前，即在待测对象在真实引用 aws-sdk 前，把 aws-sdk 替换掉。<br /><img src=\"https://cdn.nlark.com/yuque/0/2022/png/221736/1660805146873-de64799f-e831-41b9-be90-014e367b560b.png#clientId=u73c2ff79-c897-4&#x26;crop=0&#x26;crop=0&#x26;crop=1&#x26;crop=1&#x26;from=paste&#x26;height=388&#x26;id=u1caf1ab9&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=776&#x26;originWidth=2236&#x26;originalType=binary%E2%88%B6=1&#x26;rotation=0&#x26;showTitle=false&#x26;size=284984&#x26;status=done&#x26;style=none&#x26;taskId=uaaf80276-aa74-4db9-9da3-06c61d78300&#x26;title=&#x26;width=1118\" alt=\"image.png\">\n<a name=I08sW></a></p>\n<h2>效果</h2>\n<p>于是，测试就可以愉快的进行了，既可以测试自己的业务逻辑，但是又不真正调用 AWS Api：<br /><img src=\"https://cdn.nlark.com/yuque/0/2022/png/221736/1660804928911-937b2fb3-3d59-4ad5-9389-0d7bf232dc89.png#clientId=u73c2ff79-c897-4&#x26;crop=0&#x26;crop=0&#x26;crop=1&#x26;crop=1&#x26;from=paste&#x26;height=772&#x26;id=u000f3652&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=1544&#x26;originWidth=2564&#x26;originalType=binary%E2%88%B6=1&#x26;rotation=0&#x26;showTitle=false&#x26;size=374651&#x26;status=done&#x26;style=none&#x26;taskId=u41539672-0256-420b-8a53-72d866122be&#x26;title=&#x26;width=1282\" alt=\"image.png\">\n<a name=PO2kY></a></p>\n<h1>总结</h1>\n<p>测试驱动开发是一个以终为始的做事方法，是10倍程序员工作方法之一。但是为什么难以推广呢？既然是 10 倍工作效率，但业界采用比例为什么仍然很低呢？原因之一就是在实践过程中有各种拦路虎，比如让人觉得难以 mock。实际上，mock 方法有很多，本文对 aws sdk 这个具体的场景，提供了一种可行的 mock 方案，希望扫清大家在引用了 aws sdk 的开发中的 TDD 障碍。</p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}},"menus":{}}},"staticQueryHashes":[]}