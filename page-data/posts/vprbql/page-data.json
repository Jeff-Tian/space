{"componentChunkName":"component---src-templates-post-js","path":"/posts/vprbql","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/vprbql","relativePath":"posts/vprbql","frontmatter":{"title":"利用 Keycloak 的 API 来给用户分配角色","stackbit_url_path":"posts/vprbql","date":"2022-03-22T13:35:42","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p>上次有用户咨询如何编程创建 Keycloak 用户，我推荐的方式是直接利用 Keycloak 的 API 来完成这件事。因为引入第三方库或者所谓 SDK，增加了复杂性，而它们的本质，还是拼装了 HTTP 请求来调用 Keycloak 的 API。引入库或者 SDK 在大型工程中还是有价值的，但是为了快速演示和解决问题，还是直接调用 Keycloak API 来得快。</p>\n<p><a href=\"https://player.bilibili.com/player.html?bvid=BV1nS4y1D7Xj\">点击查看【bilibili】</a></p>\n<p>随后，又收到<a href=\"https://www.zhihu.com/consult/conversation/1488647402479935488/archive\">咨询</a>如何使用代码给 Keycloak 用分配角色。对于这个问题，我仍然采用直接调用  Keycloak API 的方式来加以说明。</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2022/png/221736/1647954627232-bc191c5d-bdf3-4c5d-b475-acbafafd3c04.png#clientId=ubfda23d7-006e-4&#x26;crop=0&#x26;crop=0&#x26;crop=1&#x26;crop=1&#x26;from=paste&#x26;height=298&#x26;id=u39b37f79&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=372&#x26;originWidth=1267&#x26;originalType=binary%E2%88%B6=1&#x26;rotation=0&#x26;showTitle=false&#x26;size=23974&#x26;status=done&#x26;style=none&#x26;taskId=uca6855bb-e426-4821-88f2-f797a3a8029&#x26;title=&#x26;width=1013.6\" alt=\"image.png\"></p>\n<p>首先，Keycloak 的 API 文档列出了它所有的能力，这个文档地址在： <a href=\"https://www.keycloak.org/docs-api/17.0/rest-api/#_role_mapper_resource\">https://www.keycloak.org/docs-api/17.0/rest-api</a>。</p>\n<p>分配角色，对应了 Keycloak 的 role-mapping API。这个角色映射，又分为两种，即客户端角色，以及领域角色。我在上次的示例应用中分别添加了两个路由： assgin-role，和 assign-realm-role 来对应这两种角色映射。</p>\n<p>源代码见： <a href=\"https://github.com/Jeff-Tian/keycloak-springboot\">https://github.com/Jeff-Tian/keycloak-springboot</a></p>\n<p><a name=clBP4></a></p>\n<h1>分配客户端角色</h1>\n<p>在上一次的文章里，分享了如何创建用户，并为示例创建了一个 demoapp 客户端，以及在这个客户端里增加了一个角色 visitor。</p>\n<p>现在用代码给指定的用户分配这个角色，需要先分别找到这个客户端的 id 以及角色的 id，这可以通过 Keycloak 管理后台的界面 url 上的最后一部分复制到。<br /><img src=\"https://cdn.nlark.com/yuque/0/2022/png/221736/1647761528901-7608448e-adcb-4fb6-886b-944ae38baf67.png#clientId=ue764e438-aa72-4&#x26;crop=0&#x26;crop=0&#x26;crop=1&#x26;crop=1&#x26;from=paste&#x26;height=644&#x26;id=uacc01517&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=1933&#x26;originWidth=3000&#x26;originalType=binary%E2%88%B6=1&#x26;rotation=0&#x26;showTitle=false&#x26;size=475861&#x26;status=done&#x26;style=none&#x26;taskId=uaa6ca764-d211-4691-8e6d-3717bb75903&#x26;title=&#x26;width=1000\" alt=\"image.png\"><br />以上是客户端 id，复制记下来，再找到 visitor 这个角色，复制记下来。<br /><img src=\"https://cdn.nlark.com/yuque/0/2022/png/221736/1647761574924-59f6c32b-0508-406a-ab7f-b55425daa39a.png#clientId=ue764e438-aa72-4&#x26;crop=0&#x26;crop=0&#x26;crop=1&#x26;crop=1&#x26;from=paste&#x26;height=644&#x26;id=u3dc1f6fb&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=1933&#x26;originWidth=3000&#x26;originalType=binary%E2%88%B6=1&#x26;rotation=0&#x26;showTitle=false&#x26;size=428673&#x26;status=done&#x26;style=none&#x26;taskId=u55f8a924-f038-43e3-9cdc-94694fdd9ad&#x26;title=&#x26;width=1000\" alt=\"image.png\"><br />随后，使用 <a href=\"https://www.keycloak.org/docs-api/17.0/rest-api/#_client_role_mappings_resource\">https://www.keycloak.org/docs-api/17.0/rest-api/#_client_role_mappings_resource</a> 文档列出的 API 端点，拼装出请求即可。<br /><img src=\"https://cdn.nlark.com/yuque/0/2022/png/221736/1647955131996-b70e0dfe-7a7c-4b4c-8dca-32f56953755b.png#clientId=ubfda23d7-006e-4&#x26;crop=0&#x26;crop=0&#x26;crop=1&#x26;crop=1&#x26;from=paste&#x26;height=586&#x26;id=u0c72f42f&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=733&#x26;originWidth=1791&#x26;originalType=binary%E2%88%B6=1&#x26;rotation=0&#x26;showTitle=false&#x26;size=59790&#x26;status=done&#x26;style=none&#x26;taskId=u6714492e-1ea8-40df-81f5-82cf382ecb3&#x26;title=&#x26;width=1432.8\" alt=\"image.png\"><br />关键代码见下，注意还是要先获取管理员的访问令牌，并在请求时带上这个令牌。\njava</p>\n<p>public Response jsonRequest(String url, String payload) throws IOException {\nvar mediaType = MediaType.parse(application/json);\nvar body = RequestBody.create(mediaType, payload);\nvar request = new Request.Builder().url(url).method(POST, body).addHeader(Content-Type, application/json).addHeader(Authorization, java.lang.String.format(Bearer %s, getAdminAccessToken().access_token)).build();\nvar res = client.newCall(request).execute();</p>\n<pre><code>System.out.println(java.lang.String.format(jsonRequest response = %s, res.toString()));\n\nreturn res;\n</code></pre>\n<p>}</p>\n<p>public String assignRole(String userId) throws IOException {\nSystem.out.println(java.lang.String.format(assigning role for user = %s, userId));\nvar clientId = 98ea8f07-a7f2-4607-ab56-b5208a90eaa1;\nvar url = java.lang.String.format(<a href=\"https://keycloak.jiwai.win/auth/admin/realms/UniHeart/users/%25s/role-mappings/clients/%25s\">https://keycloak.jiwai.win/auth/admin/realms/UniHeart/users/%s/role-mappings/clients/%s</a>, userId, clientId);\nvar payload = java.lang.String.format([{id: bef4bf69-371b-460a-8a0c-b2943da1983b,name:visitor,description:add roles programatically,composite:false,clientRole:true,containerId:%s}], clientId);</p>\n<pre><code>System.out.println(java.lang.String.format(payload = %s, payload));\n\nreturn this.jsonRequest(url, payload).toString();\n</code></pre>\n<p>}</p>\n<p>一个成功的请求，会拿到 Keycloak 的 204 空返回结果，不要惊讶，这正是操作成功的反馈。<br /><img src=\"https://cdn.nlark.com/yuque/0/2022/png/221736/1647955617783-b83164af-b6cb-4f0a-8277-1787bee6faa7.png#clientId=ubfda23d7-006e-4&#x26;crop=0&#x26;crop=0&#x26;crop=1&#x26;crop=1&#x26;from=ui&#x26;id=ua9ca29c7&#x26;margin=%5Bobject%20Object%5D&#x26;name=%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20220322115353.png&#x26;originHeight=878&#x26;originWidth=1477&#x26;originalType=binary%E2%88%B6=1&#x26;rotation=0&#x26;showTitle=false&#x26;size=54334&#x26;status=done&#x26;style=none&#x26;taskId=u7f9c6ec5-9e35-4d6e-8d7f-9efbbab38cb&#x26;title=\" alt=\"微信截图_20220322115353.png\"><br />不放心可以在 Keycloak 的后台验证一下。执行请求完成后，去客户端角色详情面板的用户列表查看，可以找到我们传入的用户 id 对应的用户。<br /><img src=\"https://cdn.nlark.com/yuque/0/2022/png/221736/1647955632065-c6a20b97-60a8-4968-96c6-b516e88be9a9.png#clientId=ubfda23d7-006e-4&#x26;crop=0&#x26;crop=0&#x26;crop=1&#x26;crop=1&#x26;from=ui&#x26;id=HqLCb&#x26;margin=%5Bobject%20Object%5D&#x26;name=%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20220322115427.png&#x26;originHeight=997&#x26;originWidth=1764&#x26;originalType=binary%E2%88%B6=1&#x26;rotation=0&#x26;showTitle=false&#x26;size=56514&#x26;status=done&#x26;style=none&#x26;taskId=ufec528a1-4d1d-4e90-b688-0b231a9fde7&#x26;title=\" alt=\"微信截图_20220322115427.png\"><br />点击进入用户详情，对比用户 id，正是我们传入的。<br /><img src=\"https://cdn.nlark.com/yuque/0/2022/png/221736/1647955841481-41b5f80a-cdbc-4397-a173-8f8150bfa136.png#clientId=ubfda23d7-006e-4&#x26;crop=0&#x26;crop=0&#x26;crop=1&#x26;crop=1&#x26;from=ui&#x26;id=u1775889b&#x26;margin=%5Bobject%20Object%5D&#x26;name=%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20220322115446.png&#x26;originHeight=960&#x26;originWidth=1230&#x26;originalType=binary%E2%88%B6=1&#x26;rotation=0&#x26;showTitle=false&#x26;size=41123&#x26;status=done&#x26;style=none&#x26;taskId=uceb1c811-1f39-4857-9645-9f4dbe390ab&#x26;title=\" alt=\"微信截图_20220322115446.png\">\n<a name=SS3tp></a></p>\n<h1>分配领域角色</h1>\n<p>和分配客户端角色基本相同，也就是一个请求的事情。但是要注意，payload 有所不同，比如，你不能再将客户端角色 id 和 name 填进去，不然会是 404 Role not found。另外，注意 Keycloak 对角色名称是区分大小写的，所以大小写写错，也会是 404 Role not found。</p>\n<p>当然，API 端点也有所区别，分配领域角色利用这个 API： <a href=\"https://www.keycloak.org/docs-api/17.0/rest-api/#_role_mapper_resource\">https://www.keycloak.org/docs-api/17.0/rest-api/#_role_mapper_resource</a><br /><img src=\"https://cdn.nlark.com/yuque/0/2022/png/221736/1647955462891-e535b0f7-56be-4042-9d9f-af871006df9f.png#clientId=ubfda23d7-006e-4&#x26;crop=0&#x26;crop=0&#x26;crop=1&#x26;crop=1&#x26;from=paste&#x26;height=513&#x26;id=u11c9af69&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=641&#x26;originWidth=1814&#x26;originalType=binary%E2%88%B6=1&#x26;rotation=0&#x26;showTitle=false&#x26;size=56954&#x26;status=done&#x26;style=none&#x26;taskId=ubf7f29b9-ec40-41dc-b9aa-efb99c13518&#x26;title=&#x26;width=1451.2\" alt=\"image.png\"></p>\n<p>关键代码如下：</p>\n<p>java</p>\n<p>public java.lang.String assignRealmRole(String userId) throws IOException {\nSystem.out.println(java.lang.String.format(assigning realm role for user = %s, userId));\nvar clientId = 98ea8f07-a7f2-4607-ab56-b5208a90eaa1;\nvar url = java.lang.String.format(<a href=\"https://keycloak.jiwai.win/auth/admin/realms/UniHeart/users/%25s/role-mappings/realm\">https://keycloak.jiwai.win/auth/admin/realms/UniHeart/users/%s/role-mappings/realm</a>, userId);\nvar payload = java.lang.String.format([{id: 5e47a34a-5c22-457f-af3f-e5dea7b06839, +\nname:offline_access,description:add roles programatically,composite:false,clientRole:false,containerId:%s}], clientId);</p>\n<pre><code>System.out.println(java.lang.String.format(url = %s, with payload = %s, url, payload));\n\nreturn this.jsonRequest(url, payload).toString();\n</code></pre>\n<p>}</p>\n<p>同样，当拿到 Keycloak API 204 空返回时，就是操作成功了。<br /><img src=\"https://cdn.nlark.com/yuque/0/2022/png/221736/1647955752757-519919b9-7b98-4358-98e8-6581503ddf0a.png#clientId=ubfda23d7-006e-4&#x26;crop=0&#x26;crop=0&#x26;crop=1&#x26;crop=1&#x26;from=ui&#x26;id=u0992a338&#x26;margin=%5Bobject%20Object%5D&#x26;name=%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20220322130639.png&#x26;originHeight=507&#x26;originWidth=1453&#x26;originalType=binary%E2%88%B6=1&#x26;rotation=0&#x26;showTitle=false&#x26;size=35713&#x26;status=done&#x26;style=none&#x26;taskId=u9f00b819-33bf-4059-92fe-7d32e73cbf0&#x26;title=\" alt=\"微信截图_20220322130639.png\"><br />不放心可以通过 Keycloak 后台来人肉验证。</p>\n<p>比如，以上代码是将指定的用户分配到领域 UniHeart 的 offline_access 角色里。执行请求前，先看一下 Keycloak 的角色详情中的用户列表：<br /><img src=\"https://cdn.nlark.com/yuque/0/2022/png/221736/1647955785521-2759795b-be83-4350-b52d-d345120f5224.png#clientId=ubfda23d7-006e-4&#x26;crop=0&#x26;crop=0&#x26;crop=1&#x26;crop=1&#x26;from=ui&#x26;id=u08fdd481&#x26;margin=%5Bobject%20Object%5D&#x26;name=%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20220322115939.png&#x26;originHeight=1029&#x26;originWidth=1920&#x26;originalType=binary%E2%88%B6=1&#x26;rotation=0&#x26;showTitle=false&#x26;size=90441&#x26;status=done&#x26;style=none&#x26;taskId=u66c6e6a8-ca05-406b-a990-8ecd677e63e&#x26;title=\" alt=\"微信截图_20220322115939.png\"><br />没有 test 用户。</p>\n<p>执行请求成功后，再次查看，有了。<br /><img src=\"https://cdn.nlark.com/yuque/0/2022/png/221736/1647955737169-9bc7212c-1c11-4547-9fdb-029afa83d3d8.png#clientId=ubfda23d7-006e-4&#x26;crop=0&#x26;crop=0&#x26;crop=1&#x26;crop=1&#x26;from=ui&#x26;id=udffd5d72&#x26;margin=%5Bobject%20Object%5D&#x26;name=%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20220322130743.png&#x26;originHeight=525&#x26;originWidth=983&#x26;originalType=binary%E2%88%B6=1&#x26;rotation=0&#x26;showTitle=false&#x26;size=25494&#x26;status=done&#x26;style=none&#x26;taskId=uda729106-df0e-4c5d-a364-f928a225348&#x26;title=\" alt=\"微信图片_20220322130743.png\"></p>\n<p><a name=h4uZY></a></p>\n<h1>总结</h1>\n<p>几乎所有的编程操作 Keycloak 的 SDK 或者库，本质上都是利用 Keycloak 的  API 来完成的。我们也可以直接使用一个 http client，编程操作 Keycloak。本文在上一篇编程创建 Keycloak 用户的基础上，再次详解了编程分配用户角色。</p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","description":"Full Stack Developer, good at OAuth 2.0","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"本站源码","url":"https://github.com/Jeff-Tian/space","style":"link","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}},"menus":{}}},"staticQueryHashes":[]}