{"componentChunkName":"component---src-templates-post-js","path":"/posts/ra4080d5wcexyvc1/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/ra4080d5wcexyvc1","relativePath":"posts/ra4080d5wcexyvc1","frontmatter":{"title":"Free Arch： 在 Okteto 上部署 backstage（第二部分）","stackbit_url_path":"posts/ra4080d5wcexyvc1","date":"2022-12-09T11:42:34","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p>接上一篇《<a href=\"https://zhuanlan.zhihu.com/p/590349401\">Free Arch: 在 Okteto 上部署 backstage （第一部分： PostgreSQL） - Jeff Tian的文章 - 知乎 </a> 》，完成在 Okteto 上对 backstage 的部署。上一篇部署了 backstage 应用依赖的 PostgreSQL 数据库，但其实不局限于 backstage，恭喜你有了一个免费的 PostgreSQL as as Service 了！</p>\n<p>今天，你将拥有一个部署好的开发门户： <a href=\"https://backstage-backstage-jeff-tian.cloud.okteto.net/tech-radar\">https://backstage-backstage-jeff-tian.cloud.okteto.net/tech-radar</a></p>\n<p>整个项目源码见： <a href=\"https://github.com/brick-verse/backstage\">https://github.com/brick-verse/backstage</a></p>\n<p><a name=XBt55></a></p>\n<h1>创建 Backstage 实例</h1>\n<p>其实整体步骤和创建 PostgreSQL 实例类似。\n<a name=Waosh></a></p>\n<h2>创建 Backstage secret</h2>\n<p>Backstage 配置上有一些 secret，比如授权令牌等。和上一篇的 PostgreSQL secret 一样，我们也可以为 Backstage 创建 Kubernetes secret。同样地，为了能在公开代码仓库里管理这些 secret，我们继续使用 sops。不仅在本地使用，最终还要在 GitHub Actions 里使用，为此，这里再多描述一下其安装方式。</p>\n<p>如果是 mac 电脑，要安装首推： brew install sops。但如果 GitHub Actions 里使用了 Ubuntu 镜像，就需要另外的安装方法，最简单的其实就是将 sops 官方发布的 linux 二进制文件下载下来，拷贝到应用程序库，再赋予一个可执行权限即可：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2149c07cdfd12580e96630793cfc0132/cf8e5/1670557923139-3eac76ea-9281-4c68-91b1-f62e987fd17d.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 65.54054054054055%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAABmElEQVR42n2TiY7jIBBE8/8/uCttDm/wJJmJwWMOO2DgrYxzOJlokUqA6S6qy80qxoj3nk5rjLEYa5Gt5iQNjZQ0Ut0hlaJpGk7nls55whjwPuDDAyveDN2PrA8GIQSirqnrD4So2Yuaw+d0Scu3Hcn5Z+4q58wS01DG83vfUlUV213FZrtlt6v4s95Q/RVlvdkfkSaU+GX+W8LeR46qR00lSsnnV4PqHH3fFzjnsNaVuJvIOyFlwRNhpw3f2jLGTEyJNJ2984Y5J6X0rJBr+M0T2Tn2zUCtAn5M96SfmL8b68rFs0IydgQVEjGnq4cD++aCUJ4hxCthLkrvSLOiiWjqjrQknAJiBhkFEOlMQDSB1mbGONuR3qAQxhfCucy5VpsUOp+ouw9+nY/s9AEbu3L8KHGBhcKb17OH159SZkbOWlM1hvXZcBnDfz2cFGpjyjzt57ZhQQq05sLuK9CY9NJnb8pPubyQ9KSQ57axzqE6i3MD4zCUp3m5ePp+eGqRO5Z9uCR8ECfIiTzdGmPxp+Ba1ithWryUf7y++SDf/BpyAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/2149c07cdfd12580e96630793cfc0132/fcda8/1670557923139-3eac76ea-9281-4c68-91b1-f62e987fd17d.png\"\n        srcset=\"/static/2149c07cdfd12580e96630793cfc0132/12f09/1670557923139-3eac76ea-9281-4c68-91b1-f62e987fd17d.png 148w,\n/static/2149c07cdfd12580e96630793cfc0132/e4a3f/1670557923139-3eac76ea-9281-4c68-91b1-f62e987fd17d.png 295w,\n/static/2149c07cdfd12580e96630793cfc0132/fcda8/1670557923139-3eac76ea-9281-4c68-91b1-f62e987fd17d.png 590w,\n/static/2149c07cdfd12580e96630793cfc0132/efc66/1670557923139-3eac76ea-9281-4c68-91b1-f62e987fd17d.png 885w,\n/static/2149c07cdfd12580e96630793cfc0132/c83ae/1670557923139-3eac76ea-9281-4c68-91b1-f62e987fd17d.png 1180w,\n/static/2149c07cdfd12580e96630793cfc0132/cf8e5/1670557923139-3eac76ea-9281-4c68-91b1-f62e987fd17d.png 1402w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>shell\nwget <a href=\"https://github.com/mozilla/sops/releases/download/v3.7.3/sops-v3.7.3.linux.amd64\">https://github.com/mozilla/sops/releases/download/v3.7.3/sops-v3.7.3.linux.amd64</a>\nsudo cp sops-v3.7.3.linux.amd64 /usr/local/bin/sops\nsudo chmod +x /usr/local/bin/sops</p>\n<p>这样，就可以在 cicd 的过程中，解密我们提交的代码中包含的敏感信息并直接应用到 Kubernetes 集群了。\nshell\nsops -d k8s/backstage/backstage-secrets.yaml --aws-profile lambda-doc-rotary | kubectl apply -f -</p>\n<p>这个 Kubernetes secret 源文件如下：\nyaml\napiVersion: v1\nkind: Secret\nmetadata:\nname: backstage-secrets\nnamespace: backstage-jeff-tian\ntype: Opaque\nstringData:\nGITHUB_TOKEN: ghp_xxx</p>\n<p>在加密后，就可以将其提交到代码库中了：\nshell\nsops -e -i k8s/backstage/backstage-secrets.yaml --aws-profile lambda-do\nc-rotary</p>\n<p>最终提交的代码会是这样的形式：</p>\n<p>yaml\napiVersion: ENC[AES256_GCM,data:bEk=,iv:hcFNv2TwjLfvOjeM9064bwDZB3yI5lCgEVT+Ynszc9Y=,tag:m2dI0x+KSaoDz+iL6Vw2EQ==,type:str]\nkind: ENC[AES256_GCM,data:zAD9+VKm,iv:WbcLh4rxY1yNh2y9Cd6e7SwpDBV3qdCvzrrpWKmkyi0=,tag:f3GXWcdbYRP03vhxtYzgVg==,type:str]\nmetadata:\nname: ENC[AES256_GCM,data:INjDh7TCyLrhoGv0YPnALnw=,iv:eMPwpTcFUtQBqfWESCH6z40QxfmJMHUsssNAiI0pCf0=,tag:+SOiPYSatdmuYbz5hg/cTA==,type:str]\nnamespace: ENC[AES256_GCM,data:PlQJWeKsBB0L,iv:CHQ8iaXGZGKbg+LKaLd5Ax44fu1lrnheDQrU+n6Wukk=,tag:w8wS2V5V9flqP4uTSpi3eg==,type:str]\ntype: ENC[AES256_GCM,data:vB8Cmr8M,iv:8ulZE1MR+g2ZKhswn+F8WvRd5QZWi6N++hoIUKFskn0=,tag:vz6r6VfMaqg4ItEB+3M6mA==,type:str]\nstringData:\nGITHUB_TOKEN: ENC[AES256_GCM,data:L1X1ELh/IllOesKi055edpbIWvkN4fNvjZaqIi3oskMdYz0RDnkd5A==,iv:HAFP3m6yRZGTXTERWMwKL1G+By3R1+bF64PA/sBkoEw=,tag:nH49kNWCUc4IuanT6xs10Q==,type:str]\nsops:\nkms:\n- arn: arn:aws:kms:us-east-1:443862765029:key/b1739688-ec15-407d-895d-d05ca1217a2f\ncreated_at: 2022-12-09T03:59:01Z\nenc: AQICAHjChsodiuiXwUJt0aacmc0yR0oJ/pdUQ2LNOm0pPYSlowGIlkQuqgbLzCxvn/JFbOHFAAAAfjB8BgkqhkiG9w0BBwagbzBtAgEAMGgGCSqGSIb3DQEHATAeBglghkgBZQMEAS4wEQQMTSLzU+9JpeKBpg8/AgEQgDsKbEogY5I4oAr22cK/QoX1aDGZmDrF7sCM3yG5EsZ9kdgmBDdaF8Goe5SM17Qe61UVxJVEJq+3B7lbEA==\naws_profile: lambda-doc-rotary\ngcp_kms: []\nazure_kv: []\nhc_vault: []\nage: []\nlastmodified: 2022-12-09T03:59:02Z\nmac: ENC[AES256_GCM,data:h1iPEVM42YDnx3zce/U1pCJWSxNfD53DRoVFiJNJH/fW8GbjQu5CdUpN2T4jj4QehY5SfFh8uPwMauesNm06fh6H+uZD+4HuvTRrp6iGo/DJpoTpd2fiyeEaoenFfwSNkO87Ned5mUd4aWopdWzKwYe1i8sGmpg80HV+KcoiQYQ=,iv:/Z4q/gc4uuCTuYTER6oNPantCIxfLgP1N/g4izm3X/Y=,tag:brpuZIDaN+H7DYDCkcgWzg==,type:str]\npgp: []\nunencrypted_suffix: _unencrypted\nversion: 3.7.3</p>\n<p>因此，不用担心开放源代码。</p>\n<p><a name=EZFDG></a></p>\n<h2>创建 Backstage 部署</h2>\n<p>要创建一个 Backstage 的部署描述文件，首先需要有一个 Docker 镜像。可以拉 backstage 的源码自己构建这个镜像，也可以使用开放镜像中的标准镜像，只要是打包了前端项目，并且通过后端来提供服务的版本，就行。自己从本地构建镜像的过程如下：</p>\n<p>先通过 npx @backstage/create-app 创建一个 backstage 应用，并切换至项目的根目录，然后添加连接 PostgreSQL 的包：\nshell\nyarn add --cwd packages/backend pg</p>\n<p>接着，在项目的 app-config.yml文件中，添加 PostgreSQL 配置：</p>\n<p>yaml\nbackend:\ndatabase:\n# config options: <a href=\"https://node-postgres.com/api/client\">https://node-postgres.com/api/client</a>\nclient: pg\nconnection:\nhost: postgres\nport: 5432\nuser: ${POSTGRES_USER}\npassword: ${POSTGRES_PASSWORD}</p>\n<p>注意上面的 POSTGRES_USER和 POSTGRES_PASSWORD是上一篇文章里写在 postgres-secrets.yaml文件中的，并且已经应用到了 Okteto Kubernetes。由于我们将 Backstage 和 PostgreSQL 部署在同一集群，因此可以使用 postgres这个 service name 直接访问到部署好的 PostgreSQL 服务：\nshell\nkubectl get service\nNAME       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE\npostgres   ClusterIP   10.154.150.79   <none>        5432/TCP   19h</p>\n<p>修改好了应用配置，先构建后端：\nshell\nyarn tsc\nyarn build:backend</p>\n<p>现在，就可以开始构建镜像了：</p>\n<p>shell\nyarn build-image --tag jefftian/backstage:1.0.0</p>\n<p>然后，将构建好的镜像上传至 Docker registry，可以是 ECR，也可以是 Docker 的官方镜像源：</p>\n<p>shell\ndocker push jefftian/backstage:1.0.0</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ac26306f1b0e62a0d1eb292feb82723a/9dbdb/1670580731969-9ecd1a02-e5fd-4092-8bdb-fdcf52cd4bc5.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.5945945945946%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABhUlEQVR42oVSTWsUQRTc/w/5DeIpIojRS4wrkpgIriJ4y2HdQ0Jm3N356M/pmf4seW8yYrxYULw3j+nq6upeCaXRdD2E1OiFglQGnZBcrRthBveENFvm2g5QxnLVxsBYi5UPEUprHI9HDMOAuq4hpQQhl4LyD2Pw8KMDUPA3IrEAq8kHNE0LISRCCLDWYpqmx98KcxEjXH35jmcv3+D07B1enX/E2w/XzOev17jd3c8OvfewZFtrODfOUuWpgwU/bre4+LTB+uYb1jdfuX9/vcHZxSV2dw+zw3EcmSklxJSQUkbOGSFETJPnDck1ff8PLNi2LQ6HA2dIogsoApqRmDIDJh/R9T22P3eo6l+QSnHeQgieex+wCjHyAnJEToiLW6p8/JxhjGb3ziqodg/R7lHXFaqqQtt1vLEPYc5QO88ClBvV+VIKQkzQY0IjHaqjImV83iqcnD/gxaZBq+jpOKQY/1whHznlPPMxu5wL90QSjdTneTM9RuxVRG8jz+hpZV475/8bHIuyR79RHgEAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/ac26306f1b0e62a0d1eb292feb82723a/fcda8/1670580731969-9ecd1a02-e5fd-4092-8bdb-fdcf52cd4bc5.png\"\n        srcset=\"/static/ac26306f1b0e62a0d1eb292feb82723a/12f09/1670580731969-9ecd1a02-e5fd-4092-8bdb-fdcf52cd4bc5.png 148w,\n/static/ac26306f1b0e62a0d1eb292feb82723a/e4a3f/1670580731969-9ecd1a02-e5fd-4092-8bdb-fdcf52cd4bc5.png 295w,\n/static/ac26306f1b0e62a0d1eb292feb82723a/fcda8/1670580731969-9ecd1a02-e5fd-4092-8bdb-fdcf52cd4bc5.png 590w,\n/static/ac26306f1b0e62a0d1eb292feb82723a/efc66/1670580731969-9ecd1a02-e5fd-4092-8bdb-fdcf52cd4bc5.png 885w,\n/static/ac26306f1b0e62a0d1eb292feb82723a/c83ae/1670580731969-9ecd1a02-e5fd-4092-8bdb-fdcf52cd4bc5.png 1180w,\n/static/ac26306f1b0e62a0d1eb292feb82723a/9dbdb/1670580731969-9ecd1a02-e5fd-4092-8bdb-fdcf52cd4bc5.png 2622w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>最后，创建出的 Kubernetes Deployment 文件如下：\nyaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\nname: backstage\nnamespace: backstage-jeff-tian\nspec:\nreplicas: 1\nselector:\nmatchLabels:\napp: backstage\ntemplate:\nmetadata:\nlabels:\napp: backstage\nspec:\ncontainers:\n- name: backstage\nimage: jefftian/backstage:1.0.0\nimagePullPolicy: IfNotPresent\nports:\n- name: http\ncontainerPort: 7007\nenvFrom:\n- secretRef:\nname: postgres-secrets\n- secretRef:\nname: backstage-secrets</p>\n<p><a name=zN7OV></a></p>\n<h2>创建 Backstage service</h2>\n<p>和上一篇创建 PostgreSQL service 一样，我们需要给 Backstage 应用也创建 Kubernetes Service，从而可以将连接请求导入到正确的 pod。这个 Service 描述文件如下：</p>\n<p>yaml\napiVersion: v1\nkind: Service\nmetadata:\nname: backstage\nnamespace: backstage-jeff-tian</p>\n<p>annotations:\ndev.okteto.com/auto-ingress: true\nspec:\nselector:\napp: backstage\nports:\n- name: http\nport: 80\ntargetPort: http</p>\n<p>上面的 selector 选择器会告诉 service 该连接哪个目标 pod，而端口映射会将普通的 HTTP 80 端口映射到 pod 里的后端服务的 7007 HTTP 端口（其定义在前面的部署描述文件 backstage-deployment.yaml 中）。\n<a name=DH9o9></a></p>\n<h2>开启 ingress</h2>\n<p>该 Backstage 应用和 PostgreSQL 不一样，我们需要将公网流量导入，因此需要 Ingress。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bdd3df1dde89ae3d7e2d18a1ae285099/77abb/1670584952096-8abbe49f-8c86-4111-92e7-08fd845b9e96.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 25.675675675675674%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAABBElEQVR42n2L226CQAAF+YM+1EsDWgERd1mQhWURFWmxxsSkSdP//5hpxF7e+jCZyUmOY6od2uyom468bEgyw0bXqKwiSQ1ZbhGqYJ1oxH+oYrATpwWZadGmJSv2xIlB5Q0rWSJSi65awjjH8yUzP2EeKubBnVmQ/PYPzkMYY+wRkVkm3pJZIHiOFJ4vaLorqXmhaN7I6x5VHql2Z4ptT7k9EaktobQskz8ckRZ05w+qw2UYoqRGlseh15s9UrdsbI/MD8MWFq+EZU+oOwJREQjz7TvOSmyo9hd0fULcTtISpQ2RslzfP4llzmg6Z+z6jN0FIzfg0Q0GP3k+0xvugom7GPoLLnOW8ZNR7JgAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/bdd3df1dde89ae3d7e2d18a1ae285099/fcda8/1670584952096-8abbe49f-8c86-4111-92e7-08fd845b9e96.png\"\n        srcset=\"/static/bdd3df1dde89ae3d7e2d18a1ae285099/12f09/1670584952096-8abbe49f-8c86-4111-92e7-08fd845b9e96.png 148w,\n/static/bdd3df1dde89ae3d7e2d18a1ae285099/e4a3f/1670584952096-8abbe49f-8c86-4111-92e7-08fd845b9e96.png 295w,\n/static/bdd3df1dde89ae3d7e2d18a1ae285099/fcda8/1670584952096-8abbe49f-8c86-4111-92e7-08fd845b9e96.png 590w,\n/static/bdd3df1dde89ae3d7e2d18a1ae285099/efc66/1670584952096-8abbe49f-8c86-4111-92e7-08fd845b9e96.png 885w,\n/static/bdd3df1dde89ae3d7e2d18a1ae285099/c83ae/1670584952096-8abbe49f-8c86-4111-92e7-08fd845b9e96.png 1180w,\n/static/bdd3df1dde89ae3d7e2d18a1ae285099/77abb/1670584952096-8abbe49f-8c86-4111-92e7-08fd845b9e96.png 1305w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>由于使用了 Okteto，我们可以直接启用自动 Ingress，并且得到一个 Okteto 分配好的公网域名，注意在上面的 service 定义里，我们添加了：\nyaml\nannotations:\ndev.okteto.com/auto-ingress: true</p>\n<p>它让我们得到了一个可以公开访问的网址：<a href=\"https://backstage-backstage-jeff-tian.cloud.okteto.net/\">https://backstage-backstage-jeff-tian.cloud.okteto.net/</a><br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 24.324324324324326%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAABE0lEQVR42lXK2WrCQACF4byDC2pcYtQsk8wkmUw2rU7Vi5ZCodLe9P0f5C8aEHrxwX/gOEXZYOoXmr0l1y2pMuS6QWbVw70TqRFp79Hi3gaR1T1ZPj9OkBSo8ogsOtK8IxAlMu/YxZptVKD0gaWf4K5i5l7MdCZYpQGLJMUNa9yoYu5LFp5gsRY4g02IaU7shGbsbnC9kJkXsQ4Unf0gkB26vaCMJdUnuu89zVdLVln8UPcigx/3HJFVnN9uFO0VPyrZxIawOLCODGlpUdUrRXshM2fyvcV8NiSFJW+uJNriixo/rp6cTaioj+/I0hKqjq2o2cqOULXcfn7xA8lwsmQ88xhPPQZDj9F01e+Zx2iy/OcPLgqYJCnOwnIAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/4c333422bb86a023338d27ec700c64b5/fcda8/1670584998199-4fcec06f-3bb9-46c3-ac44-648b897c170b.png\"\n        srcset=\"/static/4c333422bb86a023338d27ec700c64b5/12f09/1670584998199-4fcec06f-3bb9-46c3-ac44-648b897c170b.png 148w,\n/static/4c333422bb86a023338d27ec700c64b5/e4a3f/1670584998199-4fcec06f-3bb9-46c3-ac44-648b897c170b.png 295w,\n/static/4c333422bb86a023338d27ec700c64b5/fcda8/1670584998199-4fcec06f-3bb9-46c3-ac44-648b897c170b.png 590w,\n/static/4c333422bb86a023338d27ec700c64b5/efc66/1670584998199-4fcec06f-3bb9-46c3-ac44-648b897c170b.png 885w,\n/static/4c333422bb86a023338d27ec700c64b5/c83ae/1670584998199-4fcec06f-3bb9-46c3-ac44-648b897c170b.png 1180w,\n/static/4c333422bb86a023338d27ec700c64b5/6569d/1670584998199-4fcec06f-3bb9-46c3-ac44-648b897c170b.png 1328w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>如果想要自定义二级域名，也可以不开启自动 Ingress，而是添加一个 Ingress 定义文件，并在 Kustomization.yaml 中引用它：\nyaml\napiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\nname: backstage\nannotations:\ndev.okteto.com/generate-host: your-cool-host-name\nspec:\nrules:\n- http:\npaths:\n- backend:\nservice:\nname: backstage\nport:\nnumber: 7007\npath: /\npathType: ImplementationSpecific</p>\n<p><a name=RJIpG></a></p>\n<h2>创建 Backstage 的 kustomization</h2>\n<p>这是为了可以运行 kubectl apply -k k8s/backstage。文件内容很简单，如下所示：</p>\n<p>yaml\napiVersion: kustomize.config.k8s.io/v1beta1\nkind: Kustomization</p>\n<p>bases: []\nresources:</p>\n<ul>\n<li>backstage-deployment.yaml</li>\n<li>backstage-service.yaml</li>\n</ul>\n<p><a name=kmbHE></a></p>\n<h1>利用 GitHub Actions 自动部署</h1>\n<p>和上一篇的 PostgreSQL 不一样，Backstage 应用需要自行构建 Docker 镜像，为了能在 GitHub Actions 里自动完成这一步，我们把上面手动执行的步骤写成一个文件： .github/ci.sh。我们之前手动 npx @backstage create-app 创建的文件，我们放在 brickstage目录下，并将其提交到了代码仓库，从而在 cicd 步骤不用再做这一步，只需要从 yarn install 开始：</p>\n<p>shell\ncd brickstage\nnpm i -g yarn\nyarn install --production=false\nyarn tsc\nyarn build:backend\nDOCKER_BUILDKIT=1 yarn build-image --tag jefftian/backstage\ndocker images\ndocker run --network host -e CI=true -d -p 127.0.0.1:7007:7007 --name backstage jefftian/backstage\ndocker ps | grep -q backstage\ndocker ps -aqf name=backstage$\ndocker push jefftian/backstage\ndocker logs $(docker ps -aqf name=backstage$)\ncurl localhost:7007 || docker logs $(docker ps -aqf name=backstage$)\ndocker kill backstage || echo backstage killed\ndocker rm backstage || echo backstage removed</p>\n<p>以上和在本地 Mac 上不一样，注意在执行 yarn build-image 时需要显式启用 DOCKER_BUILDKIT。</p>\n<p>由于使用到了 node，所以在 cicd.yaml 文件中增加一个 ci 步骤，并且安装好 node。由于需要推送 Docker 镜像，记得要加入登录命令，并且保证 GitHub Actions 里有相应的 secrets：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/61496e3abb80ad5d8d37fad47e16af0b/f2331/1670584075651-35bc7dbc-65c6-436c-a5c8-5074919bd11c.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.16216216216216%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAABt0lEQVR42mVTOZLcMAyc///FD3Dg2JkzRxu5HOyORrxFkODVLmCO3fGwqgsQSmo0GtTJOI9tNzdYXIzF+WJgfVS4IEgwxsFYh1wYB1VkqhpLaeA6wLUjl4rTWgsL19N6R6lVc6mPORFjUiIuRaq4n3v26/wb396+48efn+DRcLp/LIdbg/MeMUaMMbR+2Xe8v3/AWIsQIqxzCCHAaYzYvMfffYPLSTmuCm+EQpJSQs6ktTkXfCqgUkD0GUuRUQtKZRBPUJ3o48rxpLAy63hzzsdYMWXs1qs/VJt6eAdVRqYC6zySiviPUPzbLhdVeq9/BXMDM2tjgeQyxdd3nhVWRojxoRCq8IDcBFHDfYBbB7dbvD1XrfVXQlmKLISI0Fp7NInxUHXSZ4ylEGVCkrN4yyDiVw+pVGzbrqPI2H125Jpg/I5cDww09MUKyUsjhOyRSlKI688K+4DzQZWOPnF0j1g8NvsBf1i0VcGzKCTPnGCTQaQAQ2dt8kTYe4f3/uFhQ0WsDnvYkGoALwLPGxYhtwh3GARycGSwMF89tPJ7ET2Wwk2uR8HExJjjE2ug9YZSCwpX3bp4+A/e86gde3iLJgAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/61496e3abb80ad5d8d37fad47e16af0b/fcda8/1670584075651-35bc7dbc-65c6-436c-a5c8-5074919bd11c.png\"\n        srcset=\"/static/61496e3abb80ad5d8d37fad47e16af0b/12f09/1670584075651-35bc7dbc-65c6-436c-a5c8-5074919bd11c.png 148w,\n/static/61496e3abb80ad5d8d37fad47e16af0b/e4a3f/1670584075651-35bc7dbc-65c6-436c-a5c8-5074919bd11c.png 295w,\n/static/61496e3abb80ad5d8d37fad47e16af0b/fcda8/1670584075651-35bc7dbc-65c6-436c-a5c8-5074919bd11c.png 590w,\n/static/61496e3abb80ad5d8d37fad47e16af0b/efc66/1670584075651-35bc7dbc-65c6-436c-a5c8-5074919bd11c.png 885w,\n/static/61496e3abb80ad5d8d37fad47e16af0b/c83ae/1670584075651-35bc7dbc-65c6-436c-a5c8-5074919bd11c.png 1180w,\n/static/61496e3abb80ad5d8d37fad47e16af0b/f2331/1670584075651-35bc7dbc-65c6-436c-a5c8-5074919bd11c.png 1427w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>yaml\njobs:\nci:\nname: ci\nruns-on: ubuntu-latest\nsteps:\n- uses: actions/checkout@v3\n- uses: actions/setup-node@v3\nwith:\nnode-version: 18\n- run: echo ${{secrets.DOCKER_PASSWORD}} | docker login -u ${{secrets.DOCKER_USERNAME}} --password-stdin\n- run: sh .github/ci.sh</p>\n<p>结合上一篇中的 PostgreSQL，加上本篇的 Backstage，最终的 GitHub Actions 运行效果如下：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/da808b7e57ba80c89a69c3514446dc3f/84bf8/1670584278312-fb44296e-16b6-410e-aa91-80d4a087d032.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 65.54054054054055%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACC0lEQVR42o1SaW/TQBT0T0ZCpWqjprkcNy5BBQHi16GWWnFz2LG9967tQftsJwG+8KTRaA/Nmze7wdfvP/D05RtmiwjTxRKT+RLjaYhp+IB5FGMyjxA9fkK8fkK8/kwcxWvMlzGd/41gPIswmq5wO4nwfhTi3fUY16N7zMIY4WqNWbjC4uEjZsuYeB494m4S4urmDh9u73F1M/4DgWuBXLSEtGqRiQZ1A/h92wB126HBmT18tfi3AiEVpJRQSsEYDSEE/B4rCrCKgQlJ64oLlBUH4wJFyVBWDEVZQRsLpc8I3oodfr48Y7NJ8fzyC69JgtfXBOkmRZIk2KQp3rY7GGPxPxWUXGG724PzzgnnAlprKOXdSmKlNeqmIbi6Rtu21KCua0LTNLTnEXDphSSsdXDOoWm6ZITgyLIMRVGiKEtUuiaRLMtJ4HDIYKyFtZ0wZeoF02KLXbYHZxyMcbrsq2Ic++wI1WckfUbGs6E1ZWc8O4Lq10GlOCrG6FGkUqduJRM45CWEshDKEEsSdj1bCD2cnRH4nPwYOH2FbuRCMAit4FwDYx2EUCi4wPaYIc8LZPkRx7KCULpvYIgDn5136PMbcvBQ2tAoxtUwtqZxvAPuH4vcaEhlSKhz3wtePvkgNjjc5zm5yY8luJCnUS8xiA2RBIPIpZgnf4n5byQ1QSjTC5jejTm5Gs684G/sjr7YrNMRWwAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/da808b7e57ba80c89a69c3514446dc3f/fcda8/1670584278312-fb44296e-16b6-410e-aa91-80d4a087d032.png\"\n        srcset=\"/static/da808b7e57ba80c89a69c3514446dc3f/12f09/1670584278312-fb44296e-16b6-410e-aa91-80d4a087d032.png 148w,\n/static/da808b7e57ba80c89a69c3514446dc3f/e4a3f/1670584278312-fb44296e-16b6-410e-aa91-80d4a087d032.png 295w,\n/static/da808b7e57ba80c89a69c3514446dc3f/fcda8/1670584278312-fb44296e-16b6-410e-aa91-80d4a087d032.png 590w,\n/static/da808b7e57ba80c89a69c3514446dc3f/efc66/1670584278312-fb44296e-16b6-410e-aa91-80d4a087d032.png 885w,\n/static/da808b7e57ba80c89a69c3514446dc3f/84bf8/1670584278312-fb44296e-16b6-410e-aa91-80d4a087d032.png 1162w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>自动生成的 backstage 镜像链接是： <a href=\"https://hub.docker.com/repository/docker/jefftian/backstage\">https://hub.docker.com/repository/docker/jefftian/backstage</a>，可以通过 docker pull jefftian/backstage下载到本地运行。\n<a name=LzbOl></a></p>\n<h1>总结</h1>\n<p>现在，你就有了自己的开发门户，Backstage！ 我的门户访问地址是：<a href=\"https://backstage-backstage-jeff-tian.cloud.okteto.net/\">https://backstage-backstage-jeff-tian.cloud.okteto.net/</a>  。欢迎来参观！</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/710e297472647b97f26ae79b969a5a9f/4bca9/1670586019499-a543ee01-c6b3-4ecf-98ef-9d37cac8cefa.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 54.05405405405405%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAACA0lEQVR42nWRS2sUQRSF++coYibdXdXvd/VMDwmTmcj4DARBRXeiBBRd6E/IJkImmoAorlz6d1wk4oOIC0FcfnJ77GEiuDjUrXPqnvsoq+w3pKZgXF7naXXITj7jyeiIneEBd/0X3OztsXV+j1vBPneKA7b1jMsX9pmcmzHtveSKOmQrfs2D6QduD99jrU8mmFGfG/k93tXHHFUfebN5wtutT+yvnbBbHDObfuXV9im7o288Dz7zePULO71T7q9856H+waP8J0+Gv3i2+RtrfW0NYypMUXOpucZkcJVhPiHRJYmuSLQhj2sSzxC5htRriNWAWDdEakDg1ES6ocynZPEIazweU9c1WZ5RmhwvVKw6K2jPbc85ejjKxnZ69BtDXibYzgpK2ziqx6p9kTQNiZMAa2Njg36/T5ZlRGFEkqSEYYTWHq7jopRuY600ylUMmyFVZXAct+V9z2/jNM1atIaCNE2xbRutNUopHMfBdd02Fggv97IsydKs1X3PI02TlhddOEvG7ToUosOyWQfpeDAYtKZS3PM8wjCYa647NxSxqqrWcFkQdJ0JJFnuUSS7iuZF/k7TvZHYEjNBURQYY0iSpBXEoDPyZFe+jx/45EVGGIUEQbDQ5ezyFx3meU4QhMRxTBiGi4pnRnbdhYGYL/PyB5J3ZuTlT5H4X8NuvP/xssM/bYaK4InScQcAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/710e297472647b97f26ae79b969a5a9f/fcda8/1670586019499-a543ee01-c6b3-4ecf-98ef-9d37cac8cefa.png\"\n        srcset=\"/static/710e297472647b97f26ae79b969a5a9f/12f09/1670586019499-a543ee01-c6b3-4ecf-98ef-9d37cac8cefa.png 148w,\n/static/710e297472647b97f26ae79b969a5a9f/e4a3f/1670586019499-a543ee01-c6b3-4ecf-98ef-9d37cac8cefa.png 295w,\n/static/710e297472647b97f26ae79b969a5a9f/fcda8/1670586019499-a543ee01-c6b3-4ecf-98ef-9d37cac8cefa.png 590w,\n/static/710e297472647b97f26ae79b969a5a9f/efc66/1670586019499-a543ee01-c6b3-4ecf-98ef-9d37cac8cefa.png 885w,\n/static/710e297472647b97f26ae79b969a5a9f/c83ae/1670586019499-a543ee01-c6b3-4ecf-98ef-9d37cac8cefa.png 1180w,\n/static/710e297472647b97f26ae79b969a5a9f/4bca9/1670586019499-a543ee01-c6b3-4ecf-98ef-9d37cac8cefa.png 3050w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}}}},"staticQueryHashes":[],"slicesMap":{}}