{"componentChunkName":"component---src-templates-post-js","path":"/posts/gghbmx","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/gghbmx","relativePath":"posts/gghbmx","frontmatter":{"title":"使用 Mocha 和 Chai 测试驱动开发 AWS Lambda API","stackbit_url_path":"posts/gghbmx","date":"2021-02-21T08:58:59","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p><a name=2YOxW></a></p>\n<h2>缘起</h2>\n<p>前几天学习了 AWS Lambda，非常棒。首先，未来的开发者都会是云原生的，就是说，他们所有的开发工作都会在云上进行，而 AWS Lambda 是云计算中的翘楚；其次，对于开发者和开源作者来说，由于不以盈利为目的，因此免费的基础设施和产品对他们的可持续输出非常重要，而 AWS Lambda 的免费额度远远超出大多数开发者的起步需求。<br /><img src=\"https://cdn.nlark.com/yuque/0/2021/png/221736/1613891220686-90971052-8b10-4927-b4d1-172a5f4b6f00.png#align=left&#x26;display=inline&#x26;height=706&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=1412&#x26;originWidth=2050&#x26;size=201141&#x26;status=done&#x26;style=none&#x26;width=1025\" alt=\"image.png\"><br />以上是我学完了 AWS 基础课后的证书，这个课程的主讲人是一名解决方案架构师，讲得相当好，让你对 AWS Lambda 会有一个基本和全面的认识。</p>\n<p>但是，对实际的开发工作可能没有太大帮助。你根据课程和 AWS Lambda 控制台的指引，可以很快搭建一个 Hello World 出来，但这只能算是 Playground，如果要真正进行工程实践，还需要本文这样的指南。AWS Lambda 支持的语言非常多，本文将对使用 NodeJs 进行 AWS Lambda 工程实战给出一个详尽的指导。除了 NodeJs，你可能还想有 C# 的 AWS Lambda 工程实战指南，Go 的 AWS Lambda 工程指南等等，如果哪天我学会了它们，再来分享。</p>\n<p>一个现代化的实战工程，应该是方便测试的、可以持续自动化部署的。测试驱动开发是一个不错的开发实践，本文分享如何将它应用在 AWS Lambda 开发上。</p>\n<p>首先，你需要学习一下 AWS Lambda 课程，链接在这里：<a href=\"https://www.aws.training/Details/eLearning?id=59558\">https://www.aws.training/Details/eLearning?id=59558</a></p>\n<p><a name=NjcYy></a></p>\n<h2>工具链</h2>\n<p>开发语言采用 TypeScript，测试框架采用 Mocha，断言库采用 Chai。jest 非常优秀，但是运行速度比 Mocha 慢太多，因此这里没有采用。但是 jest 的使用者众多，必须得提一下，而且从 Mocha 切换到 jest 并不需要做太多修改。</p>\n<p>Mocha 是一个在 NodeJs 上运行的 JavaScript 测试框架。Mocha 支持异步运行测试、测试覆盖报告，并且允许使用任何断言库。Chai 是一个 NodeJs 的 TDD/BDD 断言库，能够和任何 JavaScript 测试框架配合工作。</p>\n<p>Mocha 使用钩子来组织其测试结构，具体地说有这些钩子：</p>\n<ul>\n<li>describe(): 用来将测试分成一个一个的测试组并描述当前测试分组</li>\n<li>it(): 用来描述测试用例</li>\n<li>before(): 在第一个 it() 或者 describe() 之前运行</li>\n<li>beforeEach(): 在每一个 it() 或者 describe() 之前运行</li>\n<li>after(): 在所有 it() 或者 describe() 之后运行</li>\n<li>afterEach(): 在每一个 it() 或者 describe() 之后运行</li>\n</ul>\n<p><a name=FmeXI></a></p>\n<h2>测试驱动开发简介</h2>\n<p>简称 TDD，它有很多好处，比如由于测试先行，所有让我们专注在需求上，并且保证只会发布能够恰好通过所有测试的代码。</p>\n<p>TDD 的流程总体来说是一系列重复性的简单活动。首先，写一个注定失败的测试，因为这时还没有实现代码；然后，写能够通过测试的实现代码；一旦测试通过，就重构代码让它更简洁更易扩展。注意测试代码也是代码，所以测试代码本身也包括在重构的范围内。这个重复性的简单活动看起来是这样的：</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2021/png/221736/1613892537389-795c9813-61de-4ed7-8f94-e9b0a8cfbf93.png#align=left&#x26;display=inline&#x26;height=467&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=934&#x26;originWidth=1432&#x26;size=130428&#x26;status=done&#x26;style=none&#x26;width=716\" alt=\"image.png\"></p>\n<p><a name=o30UI></a></p>\n<h2>示例需求</h2>\n<p>构建一个无服务器的 Lambda API，它接受一个电话号码作为输入，并且返回这个电话号码的国别 —— 中国大陆、美国、或者不是一个电话号码。</p>\n<p><a name=ZL8Ku></a></p>\n<h2>安装开发依赖</h2>\n<p>进入你的项目目录并且执行：\nshell\nnpm install typescript -g\nnpm install chai mocha ts-node @types/chai @types/mocha --save-dev</p>\n<p><a name=ej9vu></a></p>\n<h2>写第一个测试</h2>\n<p>让我们以熟悉的 Hello World 开始。创建一个新文件，命名为 HelloWorldService.spec.ts（这个 sepc.ts 的后缀表明这是一个测试文件）。在这个 HelloWorldService.spec.ts  的顶部，加载 mocha 和 chai，然后就开始使用 Mocha 的钩子函数（describe 和 it）来定义一个简单的测试，这个测试期待 HelloWorldService 返回一个 “HelloWorld”字符串。</p>\n<p>typescript\nimport {expect} from chai\nimport mocha\nimport {HelloWorldService} from ./HelloWorldService</p>\n<p>describe(Hello World string function, () => {\nit(should return Hello World, () => {\nconst result = HelloWorldService()\nconst expectedResult = Hello World\nexpect(result).to.equal(expectedResult)\n})\n})</p>\n<p>测试写好了，我们来运行它。为了方便起见，我们在 package.json 中创建一个 NPM 脚本，这个脚本调用 mocha，并将测试文件所在的目录作为参数传给它。由于我们的代码是使用 TypeScript 写的，所以还需要将 ts-node 注册进入 mocha 才行。一旦这个脚本创建好，我们就可以从命令行终端运行测试了（注意 .spec.ts 后缀，这是我们表明测试文件的约定）：\njson\n...\nscripts: {\n...\ntest: mocha -r ts-node/register src/**/*.spec.ts\n...\n}\n...</p>\n<p>尝试执行测试会报错，因为 HelloWorldService.ts 还不存在，让我做个快速修复，创建这个文件，并且写一行代码实现 HelloWorldService：\ntypescript\nexport const HelloWorldService = () =></p>\n<p>再次在命令行输入 npm test 运行测试，得到：<br /><img src=\"https://cdn.nlark.com/yuque/0/2021/png/221736/1613893743041-8d0eac9c-8cca-481a-a49c-dc399b1714b7.png#align=left&#x26;display=inline&#x26;height=318&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=636&#x26;originWidth=1492&#x26;size=73737&#x26;status=done&#x26;style=none&#x26;width=746\" alt=\"image.png\"><br />测试能够运行，但是结果告诉我们 HelloWorldService 没有返回期待的结果，让我们修复它，改写 HelloWorldService.ts 文件：</p>\n<p>diff</p>\n<ul>\n<li>export const HelloWorldService = () =></li>\n</ul>\n<ul>\n<li>export const HelloWorldService = () => Hello World</li>\n</ul>\n<p>再次运行测试，得到：</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2021/png/221736/1613893989945-5e5300b7-3f06-43b8-95db-6c8ee123d44a.png#align=left&#x26;display=inline&#x26;height=100&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=200&#x26;originWidth=1162&#x26;size=16023&#x26;status=done&#x26;style=none&#x26;width=581\" alt=\"image.png\"><br />测试通过，由于代码很简单，还不需要重构，所以第一个 TDD 周期就完成了！</p>\n<p><a name=N7GNQ></a></p>\n<h2>测试电话号码服务算法</h2>\n<p>到目前位置，一个支持 TDD 和 TypeScript 的项目就搭建起来了，我们开始构建电话号码服务。为了简单起见，这个服务只用来判断一个电话号码是否是中国大陆电话号码。先写一个测试：\ntypescript\ndescribe(PhoneNumberService.determinePhoneNumberType_CN_MOBILE, () => {\nit(should return CN_MOBILE, () => {\nconst expectedResult = PhoneNumberType.CN_MOBILE;</p>\n<pre><code>const phoneNumbers = [+8617712345678, 17712345678]\n\nphoneNumbers.forEach(phoneNumber => {\n\tconst result = PhoneNumberService.determinPhoneNumberType(phoneNumber)\n  \n  expect(result).to.equal(expectedResult)\n})\n</code></pre>\n<p>})\n})</p>\n<p>运行测试，失败。让我们来写第一个实现，能够通过这个测试用例：\ntypescript\nimport {PhoneNumberType} from ./enums/PhoneNumberType\nconst CN_Mobile_Phone_Number_Regex = /^(+86)1d{10}$/</p>\n<p>export class PhoneNumberService {\npublic static determinerPhoneNumberType(phoneNumber: string): PhoneNumberType {\nreturn this.isCNMobile(phoneNumber) ? PhoneNumberType.CN_MOBILE : PhoneNumberType.INVALID\n}</p>\n<p>public static isCNMobile(phoneNumber: string): boolean {\nreturn CN_Mobile_Phone_Number_Regex.test(phoneNumber)\n}\n}</p>\n<p>重新运行测试，通过！下一步是添加一个让测试失败的测试用例，然后改进代码让它通过。直到所有的测试用例都通过为止。这里略过不再赘述。</p>\n<p><a name=peYSf></a></p>\n<h2>添加 AWS Lambda 事件处理器</h2>\n<p>首先添加 aws-lambda 依赖，这是 AWS Lambda 为 NodeJs 开发的 SDK。\nshell\nnpm install aws-lambda --save</p>\n<p>然后新建一个文件，代码如下：\ntypescript\nimport {Context, APIGatewayProxyEvent} from aws-lambda\nimport {PhoneNumberService} from ../services/PhoneNumberService;</p>\n<p>module.exports.handler = async (apiGatewayEvent: APIGatewayEvent, _context: Context) : Promise<any> => {\nif (!requestBody) {\nreturn new HttpResponse(HttpStatusCode.BAD_REQUEST);\n}</p>\n<p>const res = PhoneNumberService.determinePhoneNumberType(requestBody.phoneNumber)</p>\n<p>return new HttpResponse(HttpStatusCode.OK, res)\n}</p>\n<p><a name=5GXRO></a></p>\n<h2>配置 AWS Lambda 并本地运行验证</h2>\n<p>安装 AWS Lambda 提供的命令行工具 serverless：\nshell\nnpm i -g serverless</p>\n<p>配置：\nshell\nserverless config credentials --provider aws --key YOUR_ACCESS_KEY --secret YOUR_SECRET_ACCESS_KEY</p>\n<p>再在项目中创建一个 serverless.yml 文件：\nyaml\nservice: phone-number-api</p>\n<p>provider:\nname: aws\nruntime: nodejs12.x</p>\n<p>functions:\nphonenumber:\nhandler: index.handler\nname: serverless-phone-number</p>\n<p>在 package.json 文件里添加一个脚本命令：\njson\n{\n...\nscripts: {\n...\nlocal: tsc &#x26;&#x26; serverless invoke local --function phonenumber --data +8617712345678\n...\n}\n...\n}</p>\n<p>执行 npm run local 验证。</p>\n<p><a name=evbWU></a></p>\n<h2>配置部署脚本</h2>\n<p>在 package.json 中增加一个部署脚本：\njson\n{\n...\nscripts: {\n...\ndeploy: tsc &#x26;&#x26; serverless deploy\n...\n}\n...\n}</p>\n<p>要将我们写好的 AWS Lambda 部署上线，只需要运行 npm run deploy 。Serverless 会帮我们处理所有事情，包括创建 CloudFormation Stack，上传构建制品到 S3，以及创建我们的 Lambda。<br /><img src=\"https://cdn.nlark.com/yuque/0/2021/png/221736/1613896314613-1c39bb7e-1c34-431f-b31e-11075329afd0.png#align=left&#x26;display=inline&#x26;height=218&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=436&#x26;originWidth=1846&#x26;size=71142&#x26;status=done&#x26;style=none&#x26;width=923\" alt=\"image.png\"><br />要持续开发 Lambda，只需要更改代码，确保测试通过。然后运行相同的 npm run deploy 脚本就能够将更新的改动部署上线。</p>\n<p><a name=JMVYh></a></p>\n<h2>验证部署后的服务</h2>\n<p>你可以用 Postman 发起一个 POST 请求到我们运行  npm run deploy 后得到的分配好的终端节点：<br /><img src=\"https://cdn.nlark.com/yuque/0/2021/png/221736/1613896559115-849bf2c4-2ace-4b08-8f54-05221565809a.png#align=left&#x26;display=inline&#x26;height=226&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=452&#x26;originWidth=1600&#x26;size=248355&#x26;status=done&#x26;style=none&#x26;width=800\" alt=\"image.png\"><br />也可以配置一个命令行脚本到 package.json 文件中：\njson\n{\n...\nscripts: {\n...\nremote: serverless invoke --function phonenumber --data +8617712345678\n...\n}\n...\n}</p>\n<p>之后使用 npm run remote 即可。</p>\n<p><a name=JIf6N></a></p>\n<h2>总结</h2>\n<p>本文快速回顾了 TDD 的步骤，并给了一个将其应用于 AWS Lambda 开发的快速示例。欢迎参考该示例创建 AWS Lambda 的 TypeScript TDD 的开发项目模版。</p>\n<p><a name=sbUwi></a></p>\n<h2>彩蛋</h2>\n<p>AWS Lambda 在中国最大的竞争对手，应该是阿里云的函数计算。参考本文，做一些适当的修改，就可以写一个阿里云函数计算的 TypeScript TDD 开发项目模版，其实作者已经写了一个，欢迎自由取用：<a href=\"https://github.com/Jeff-Tian/ali-fc-typescript-skeleton\">https://github.com/Jeff-Tian/ali-fc-typescript-skeleton</a>。</p>\n<p>作者使用这个开发模版写了一个上传文件转码服务，用来将用户上传的 office 文档，转码成图片格式，并且添加水印，然后再在前端展示，既可以展示自己的原创内容，又能一定程度上防止抄袭。由于阿里云函数计算的免费额度也很大，所以运行至今一年多下来，给公司节省了很多钱。<br /><img src=\"https://cdn.nlark.com/yuque/0/2021/png/221736/1613897448584-49cd00e8-e0b8-42a5-9e66-908c49ad6670.png#align=left&#x26;display=inline&#x26;height=380&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=760&#x26;originWidth=1428&#x26;size=115035&#x26;status=done&#x26;style=none&#x26;width=714\" alt=\"image.png\"></p>\n<p>因此鼓励你更多地使用函数计算，这是趋势。</p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","description":"Full Stack Developer, good at OAuth 2.0","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"本站源码","url":"https://github.com/Jeff-Tian/space","style":"link","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}},"menus":{}}},"staticQueryHashes":[]}