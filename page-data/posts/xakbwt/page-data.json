{"componentChunkName":"component---src-templates-post-js","path":"/posts/xakbwt/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/xakbwt","relativePath":"posts/xakbwt","frontmatter":{"title":"使用 NestJs 开发 GraphQL API 的一些经验分享","stackbit_url_path":"posts/xakbwt","date":"2022-04-14T15:29:18","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p><a name=TMrvF></a></p>\n<h1>GraphQL</h1>\n<p>GraphQL 是一个开源的 API 数据查询操作语言，也是一个为实现查询已有数据的运行时。Facebook 内部在2012年开发了 GraphQL 并应用在了 Facebook App 上，在2015年公开发行。2018年11月7日，GraphQL 项目从 Facebook 移出到新成立的 GraphQL 基金会。<br />GraphQL 为 API 中的数据提供了完整的和可理解的描述，给予了客户端精确查询所需要数据的能力，不多不少。并且使得随时间演进 API 更简单，还提供了强大的开发工具。\n<a name=ktYnD></a></p>\n<h2>查询所需，精准获取</h2>\n<p>正如简介中提到的，GraphQL 为客户端提供查询和操作的服务。在 GraphQL 时代之前，restful 风格的 API 非常流行（其实现在仍然很流行）。但是，即使是为了同样的目的去获取一个数据，不同的客户端可能期待的数据略有不同。比如，同样是用户详情页面，移动端和桌面端的展示由于屏幕尺寸不同会略有区别。这时，restful API 要么提供两个不同的 API，要么在同一个 API 里返回两端都需要的数据。由于多数字段需求相同，因为更多地采用了后者。这让移动端得到的响应不必要地增加了，想像如果有多端，那么这个响应体会更加庞大！更糟糕的是，为了某一个端作的改动，会影响到其他所有端。<br />为了解决这些问题，BFF 架构被提出来了，该架构为每个端都提供了一个专门的后端。这虽然解决了部分问题，但是却带来了更多的问题，最主要的代码重复，以及需要更大的团队来维护这些 API。</p>\n<blockquote>\n<p>这里顺带一点个人片面的观点：thoughtworks 的大神 Martin Fowler 很推崇 BFF 架构，但是我曾经在一个公司里用过一年左右的时间，体验真的不好，虽然 thoughtworks 和 Martin Fowler 在业界里有很高的声誉，但是给我的真实感觉就像最近的上海防疫措施，解决方案比原来的问题更差。</p>\n</blockquote>\n<p>GraphQL 虽然也为所有客户端提供所需要的全部信息，但同时还提供了选择仅仅需要的数据的能力，而且不会返回任何更多的信息。由于所有的查询都是可预期的，所以使用了 GraphQL 的 App 往往更快和更稳定。\n<a name=ZFYn6></a></p>\n<h2>一次请求返回多个资源</h2>\n<p>一般消费 restful API 的应用在渲染页面时会发多个请求，这种网络来回非常耗时。为了解决这个问题，bulk API 方案可以在一个请求里组合多个请求。但是，这比较难以使用，因此现实中采用这种方案的应用十分少见。而且，也不那么灵活，更不好的是，一旦组合了多个 API，所有 API 的所有响应体都会塞在这个组合请求里，非常庞大。<br />GraphQL 也为应用端提供了在一个请求里查询所有数据的能力，但却是使用一种非常易于使用的查询语言。而且由于前一个特性提到的，它也不会增加额外的不必要的响应返回体。\n<a name=rW0HX></a></p>\n<h2>类型系统</h2>\n<p>由于 GraphQL 中有类型系统，就像第一个特性中提到的，所有查询都是可预期的。并且，这还可以省去客户端自己写解析代码的麻烦。\n<a name=yZdck></a></p>\n<h3>演进变得简单</h3>\n<p>不再需要版本化的 API，添加新字段和新类型不会给已有的查询造成任何影响。过时的字段和类型可以标记为废弃，并在一段时间后确定没有客户端使用的情况下安全删除。\n<a name=otDyR></a></p>\n<h1>使用 NestJs 开发 GraphQL</h1>\n<p><a name=anwZw></a></p>\n<h2>使用到的框架</h2>\n<p><a name=bC7p6></a></p>\n<h3>NestJs</h3>\n<p>NestJs 是一个构建高效、可伸缩的NodeJs服务器端应用的框架，使用 TypeScript 编写所以完全支持 TypeScript，当然也支持你使用 JavaScript 使用它。它还结合了面向对象、函数式以及函数响应式编程风格。它有效地解决了NodeJs应用的架构问题，像 Angular Js 一样，它内置了依赖注入机制，可以提高开发效率，能够创建快速、可测和扩展性好的应用。<br />对 GraphQL 开发，NestJs 提供了代码优先的开发方式，开发者可以使用 TypeScript 来定义 GraphQL 模式来避免语言之间的上下文切换。<br />在 NestJs 的世界里开发 GraphQL API，你会遇到Modules、Resolvers以及Services的概念，这和开发restful API很类似，你可以将 Resolvers 类比为 Controllers。\n<a name=ieaQg></a></p>\n<h3>Apollo Graph平台</h3>\n<p>Apollo Graph 平台统一了在不同应用和服务的 GraphQL，解锁了工程团队更快交付的能力。它提供了很多前后端库。比如可以使用它的 React 客户端来执行 GraphQL 操作，缓存结果，并管理应用状态。\n<a name=ASNT3></a></p>\n<h2>服务器端开发</h2>\n<p><a name=b6imZ></a></p>\n<h3>测试</h3>\n<p>当开始开发一个新的 feature 时，我们可以使用“按愿望思考”的方式，写下新的 API 应该长的样子和期待的响应结果。这其实就是一个端到端测试用例，以之前文章提到过的语雀服务为例：<br /><a href=\"https://zhuanlan.zhihu.com/p/415577362\">使用万能 BFF，将语雀文章 GraphQL 服务化</a><br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.24324324324324%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABdElEQVR42k2STW7cMAyFfZIAbSZji38iJdtJJp0WLdBFgaCLbrrovve/wQsk25MsPouWrMdnksM6P6GWilor5jrDi6O4oBjDsoOIbqR0xOnD/nvMzBjWGl0oosAjkMOhbrDIsKyIHMjZ4W5YakZE9O+s7znCK7JlWCjUBEPJGbkd1AozhWdBNoWqQIUhIhhFQSJQ3d4bvK89ZgbLxjC74Pu3BevLMy6XGdfHjGUOpBx4UEOo4KdMeG7iqjBtybb1iA/MDEPLdL0sKCW6bZu9u3zlB/zle/zhE77wBGPujg+3aeej08bQi6mKWBzmTTBjUcK/9AkXGhGUkJhxZsaJBT/ojCuNeKERX2mEHg05mtIexAQSQmqdnCZMifCZBOfEmIg6axrxP93hN526iO9wu9tquDM0m210lnlFidJHKNxRiiGqoeSAhONXEF7zlqgJpJ0utru7OSw+oy6PW3FFt3poY+uqimASxbmdHZdvv/k+g03wDbAnFDb2m8cKAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/d53afb64ab3ebdb863615ff5b403133e/fcda8/1649947552591-6e9054ce-8cd2-4442-9dd8-e93e1c74ce66.png\"\n        srcset=\"/static/d53afb64ab3ebdb863615ff5b403133e/12f09/1649947552591-6e9054ce-8cd2-4442-9dd8-e93e1c74ce66.png 148w,\n/static/d53afb64ab3ebdb863615ff5b403133e/e4a3f/1649947552591-6e9054ce-8cd2-4442-9dd8-e93e1c74ce66.png 295w,\n/static/d53afb64ab3ebdb863615ff5b403133e/fcda8/1649947552591-6e9054ce-8cd2-4442-9dd8-e93e1c74ce66.png 590w,\n/static/d53afb64ab3ebdb863615ff5b403133e/efc66/1649947552591-6e9054ce-8cd2-4442-9dd8-e93e1c74ce66.png 885w,\n/static/d53afb64ab3ebdb863615ff5b403133e/c83ae/1649947552591-6e9054ce-8cd2-4442-9dd8-e93e1c74ce66.png 1180w,\n/static/d53afb64ab3ebdb863615ff5b403133e/da952/1649947552591-6e9054ce-8cd2-4442-9dd8-e93e1c74ce66.png 1872w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span><br />以上只展示了 Happy Path，更多边角测试用例以及单元测试等，详见：<a href=\"https://github.com/Jeff-Tian/serverless-space\">https://github.com/Jeff-Tian/serverless-space</a>。\n<a name=dcsC2></a></p>\n<h3>Modules, Resolvers 以及 Services</h3>\n<p>要实现以上 API，需要先使用 ObjectType 定义模型。然后组装 Module, Resolver 和 Service，其中 Resolver 调用 Service 并返回模型。完整代码见 <a href=\"https://github.com/Jeff-Tian/serverless-space\">https://github.com/Jeff-Tian/serverless-space</a>，其结构如下：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 28.37837837837838%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABV0lEQVR42j2P23KiUBRE/ZR5mDFwgINwFC8gNw/IHTTRJCb//xtrCiszD6t6V3dVV+9FO12pmo441xR1i64aiqYj6SbKfkBXFft2IK8b2qGkGSfyqkY3HWV/ZXz7YHj7oL28PrNFWpTofuTcdBTniiTLyU6abZJjHVMOe0UYKo7H4OmVRUJXJ6RpRFy3ZF1PUrcEOmefHFm4h5R4vKMv72zSglWUo6KMeLujdx12a8HaX7JRFrYQWKaBLWZMxMtvDGOJaSwRwsA0DBa/3JB1VKK7G201cCo6ErXj4Ukenk20sYm2fwi3NsHugK8UjiOxbQdHus/bsqz/LKoiZroOvH5/8vi6c3vcGIcKnYS8rHdIRxIom2NgESgfz/PxViuklKxWHq50EfPyf4XZKePrfuP9MnKtNNO5YMxjdLjHUwFSOihloHwbYQpM00TM7wqB+aNz0awzfwG7zcs1nsciLwAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/97a684587b98b09a61630fdd38465373/fcda8/1649948955401-f003404b-548d-4680-afae-24cbcc4e6694.png\"\n        srcset=\"/static/97a684587b98b09a61630fdd38465373/12f09/1649948955401-f003404b-548d-4680-afae-24cbcc4e6694.png 148w,\n/static/97a684587b98b09a61630fdd38465373/e4a3f/1649948955401-f003404b-548d-4680-afae-24cbcc4e6694.png 295w,\n/static/97a684587b98b09a61630fdd38465373/fcda8/1649948955401-f003404b-548d-4680-afae-24cbcc4e6694.png 590w,\n/static/97a684587b98b09a61630fdd38465373/efc66/1649948955401-f003404b-548d-4680-afae-24cbcc4e6694.png 885w,\n/static/97a684587b98b09a61630fdd38465373/c83ae/1649948955401-f003404b-548d-4680-afae-24cbcc4e6694.png 1180w,\n/static/97a684587b98b09a61630fdd38465373/08c33/1649948955401-f003404b-548d-4680-afae-24cbcc4e6694.png 1570w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span><br />在 NestJs 中，Resolvers 和 Services 都是 Modules 的 Providers，区别是我们使用 Resolvers 做查询或者操作的路由，而使用 Services 写业务代码。\ntypescript\n...</p>\n<p>@Module({\nproviders: [YuqueResolver, YuqueService, ...],\n})\nexport class YuqueModule {}</p>\n<p><a name=A4F1e></a></p>\n<h2>客户端开发</h2>\n<p>使用 apollo-client我们就不用自己组装原始的 HTTP 请求了，只需要写 GraphQL 查询。首先，定义一个全局使用的 client，启用缓存和 APQ：\ntypescript\nimport {ApolloClient, ApolloLink, createHttpLink, InMemoryCache} from @apollo/client\nimport Taro from @tarojs/taro\nimport crypto from crypto</p>\n<p>import {createPersistedQueryLink} from @apollo/client/link/persisted-queries</p>\n<p>const graphQLServerUrl = <a href=\"https://sls.pa-ca.me/nest/graphql\">https://sls.pa-ca.me/nest/graphql</a></p>\n<p>const httpLink = createHttpLink({\nuri: graphQLServerUrl,\nasync fetch(url, options) {\nconsole.log(url = , url, options)\nconst res = await Taro.request({\nurl: url.toString(),\nmethod: (options?.method || POST) as POST | GET,\nheader: {\ncontent-type: application/json\n},\ndata: options?.body,\nsuccess: console.log\n})</p>\n<pre><code>return {text: async () => JSON.stringify(res.data)} as any\n</code></pre>\n<p>}\n})</p>\n<p>const queryLink = createPersistedQueryLink({\nuseGETForHashedQueries: true,\nsha256: async (document: string) => crypto.createHash(sha256).update(document).digest(hex)\n})</p>\n<p>export const client = new ApolloClient({\nlink: ApolloLink.from([queryLink, httpLink]),\ncache: new InMemoryCache()\n})</p>\n<p>然后，在真正查询的地方，使用 apollo 提供的 useQuery hook：\ntypescript\nimport {gql, useQuery} from @apollo/client</p>\n<p>const YUQUE_BLOG = gql\nquery {\nyuque (id: ${id}) {\nid\ntitle\ndescription\nword_count\ncreated_at\ncover\nbody\nbody_html\n}\n}</p>\n<p>const {loading, error, data} = useQuery(YUQUE_BLOG)</p>\n<p>完整代码见： <a href=\"https://github.com/Jeff-Tian/weapp\">https://github.com/Jeff-Tian/weapp</a>。</p>\n<p><a name=VLec4></a></p>\n<h2>文档</h2>\n<p>restful API一般需要使用 Swagger 等等单独发布文档站点，而 GraphQL 则是自文档化的。它的文档总是随代码同步更新的。</p>\n<p>比如，以上示例的 GraphQL 的 URL 端点是 <a href=\"https://sls.pa-ca.me/nest/graphql\">https://sls.pa-ca.me/nest/graphql</a>，那么在浏览器里访问这个地址就会打开一个文档页面，因为这是一个 HTTP GET 请求。而其数据查询和操作服务，都是以 HTTP POST 形式提供的。你可以在文档页面组装这些查询请求并实时查看结果，非常方便。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a13eac1ffa9ba62cac2f0acee7119574/d185f/1649950147854-a8d7bdab-b6f1-4531-a684-83e149c8b88f.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.70270270270271%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAACVElEQVR42m2RaU8TYRSFBxBLiy1Q7Eq36XSbQitbaS3QFSoQ/AkCMcqiibjEhPBFIiBgW4uWRQSDJMT4Lx+dGSA08cPJvLln7jPnzCt83Dlit3ZBpX7JXu2CrfIZGzvf2dj9wefyMdUvJ1RrZ3yrXlApn1Crn1Pd/0mleky9/ovDr6ecnv3h/PQ3tb1DhLfrRyy/qbD4qszSapmX7/ZZXTvg6co2CyufWFjeZn5pi7nnH3jybEM9a9pmbnGTedXf5MX7A9a2LhE67Ema26MIehnhbgihLYLROkxbZxyhLYygC6leszlFc9cIgi5Mk0GmSR9RpfkRWtp7uWOMITjELE5/Dr15EF1nP4buIaRoiUBsBpc8iShP4I/PEppaR86/5oGURh54TKBvGn+0hCtQQJQnkfqmcAXyCCbnKCZrQoW1muLq2Srm8EZK+OQSYqRIj5TD6UnhcCdxixk8oeIVLK95/pw6U8IJRtsI92wP0XUNIhjj6C0JwtI4gb4ZpN5pdUGRkkRZdEgF/NFp5IFZpN5H+CITiHIJb7iIzTuu/UNTzxiG7mFsHVHS9igFcQh3sIBTymP3jd/I5suoM1GeIhjToKG4Vl0Bq0ClYtCdpN/ZT9gsY7UM4ghNqHUdYganP4vdl9GgYgard+yqZvZGynvKTPEEhzdPyJOk25GixTyEwZLAE8yrNXzhIu5A7lbtPFaPAszezG5L8QSTdxKjPYWua4BWYwyjJdHw9WspC0oSDdgIuvbVhEZHmvuuNCZbUr1lBajc1v8WlKfVM9pQuQH4L+Ffd0tpMnDVGGYAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/a13eac1ffa9ba62cac2f0acee7119574/fcda8/1649950147854-a8d7bdab-b6f1-4531-a684-83e149c8b88f.png\"\n        srcset=\"/static/a13eac1ffa9ba62cac2f0acee7119574/12f09/1649950147854-a8d7bdab-b6f1-4531-a684-83e149c8b88f.png 148w,\n/static/a13eac1ffa9ba62cac2f0acee7119574/e4a3f/1649950147854-a8d7bdab-b6f1-4531-a684-83e149c8b88f.png 295w,\n/static/a13eac1ffa9ba62cac2f0acee7119574/fcda8/1649950147854-a8d7bdab-b6f1-4531-a684-83e149c8b88f.png 590w,\n/static/a13eac1ffa9ba62cac2f0acee7119574/efc66/1649950147854-a8d7bdab-b6f1-4531-a684-83e149c8b88f.png 885w,\n/static/a13eac1ffa9ba62cac2f0acee7119574/c83ae/1649950147854-a8d7bdab-b6f1-4531-a684-83e149c8b88f.png 1180w,\n/static/a13eac1ffa9ba62cac2f0acee7119574/d185f/1649950147854-a8d7bdab-b6f1-4531-a684-83e149c8b88f.png 2686w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}},"menus":{}}},"staticQueryHashes":[],"slicesMap":{}}