{"componentChunkName":"component---src-templates-post-js","path":"/posts/xiqfs7b68wtxfult/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/xiqfs7b68wtxfult","relativePath":"posts/xiqfs7b68wtxfult","frontmatter":{"title":"将免费架构进行到底，使用 AWS SAM 将 Koa 服务从 Cyclic 迁移到 Lambda","stackbit_url_path":"posts/xiqfs7b68wtxfult","date":"2024-01-20T14:47:26","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p>早在 2021 年，我提出免费架构（Free Arch），即尽量使用免费资源来构建应用和服务，并且要在多处部署，参考《<a href=\"%5Bhttps://zhuanlan.zhihu.com/p/580160351%5D(https://zhuanlan.zhihu.com/p/580160351)\">Free Arch: 狡兔三窟，多处部署 - Jeff Tian的文章 - 知乎</a> 》。</p>\n<p>另外，见《<a href=\"%5Bhttps://zhuanlan.zhihu.com/p/674125115%5D(https://zhuanlan.zhihu.com/p/674125115)\">欢迎来调戏我：在公众号里对接 AWS Bedrock 服务 - Jeff Tian的文章 - 知乎</a> 》，我将一个微信智能助理部署到了 Okteto，好景不长，Okteto 于 2024 年 1 月 15 日开始停止了免费服务。于是在《<a href=\"%5Bhttps://zhuanlan.zhihu.com/p/678780266%5D(https://zhuanlan.zhihu.com/p/678780266)\">调用 AWS Bedrock 服务，为微信公众号消息提供自动回复功能。 - Jeff Tian的文章 - 知乎</a> 》中我提到，我又将该智能助理部署到了 <a href=\"%5Bhttps://app.cyclic.sh/#/join/Jeff-Tian%5D(https://app.cyclic.sh/#/join/Jeff-Tian)\">Cyclic</a> 平台。</p>\n<p>然而，没想到该文引来巨大的流量，很快就将我在 <a href=\"%5Bhttps://app.cyclic.sh/#/join/Jeff-Tian%5D(https://app.cyclic.sh/#/join/Jeff-Tian)\">Cyclic</a> 平台上的免费额度花光了。<br />![因为加了张红包封面，导致流量暴增](<a href=\"https://cdn.nlark.com/yuque/0/2024/png/221736/1705742773139-a6a135d1-7386-4e73-aba5-b28af10c936c.png#averageHue=%23fdfdfc&#x26;clientId=uf17942a5-e6c2-4&#x26;from=paste&#x26;height=319&#x26;id=u062a8a5c&#x26;originHeight=638&#x26;originWidth=2242&#x26;originalType=binary%E2%88%B6=2&#x26;rotation=0&#x26;showTitle=true&#x26;size=241742&#x26;status=done&#x26;style=none&#x26;taskId=u58d40974-fde6-4fa7-a0c4-4cfee11b5c1&#x26;title=%E5%9B%A0%E4%B8%BA%E5%8A%A0%E4%BA%86%E5%BC%A0%E7%BA%A2%E5%8C%85%E5%B0%81%E9%9D%A2%EF%BC%8C%E5%AF%BC%E8%87%B4%E6%B5%81%E9%87%8F%E6%9A%B4%E5%A2%9E&#x26;width=1121\">https://cdn.nlark.com/yuque/0/2024/png/221736/1705742773139-a6a135d1-7386-4e73-aba5-b28af10c936c.png#averageHue=%23fdfdfc&#x26;clientId=uf17942a5-e6c2-4&#x26;from=paste&#x26;height=319&#x26;id=u062a8a5c&#x26;originHeight=638&#x26;originWidth=2242&#x26;originalType=binary∶=2&#x26;rotation=0&#x26;showTitle=true&#x26;size=241742&#x26;status=done&#x26;style=none&#x26;taskId=u58d40974-fde6-4fa7-a0c4-4cfee11b5c1&#x26;title=%E5%9B%A0%E4%B8%BA%E5%8A%A0%E4%BA%86%E5%BC%A0%E7%BA%A2%E5%8C%85%E5%B0%81%E9%9D%A2%EF%BC%8C%E5%AF%BC%E8%87%B4%E6%B5%81%E9%87%8F%E6%9A%B4%E5%A2%9E&#x26;width=1121</a> 因为加了张红包封面，导致流量暴增)</p>\n<p>![公众号收到一大波调戏，不过大多都是索要红包封面而已](<a href=\"https://cdn.nlark.com/yuque/0/2024/png/221736/1705742887505-a1f0f5ba-53e4-43b4-a01c-7a3850d68d0a.png#averageHue=%23dfc56b&#x26;clientId=uf17942a5-e6c2-4&#x26;from=paste&#x26;height=696&#x26;id=u29a6264e&#x26;originHeight=1392&#x26;originWidth=2900&#x26;originalType=binary%E2%88%B6=2&#x26;rotation=0&#x26;showTitle=true&#x26;size=475094&#x26;status=done&#x26;style=none&#x26;taskId=u6849f8c3-b34b-4095-9a79-76a914da632&#x26;title=%E5%85%AC%E4%BC%97%E5%8F%B7%E6%94%B6%E5%88%B0%E4%B8%80%E5%A4%A7%E6%B3%A2%E8%B0%83%E6%88%8F%EF%BC%8C%E4%B8%8D%E8%BF%87%E5%A4%A7%E5%A4%9A%E9%83%BD%E6%98%AF%E7%B4%A2%E8%A6%81%E7%BA%A2%E5%8C%85%E5%B0%81%E9%9D%A2%E8%80%8C%E5%B7%B2&#x26;width=1450\">https://cdn.nlark.com/yuque/0/2024/png/221736/1705742887505-a1f0f5ba-53e4-43b4-a01c-7a3850d68d0a.png#averageHue=%23dfc56b&#x26;clientId=uf17942a5-e6c2-4&#x26;from=paste&#x26;height=696&#x26;id=u29a6264e&#x26;originHeight=1392&#x26;originWidth=2900&#x26;originalType=binary∶=2&#x26;rotation=0&#x26;showTitle=true&#x26;size=475094&#x26;status=done&#x26;style=none&#x26;taskId=u6849f8c3-b34b-4095-9a79-76a914da632&#x26;title=%E5%85%AC%E4%BC%97%E5%8F%B7%E6%94%B6%E5%88%B0%E4%B8%80%E5%A4%A7%E6%B3%A2%E8%B0%83%E6%88%8F%EF%BC%8C%E4%B8%8D%E8%BF%87%E5%A4%A7%E5%A4%9A%E9%83%BD%E6%98%AF%E7%B4%A2%E8%A6%81%E7%BA%A2%E5%8C%85%E5%B0%81%E9%9D%A2%E8%80%8C%E5%B7%B2&#x26;width=1450</a> 公众号收到一大波调戏，不过大多都是索要红包封面而已)</p>\n<p>![很快收到了 Cyclic 平台的服务中止邮件](<a href=\"https://cdn.nlark.com/yuque/0/2024/png/221736/1705742954841-c361d074-7592-4cb9-a414-6c210944cad8.png#averageHue=%23f4ecea&#x26;clientId=uf17942a5-e6c2-4&#x26;from=paste&#x26;height=933&#x26;id=u1b105900&#x26;originHeight=1866&#x26;originWidth=1530&#x26;originalType=binary%E2%88%B6=2&#x26;rotation=0&#x26;showTitle=true&#x26;size=316969&#x26;status=done&#x26;style=none&#x26;taskId=ud87a805f-fd80-4cb9-8b12-1920fcdb00c&#x26;title=%E5%BE%88%E5%BF%AB%E6%94%B6%E5%88%B0%E4%BA%86%20Cyclic%20%E5%B9%B3%E5%8F%B0%E7%9A%84%E6%9C%8D%E5%8A%A1%E4%B8%AD%E6%AD%A2%E9%82%AE%E4%BB%B6&#x26;width=765\">https://cdn.nlark.com/yuque/0/2024/png/221736/1705742954841-c361d074-7592-4cb9-a414-6c210944cad8.png#averageHue=%23f4ecea&#x26;clientId=uf17942a5-e6c2-4&#x26;from=paste&#x26;height=933&#x26;id=u1b105900&#x26;originHeight=1866&#x26;originWidth=1530&#x26;originalType=binary∶=2&#x26;rotation=0&#x26;showTitle=true&#x26;size=316969&#x26;status=done&#x26;style=none&#x26;taskId=ud87a805f-fd80-4cb9-8b12-1920fcdb00c&#x26;title=%E5%BE%88%E5%BF%AB%E6%94%B6%E5%88%B0%E4%BA%86%20Cyclic%20%E5%B9%B3%E5%8F%B0%E7%9A%84%E6%9C%8D%E5%8A%A1%E4%B8%AD%E6%AD%A2%E9%82%AE%E4%BB%B6&#x26;width=765</a> 很快收到了 Cyclic 平台的服务中止邮件)</p>\n<p>于是今天再来折腾，将它部署到 AWS Lambda 上。</p>\n<p>AWS Lambda，我已经在自己的万能 BFF （详见《<a href=\"%5Bhttps://zhuanlan.zhihu.com/p/646372965%5D(https://zhuanlan.zhihu.com/p/646372965)\">基于 AWS 构建 BFF 的架构说明 - Jeff Tian的文章 - 知乎</a> 》）中使用了很多年了，至今仍然免费，看来还是 AWS 大方！不过，万能 BFF 使用的是 Serverless 框架，但我这次想玩点新鲜的，于是决定试用一下 AWS SAM 来进行部署。</p>\n<p><a name=Xk8RC></a></p>\n<h1>什么是 SAM</h1>\n<p>SAM 是 Serverless Application Model 的缩写，我感觉是 serverless 框架的竞争对手，它们的很多理念都相似，也都可以通过 yaml 文件来描述函数。\n<a name=r6K0O></a></p>\n<h1>怎么做</h1>\n<p>以下几个提交描述了接下来要概述的步骤，但是到了代码级别，非常详细，分别是：</p>\n<ul>\n<li><a href=\"https://github.com/Jeff-Tian/bedrock/commit/38676d1fb1f24a306318a66abd4c6f0201a1aa0a\">https://github.com/Jeff-Tian/bedrock/commit/38676d1fb1f24a306318a66abd4c6f0201a1aa0a</a></li>\n<li><a href=\"https://github.com/Jeff-Tian/bedrock/commit/d291625ce850f2f32b7064bd6d042ab16f8ddcba\">https://github.com/Jeff-Tian/bedrock/commit/d291625ce850f2f32b7064bd6d042ab16f8ddcba</a></li>\n</ul>\n<p><a name=e8Tpw></a></p>\n<h2>代码重构</h2>\n<p>看过上一篇文章，已经知道我们写了一个 Koa 应用，命名为 app.js。现在，将它最后一行：app.listen(8080) 删除，并新建一个 server.js，引用 app.js，并将 app.listen(8080) 写在这个新的文件里。它是服务器化的启动方式，我们即将新增无服务器化的启动方式，但是同时我们保证不破坏已有的服务器启动方式。这时，再顺便将 yarn start命令从 node app.js改成 node server.js。\n<a name=ShbAu></a></p>\n<h1>安装 serverless-http</h1>\n<p>yaml\nyarn add serverless-http</p>\n<p>即可。\n<a name=yNo9g></a></p>\n<h1>无服务器化</h1>\n<p>新增文件 serverless.js，并引用 app.js，以及增加 handler函数。这一步我们应该很熟悉，之前在万能 BFF 里也写同样的函数，即无服务器化的主入口是 handler 函数。\nyaml\nconst ServerlessHttp = require(serverless-http);\nconst app = require(./app);</p>\n<p>module.exports.handler = ServerlessHttp(app);</p>\n<p><a name=v5kqJ></a></p>\n<h1>增加 SAM 描述文件</h1>\n<p>在新增文件夹 sam里添加 template.yaml文件，这有点类似万能 BFF 里的 serverless.yaml，但是细节有一些区别，这个文件如下：\nyaml\nAWSTemplateFormatVersion: 2010-09-09\nTransform: AWS::Serverless-2016-10-31\nResources:\nEasySchoolBackendFunction:\nType: AWS::Serverless::Function\nProperties:\nCodeUri: ./dist.zip\nHandler: dist/serverless/serverless.handler\nRuntime: nodejs18.x\nTimeout: 900\nPackageType: Zip\nEnvironment:\nVariables:\nAWSAccessKeyId: !Ref AWSAccessKeyId\nAWSSecretAccessKey: !Ref AWSSecretAccessKey\nCYCLIC_DB: outstanding-necklace-frogCyclicDB\nCYCLIC_APP_ID: outstanding-necklace-frog\nCYCLIC_URL: <a href=\"https://outstanding-necklace-frog.cyclic.app\">https://outstanding-necklace-frog.cyclic.app</a>\nCYCLIC_BUCKET_NAME: cyclic-outstanding-necklace-frog-eu-north-1\nEvents:\nApiEvent:\nType: Api\nProperties:\nPath: /{any+}\nMethod: ANY</p>\n<p>注意，需要加密存储的值放在 GitHub Actions 里的秘密值里，在这里使用 !Ref引用。\n<a name=KEDx4></a></p>\n<h1>从本地部署到 AWS Lambda</h1>\n<p>先在本地执行 yarn deploy，它其实是 yarn zip&#x26;&#x26;cd sam&#x26;&#x26;sam build&#x26;&#x26;AWS_PROFILE=lambda-doc-rotary sam deploy --guided 的组合，通过它，会生成一个元数据文件 samconfig.toml如下：\ntoml\nversion = 0.1\n[default.deploy.parameters]\nstack_name = sam-app\nresolve_s3 = true\ns3_prefix = sam-app\nregion = us-east-1\nconfirm_changeset = false\ncapabilities = CAPABILITY_IAM\nimage_repositories = []</p>\n<p><a name=sAyFI></a></p>\n<h1>从 GitHub Actions 运行 CICD</h1>\n<p>新增一个 workflow，如下：\nyaml</p>\n<h1>This workflow will run tests using node and then publish a package to GitHub Packages when a release is created</h1>\n<h1>For more information see: <a href=\"https://docs.github.com/en/actions/publishing-packages/publishing-nodejs-packages\">https://docs.github.com/en/actions/publishing-packages/publishing-nodejs-packages</a></h1>\n<p>name: Node.js Package</p>\n<p>on:\npush:\nbranches:\n- main\njobs:\ndeploy:\nruns-on: ubuntu-latest\nsteps:\n- uses: actions/checkout@v3\n- uses: actions/setup-node@v3\nwith:\nnode-version: 18\n- run: npm i -g yarn\n- run: yarn &#x26;&#x26; yarn ci\n- run: yarn zip\n- uses: aws-actions/setup-sam@v2\n- uses: aws-actions/configure-aws-credentials@v1\nwith:\naws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}\naws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}\naws-region: us-east-1\n- run: |\ncd sam\nsam build --use-container\n# Prevent prompts and failure when the stack is unchanged\n- run: |\ncd sam\nsam deploy --no-confirm-changeset --no-fail-on-empty-changeset --parameter-overrides AWSAccessKeyId=${{ secrets.AWS_ACCESS_KEY }} AWSSecretAccessKey=${{ secrets.AWS_SECRET_KEY }}</p>\n<p><a name=gsPEk></a></p>\n<h1>最终效果</h1>\n<p>提交代码，等待新的 GitHub Actions 执行，执行完成后，可以从 AWS 控制台看到新的 Cloud Formation：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0422547e5006349eb203c07518bd5556/a22ca/1705750606705-7d7e5829-2f27-45dd-a7d4-a9288cbf2920.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.35135135135135%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAACHUlEQVR42kWSTW/TQBCGI34E0EohTdPEsffL9q7Xn3GclIZSEELlgBCcOXBCcAAJ/gwIDiCO/L8HeYvg8GpnR6t3Zp7ZSbU5UO2uyKst2jiEyhAiQ6oMrTMyW5HVe7QfMOWAqfYovyWrz6nvP6HdP2Z4+Azz4BXR/gWTqr1ge3iK8z3L559Zf/hF/PYr8ftv3H7zBXl4Sb05R9oW5Vqk65G2Q7kenXeYog856weKcsck9S3KbxCx5M71R+59+s3Zh58cvfvBrdffmW2uSXVKbAqkKRDaofMSX/e4akO92ZH7hqLuUXnJxHfnpM2OWDlm84jZSjJdxMyXgtnJklWs8c2AtA06r1BZGU5j66C87MJdmIJYWSZ50aJST6JvDG25Qec185UKpotIoV3LfKm4txDM/mqMp6cJ85Umko5E/zVMXROCYLiIEWnJOm+QecP0JOJsNLQ1yyQl1gWRtCwiTawdS5GGfGJ8yCWqYNKfX9IOF8F0drpmPo67UkRJFjpey4zd4VHglRVNGN/kNcpZTGkRqQu4QlPKMbHhYRtgTxcJx6JiYXuOEs/dhWEVG9rtxT9mRb0lcw2yaFB1h3T1DSZb34w8Ah0DoS3TM8mx6ZHDJWK44tS0RLFhuH9F7rtQuOr2WN8hig7he4RtSF39fylj1ZHfqJPTNcJYqu2WZtghjGMZG7rhwMg6LRr6/QNcNf5Fh/YekRb/djAa/gGI2EIZxMT+5wAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/0422547e5006349eb203c07518bd5556/fcda8/1705750606705-7d7e5829-2f27-45dd-a7d4-a9288cbf2920.png\"\n        srcset=\"/static/0422547e5006349eb203c07518bd5556/12f09/1705750606705-7d7e5829-2f27-45dd-a7d4-a9288cbf2920.png 148w,\n/static/0422547e5006349eb203c07518bd5556/e4a3f/1705750606705-7d7e5829-2f27-45dd-a7d4-a9288cbf2920.png 295w,\n/static/0422547e5006349eb203c07518bd5556/fcda8/1705750606705-7d7e5829-2f27-45dd-a7d4-a9288cbf2920.png 590w,\n/static/0422547e5006349eb203c07518bd5556/efc66/1705750606705-7d7e5829-2f27-45dd-a7d4-a9288cbf2920.png 885w,\n/static/0422547e5006349eb203c07518bd5556/c83ae/1705750606705-7d7e5829-2f27-45dd-a7d4-a9288cbf2920.png 1180w,\n/static/0422547e5006349eb203c07518bd5556/a22ca/1705750606705-7d7e5829-2f27-45dd-a7d4-a9288cbf2920.png 2958w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><br />并能从 AWS Lambda 控制台看到新创建出来的函数：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cc823db441e7d1ea3dbedc89d0ebf26c/6c837/1705750666677-c48a2648-fd59-4b4e-b53a-75573bea83ec.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.64864864864865%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB2ElEQVR42mWR226VQBSGeQVb20RNbDdn2MMAAwPMhg20u9o2VWO8MPFGr+r7v8FnZlq11osvP6zDPzNrecu7D3RmoVY9leoo645ade67VprO7FHDQmMW1LDSmJWq2zNe3bHefGY53HL95TvJ3T3++x94kVpI9SWJWojVSiAnwsIQVhNRYUibhaDaE0jDxmo9cyYNYbkQl3vi5oKwXkmKHVU7450EkqBZeSNHXhUjr/OeF0HNcVBzFCqOrD5y/ESPw5rTRHOatJwkLS/Diigr8cJU0k4H/LxmE27xY0GQFPhx8Uefs4kEcV7T7VaHVAPJtubMz/DO9UL89Z5mmMllQ1JoRy5bsqL5T7elduSPMYv9j7OSTZjjBYlkqwyibImE5nqQfLudGC/vXGEq/jb+pjWzy9lbWexBUSoJowLPjzJSUZIKRSIahq7jsK7008E9xTbaBoutsYbjcsUwXdAOM/24os3icu6GadZh+k/IpkeUHbLdUerJGYiqQ1TaFVtzOy97gB6t2Z5ajzT9nqrduYU4w6KY+XjzEzNfIO3TnUn3MKcnz7Qxa2q1HBZyZciEInWz1MR59WD41o8QqnEBP9q6zQZ208+w23f5WBAm4p+6MCk4DzJn+AsvYTbcHSczxAAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/cc823db441e7d1ea3dbedc89d0ebf26c/fcda8/1705750666677-c48a2648-fd59-4b4e-b53a-75573bea83ec.png\"\n        srcset=\"/static/cc823db441e7d1ea3dbedc89d0ebf26c/12f09/1705750666677-c48a2648-fd59-4b4e-b53a-75573bea83ec.png 148w,\n/static/cc823db441e7d1ea3dbedc89d0ebf26c/e4a3f/1705750666677-c48a2648-fd59-4b4e-b53a-75573bea83ec.png 295w,\n/static/cc823db441e7d1ea3dbedc89d0ebf26c/fcda8/1705750666677-c48a2648-fd59-4b4e-b53a-75573bea83ec.png 590w,\n/static/cc823db441e7d1ea3dbedc89d0ebf26c/efc66/1705750666677-c48a2648-fd59-4b4e-b53a-75573bea83ec.png 885w,\n/static/cc823db441e7d1ea3dbedc89d0ebf26c/c83ae/1705750666677-c48a2648-fd59-4b4e-b53a-75573bea83ec.png 1180w,\n/static/cc823db441e7d1ea3dbedc89d0ebf26c/6c837/1705750666677-c48a2648-fd59-4b4e-b53a-75573bea83ec.png 2962w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><br />其触发器 API Gateway 详情如下：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c61b529bfc53dd39ec2b2330d351ccdf/78302/1705750715728-4559210a-a31b-45cf-8778-13943a015e81.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 26.351351351351354%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAABBklEQVR42lXQb0vDMBDH8b4JYVvXNk2a9E/S1qV20+Ec6nAgqI8E34yv/SsJQ/TBBw7ufgd3yTqvqIwjKzSi6mj6iVJbMmFYrRWr7L80U+RlTS7qOBOEWmkbe4l2E87vuVrkhOW7wxOq9+TKIiqH0EH/qzQDbX9D4yZMt8FYT+08890RqS2JbEa0nVikkkUqsMMe75/R7RgDOvQvqnpAmT4GpXHIUJueUrsoK2uSsuqorY/nLbOc+90nX6/fnN/e2b58sDme8YcTm8OJYf+Iuz3itg/Y4QY7zlE3zrjrLco4Eqkd3TCzTCXLtKSQDUK1tL2nqCyFdhcWYRzC9PENYe6vkAkv+wEZbZOn/8GHJgAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/c61b529bfc53dd39ec2b2330d351ccdf/fcda8/1705750715728-4559210a-a31b-45cf-8778-13943a015e81.png\"\n        srcset=\"/static/c61b529bfc53dd39ec2b2330d351ccdf/12f09/1705750715728-4559210a-a31b-45cf-8778-13943a015e81.png 148w,\n/static/c61b529bfc53dd39ec2b2330d351ccdf/e4a3f/1705750715728-4559210a-a31b-45cf-8778-13943a015e81.png 295w,\n/static/c61b529bfc53dd39ec2b2330d351ccdf/fcda8/1705750715728-4559210a-a31b-45cf-8778-13943a015e81.png 590w,\n/static/c61b529bfc53dd39ec2b2330d351ccdf/efc66/1705750715728-4559210a-a31b-45cf-8778-13943a015e81.png 885w,\n/static/c61b529bfc53dd39ec2b2330d351ccdf/c83ae/1705750715728-4559210a-a31b-45cf-8778-13943a015e81.png 1180w,\n/static/c61b529bfc53dd39ec2b2330d351ccdf/78302/1705750715728-4559210a-a31b-45cf-8778-13943a015e81.png 2798w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><br />简单做个测试，得到结果符合预期：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cc24bf8a91eb590923ac5d3a8b604e49/412e0/1705752263774-c5481dd9-01d8-4c51-852c-f8732948462f.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 41.891891891891895%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABmklEQVR42m3Q227TQBDGcb9CmyooqSCt49jetdden8924oaEHiQEEhe8/4P8UTYFJMTFaL6di9+sxqqGE/X+hbSaUElNoCuCqDQ51KWZJ92JuNoTVQeCYsJLWrLhTH14o9m/MD7/IDz+RE7fseruSDe/oss9MqoRcU1ez7hhjiMyuqalH/eIqELomjAfkEmD1B1Kt+hyRGU9KiqRqsTKm5EkbxAqxXYDXBERZzWe1Gx2MafO5XWOeAxr/KTGDnK2YXEtde27qORRaLZugJWWHXHWIKMCx1M8yJyoPWPrDluVrIKG7fQNMbxhV19YxQcWsudWdKz1gbvgkns++BW2I7Hy7vAO5ga0XYUfFfiqwA8S1l7KWs8sg4Ebr+FO9ixEZ+qaWwMu/RJnF2BV/YxKqj+g44UEcWHeMky493OWauLWbw146b/zjd+y8P+C2wvYjk/mh0JlBtx6yoDCgClrL2NTnAmnr+zaF5zmmYfixL0+sAzH64J30N5JrHqYSYr2v6AIEwOu9Ixdntnkn/mYPvEpO17vd7nlP+Avlnj4SwjMxToAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/cc24bf8a91eb590923ac5d3a8b604e49/fcda8/1705752263774-c5481dd9-01d8-4c51-852c-f8732948462f.png\"\n        srcset=\"/static/cc24bf8a91eb590923ac5d3a8b604e49/12f09/1705752263774-c5481dd9-01d8-4c51-852c-f8732948462f.png 148w,\n/static/cc24bf8a91eb590923ac5d3a8b604e49/e4a3f/1705752263774-c5481dd9-01d8-4c51-852c-f8732948462f.png 295w,\n/static/cc24bf8a91eb590923ac5d3a8b604e49/fcda8/1705752263774-c5481dd9-01d8-4c51-852c-f8732948462f.png 590w,\n/static/cc24bf8a91eb590923ac5d3a8b604e49/efc66/1705752263774-c5481dd9-01d8-4c51-852c-f8732948462f.png 885w,\n/static/cc24bf8a91eb590923ac5d3a8b604e49/c83ae/1705752263774-c5481dd9-01d8-4c51-852c-f8732948462f.png 1180w,\n/static/cc24bf8a91eb590923ac5d3a8b604e49/412e0/1705752263774-c5481dd9-01d8-4c51-852c-f8732948462f.png 2990w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><br />在 postman 中测试也通过：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/823dfc2a44a072529147833a962f31e8/b5c21/1705761372413-a1d8a53e-241a-48db-b9bd-f2d8c11877d8.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABbElEQVR42n1SiW3DMAzUjJ2sM3SVbpEEyB80tix/eq3nCtJ2mhZtCRxEUdTpSEq4MGEYBmitMY7jAxTr+x4pJTxbSQklTiil8FnbtrDOoR8tBm0hjO5hrWGCpmkYqm05UTUNk67kxhgmiSnxOk0RyAGbu8fLW4/XdwPhvUOYArz3DOsdnDWguLUWzs2rsQ4pZ1b2DLKUCz6GhMZkiDBNXGJd16xOSsn+0HUwWrMqrUdoG5B/kH2RlrUhEDFndF2H0+mE/X6Pw+HAPqkly4uqnBP7v4FKJ2FUgaBX6fL5fMZ2u8Vms8Fut2PSlfxyubBPOB6PHFvPq6piQdQWeljEmHhDwVrKeShKPUqXS2zdE+5VhVouZ6qBd25ROkEoKTEO4zyA4HkINMGSM34aXaKyUklIJTNiniceQkCMEYL+H30RUtEq9U1h1yoeGOVQ8n+29lqQDrpEPbxer4zb7ca9IVJ6jMjKHxN+/j5E+Am6NANQUUUb/gAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/823dfc2a44a072529147833a962f31e8/fcda8/1705761372413-a1d8a53e-241a-48db-b9bd-f2d8c11877d8.png\"\n        srcset=\"/static/823dfc2a44a072529147833a962f31e8/12f09/1705761372413-a1d8a53e-241a-48db-b9bd-f2d8c11877d8.png 148w,\n/static/823dfc2a44a072529147833a962f31e8/e4a3f/1705761372413-a1d8a53e-241a-48db-b9bd-f2d8c11877d8.png 295w,\n/static/823dfc2a44a072529147833a962f31e8/fcda8/1705761372413-a1d8a53e-241a-48db-b9bd-f2d8c11877d8.png 590w,\n/static/823dfc2a44a072529147833a962f31e8/efc66/1705761372413-a1d8a53e-241a-48db-b9bd-f2d8c11877d8.png 885w,\n/static/823dfc2a44a072529147833a962f31e8/c83ae/1705761372413-a1d8a53e-241a-48db-b9bd-f2d8c11877d8.png 1180w,\n/static/823dfc2a44a072529147833a962f31e8/b5c21/1705761372413-a1d8a53e-241a-48db-b9bd-f2d8c11877d8.png 2154w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><a name=aDC5K></a></p>\n<h1>难点</h1>\n<p>因为 cyclic 对 AWS dynamodb sdk 进行了二次封装，使用了自己的模型，即所谓的单表缓存，极大地简化了对 Dynamodb 的调用。但是，如果要在自己的 AWS 账号里，也能正常使用 cyclic 的 dynamodb 封装，那就要反向推测出其 dynamodb 的模式，这有点困难，好在有一篇文档：<a href=\"https://docs.cyclic.sh/concepts/database\">https://docs.cyclic.sh/concepts/database</a> 。简单介绍了其结构：</p>\n<table>\n<thead>\n<tr>\n<th>IndexName</th>\n<th>Partition Key</th>\n<th>Range Key</th>\n<th>Projected Fields</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>primary</td>\n<td>pk</td>\n<td>sk</td>\n<td>all</td>\n</tr>\n<tr>\n<td>keys_gsi</td>\n<td>keys_gsi</td>\n<td>keys_gsi_sk</td>\n<td>pk,sk, gsi_prj</td>\n</tr>\n<tr>\n<td>gsi_prj</td>\n<td>gsi_prj</td>\n<td>-</td>\n<td>prj</td>\n</tr>\n</tbody>\n</table>\n<p>然后，通过 GPT-4 Turbo，终于推断出了一个 SAM template：\nyaml\nChatsTable:\nType: AWS::DynamoDB::Table\nProperties:\nTableName: outstanding-necklace-frogCyclicDB\nAttributeDefinitions:\n- AttributeName: pk\nAttributeType: S\n- AttributeName: sk\nAttributeType: S\n- AttributeName: keys_gsi\nAttributeType: S\n- AttributeName: keys_gsi_sk\nAttributeType: S\n- AttributeName: gsi_prj\nAttributeType: S\nKeySchema:\n- AttributeName: pk\nKeyType: HASH\n- AttributeName: sk\nKeyType: RANGE\nGlobalSecondaryIndexes:\n- IndexName: keys_gsi\nKeySchema:\n- AttributeName: keys_gsi\nKeyType: HASH\n- AttributeName: keys_gsi_sk\nKeyType: RANGE\nProjection:\nProjectionType: ALL # 或者指定具体的属性\n- IndexName: gsi_prj\nKeySchema:\n- AttributeName: gsi_prj\nKeyType: HASH\nProjection:\nProjectionType: ALL # 或者指定具体的属性\nBillingMode: PAY_PER_REQUEST</p>\n<p>这一步，花了我好多时间！</p>\n<p><a name=trGWE></a></p>\n<h1>总结</h1>\n<p>Cyclic 是一个非常好的平台，的确为我们做了很多事情，从而简化了对 AWS 的使用。也就是说 Cyclic 是一个很好的服务者，但是使用它的服务，超过一定限度，就需要收费了。这非常合情合理，如果不想付费，而额度又超过了它的免费计划，就需要自己和 AWS 打交道了。<br />也就是说，一切技术或者 IT 本质上也是一种服务。要么付费买人家的服务，要么自己去做所有的脏活累活。<br />另外，如果有能力自己做这些脏活累活，别人又有需求，完全可以打包成产品卖出去。<br />事实上，我已经发现很多所谓的产品，都是这样的。同时也越来越感觉到 AWS 的了不起，不知道多少公司和产品，都是依托 AWS，来为别人提供服务的呢！</p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}},"menus":{}}},"staticQueryHashes":[],"slicesMap":{}}