{"componentChunkName":"component---src-templates-post-js","path":"/posts/bldo7l3n1hf5h4ux/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/bldo7l3n1hf5h4ux","relativePath":"posts/bldo7l3n1hf5h4ux","frontmatter":{"title":"往 Keycloak 里批量添加用户","stackbit_url_path":"posts/bldo7l3n1hf5h4ux","date":"2022-12-01T02:46:37","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p><a name=eKBIE></a></p>\n<h1>前情提要</h1>\n<p>接上一篇《 <a href=\"https://zhuanlan.zhihu.com/p/587831808\">使用 Keycloak 接管 SpringBoot 应用的用户认证功能 - Jeff Tian的文章 - 知乎</a> 》。使用 Keycloak 接管 SpringBoot 应用的用户认证功能，通过手动迁移一个用户，并重点详述了登录验证的接口改造，验证了端到端的可行性。现在，来优化第一步，<strong>批量迁移用户</strong>。</p>\n<p>可能有多种方案，这里详细列举两种简单可行的，其他方案比较复杂，比如需要停机，以及写复杂的命令行脚本。一种是利用 Keycloak 的导入功能，一种是通过编程调用 Keycloak 的接口方式。\n<a name=byLui></a></p>\n<h1>（推荐！）方案一： partialImport</h1>\n<p>首先，使用一个 Keycloak 实例，导出一个 json 文件，比如我用我的线上 Keycloak 实例（目前是 16.1.1 版本）： keycloak.jiwai.win，点击导出：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/183e0ab0138425f1095deca7acb2a578/09e48/1669861086910-2c833fd1-023c-4964-8d3e-362b4ef81883.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 82.43243243243244%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAACIklEQVR42p2TzWoTURiGp6u6DVm10k5+mpj56/yd+WsyjU2w6Mob8AZcuhHcVTFtkyaT2NIouBKXIulNiBfgHYigEBKlsW3UmXllzhQpJoU2Hzx8HPjOw/udYZh3vSO87x3h5es3aLS72GkeoO4dora3j61aC0+3W9iqNeO+HZ+f11/QmV3vkPaLMAuZHJYzWSQSCczP3wAzNweGYZBMJiGJInieg8Dz4Dkuho87dwmMbpUQwa0SiKoJxSwilRPQOegiqtPTM/i+j6sWo9slGGtlKMYaFa7qNpazBdSbbTrw59cYg8EQ/X4fo9EIP09OMBwOEYYhgiCYgBEUA4azDmK74GWC6LzArsDzOhj+Br78OAPCAMejEcbjMSUSRxVJ/4eRNAu2W6HCgqTRlItsHl6nhQ+Dz/j09XjqatHlqStHAset0LUjuaAQsGkRTxqP8Q0f6ZAf+hNJLiacEEYruxubkIkNXtHBpiQ83H2AMb4j9KOLwVTJtJRUqFklWMXb9P0E2cBS9haevX0Up/ODqUku/coycaCfv1+EIFlg5TS6vUYsDPwry6hQUA0Qx4WoGuDkWJgtsWi9as4m5CUCu1SBrDvIcyoVZ4pLqDe985WvKdSqZZTv3YHuOpBMAlI1kdHy2GvuzyYk99dhbxZBqha0DQPmXQvpvIBWe0YhrygoqAo4VaWIOsEiu/Lv17u2kJMICpIeI+oQFRM3Uzk0ZhT+BfVfy63GzC1AAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/183e0ab0138425f1095deca7acb2a578/fcda8/1669861086910-2c833fd1-023c-4964-8d3e-362b4ef81883.png\"\n        srcset=\"/static/183e0ab0138425f1095deca7acb2a578/12f09/1669861086910-2c833fd1-023c-4964-8d3e-362b4ef81883.png 148w,\n/static/183e0ab0138425f1095deca7acb2a578/e4a3f/1669861086910-2c833fd1-023c-4964-8d3e-362b4ef81883.png 295w,\n/static/183e0ab0138425f1095deca7acb2a578/fcda8/1669861086910-2c833fd1-023c-4964-8d3e-362b4ef81883.png 590w,\n/static/183e0ab0138425f1095deca7acb2a578/efc66/1669861086910-2c833fd1-023c-4964-8d3e-362b4ef81883.png 885w,\n/static/183e0ab0138425f1095deca7acb2a578/09e48/1669861086910-2c833fd1-023c-4964-8d3e-362b4ef81883.png 974w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>这样，得到了一个 JSON 文件。打开它，然后，在最后一个 }前加入用户信息。比如：</p>\n<p>json\n{\n...\nusers: [\n{\nusername: user,\nenabled: true,\ncredentials: [\n{\ntype: password,\nvalue: password\n}\n]\n}\n]\n...\n}</p>\n<p>当然，你可以使用程序，创建多个用户的 JSON 数组，添加到导出的 JSON 文件，然后保存。接着，在目标 Keycloak 中，选择导入（我这里用了 19.0.1 版本）：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/76cdb1ef88d07d57e852ab21dfd52a59/7ebf9/1669861565985-6c918a6f-93df-46d9-be36-a4b2d9e77eee.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 49.32432432432432%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB9UlEQVR42oWP3U+SYRjG36XWpiP5Ch2DbEI2qa1CXLP1Z7SZigWr4AW0FyJbucnHgQ7+Hzu0g9YWB8C/wBmGTg1Qxtfrz72Pg6LVvLffruu5D677eiQ5FObVa5mlVT8vvD6eL3oFmr+KJU1XfCwuvWTV6yXk8yNJksSf2G027s3cxel04HBM4/wHvf20w8Gsy8VDt4v7j2bxLMwhTUxaMZotjI7dZNb1gN3dL+ztfSWXy1EoFMjn8+TzBfLC/9Zisci37z/YTGzz/rPCxqcNPm5+QLplmcBktjA0fB3P/BNqtRpHR0d02m3+N+q52vc72zv43/iQ1wJEFBnJYDQxrjcyPHID99w85XKZSqXC8fGJCNYO1Ov1S63V+VU74aC6z2Ftn2q1SiaTISSHWF9bR3mnaA0n0RtM/cC2aHZOp9Om2+2gqt2/6NDqNmirDZrNpggMh8PEYjGUqII0Pm5EpzNwbWiEx24Pp/U6Z2dnqKrKVaMdyGaz/cBoNIo0NXMbu8OOTq9n4ekzSqUSPw8OOW00RQONVqs1QLN1uWs0GoMNFQXJeseKdcqK3mDEZp8iGouRSCRJJpNsbW0JTafTglQq1fc94vG4CNLaiUCTyYLZPMHomA6D0czy8oq4GAwGkWWZSCQi0HZvAwGhvXc4EhkI0758Ada1A1Cc98b3AAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/76cdb1ef88d07d57e852ab21dfd52a59/fcda8/1669861565985-6c918a6f-93df-46d9-be36-a4b2d9e77eee.png\"\n        srcset=\"/static/76cdb1ef88d07d57e852ab21dfd52a59/12f09/1669861565985-6c918a6f-93df-46d9-be36-a4b2d9e77eee.png 148w,\n/static/76cdb1ef88d07d57e852ab21dfd52a59/e4a3f/1669861565985-6c918a6f-93df-46d9-be36-a4b2d9e77eee.png 295w,\n/static/76cdb1ef88d07d57e852ab21dfd52a59/fcda8/1669861565985-6c918a6f-93df-46d9-be36-a4b2d9e77eee.png 590w,\n/static/76cdb1ef88d07d57e852ab21dfd52a59/efc66/1669861565985-6c918a6f-93df-46d9-be36-a4b2d9e77eee.png 885w,\n/static/76cdb1ef88d07d57e852ab21dfd52a59/c83ae/1669861565985-6c918a6f-93df-46d9-be36-a4b2d9e77eee.png 1180w,\n/static/76cdb1ef88d07d57e852ab21dfd52a59/7ebf9/1669861565985-6c918a6f-93df-46d9-be36-a4b2d9e77eee.png 1919w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>当选择好刚刚保存的 JSON 文件后，就能在预览框里看到内容了（同时你还可以编辑它，比如删除不想导入的信息等）。在导入前，勾上用户（Keycloak 会贴心地显示出一共会导入多少个用户），然后，选择遇到冲突时跳过的选项，就可以点击“导入”按钮了：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4ac4d7d724fb98e0cd681335854e765f/10b63/1669861830739-795b424f-ecca-4606-97cd-1823a0054d9c.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 49.32432432432432%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAACLUlEQVR42n2R204TURiFR+QYQSon0SpyYfSCAbHoo5hoQkUSLVTOXEhqAhENvgC3XNBA4gt45T0PAHTGNMKFwrSUdgrT0s50Th+ZgTRqjH+ysnZ2sr+svX5h/O0EI6/HeTE8SvjVG97FlogtLrO4vPJ/fVhh6eNnItFpnj0PMxwOMz46iiAIAldqarwDwWCQ3d0ddra32dv7QTqlkFIOSfmuXPjlnXJ4gKrmmJycpPdeD6Io8jgUQui+FaS9o4vGpmYGQ0/IZDLkVBXTsLFNB7Ni+apUKpcyMQzDlzfxzS9EJ6aJxd6zsLCA4MHa2juprWtA7H9EOpMhm81xoCVJl/c41bMUdQ3dKFdBhqGj6zrgsra2xsuRET/p1NTUBTBwo53a+kZEcQBVK1IoFDjKKliugYOF7Zq4rgOu67snx7H9hOvr60QiEebm5piZmUHo7Or2gXX1jfT195PJp1C1LIWSRrlSQjfP/Meu4+I4TlW2fQGMx+OMjY0xPz/P7OwsQmugjeutAa7WNtA3IPIrl+ZITZMvHHNaylM0TtDdMxw/IVXwv4B+Qm8pN7tv09ISYHBoCPXkkFxeQTk+IF/Mki/mULVjymaRkq1h2SaO7WBZVvXLfwDv9PRyt6eXa82tDD0NsbW/z8+Chut1h4nzm8Dh79nY2PA7rAI7Orvweqyrb+LBw/t8in9l89sWsiyxm0ggyRLyd9n3REJCkiRkWfY9mUyyurpKNBqtLuUcblRL19NhOP8AAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/4ac4d7d724fb98e0cd681335854e765f/fcda8/1669861830739-795b424f-ecca-4606-97cd-1823a0054d9c.png\"\n        srcset=\"/static/4ac4d7d724fb98e0cd681335854e765f/12f09/1669861830739-795b424f-ecca-4606-97cd-1823a0054d9c.png 148w,\n/static/4ac4d7d724fb98e0cd681335854e765f/e4a3f/1669861830739-795b424f-ecca-4606-97cd-1823a0054d9c.png 295w,\n/static/4ac4d7d724fb98e0cd681335854e765f/fcda8/1669861830739-795b424f-ecca-4606-97cd-1823a0054d9c.png 590w,\n/static/4ac4d7d724fb98e0cd681335854e765f/efc66/1669861830739-795b424f-ecca-4606-97cd-1823a0054d9c.png 885w,\n/static/4ac4d7d724fb98e0cd681335854e765f/c83ae/1669861830739-795b424f-ecca-4606-97cd-1823a0054d9c.png 1180w,\n/static/4ac4d7d724fb98e0cd681335854e765f/10b63/1669861830739-795b424f-ecca-4606-97cd-1823a0054d9c.png 1897w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>导入成功后，Keycloak 会再次显示，一共添加了多少个用户到系统里：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e7e576554693451382d0161d08ef7969/6fa81/1669861983893-8a0cb7bd-1289-4de2-90e8-4ec2c8a41d53.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.94594594594595%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB4UlEQVR42o2RzWoTURiGj0ubJu1kMkmTVKoXIDW1iwraRKW1lraJRCqIFeoqGkLa3XgDXoO74B24U5Em2E5KW0VFpFegSDFCfmemSWYeyQmm1pUfPLznvIvnO3DEg7U1Vu8/JJVeZeXOXeYWlrgxd5tbiyssLCZlnpCU3R963eJyiqVkmuVkinvpNEIIgRBn6KdgcvIi8/M3SVyfJZ64dpr4CbPxqyQScWZmrjAVu8RULMbl6WlEaCyCGgjh9SmEwhHKH7b51fgpcejQpT0AnAEuXXpT2jZ4ksuj60/RdR0R0IKogSBDHi+qpvHufYlKs8L3yjeOakenqJpVGnadulWjZlYxafDm7WvW1x+RzWbJ5XIIxR/AN6LgGfahqCqfv36Smx3Xkem6Lv+O4zh02h15LpaKZDIZNjc3yefzCC04huJX8Xh8qFqA/Y97tLsdTNPEto+xLBvbsmk1W1imhdnq967j/iV8LIUbGxuIkVE/Xt8oZ4eGGVH8fDk8ALo07TpWpyUx2015bx33aVg1mnYNlw5bxa3BC6UwOj5BJHoORQ1y4fwEr3YP+WHy31Mul08Lx8JRwpFxFL9GNBJGf/acFy+32ds12NkxKBtljAGGTNntGOzvH1AoFOSH9GQ94W+dV+sMayULPAAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/e7e576554693451382d0161d08ef7969/fcda8/1669861983893-8a0cb7bd-1289-4de2-90e8-4ec2c8a41d53.png\"\n        srcset=\"/static/e7e576554693451382d0161d08ef7969/12f09/1669861983893-8a0cb7bd-1289-4de2-90e8-4ec2c8a41d53.png 148w,\n/static/e7e576554693451382d0161d08ef7969/e4a3f/1669861983893-8a0cb7bd-1289-4de2-90e8-4ec2c8a41d53.png 295w,\n/static/e7e576554693451382d0161d08ef7969/fcda8/1669861983893-8a0cb7bd-1289-4de2-90e8-4ec2c8a41d53.png 590w,\n/static/e7e576554693451382d0161d08ef7969/efc66/1669861983893-8a0cb7bd-1289-4de2-90e8-4ec2c8a41d53.png 885w,\n/static/e7e576554693451382d0161d08ef7969/c83ae/1669861983893-8a0cb7bd-1289-4de2-90e8-4ec2c8a41d53.png 1180w,\n/static/e7e576554693451382d0161d08ef7969/6fa81/1669861983893-8a0cb7bd-1289-4de2-90e8-4ec2c8a41d53.png 1856w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>关闭弹窗，再去用户面板，就可以看见导入的用户了：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/29e438735e153b48b6ec3f5406314729/9c1e6/1669862068219-1040695f-a14f-4f85-81f8-012214f58f7c.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 41.21621621621622%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABmElEQVR42qWQzWoTURTHZ1s3UrAZUqRES2Jj0rSNUhtQcFMUx5gGW0EoLgSxuHDZudO6SP1AfA1fwTdw73MIRjSTmblz596Z+UlmqhQEN1748b/n3HPu+bCeHxzw7MVL9p885dHjfQbDPe46A5wHQ+71/8Y5y2lMf2eX+4OH7Ax3sSp2leriRSoVm7m5c/R6PYR7WOAJF08IRKEl5Zv7B3cW5wmOPMGr42Os9e4mK80OjeYq9uISo5O3/M+xrrbWaXe61C43OD+/gCuOyIFv338yHo/xfZ8o1oRSY4z5J2maYjl7Dtv9O9zcvkWrs8G79x+KSipWpMYQyZiPn8d8+vIDyMnzspPfWt5Lo/jwxu0eG1vXWdvssnSpzuj1G0xq8IPpLB0pIyZBhNQGbTTTwCfNTEEQTkm0IsszpJRFl9Zq5xr1K21qtQbzCzbi5JAoT/DVhARJOPmKMj4aSZyGhNpHZSFxFhLpaeGLswBl4tkAWM32Go2VFsv1JhfsKt7IK0dOJTpT6Cw+VYXOFSZPCj1LksWkebnDX/JQ5YFaREdiAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/29e438735e153b48b6ec3f5406314729/fcda8/1669862068219-1040695f-a14f-4f85-81f8-012214f58f7c.png\"\n        srcset=\"/static/29e438735e153b48b6ec3f5406314729/12f09/1669862068219-1040695f-a14f-4f85-81f8-012214f58f7c.png 148w,\n/static/29e438735e153b48b6ec3f5406314729/e4a3f/1669862068219-1040695f-a14f-4f85-81f8-012214f58f7c.png 295w,\n/static/29e438735e153b48b6ec3f5406314729/fcda8/1669862068219-1040695f-a14f-4f85-81f8-012214f58f7c.png 590w,\n/static/29e438735e153b48b6ec3f5406314729/efc66/1669862068219-1040695f-a14f-4f85-81f8-012214f58f7c.png 885w,\n/static/29e438735e153b48b6ec3f5406314729/c83ae/1669862068219-1040695f-a14f-4f85-81f8-012214f58f7c.png 1180w,\n/static/29e438735e153b48b6ec3f5406314729/9c1e6/1669862068219-1040695f-a14f-4f85-81f8-012214f58f7c.png 1734w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>这里演示只导入了一个用户，如果要导入多个用户，准备好一个用户 JSON 数组就好了。这一步，当然是可以用程序生成了，只要格式符合上面的例子就行了。\n<a name=k50Ff></a></p>\n<h1>方案二：调用 Keycloak 创建用户接口来创建用户</h1>\n<p>Keycloak 的创建用户接口，一次可以创建一个，但是既然是编程调用，自然一个循环就可以搞定多个用户的批量创建了。以 Java 代码为例，可以这样调用创建用户接口（以我的线上 Keycloak 实例为目标）：</p>\n<p>java\npublic String createUser(UserPayload user) throws IOException {\nvar url = <a href=\"https://keycloak.jiwai.win/auth/admin/realms/UniHeart/users\">https://keycloak.jiwai.win/auth/admin/realms/UniHeart/users</a>;\nvar payload = java.lang.String.format({firstName:Sergey,lastName:Kargopolov, email:%s, enabled:true, username:%s, credentials:[{type:password,value:%s,temporary:false}]}, user.getEmail(), user.getUsername(), user.getPassword());\nreturn this.jsonRequest(url, payload).toString();\n}</p>\n<p>上面的代码，在真正执行前，需要先获取到管理员的访问令牌，这可以通过调用 Keycloak 的 master 域的管理员登录接口来完成：</p>\n<p>java\npublic KeycloakAccessTokenPayload getAdminAccessToken() throws IOException {\nvar username = System.getenv(KC_ADMIN);\nvar password = System.getenv(KC_PASSWORD);</p>\n<pre><code>System.out.println(java.lang.String.format(username = %s; password = %s, username, password));\n\nvar mediaType = MediaType.parse(application/x-www-form-urlencoded);\nvar body = RequestBody.create(mediaType, java.lang.String.format(username=%s&#x26;password=%s&#x26;grant_type=password&#x26;client_id=admin-cli, username, password));\nvar request = new Request.Builder()\n        .url(https://keycloak.jiwai.win/auth/realms/master/protocol/openid-connect/token)\n        .method(POST, body)\n        .addHeader(Content-Type, application/x-www-form-urlencoded)\n        .build();\nvar response = client.newCall(request).execute();\n\nvar s = Objects.requireNonNull(response.body()).string();\n\nSystem.out.println(java.lang.String.format(token response = %s, s));\n\nreturn JsonHelper.parseFrom(s);\n</code></pre>\n<p>}</p>\n<p>获取到管理员的访问令牌后，需要在后续的接口请求中，将其添加到 http header 中去：</p>\n<p>java\npublic Response jsonRequest(String url, String payload) throws IOException {\nvar mediaType = MediaType.parse(application/json);\nvar body = RequestBody.create(mediaType, payload);\nvar request = new Request.Builder().url(url).method(POST, body).addHeader(Content-Type, application/json).addHeader(Authorization, java.lang.String.format(Bearer %s, getAdminAccessToken().access_token)).build();\nvar res = client.newCall(request).execute();</p>\n<pre><code>System.out.println(java.lang.String.format(jsonRequest response = %s, res.toString()));\n\nreturn res;\n</code></pre>\n<p>}</p>\n<p>这就是创建用户的核心代码了，完整的可运行代码，详见： <a href=\"https://github.com/Jeff-Tian/keycloak-springboot/blob/main/src/main/java/com/example/keycloakspringboot/KeycloakHelper.java#L29\">https://github.com/Jeff-Tian/keycloak-springboot/blob/main/src/main/java/com/example/keycloakspringboot/KeycloakHelper.java#L29</a>。</p>\n<p><a name=c8TYQ></a></p>\n<h1>总结</h1>\n<p>有两种简单直接的方式来将旧系统中的用户迁移到 Keycloak 里，一是手工导入、二是编程调用接口创建。从少写代码的角度来看，推荐使用第一种手工导入方式。</p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}}}},"staticQueryHashes":[],"slicesMap":{}}