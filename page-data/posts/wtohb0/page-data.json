{"componentChunkName":"component---src-templates-post-js","path":"/posts/wtohb0/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/wtohb0","relativePath":"posts/wtohb0","frontmatter":{"title":"Free Arch: 狡兔三窟，多处部署","stackbit_url_path":"posts/wtohb0","date":"2022-11-03T09:59:04","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p>刚刚写了一篇《<a href=\"https://zhuanlan.zhihu.com/p/580043578\">Free Arch: 个人开发者也能做到支付闭环 - Jeff Tian的文章 - 知乎</a>》，提到了其中的 Demo，也是一个老项目的复活，这里详解一下复活步骤。\n<a name=lc5nq></a></p>\n<h1>OAM</h1>\n<p>首先，要再提一下《<a href=\"https://zhuanlan.zhihu.com/p/571009896\">Free Arch: 使用 OAM 摆脱厂商锁定 - Jeff Tian的文章 - 知乎</a>》，它利用开放应用模型，将老项目 uni-orders 复活，并分别部署到了 Okteto 和 Napptive。参考它，我又将老项目 v 复活，依葫芦画瓢，将它也部署到了 Okteto 和 Napptive：</p>\n<p><a name=Q8bvN></a></p>\n<h2>v 的 GitHub Actions</h2>\n<p><a href=\"https://github.com/Jeff-Tian/v/actions\">https://github.com/Jeff-Tian/v/actions</a></p>\n<p>做得还不完美。</p>\n<p>测试其实通过了，但是由于使用了 killall node 的方式结束测试进程，导致显示是失败的。而对于 napptive，问题尝试先部署，再更新。如果已经是已部署状态（未被强行休眠），部署显示失败。但整体其实是成功的。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.64864864864865%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABiklEQVR42nWS646bMBCFzc3GYK6FhBACSSBXUtJIaaXV7vu/1lmNIW3aZn8czcGjGQ/fmAVpgfBJKp4hiHMEyfwvUe4RH/6V2LJuse56VJsDyrrDrNohXhwQZyXq9qSLs6LGujtrn84qRFk5Nfi/MQvTOdJ8CRXnkME3+FEOGZJP4UeZjh6dhxmkSuFOkl+IUaN0toTpeGAGBzMFmMnBLHfyL0S5r/IWVzAsCYv7sIUCfVtCwbAlmC1hcl9fRtGaRDnT9mA6Y248Vzoy7kdoLj3q7QlF1aJYtdr7tBiV4Hq64jjcse9vWKw6rLYnjSCtKhxvd5yHn2i6M8p6p2sZgV7vLxo2MSBWxE74MWyuwEUAxw3hyBCOO3o9lVAQXgROkn/ybL5o8HZ/x3D/QP/jF5qux/YwIC8aiCDG5vIdu/NNT0F/sGz2cP3kifczPwGWZCV2hwHt8aqfz2pz1MU0seFI+Emu36Y3bZm2rllZrmb5r5gtghG6M0J+gNdbp03SJA/RFAb/3exV00+DoeyJBpu68wAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/699477d9389c20235adf0a8effb23c28/fcda8/1667468448924-857cb574-c7db-4486-bbe8-afd624328e19.png\"\n        srcset=\"/static/699477d9389c20235adf0a8effb23c28/12f09/1667468448924-857cb574-c7db-4486-bbe8-afd624328e19.png 148w,\n/static/699477d9389c20235adf0a8effb23c28/e4a3f/1667468448924-857cb574-c7db-4486-bbe8-afd624328e19.png 295w,\n/static/699477d9389c20235adf0a8effb23c28/fcda8/1667468448924-857cb574-c7db-4486-bbe8-afd624328e19.png 590w,\n/static/699477d9389c20235adf0a8effb23c28/efc66/1667468448924-857cb574-c7db-4486-bbe8-afd624328e19.png 885w,\n/static/699477d9389c20235adf0a8effb23c28/c83ae/1667468448924-857cb574-c7db-4486-bbe8-afd624328e19.png 1180w,\n/static/699477d9389c20235adf0a8effb23c28/2ba99/1667468448924-857cb574-c7db-4486-bbe8-afd624328e19.png 1221w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n<a name=O2ijJ></a></p>\n<h2>Okteto 上的 v</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/52015163a0785217972dd8781a53f393/00d43/1667458423676-b4fa7237-e994-4195-81dd-c27160929ebd.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 65.54054054054055%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAACs0lEQVR42pWR3W/bVBiHLW5gGm2TNk3qOI597Ng+cezEbpPYST+mrirZLjoNaUNFGtxwgcSQpo1mWb9WNGk3SFzwZ8JGYU1aevdAXHUSggs40qPfx3t0jo6Owr+s8eSct6envHn7Kz//8obT337nbDzmj8tLJufnnI0nXFxecn5xkfl3Z2e8G48ZTyYoz0eHfPP4CU+e7nFw9D0HR694Njzku+Ehe6Mjhi9eMto/4enePs/3XzI6OMl0+OI4m135K302PEBRPrjBZ7uP8IMYRfkIwwqpN3vYcoWlikN+0SBX0KnJmIWSYL5osqhaGYUlkTH1uUIVr9FGKRQrHJ+8YnD3HrO5JbZ3HrL76Ct27u+yNbiHDNq4/grHJ6/pr2/TSTfpb3ySkfS3SFa3st5rrPDDjz+h5BZUbnw4w82beUplQTVo40cpohZSrkoqZh1d+GiGzHTKtLvur/NUp/uVfL5ELu4wZ9gsqQLLjdFFiHCj7Nk1uZJ1lreMcOOMa2/UIkQtyubCveqUvGqQ277DXNymUDJJNncYHb8m3dyhv3WfW4MH2EGKWe8ipvhdDNlBxht01+8i1+5gNFLsehe73kHJWx4zjs+M5aFVXVbDNp/eHrDWStiIeqy3Ujpek7Yb0s70imnXlS269SjLNaeF6S6j5HNFTN2mUNSR8wVWw5hvv35M4PgIzcSuWFia+TdE2UAKl0gGODJE6oK4XEEVPspsrpj98trtAdbHs/SCiC8+/5JQRjS8Fg23iVWxEJp4j6mZ1AyHphfgeAGeLliuVClbIYqqmSS9jewms2KRuCGBZtF1QxIvzHLqNf/BdNZxAhInoOc1qctlqk6EMl8os7CoMb+gUtJdzEaKaCQY9e5/pio72H5CWXdR5vIl0v4tTMujqFo4jQRbtv83NT9B/evAPwGZv8dIE/cX5wAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/52015163a0785217972dd8781a53f393/fcda8/1667458423676-b4fa7237-e994-4195-81dd-c27160929ebd.png\"\n        srcset=\"/static/52015163a0785217972dd8781a53f393/12f09/1667458423676-b4fa7237-e994-4195-81dd-c27160929ebd.png 148w,\n/static/52015163a0785217972dd8781a53f393/e4a3f/1667458423676-b4fa7237-e994-4195-81dd-c27160929ebd.png 295w,\n/static/52015163a0785217972dd8781a53f393/fcda8/1667458423676-b4fa7237-e994-4195-81dd-c27160929ebd.png 590w,\n/static/52015163a0785217972dd8781a53f393/efc66/1667458423676-b4fa7237-e994-4195-81dd-c27160929ebd.png 885w,\n/static/52015163a0785217972dd8781a53f393/00d43/1667458423676-b4fa7237-e994-4195-81dd-c27160929ebd.png 1000w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><a name=Xs6GW></a></p>\n<h2>Napptive 上的 v</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/aae41fdf8b2756cc3327504c8f247d5c/c8252/1667458469529-3616b715-baa2-407b-bcc6-a20883a6a548.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.16216216216216%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABvklEQVR42m3Ky04TYQCG4Vm6IoYCU+ckaEspVOn0PCS089Nzh9JJD5MwloAa1CYuFIN2BqomKguMN+E1uSFczGvSxLBx8STfm3zStx+/uJzNCMMLgjDkw9lHZsFPws9f5h1eXPJpOiUIwnkHQXC3/0MqG29R5VW2M0mKxSLx9Yc8frSJuraGrussyzKxWAxDN1AUBcMw0AwDVddQNRVFU1HVO9K1dUuzMObEe89o4HHkTnHFC5x2h0ajQSabZTQa0e06tNpt+r0ePbtCpyxwRR13rzr//SO9U/6QXx1ib56SSm4jEgGuGWCaGTLpNOvrcZz9A77Orng1ecPkdIhjOSSMPLKsU7by1PZsbFFBCBtpErnBSrXZHwi63S57zRK71QI7pRK5coV4aguvN+b68je+d8zLcZ3z599p2EdoTzYQnTrNcpOqaFETLaSThRsq5oCjY59Bf4jb69NudagKgXAcirkcWd0kEdkkrRQxoyWy0SyZSJ581KKgFtnQd0hoFkndQjq8d8tuesA0OOeZP8b3/TnP8zg89DFTSfq1A173z1h7sEhCXUF+arBw1WTJ2UJevM9ydAlNV4gqK/wFszkAcbPzYGMAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/aae41fdf8b2756cc3327504c8f247d5c/fcda8/1667458469529-3616b715-baa2-407b-bcc6-a20883a6a548.png\"\n        srcset=\"/static/aae41fdf8b2756cc3327504c8f247d5c/12f09/1667458469529-3616b715-baa2-407b-bcc6-a20883a6a548.png 148w,\n/static/aae41fdf8b2756cc3327504c8f247d5c/e4a3f/1667458469529-3616b715-baa2-407b-bcc6-a20883a6a548.png 295w,\n/static/aae41fdf8b2756cc3327504c8f247d5c/fcda8/1667458469529-3616b715-baa2-407b-bcc6-a20883a6a548.png 590w,\n/static/aae41fdf8b2756cc3327504c8f247d5c/efc66/1667458469529-3616b715-baa2-407b-bcc6-a20883a6a548.png 885w,\n/static/aae41fdf8b2756cc3327504c8f247d5c/c83ae/1667458469529-3616b715-baa2-407b-bcc6-a20883a6a548.png 1180w,\n/static/aae41fdf8b2756cc3327504c8f247d5c/c8252/1667458469529-3616b715-baa2-407b-bcc6-a20883a6a548.png 2178w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><a name=TSuPg></a></p>\n<h1>Vercel</h1>\n<p>但是这一次更进一步，还仅将 v 部署在了两个不同的 Kubernetes 集群中，还将它部署在了 Vercel 上！</p>\n<p><a name=JR2p6></a></p>\n<h2>k2e</h2>\n<p>v 这个项目，是一个很老的项目了，当时我不知道出于什么原因，将服务器和客户端的代码，杂揉在了一起。大概是为了将它们部署在一个地方，使用 pm2 + nginx 来对外提供服务。另外，在开发时前后端有很多代码是共享的，总之，不太像一个纯粹的前后端分离的主流项目。后端是 koa 写的，前端就是一个 create-react-app。</p>\n<p>在将这种杂揉在一起的代码部署上 Kubernetes 时，没有任何障碍。没有想到，部署上 Vercel 竟然也如此丝滑顺畅，这得益于参考《<a href=\"https://zhuanlan.zhihu.com/p/542130945\">Free Arch：将 Koa 服务部署到 Vercel - Jeff Tian的文章 - 知乎</a> 》。即添加一个 api 目录，并使用 <a href=\"https://github.com/xingxingted/koa-to-express\">@jeff-tian/koa-to-express</a> 将 koa 形式的中间件转换成了 Express 的中间件，就和 Vercel 的 Serverless 函数对上了！其实上文中有大佬留言，不需要做这个转换，只需要自己写一个 runtime 就行了。但是我还没有空研究这个 runtime，总之再次使用了自己的 k2e，又不是不能跑（逃……）。</p>\n<p><a name=jl750></a></p>\n<h2>Vercel 上的 v</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e93dbe76dec1879aee783d007dcbb87a/ffe34/1667469400022-eaac9850-8509-459b-99d9-614d83bbdbbf.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.48648648648649%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAACZklEQVR42mVTTW8SURQdvlJg+CrQNkhhmA/HupTOMDDSStMm/oT+AjDEhSY21YUrEoMLEtpYSVMXJlT4KXWHwUTtgg0hGEgTK8YNdXHMfTjE6iRn3rv3nTlzz70znJHN415hG1tbO9Cym0hrOeh6Dul1A2nNgJ4xsa5nkc3msbG5hXUtC+3PuZbJQc/kcCedYZyMYYJLJATIyk2o6i3cSIpIijIURUUqJSEeT0AUJQgpEZIoYW3tNgRBZIivJlg+JRJvFclkCpIkg+N5L3w+H7xeL/w+nu0DAT8o73K54HQ64HDMYLPb4HDYYbfbWUyrtbfyXDgcxvLyMlZWVhCNRhkojkQiWFpaQigUQiAQYAgGgyA+cSKR6Jz/Nzh6gIiCIECWZUiSxEonqymyKkksb50R1+PxMCwsLDC43W7mkMARgUR3d3dRLpdRLBZRKpXw5NFD7O89Rqn0gMUEOovFYqx6cuT3+1mLSJTjuBkooSgKms0m2u022u0W3jbfYe/FIZ493cfJyRu0Wi2cnp4yqKrKREjUaoUlaLPZwFG5hmHg3+vz1x/4cn7+X75QKLDKrOqop+SQKhdFcSaoaRomkwkGgwG63Y+4vPw2F5hOp+j3+xiPR7i6muJuPg8PzzNBGgIJUu9o0k6ncyao6zpGoxF6vR46nQ6GwyFG4zF7wcXFBd6fneFD9xMmk58wN/Jw8zy8Hs986rTOe0j+TdO8Zouquhb/AvC9Qzds79zH4mJoNlFLxOqfNRTyXq/XUa1WUalUUKvVcHx8jEajgUbjNQ4OX+Go9hxHBy/ZX2V9kyTK8zyDNenfDXi85chk6bIAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/e93dbe76dec1879aee783d007dcbb87a/fcda8/1667469400022-eaac9850-8509-459b-99d9-614d83bbdbbf.png\"\n        srcset=\"/static/e93dbe76dec1879aee783d007dcbb87a/12f09/1667469400022-eaac9850-8509-459b-99d9-614d83bbdbbf.png 148w,\n/static/e93dbe76dec1879aee783d007dcbb87a/e4a3f/1667469400022-eaac9850-8509-459b-99d9-614d83bbdbbf.png 295w,\n/static/e93dbe76dec1879aee783d007dcbb87a/fcda8/1667469400022-eaac9850-8509-459b-99d9-614d83bbdbbf.png 590w,\n/static/e93dbe76dec1879aee783d007dcbb87a/efc66/1667469400022-eaac9850-8509-459b-99d9-614d83bbdbbf.png 885w,\n/static/e93dbe76dec1879aee783d007dcbb87a/ffe34/1667469400022-eaac9850-8509-459b-99d9-614d83bbdbbf.png 1055w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><a name=rwXmY></a></p>\n<h1>复活老项目</h1>\n<p>这样，每一次提交代码，就将 v 同时部署在了三个平台，做到了真正意义上的“狡兔三窟”。不仅复活了老项目，还同时给它制造了多个分身。这一次，不是为了复活而复活，而是为了实现个人收款自动化的功能，不想从零开始，就在老项目（哪怕是一个屎山项目）上添加这个功能了。</p>\n<p><a href=\"https://v.pa-ca.me/orders\">https://v.pa-ca.me/orders</a></p>\n<p>嗯，就是喜欢做这样的事情：</p>\n<ul>\n<li><a href=\"https://zhuanlan.zhihu.com/p/522752605\">屎山并不可怕 - Jeff Tian的文章 - 知乎 </a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/359908165\">10 年前老博客以 JAM Stack 方式满血复活！ - Jeff Tian的文章 - 知乎 </a></li>\n</ul>\n<p><a name=GBlCM></a></p>\n<h1></h1>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}},"menus":{}}},"staticQueryHashes":[],"slicesMap":{}}