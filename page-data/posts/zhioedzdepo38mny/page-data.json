{"componentChunkName":"component---src-templates-post-js","path":"/posts/zhioedzdepo38mny/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/zhioedzdepo38mny","relativePath":"posts/zhioedzdepo38mny","frontmatter":{"title":"使用 IdentityServer  保护 Vue 前端","stackbit_url_path":"posts/zhioedzdepo38mny","date":"2022-12-13T09:54:23","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p><a name=MW1Td></a></p>\n<h1>前情提要</h1>\n<p>《<a href=\"https://zhuanlan.zhihu.com/p/533197284\">使用 IdentityServer 保护 Web 应用（AntD Pro 前端 + SpringBoot 后端） - Jeff Tian的文章 - 知乎</a> 》中记录了使用 IdentityServer 保护前后端的过程，其中的前端工程是以 UMI Js 为例。今天，再来记录一下使用 IdentityServer 保护 Vue 前端的过程，和 UMI Js 项目使用 umi plugin 的方式不同，本文没有使用 Vue 相关的插件，而是直接使用了 oidc-client js。</p>\n<p>另外，我对 Vue 这个框架非常不熟，在 vue-router 这里稍微卡住了一段时间，后来瞎试居然又成功了。针对这个问题，我还去 StackOverflow 上问了，但并没有收到有效的回复： <a href=\"https://stackoverflow.com/questions/74769607/how-to-access-vues-methods-from-navigation-guard\">https://stackoverflow.com/questions/74769607/how-to-access-vues-methods-from-navigation-guard</a></p>\n<p><a name=bjAAH></a></p>\n<h1>准备工作</h1>\n<p>首先，需要在 IdentityServer 服务器端注册该 Vue 前端应用，仍然以代码写死这个客户端为例：</p>\n<p>csharp\nnew Client\n{\nClientId = vue-client,\nClientSecrets = { new Secret(vue-client.Sha256()) },\nClientName = vue client,\nAllowedGrantTypes = GrantTypes.Implicit,\nAllowAccessTokensViaBrowser = true,\nRequireClientSecret = false,\nRequirePkce = true,</p>\n<pre><code>            RedirectUris =\n            {\n                http://localhost:8080/callback,\n                http://localhost:8080/static/silent-renew.html,\n            },\n            AllowedCorsOrigins = { http://localhost:8080 },\n            AllowedScopes = { openid, profile, email },\n            \n            AllowOfflineAccess = true,\n            AccessTokenLifetime = 90,\n            AbsoluteRefreshTokenLifetime = 0,\n            RefreshTokenUsage = TokenUsage.OneTimeOnly,\n            RefreshTokenExpiration = TokenExpiration.Sliding,\n            UpdateAccessTokenClaimsOnRefresh = true,\n            RequireConsent = false,\n        };\n</code></pre>\n<p><a name=mLZql></a></p>\n<h1>在 Vue 工程里安装 oidc-client</h1>\n<p>shell\nyarn add oidc-client</p>\n<p><a name=UmXhq></a></p>\n<h1>在 Vue 里配置 IdentityServer 服务器信息</h1>\n<p>在项目里添加一个 src/security/security.js文件：</p>\n<p>javascript\nimport Oidc from oidc-client</p>\n<p>function getIdPUrl() {\nreturn <a href=\"https://id6.azurewebsites.net\">https://id6.azurewebsites.net</a>;\n}</p>\n<p>Oidc.Log.logger = console;\nOidc.Log.level = Oidc.Log.DEBUG;</p>\n<p>const mgr = new Oidc.UserManager({\nauthority: getIdPUrl(),\nclient_id: vue-client,\nredirect_uri: window.location.origin + /callback,\nresponse_type: id_token token,\nscope: openid profile email,\npost_logout_redirect_uri: window.location.origin + /logout,\nuserStore: new Oidc.WebStorageStateStore({store: window.localStorage}),\nautomaticSilentRenew: true,\nsilent_redirect_uri: window.location.origin + /silent-renew.html,\naccessTokenExpiringNotificationTime: 10,\n})</p>\n<p>export default mgr</p>\n<p><a name=frzhB></a></p>\n<h1>在 main.js 里注入登录相关的数据和方法</h1>\n<p><a name=I9QIv></a></p>\n<h2>数据</h2>\n<p>不借助任何状态管理包，直接将相关的数据添加到 Vue 的 app 对象上：</p>\n<p>javascript\nimport mgr from @/security/security;</p>\n<p>const globalData = {\nisAuthenticated: false,\nuser: ,\nmgr: mgr\n}</p>\n<p><a name=CJvDH></a></p>\n<h2>方法</h2>\n<p>javascript\nconst globalMethods = {\nasync authenticate(returnPath) {\nconsole.log(authenticate)\nconst user = await this.$root.getUser();\nif (user) {\nthis.isAuthenticated = true;\nthis.user = user\n} else {\nawait this.$root.signIn(returnPath)\n}\n},\nasync getUser() {\ntry {\nreturn await this.mgr.getUser();\n} catch (err) {\nconsole.error(err);\n}\n},\nsignIn(returnPath) {\nreturnPath ? this.mgr.signinRedirect({state: returnPath}) : this.mgr.signinRedirect();\n}\n}</p>\n<p><a name=qpefJ></a></p>\n<h2>修改 Vue 的实例化代码</h2>\n<p>javascript\nnew Vue({\nrouter,\ndata: globalData,\nmethods: globalMethods,\nrender: h => h(App),\n}).$mount(#app)</p>\n<p><a name=XBhoW></a></p>\n<h1>修改 router</h1>\n<p>在 src/router/index.js中，给需要登录的路由添加 meta 字段：</p>\n<p>javascript\nVue.use(VueRouter)</p>\n<p>const router = new VueRouter({\n{\npath: /private,\nname: private page,\ncomponent: resolve => require([@/pages/private.vue], resolve),\nmeta: {\nrequiresAuth: true\n}\n}\n});</p>\n<p>export default router</p>\n<p>接着，正如在配置中体现出来的，需要一个回调页面来接收登录后的授权信息，这可以通过添加一个 src/views/CallbackPage.vue 文件来实现：</p>\n<p>vue\n<template></p>\n  <div>\n    <p>Sign-in in progress... 正在登录中……</p>\n  </div>\n</template>\n<script>\nexport default {\n  async created() {\n    try {\n      const result = await this.$root.mgr.signinRedirectCallback();\n      const returnUrl = result.state ?? /;\n      await this.$router.push({path: returnUrl})\n    }catch(e){\n      await this.$router.push({name: Unauthorized})\n    }\n  }\n}\n</script>\n<p>然后，需要在路由里配置好这个回调页面：</p>\n<p>javascript\nimport CallbackPage from @/views/CallbackPage.vue;</p>\n<p>Vue.use(VueRouter)</p>\n<p>const router = new VueRouter({\nroutes: {\npath: /private,\nname: private page,\ncomponent: resolve => require([@/pages/private.vue], resolve),\nmeta: {\nrequiresAuth: true\n}\n},\n{\npath: /callback,\nname: callback,\ncomponent: CallbackPage\n}\n});</p>\n<p>export default router</p>\n<p>同时，在这个 router 里添加一个所谓的“全局前置守卫”（<a href=\"https://router.vuejs.org/zh/guide/advanced/navigation-guards.html#%E5%85%A8%E5%B1%80%E5%89%8D%E7%BD%AE%E5%AE%88%E5%8D%AB\">https://router.vuejs.org/zh/guide/advanced/navigation-guards.html#%E5%85%A8%E5%B1%80%E5%89%8D%E7%BD%AE%E5%AE%88%E5%8D%AB</a>），注意就是这里，我碰到了问题，并且在 StackOverflow 上提了这个问题。在需要调用前面定义的认证方法时，不能使用 router.app.authenticate，而要使用 router.apps[1].authenticate，这是我通过 inspect router发现的：</p>\n<p>javascript\n...</p>\n<p>router.beforeEach(async function (to, from, next) {\nlet app = router.app.$data || {isAuthenticated: false}\nif(app.isAuthenticated) {\nnext()\n} else if (to.matched.some(record => record.meta.requiresAuth)) {\nrouter.apps[1].authenticate(to.path).then(()=>{\nnext()\n})\n}else {\nnext()\n}\n})</p>\n<p>export default router</p>\n<p>到了这一步，应用就可以跑起来了，在访问 /private 时，浏览器会跳转到 IdentityServer 服务器的登录页面，在登录完成后再跳转回来。\n<a name=Iv6ZO></a></p>\n<h1>添加 silent-renew.html</h1>\n<p>注意 security.js，我们启用了 automaticSilentRenew，并且配置了 silent_redirect_uri的路径为 silent-renew.html。它是一个独立的引用了 oidc-client js 的 html 文件，不依赖 Vue，这样方便移植到任何前端项目。</p>\n<p><a name=V8x9Y></a></p>\n<h2>oidc-client.min.js</h2>\n<p>首先，将我们安装好的 oidc-client 包下的 node_modules/oidc-client/dist/oidc-client.min.js文件，复制粘贴到 public/static目录下。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6a88d577a166df5e75ff42e98e47a31a/05fb0/1670926226599-764ba6aa-c2b6-4142-b825-983202e7194b.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 110.8108108108108%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAABYlAAAWJQFJUiTwAAADkUlEQVR42oWU64/bRBTF8+/QAlXZtkk2sZ3H5uHHjGfGY2/eWWdL1RYqgVA/sKKIR4so0oIEf/APeZzsbgCVD0fXsjzH59x75ja80BDOLkmyBSJbMEgMQajwpylBKPEmCm+ib9AdKyKzJNQLpnpOP7bE2YpeXDAOpzQmwy4i6jETfZ6nTWz2BKva5KblqowCZNQ7gggDRHioNar3XqdJY3LWJRVDFnLAC90mty1yfUqRtchNmzTukcb9D0JGfVTSx+ue0gjHATIZMJdDnus21jTRIiBNArTwHWF1wNW7JAdEfaeuJmzTiKY993FuIi62liJrk6lTp04l/v5AjfQf1u9CxTeE1R8H7kCRKxYLgTUdlOjfIumTJn1EckaanKGSIeldxEO0OMPzOjSScRsTNtEVxifM14b5akCW3CeXn5Knn5CJB+TxQ5Zhm5n0UVU7og4m7mLiutqki99t0vDMFf78ms78N1qLa1T5nmflK3blFdvdT+wuv2Oze8fi4j2z8prl/Gcutj8gnv1JfPkH04vfXU0+/4vOaEYj0F/TO/+RxF6xVK/54vw1T9ev2JTfsirfsNm9YV1+z/ryirK8YjN7yar8BvX0LeryF5KLd8jyLerpr/iTorachU/YjR6yHX3GV8szvpw9ZhXeYxvfZxvfYxN9TCk+Io8fYGWTLD2trSYeVnjog2WvdTuUOB6Qz3M2a8G5bZLZDlr7CDFAVpD1YNK4GsoI5QZ0O5h6KKeH2PSRYcB6plkvIrRsopPANT91calxyNz/xKbOoYgHXOgRO9MlM23sPotGeh8kuiE8DnYfEfosFpbVUmJkCyXqm6KFRxoHLnsqGThU39/WoWvZEWElV0w9Zuea1UqSmxN3n92C0B4mHWFVRJZOydIxWp65auTI9a4m7x0TJlOP5XlGuScsTJsia5IbjyLzsSrA6q4js7oinrhnJYZOZfUD3+/cEsbTgN0s4eVmjNGP3Z2uV1iHXPexaoBVPacoUxNMpXCvsrJu5PB4ymLqk+WS+UZQ6EdY3XFLoiKwOsKqKUZOnP2KpMLBdo07sakt+6wWKeUmxupHrodGVlbHWDXZH65751TeUadcDof/QTjXlJvEEVYLtlKZ6647WCl0Vg+K9pbrBfuvHNaxya1066swNaGRAzI13vfs2OJB6fHGPoqNz6xI2a5jCnPCuW1RmBZZ2nYTdZNVkxu7lcWD4rvB/hvstEDbb/DhTQAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/6a88d577a166df5e75ff42e98e47a31a/fcda8/1670926226599-764ba6aa-c2b6-4142-b825-983202e7194b.png\"\n        srcset=\"/static/6a88d577a166df5e75ff42e98e47a31a/12f09/1670926226599-764ba6aa-c2b6-4142-b825-983202e7194b.png 148w,\n/static/6a88d577a166df5e75ff42e98e47a31a/e4a3f/1670926226599-764ba6aa-c2b6-4142-b825-983202e7194b.png 295w,\n/static/6a88d577a166df5e75ff42e98e47a31a/fcda8/1670926226599-764ba6aa-c2b6-4142-b825-983202e7194b.png 590w,\n/static/6a88d577a166df5e75ff42e98e47a31a/efc66/1670926226599-764ba6aa-c2b6-4142-b825-983202e7194b.png 885w,\n/static/6a88d577a166df5e75ff42e98e47a31a/05fb0/1670926226599-764ba6aa-c2b6-4142-b825-983202e7194b.png 1138w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>然后，在这个目录下添加 public/static/silent-renew.html文件。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1679bfb6c6cfe2ff6e5de5cbf0db2655/302a4/1670926436227-a71b168c-6f84-4efa-9148-9baa0b4de92f.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 96.62162162162163%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAABYlAAAWJQFJUiTwAAADN0lEQVR42nWSSY8cRRBG+w9xAY08091VlVn7npm19jLt6bFhxgZhCx8sDmOEhISEOLAc4MhPfaiylxlbcPgUmVUZL7+IyFmVXjHUHve9oNefoYsvMMUFTXmBzi8xxQJdLtHFgra4wmSXmOzZ/2pW6G/Yd695u3/H3Yvv+Gr/js3qWzbDa9bNKzbdG8z4nnL4Hn/7E3L8ATF8QA4fbDzptJ/p5oFk/Qub7QNfvvmL4e0/hDd/sxx/Z7n6DW/8lbz9EdU8UHU/M9/8yWL9x0GbJzruZ/vwc9rsClO67Ks5N+uc56uMvnYZtKCrPRol0UqwTy94mV7YFrTFgiaf0xQnLTD5nNlNNG0kZSbQJuLlreb5tme70ux3A/tdz+2uZ7c2KJVyVwesdIpRCY1VSqsfNdtHVzS5R11FrLaKYVdxvWkZh4pxqOm7kr4raJscXYXc5y5DHdl1qxOaaV36qNLHVAGzMVlyG12iap/dreHrtebVRnG30dyYmOvKZ6dCruuA+8yxe61iWhVj6ghVSOpcnDVzpaAJfe57xYsmpgs82sCjDzwascRIByMcjOcQSw8vCJC+byV8iZACIeVZs4UrcKOMZtximp6wqLlYejxzBJeu5NkTXbmChSOYHzXlLlz5kWYL18OTAVU7klcK03TUuiGMU2QQEcYJQRQjgxA/ivH8kCBK8PyApStYeifwYT2bbnKF5HosaPuBstZUylCb1l4QTMA4tfKjBOGHhxhEZ9l/YYwMI2YLx8ORAarrUU2LMi1FrWyMs9wmhMmnsNACLCxKzpfJMH4E6m60kKYbKCpFbRp7eIJOh4MTKDqA5NHRBLawILLtsD1cioBq2NIOK4bVhqLWZEVFWlR2LY59C459PZR3AJ2cTWemPtopO9JHr9c0/YhuOkpliNP8MJgwtjBpXT06m1xa53FyruDg0Dk4VL2mqGqSvLSlTzE4AqceypOrKR5dToBJ4ljuuWRZlEizodaGvKztdOOsIC0O0KUncYRve+jK4Jw8fZs73vnZ2JKXrke+vcH0A6bt7DCyskK3nS2/Or7JCfo08fHtyY90KDmtkXF2nFh8fmdTr8IkOwP/S59C/wVrX8T9SseP1wAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/1679bfb6c6cfe2ff6e5de5cbf0db2655/fcda8/1670926436227-a71b168c-6f84-4efa-9148-9baa0b4de92f.png\"\n        srcset=\"/static/1679bfb6c6cfe2ff6e5de5cbf0db2655/12f09/1670926436227-a71b168c-6f84-4efa-9148-9baa0b4de92f.png 148w,\n/static/1679bfb6c6cfe2ff6e5de5cbf0db2655/e4a3f/1670926436227-a71b168c-6f84-4efa-9148-9baa0b4de92f.png 295w,\n/static/1679bfb6c6cfe2ff6e5de5cbf0db2655/fcda8/1670926436227-a71b168c-6f84-4efa-9148-9baa0b4de92f.png 590w,\n/static/1679bfb6c6cfe2ff6e5de5cbf0db2655/efc66/1670926436227-a71b168c-6f84-4efa-9148-9baa0b4de92f.png 885w,\n/static/1679bfb6c6cfe2ff6e5de5cbf0db2655/302a4/1670926436227-a71b168c-6f84-4efa-9148-9baa0b4de92f.png 1080w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>html</p>\n<!DOCTYPE html>\n<html>\n<head>\n    <title>Silent Renew Token</title>\n</head>\n<body>\n<script src=oidc-client.min.js></script>\n<script>\n    console.log(renewing tokens);\n    new Oidc.UserManager({userStore: new Oidc.WebStorageStateStore({ store: window.localStorage })})\n        .signinSilentCallback();\n</script>\n</body>\n</html>\n<p><a name=HFuLX></a></p>\n<h1>给 API 请求添加认证头</h1>\n<p>最后，给 API 请求添加上认证头。前提是，后端接口也使用同样的 IdentityServer 来保护（如果是 SpringBoot 项目，可以参考《<a href=\"https://zhuanlan.zhihu.com/p/533197284\">使用 IdentityServer 保护 Web 应用（AntD Pro 前端 + SpringBoot 后端） - Jeff Tian的文章 - 知乎</a> 》）；否则，如果 API 是公开的，就不需要这一步了。</p>\n<p>对于使用 axios 的 API 客户端，可以利用其 request interceptors，来统一添加这个认证头，比如：</p>\n<p>javascript\nimport router from ../router\nimport Vue from vue;</p>\n<p>const v = new Vue({router})</p>\n<p>const service = axios.create({\n// 公共接口--这里注意后面会讲\nbaseURL: process.env.BASE_API,\n// 超时时间 单位是ms，这里设置了3s的超时时间\ntimeout: 20 * 1000\n});</p>\n<p>service.interceptors.request.use(config => {\nconst user = v.$root.user;\nif(user) {\nconst authToken = user.access_token;\nif(authToken){\nconfig.headers.Authorization = Bearer ${authToken};\n}\n}</p>\n<pre><code>return config;\n</code></pre>\n<p>}, Promise.reject)</p>\n<p>export default service</p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}}}},"staticQueryHashes":[],"slicesMap":{}}