{"componentChunkName":"component---src-templates-post-js","path":"/posts/wsehy3sgpl83ltro/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/wsehy3sgpl83ltro","relativePath":"posts/wsehy3sgpl83ltro","frontmatter":{"title":"抛弃隐式许可，拥抱 PKCE","stackbit_url_path":"posts/wsehy3sgpl83ltro","date":"2023-08-28T12:29:22","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p><a name=wwm2X></a></p>\n<h1>OpenID Connect 和 OAuth 2.0 概览</h1>\n<p>在早些年代，网站之间互不连接。后来，连接需求越来越大，但是怎么安全地连接就成了一个问题。经过 3 次修改，OAuth 2.0 （先是 1.0，后来是 1.0a）诞生了，其中的 O 就是开放互联的意思。<br />OAuth 2.0 中有一些术语，其中一部分我列在了下表里。纯解释有些抽象，我们想象一个具体的场景：你现在要登录知乎网站，选择了使用微信登录。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4eabb59013c24e8047bbe17ed0da5182/9cac8/1693216689696-f970519f-6106-4833-b72b-9d55d4eea7d0.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 67.56756756756756%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABYlAAAWJQFJUiTwAAAC/UlEQVR42o2RXW8bRRSG9+/YLRIp5QZ+DTfck7TQEkht56OJ0iaOVIra2gQEpdyAUNQCrkPjpIkckbiJQqkT24R6bW9i49jeXc/Yu97dB3nzUVFxwdG858yc9+jMO2eUgbff5Y2Bd3jrzQEuXrhIMHCec8HzBAPnCASCfvwXgscIBP4byuhnMa7e/oZP73zL1Vtf8slcjKFonMtzX3BpNs7QbMzHpdkYH9yMMXjzHoM37nJ55nXc8aPC0So7pSJPa5I/qg1qLzbYqTRYLrXYqEkyRzabdYvtpsXDQo9oBm4/hxUTUgYsn8KEVQOUz39Z4uNQhKmJMDcmrzMZCXM9HGJkeJixcJiJ0QjjkTDj4RCha2EerO+xWJKkNMmSJnlSFvxaFixrkru7RygXYlnSf/4Njo2QHUwpaRg6ptlGNwzMdhshJEJKDNPkZVFFrRzQbOk+5wE9t+/hQaGG8jCxwKF2wKm1sVD1qp8zDAPHcc44z3WpHNaptyTdroVt26eM79Ob6yju9mNEvXyc9lw8z6Pb7aKqKkKK41qvvzxs26LRbCE6Nobo0nM8bMejITxkD5aTSyiJtS0svXpyB0gpicfjTE1NMR+fZ1/bBVyfsywbS+on51fKhdmiJwzmk1mUrZ11rObhGdlXF41GGRoaJBIaY0tdIc8K1d4+eDaPMgbDC20iP5ncSkkmE20+/KHJV6smY+kqSiYdp2NWzhp2Oh2mp6cZGbnGlSsfUSkez/ewl0e1MqRf5kjlLFbzFqkXOiu5Dkt5m6zmML6tozxJJClXtLOG/UHncjkKhYIfhWi/Um91qcsCHfr11smjLfCEvxvdaqI8nZlB+0v1E/0fdT2P1811XVzP9WeoNwyaesuH6HTpSoFom+A6JLJ7KNHwHAdalf9lnkf16AjLdtBNgey51KWDYbk0e9Bb+xnl/XiSjed7FDWNzT2VZ7v7VPM5SkWVbLlGRVXJFctkVY1MocR79xaZeLTDj7/XWfxtl+8WUnydXOPxs3XK39/nH5sAtll3eopyAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/4eabb59013c24e8047bbe17ed0da5182/fcda8/1693216689696-f970519f-6106-4833-b72b-9d55d4eea7d0.png\"\n        srcset=\"/static/4eabb59013c24e8047bbe17ed0da5182/12f09/1693216689696-f970519f-6106-4833-b72b-9d55d4eea7d0.png 148w,\n/static/4eabb59013c24e8047bbe17ed0da5182/e4a3f/1693216689696-f970519f-6106-4833-b72b-9d55d4eea7d0.png 295w,\n/static/4eabb59013c24e8047bbe17ed0da5182/fcda8/1693216689696-f970519f-6106-4833-b72b-9d55d4eea7d0.png 590w,\n/static/4eabb59013c24e8047bbe17ed0da5182/efc66/1693216689696-f970519f-6106-4833-b72b-9d55d4eea7d0.png 885w,\n/static/4eabb59013c24e8047bbe17ed0da5182/c83ae/1693216689696-f970519f-6106-4833-b72b-9d55d4eea7d0.png 1180w,\n/static/4eabb59013c24e8047bbe17ed0da5182/9cac8/1693216689696-f970519f-6106-4833-b72b-9d55d4eea7d0.png 2288w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<table>\n<thead>\n<tr>\n<th><strong>术语</strong></th>\n<th>解释</th>\n<th>举例</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>客户端应用</strong></td>\n<td>代替你做一些操作的应用</td>\n<td>知乎</td>\n</tr>\n<tr>\n<td><strong>访问令牌</strong></td>\n<td>你授权客户端应用之后，颁发给客户端应用的一个字符串</td>\n<td>一个 jwt 或者是一个普通的字符串</td>\n</tr>\n<tr>\n<td><strong>授权服务器</strong></td>\n<td>验证资源拥有者以及客户端应用是否可以访问受保护资源的服务器</td>\n<td>微信</td>\n</tr>\n<tr>\n<td><strong>资源服务器</strong></td>\n<td>保存着资源以及提供相关服务的服务器</td>\n<td>在这里，仍然是微信。但可以是不同的服务器。</td>\n</tr>\n<tr>\n<td><strong>资源拥有者</strong></td>\n<td></td>\n<td>你自己</td>\n</tr>\n<tr>\n<td><strong>受保护资源</strong></td>\n<td></td>\n<td>你的微信昵称、头像等</td>\n</tr>\n</tbody>\n</table>\n<p>以上例子中，通过 OAuth 2.0 就将知乎和微信连接起来了。在通过 OAuth 2.0 开放互联的新世界里，还缺少一样东西，就是身份识别。于是 OIDC （即 OpenID Connect）诞生了。OIDC 在 OAuth 2.0 的基础上增加了很薄的一层，即引进了一种新的令牌：身份令牌， 使用 jwt 格式存储了经过验证的用户身份信息。这将开放互联提升了一个高度，并且为单点登录打开了一扇门（单点登录除了 OIDC 协议，还有 SAML 协议等）。<br />OAuth 2.0 以及 OIDC 使用了一系列的流程来管理客户端应用、授权服务器和资源服务器之间的交互。比如上面的例子中，就是一个授权码流程，就是从浏览器触发，并且像这样来工作：</p>\n<ol>\n<li>知乎想要你的微信昵称，并且展示了一个微信图标按钮。</li>\n<li>你点了这个按钮，就会被重定向到微信的站点并要求扫码登录。</li>\n<li>一早你扫码，微信（手机上）会展示一个页面说知乎想要获取你的微信名称和头像。<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3c00e15cae070a3714ffa55cee3e40c4/d9199/1693217865788-a1e05373-e768-4c46-9f79-4cff86966478.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 216.89189189189187%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAArCAIAAAD3xz8iAAAACXBIWXMAAAsTAAALEwEAmpwYAAAEHElEQVR42q1WXU/bVhiOtKt9/Ivufv9idHfrzYQ0qZSLVlV3Ve1m+wX0YhOdhFQhVpA2aRsZWhWlY0lpCmYVyRLFqR3skGSYEOL4M4m/jm3sc46n2GCgJKTr9ugoOj72o+f9PkkEQdDv91VVlSQJQhhcCQCA2BUUq/e33UYYJYIgaLVa9RCe542jYYyDIFBVla0yXK+d12kfwUTwH5BACO3t7VEUdXR0NPFrjDFCCAcYB0NDEhhjTdMVtWcB8K+Vzz+gU+BLGEvGGPdsbPvB2yjbPp76GSxXnDpVLJXJZrO5v7/Pheh0OoIgHBwcuK47muyhYIFEhS4yB4pumIZh9EJommaE6Pf7I0sgEQXRGiguMB3HURRZC6HrumkOTxzHAQCMVcYYb//5Mpt9Vi6Xt7e3V1dXs9lsLpdLp9MURa2traXT6UwmY9v2CDJCqNlsUhRFEATDMM1mk6Zpkhw6H0cbhhjls+cRBFGpVEiSzOfzpVKJJMmdnZ3d3V2EUFybE/L8lkWCx2AyGWPs+z5CCELoh4j3kateiOPjY8/zorcXlEVRVBRFlmVFUQRB6HQ6sixLksTzvKZpqqoqiiKKoiAIkiTFYT9R5rtdIYQoSaqq8jwvSZIgCIqiTKjts44L8MgZcLYPn+PDIdlHOJ3/6/sfV9YLL03LbB8etlotQRAMw3iDxvDc+WTy2y9ufjU/17MAWS7TNH14eChJ0nn9yC4Xeapn4phsOdaT3O/ZX3/4aT1je9AGIKpny7IMw7AsyzRNXdc1XcMIucgH8PhMGUKoqCbGgWN7EKIoPVFK4oRH+5EBQwIkGO23lv08CNCEMXY6wEJy6MgCdfOzp598x962gMIwNe6AazQacTGMDVhoiztfnf14/dNvarcBUHZ3awzL0DQ9mRz+wqq2vsr9QvaeBgGMAxu5Go/EN+qqWHBib5x1VXTXWJbFcRzLso1Gg+O4arXabrdpmhZF8XJjn5Edx4kuPZqmC4UCRVE0TZfLZYZhBoNB9HaC2a7rqqoqhog2sixPvjGucG+c8xeUPQwddOzA15bnopPlYfi/z7AwscsCMVNbvFdfuVtfvlN/fKu2OFtbvFN/fLe+fK++MlNbXBaI821/QXnq1Vxi48Y7m58nctMfELMflb7+sPDlu8RM4sX08HDjxtSruZHKQ1ynHpyQX0y/R9y6lr9/LX//fWI2kTshX6cexB+/bvaWVlvgN5a6W0vdzUf884ftPx4eZR7xuaXu5lJ3a4Hf2NJqY80etiM8XejKw8tkE5g9rd/XB7plHLRb+WKBZqqCLA4Mra8PelrfBOZYMgBAOwXP85VKpVgs8jw/nEEhwMX/LRfIvu+7rgshPF9S8S3puq7v++PndkhgWTaZTKZSqSchUqlUMplkWfZyV/0Dg6drRQ+2zksAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMG_1014.png\"\n        title=\"IMG_1014.png\"\n        src=\"/static/3c00e15cae070a3714ffa55cee3e40c4/fcda8/1693217865788-a1e05373-e768-4c46-9f79-4cff86966478.png\"\n        srcset=\"/static/3c00e15cae070a3714ffa55cee3e40c4/12f09/1693217865788-a1e05373-e768-4c46-9f79-4cff86966478.png 148w,\n/static/3c00e15cae070a3714ffa55cee3e40c4/e4a3f/1693217865788-a1e05373-e768-4c46-9f79-4cff86966478.png 295w,\n/static/3c00e15cae070a3714ffa55cee3e40c4/fcda8/1693217865788-a1e05373-e768-4c46-9f79-4cff86966478.png 590w,\n/static/3c00e15cae070a3714ffa55cee3e40c4/efc66/1693217865788-a1e05373-e768-4c46-9f79-4cff86966478.png 885w,\n/static/3c00e15cae070a3714ffa55cee3e40c4/d9199/1693217865788-a1e05373-e768-4c46-9f79-4cff86966478.png 960w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></li>\n<li>一旦你点击允许，微信（浏览器上）会跳转回知乎页面，并且在 URL 上带上临时的授权码。</li>\n<li>（知乎事先在微信的开放平台注册了一个网站应用），知乎用从 URL 上获取到授权码，加上它在微信的开放平台的网站应用里获取到的凭据（appid 和 appsecret），去微信换取访问令牌。</li>\n<li>微信校验授权码，如果一切校验通过，就为知乎颁发一个受限（仅允许对你的微信名称和头像进行只读访问）的访问令牌。</li>\n<li>知乎接着使用这个访问令牌去调用微信 API（获取你的用户信息）</li>\n<li>微信 API 验证访问令牌，如果请求匹配令牌的能力，就返回你的用户信息</li>\n</ol>\n<p><img src=\"https://cdn.nlark.com/yuque/__mermaid_v3/5ac3b63028acc8b181db1ae768ea23ed.svg#lake_card_v2=eyJ0eXBlIjoibWVybWFpZCIsImNvZGUiOiJzZXF1ZW5jZURpYWdyYW1cbiAgICBhdXRvbnVtYmVyXG4gICAgXG4gICAgcGFydGljaXBhbnQgUk8gYXMgXCLotYTmupDmi6XmnInogIU8YnIgLz7vvIjkvaDvvIznlLHmtY_op4jlmajmiJbogIXmiYvmnLrku6PnkIbvvIlcIlxuICAgIHBhcnRpY2lwYW50IENBIGFzIFwi5a6i5oi356uv5bqU55SoPGJyIC8-77yI55-l5LmO77yJXCJcbiAgICBwYXJ0aWNpcGFudCBBUyBhcyBcIuaOiOadg-acjeWKoeWZqDxiciAvPu-8iOW-ruS_oe-8iVwiXG4gICAgcGFydGljaXBhbnQgUlMgYXMgXCLotYTmupDmnI3liqHlmag8YnIgLz7vvIjlvq7kv6EgQVBJ77yJXCJcblxuICAgIFJPIC0-PiBDQSA6IOeCueWHu-S9v-eUqOW-ruS_oeeZu-W9lSBcbiAgICBDQSAtLT4-IFJPIDog6Lez6L2s5Yiw4oCm4oCmXG4gICAgUk8gLT4-IEFTOiDigKbigKblvq7kv6HnmoTmiavnoIHnmbvlvZXpobXpnaJcbiAgICBBUyAtLT4-IFJPOiDlsZXnpLrkuoznu7TnoIFcbiAgICBSTyAtPj4gUk86IOaJq-eggVxuICAgIFJPIC0-PiBBUzog5omL5py66YCa55-l5b6u5L-h5L2g5bey5omr56CBXG4gICAgbm90ZSByaWdodCBvZiBBUzog6aqM6K-B55So5oi3XG4gICAgQVMgLS0-PiBSTzog5bim552A5o6I5p2D56CB6Lez6L2s5Yiw4oCm4oCmXG4gICAgUk8gLT4-IENBOiDigKbigKbnn6XkuY7nmoTpobXpnaJcbiAgICBDQSAtPj4gQVM6IOivt-axguiuv-mXruS7pOeJjFxuICAgIG5vdGUgb3ZlciBDQSwgQVM6IOivt-axguWMheaLrO-8mjxiciAvPuWuouaIt-erryBJROOAgeWuouaIt-erryBzZWNyZXQg5ZKM5o6I5p2D56CBXG4gICAgbm90ZSByaWdodCBvZiBBUzog6aqM6K-BPGJyIC8-LSDlrqLmiLfnq68gSUQ8YnIgLz4t5a6i5oi356uvIHNlY3JldDxiciAvPi0g5o6I5p2D56CBXG4gICAgQVMgLS0-PiBDQTog6L-U5Zue6K6_6Zeu5Luk54mMXG4gICAgQ0EgLT4-IFJTOiDluKbkuIrku6TniYzov5vooYwgQVBJIOivt-axglxuICAgIG5vdGUgcmlnaHQgb2YgUlM6ICDpqozor4Hku6TniYxcbiAgICBSUyAtLT4-IENBOiBBUEkg5ZON5bqUXG5cbiIsInVybCI6Imh0dHBzOi8vY2RuLm5sYXJrLmNvbS95dXF1ZS9fX21lcm1haWRfdjMvNWFjM2I2MzAyOGFjYzhiMTgxZGIxYWU3NjhlYTIzZWQuc3ZnIiwiaWQiOiJKUVR0TCIsIm1hcmdpbiI6eyJ0b3AiOnRydWUsImJvdHRvbSI6dHJ1ZX0sImNhcmQiOiJkaWFncmFtIn0=\" alt=\"\">\n注意以上流程图中的第 8 步，知乎不仅要带上授权码，还要带上事先由微信分配的秘密凭据，这是知乎网站的后端服务器才能获取到的：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 70.27027027027026%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsTAAALEwEAmpwYAAABe0lEQVR42o2RT2vkMAzF8/G6IZk/l2G+8x72ttBDYWG6aTrOxI4tyXIcyyXJUMK2dPtDB2P76T2h4nw+n06nw+Gw3+/Lsqzruqqr4/G4W3jY8GOhLMv9brer66qqCmOMUkpr7UMgz8RM3hORX6CPIBKzF6EQirwgIjGELLJU/g+e8+/HPNhZfO1u/eXP7ekRX1+TagXc2u8T2XoJKD9/SXebxVobfVPavETECHZinlKa/iEtiNzPOaeUCmZumsYBOEA9DEAECOA2AFijh/ZFt+3t77PtewAwfe+sK0REay0iKaW+7xGRiEJM27DJk4AbEV3XCc5DrcmKGKNSahzHMI7X67W9qsFBCGPcMIYwgkOtB6ViCNMULQXkWATm58vFWuuc03qOBHPuDyDea3kerHNIc2xjzBrbAaxry99jFndd9z4zAGitjTHW2sVvtooxfi5OKTVNQ0QxRmsHQGTm7zrnnJmZcBa7wXrvv/i9Xfld/A45+NqWN8QY3wDs+Qek3+JSgQAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/b671d2991a68e70a6b8cdb36f6d5cfe4/fcda8/1693219182412-ad4db0bb-9c4d-4080-bb71-b10b2eb3e893.png\"\n        srcset=\"/static/b671d2991a68e70a6b8cdb36f6d5cfe4/12f09/1693219182412-ad4db0bb-9c4d-4080-bb71-b10b2eb3e893.png 148w,\n/static/b671d2991a68e70a6b8cdb36f6d5cfe4/e4a3f/1693219182412-ad4db0bb-9c4d-4080-bb71-b10b2eb3e893.png 295w,\n/static/b671d2991a68e70a6b8cdb36f6d5cfe4/fcda8/1693219182412-ad4db0bb-9c4d-4080-bb71-b10b2eb3e893.png 590w,\n/static/b671d2991a68e70a6b8cdb36f6d5cfe4/efc66/1693219182412-ad4db0bb-9c4d-4080-bb71-b10b2eb3e893.png 885w,\n/static/b671d2991a68e70a6b8cdb36f6d5cfe4/c83ae/1693219182412-ad4db0bb-9c4d-4080-bb71-b10b2eb3e893.png 1180w,\n/static/b671d2991a68e70a6b8cdb36f6d5cfe4/e9140/1693219182412-ad4db0bb-9c4d-4080-bb71-b10b2eb3e893.png 1226w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span><br />以上的流程对传统的网站应用来说是完美的，但是对于单页应用来说，没有服务端的支持，就没有安全地存储这种秘密凭据的方式。如果存储在客户端，流程上虽然可以工作，但是任何人都能通过浏览器查看源码从而获取到这种秘密信息。在早些的 OAuth 2.0 时代，由于没有更好的选择，就发明了隐式许可流程来从授权服务器处获取访问令牌。这是一种不安全的方式，在 OAuth 2.1 中被废弃，并提供了 PKCE 这个更好的做法来代理隐式许可。不过，在了解 PKCE 之前，让我们先来审视一下隐式流程，看看为什么它不够安全。\n<a name=g5GQE></a></p>\n<h1>为什么不能再使用隐式流程</h1>\n<p>OAuth 2.0 规范中一度包含了隐式流程，那时候单页应用在浏览器中受到的限制比较大，比如 JavaScript 不能访问浏览器的浏览历史、也不能访问本地存储。并且，那时候很多服务器也不接受跨站 POST 请求，导致单页应用没法通过 /token 端点获取到令牌，从而整个授权码流程不能正常运行。<br />我们假想一个单页应用“哈德韦”，使用隐式许可流程接入微信登录，那么流程会是以下这样：\n<img src=\"https://cdn.nlark.com/yuque/__mermaid_v3/fd34f6d1f9079f353a22b553435082b0.svg#lake_card_v2=eyJ0eXBlIjoibWVybWFpZCIsImNvZGUiOiJzZXF1ZW5jZURpYWdyYW1cbiAgICBhdXRvbnVtYmVyXG4gICAgXG4gICAgcGFydGljaXBhbnQgUk8gYXMgXCLotYTmupDmi6XmnInogIU8YnIgLz7vvIjkvaDvvIznlLHmtY_op4jlmajmiJbogIXmiYvmnLrku6PnkIbvvIlcIlxuICAgIHBhcnRpY2lwYW50IENBIGFzIFwi5a6i5oi356uv5bqU55SoPGJyIC8-77yI5ZOI5b636Z-m77yJXCJcbiAgICBwYXJ0aWNpcGFudCBBUyBhcyBcIuaOiOadg-acjeWKoeWZqDxiciAvPu-8iOW-ruS_oe-8iVwiXG4gICAgcGFydGljaXBhbnQgUlMgYXMgXCLotYTmupDmnI3liqHlmag8YnIgLz7vvIjlvq7kv6EgQVBJ77yJXCJcblxuICAgIFJPIC0-PiBDQSA6IOeCueWHu-S9v-eUqOW-ruS_oeeZu-W9lSBcbiAgICBDQSAtLT4-IFJPIDog6Lez6L2s5Yiw4oCm4oCmXG4gICAgUk8gLT4-IEFTOiDigKbigKblvq7kv6HnmoTmiavnoIHnmbvlvZXpobXpnaJcbiAgICBBUyAtLT4-IFJPOiDlsZXnpLrkuoznu7TnoIFcbiAgICBSTyAtPj4gUk86IOaJq-eggVxuICAgIFJPIC0-PiBBUzog5omL5py66YCa55-l5b6u5L-h5L2g5bey5omr56CBXG4gICAgbm90ZSByaWdodCBvZiBBUzog6aqM6K-B55So5oi3XG4gICAgQVMgLS0-PiBSTzog5bim552A5Luk54mM6Lez6L2s5Yiw4oCm4oCmXG4gICAgUk8gLT4-IENBOiDigKbigKblk4jlvrfpn6bnmoTpobXpnaIgIzM1O2FjY2Vzc190b2tlbj1hYmMxMjNcbiAgICBub3RlIHJpZ2h0IG9mIENBOiDku44gVVJMIOS4reiOt-WPluWIsOiuv-mXruS7pOeJjFxuICAgIENBIC0-PiBSUzog5bim5LiK5Luk54mM6L-b6KGMIEFQSSDor7fmsYJcbiAgICBub3RlIHJpZ2h0IG9mIFJTOiAg6aqM6K-B5Luk54mMXG4gICAgUlMgLS0-PiBDQTogQVBJIOWTjeW6lFxuXG4iLCJ1cmwiOiJodHRwczovL2Nkbi5ubGFyay5jb20veXVxdWUvX19tZXJtYWlkX3YzL2ZkMzRmNmQxZjkwNzlmMzUzYTIyYjU1MzQzNTA4MmIwLnN2ZyIsImlkIjoidGhxVmwiLCJtYXJnaW4iOnsidG9wIjp0cnVlLCJib3R0b20iOnRydWV9LCJjYXJkIjoiZGlhZ3JhbSJ9\" alt=\"\">\n注意当你认证完成，授权服务器（微信）在响应回客户端应用（哈德韦）时，会在 URL 上直接带上令牌。这时候，微信并不能确认是否真的是浏览器（期待的接收者）接收到了令牌，更糟的是，多数浏览器或者插件支持同步浏览历史，这会导致令牌泄露。为了缓解这个问题，一般支持隐式流程的授权服务器，都会通过 #token=xxx 的方式将令牌返回到客户端应用（在授权链接中通过 response_mode=fragment 指定），因为#后面的部分不会被发送服务器，仅存在浏览器端，但是这仍然不够安全。<br />隐式许可的授权链接结构如下：</p>\n<p><a href=\"https://dev-micah.okta.com/oauth2/default/v1/authorize\">https://dev-micah.okta.com/oauth2/default/v1/authorize</a>?\nclient_id=0oapu4btsL2xI0y8y356\n&#x26;redirect_uri=<a href=\"http://localhost:8080/callback\">http://localhost:8080/callback</a>\n&#x26;response_type=id_token token\n&#x26;response_mode=fragment\n&#x26;state=SU8nskju26XowSCg3bx2LeZq7MwKcwnQ7h6vQY8twd9QJECHRKs14OwXPdpNBI58\n&#x26;nonce=Ypo4cVlv0spQN2KTFo3W4cgMIDn6sLcZpInyC40U5ff3iqwUGLpee7D4XcVGCVco\n&#x26;scope=openid profile email</p>\n<p>响应（跳转链接）结构如下：</p>\n<p><a href=\"http://localhost:8080/callback#\">http://localhost:8080/callback#</a>\nid_token=eyJraWQiOiI3bFV0aGJyR2hWVmx...\n&#x26;access_token=eyJraWQiOiI3bFV0aGJyR2...\n&#x26;token_type=Bearer\n&#x26;expires_in=3600\n&#x26;scope=profile+openid+email\n&#x26;state=SU8nskju26XowSCg3bx2LeZq7MwKcwnQ7h6vQY8twd9QJECHRKs14OwXPdpNBI58</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 39.86486486486486%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsTAAALEwEAmpwYAAABGklEQVR42o3OzUrDQBAA4H0USdrND422il4KvehFQaRpzM9GKwg+gw8hMYcaT/aiqCDJ7OymLTFC9dEkbS16kXzMMIf5YUhnyzR22t3e/l63Z23vGlZboQbVTKWhK9RUm6ZKTZUaKjU2VKo0tKZuUb3V2uxohkVsl/WdwPZDx2cDL7B95jns+uDcD8NgyNhF6IXMdgPHD/uOd3h8cmR79qk/vLxy2RlB5HyRvKrIhfi4f54+pbMS5/Ps8wuLQgBULUQEAMgyAOALBBHFEiJKMXt8m76kfCKRI4AAqO6uuuvJn3GCawJFCvlryqXAamEV/yD8r+VDWA+RUuZ5PvkVUkpeDxklyeguieI4iuPbOL6JoofxuHwvixq+AUH0FNBPyADzAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/dd249cd0331fe8a072aae60f9b2c08af/fcda8/1693220613123-e8ea779e-9bf2-4acb-aa2f-d5ee390b0355.png\"\n        srcset=\"/static/dd249cd0331fe8a072aae60f9b2c08af/12f09/1693220613123-e8ea779e-9bf2-4acb-aa2f-d5ee390b0355.png 148w,\n/static/dd249cd0331fe8a072aae60f9b2c08af/e4a3f/1693220613123-e8ea779e-9bf2-4acb-aa2f-d5ee390b0355.png 295w,\n/static/dd249cd0331fe8a072aae60f9b2c08af/fcda8/1693220613123-e8ea779e-9bf2-4acb-aa2f-d5ee390b0355.png 590w,\n/static/dd249cd0331fe8a072aae60f9b2c08af/efc66/1693220613123-e8ea779e-9bf2-4acb-aa2f-d5ee390b0355.png 885w,\n/static/dd249cd0331fe8a072aae60f9b2c08af/c83ae/1693220613123-e8ea779e-9bf2-4acb-aa2f-d5ee390b0355.png 1180w,\n/static/dd249cd0331fe8a072aae60f9b2c08af/23d36/1693220613123-e8ea779e-9bf2-4acb-aa2f-d5ee390b0355.png 2354w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span><br />如果不用隐式流程，对于单页应用，那该怎么办呢？其实可以使用 PKCE，它的全称是 Proof Key for Code Exchange，做为授权码流程的扩展，已经被广泛用在了手机原生应用上。\n<a name=dXId2></a></p>\n<h1>使用 PKCE 来让应用更安全</h1>\n<p>PKCE 有单独的规格说明，它让使用<strong>公开客户端</strong>的授权码流程更加安全。在理解这一点前，我们先来看看不用它的话为什么不够安全。这里提到了公开客户端，也就是这种客户端在授权服务器的应用列表里，只有 client id，没有 client secret。在原生应用场景里，当授权服务器将授权码返回给应用时，会调用它的 Scheme URL，来唤起该应用。但这时如果有恶意应用通过向手机注册同样的 Scheme URL 来冒充它，那么授权码就可能被该恶意应用截获，从而抢在真正的应用之前向授权服务器换取令牌（因为没有 client secret，而 client id 又是可以通过网络抓包获取到的，从而只需要通过 client id 加上授权码换取令牌）。<br />所以 PKCE 流程，会利用动态生成的秘密值在发起整个授权码流程之前做一些准备工作，并且在授权码的流程结束附近处增加验证环节，让接收授权码的应用证明它就是发起整个流程的那个应用。<br />具体来说，应用在发起流程前，生成一个随机值，称为code verifier。应用将该值 hash 之后，即成为 code challenge。然后，应用像普通的授权码流程一样，发起整个流程，只是在查询字符串里带上了 code challenge，一并发往授权服务器。授权服务器会存储 hash 后的 code challenge，在后面校验时会用到。当用户验证成功后，授权服务器把授权码发回应用。<br />应用收到授权码，会再次发起请求以换取令牌，但是要带上 code verifier（虽然不需要传递固定的 client secret 了，但是需要传递一个动态的 secret，code verifier 就相当于动态的 secret）。现在授权服务器可以 hash 这个 code verifier，并且和它之前存储起来的 hash 过后的值进行比较，如果一致，验证就通过，正常返回令牌。这是一个非常有效的使用动态密钥代替静态密钥的机制。<br />这个流程最初只被运用在原生应用场景，因为那时候的浏览器和多数的授权服务器都不支持 PKCE。但是现在这个情况已经改变了，浏览器和授权服务器都可以支持 PKCE。<br />这样的流程图如下所示：\n<img src=\"https://cdn.nlark.com/yuque/__mermaid_v3/9a921f1250bfbb2da11ff41939a910d7.svg#lake_card_v2=eyJ0eXBlIjoibWVybWFpZCIsImNvZGUiOiJzZXF1ZW5jZURpYWdyYW1cbiAgICBhdXRvbnVtYmVyXG4gICAgXG4gICAgcGFydGljaXBhbnQgUk8gYXMgXCLotYTmupDmi6XmnInogIU8YnIgLz7vvIjkvaDvvIznlLHmtY_op4jlmajmiJbogIXmiYvmnLrku6PnkIbvvIlcIlxuICAgIHBhcnRpY2lwYW50IENBIGFzIFwi5a6i5oi356uv5bqU55SoPGJyIC8-77yI5ZOI5b636Z-m77yJXCJcbiAgICBwYXJ0aWNpcGFudCBBUyBhcyBcIuaOiOadg-acjeWKoeWZqDxiciAvPu-8iOW-ruS_oe-8iVwiXG4gICAgcGFydGljaXBhbnQgUlMgYXMgXCLotYTmupDmnI3liqHlmag8YnIgLz7vvIjlvq7kv6EgQVBJ77yJXCJcblxuICAgIFJPIC0-PiBDQSA6IOeCueWHu-S9v-eUqOW-ruS_oeeZu-W9lSBcbiAgICBub3RlIHJpZ2h0IG9mIENBOiDnlJ_miJDpmo_mnLrlgLzvvIw8YnIgLz7lubblk4jluIzkuYtcbiAgICBDQSAtLT4-IFJPIDog6Lez6L2s5Yiw4oCm4oCmXG4gICAgUk8gLT4-IEFTOiDigKbigKblvq7kv6HnmoTmiavnoIHnmbvlvZXpobXpnaLvvIzluKbkuIrlk4jluIzlkI7pmo_mnLrlgLxcbiAgICBub3RlIHJpZ2h0IG9mIEFTOiDlrZjlgqjlk4jluIzlgLxcbiAgICBBUyAtLT4-IFJPOiDlsZXnpLrkuoznu7TnoIFcbiAgICBSTyAtPj4gUk86IOaJq-eggVxuICAgIFJPIC0-PiBBUzog5omL5py66YCa55-l5b6u5L-h5L2g5bey5omr56CBXG4gICAgbm90ZSByaWdodCBvZiBBUzog6aqM6K-B55So5oi3XG4gICAgQVMgLS0-PiBSTzog5bim552A5o6I5p2D56CB6Lez6L2s5Yiw4oCm4oCmXG4gICAgUk8gLT4-IENBOiDigKbigKblk4jlvrfpn6bnmoTpobXpnaIgXG4gICAgbm90ZSByaWdodCBvZiBDQTog5LuOIFVSTCDkuK3ojrflj5bliLDmjojmnYPnoIFcbiAgICBDQSAtPj4gUlM6IOivt-axguS7pOeJjFxuICAgIG5vdGUgb3ZlciBDQSwgUlM6IOivt-axguWMheWQqzxiciAvPkNsaWVudCBJROOAgeWTiOW4jOWJjeeahOmaj-acuuWAvOOAgeS7peWPiuaOiOadg-eggVxuICAgIG5vdGUgcmlnaHQgb2YgUlM6IOmqjOivge-8mjxiciAvPi0gQ2xpZW50IElEPGJyIC8-LSDlk4jluIzkvKDpgJLmnaXnmoTlgLzlubbkuI7liY3pnaLlrZjlgqjnmoTlgLzmr5TovoM8YnIgLz4tIOaOiOadg-eggVxuICAgIFJTIC0tPj4gQ0E6IOi_lOWbnuS7pOeJjFxuICAgIENBIC0-PiBSUzog5bim5LiK5Luk54mM6L-b6KGMIEFQSSDor7fmsYJcbiAgICBub3RlIHJpZ2h0IG9mIFJTOiAg6aqM6K-B5Luk54mMXG4gICAgUlMgLS0-PiBDQTogQVBJIOWTjeW6lFxuXG4iLCJ1cmwiOiJodHRwczovL2Nkbi5ubGFyay5jb20veXVxdWUvX19tZXJtYWlkX3YzLzlhOTIxZjEyNTBiZmJiMmRhMTFmZjQxOTM5YTkxMGQ3LnN2ZyIsImlkIjoiRncxRzUiLCJtYXJnaW4iOnsidG9wIjp0cnVlLCJib3R0b20iOnRydWV9LCJjYXJkIjoiZGlhZ3JhbSJ9\" alt=\"\"><a name=H4UwD></a></p>\n<h1>写个测试来验证下</h1>\n<p>纸上得来终觉浅，绝知此事要写个测试。和上次《<a href=\"https://zhuanlan.zhihu.com/p/621445646\">OIDC （OAuth 2.0）授权码许可流程详解：纸上得来终觉浅，绝知此事得写个测试 - Jeff Tian的文章 - 知乎 </a> 》一样，我们还是来写个完整的端到端自动化测试。同样还是选用 Duende IdentityServer 作为授权服务器，完整的代码提交见： <a href=\"https://github.com/Jeff-Tian/IdentityServer/commit/d9c3afa78eb16318b4ff8d6be7d7c1d249b1f1b4\">https://github.com/Jeff-Tian/IdentityServer/commit/d9c3afa78eb16318b4ff8d6be7d7c1d249b1f1b4</a>。<br />在写测试时就碰到了一些细节问题，这里重点提一下。\n<a name=zJjwJ></a></p>\n<h2>哈希算法是可以选择的</h2>\n<p>首先，在上面的流程介绍里提到了哈希(随机值)=code challenge，这里的随机值就是 code verifier。但是哈希算法是可以有多种的，它在构造授权链接时，通过 code_challenge_method 指定，常用的是 S256。比如一个典型的 PKCE 授权链接是：</p>\n<p><a href=\"https://dev-micah.okta.com/oauth2/default/v1/authorize\">https://dev-micah.okta.com/oauth2/default/v1/authorize</a>?\nclient_id=0oapu4btsL2xI0y8y356&#x26;\nredirect_uri=<a href=\"http://localhost:8080/callback&#x26;\">http://localhost:8080/callback&#x26;</a>\nresponse_type=code&#x26;\nresponse_mode=fragment&#x26;\nstate=MdXrGikS5LACsWs2HZFqS7IC9zMC6F9thOiWDa5gxKRqoMf7bCkTetrrwKw5JIAA&#x26;\nnonce=iAXdcF77sQ2ejthPM5xZtytYUjqZkJTXcHkgdyY2NinFx6y83nKssxEzlBtvnSY2&#x26;\ncode_challenge=elU6u5zyqQT2f92GRQUq6PautAeNDf4DQPayyR0ek_c&#x26;\ncode_challenge_method=S256&#x26;\nscope=openid profile email</p>\n<p>除了 S256，还有 plain，在上面的测试代码中，为了略简单一点，没有使用 S256，而是使用了 plain，即 plain(随机值) = 原来的随机值，即 code verifier 和 code challenge 的值是一样的。但是注意，使用 plain，其实没有安全保证，所以默认禁止的：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/fdb75d7b0e6bd6534d5efb00f9ec565e/37f12/1693224275538-068dd5de-87df-4fc5-9a55-1555a0976b73.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 54.05405405405405%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAACHUlEQVR42lWT647bNhCF9SptvbpRlIakJF4k2Ssn3vW6CdIWCXLd5P2f4issL7bojw9nMAMcHhLD7LzueXdI/LkuzFNi9AHbD3TG0nZCawTdCcb1dGLoRLa+dT1iLGMIaGs5DgO9WDKlW8Q4Bu/Ji4KqqjbyPGe326GaFiVCrTVaVXStotM10ioaVVKWBXVVUNUldV2Qaa0xYjifzyzLgnMOay1FWWymbatxweMHw+g0zjQ4aejNFc1gNaPVdM3tkKxpGsQKp9OJeZ43MxHZUv6+y7mrDNoO6Lmm1g1lpbkrKnb5f/xxV26aF4pMqYYYE8MwcDW/Jm6UoiwKgvzGl7cFP75XPH9s+HFR/LxUPD9V/Hzh+ank10Xx/SHn03F3SxhSYL/fb1cO10duNWINb6Pm2zfF538sXx4dX9/1fHoQ/l4Vfx0bPqyKD2u91e/3BY9TTmasJaXENE2vxBgYncc/GWTpaJSj1h11I1SNUNYtRaX/T91u/VfD9GIWYiAMgcN7y3xx2M4h0iLSbZhX5KZGbrzMM9f3xBjZx2vKSO9G4puOdFE46XFDj2z7ZxCxr/V1HztzU+nk1u8MmRjDvJ44vHlkOhyJxzP79Uia7gnzyrjc008H0rISl5Xh/oEwHxjnPePxhE+JYb7OjsRpT2aMxfkZm1ZcmLefMviAj4noRyY/Ev3AYQosyTOnm05hZEmRJY54P9LHBe8D/wI3XmMeCq3AQAAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/fdb75d7b0e6bd6534d5efb00f9ec565e/fcda8/1693224275538-068dd5de-87df-4fc5-9a55-1555a0976b73.png\"\n        srcset=\"/static/fdb75d7b0e6bd6534d5efb00f9ec565e/12f09/1693224275538-068dd5de-87df-4fc5-9a55-1555a0976b73.png 148w,\n/static/fdb75d7b0e6bd6534d5efb00f9ec565e/e4a3f/1693224275538-068dd5de-87df-4fc5-9a55-1555a0976b73.png 295w,\n/static/fdb75d7b0e6bd6534d5efb00f9ec565e/fcda8/1693224275538-068dd5de-87df-4fc5-9a55-1555a0976b73.png 590w,\n/static/fdb75d7b0e6bd6534d5efb00f9ec565e/efc66/1693224275538-068dd5de-87df-4fc5-9a55-1555a0976b73.png 885w,\n/static/fdb75d7b0e6bd6534d5efb00f9ec565e/c83ae/1693224275538-068dd5de-87df-4fc5-9a55-1555a0976b73.png 1180w,\n/static/fdb75d7b0e6bd6534d5efb00f9ec565e/37f12/1693224275538-068dd5de-87df-4fc5-9a55-1555a0976b73.png 3750w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>尽管不推荐，但在自动化测试场景下，这可以通过设置 AllowPlainTextPkce为会 true，来让测试运行起来。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 47.972972972972975%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABcklEQVR42nVSW24bMQz0MfpRtLZIinpL+7IbJEXzmd6h97/GFJK3QdZFPgYzWomzQ1GnXAqstfh+PoOUQMq4MMOIoLQJpTWkXEDEOJsLUkoQkaFtiNBYQaIwYuBjwMk5Nw4QE0QYohZaCjRnxHlBqAUxVVj1IDJQVQjzCOFDgA8RznuIlYFT3+joB9XasRnaBM0FogpzMTDGjITEAkN018Rg5mHeA1mxg0/d6GCqipQjrmvDbW24LhU/toanbdfrHV3H4EediN35E8PgFEtNWFpHxrrzMmVsc8E6lcFzTXD9CnrC3eNgOEydg8YIcR5sFdwLfBiaiA4t079293T/J+ysijjPSOuGOE0IrSFfb2Ptgh93rGoPIT5iGMrHhDGi/npFeX5BeXpBuf0cQ/KtQTVDbYWwvid6xImtBfVn0z+og+0J+pRruyNnMCWU39+w/PmC/PYVdjYw3GsYho94GIp9f2ePf9YgcIXhKyNs9GnLfwFFoyY+kG6kEwAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/4bc688aa1ef49bc957e92b3e4de1b50d/fcda8/1693224350317-440bd6bf-e41f-4cde-a2ca-85f734502c40.png\"\n        srcset=\"/static/4bc688aa1ef49bc957e92b3e4de1b50d/12f09/1693224350317-440bd6bf-e41f-4cde-a2ca-85f734502c40.png 148w,\n/static/4bc688aa1ef49bc957e92b3e4de1b50d/e4a3f/1693224350317-440bd6bf-e41f-4cde-a2ca-85f734502c40.png 295w,\n/static/4bc688aa1ef49bc957e92b3e4de1b50d/fcda8/1693224350317-440bd6bf-e41f-4cde-a2ca-85f734502c40.png 590w,\n/static/4bc688aa1ef49bc957e92b3e4de1b50d/efc66/1693224350317-440bd6bf-e41f-4cde-a2ca-85f734502c40.png 885w,\n/static/4bc688aa1ef49bc957e92b3e4de1b50d/c83ae/1693224350317-440bd6bf-e41f-4cde-a2ca-85f734502c40.png 1180w,\n/static/4bc688aa1ef49bc957e92b3e4de1b50d/4ca46/1693224350317-440bd6bf-e41f-4cde-a2ca-85f734502c40.png 1944w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n<a name=S6tz1></a></p>\n<h2>code challenge 是有长度要求的</h2>\n<p>本来为了简单省事，将 code challenge 设置成了 123，结果得到了 code_challenge is either too short or too long错误：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2b566c8ddd5eb0888ecb91e88d78ad9a/0a61a/1693224533276-ef19cee3-42fa-4993-a60f-af0791945fa9.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50.67567567567568%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB4ElEQVR42l2SWY6cQBBEucyw1b4CTUEvgKdl2b7/bZ4FI9uSP0KRypKyMiKy2tbCUUa2MjHkRAgRYx1KG4RSaG9RWuO8R2uNMV99aR0uBnxKOGuYnMP6RCW1wbrAbS70fY8Q4kJd19QfNVJblNEoJXFa4I1AyQ4pxYVW9HR9Ryd6QjBU54/WGt7vN/d1JYSAc462banrBm08KgSM1XirCNYQrlpjlETJc4EeKXqMkVRKKZx3PB4PhmHAWntJa5qG+uMDaT06ZazWWCWJoyDkHqsl3sqLz2F939G2HVXfC+a5kHO+/DmHdV134ZRtlSMEj5sE+dnjxgYlG6Ro/0KJFi07jBZfG6YhUcrMsiyM44j3jjEPpJh5fSYePzXlUJQSSUYRTI//D8EKtBJUp1/jeGMYpwsxJkLMxNVx+6VJ+5m0RgqDlBqtDeoM6mT1rz7DFVJShZTwy5txeROWT9T8xs0b4fuCWHea9I0m7XTDQTt8oxk+adOLejxoxp0mPmnzgRgOpAlUMWWGsjFuP8jLxvQ4mJcnc9kpy4tyv3Nb72zPJ/fnxvLamdc782vn8XpxXxemx86tPK/zq+wleaJMhTycvkVCjMQYyNETnf06lT98nsxZO0t05np31mKtuwL9DTLLPf2rTTdHAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/2b566c8ddd5eb0888ecb91e88d78ad9a/fcda8/1693224533276-ef19cee3-42fa-4993-a60f-af0791945fa9.png\"\n        srcset=\"/static/2b566c8ddd5eb0888ecb91e88d78ad9a/12f09/1693224533276-ef19cee3-42fa-4993-a60f-af0791945fa9.png 148w,\n/static/2b566c8ddd5eb0888ecb91e88d78ad9a/e4a3f/1693224533276-ef19cee3-42fa-4993-a60f-af0791945fa9.png 295w,\n/static/2b566c8ddd5eb0888ecb91e88d78ad9a/fcda8/1693224533276-ef19cee3-42fa-4993-a60f-af0791945fa9.png 590w,\n/static/2b566c8ddd5eb0888ecb91e88d78ad9a/efc66/1693224533276-ef19cee3-42fa-4993-a60f-af0791945fa9.png 885w,\n/static/2b566c8ddd5eb0888ecb91e88d78ad9a/c83ae/1693224533276-ef19cee3-42fa-4993-a60f-af0791945fa9.png 1180w,\n/static/2b566c8ddd5eb0888ecb91e88d78ad9a/0a61a/1693224533276-ef19cee3-42fa-4993-a60f-af0791945fa9.png 3822w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>这才了解到，其实 code challenge 是有长度要求的，感谢<a href=\"http://gk.link/a/1291Y\">王新栋老师在极客时间的专栏中</a>（<a href=\"http://gk.link/a/1291Y\">http://gk.link/a/1291Y</a>）提醒，code verifier 的长度必须在 43 到 128 个字符之间。<br /><a href=\"http://gk.link/a/1291Y\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.75675675675676%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAAByElEQVR42q2S607bQBCF/f5v0AeoBEpDK2xAQgK18Aq0lVChUUMVJ8SX2nu/+Kt206Dkfy0dzfh453jO7BTX5SfmsxnVxSU3N7dcXV1RVRecnX3k5OSU2WxOWVacn5f/UHFeVpnb4YL3J+/4MD+lLC8pIKKkwDnL/3iKUUi22y2b1y19vSAMK7zVhBCIMeK9R2mDMRatTc6t9Whtsc4TQiREMnwIFIlw1jEl+fYnfvVAnCamKTN45xj+tIxDR99tGPotwckMb+VBLpiip0gFfT+gjcUE8JDF9oJWtrx8LXn5VrF5vmP9dM/m+Z710x31jy/8fvzM8vsti4dr1PhKocTIcvkLay0heKYYjwSdVaxfHuk2C6zVKKXQWuOcy/n+PSG5LYwxjOP4JrAXe7PsQ3bQJXQdq7qm6/o801GIXKuURkqZ514orfOBuKs/EotxyoJSiqNOUhP7mARTLoTIF1gYrRiammhGcIrJ24NuyX9t25aubfM2NE1D0+xi6rjvuswPw5DHVcTg8EYRvc1IN8VBlymqvC4aqdQOUmVuv0bpm8iWI4U2hrpeZ9vJVnQmyRzZTkVCKoTSjFIxSpmx4xTKWKQ2eQ//AicpRdRHgvplAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/d66ed27d58bdf067043c3ed63b4d4226/fcda8/1693224889568-bf293cd9-0343-4912-9e10-320cab49d68b.png\"\n        srcset=\"/static/d66ed27d58bdf067043c3ed63b4d4226/12f09/1693224889568-bf293cd9-0343-4912-9e10-320cab49d68b.png 148w,\n/static/d66ed27d58bdf067043c3ed63b4d4226/e4a3f/1693224889568-bf293cd9-0343-4912-9e10-320cab49d68b.png 295w,\n/static/d66ed27d58bdf067043c3ed63b4d4226/fcda8/1693224889568-bf293cd9-0343-4912-9e10-320cab49d68b.png 590w,\n/static/d66ed27d58bdf067043c3ed63b4d4226/efc66/1693224889568-bf293cd9-0343-4912-9e10-320cab49d68b.png 885w,\n/static/d66ed27d58bdf067043c3ed63b4d4226/c83ae/1693224889568-bf293cd9-0343-4912-9e10-320cab49d68b.png 1180w,\n/static/d66ed27d58bdf067043c3ed63b4d4226/e80ec/1693224889568-bf293cd9-0343-4912-9e10-320cab49d68b.png 2582w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></a><br />我们现在使用了 plain，所以 code challenge 也应该在这个长度。于是我设置成了 1234567890123456789012345678901234567890123正好长度是 43，通过了测试。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.02702702702703%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB2klEQVR42k2S6W7bMBCE9TCWxPsQZYu6LMtunKZB8/5v8xWUg6A/BthdkrODGVb368Q+XdjHC10MWGtRStMKQd00CCVo2xapFE3b0oiWum2ohURIhfcBJTVCCrS2VMZ5nI8s6xVtDMaYg1RKSV3XqNI7h7KO1moaJai/IYRCCo1RFiEkMRqqEIoqw/v7k33fSSnRdd2hqD6dELHD5Uy6lJmkbZoflIUvnDidarRqqax1+OC53W7kIVMWxBAwUh2Xc98zDQPn6ElBkzpD31mUFMd50zQHSt22gqr4NU4zeXyRee9RSh4PhBDEFIgpErsOnyI6OqSWPyT/ExqjqKxRnC8Xch5Z5oWcMy72nMf18NI4i7bmsKUsk1IdBCWo/1E8V0pR+WEjRssw9ITo8N4SoicEjzH6WNB1PS70+BCJ8aX2sCa++lcOFq01Vco7yiWm/ZPb84vL8oZJKyrMhJR5Pt9Ybx/k7Yv1/pfr/YN9v3PdHqz7B/NyZZomhmHAOUcVg0Npj7Yd1ieMS0etbIcPHdu2kZdfnJc/jNsn0/ab9boxLxvj+saQZ/q+p+/Ph8oqhIgsn/I7iBJIqcsseM/j8WDe3plvn8zbk/n6YPr2eiph5sxlGDkP06HwHwDoOQNMrX7zAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/743c50a3fb1c23727a5137f3f8fa5eea/fcda8/1693225409659-aa5fca44-5490-4e8c-9137-d9fd230c4e08.png\"\n        srcset=\"/static/743c50a3fb1c23727a5137f3f8fa5eea/12f09/1693225409659-aa5fca44-5490-4e8c-9137-d9fd230c4e08.png 148w,\n/static/743c50a3fb1c23727a5137f3f8fa5eea/e4a3f/1693225409659-aa5fca44-5490-4e8c-9137-d9fd230c4e08.png 295w,\n/static/743c50a3fb1c23727a5137f3f8fa5eea/fcda8/1693225409659-aa5fca44-5490-4e8c-9137-d9fd230c4e08.png 590w,\n/static/743c50a3fb1c23727a5137f3f8fa5eea/efc66/1693225409659-aa5fca44-5490-4e8c-9137-d9fd230c4e08.png 885w,\n/static/743c50a3fb1c23727a5137f3f8fa5eea/c83ae/1693225409659-aa5fca44-5490-4e8c-9137-d9fd230c4e08.png 1180w,\n/static/743c50a3fb1c23727a5137f3f8fa5eea/2bfae/1693225409659-aa5fca44-5490-4e8c-9137-d9fd230c4e08.png 3804w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n<a name=InBoU></a></p>\n<h1>墙裂安利</h1>\n<p>最后，为王新栋老师在极客时间的《OAuth 2.0 实战课》打个广告，我已经反复学了 3 遍并且还时不时复习，受益匪浅，欢迎大家一起加入学习（<a href=\"http://gk.link/a/1291Y\">http://gk.link/a/1291Y</a>）！<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 177.7027027027027%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAkCAIAAAAGkY33AAAACXBIWXMAAAsTAAALEwEAmpwYAAAGw0lEQVR42j2WSW8cxxXH54Pkkmu+Si65JQcjNhLJOcRAAjiIJFoWKQmxpGixaCcOZUs0RYm7RA7FGc7G4ewzve9V1V1L792zkBRJIx8g6JnIwEPdfm+p9/6vKqf0oNKDchfonGPw2BSIJVJLopbEoOxC2QWZMSAxUw4sybVEagpE57DaRzm1j0yJee4Eab7BE1Oklsig4iLFs9UPpgW2THHrWOlqfFvnWprQNnTOyWU+ZOv+g3s3r12zZHxU7HTrgmOEBMQMJlOLMUiwSr39laP9Uv5t5WC3Uiu2DB7niBk/+3b1V7/45Se/+bXUkbpNWRyYEmcZKhUHpswDRYDI8CmKMUwpSilIiB7Zqm+JNGervtgx735xZ/XFum2FquSYGrUMagPf0imyXGAwYofMSTIeRA4IbSOwVR/Kbg7KLjGjkJ15ZEJQzJzUxalLhh4bBe54Zj4beWzIcELsBMMoc2GGtubnsB7aZoB03yWpR0ehNw79SRyceHQ4I0Nv7JIhsWOXpAyn1IkdEDlWxuewFR0fCvUCl9+sCz1r0DLerJZlzhZ7oHes9Y61QVM/KnI7q+V+Q3/+dKd20F96tPFq6Z3PxjkC46Mi9277eGvlcHe9tv2ytLdW6ze0dl1plIXjQ57vWKW99sp3b99t15892TjYaSw9Xt9cLgZsnKN2giwfml7onxA7ZjiZJUxgSGDkOim1Y4IigiLb9DEIbcu3ge8An9pxjqDYY0PXDpBoNcuD+n69XWrXigOupbVqQqPKH7w5blb42kF3f/vocK/VKPPQ9ENvnMHUSQjwiQbd4zJ4u2oJpmP5thlQlGAQOqaPDJ/A2FKZIRFToUBjGIYuThlOMjhi8Vk7/7688lP1x7PRRRpdjJKLUfx+nLwfp+fj9HyUXIyTi2H8PgnPYv/Up6P/wy5Ne3Wp9fx78fUyt/aqWxOH6cUkvRyn55PhxWQ4Oy/G6eUwPk+jjI/8k8AdM5zmAjZa+HzxLx/PL3w6d/3q7RufPUqCs9PJf09Gl6fjy5PR5YfgGZxFDk5Db+KzkZtFJsNWVTx82yrudd/tNI5LnItTn44Yjj2S+HQ4hS9HycUs7M/wtGY7xih0SWqqxFAIQZEqILFnCj1L7FuqgCbDn0YfCp7lHHoTj2bTmrXKVKjYs4Se2WsoXMegToxMzwGBh4dQd3XJIXY8Si7i4PTngrNRdZIchrGlMYWHCgcdGBgysVRqyESXHF1ybMu31Kw9SXg2TM5j/0PBJKV2ksMggyUOyhzEMAS6iwwP6K6lMpW3dQnLHFQFG8NsyGZSmSokISjKhGFIlGsbmuRoYhYNGd4smqlSrq1zbV3sW3zH4LsGw+nsqqiTaTPnmCGBUxmT4WyqQ28S+SdxcBIHp9m0JOdpdJbG7+PgdCZsjw7JdDHkHC3AIMIoodM1wHDiksy9zzJhT/OnLk4dEGYJ06GlMVVwMIgzPduKZ0rUkKgmEGh41MlSYjgJvLGpZOUoHOocya2q2G+qzYpYL/RrB/1B08AZrPr1g8Hmi8LL/+w2K+K0hyOPDj02BLrbrolc2+A7ZrMiVPa73brSKPHtmlza7SDFywHFbZXFSr5TLw4yO+SOigOZQ7MrsC0fGq4h4/rhQBdxqyLKPVB916vmu6ZAcpZI5B6UOiB7N/pQHiBpgIDm0mwNJCxbhqkq2PIA9htasyIKHUvpIaWHstVr8BhIDKm+owXEDCmMmJ1QlJCssdkOoXasCU6rKnXqcrsqtcqirflQcbOlb3COKTGkBbYRYSMmICEoJSAiIMYwJlOzzcDO/KZYD5HsQ8UHkps9N6ZAuCOpVejU881usd8vcYMq7xh+1j8QzXiGUkulMmeqnCX1Tb6j8S3V4HAG8xW+mW9Vd5u9w0G30O0WurYZOiDGKCHTfob05CB/ODd3Y3Fx8cnXT+YXbr1e3YCSl1MFGn71dPzX66OH/xr/4/HJtVvje0+jrUL6YDFafePCxDEDD49r5cbC7YX79x/MzX1x9eqV9VdbQGQ5pY/ktQL373V+ZV9YPVC+35aX96RCT90oKTs1sYeQ6nlo2Kh15hfml5ae3b1z98svb6693MzS1gb23Zs/XPnk7h8+Wrjxt29//7tbf756//PPHv3xo9t/+vjOld/OtStSQs8K+fL8wvzDh/+8d++ra9f/vrO5m8FKD+bXjl5+t/dqaX/zRfH10v7Gi+LWj6X1Hwobz4tbyyW1b3twVC0eP3n89evVtZXll98sflPIl/SBkxPbpsFjKDM0/Q04eoDNkFgRs2IXJC5IZq8pmv4Psh+D6gGJaQMkdaz/ATLBxlNNAJhZAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMG_1015.jpeg\"\n        title=\"IMG_1015.jpeg\"\n        src=\"/static/56c53c671e003d43c325f98a809795c9/1c72d/1693225698120-6ff0824e-6617-47c6-950f-bb63ce972142.jpg\"\n        srcset=\"/static/56c53c671e003d43c325f98a809795c9/a80bd/1693225698120-6ff0824e-6617-47c6-950f-bb63ce972142.jpg 148w,\n/static/56c53c671e003d43c325f98a809795c9/1c91a/1693225698120-6ff0824e-6617-47c6-950f-bb63ce972142.jpg 295w,\n/static/56c53c671e003d43c325f98a809795c9/1c72d/1693225698120-6ff0824e-6617-47c6-950f-bb63ce972142.jpg 590w,\n/static/56c53c671e003d43c325f98a809795c9/a8a14/1693225698120-6ff0824e-6617-47c6-950f-bb63ce972142.jpg 885w,\n/static/56c53c671e003d43c325f98a809795c9/fbd2c/1693225698120-6ff0824e-6617-47c6-950f-bb63ce972142.jpg 1180w,\n/static/56c53c671e003d43c325f98a809795c9/1ef88/1693225698120-6ff0824e-6617-47c6-950f-bb63ce972142.jpg 1242w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}},"menus":{}}},"staticQueryHashes":[],"slicesMap":{}}