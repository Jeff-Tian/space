{"componentChunkName":"component---src-templates-post-js","path":"/posts/cnrark/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/cnrark","relativePath":"posts/cnrark","frontmatter":{"title":"Keycloak 关注公众号即登录插件升级了！","stackbit_url_path":"posts/cnrark","date":"2021-09-07T06:11:17","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p><a name=tdVWN></a></p>\n<h1>体验链接</h1>\n<p><a href=\"https://uniheart.pa-ca.me/keycloak/login\">https://uniheart.pa-ca.me/keycloak/login</a></p>\n<p>请忍受二维码出现的速度很慢，因为使用的是免费资源……\n<a name=smml4></a></p>\n<h1></h1>\n<p><a name=LZrL3></a></p>\n<h1>背景</h1>\n<p>今年 2 月份发表的一篇专栏《<a href=\"https://zhuanlan.zhihu.com/p/349504145\">基于 keycloak 的关注公众号即登录功能的设计与实现</a>》，居然有人默默地认真看了，还通过<a href=\"https://www.zhihu.com/consult/conversation/1417107982655684608/archive\">付费咨询</a>频道，向我反映了这篇文章中的插件，在最新版本的 Keycloak 中使用时会报错。<br /><a href=\"https://www.zhihu.com/consult/conversation/1417107982655684608/archive\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 196.6216216216216%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAnCAYAAAAPZ2gOAAAACXBIWXMAAAsTAAALEwEAmpwYAAAFfklEQVR42o2WV3IbRxCGAQZFkkiLBUESDMggctwFFpEBVaLLliWWy5b94EedQHfTGXSp3/6GHBigaJcfemdnuufvNN0zoXg8rmTS1f7+viKRiA4ODhSNRlcUi8eUzrpKX6TM/zovGo0oEksqni4rkcoqFncUYvHk5ETZbFbpdFqnp6dPNkUN7+zszCh8ystls0rEI4oc7Jl5KBaL6fj42GwADHAYWA6Pf9ZPTzMPFsdihheNPvAymYwSCcfM4RnAvb09HR4e6urqamXFOqAF2gSMPisXYgFyXVfn5+ey83VKJBLPrj/HC718+VLQzs6Otre3ZecvXrzY+P8/hGwoHA6bydu3b/X69evvAHZ3d83amzdv/pPYGwqFoJAuLi707ds3ffnyxSSgXC6rUqmo2+3K8zyVSqV/ddkScdza2noAJLNfv37V58+fDeDl5aUBYWw2m+bYsOG/iIQYQOLGoWZ89eqVyThzS4SC0WaYU2CJIrCFsLKQGJIp3IRqtZrJNpZyPrGes8aco5XL5VYHvVgsqlAoGBkUrAA5MtfX17q9vTU0Go3k+776/b56vZ4ZB4OBOp2OFouFJpOJ2u22giDQzc2NMcJ6uQJEiE0IAkjsIOJoEzSdTo0iKzcej413hGnDZQDRDBBWsAFhRoD4x1J4s9lMw+HQEP9QMpncdJkFjgfa0UwscQcQrMRl6zYyKLFWo4zYkpwNCwGw2lGAIC4CShJs/PAC5ciwRqhSqdQmoAWwiWBkM0rINAeff4CIFQDIVatVo+Do6GgTMOW6Gvq+sQgLg9HIgBTyeTN2HhPVaDTMUamUy8rncwYQ1931GIY4h66rzmAgbzRSz/M0GI2UPsnoKJNRrlRSQHaDQPVWS9VmU7VmU5nzCyNzUSgolkxq3wJuh8PKu0nN2y0Nq5eatVsqH6V1F4x06w30Lhhp6XtmvvQGCmpVI3fT76uQcjUolZRPOjqMHCgMYDwc0jCd0i8317ob9PX78lY/Dn0FpaLamRNVko6umw0tO22z/mE60c/jQIt6TZNKWT/4nt77nlqxiLYBdLbCyqZcdUeB+sRvNle739dZLq+zXE4XhaIuGw3jarZY1Hi+kD8eq97pqNHpaDSbmXBV4lHtGsDtsHJOQu1OV5PxWLPpVKVi0SRiEgS6vlqYhDXrdZ0cHxsZK7e8vdViPtfQ81RLxLUDoLu9payTUKFSUbVWU5cDDECrpT4VQ0l6nhKOo8l0Zni9wUDT+VxNsg/4fK6W62gnHFZobyss33X063ikP2YTfeh39VOnpbtG3cz/vF7orlHT+25bv41H8k+O9K5eM+v33kD3/kDT81NVY9GHpIQez+F0HGg6Hsujw3Q6xkXGQa+nzPGx+r2u4edzOZUKBQXUs+cZ91NucvNgO9Sy76/qmVpuNJumguiFjuOYMps+NgN45UpF9UbDzA/T6e9r+e7ubtU9KEN6HPf0fD5f1Xi9XjeEYkYaB83Y3uX/WOg4xjJjxWP5MdJ0AaM50CQABwyF1Dr1zN1jr4YNC2FSl7QvgNEOAJtxmxrmv9VqGXBqG8X800BWFnLrsYB7dBQ6MA0BrShh43K5XHVpGgTu0gtRyJWBF3iJcQ/dJpUy7gFIBwHIWsKLDGsJibXYxhk+cni4mWXHMUwbR+JkXacbw8NCFNJQUUDSAEOWcDx7Bdi7wrZ/3EM74ACxTrIAYs3efBiykWXrst1kM4mFxMpmGGUoIN5cn1jPu8Ze9gaQDwmgja8TGxlJmF0jnqwzMieB3z1F+DBZf2I89/Rdf3gCilcQVgK+upf5YPJTQC5v3OFts06s2bfO03fO6hzyhODBCfEeZI2z9unTJ338+FH39/eG+GcNHjLI2n3mGfL3+/Avjn1DDghKqx0AAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/839f1496a3ed3d8f85eb1a8cb0131d99/fcda8/1630934654306-c617547a-4ca2-476d-a0ca-3e5f4d6457ac.png\"\n        srcset=\"/static/839f1496a3ed3d8f85eb1a8cb0131d99/12f09/1630934654306-c617547a-4ca2-476d-a0ca-3e5f4d6457ac.png 148w,\n/static/839f1496a3ed3d8f85eb1a8cb0131d99/e4a3f/1630934654306-c617547a-4ca2-476d-a0ca-3e5f4d6457ac.png 295w,\n/static/839f1496a3ed3d8f85eb1a8cb0131d99/fcda8/1630934654306-c617547a-4ca2-476d-a0ca-3e5f4d6457ac.png 590w,\n/static/839f1496a3ed3d8f85eb1a8cb0131d99/efc66/1630934654306-c617547a-4ca2-476d-a0ca-3e5f4d6457ac.png 885w,\n/static/839f1496a3ed3d8f85eb1a8cb0131d99/d9199/1630934654306-c617547a-4ca2-476d-a0ca-3e5f4d6457ac.png 960w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></a><br />看来 Keycloak 是一个非常活跃的开源项目，因为我在 2020 年开发关注公众号即登录插件时，Keycloak 版本号还是 7.0.0，但是现在已经升级到 15.0.2 了。</p>\n<p><a name=KMdLg></a></p>\n<h1>新版</h1>\n<p>在周末，我升级了该插件，在最新版本的 Keycloak 15.0.2 中测试通过。相关 mvn 包的配置和资源信息在这里： <a href=\"https://github.com/Jeff-Tian/keycloak-services-social-weixin/packages/225091?version=0.0.20\">https://github.com/Jeff-Tian/keycloak-services-social-weixin/packages/225091?version=0.0.20</a>。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/51018eb1a1a461fc8f45157ae0cbfa7c/6871f/1630989608105-ffc3a37f-22e3-46cc-8431-1b45fd62deb0.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.810810810810814%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAADIklEQVR42jXSXUibVxzH8eciiC9RzFRQISKKCArWqKhNEDfFF3yJJkWTQDVLptHYmBmnBmLtxA2Zd154011vF3u5GZvr1jZOq+xivdhgbMgmJSYxwa46jUqixuc7nmftgR/ncC4+nP//f4TIQegmEArx5+7f4u9/7PLX3guC4QMi0ShHR8fyee9FgEAwTDAUIRSOsL8fIhw6IBiOEAgesB+KiuH9AIG93aTw8OGnrK2tiaurq6ysrLC8vMzS0hIfLi6ysLCAb36e2dlZOR6PB5fLxcTEBGMOB/b37IyMjGCz2bFZh8ThuxYEn88ner1e3G63OD4+jsPhwGazYTabMBj6MRoMWMxm7twx0tryDjqtFq1Wi06no76+nsbGRurq6sTa2lqqbt0Shbm5OWZmZiQQp9PJ6OioDM5653mw9Am+Bx/jW/iIOd8iUzM+Jj1e7lrtNDU1yWloaEDCajQaqqqqEKanp5mammJsbAy73S5jAwMD/PL8OdKKx+MkEonXict329s7aDQaGdK8hiorK+UIUk+kUiVoeHgYi8VCf38/z7Z3uLiEo9MEx7FLjs+ueHWSIAk89W9QUVEhQ9JeXl5OWVkZpaWlCG96NjQ0hNlsxmg00tnZiX9jk3/Pkrw6veYods1xLMk/J5dc3sDjJ34ZeIOUlJRQVFREQUEBglSm1WplcHAQg8FAb28vbW1tbG094zwuchxLcHp+LUc6n13Box8fU6RWU1xcjFqtlqH8/Hzy8vIQpJeZTCb6+vro7u6mtbWVt5ubWH+yxXe/nvP5ZoSvfz6U89lmhPXfLvjqmx8oLMynsLBQhnJzc8nOziYrKwvBZDKJUpk9PT1ie3s7LS0taHU6/OvfwsUFZy9fchKNyokdHkpTYv3LL2QgJycHlUpFZmamqFQqSU9PFwWpTL1eL3Z0dMhYc3MzNTW17Gz45YkiJiF5BTdJEG/kq58efU+mUolK9RYSlJaWRmpqqqhQKBD0ev11V1eXhInSv2q8fZvq6mretdnx3b+PZ/oDXO73cbrcOO/dwzU5SY9eL0MZGRmkpKSgUCj+xwTh6j+cNEOcR/oeqgAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/51018eb1a1a461fc8f45157ae0cbfa7c/fcda8/1630989608105-ffc3a37f-22e3-46cc-8431-1b45fd62deb0.png\"\n        srcset=\"/static/51018eb1a1a461fc8f45157ae0cbfa7c/12f09/1630989608105-ffc3a37f-22e3-46cc-8431-1b45fd62deb0.png 148w,\n/static/51018eb1a1a461fc8f45157ae0cbfa7c/e4a3f/1630989608105-ffc3a37f-22e3-46cc-8431-1b45fd62deb0.png 295w,\n/static/51018eb1a1a461fc8f45157ae0cbfa7c/fcda8/1630989608105-ffc3a37f-22e3-46cc-8431-1b45fd62deb0.png 590w,\n/static/51018eb1a1a461fc8f45157ae0cbfa7c/efc66/1630989608105-ffc3a37f-22e3-46cc-8431-1b45fd62deb0.png 885w,\n/static/51018eb1a1a461fc8f45157ae0cbfa7c/c83ae/1630989608105-ffc3a37f-22e3-46cc-8431-1b45fd62deb0.png 1180w,\n/static/51018eb1a1a461fc8f45157ae0cbfa7c/6871f/1630989608105-ffc3a37f-22e3-46cc-8431-1b45fd62deb0.png 2688w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><a name=cltFa></a></p>\n<h1>前一个版本</h1>\n<p>在 Keycloak 7.0.0 中实测通过的插件版本是 0.0.6，其 mvn 包的配置以及资源信息在 <a href=\"https://github.com/Jeff-Tian/keycloak-services-social-weixin/packages/225091?version=0.0.6\">https://github.com/Jeff-Tian/keycloak-services-social-weixin/packages/225091?version=0.0.6</a>。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 68.91891891891892%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACoElEQVR42o2Ty0tbQRSH73/h/1A3IqKo+Db1CT5QSVB8JCKoBRVEEAWLm9Juu+iqS3FRsUKzaLtoKRQKLoqLLlTUqKkx5llINPcxc78yk/ikQgc+Zu7MPb8558w5xtTUFBMTExq/38/Y2Bjj4+OMjo4yMjKi99VeIBDA5/PR1dVFe3s7bW1tN3NLSwsNDQ3U1NRgKOPh4WFtrAy8Xi8DAwP09PTQ39+vhQYHB/U/SqypqYnm5mYaGxupr6/XIlVVVVRWVlJdXY0xPz/P6uoqKysrLC0tsby8zOLiIgsLC5q5uTlmZ2eZmZnh2fQ00wUmJyd1JAG/X1+qIlIXGMFgEDWklDw2XNd99MwREiFdUuk0nZ2d/yeYTqXIZTMgHFzb0mDbuLaNtExlTDIWw+Px3AqapqlFhRD3kRJpW1jRCFfRCLlohGw0Qip8or8vz89wknFi+7s6r8bW1pYWtNVtyvgBStBVmDnkVRbXcXDCIcydbVwpEMpzxyZxfk5tbW1eUBmapoUjBI4yuEF56SAf5FBcRHD2ft1LVSKZzJfN5uam3rByV9dPUADtXdZ0tId3h8xmEPGL/Lqwl0gkqKiowNjYeIcAon8uSV3aJC9tPSviGYtExtLy4uIc53APEQ4hIuE84RD24S6cnRCPRiktLcX48H6DLwdZngf3efX5iNdfj3nz7YSXn4548fGQt99P896G9rF+/sDa2cY5PtBhy3QSOxyCyCmx32FKy8ow1tfX8yHbNkLV1F2k1I+VMy3MK1M/jII7Ob1exRMJSkpKMNbW1grJFf+sQZV0y7Kw5W123UKxK6TI28ViMZ4UF2N0d3frPh0aGsLr89HX16f7WNPbizrv6OigrbWVpx6PRvWyarO6ujqN6uHy8nKKior4C2H4ibjwyDvuAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/eeb98d81498f6305489fb24674f0e6c3/fcda8/1630990314025-27a93a65-9406-4a41-bcf3-3afdc755105e.png\"\n        srcset=\"/static/eeb98d81498f6305489fb24674f0e6c3/12f09/1630990314025-27a93a65-9406-4a41-bcf3-3afdc755105e.png 148w,\n/static/eeb98d81498f6305489fb24674f0e6c3/e4a3f/1630990314025-27a93a65-9406-4a41-bcf3-3afdc755105e.png 295w,\n/static/eeb98d81498f6305489fb24674f0e6c3/fcda8/1630990314025-27a93a65-9406-4a41-bcf3-3afdc755105e.png 590w,\n/static/eeb98d81498f6305489fb24674f0e6c3/efc66/1630990314025-27a93a65-9406-4a41-bcf3-3afdc755105e.png 885w,\n/static/eeb98d81498f6305489fb24674f0e6c3/c83ae/1630990314025-27a93a65-9406-4a41-bcf3-3afdc755105e.png 1180w,\n/static/eeb98d81498f6305489fb24674f0e6c3/aa440/1630990314025-27a93a65-9406-4a41-bcf3-3afdc755105e.png 1500w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p><a name=U9QEN></a></p>\n<h1>差异以及不兼容原因</h1>\n<p>理论上 Keycloak 升级不应该影响该插件的功能，但是该插件的实现上依赖了 Keycloak 的 BrokeredIdentityContext 中的一个 <strong>setCode</strong> API，但是该 API 在新版本的 Keycloak 中被删除了。因此这次的改动就是换用了一个 API (<strong>setContextData</strong>) 而已。</p>\n<p>Keycloak 的这个破坏性改动，看提交描述是修复一个 Broker 状态参数，但是具体的 JIRA 卡：<a href=\"https://issues.redhat.com/browse/KEYCLOAK-14483\">https://issues.redhat.com/browse/KEYCLOAK-14483</a>，我还没有权限查看。这个提交详情见：<a href=\"https://github.com/keycloak/keycloak/commit/41dc94fead4c20560e0dd96c3efbd7bd10a484b6\">https://github.com/keycloak/keycloak/commit/41dc94fead4c20560e0dd96c3efbd7bd10a484b6</a>。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.13513513513513%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAABx0lEQVR42oXQyU7bUBjF8TxIqRrA851sX984tjMDkSp11yUL3qyKIEOjika0fb5/lQFEFFoWPx1fL46OvtbsYcG32QPbnN0vuJ8vmS8WrBYr5ss18+V3Fqs189Wa9Y9HNk9/+Pn0+8Xm1ffj5hets3bAWTvc+fDJw9cNafUFZ4fIYoh2I6QdvBB5/8jrf6GuaF2GiotAsk9BoGvC4gZP19i0S9EdY5spWXVFoDpcxDmXid2LD57fSUFrW/as7UtMrKikQkeSWqX0OjW9ZkSROVSsEZFEhAIRyjeI48JzXxCKApE2BKKgNI6mnlD2p9hyiM5rEt3Bj9Id7w3HhV5E5D6jxnfEbkqUDxHuGuEmJMWE2I6I873A9PF178TJwig2KJkRRoo4SZHaYdKSKEnxfIEfyP86KvzoJVwXXW7rHiOdMzA510XJ2DU0OqeSKbVMd/kvL4WXh8Kpq7hr+kyMZZQ5boqKm3LAeFucWRqV0aj0kKdOFl7Zkttqv7AxlkFeMsw79IzdrdyqVfb+wucbbu+mlSWMNToxFFkH63oo4zCmROsOYaT3NwvfueG5FxNmE5LmK0E6xFddfFXh63qXnuweVHjqbX8BXKeShBYSsY8AAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/47ef46f7f17bde44881dfce370dfc03f/fcda8/1630991406445-9abc762b-d49e-4a3e-87fd-852e2284ac27.png\"\n        srcset=\"/static/47ef46f7f17bde44881dfce370dfc03f/12f09/1630991406445-9abc762b-d49e-4a3e-87fd-852e2284ac27.png 148w,\n/static/47ef46f7f17bde44881dfce370dfc03f/e4a3f/1630991406445-9abc762b-d49e-4a3e-87fd-852e2284ac27.png 295w,\n/static/47ef46f7f17bde44881dfce370dfc03f/fcda8/1630991406445-9abc762b-d49e-4a3e-87fd-852e2284ac27.png 590w,\n/static/47ef46f7f17bde44881dfce370dfc03f/efc66/1630991406445-9abc762b-d49e-4a3e-87fd-852e2284ac27.png 885w,\n/static/47ef46f7f17bde44881dfce370dfc03f/2e367/1630991406445-9abc762b-d49e-4a3e-87fd-852e2284ac27.png 1066w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>只两个方法的删除是最大的不兼容问题，其他的小问题在某些方法签名上的变化。</p>\n<p>上面👆都是流水账，下面是比较重要的内容了！即如何通过配置的方法，实现一个你自己的关注微信公众号即登录的应用。</p>\n<p><a name=n9qS2></a></p>\n<h1>实现一个你自己的关注微信公众号即登录应用</h1>\n<p>如果你希望自己的应用集成关注公众号即登录应用，想了解如何开发，可以参考：《<a href=\"https://zhuanlan.zhihu.com/p/393360806\">基于 Java Spring Security 的关注微信公众号即登录的设计与实现</a>》。</p>\n<p>如果你不想写代码，那么推荐你使用该插件进行集成。我已经集成了好几个应用了，这里详细讲解一下集成步骤。</p>\n<p><a name=LXouq></a></p>\n<h2>集成的示例应用</h2>\n<ul>\n<li><a href=\"https://uniheart.pa-ca.me/keycloak/login\">https://uniheart.pa-ca.me/keycloak/login</a><br />这是一个基于 eggjs 开发的 node 应用，可以通过关注测试公众号拿到相关的令牌信息</li>\n<li><a href=\"https://jeff-tian-gitlab-wq766wrh9r57-8929.githubpreview.dev/\">https://jeff-tian-gitlab-wq766wrh9r57-8929.githubpreview.dev/</a><br />这是一个 gitlab-ee 应用，增加了关注公众号登录的功能。但是由于利用了 Github 的 Codespace，很可能你打开时已经处于关闭状态（503）。如果你很想体验，请联系我，我可以实时打开这个服务。集成步骤详见《<a href=\"https://zhuanlan.zhihu.com/p/405425214\">在自托管 GitLab 实例中集成 Keycloak 登录</a>》。</li>\n<li><a href=\"https://keycloak.jiwai.win/auth/realms/UniHeart/account/\">https://keycloak.jiwai.win/auth/realms/UniHeart/account/</a><br />这是一个部署在 Heroku 上的 Keycloak 应用本身了</li>\n</ul>\n<p><a name=GEgkC></a></p>\n<h2>集成步骤</h2>\n<p><a name=hjq0K></a></p>\n<h3>部署 Keycloak</h3>\n<p>Keycloak 是一个优秀的开源用户认证与授权管理系统，推荐你先部署它。无论你的应用是什么语言编写，都可以快速通过配置的方式和它集成，详细参看官方文档。</p>\n<p>需要注意的是，部署时要把本插件（ <a href=\"https://github.com/Jeff-Tian/keycloak-services-social-weixin/packages/225091?version=0.0.20\">https://github.com/Jeff-Tian/keycloak-services-social-weixin/packages/225091?version=0.0.20</a> ）的 jar 包拷贝到 Keycloak 的 /opt/jboss/keycloak/providers/ 目录下，然后需要把配置页面的两个 html 文件拷贝到 /opt/jboss/keycloak/themes/base/admin/resources/partials 目录。</p>\n<p>具体可以参考： <a href=\"https://github.com/Jeff-Tian/keycloak-heroku/blob/master/Dockerfile\">https://github.com/Jeff-Tian/keycloak-heroku/blob/master/Dockerfile</a> 这个 Dockerfile 文件。</p>\n<p><a name=ORpy5></a></p>\n<h3>在 keycloak 中添加关注公众号即登录插件</h3>\n<ul>\n<li>登录你的 Keycloak admin console<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bb0a1a1cefed7f93ce4a12765b3818a9/8ce22/1630992753468-362a8681-bebc-46ec-b63e-0a321d7310ec.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 70.27027027027026%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAABVUlEQVR42pWT626EIBCFff8H6iP0T9+h3aJ4wwuIiBGG08hud91G43aSL0OYmaMwQ6IGjZTnuLAULM2Qco6yFhjNBGtnjNOEcbIwk417+oSEiOC9jzh39eve4hykHuGcw7IsmOf5Ggshxo9IcGDdoPH2/gE9DBBCgDEWRVcLIRyVIVmDe5zZUV2yl7SacwuUlNBawxiDruvAOY9UVXXLOxHcHscRoVcKSuvYmLbr8fl1wTdj4Hm+LXhaJnti8WuzBdzywDsg0BXyIDsheP98TXtHXo1kB5ItVN1grGtMorpjRQ3bCrimAqn+URcCFuf3BX3fAkajFAoFL1CxC6qUock5BM/QlAVokAiD3NQFzMuBYFhnSg8wdQnJU0ieoedpRBU8+i5jMFo/NXN3DrcjQ+vfhgBHIfoVCnisie5NOR6bW7t+7+WVeTwU3Et4hX8Jnj21v4I/upRKrk+ssZkAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/bb0a1a1cefed7f93ce4a12765b3818a9/fcda8/1630992753468-362a8681-bebc-46ec-b63e-0a321d7310ec.png\"\n        srcset=\"/static/bb0a1a1cefed7f93ce4a12765b3818a9/12f09/1630992753468-362a8681-bebc-46ec-b63e-0a321d7310ec.png 148w,\n/static/bb0a1a1cefed7f93ce4a12765b3818a9/e4a3f/1630992753468-362a8681-bebc-46ec-b63e-0a321d7310ec.png 295w,\n/static/bb0a1a1cefed7f93ce4a12765b3818a9/fcda8/1630992753468-362a8681-bebc-46ec-b63e-0a321d7310ec.png 590w,\n/static/bb0a1a1cefed7f93ce4a12765b3818a9/8ce22/1630992753468-362a8681-bebc-46ec-b63e-0a321d7310ec.png 685w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></li>\n<li>创建你的领域，并在领域设置里打开身份提供者：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8fdb94d3122d6edda923867f76d60812/72aae/1630993405981-7f074ad5-5b22-4b70-b37e-c795b791885f.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 47.972972972972975%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABkklEQVR42p2Ry07CYBCFu0D3hIvsNQrWFltugopaBIVoeAPjgykUNF5wwQuoj8GCFF0YxI3lUhBaAsf8QyQxJkac5Muc2ZzMmeHuHx5RLpdRvLjEeS4PtVBAoVgkzTg7z1HP5VXqeVVFXi3QfHV9g9vSHW5uS1M43i9hwe2G3W6HzWYj5ubm4XK54PF4CKadTue0T7QTDofjB5wUjGKFXydWxQCWvAKUZAaVSgU1TUO1WkW73Uav14NhGOh2u7/CBSJbEKQwRDkCf2ADXkFGMn2Md13HeDzGYDDALMXF4grC0ThtyPuDWPQKSKQyqD09o9lqo2sY6HQ60HUdmqah1WrRzGCbNxoN0mz7er0ObltJYXf/ECu8RIaTyGm8vL7hw7RgmSYsy0K/3ydTpr8wTZOMmB4Oh6S5vcQB4jsJiP4gRV/m16GkMmg2mxSBxZ4p8snxEU6zWSRCYciRTaxJIRweZaHrE8PRaESmf4Xb3FYgh2LwrknTL7MTsKf8y5DF9AkyfGJgckOfiL1k+pvhLJE/AaGDVziyVtaWAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/8fdb94d3122d6edda923867f76d60812/fcda8/1630993405981-7f074ad5-5b22-4b70-b37e-c795b791885f.png\"\n        srcset=\"/static/8fdb94d3122d6edda923867f76d60812/12f09/1630993405981-7f074ad5-5b22-4b70-b37e-c795b791885f.png 148w,\n/static/8fdb94d3122d6edda923867f76d60812/e4a3f/1630993405981-7f074ad5-5b22-4b70-b37e-c795b791885f.png 295w,\n/static/8fdb94d3122d6edda923867f76d60812/fcda8/1630993405981-7f074ad5-5b22-4b70-b37e-c795b791885f.png 590w,\n/static/8fdb94d3122d6edda923867f76d60812/efc66/1630993405981-7f074ad5-5b22-4b70-b37e-c795b791885f.png 885w,\n/static/8fdb94d3122d6edda923867f76d60812/72aae/1630993405981-7f074ad5-5b22-4b70-b37e-c795b791885f.png 964w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></li>\n<li>点击编辑“weixin”进行配置：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 79.05405405405406%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAACPElEQVR42qVU/W/aMBDN//9P7Zdp6zYN2rWMwoCUUEIC5IN8OLbP9pt8ARqpVJq0SE/nOMnL8927C3bpHlprWGvAl3P4nytolYHoOkhNIGthAY7a9FBKvQMR3YS1FkGvyqLb7xDPn9EdUhTRC5LFHFm4RF1VqOoalY9VhbquIaV8h67rmDTgA1qLardFtllD5RmaJIbIM6jVDOppxKrNWYEx5iZ82jwCnzNPqpzDoSghjYGyjqN0QDv+BrmNQAC0UtcPhyC6ROqPrLM98nDJR5T7BOXmhdfFOoTIDpDTX9BtAz1QcgteKRPK/IhktcAxWkMWGcp4i8P6BWX8iu7HZ8jJGDKcg4wBnRVdcVbmi+VzGbizTXyeDscMighaSWgiTgXnL9n2uWxr3rsF69ArvBB6yfs0RSs6hGkJSQSIBrScwsQR9OwJFM5hjyn/wCSvMLtNH9MYtjj2PrwQetmnskQjJO43BaTWfhMm2zNsfYKtSoYTLWxTs2LbVHzvlITnuhIKIRBFEbRWkG0NpQnoBPT0AWp8B/37ntd6MoZ+/NnjzwR69gg9n4BWz0wcXNTlec7wRy/LExQZuPoENfoKefcJavQF+uE7aL0ARUvQagazXXM6GIeE2zbofW1ZoSf0lfJr7m9f1bYBnUoYIWA6wUX6EL713GAYpGnKhN7Abdv23rIW5Bz3Nxn7ZhU9tM3A2MMqx3GMrpMoasGE/gXzwSAYwtvFx771eGK569SSZDEKj6iquvendefn/4a/TADYjs/+xtEAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/5cbf3dec0d8f5120542d879031ad5621/fcda8/1630993537868-6f46730d-6aca-49bf-b9e6-db6bf125bc73.png\"\n        srcset=\"/static/5cbf3dec0d8f5120542d879031ad5621/12f09/1630993537868-6f46730d-6aca-49bf-b9e6-db6bf125bc73.png 148w,\n/static/5cbf3dec0d8f5120542d879031ad5621/e4a3f/1630993537868-6f46730d-6aca-49bf-b9e6-db6bf125bc73.png 295w,\n/static/5cbf3dec0d8f5120542d879031ad5621/fcda8/1630993537868-6f46730d-6aca-49bf-b9e6-db6bf125bc73.png 590w,\n/static/5cbf3dec0d8f5120542d879031ad5621/efc66/1630993537868-6f46730d-6aca-49bf-b9e6-db6bf125bc73.png 885w,\n/static/5cbf3dec0d8f5120542d879031ad5621/e24fe/1630993537868-6f46730d-6aca-49bf-b9e6-db6bf125bc73.png 1073w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span><br />注意，这里有一个非必填项，customized-login-url，在这里也必须填写，否则就会走默认的开放平台的 OAuth 登录逻辑了。如果你不想自己开发展示带餐二维码，以及对用户扫码的感知逻辑，请一定要填写：<a href=\"https://wechat.pa-ca.me/mp-qr\">https://wechat.pa-ca.me/mp-qr</a> 这个开发好的地址。</li>\n</ul>\n<p><a name=WHwTt></a></p>\n<h3>公众号的配置</h3>\n<p><br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.91891891891892%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA8klEQVR42p2SbWvFIAyF/f9/rlDoYLBvpe+trX3TVu0ZJ7ByBxt3u4GHoCYxnqiyLENZlqBd14X/2LZtMMYIWg+wZ4Cy1uI8zxvnHLhH/4zHPO89jsNBpWmKoiiQ57nQ9z2macIwDC+hmOysxbIs2PddbpvnGTFGvGJScLcOMV6iIVvnk+lDCL/Dc+8l7hGVJAne3j9QNx2qqkLTNEJd17f/kaYTuq4Tmb5QnNA4atGNgQxgIR5qrdG27V2ce5RjMgbz7mFswBni/UOIYpscPwut6yIJ1HNdV/FcE17MuKcaHseBcRyli78Yh/Wd6+6OHX4Cx124d4lBe2EAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/97560bae15b09d474aaaf8ca28f90cdc/fcda8/1630993905175-0deca8c1-487a-49be-a0d9-f45286a7b051.png\"\n        srcset=\"/static/97560bae15b09d474aaaf8ca28f90cdc/12f09/1630993905175-0deca8c1-487a-49be-a0d9-f45286a7b051.png 148w,\n/static/97560bae15b09d474aaaf8ca28f90cdc/e4a3f/1630993905175-0deca8c1-487a-49be-a0d9-f45286a7b051.png 295w,\n/static/97560bae15b09d474aaaf8ca28f90cdc/fcda8/1630993905175-0deca8c1-487a-49be-a0d9-f45286a7b051.png 590w,\n/static/97560bae15b09d474aaaf8ca28f90cdc/efc66/1630993905175-0deca8c1-487a-49be-a0d9-f45286a7b051.png 885w,\n/static/97560bae15b09d474aaaf8ca28f90cdc/7a1fb/1630993905175-0deca8c1-487a-49be-a0d9-f45286a7b051.png 1030w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>只需要配置接口，不需要配置其他。这个接口是用来接收微信的消息的，如果你不想自己开发，可以使用我开发好的，URL 是：<a href=\"https://uniheart-developer-edition.ap15.force.com/services/apexrest/callback/wechat\">https://uniheart-developer-edition.ap15.force.com/services/apexrest/callback/wechat</a>。欢迎通过知乎付费咨询，或者微信打赏的方式向我索取 Token。</p>\n<blockquote>\n<p><strong>注意，对于个人订阅号，或者未认证的企业服务号，都是没有相关接口（获取带餐二维码等）权限的，所以如果是个人测试的话，只能使用测试公众号，如本截图一样。</strong></p>\n</blockquote>\n<p><a name=OQhKZ></a></p>\n<h1>总结</h1>\n<p>这是一篇 Keycloak 集成的配置详解，因为陆续有人向我反映看了我的一系列 Keycloak 文章后（<a href=\"https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzAxNTk3ODgxNA==&#x26;action=getalbum&#x26;album_id=1792107127465967619&#x26;scene=173&#x26;from_msgid=2247484524&#x26;from_itemidx=1&#x26;count=3&#x26;nolastread=1#wechat_redirect\">https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzAxNTk3ODgxNA==&#x26;action=getalbum&#x26;album_id=1792107127465967619&#x26;scene=173&#x26;from_msgid=2247484524&#x26;from_itemidx=1&#x26;count=3&#x26;nolastread=1#wechat_redirect</a>），仍然碰到一些配置上的问题。</p>\n<p>这里面有综合利用到各种不同的免费资源，因此体验一定不是最好的。如果有更好的建议（更大的羊毛可以薅），欢迎留言分享。</p>\n<p>这里面涉及到的相关开发，全部以开源形式放在 GitHub 上，欢迎对其中不满意的地方，发 PR 改进。一共有好多个代码库，可以使用这个链接列出： <a href=\"https://github.com/Jeff-Tian?tab=repositories&#x26;q=keycloak&#x26;type=&#x26;language=&#x26;sort=\">https://github.com/Jeff-Tian?tab=repositories&#x26;q=keycloak&#x26;type=&#x26;language=&#x26;sort=</a></p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}},"menus":{}}},"staticQueryHashes":[],"slicesMap":{}}