{"componentChunkName":"component---src-templates-post-js","path":"/posts/duvnw8pysoobgi77/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/duvnw8pysoobgi77","relativePath":"posts/duvnw8pysoobgi77","frontmatter":{"title":"ChatGPT 教我如何修改 node_modules 里的代码","stackbit_url_path":"posts/duvnw8pysoobgi77","date":"2023-07-11T11:50:44","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p>node_modules 里的包都是外部依赖，一般来说不应该直接修改 node_modules 里的文件。但是凡事总有例外，总会碰到需要修改的场景，这里列举两个办法。这两个办法都是 ChatGPT 教我的，亲测有效，分享给大家。</p>\n<p><a name=KwWFD></a></p>\n<h1>发新包</h1>\n<p>我用 vuejs/vitepress 写文档时，发现 markdown 文件可以包含，但不支持嵌套包含。所以联合 ChatGPT，修复了这个问题。整个过程大致如下：\n<a name=oMBeU></a></p>\n<h2>克隆</h2>\n<p>因为没有官方仓库的修改权限，所以首先需要将官方的 vuejs/vitepress 克隆至自己的仓库，接着就可以在自己的仓库中修改代码了。详细过程见：《<a href=\"https://zhuanlan.zhihu.com/p/640487822\">【已被采纳】基本功不好，如何做开源贡献？使用 ChatGPT 写代码实录。 - Jeff Tian的文章 - 知乎 </a> 》</p>\n<p><a name=KI9Of></a></p>\n<h2>贡献</h2>\n<p>不妨将自己的修改贡献给原仓库，这只需要发一个合并请求，详见上文。\n<a name=tk84s></a></p>\n<h2>发自己的包</h2>\n<p>然后，就可以等待维护者的审核了，如果通过审核，还需要等待官方发新版，才能在自己的依赖中更新版本从而使用到自己的修改。如果等不及，但想提前使用自己修改过的版本，就可以发自己的包。<br />在上例中，我修改的版本虽然已经得到采纳，但是目前新的版本还没有发出来，为了提前使用嵌套包含功能，我从主分支拉出一个新的分析 jeff，并将 package.json 做了必要修改后，发了一个新包： @jeff-tian/vitepress。这样，只需要引用该包，就能立即使用到新的功能了。\nshell\nnpm i @jeff-tian/vitepress --save</p>\n<p>为了发新包，需要做的修改详见：<a href=\"https://github.com/vuejs/vitepress/commit/b35de817436d57dee84cc369bb28b7ae1bef0493\">https://github.com/vuejs/vitepress/commit/b35de817436d57dee84cc369bb28b7ae1bef0493</a>\ndiff\n{</p>\n<ul>\n<li>name: vitepress,</li>\n<li>version: 1.0.0-beta.3,</li>\n<li>description: Vite &#x26; Vue powered static site generator,</li>\n</ul>\n<ul>\n<li>name: @jeff-tian/vitepress,</li>\n<li>publishConfig: {</li>\n<li>access: public</li>\n<li>},</li>\n<li>version: 1.0.0,</li>\n<li>description: Vite &#x26; Vue powered static site generator, support nested inclusion,</li>\n</ul>\n<p>type: module,\npackageManager: <a href=\"mailto:pnpm@8.6.3\">pnpm@8.6.3</a>,\nmain: dist/node/index.js,</p>\n<p><a name=lvR32></a></p>\n<h1>post install</h1>\n<p>在上面的场景下，发新包的方式非常适合。然而，有些情况下，则不一定适合。比如，要修改的文件不在项目的直接依赖包里，而是嵌套 n 层，非常底层。如果用发新包的方式，那么整个依赖树中都得依次更新 package.json，并将每个包都发一遍。这样做的话工作量大到几乎不可能完成。<br />这时候，可以利用 post install，做文件内容的查找替换，非常好用！\n<a name=dDKPs></a></p>\n<h2>举个例子</h2>\n<p>还是项目中用到了 vuejs/vitepress，发现在 markdown 文件中引用的图片，如果文件名中有了空格，那么整个文档站点编译就会失败，比如：\nshell\nCould not resolve ./book/resources/test%20(1).svg from docs/index.md</p>\n<p>原因是 vitepress 依赖了一系列的包，最终最底层的 @vue/core 将文件名使用了 parseUrl 函数处理过，导致空格被编码成了 %20，从而在 nodejs 里的 import 过程中，出现找不到文件的错误。</p>\n<p>尽管说在文件名里使用空格是非常不推荐的，但由于操作系统支持这样的文件名，并且很多过程会自动产生包含空格的文件名，所以我个人认为非常有必要在 vue 生态中支持这样的文件名。</p>\n<p>这个问题很多人反映过：</p>\n<ul>\n<li><a href=\"https://github.com/vuejs/vitepress/issues/2596\">https://github.com/vuejs/vitepress/issues/2596</a></li>\n<li><a href=\"https://github.com/vuejs/vitepress/issues/573\">https://github.com/vuejs/vitepress/issues/573</a></li>\n<li><a href=\"https://github.com/vitejs/vite/issues/7300\">https://github.com/vitejs/vite/issues/7300</a></li>\n<li><a href=\"https://github.com/vuejs/vuepress/issues/2152\">https://github.com/vuejs/vuepress/issues/2152</a></li>\n</ul>\n<p>但是 2 年多了官方也没有计划做修复。</p>\n<p><a name=fpP3i></a></p>\n<h2>修复</h2>\n<p>我决定修复一下，并尝试贡献回官方仓库： <a href=\"https://github.com/vuejs/core/pull/8752\">https://github.com/vuejs/core/pull/8752</a>。但是估计不会很快得到响应，于是需要一个临时解决方案。<br />如果通过发一个新包，那么我还需要顺着依赖树改所有的相关依赖，放弃。</p>\n<p><a name=Jpxfo></a></p>\n<h2>post install 来帮忙</h2>\n<p>于是我就问 ChatGPT 该怎么办？<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/14a764b39fafa5d8c7fedc149f4ddf6c/7ef4c/1689075739154-21b36dca-a33c-4f19-8ace-d84aa0077ac8.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 64.86486486486486%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB/klEQVR42l1TB47jMAz0/3+3yN1mL81xt9xV7Lglcxg6my0CBpQpckiOLE8VJcqqQq4KpHkulr5cKdRNC9cPsH0P6zYY5zaf6+GG4eXrtEFVN/DwXK3WKMoKWaYQxynyvECaZrJXqkRRVKiqGkmayTfPmqZFkqS4XkNkWQ5jDLzH4wGCa5omIQijGOezjzCMt4QgRBBE8u37gVjicrkiSTJorWGMFZ4fhOM4SuBnMtG0LbQ26DotHbGL220US5+1Ds45iVmW5RfhNMlYRNt2QuColeslQRKfRNSLxRjTsUNrMQy3Lw25lnkR7Vh1XVcs6yp2nmeRgx1wT3Aa+ohPH2O9eV4ksJ9GDPOWdL/fN6x3bOerWE4wPZMnKTJ/FRDyGV4/3DDfJpy0wr8yQRJlCMIEx5OPgHqGieAaxIji7YbLskaaKYGS228QRglyVcKjwJx9HCcY4xAnGS5+iMPJx/F0xfkSCNJUwViHpulQNx3aVsu+7TS0sdDayk1/IxxFeBL51whl1aAoawH3TGjaDpn8n0osi9OWz5iqbuGRjCBx3w8yQl23sHa7XXkVtkfXmdeNE9RrXe/Pi9rAKX90yKT9xwm7Px94272LLmc/xPv+iL/7g3T/ttvjcPSlO+pKHaM4lU7J9SKkZWU+Pb5njsCOv5//nmb7qfvXNCT8D1CJ3P0PT1ewAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/14a764b39fafa5d8c7fedc149f4ddf6c/fcda8/1689075739154-21b36dca-a33c-4f19-8ace-d84aa0077ac8.png\"\n        srcset=\"/static/14a764b39fafa5d8c7fedc149f4ddf6c/12f09/1689075739154-21b36dca-a33c-4f19-8ace-d84aa0077ac8.png 148w,\n/static/14a764b39fafa5d8c7fedc149f4ddf6c/e4a3f/1689075739154-21b36dca-a33c-4f19-8ace-d84aa0077ac8.png 295w,\n/static/14a764b39fafa5d8c7fedc149f4ddf6c/fcda8/1689075739154-21b36dca-a33c-4f19-8ace-d84aa0077ac8.png 590w,\n/static/14a764b39fafa5d8c7fedc149f4ddf6c/efc66/1689075739154-21b36dca-a33c-4f19-8ace-d84aa0077ac8.png 885w,\n/static/14a764b39fafa5d8c7fedc149f4ddf6c/c83ae/1689075739154-21b36dca-a33c-4f19-8ace-d84aa0077ac8.png 1180w,\n/static/14a764b39fafa5d8c7fedc149f4ddf6c/7ef4c/1689075739154-21b36dca-a33c-4f19-8ace-d84aa0077ac8.png 1748w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3f964cab936443b64ea0804cfdbf74b9/0d0e4/1689075803459-6834fcf6-1ada-4b67-a0ae-6d05057a5151.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 110.8108108108108%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAABYlAAAWJQFJUiTwAAAC8ElEQVR42pWUTW/bRhCGd0mRlGTLrq3IaYH2UMTWwbrklEOB/swGSK/pobZRwLk0MhAX6CGN3EvQW6PP1rUpUR+kPihStK08xa6TxmgdSz08mOGKfDEzq3lFx+vidjxU1Hm7Q6fb07Q7Hu12h26vTxTPCKOYqSJ+F2/mcUwYRYjLy0v+zcXFh3ycxMxmCXE801ERRTFRHOszlas4jSKSJEHoHz+CevFs2Of0r3Nq9Rb1xh/UG3/iuh7dbp+Op7ro0usN8LweYThFqI9u471gPI1ptk45dztaQOEHQz0GJTTwA4JgxHA41t8sFAynEV63rytSuR+MGPhDjXpWs1VcXc1Jkou7BdW8VDXl8gsOn/1IuXzMUflYx/c8f/6Co6OfOD7+mX5/8HHB6TRiPn9LtVrjiy93yK3mWFtfw8nmsNMr2JkVHEV2FSezympunZOTXxcLvnlT5V7hPmnbIuVYCNtE2imkZSJMiUgZCEMgpODVq8pygp9/+hkbToa1XA6ZMrFtG8uyEEIghdDRMAwqlZPlBDfzBYQwsAwTQ8h/RG6izpaucGNri9R6jsy9DZzcCnY2jcg6iIyDSJkIQ2JkHConS1ZYKBQwpcBOO1iaNMJKYTmOblVXaJrLt1wobJGzM6xlsji2Tco0EVJiGgZSymtBKaks23I+n0cK41rIkPpGbwopzP9T4eYnG/+5hNt4+fKXuzdFrZLvBxwePuP7vX329w/Y3ztg711+cPADT59+xzePH/Pkybe4rnuX4Id99oMx/cGIYBji+2MG/ph4dkkcX5AkV8zn8Ba07d3Zslr4ZrPFV4++pvhgl+1iSfNge5ft7V12iiV2dnYpFkuUSg95/fq3JWZYrXJ/M09KXYBaM4Upb52h/mMvMtjJJKTeaPF7tUa1WqfZaFGrNajXm9TqDY3qQp2pdxf64WQy5dz1cNtdTs9cgqGaZ6Dp9X3ti8PRRPukNthFFYbhtcEqlN3f5Oy8o413NJ4wHk/0mP4G23BW+Rps5KwAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/3f964cab936443b64ea0804cfdbf74b9/fcda8/1689075803459-6834fcf6-1ada-4b67-a0ae-6d05057a5151.png\"\n        srcset=\"/static/3f964cab936443b64ea0804cfdbf74b9/12f09/1689075803459-6834fcf6-1ada-4b67-a0ae-6d05057a5151.png 148w,\n/static/3f964cab936443b64ea0804cfdbf74b9/e4a3f/1689075803459-6834fcf6-1ada-4b67-a0ae-6d05057a5151.png 295w,\n/static/3f964cab936443b64ea0804cfdbf74b9/fcda8/1689075803459-6834fcf6-1ada-4b67-a0ae-6d05057a5151.png 590w,\n/static/3f964cab936443b64ea0804cfdbf74b9/efc66/1689075803459-6834fcf6-1ada-4b67-a0ae-6d05057a5151.png 885w,\n/static/3f964cab936443b64ea0804cfdbf74b9/c83ae/1689075803459-6834fcf6-1ada-4b67-a0ae-6d05057a5151.png 1180w,\n/static/3f964cab936443b64ea0804cfdbf74b9/0d0e4/1689075803459-6834fcf6-1ada-4b67-a0ae-6d05057a5151.png 1230w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>我试了一下，居然好用！这里将详细的代码再用文字贴一遍，如果你也需要在 vue 生态的 markdown 文件中，使用带空格的静态文件资源，可以闭眼粘贴使用。\n<a name=WFBTn></a></p>\n<h3>创建 postinstall.js 文件</h3>\n<p>javascript\nconst fs = require(fs);</p>\n<p>const filePath = node_modules/@vue/compiler-sfc/dist/compiler-sfc.cjs.js;</p>\n<p>fs.readFile(filePath, utf8, (err, data) => {\nif (err) {\nconsole.error(err);\nreturn;\n}</p>\n<pre><code>const modifiedData = data.replace(\n    /context.imports.push({s*exp,s*path:s*path2s*});/g,\n    context.imports.push({ exp, path: path2 &#x26;&#x26; path2[0] === / ? decodeURIComponent(path2) : path2 });\n);\n\nfs.writeFile(filePath, modifiedData, utf8, (err) => {\n    if (err) {\n        console.error(err);\n        return;\n    }\n\n    console.log(File modified successfully!);\n});\n</code></pre>\n<p>});</p>\n<p><a name=tkLus></a></p>\n<h3>在 package.json 的 scripts 节增加</h3>\n<p>diff</p>\n<ul>\n<li>\n<pre><code>postinstall: node postinstall.js\n</code></pre>\n</li>\n</ul>\n<p>后面再执行一次 npm install 后，空格带来的麻烦就消失了！</p>\n<p><a name=x7hQ2></a></p>\n<h1>总结</h1>\n<p>ChatGPT 教会了我两个修改 node_modules 目录下的文件的方法，如果是第一层依赖的代码，可以直接修改后发新包，省得做文件内容替换。如果是第 n 层的依赖，建议使用 postinstall 脚本进行文件内容替换。</p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}},"menus":{}}},"staticQueryHashes":[],"slicesMap":{}}