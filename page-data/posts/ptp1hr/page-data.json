{"componentChunkName":"component---src-templates-post-js","path":"/posts/ptp1hr/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/ptp1hr","relativePath":"posts/ptp1hr","frontmatter":{"title":"实战案例：在 Umi Js 项目中通过 umi-plugin-oauth2 插件对接 Keycloak","stackbit_url_path":"posts/ptp1hr","date":"2022-10-12T05:09:48","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p><a name=t7k62></a></p>\n<h1>Keycloak</h1>\n<p>Keycloak 是一个开源的身份认证与访问授权管理系统。对于开发者来说，通过它，可以关注自己的应用业务逻辑，而不必每个系统都单独开发用户系统。无论是写前端、BFF 还是后端，都可以直接“接入” Keycloak，这时只需要少量配置代码，节省大量的开发测试工作。</p>\n<p><a name=bYM8o></a></p>\n<h2>保护后端服务</h2>\n<p>以 Spring Boot 为例，以前写过： 《<a href=\"https://zhuanlan.zhihu.com/p/480816990\">https://zhuanlan.zhihu.com/p/480816990</a>》。</p>\n<p><a name=b5pRt></a></p>\n<h2>保护 BFF</h2>\n<p>以 eggjs 为例，以前写过：《<a href=\"https://zhuanlan.zhihu.com/p/359057316\">https://zhuanlan.zhihu.com/p/359057316</a>》。</p>\n<p><a name=Vw3P0></a></p>\n<h2>保护纯前端</h2>\n<p>这个目前官网有 Vue.js 的案例： <a href=\"https://www.keycloak.org/securing-apps/vue\">https://www.keycloak.org/securing-apps/vue</a>。我今天正好可以给 Keycloak 补充一个 Umi Js 的案例，并借此机会给 umi-plugin-oauth2 打一个广告，希望能推广给更多人使用它。</p>\n<p><a name=UMX57></a></p>\n<h1>umi-plugin-oauth2</h1>\n<p>它的源代码见： <a href=\"https://github.com/Jeff-Tian/umi-plugin-oauth2\">https://github.com/Jeff-Tian/umi-plugin-oauth2</a>，是从另一个 umi-plugin-oauth2-client 分叉而来，但是已经做了很多改进，目前已经在企业的生产环境中使用了。</p>\n<p><a name=e4CMD></a></p>\n<h2>IdentityServer</h2>\n<p>可以将 IdentityServer 看成是一个 ASP.NET 版的无头 Keycloak。所以要关注应用业务逻辑，将应用与身份管理解耦，其实不只 Keycloak 一个选择。在《<a href=\"https://zhuanlan.zhihu.com/p/533197284\">https://zhuanlan.zhihu.com/p/533197284</a>》一文里，详解了使用 IdentityServer 保护 Java 后端服务和前端应用。这个前端应用，其实就是基于 Umi Js 的，其实最后也是使用了 umi-plugin-oauth2 这个插件。</p>\n<p>正如 umi-plugin-oauth2 的名字所表达的，使用这个插件，可以帮助 Umi Js 应用接入任何 OAuth 2.0 的授权服务，并不局限于 IdentityServer。于是今天再次举一个接入 Keycloak 的实例。</p>\n<p><a name=b5GmP></a></p>\n<h1>连点成线，拼凑软件</h1>\n<p>之前写了一篇《<a href=\"https://zhuanlan.zhihu.com/p/551301145\">https://zhuanlan.zhihu.com/p/551301145</a>》，发现自己对拼凑软件上瘾了，这次也不例外，继续拼凑。首先，这个 UmiJs 前端不是我从 0 开始搭建的，是基于一名知友的仓库分叉而来，一开始是帮助他解决在 UmiJs 里集成 CKEditor 时碰到的错误，解决完后，今天又想起它，再次挖掘一下利用价值：给它添加上用户登录和退出的功能。</p>\n<p><a name=ligY5></a></p>\n<h1>在线访问</h1>\n<p>部署在 Vercel 上： <a href=\"http://umi-ckeditor5.vercel.app/\">http://umi-ckeditor5.vercel.app/</a>.<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 70.27027027027026%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABYlAAAWJQFJUiTwAAABVklEQVR42q1T2W6DMBD0//9eTvqQBFBJiAIYG4LNkalmU6NUaqU2qaVh9vJ65MWq0jXiJEWcviPJclRaw9gGujYC27Swzd2f46ZBazR0WUAbC9NYaGNQGws1DAP6vofvB/hhgncOnr73cM5hHAawxnkvdYx1zmPyHfqu/Yx7OO9kj8I/L5VlmZzKdbvdXoY6n8+4XC6YpullddIwz3McDgdQ6el0+gLmAgfQp4jHGuJ4PKKqKqgoirDZbLDdbrFer8VerVYC2sFnnrxcLmd7sVgIcx/jSZLc75AK4zgW7Pf72afNogDGyGmazjVk1hFUrhhgUV3XIrksS+Hv7IDgF0Uh9x9ixhgofkKStrVWWGuNcRx/PX0uDlaxWRhK13W4Xq+Cx2aPTX86YG7ICb1FEXa7nShtmkYaP/MbScOgqG1bQVDG5F/BJyp3yIEQVCZvteueAvd+AOMbNNad5KIdAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/095fcbd6c64ca25a1654da8c80bf6f72/fcda8/1665549506180-0b7d2e6a-a37b-4150-a456-84f2d8694afa.png\"\n        srcset=\"/static/095fcbd6c64ca25a1654da8c80bf6f72/12f09/1665549506180-0b7d2e6a-a37b-4150-a456-84f2d8694afa.png 148w,\n/static/095fcbd6c64ca25a1654da8c80bf6f72/e4a3f/1665549506180-0b7d2e6a-a37b-4150-a456-84f2d8694afa.png 295w,\n/static/095fcbd6c64ca25a1654da8c80bf6f72/fcda8/1665549506180-0b7d2e6a-a37b-4150-a456-84f2d8694afa.png 590w,\n/static/095fcbd6c64ca25a1654da8c80bf6f72/efc66/1665549506180-0b7d2e6a-a37b-4150-a456-84f2d8694afa.png 885w,\n/static/095fcbd6c64ca25a1654da8c80bf6f72/c83ae/1665549506180-0b7d2e6a-a37b-4150-a456-84f2d8694afa.png 1180w,\n/static/095fcbd6c64ca25a1654da8c80bf6f72/7831d/1665549506180-0b7d2e6a-a37b-4150-a456-84f2d8694afa.png 2116w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n<a name=vrJtt></a></p>\n<h1>接入步骤详解</h1>\n<p>完整的修改记录源码见这个提交： <a href=\"https://github.com/Jeff-Tian/umi-ckeditor5/commit/f2c7eb0e8212362441180d6dd54ca13bd52461ed\">https://github.com/Jeff-Tian/umi-ckeditor5/commit/f2c7eb0e8212362441180d6dd54ca13bd52461ed</a>。</p>\n<p><a name=C5axs></a></p>\n<h2>Keycloak 配置</h2>\n<p><a name=wDFJS></a></p>\n<h3>首先，需要添加一个公开客户端</h3>\n<p>因为这是使用纯前端对接 Keycloak，所以需要将客户端设置为公开的。毕竟，即使使用加密的客户端，那密钥保存在前端也是没有意义的。如果需要高安全性，那么一定是要用 BFF 来对接 Keycloak，而前端只需要和 BFF 对接，对具体授权服务完全无感知。参考《<a href=\"https://zhuanlan.zhihu.com/p/571585321\">https://zhuanlan.zhihu.com/p/571585321</a>》一文对此的讨论。</p>\n<p>但是，目前业务仍然有使用纯前端直接对接授权服务的做法，本篇也是如此，不考虑 BFF 方案。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/529ed5b31dabbefc0c15189776433bf3/df009/1665549562128-168a41f0-5d60-4d4a-96a2-08ed5778931a.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.70270270270271%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABqElEQVR42o2S7WoTQRiF9zoqYhEsrW1taptUTZVKKfSuqlUignflTRg/EGyar9ndmd3Zz9nsPLKTNLRFMC8c3vmzD+ecd73B9ZDvP37S//Wbq8EQIQSj8Rg/CJBSInyfIAyZ+gGhmKBkiE5TdKKJdUKSaHSSIpUiijXem9NzuidnbO216X3+QmZmhKGkqiqMMZRlSVGUblempMhziqJwyhfvm22txTs6fsvuwQsePt7k/cdPNFPX9fKjLE0dzMGNcfu+ynK+HbDTPaF1+Iq19Q3efegtgJZIKeI0RxeGelY5x41m1a33bHZnN0a8l69PabW7rD16sgS6CGnCOM7o+xqw1NY6B/+Tt93q0Mg5vJwDY62RUeSiNpGtQ7Ia8HnnmO29Ng/WN7hYODSxYnr1h0KFZIGgUJIq0VTGLOPeV9Ohi7zf6fL0Brg4ShkIcjFBCsHgeoSNJFUgXH9NX//SssOd25EXDn0hkGLKSCV8myiwNbauWWW8zd0DdvaPHPDisud6aH7mOPTpBylfh8n88nbFDreeHd4BNpNlGUopdJajksydxK545b/fFAZakD/z0wAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/529ed5b31dabbefc0c15189776433bf3/fcda8/1665549562128-168a41f0-5d60-4d4a-96a2-08ed5778931a.png\"\n        srcset=\"/static/529ed5b31dabbefc0c15189776433bf3/12f09/1665549562128-168a41f0-5d60-4d4a-96a2-08ed5778931a.png 148w,\n/static/529ed5b31dabbefc0c15189776433bf3/e4a3f/1665549562128-168a41f0-5d60-4d4a-96a2-08ed5778931a.png 295w,\n/static/529ed5b31dabbefc0c15189776433bf3/fcda8/1665549562128-168a41f0-5d60-4d4a-96a2-08ed5778931a.png 590w,\n/static/529ed5b31dabbefc0c15189776433bf3/efc66/1665549562128-168a41f0-5d60-4d4a-96a2-08ed5778931a.png 885w,\n/static/529ed5b31dabbefc0c15189776433bf3/c83ae/1665549562128-168a41f0-5d60-4d4a-96a2-08ed5778931a.png 1180w,\n/static/529ed5b31dabbefc0c15189776433bf3/df009/1665549562128-168a41f0-5d60-4d4a-96a2-08ed5778931a.png 2832w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><a name=OPTBt></a></p>\n<h3>然后，要配置好允许的回调 Uri</h3>\n<p>不然的话，点击登录跳转到 Keycloak，Keycloak 会展示一个错误页面，显示回调 Uri 不正确。这时，可以配置两个（或者根据情况配置多个）Uri。 localhost 供本地调试，其他不同的线上环境按需添加：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b23514983828c611a2dd2ff431575835/9b204/1665552985283-50a08803-329e-4b86-ab82-7aa442159f40.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 18.91891891891892%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAuklEQVR42lWPTU/DMBBE+///GDe4ICSuATcfjUJD7GzWu/JDNi0qK41WmsObmZOIUE/d2USwUlBVcs7ocXCIkFUxs+Y96u65e2OUUjjJvkOKxPDBHjpkGuiHgXMILOs3qxwcZmgNqN+8hesNWgvtlfEPKAnSBn2Hvr8yTBfGvic+P2FvL+i5a231+oUuMzqPaIpkswaLMT4Ab5O9FJJmank3azN8W7Hr8ivZsXnCxoD1n1iKmPvf9DvwB6dyNm5vypIQAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/b23514983828c611a2dd2ff431575835/fcda8/1665552985283-50a08803-329e-4b86-ab82-7aa442159f40.png\"\n        srcset=\"/static/b23514983828c611a2dd2ff431575835/12f09/1665552985283-50a08803-329e-4b86-ab82-7aa442159f40.png 148w,\n/static/b23514983828c611a2dd2ff431575835/e4a3f/1665552985283-50a08803-329e-4b86-ab82-7aa442159f40.png 295w,\n/static/b23514983828c611a2dd2ff431575835/fcda8/1665552985283-50a08803-329e-4b86-ab82-7aa442159f40.png 590w,\n/static/b23514983828c611a2dd2ff431575835/efc66/1665552985283-50a08803-329e-4b86-ab82-7aa442159f40.png 885w,\n/static/b23514983828c611a2dd2ff431575835/c83ae/1665552985283-50a08803-329e-4b86-ab82-7aa442159f40.png 1180w,\n/static/b23514983828c611a2dd2ff431575835/9b204/1665552985283-50a08803-329e-4b86-ab82-7aa442159f40.png 2520w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><a name=fsnGK></a></p>\n<h3>接着，配置 Web Origin</h3>\n<p>以上配置完成后，应用已经可以使用 Keycloak 登录了，登录成功后，回正常跳回应用。然后应用会使用 ajax 向 Keycloak 的 OIDC 服务请求 Token 和 UserInfo，由于这是纯前端，而非服务器端应用或者本地客户端应用，所以会碰到跨域 CORS 错误：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b4fa83c0d84e3cb9fe0a1666a09520bc/4a00e/1665549983037-055c3ce5-e541-4586-af28-c841b7dfa849.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.48648648648649%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAACYElEQVR42lWT3W7bRhBG8yIJJGqXIin+LLlcUiIpibQU2XHcGm5QoI9cFAV6kz6ALce59316ip2qSHsxwHB35+zsfB/fADyeX2iGE+M0sd2PONdQ2ZrFYkGeF3T9QGUt292ItTVFYYiTBK01URQxbHcYU6K14o0HPp1fqNYjbdvSbjpMWZIXBUopVqsVtXPUtWOcDlKc57mAPDAMQ7kkzTL5FuDz+ZH9rmO/nwRqjMFWFrUIKPKCvh/oup6Hn37m+uaDAOMoJvRArWnbNWVZotWlwy8vZ6arBtfv0XFMWlaYpuVdEEju+oEozWi6AeMaUlMSJglBGEqsdyOZrQkE+Nc3vv7xG7/UGQ8m565IuV1FfMoTTmrGTRzyUKRMasY4f8d+/pYPccj1UnGlZhL3WcL9akm1CC7A33/lU5lxt1pylyfcJkt+TEJOesZ1pLiNFAc9530456BnArzxa2rGUc/5GGt+iBVGLS6iPJ3pthPH9yeZn59RaS2LRSD5dDhSFAXRcikz8ypnWUaolYjSD1uKqro82Yvy/MQ0buiGPas0JS8MtnYEQSC5V941Lf2wEyulWU4Ux+gwRGkte2VZ/UeU50e2XUluKpHe314Yg/LFaYbxIpUVm66XjtI0JY5jyf15D8uy/Lttzk+PDP1ajLsfJ6rKihf/NbY3uffh3f0DV8fT/4ztw9a1GFt9t82LzMHPyv8R/0CsPNkXt+uNmPtwPEnuuxUjK4UONY149wJ8fX3l8+c/6YYd7bqnsg7XbFhvBmzd0rQd7WbANWvKyknIuq3ZtY7e1Wzbht75PcvffwmvIn3qsUUAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"cors-error.png\"\n        title=\"cors-error.png\"\n        src=\"/static/b4fa83c0d84e3cb9fe0a1666a09520bc/fcda8/1665549983037-055c3ce5-e541-4586-af28-c841b7dfa849.png\"\n        srcset=\"/static/b4fa83c0d84e3cb9fe0a1666a09520bc/12f09/1665549983037-055c3ce5-e541-4586-af28-c841b7dfa849.png 148w,\n/static/b4fa83c0d84e3cb9fe0a1666a09520bc/e4a3f/1665549983037-055c3ce5-e541-4586-af28-c841b7dfa849.png 295w,\n/static/b4fa83c0d84e3cb9fe0a1666a09520bc/fcda8/1665549983037-055c3ce5-e541-4586-af28-c841b7dfa849.png 590w,\n/static/b4fa83c0d84e3cb9fe0a1666a09520bc/efc66/1665549983037-055c3ce5-e541-4586-af28-c841b7dfa849.png 885w,\n/static/b4fa83c0d84e3cb9fe0a1666a09520bc/c83ae/1665549983037-055c3ce5-e541-4586-af28-c841b7dfa849.png 1180w,\n/static/b4fa83c0d84e3cb9fe0a1666a09520bc/4a00e/1665549983037-055c3ce5-e541-4586-af28-c841b7dfa849.png 1406w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>所以，对于这种纯前端应用，就需要多一个 Web Origin 的配置，同样的，根据多个环境，可以相应地添加多个 Web Origin：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/dffd802f14113ab932878745a45051b9/f5aa5/1665550020588-728e1858-ef38-4ab0-98ba-7ccf65c98906.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 15.54054054054054%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAmklEQVR42jWO0QqCQBBF/f/Pqui5p16MtJKyJF1W13XmbtyYRS8MA3eYwyn2hyMtIQQ65xhjpIhwDoFRQZlG4nwinnfC9UTXEq+GqEsizgRAFcnbUuxWoEVVmVLK4Pb9YX+7cq4v1KqkDD3FDZQwUaaJMnrKsuQfk7HJwM3Qe5/LDYqUmMzA5tsRTU08KkKVSL98N6tsaN1q+Afpleaj8HRVPAAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/dffd802f14113ab932878745a45051b9/fcda8/1665550020588-728e1858-ef38-4ab0-98ba-7ccf65c98906.png\"\n        srcset=\"/static/dffd802f14113ab932878745a45051b9/12f09/1665550020588-728e1858-ef38-4ab0-98ba-7ccf65c98906.png 148w,\n/static/dffd802f14113ab932878745a45051b9/e4a3f/1665550020588-728e1858-ef38-4ab0-98ba-7ccf65c98906.png 295w,\n/static/dffd802f14113ab932878745a45051b9/fcda8/1665550020588-728e1858-ef38-4ab0-98ba-7ccf65c98906.png 590w,\n/static/dffd802f14113ab932878745a45051b9/efc66/1665550020588-728e1858-ef38-4ab0-98ba-7ccf65c98906.png 885w,\n/static/dffd802f14113ab932878745a45051b9/c83ae/1665550020588-728e1858-ef38-4ab0-98ba-7ccf65c98906.png 1180w,\n/static/dffd802f14113ab932878745a45051b9/f5aa5/1665550020588-728e1858-ef38-4ab0-98ba-7ccf65c98906.png 2312w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><a name=ZthkZ></a></p>\n<h2>Umi Js 引入 umi-plugin-oauth2 包</h2>\n<p>shell\nyarn add umi-plugin-oauth2</p>\n<p>不过，这个包还依赖其他几个 peer dependency，也需要一并安装一下（这是 umi-plugin-oauth2 的后续优化点，不需要用户手动安装 peer dependency）：</p>\n<p>shell\nyarn add ahooks client-oauth2 pkce</p>\n<p><a name=UAqL6></a></p>\n<h2>添加 oauth2Client 配置</h2>\n<p>在 umirc.[tj]s 文件中添加 oauth2Client 的配置项，这里需要填入一些 Keycloak 服务的可发现 Uri 以及其他信息。其中，那些可发现 OIDC 的 Uri 可以这样找到。先在领域配置中，点击 OpenID Endpoint Configuration：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/10bf0048ba10be677c1b7b2786896de4/14586/1665550340074-fb4218e1-c794-4b71-98f1-a8ce1f5881ef.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.16216216216216%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAACCklEQVR42n2Sb2/SUBSH+yXEGZ1RWXDLxhgFBmyMZZoYv58x8ZXO6RI/iUBHW31D1DcbxGhcxgrtoP9oH3NvAVGnJ/nl3Jyc+9zzO63S+fSFTqfDSVun1WqhmR9pahrNVotGs8n7RgPDNDEMA30q7UTng65haA20to5pGrR1Hd0wUdTaPrm8Sjq9wtLSLW6kUmQyGUqlIqqqzpXP56/RlszqQk3JFaqs50qsrOVYzRZI3b7Ps+cvsIY23V6Pfr+PNRgwmMqyLKnZWWTRc3lpyT6luPuI0s4++XKNYrXOvcwGR8fvEOH5PlEUMZlMCMKQIAgIp1nUxFlk1/PmNSVXrlN//JRCZY9ccYc7D1Y5PDqWQAEbj8c4ti0vua4rL81hYTiHzmrKplqhvHvA+ta21M3lNC8P3yQTep60NRqNBZ4oDPH9QE7zLylZtcrewRMJ3ciXWbq7wqvXbyVQvDq0ba7sIZ8HPhcjH+JkBQIeRRPpYlGKgCR2qwlwWQCTCYVd27YJPJfTyyvO7XGyCiCeKY6nQkpazqoVHm6ofwH9IMBxHAkeOiNOv53T7dv8OOvim03c0Rg3Bi+Y4AahlJKd7nBts7gA/GV5FmKfV46TfATfI/56Bh0TvvdgEiZNcYyyWahSrh3If/DPCcXlmaXrQlq2LohHzty+klXLqNu1/wL5bVczRUle3CXwEzla8Kjz/UgtAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/10bf0048ba10be677c1b7b2786896de4/fcda8/1665550340074-fb4218e1-c794-4b71-98f1-a8ce1f5881ef.png\"\n        srcset=\"/static/10bf0048ba10be677c1b7b2786896de4/12f09/1665550340074-fb4218e1-c794-4b71-98f1-a8ce1f5881ef.png 148w,\n/static/10bf0048ba10be677c1b7b2786896de4/e4a3f/1665550340074-fb4218e1-c794-4b71-98f1-a8ce1f5881ef.png 295w,\n/static/10bf0048ba10be677c1b7b2786896de4/fcda8/1665550340074-fb4218e1-c794-4b71-98f1-a8ce1f5881ef.png 590w,\n/static/10bf0048ba10be677c1b7b2786896de4/efc66/1665550340074-fb4218e1-c794-4b71-98f1-a8ce1f5881ef.png 885w,\n/static/10bf0048ba10be677c1b7b2786896de4/c83ae/1665550340074-fb4218e1-c794-4b71-98f1-a8ce1f5881ef.png 1180w,\n/static/10bf0048ba10be677c1b7b2786896de4/14586/1665550340074-fb4218e1-c794-4b71-98f1-a8ce1f5881ef.png 2314w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>在打开的新页面里，去拷贝相关的 Uri （这是 umi-plugin-oauth2 另一个的后续优化点，争取做到用户只需要填入这个可发现链接即可，插件包自行解析其他的 Uri）：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5ccad6dcc41680f52015665f43771e73/0c307/1665550491015-47b30897-00e5-4b1a-b189-3a5467f79234.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.567567567567565%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABmElEQVR42qWRa2vbMBSG/f//ze4d7SjdYFu2UEq3xlkuviRO6tiJY0uxLF/kZ0RZwwr7tgMP76uDeI/EceJNQrhYEMUJcZKSpilJmrJJUrIsY5dlFEIipCQXklLsybMdeSEQUlgtRE4hhMXJCsm+kCjdouuWSjcoXaOqmrrpbO9QKlSlOagKrTXGdBhj6PseY/rz+YhTlSW1LqlUjq6k9bU+oLU807UNpm1PdB2YHo6BXWv173J+DT4S3N0Q/rwimnxmOf/AYnZFOLskmFxYovk1K+/mzNr7xGp+w255SxV7NI3C9N0p0BtcM/vyknB4STz+ytK9IBy9I3LfW79w3xI8vMJ/eEE4ekM4em17T37vDzmoLW1XnwJHd98Z/xji3n9jMr5l4g5Yzu/J4hl55pPvA4p9eNYnSvFIKWKMOjz/sh+ErB4jgmjKejsjFT5p4ZMKj0TM2RTTZ5rYvkehEso6R+odskoRamNf6SxjlyiekqRrtK7slL4/bfCE+SfGtHSmsXrccmdae9/ZSp+t9Kja4k8Y/1W/AcXLqJeGX5tGAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/5ccad6dcc41680f52015665f43771e73/fcda8/1665550491015-47b30897-00e5-4b1a-b189-3a5467f79234.png\"\n        srcset=\"/static/5ccad6dcc41680f52015665f43771e73/12f09/1665550491015-47b30897-00e5-4b1a-b189-3a5467f79234.png 148w,\n/static/5ccad6dcc41680f52015665f43771e73/e4a3f/1665550491015-47b30897-00e5-4b1a-b189-3a5467f79234.png 295w,\n/static/5ccad6dcc41680f52015665f43771e73/fcda8/1665550491015-47b30897-00e5-4b1a-b189-3a5467f79234.png 590w,\n/static/5ccad6dcc41680f52015665f43771e73/efc66/1665550491015-47b30897-00e5-4b1a-b189-3a5467f79234.png 885w,\n/static/5ccad6dcc41680f52015665f43771e73/c83ae/1665550491015-47b30897-00e5-4b1a-b189-3a5467f79234.png 1180w,\n/static/5ccad6dcc41680f52015665f43771e73/0c307/1665550491015-47b30897-00e5-4b1a-b189-3a5467f79234.png 2526w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>这样，得到的 umirc.[tj]s文件如下：</p>\n<p>javascript\n...</p>\n<p>oauth2Client: {\nclientId: demoapp,\naccessTokenUri:\n<a href=\"https://keycloak.jiwai.win/auth/realms/UniHeart/protocol/openid-connect/token\">https://keycloak.jiwai.win/auth/realms/UniHeart/protocol/openid-connect/token</a>,\nauthorizationUri:\n<a href=\"https://keycloak.jiwai.win/auth/realms/UniHeart/protocol/openid-connect/auth\">https://keycloak.jiwai.win/auth/realms/UniHeart/protocol/openid-connect/auth</a>,\nredirectUri: <a href=\"https://umi-ckeditor5.vercel.app/oauth2/callback\">https://umi-ckeditor5.vercel.app/oauth2/callback</a>,\nscopes: [openid, email, profile],\nuserInfoUri:\n<a href=\"https://keycloak.jiwai.win/auth/realms/UniHeart/protocol/openid-connect/userinfo\">https://keycloak.jiwai.win/auth/realms/UniHeart/protocol/openid-connect/userinfo</a>,\nuserSignOutUri:\n<a href=\"https://keycloak.jiwai.win/auth/realms/UniHeart/protocol/openid-connect/logout\">https://keycloak.jiwai.win/auth/realms/UniHeart/protocol/openid-connect/logout</a>,\nhomePagePath: /,\n},\n...</p>\n<p>注意以上的 redirectUri 填写了线上地址，在本地启动的话，得用本地的地址，这时，只需要在 umirc.local.[tj]s文件中覆盖 refirectUri 即可：</p>\n<p>javascript\nimport { defineConfig } from umi;</p>\n<p>export default defineConfig({\noauth2Client: {\nredirectUri: <a href=\"http://localhost:8000/oauth2/callback\">http://localhost:8000/oauth2/callback</a>,\n},\n});</p>\n<p><a name=HLBxr></a></p>\n<h2>添加一个 wrappers/auth.jsx 文件</h2>\n<p>比如这样：</p>\n<p>jsx\nimport React from react;\nimport { useEffect } from react;\nimport { useOAuth2User } from umi;</p>\n<p>const isEmptyObject = (obj) =>\nObject.keys(obj).length === 0 &#x26;&#x26; obj.constructor === Object;</p>\n<p>const Auth = (props) => {\nconst { children } = props;</p>\n<p>const { token, user, signIn, refresh } = useOAuth2User();</p>\n<p>useEffect(\n() => {\nconsole.log(token = , token, user);\nif (token === undefined || isEmptyObject(token) || user === undefined) {\nsignIn();\n} else if (token !== undefined) {\nrefresh(token);\n}\n},\n[],\n);</p>\n<p>if ((token !== undefined &#x26;&#x26; !isEmptyObject(token)) || user !== undefined) {\nreturn children;\n}</p>\n<p>return <span>Loading...</span>;\n};</p>\n<p>export default Auth;</p>\n<p><a name=aOeor></a></p>\n<h2>在组件中使用</h2>\n<p>比如像这样\njsx\nimport react;\nimport { useOAuth2User } from umi;</p>\n<p>export const UserInfo = () => {\nconst { token, user, signIn, signOut } = useOAuth2User();\nreturn (\n<div>\n<p>\n{!token ? (\n<button onClick={signIn}>登录</button>\n) : (\n<button onClick={signOut}>退出</button>\n)}\n</p>\n<div>\n<strong>Token Object</strong>: <br />\n&#x3C;textarea\nreadOnly\nstyle={{ width: 100%, height: 15em }}\nvalue={JSON.stringify(token, null, 4) ?? 登录后可见}\n></textarea>\n<strong>User Object</strong>:<br />\n&#x3C;textarea\nreadOnly\nstyle={{ width: 100%, height: 15em }}\nvalue={JSON.stringify(user, null, 4) ?? 登录后可见}\n></textarea>\n</div>\n</div>\n);\n};</p>\n<p>这样就完成了 UmiJs 和 Keycloak 的对接！</p>\n<p><a name=xcNAV></a></p>\n<h1>总结</h1>\n<p>采用 umi-plugin-oauth2 插件包，可以轻松对接 OAuth 2.0 授权服务。目前我给出了 IdentityServer 和 Keycloak 两个具体的例子。</p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}},"menus":{}}},"staticQueryHashes":[],"slicesMap":{}}