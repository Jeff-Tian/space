{"componentChunkName":"component---src-templates-post-js","path":"/posts/zsv9q16ehccamysu/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/zsv9q16ehccamysu","relativePath":"posts/zsv9q16ehccamysu","frontmatter":{"title":"Keycloak 自定义用户联邦示例","stackbit_url_path":"posts/zsv9q16ehccamysu","date":"2023-03-29T10:25:44","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p>上次，在《<a href=\"https://zhuanlan.zhihu.com/p/588455371\">Free Arch: Keycloak 用户联邦 LDAP 初体验（感谢 Authing!） - Jeff Tian的文章 - 知乎 </a> 》一文里，利用 Authing.cn 提供的免费 LDAP，初探了 Keycloak 的用户联邦功能。Keycloak 自带的用户联邦，只有 Kerberos 和 LDAP 两种，今天，我们通过 Keycloak 提供的 User Storage SPI 来自定义一个用户联邦提供程序：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ddc996859f210bf47241b83d1f2f27b9/79daf/1680055045703-693836fe-7acb-4cba-a983-081e96527e85.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 70.94594594594594%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABYlAAAWJQFJUiTwAAACqElEQVR42o2Sy08TURTGZ8UKV0DBYiyPaaeltIUylPJITEw0akgUgVSQhWGD0b/GhYlQRNCoC/8LEmICiyYCaozEltKW0pm50wel78+cWzoBE6M3+XLOvZn53e+cc4WnS0tYevYcTxYX8XhhAXNz85iZncXU1END09PTCAQeIRAI/FOCqa0NZksXTO3tuNLcjKamJoiiiPHxMfj9foz6/fD5fJBlmWv4PP5NgsPphtUm4dp1C3pFG0wdZrz/8BHFQgGRSASHh4fI5XL43yW4PF7YnR50i3ZYHf1o7ejE2pt11GpVJJNJqKqKdDrNoaRMJsNFZxSz2eylM8E9KIOgPaKEXpsDre1mrARXUSgUkEgc4+TkBIlEwlAsFgNj7BLoYi64BoYw7B+HKPWhx2pHW0cnXi2vcHe7u7sIh8NQFIVL0zSkUinumnJd13mkPYkuEtwDQ5D6XLD0WCFKdYfB1dc4PT1FPB433NDPBKWcSqdIl1KZ+Xyef09w7tDR7zkH9qHFdBXrG2/5QLa3t7G/v89/oHK3trawt7fHIeVKCZubm3wfjUZRKpXqDr3yCFwDXgPY6CGtcrmMSqWCWq3G88YZakCtVJ9qKBTiL6FardYdNnrX1WuDeGEotIrFIiqVMo/FQgkogzvLlBUc5HdwdPYVsaMYb4XhkEr2eGU+YYLTUJaDQX6jqmjIsByYzpBkR/jJQvjOPuMH20GM/YLKUshl60+JYNRn/g59oxOwO93oFiW0mMxYWV7jwGMlhgj7xkGkOAtDYyqyeh4ZnQaVBmOaAeMOB+URjE3cAEXJ6YK5y4KXGy+gVaI4UL4gwSLQmIKMnjuH6GC6xl2TaN8QB96dvI+pmQDuTT7AzTu3MHJ7GO8+raNQOgNT00gThOmGE+6G6Ub+p34DyeFAC4WrUNsAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/ddc996859f210bf47241b83d1f2f27b9/fcda8/1680055045703-693836fe-7acb-4cba-a983-081e96527e85.png\"\n        srcset=\"/static/ddc996859f210bf47241b83d1f2f27b9/12f09/1680055045703-693836fe-7acb-4cba-a983-081e96527e85.png 148w,\n/static/ddc996859f210bf47241b83d1f2f27b9/e4a3f/1680055045703-693836fe-7acb-4cba-a983-081e96527e85.png 295w,\n/static/ddc996859f210bf47241b83d1f2f27b9/fcda8/1680055045703-693836fe-7acb-4cba-a983-081e96527e85.png 590w,\n/static/ddc996859f210bf47241b83d1f2f27b9/efc66/1680055045703-693836fe-7acb-4cba-a983-081e96527e85.png 885w,\n/static/ddc996859f210bf47241b83d1f2f27b9/c83ae/1680055045703-693836fe-7acb-4cba-a983-081e96527e85.png 1180w,\n/static/ddc996859f210bf47241b83d1f2f27b9/79daf/1680055045703-693836fe-7acb-4cba-a983-081e96527e85.png 2792w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><a name=SL9ND></a></p>\n<h1>User Storage SPI</h1>\n<p>官方文档见： <a href=\"https://www.keycloak.org/docs/latest/server_development/index.html#_user-storage-spi\">https://www.keycloak.org/docs/latest/server_development/index.html#_user-storage-spi</a>。它用来扩展 Keycloak，以连接到外部的用户数据库和凭据存储。前面提到的 Keycloak 内置的 LDAP 以及 ActiveDirectory 支持，就是实现了该 SPI 接口。Keycloak 提供了开箱即用的本地数据库来创建、更新和查找用户以及验证其凭据。但是，对于企业来说经常会存在一些外部专用的用户数据库的情况，并且出于各种原因，这些数据库不能迁移到 Keycloak 的数据模型中。在这种情况下，应用开发者就需要写一个专门的 User Storage SPI 具体实现来桥接外部用户存储和 Keycloak 内部所使用的用户对象，从而能够在 Keycloak 中登录这些用户，以及在 Keycloak 中管理他们。</p>\n<p>当 Keycloak 运行时需要查找一个用户时（比如当用户登录时），它会执行一系列的步骤来定位用户。首先看用户缓存中是否能找到该用户；如果找到了，就使用该缓存中的用户内存表示。然后在 Keycloak 的本地数据库中查找，没有找到的话，就循环遍历 User Storage SPI 提供者程序来执行用户查询，直到某一个 SPI 提供者程序返回该用户。返回该用户的提供者程序需要查询外部用户存储，并且负责将外部数据表示映射成为 Keycloak 的用户元模型。</p>\n<p>User Storage SPI 提供者程序实现还能执行复杂的条件查询、向用户执行增删改查操作、验证和管理凭据、以及对多个用户执行批量更新。这些都取决于外部存储的能力。</p>\n<p>User Storage SPI 提供者程序实现的打包和部署方式与 Jakarta EE 组件非常相似，很多时候甚至可以将 User Storage SPI 直接等同于 Jakarta EE 组件。不过，在打包和发布之后，它们并不会默认就开启，而是要在管理控制台中，从领域的“用户联邦”选项卡中手动开启。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f436f79a3eefbe17c7886476943caf70/f705e/1680057509019-43d87948-c370-495e-8610-ed870b7007c1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.21621621621621%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAACQUlEQVR42p2RTU8TURSGZ2XdEokbDfRz2mk7bWk709ZFjbroQonRf0BrAENi2Ij6F/wV/gR14YalO1lIQYG4YmNICiltZujX3JnH9E4lVdBET/LMOXdO7nvfc6/yYmOD5y9f8Wx9nbW1NVZXn9JoPKFer09o+OtGg6WluszLKyssL6/4+TeUmZkZrt+4ybXZWQKBK1wNBNAzGYxSBcMsYRgGxWKRkmlSqVQol8vnlEolTNPANM1zlJSeJZ7QmAuGCIYjJNM6e1+/MRBgnQ2wLItut0u/38dxBEL4OI7DZaGkMgskUlnCsQShaBxNy7H56S0d64T2SZvj42PabT8fHR3RarUk49q2LSnied74I7OSWSiQN8pEVI35cIxoXOPd1hsGox49uyc39IeCU1tgD8HqTxhAt+fJ/x3b7w9GLko6s0A2b0iHwVCCYCrIx/0P2J0+nc4pHjAcjeTYI0fgCBfHmTCuhYdwPdkTwkXRcwXiSZ1gRGVuXiVdVdk73JbOHOGAKzhrdzhptRGDAa4czb2A67qTkXMF9FxeCs6HVPR7UXb3dnxBd+zPYXPrO6/fHzKyzxi6/uV7XB5KMp1F1dJSLJyMkqrGaH7elU3hutKhsC1Gtg3COX+EP6EkUhmSepZQRCOai6AZCZrbX+RGV4hfnHg/X3QqX3CoZ/MUShViqk7MCKKmNHaaUw6nTpe1r/YXwVyB8q0qmWKeSD5EVE2yszsl+I+h1B48YvHhY2qL96nWbnPnbo39gwN/5P8Q/AFi6iGHiStPXwAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/f436f79a3eefbe17c7886476943caf70/fcda8/1680057509019-43d87948-c370-495e-8610-ed870b7007c1.png\"\n        srcset=\"/static/f436f79a3eefbe17c7886476943caf70/12f09/1680057509019-43d87948-c370-495e-8610-ed870b7007c1.png 148w,\n/static/f436f79a3eefbe17c7886476943caf70/e4a3f/1680057509019-43d87948-c370-495e-8610-ed870b7007c1.png 295w,\n/static/f436f79a3eefbe17c7886476943caf70/fcda8/1680057509019-43d87948-c370-495e-8610-ed870b7007c1.png 590w,\n/static/f436f79a3eefbe17c7886476943caf70/efc66/1680057509019-43d87948-c370-495e-8610-ed870b7007c1.png 885w,\n/static/f436f79a3eefbe17c7886476943caf70/c83ae/1680057509019-43d87948-c370-495e-8610-ed870b7007c1.png 1180w,\n/static/f436f79a3eefbe17c7886476943caf70/f705e/1680057509019-43d87948-c370-495e-8610-ed870b7007c1.png 2998w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1b5990ba67d81f9b7ef7d16a166ea5f5/41870/1680057436054-a5a44d9d-6b8a-479d-8576-7e50f0c0a71a.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 85.8108108108108%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAABYlAAAWJQFJUiTwAAADbElEQVR42nWU7U9bVRjA76dBQuqHubW2DEoLbaEFt/HSIsMJwSmC071o3D+g33Roglli5hZf4idjIuocMF8Yn4hR/wn94OY+bNQwUlmRWroCvS2097a9t/2Zc0qBYXaSX845Nze/+zzPOc9VZmdnuTk7y43paSYmvuLrb65x7dvrXJ+ckkxOVZiavsHk1DTfff+DfH/m5i5i/+PMDHNzP6E0NDTgcjbi6QrSGQzianJit9uxWCw8YbFQV1dHbW3tLjU11Bw4QI2YtxHPFUXB6/WhOJuacLlcNLqbcbnd1NfXY7c7sNlsWK1WGp1OAoEAfr9/h/17gc/nIxQKobR4W/G3H6Wj4xhenx+nq4Umt4cWTyuHbQ7G37+ErutsbGw8QiqVIp1O75DJZFBTKkqg/Sj9zw7Q1dOLr60dV7MXd4sPj8/PIauDK1c/wjAMwuEw9xcXuTc/z92794hEIpRMEyhDuYRpmhJFSI519tDY1CwjEzIhbfG2ccjm4PKHVymXSkQfLLEsiD4gtvIP8Xic2GqSlXiSxeUEyeQaiUSiIgz2nqAt8PSOUCCEh6XwCmLEVtdIrKmS1eQ6Gc0glTNJa6acq0MRIpGyiLKablX4pNXB5Q8u8XvUYPDzRYa/jDAy8TdDX0Q4/vFf3I5myWgmyc0icbXIpm6itPo7pGxv/XYjrGd8fJy1HMz9keSXO+v8emeDn/9cZ+7WOg8zBYpGCa1gki+aGGZJpBzgeFePFOwXWp+q5+LYe1AyoJyvYGpQ0uVay25tn/A26TRK9USFQNRQSKuHIoTvjL1bqeG/cVLpjFznC0VJoVCU10dV06iqKqnU8OQAXd0hKa5GKNY2+5FKhOUyW1tbFAoFKdQ0TV4lsReSvfdR1rCzOyTrGOo9QbOndU+EFWEZyOVybG5myGazPEwmyefzjxcGe/voCfXR3dP7yMWWEV4cg5LJajzO/HyY5WiU2PIyhccJPb42Qs/009kdlFLxgSNONy63h4NWO2+/+RbEllhfWCD82y3S9xcwV5bANCgaBuq+FlSGXnqVkdHTjJ4+w8jLrzB06kX6Tw7y3ODzsh1F6xXzOnouR0HXyesaeV2X/S3S/1+EI2cvcObsec6/foFzr73BC8OjDJ0alnNf/wCffPrZzs8hlVJJqdvI063I9kr/AxuufICL1AIuAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/1b5990ba67d81f9b7ef7d16a166ea5f5/fcda8/1680057436054-a5a44d9d-6b8a-479d-8576-7e50f0c0a71a.png\"\n        srcset=\"/static/1b5990ba67d81f9b7ef7d16a166ea5f5/12f09/1680057436054-a5a44d9d-6b8a-479d-8576-7e50f0c0a71a.png 148w,\n/static/1b5990ba67d81f9b7ef7d16a166ea5f5/e4a3f/1680057436054-a5a44d9d-6b8a-479d-8576-7e50f0c0a71a.png 295w,\n/static/1b5990ba67d81f9b7ef7d16a166ea5f5/fcda8/1680057436054-a5a44d9d-6b8a-479d-8576-7e50f0c0a71a.png 590w,\n/static/1b5990ba67d81f9b7ef7d16a166ea5f5/efc66/1680057436054-a5a44d9d-6b8a-479d-8576-7e50f0c0a71a.png 885w,\n/static/1b5990ba67d81f9b7ef7d16a166ea5f5/c83ae/1680057436054-a5a44d9d-6b8a-479d-8576-7e50f0c0a71a.png 1180w,\n/static/1b5990ba67d81f9b7ef7d16a166ea5f5/41870/1680057436054-a5a44d9d-6b8a-479d-8576-7e50f0c0a71a.png 1788w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<blockquote>\n<p>需要注意的是，如果提供者程序实现使用了用户属性作为链接/建立用户身份的元数据属性，那就得保证用户不能编辑这些属性，并且需要将相关的属性都设置了只读。比如 LDAP_ID属性，被 Keycloak 内置的 LDAP 提供者用作存储用户在 LDAP 服务器侧的 ID。</p>\n</blockquote>\n<p><a name=oR8zS></a></p>\n<h1>效果演示</h1>\n<p>出于简单性考虑，我们添加一个外部用户，用户名是 test-user，密码是 test-password。\njava\npublic CustomUserStorageProvider(KeycloakSession session, ComponentModel model, Properties properties) {\nthis.session = session;\nthis.model = model;\nthis.properties = new Properties();</p>\n<pre><code>this.properties.put(test-user, test-password);\n</code></pre>\n<p>}</p>\n<p>用户登录时，我们在校验密码处打印一行日志：</p>\n<p>java\n@Override\npublic boolean isValid(RealmModel realmModel, UserModel userModel, CredentialInput input) {\nlogger.info(CredentialInputValidator.isValid);\nif (!supportsCredentialType(input.getType())) return false;\nString password = properties.getProperty(userModel.getUsername());\nif (password == null) return false;\nreturn password.equals(input.getChallengeResponse());\n}</p>\n<p>当使用 test-user 和 test-password 登录 Keycloak 时（登录链接形如：<a href=\"https://keycloak.jiwai.win/auth/realms/UniHeart/protocol/openid-connect/auth?client_id=UniHeart-Client&#x26;state=d70e525d-c59e-4e49-8240-240df9bb910d&#x26;redirect_uri=http%3A%2F%2Falpha-jeff-tian.cloud.okteto.net%2Fkeycloak%2Flogin%3Fauth_callback%3D1&#x26;scope=openid&#x26;response_type=code\">https://keycloak.jiwai.win/auth/realms/UniHeart/protocol/openid-connect/auth?client_id=UniHeart-Client&#x26;state=d70e525d-c59e-4e49-8240-240df9bb910d&#x26;redirect_uri=http%3A%2F%2Falpha-jeff-tian.cloud.okteto.net%2Fkeycloak%2Flogin%3Fauth_callback%3D1&#x26;scope=openid&#x26;response_type=code</a>），控制台有相关的日志输出：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40.54054054054054%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABYUlEQVR42j1S2W7EIBDLS5Pu5iDcwxECu1Hb//9BV0OVPlhiNIzHNgwyJmxE0McBlRJkzlikhCdCjBHkPVKMKKXAaA1jNKy1cM71WimF5/OJeZ7xOU0YlhAgS+lYQ8SWMz6FgPUeRARjDEIInVxrjWVdIYTo2LYN+773s5Sykw42Jbic8RAC47J0smmee5MHHo9HH2KwmnuYa+5zffcnVsg2d1ZGhD0EqJyxsRWt/ywT/YOVst3bMpMw+Y2u0LBdzo6VnidcbRA85BxaazhK+Qfnqo3pvZuQVXMUDM5yuC+GGBFTQjnPXuecceSEkhJyCEhEuFrF93XhXSuuV+t3aq39wXg5LxmOWhFLwfl+o7QGYqKu6MT3kfBVDvy8Gl45wYoNQUmQkshagrSCsbar5MdjxQNnJ2LE4j1m67AS4SkEtHO4gkclhzMQTvI4vOuEQStEKbBOIz6mqX8Xzm8cR/wC1AHHfTfLbKAAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/d812ee6311ca43b68c059a21e320f664/fcda8/1680057796633-fcfc041f-961d-4f67-8936-3559b8af8ea9.png\"\n        srcset=\"/static/d812ee6311ca43b68c059a21e320f664/12f09/1680057796633-fcfc041f-961d-4f67-8936-3559b8af8ea9.png 148w,\n/static/d812ee6311ca43b68c059a21e320f664/e4a3f/1680057796633-fcfc041f-961d-4f67-8936-3559b8af8ea9.png 295w,\n/static/d812ee6311ca43b68c059a21e320f664/fcda8/1680057796633-fcfc041f-961d-4f67-8936-3559b8af8ea9.png 590w,\n/static/d812ee6311ca43b68c059a21e320f664/efc66/1680057796633-fcfc041f-961d-4f67-8936-3559b8af8ea9.png 885w,\n/static/d812ee6311ca43b68c059a21e320f664/c83ae/1680057796633-fcfc041f-961d-4f67-8936-3559b8af8ea9.png 1180w,\n/static/d812ee6311ca43b68c059a21e320f664/412e0/1680057796633-fcfc041f-961d-4f67-8936-3559b8af8ea9.png 2990w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n<a name=Ayqne></a></p>\n<h1>完整代码改动</h1>\n<p>代码提交见：<a href=\"https://github.com/Jeff-Tian/keycloak-heroku/commit/bbf30f6ecdeba8fec0f3a612893f77eef083604a\">https://github.com/Jeff-Tian/keycloak-heroku/commit/bbf30f6ecdeba8fec0f3a612893f77eef083604a</a>\n<a name=iAnoj></a></p>\n<h1>注意事项</h1>\n<p>完整提交见： <a href=\"https://github.com/Jeff-Tian/keycloak-heroku/commit/6dbd3081dcfdc218c7c7e7e19fa3c25cb04837b2\">https://github.com/Jeff-Tian/keycloak-heroku/commit/6dbd3081dcfdc218c7c7e7e19fa3c25cb04837b2</a><br />本次演示使用了 21.0 的 Keycloak，要注意的是相关的 spi 依赖，需要至少升级到 13.0.1 版本。</p>\n<p>xml\n<dependency>\n<groupId>org.keycloak</groupId>\n<artifactId>keycloak-server-spi</artifactId>\n<scope>provided</scope>\n<version>13.0.1</version>\n</dependency></p>\n<p>否则，在在运行时可能会报这个错：</p>\n<p>xml\ndoes not define or inherit an implementation of the resolved method abstract org.keycloak.models.UserModel getUserByUsername(org.keycloak.models.RealmModel, java.lang.String) of interface org.keycloak.storage.user.UserLookupProvider.</p>\n<p>原因是 spi 中 getUserByUsername方法的参数顺序有了调整。详见 <a href=\"https://www.keycloak.org/docs-api/13.0/javadocs/org/keycloak/storage/user/UserLookupProvider.html\">https://www.keycloak.org/docs-api/13.0/javadocs/org/keycloak/storage/user/UserLookupProvider.html</a>：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3aa3c09dc3f6e217a7bc58a4fcaaafed/3707e/1680083783485-9c9e38f5-61b4-4d24-b5b5-52796c65061a.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.89189189189189%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAACgklEQVR42m2TS2/jNhRG9f+X3XbVVdtdC3SRPpNOigIeNMnE7US2lfFL1JsiKckUZcfKKcSgwQQogQM+LsjL7/JjcD6fGVxP17UUVYVUCt00mKahlIo0r8hL6clKiTKNj2vT0B0sw3DEDcMrge0HZONQreN8Gnjbnv+Hz6LjmePx+IbAlo8kf3xJPPuaX2Zzru6WXN6G/H634N39iut5xPXU36/8mufDksubkCjOOB2P9L3DuRcCk0X8+d0XzC6+4od3N1zdrvj5/UcubxZ8f/meby+u+ebi2o9/nH30sV//Cvlp9g93iy1SNeSVppAvBMenZ1o30rhnnHsruWtbirKiqiRFUaKURiuJmuqsFMPQM44j4xnO4+gJXN8TixQppT9g2jRhtGG7i3lYRGx2ApFkCJGQJBnbfeLnuuxoTUepM4xpMMYQuNOJWhuUaalNS3uwNN2Bg+0RaU4YbdiIHJGXlLL2cd0eMF3HXF0xb34jble0becJTrJAx3tMknhGozy0hnq/R6wixHLJ9iEki1aIZUiyjKjiFeI0ZxgtjLxInyTbJGYbZ5R5Qas1cvJiWaHrmmj1yO3dPY+Pa+J9jIgF6/WOWCQUnx6xhUbrzperrpUnGDKBSQV1HFPu9vRViS0LXF2RRBHhhzmfHhZsw5B8s0GLGJUI6u2WKku9wa3tsdZ6gpNzdEphmwbbtpxd7xkHh5E1Mi8o04xcJORJSi4EebwnSzMqKb33pt/29HT2fWB7x3qXkBUVWhtkrZG1QmlDtN5x+3dItNmziVN2IkUkKUlW+DJNL52mmZcqp+SyJpicbg/WczgcXpmuP/lvL1KfrChrqqqi67pXef/x+b5/AZl4yyAu8PhXAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/3aa3c09dc3f6e217a7bc58a4fcaaafed/fcda8/1680083783485-9c9e38f5-61b4-4d24-b5b5-52796c65061a.png\"\n        srcset=\"/static/3aa3c09dc3f6e217a7bc58a4fcaaafed/12f09/1680083783485-9c9e38f5-61b4-4d24-b5b5-52796c65061a.png 148w,\n/static/3aa3c09dc3f6e217a7bc58a4fcaaafed/e4a3f/1680083783485-9c9e38f5-61b4-4d24-b5b5-52796c65061a.png 295w,\n/static/3aa3c09dc3f6e217a7bc58a4fcaaafed/fcda8/1680083783485-9c9e38f5-61b4-4d24-b5b5-52796c65061a.png 590w,\n/static/3aa3c09dc3f6e217a7bc58a4fcaaafed/efc66/1680083783485-9c9e38f5-61b4-4d24-b5b5-52796c65061a.png 885w,\n/static/3aa3c09dc3f6e217a7bc58a4fcaaafed/c83ae/1680083783485-9c9e38f5-61b4-4d24-b5b5-52796c65061a.png 1180w,\n/static/3aa3c09dc3f6e217a7bc58a4fcaaafed/3707e/1680083783485-9c9e38f5-61b4-4d24-b5b5-52796c65061a.png 1878w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>出于兼容性考虑，需要同时添加以下方法：\njava\n@Override\npublic UserModel getUserByUsername(RealmModel realm, String username) {\nreturn this.getUserByUsername(username, realm);\n}</p>\n<p>另外，在添加 spi 依赖时，  <scope>provided</scope> 这一行非常重要，否则会报一个编译错误：\nxml\nBuild step org.keycloak.quarkus.deployment.KeycloakProcessor#configureProviders threw an exception: java.util.ServiceConfigurationError: org.keycloak.provider.Spi: org.keycloak.locale.LocaleSelectorSPI not a subtype</p>\n<p>详见： <a href=\"https://github.com/keycloak/keycloak/issues/10230#issuecomment-1047695223\">https://github.com/keycloak/keycloak/issues/10230#issuecomment-1047695223</a></p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}},"menus":{}}},"staticQueryHashes":[],"slicesMap":{}}