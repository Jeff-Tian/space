{"componentChunkName":"component---src-templates-post-js","path":"/posts/ooedgb","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/ooedgb","relativePath":"posts/ooedgb","frontmatter":{"title":"Free Arch【已解决】七牛云上传 Cloudflare 证书","stackbit_url_path":"posts/ooedgb","date":"2022-05-12T15:17:47","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p><a name=bomvF></a></p>\n<h1>【问题】</h1>\n<p>在七牛云的证书管理页面，上传证书时，出现 <strong>[400338] 获取父级证书失败，请稍后重试</strong>的报错。</p>\n<p><a name=qFE4I></a></p>\n<h1>【详细描述】</h1>\n<p>通过实际测试发现，即使使用了 Cloudflare 对静态站点进行 CDN 加速，其文件下载速度在上海的电信网络里实测仍然非常慢。虽然是电信千兆光纤网，但是下载一个32兆的文件，仍然需要长达一个小时，无法忍受。你也可以打开这个页面，尝试下载页面上的 apk 文件试试。<br /><a href=\"https://app.jeff-tian.jiwai.win/\">https://app.jeff-tian.jiwai.win/</a><br /><img src=\"https://cdn.nlark.com/yuque/0/2022/png/221736/1652363782791-70bf9af3-8ba1-4578-8787-3b1af0a8d2dc.png#clientId=u981ed5f2-8c9f-4&#x26;crop=0&#x26;crop=0&#x26;crop=1&#x26;crop=1&#x26;from=paste&#x26;height=412&#x26;id=ua2a76dd6&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=824&#x26;originWidth=2042&#x26;originalType=binary%E2%88%B6=1&#x26;rotation=0&#x26;showTitle=false&#x26;size=138955&#x26;status=done&#x26;style=none&#x26;taskId=uc931656c-4427-4d6b-8f53-e0b8480c7ca&#x26;title=&#x26;width=1021\" alt=\"image.png\"></p>\n<p>推测 Cloudfloare 的 CDN 结点在中国还是比较少，于是想起了七牛云，想使用七牛云的 CDN 文件分发功能。但是我在在 Cloudflare 的配置里对 jiwai.win 这个域名配置了 https，这个配置不能轻易改动，否则会影响其他的子域名，这带来的问题是，通过七牛云的 CDN 加速后，实际上如果使用 https:// 访问会报 PROTOCOL_MISMATCH 的错误，而通过 http:// 访问呢，那肯定也是不行的了。七牛云这时会自动跳转到源站的 https 协议上，导致没有加速效果。</p>\n<p>这时，只能以 https 的形式来开通这个 CDN 加速，这时七牛云会要求选择一个 https 证书，要么购买，要么直接上传自有证书。购买是 Free Arch 不能接受的，不过七牛云很贴心地提供了一种免费的 DV 证书，这虽然免费，但仍然不能被 Free Arch 接受，有两个原因：</p>\n<ol>\n<li>有个审核期，这就阻碍了 Free Arch 的自由这一层的含义，Free Arch 要求的是立刻马上生效；</li>\n<li>DV 证书申请通过后，只有一年的有效期，这太烦了，每年都要再来一次，忍受这个审核期。<br /><img src=\"https://cdn.nlark.com/yuque/0/2022/png/221736/1652366430826-5f06f627-ff0f-41c7-afaa-4b3afd03c272.png#clientId=u981ed5f2-8c9f-4&#x26;crop=0&#x26;crop=0&#x26;crop=1&#x26;crop=1&#x26;from=paste&#x26;height=549&#x26;id=u345abaf3&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=1098&#x26;originWidth=1644&#x26;originalType=binary%E2%88%B6=1&#x26;rotation=0&#x26;showTitle=false&#x26;size=158963&#x26;status=done&#x26;style=none&#x26;taskId=u37897405-6fe1-4c0e-af43-a322de5f9a9&#x26;title=&#x26;width=822\" alt=\"image.png\"></li>\n</ol>\n<p>这时，我想到是要加速 Cloudflare，而 Cloudflare 生成的证书的有效期，可以最长 15 年。于是我想到直接上传 Cloudflare 的源站证书了。<br /><img src=\"https://cdn.nlark.com/yuque/0/2022/png/221736/1652366567679-4c211a28-e5cd-47a1-85b7-355de733ddcb.png#clientId=u981ed5f2-8c9f-4&#x26;crop=0&#x26;crop=0&#x26;crop=1&#x26;crop=1&#x26;from=paste&#x26;height=311&#x26;id=ue47715cf&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=622&#x26;originWidth=1814&#x26;originalType=binary%E2%88%B6=1&#x26;rotation=0&#x26;showTitle=false&#x26;size=77265&#x26;status=done&#x26;style=none&#x26;taskId=u04aa093f-f63b-422a-82f9-78b713bd548&#x26;title=&#x26;width=907\" alt=\"image.png\"></p>\n<p>这时碰到的问题是，生成的证书怎么也传不上去，会报 **[400338] 获取父级证书失败，请稍后重试 **这个错误信息。</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2022/png/221736/1652363467568-4df4d16f-9e49-492e-96d0-d57348a6f8f0.png#clientId=u981ed5f2-8c9f-4&#x26;crop=0&#x26;crop=0&#x26;crop=1&#x26;crop=1&#x26;from=paste&#x26;height=230&#x26;id=u535a91ba&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=460&#x26;originWidth=1118&#x26;originalType=binary%E2%88%B6=1&#x26;rotation=0&#x26;showTitle=false&#x26;size=47346&#x26;status=done&#x26;style=none&#x26;taskId=u66a3da3d-fbf9-4f61-9352-6eeee605674&#x26;title=&#x26;width=559\" alt=\"image.png\"></p>\n<p><a name=tASwX></a></p>\n<h1>【背景】如何获取 Cloudflare 源证书？</h1>\n<p>我也忘了具体的做法，还好之前在薅 AWS lambda 的羊毛时，为了使用 Cloudflare CDN 加速 lambda，也是需要在 AWS 的 ACM 里上传 Cloudflare 证书的，当时写了一篇文章：《<a href=\"https://zhuanlan.zhihu.com/p/423766959\">Free Arch：给 GraphQL 增加 CDN 缓存</a>》，并宣称有极大的参考价值，没想到这次又可以复用一次，果真是有极大的参考价值呀。获取 Cloudflare 证书的步骤那篇文章里有，但这里再简单贴几个图，因为，Cloudflare 的界面已经修改了！<br /><img src=\"https://cdn.nlark.com/yuque/0/2022/png/221736/1652364452106-faa19b59-0bae-4015-b410-34f9d474fa30.png#clientId=u981ed5f2-8c9f-4&#x26;crop=0&#x26;crop=0&#x26;crop=1&#x26;crop=1&#x26;from=paste&#x26;height=383&#x26;id=ucf4a960f&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=766&#x26;originWidth=2302&#x26;originalType=binary%E2%88%B6=1&#x26;rotation=0&#x26;showTitle=false&#x26;size=143231&#x26;status=done&#x26;style=none&#x26;taskId=u168ed629-aa3f-41c2-85ef-adcdf906fd9&#x26;title=&#x26;width=1151\" alt=\"image.png\"><br /><img src=\"https://cdn.nlark.com/yuque/0/2022/png/221736/1652364425463-97df485a-1b41-4b0d-b77c-7aff8627e509.png#clientId=u981ed5f2-8c9f-4&#x26;crop=0&#x26;crop=0&#x26;crop=1&#x26;crop=1&#x26;from=paste&#x26;height=638&#x26;id=u6ee77429&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=1276&#x26;originWidth=1854&#x26;originalType=binary%E2%88%B6=1&#x26;rotation=0&#x26;showTitle=false&#x26;size=323401&#x26;status=done&#x26;style=none&#x26;taskId=u5988ca75-ba85-4c56-b317-8a57ccb11f2&#x26;title=&#x26;width=927\" alt=\"image.png\"></p>\n<p>将以上的源证书和私钥拷贝好，粘贴到七牛云的自有证书上传页面：<br /><img src=\"https://cdn.nlark.com/yuque/0/2022/png/221736/1652364541943-b507b396-fb97-4b6e-8d4d-d2afa5acf189.png#clientId=u981ed5f2-8c9f-4&#x26;crop=0&#x26;crop=0&#x26;crop=1&#x26;crop=1&#x26;from=paste&#x26;height=639&#x26;id=u3478c1fe&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=1278&#x26;originWidth=1914&#x26;originalType=binary%E2%88%B6=1&#x26;rotation=0&#x26;showTitle=false&#x26;size=147678&#x26;status=done&#x26;style=none&#x26;taskId=ufc9e392e-ab55-4c63-88c1-91fe20c3f12&#x26;title=&#x26;width=957\" alt=\"image.png\"><br />点击上传，就碰到了 <strong>[400338] 获取父级证书失败，请稍后重试 <strong>这个错误。我还真的等了一会儿，再重试，仍然如此，无论怎么重试都没有用，于是明白了“请稍后重试”，就是废话！关键信息在</strong>获取父级证书失败</strong>。<br />这个我在上一篇文章中也是有经验的，当时在 AWS ACM 的证书上传时，碰到一个证书链的问题，这里说是父级证书的问题，虽然我不懂这些证书呀 https 呀，但是靠着<a href=\"https://zhuanlan.zhihu.com/p/504711474\">技术直觉力</a>，我觉得这是同一个问题。</p>\n<p><a name=tpmrt></a></p>\n<h1>【如何获取 Cloudflare 的根证书】</h1>\n<p>无论字面上说根证书、证书链、还是父证书，对我现在的具体问题来说，都是需要找到 Cloudflare 的根证书了。好在有这篇参考价值极大的文章《<a href=\"https://zhuanlan.zhihu.com/p/423766959\">FreeArch：给 GraphQL 增加 CDN 缓存</a>》，我很快找到了。顺便说一下，这篇文章里给到的 Cloudflare 文档的原始链接，已经是 404 了！而且我尝试在 Cloudflare 官方开发者文档里搜索了 Cloudflare root CA 等等关键词，再也找不到根证书的具体内容了！这种死链问题，真是比较坑爹。好在我的参考价值极大的文章里明文粘贴了 Cloudflare 的根证书内容，再一次派上了用场！由于非常有效，这里再粘贴一次：</p>\n<p>-----BEGIN CERTIFICATE-----\nMIIEADCCAuigAwIBAgIID+rOSdTGfGcwDQYJKoZIhvcNAQELBQAwgYsxCzAJBgNV\nBAYTAlVTMRkwFwYDVQQKExBDbG91ZEZsYXJlLCBJbmMuMTQwMgYDVQQLEytDbG91\nZEZsYXJlIE9yaWdpbiBTU0wgQ2VydGlmaWNhdGUgQXV0aG9yaXR5MRYwFAYDVQQH\nEw1TYW4gRnJhbmNpc2NvMRMwEQYDVQQIEwpDYWxpZm9ybmlhMB4XDTE5MDgyMzIx\nMDgwMFoXDTI5MDgxNTE3MDAwMFowgYsxCzAJBgNVBAYTAlVTMRkwFwYDVQQKExBD\nbG91ZEZsYXJlLCBJbmMuMTQwMgYDVQQLEytDbG91ZEZsYXJlIE9yaWdpbiBTU0wg\nQ2VydGlmaWNhdGUgQXV0aG9yaXR5MRYwFAYDVQQHEw1TYW4gRnJhbmNpc2NvMRMw\nEQYDVQQIEwpDYWxpZm9ybmlhMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKC\nAQEAwEiVZ/UoQpHmFsHvk5isBxRehukP8DG9JhFev3WZtG76WoTthvLJFRKFCHXm\nV6Z5/66Z4S09mgsUuFwvJzMnE6Ej6yIsYNCb9r9QORa8BdhrkNn6kdTly3mdnykb\nOomnwbUfLlExVgNdlP0XoRoeMwbQ4598foiHblO2B/LKuNfJzAMfS7oZe34b+vLB\nyrP/1bgCSLdc1AxQc1AC0EsQQhgcyTJNgnG4va1c7ogPlwKyhbDyZ4e59N5lbYPJ\nSmXI/cAe3jXj1FBLJZkwnoDKe0v13xeF+nF32smSH0qB7aJX2tBMW4TWtFPmzs5I\nlwrFSySWAdwYdgxw180yKU0dvwIDAQABo2YwZDAOBgNVHQ8BAf8EBAMCAQYwEgYD\nVR0TAQH/BAgwBgEB/wIBAjAdBgNVHQ4EFgQUJOhTV118NECHqeuU27rhFnj8KaQw\nHwYDVR0jBBgwFoAUJOhTV118NECHqeuU27rhFnj8KaQwDQYJKoZIhvcNAQELBQAD\nggEBAHwOf9Ur1l0Ar5vFE6PNrZWrDfQIMyEfdgSKofCdTckbqXNTiXdgbHs+TWoQ\nwAB0pfJDAHJDXOTCWRyTeXOseeOi5Btj5CnEuw3P0oXqdqevM1/+uWp0CM35zgZ8\nVD4aITxity0djzE6Qnx3Syzz+ZkoBgTnNum7d9A66/V636x4vTeqbZFBr9erJzgz\nhhurjcoacvRNhnjtDRM0dPeiCJ50CP3wEYuvUzDHUaowOsnLCjQIkWbR7Ni6KEIk\nMOz2U0OBSif3FTkhCgZWQKOOLo1P42jHC3ssUZAtVNXrCk3fw9/E15k8NPkBazZ6\n0iykLhH1trywrKRMVw67F44IE8Y=\n-----END CERTIFICATE-----</p>\n<p>而且，我的参考价值极大的文章还贴心地写了应该如何将这个根证书与上一次生成的服务器源证书拼接在一起，以成功地上传至 AWS ACM。但是这一次，我照做了，结果还是 **[400338] 获取父级证书失败，请稍后重试 **这个错误！</p>\n<p>这就百思不得其解了……</p>\n<p>在这里卡了一秒，立即再次用技术直觉力，猜测，难道这个证书链并没有通用的标准顺序？各大厂商（程序员）自行随意实现的？而且都有一个通病，就是界面上不给个提示，文档也没有，只能靠用户去猜？</p>\n<p>既然猜到这里，我立即调换了一根证书和源证书的顺序，再试了一次上传，真的成功了！这里再贴一下，对于七牛云的证书上传页面，应该用下面的顺序，和 AWS ACM 的证书上传页面，顺序正好相反。当然你也举一反三，以后在别的什么厂商的证书上传页面，上传碰到错误，千万不要无脑重试，而是需要换一换顺序再试：</p>\n<p>-----BEGIN CERTIFICATE-----\n源服务器证书内容\n-----END CERTIFICATE-----</p>\n<p>-----BEGIN CERTIFICATE-----\nCloudflare 根证书内容\n-----END CERTIFICATE-----</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2022/png/221736/1652366949644-043bbdbd-e930-4855-97d6-b289e3ff62eb.png#clientId=u981ed5f2-8c9f-4&#x26;crop=0&#x26;crop=0&#x26;crop=1&#x26;crop=1&#x26;from=paste&#x26;height=437&#x26;id=u7e33b9da&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=874&#x26;originWidth=1996&#x26;originalType=binary%E2%88%B6=1&#x26;rotation=0&#x26;showTitle=false&#x26;size=145109&#x26;status=done&#x26;style=none&#x26;taskId=u3bac8ec0-ce03-44f4-b920-6370a8f0bc0&#x26;title=&#x26;width=998\" alt=\"image.png\">\n<a name=ev1Dp></a></p>\n<h1>【总结】</h1>\n<p>至此在七牛云的证书管理页面上传 Cloudflare 证书的问题已经完美解决，再总结一下解决方法：</p>\n<ol>\n<li>获取 Cloudflare 根证书</li>\n<li>生成源服务器证书</li>\n<li>将证书内容拼接起来，注意将根证书内容放在后面</li>\n</ol>\n<p>最后，在《<a href=\"https://zhuanlan.zhihu.com/p/423766959\">Free Arch：给 GraphQL 增加 CDN 缓存</a>》里有抱怨 AWS 报证书链的错误时，在 AWS 文档里没有找到任何证书链相关的文档。这次在七牛云的文档里，却找到了证书链的相关说明，虽然很简短，但是写得比较清楚，有兴趣的同学可以看一看：</p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}},"menus":{}}},"staticQueryHashes":[]}