{"componentChunkName":"component---src-templates-post-js","path":"/posts/gaiylg/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/gaiylg","relativePath":"posts/gaiylg","frontmatter":{"title":"Free Arch：给 GraphQL 增加 CDN 缓存","stackbit_url_path":"posts/gaiylg","date":"2021-10-20T12:32:47","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<blockquote>\n<p><strong>FBI 警告</strong>：这是一篇极具参考价值的文章，它利用免费架构，将 GraphQL 请求响应加快到令人发指的程度，而且具有一个反常的特性，那就是访问越频繁，流量分布越宽广，其整体性能越好。</p>\n</blockquote>\n<p><a name=SJZ68></a></p>\n<h1></h1>\n<p><a name=tjdwW></a></p>\n<h1>极具参考价值</h1>\n<p>因为网上的文档极少或者完全没有，而仅存的少量文档在关键部分却一笔带过，含糊其辞，对于我这样的小白极不友好！</p>\n<p><a name=AUwTD></a></p>\n<h1>免费架构的反常特性</h1>\n<p>一般的应用服务，访问量一大，其性能急剧下降。这是因为一般的应用，使用了服务器，不仅昂贵，而且扛不住大流量。免费架构其实就是利用了 CDN，而这个反常特性，其实是 CDN 的正常特性。</p>\n<p><a name=RMvIw></a></p>\n<h1>问题背景</h1>\n<p>前面几篇文章都是针对万能 BFF，其中的一能，就是利用 gatsby-source-yuque 插件，将语雀文章 GraphQL 服务化。但是这个插件的实现是非常简单粗暴的，即一篇一篇下载语雀文章，并保存为一个 json 文件。由于它的本来目的是服务于静态站点的生成，即只在站点构建阶段运行，实际运行时是很快的。当新增语雀文章时，通过 webhook 触发站点重新构建，生成全新的站点，所以简单粗暴的实现并没有问题。</p>\n<p>但是万能 BFF 把它的使用场景扩大了，比如给小程序提供服务。由于小程序需要审核，不像 Web 站点发布那般自由，于是需要将这个服务动态化，从而在不需要发布新的小程序的前提下，也能在小程序里看到最新的文章。</p>\n<p><span>fallback node</span></p>\n<p>免费架构薅了 AWS Lambda 的羊毛，将万能 BFF 部署在 AWS lambda 上，于是让原本就慢的服务雪上加霜，因为 lambda 的冷启动本身就很耗时。另外因为小程序需要连接备案域名的问题，采用了代理服务绕过，而这个代理服务也是免费的 Heroku 服务，也存在冷启动问题，因此是<strong>三慢合一</strong>！</p>\n<p><a name=Xo87b></a></p>\n<h1>免费架构的问题解决思路</h1>\n<p>如果说优化 gatsby-source-yuque 插件，让其性能提升，是有很多办法的，比如存数据库，增量拉取更新、用 Redis 做一层缓存等等。</p>\n<p>但这都不是免费架构的问题解决思路。</p>\n<blockquote>\n<p><strong>FBI 警告</strong>：什么是架构？如果通过代码优化提升系统性能，可能会遮盖架构的光辉。好的架构，就是在烂代码的前提下，提升系统的整体表现。</p>\n</blockquote>\n<p>再说，数据库、Redis 等等资源成本是我等穷困程序员所不能接受的，更别提开发成本了。</p>\n<p>免费架构准备绕过所有后端优化，直接将 GraphQL 响应放在 CDN 边缘节点上，不仅节省了后端资源成本，而且其性能也是秒杀所有后端优化方案。</p>\n<p><a name=N0zKb></a></p>\n<h1>免费架构的实现细节</h1>\n<p>利用 Cloudflare 的全球 CDN 网络，加上其页面规则，在 GraphQL 服务被第一次请求时被缓存在离用户最近的边缘服务器，从而使该用户周围的用户收益，在发起请求时直接从边缘节点获取到响应，实现页面秒开效果。当有新的语雀文章更新时，可以利用 Cloudflare 的 API 删除缓存。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 240px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.83783783783784%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAADE0lEQVR42lWSS28bZRSG33HixPGlbuNb7MZ2HNsTNzeaEEQBwYIQHOqZcVqoHErbOBQ7vo3dXCgVAhbsEPRPoO5ZsgZ+AIING4LnPdOwgP+A0UxYkFc6+qTvO3rec/kARzr/H17ojENnGDpnoDOIqgUYVKDLeY7mnKKg4p7OG1AZ4lxVG3j7N8AQJ1GBbgWgcxq6JGHILAwJKTuOkeWDxnOwA9ToRcVSXIMd65zjyrDdCH81ctz90OkAJ93KdKaxTR9gY6FvKcha8FStMcWgFwZj0HnJBWv0uAU5cGicgM4oDEagMaoYjEzcdhP9SpXx5IecUk0CqzKJMgOoMAiNCVQkpVTlKgxJ/jeaMLRTF+g4hlFh1FOVNMoMAz8791Pjt+gpDRhSTar5LveiD2Rl4l3O+e4wG6hJDttM4CZjMHjF7a5KYDQaId0QrBxKKNPkO+kmt7Mt0QI1BuN1wU8/jLDQ51PV5HeZhqyP32IKWxIL7jLvGARqMgP8CNwUYHMI5LqWx787VDaeiL/QpV7o8evSgJ8WesS3v/6N+Q79uTa3ij1qqsm9dJOb8Tpfyh5IuTTg90WT62Pv20D5DIUOAbVvja8cydTqkaDYscdVk2tqnzdKA87E94jZBmedNvG6XMk0+eZ8hy8u9FnPd6yPFx/xi/VP7JA6EN/SkY2lYxtIHQwx37Ww2BesHgtGo3+Q77AcfSCl7AGT10/Em2szFrnPxXSDry49Eqw9lnCxx2uFLvPYeK4AI2RagmyLwEydmOtYSDfozFLx3SFSDyWSa0tNNfmys+HYvoXEPl/ItXnj+olEl4+JxF1i+p4EFYOJdIPJtcf0bTwhLijXpjLXIuZanFVNeWPn6Z/ew2d/IXTvFLkOE6UBA5frv0M1qbzyuaWkHjKQaUpONeVa0WRwwaTnInFb3G0pVU5WvhGUTBvLhzYi9T+QalgoDQi89QsQfoZLNduZr/uZrzYthHZFWTmxLvIuf3CGifdsjN0+w2yTymufPcfml2fw3z1F8iMLxd7FljIHBLaI6P4Q0/eJ5WML/wKuW1eYdiLatwAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/de91701a10a9926bc3214edfdc5697eb/8ff5a/1634729354203-68c5682b-23a9-491f-9d76-ecd21b013eb7.png\"\n        srcset=\"/static/de91701a10a9926bc3214edfdc5697eb/12f09/1634729354203-68c5682b-23a9-491f-9d76-ecd21b013eb7.png 148w,\n/static/de91701a10a9926bc3214edfdc5697eb/8ff5a/1634729354203-68c5682b-23a9-491f-9d76-ecd21b013eb7.png 240w\"\n        sizes=\"(max-width: 240px) 100vw, 240px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n<a name=f9yPO></a></p>\n<h1>免费架构的缺点</h1>\n<p><a name=gUkKe></a></p>\n<h2>仍需少量开发</h2>\n<p>后面的详细步骤会讲解</p>\n<p><a name=t6HGC></a></p>\n<h2>不解决第一次请求速度问题</h2>\n<p>第一次请求会很慢，这只能通过后端代码优化解决。</p>\n<blockquote>\n<p><strong>FBI 警告</strong>：如果你打开“哈德韦”小程序，碰到了十几秒才看到文章的话，那么我感谢你，因为你的宝贵时间没有浪费，提高了你周围很多小伙伴的用户体验以及你后续再次访问的速度。</p>\n</blockquote>\n<p><a name=d8peA></a></p>\n<h1>给 GraphQL 增加 CDN 缓存的具体步骤</h1>\n<p><a name=cPyid></a></p>\n<h2>一、少量开发：启用 APQ</h2>\n<p>因为 GraphQL 本质上是一个 HTTP POST 请求，通过启用 APQ，能够将缓存过的请求，转为 GET 请求。从而为后面利用 Cloudflare 设置页面规则（GET 请求）埋下了伏笔。</p>\n<p><a name=x8GJD></a></p>\n<h3>服务器端：</h3>\n<p><a href=\"https://github.com/Jeff-Tian/serverless-space/blob/c566d9ca16913952142d6c9caae07e2a130319b3/src/app.module.ts?_pjax=%23js-repo-pjax-container%2C%20div%5Bitemtype%3D%22http%3A%2F%2Fschema.org%2FSoftwareSourceCode%22%5D%20main%2C%20%5Bdata-pjax-container%5D#L15\">https://github.com/Jeff-Tian/serverless-space/blob/c566d9ca16913952142d6c9caae07e2a130319b3/src/app.module.ts?_pjax=%23js-repo-pjax-container%2C%20div%5Bitemtype%3D%22http%3A%2F%2Fschema.org%2FSoftwareSourceCode%22%5D%20main%2C%20%5Bdata-pjax-container%5D#L15</a>\ntypescript\nimport {Module} from @nestjs/common\nimport {GraphQLModule} from @nestjs/graphql\nimport {ApolloServerPluginCacheControl, ApolloServerPluginLandingPageLocalDefault} from apollo-server-core\nimport {CatsModule} from ./cats/cats.module\nimport {RecipesModule} from ./recipes/recipes.module\nimport {YuqueModule} from ./yuque/yuque.module</p>\n<p>const ONE_DAY_IN_SECONDS = 60 * 60 * 24</p>\n<p>@Module({\nimports: [CatsModule, RecipesModule, YuqueModule, GraphQLModule.forRoot({\nautoSchemaFile: true,\nsortSchema: true,\nplayground: false,</p>\n<pre><code>  \t// 这里！\n    persistedQueries: {\n        ttl: ONE_DAY_IN_SECONDS\n    },\n    plugins: [ApolloServerPluginLandingPageLocalDefault(), ApolloServerPluginCacheControl({defaultMaxAge: ONE_DAY_IN_SECONDS})]\n})],\n</code></pre>\n<p>})\nexport class AppModule {\n}</p>\n<p><a name=pRKEx></a></p>\n<h3>小程序端</h3>\n<p><a href=\"https://github.com/Jeff-Tian/weapp/blob/94c0a22ab54b579ec6991e33c3a8d327bd0f31d8/src/apollo-client.ts?_pjax=%23js-repo-pjax-container%2C%20div%5Bitemtype%3D%22http%3A%2F%2Fschema.org%2FSoftwareSourceCode%22%5D%20main%2C%20%5Bdata-pjax-container%5D#L27\">https://github.com/Jeff-Tian/weapp/blob/94c0a22ab54b579ec6991e33c3a8d327bd0f31d8/src/apollo-client.ts?_pjax=%23js-repo-pjax-container%2C%20div%5Bitemtype%3D%22http%3A%2F%2Fschema.org%2FSoftwareSourceCode%22%5D%20main%2C%20%5Bdata-pjax-container%5D#L27</a>\ntypescript\nimport {ApolloClient, ApolloLink, createHttpLink, InMemoryCache} from @apollo/client\nimport Taro from @tarojs/taro\nimport crypto from crypto</p>\n<p>import {createPersistedQueryLink} from @apollo/client/link/persisted-queries</p>\n<p>const graphQLServerUrl = <a href=\"https://sls.pa-ca.me/nest/graphql\">https://sls.pa-ca.me/nest/graphql</a></p>\n<p>const httpLink = createHttpLink({\nuri: graphQLServerUrl,\nasync fetch(url, options) {\nconsole.log(url = , url, options)\nconst res = await Taro.request({\nurl: url.toString(),\nmethod: (options?.method || POST) as POST | GET,\nheader: {\ncontent-type: application/json\n},\ndata: options?.body,\nsuccess: console.log\n})</p>\n<pre><code>return {text: async () => JSON.stringify(res.data)} as any\n</code></pre>\n<p>}\n})</p>\n<p>const queryLink = createPersistedQueryLink({\nuseGETForHashedQueries: true,\nsha256: async (document: string) => crypto.createHash(sha256).update(document).digest(hex)\n})</p>\n<p>export const client = new ApolloClient({\nlink: ApolloLink.from([queryLink, httpLink]),\ncache: new InMemoryCache()\n})</p>\n<p><a name=HrHwm></a></p>\n<h2>二、去掉代理、启用 AWS API 网关的自定义域名功能（极具参考价值！）</h2>\n<p>看过前面几篇文章的同学会了解，免费架构为了求快，在解决小程序的安全域名要求备案的限制时，使用了代理方案。而且代理的代码很粗糙，存在被滥用的风险，因此这里去掉它，这是为了安全。</p>\n<p>《<a href=\"https://mp.weixin.qq.com/s/W4c-XHe6L9imJsLtQyKtjA\">在小程序里接入 GraphQL</a>》</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5d92ed0ee46408131eddf1973101046e/d9199/1634730517271-5a2052a2-f9f5-4f2d-a650-fd1238cd55d8.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 216.89189189189187%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,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'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/5d92ed0ee46408131eddf1973101046e/fcda8/1634730517271-5a2052a2-f9f5-4f2d-a650-fd1238cd55d8.png\"\n        srcset=\"/static/5d92ed0ee46408131eddf1973101046e/12f09/1634730517271-5a2052a2-f9f5-4f2d-a650-fd1238cd55d8.png 148w,\n/static/5d92ed0ee46408131eddf1973101046e/e4a3f/1634730517271-5a2052a2-f9f5-4f2d-a650-fd1238cd55d8.png 295w,\n/static/5d92ed0ee46408131eddf1973101046e/fcda8/1634730517271-5a2052a2-f9f5-4f2d-a650-fd1238cd55d8.png 590w,\n/static/5d92ed0ee46408131eddf1973101046e/efc66/1634730517271-5a2052a2-f9f5-4f2d-a650-fd1238cd55d8.png 885w,\n/static/5d92ed0ee46408131eddf1973101046e/d9199/1634730517271-5a2052a2-f9f5-4f2d-a650-fd1238cd55d8.png 960w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>但是，更重要的是，我们需要加快响应速度，要知道这个代理也是一个免费服务，当冷启动时，是非常慢的，再加上 AWS lambda 的冷启动，以及这个插件本身的慢，所以是<strong>三慢合一</strong>！</p>\n<p>要去掉它，就需要将自定义域名指向 AWS lambda 自动生成的长长的域名。</p>\n<p>极具参考价值，主要指这里。因为要利用 Cloudflare 的 CDN 网络和页面规则，自然，这个自定义域名需要交给 Cloudflare 托管。但是如何将 Cloudflare 托管的域名，指向 AWS lambda，文档少，关键步骤缺失。这让小白我，通过长时间的试错，才最终成功。</p>\n<p><a name=uGNWe></a></p>\n<h3>开通自定义域名</h3>\n<p>在使用 serverless 部署好 lambda 后，会自动生成相关的 API 网关。但是并未开通自定义域名，需要另外去开通：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/19aed780fa056600e4dff5521e5efee3/c88fb/1634730903389-cbd9d43c-db8f-4528-9d84-a9b45d0e6038.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.70270270270271%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABq0lEQVR42n2S627bMAyF82ZDliZLk6VZ0RQddnn0YfvTLbFTy7pRoi4+g2Un2dqiBj6QgswD8lCT680OHz7eYTrfYLrYYLbc4mq5xeL6BrPFGtP5Cu/nK7ybLTG9WmG5vsXN7WesNw8lbndf8Gn3FXf333D/8B0T0QhIbfDj5y/sDzVaqSGVAZEDuR4/0J/JQRuC0hbKDBhLBUuu1E3AHilnNELAGIOUUqHrukIu5BI7vP31/0/6hDngqRGo6xrWEpzzcP4fnIN1jBATcs6lgRLTkJ/OHMIgGELA4+Nv1McjQozwzAPe/0dgLkWv3fUQ0SgYI451DSkEgvdgIgT257G7ceS6NfhTNxCGIMmjtR6GIyhmUOxgeeyQvYesKhil4LSCURokFXJOSLk7j0kcYX2ACwk+JHBMCLlDLAAc4kWw3u+hlIbtN6ctjJQgDnAxFQHqRWJPLpFCLAKDl2n0kC8eHqoK1aFC89QUhBBlUcZaMHMpiiOn/LmXFw9DgGhbSKXPWysbHItPW3zOxePhQfW7GJ8No5WyvENL9DrWvqDvvr/TxkBpDW0t/gJERTIeqgj+1QAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/19aed780fa056600e4dff5521e5efee3/fcda8/1634730903389-cbd9d43c-db8f-4528-9d84-a9b45d0e6038.png\"\n        srcset=\"/static/19aed780fa056600e4dff5521e5efee3/12f09/1634730903389-cbd9d43c-db8f-4528-9d84-a9b45d0e6038.png 148w,\n/static/19aed780fa056600e4dff5521e5efee3/e4a3f/1634730903389-cbd9d43c-db8f-4528-9d84-a9b45d0e6038.png 295w,\n/static/19aed780fa056600e4dff5521e5efee3/fcda8/1634730903389-cbd9d43c-db8f-4528-9d84-a9b45d0e6038.png 590w,\n/static/19aed780fa056600e4dff5521e5efee3/efc66/1634730903389-cbd9d43c-db8f-4528-9d84-a9b45d0e6038.png 885w,\n/static/19aed780fa056600e4dff5521e5efee3/c83ae/1634730903389-cbd9d43c-db8f-4528-9d84-a9b45d0e6038.png 1180w,\n/static/19aed780fa056600e4dff5521e5efee3/c88fb/1634730903389-cbd9d43c-db8f-4528-9d84-a9b45d0e6038.png 3710w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><br />这里的难点是申请证书。</p>\n<p><a name=U59Hs></a></p>\n<h3>验证域名</h3>\n<p>申请证书前，需要验证域名。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/74810fdcda6635ab1726e3f6efdb8bcd/a2792/1634730960281-f260011b-285f-46eb-81fa-905e408f437f.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 31.08108108108108%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAy0lEQVR42o3R226EIBCAYd//EbfJprbKipqoDCAs4N/g9qJJY9NJvrljTjSlFIwxhBDw3pNTosZxHL/AS31zpalJvGcxwv39Az3NLJsgzp+MCCIW63fa2TFu+2XDqinA9ugJWuG0QlSHG3ripAmDIsYn8VkljI/IHsk5XzoLStcyzwtvakUvlm4SYsrkWVNSohyvNfme4s+V61XW/vOcTMaRVfVsqscOD2zX4pzDeY9zP/hr5w2ts3Rty/12I4Wd6Cyh2j0hxvPD/usLopbSI+ONeqIAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/74810fdcda6635ab1726e3f6efdb8bcd/fcda8/1634730960281-f260011b-285f-46eb-81fa-905e408f437f.png\"\n        srcset=\"/static/74810fdcda6635ab1726e3f6efdb8bcd/12f09/1634730960281-f260011b-285f-46eb-81fa-905e408f437f.png 148w,\n/static/74810fdcda6635ab1726e3f6efdb8bcd/e4a3f/1634730960281-f260011b-285f-46eb-81fa-905e408f437f.png 295w,\n/static/74810fdcda6635ab1726e3f6efdb8bcd/fcda8/1634730960281-f260011b-285f-46eb-81fa-905e408f437f.png 590w,\n/static/74810fdcda6635ab1726e3f6efdb8bcd/efc66/1634730960281-f260011b-285f-46eb-81fa-905e408f437f.png 885w,\n/static/74810fdcda6635ab1726e3f6efdb8bcd/c83ae/1634730960281-f260011b-285f-46eb-81fa-905e408f437f.png 1180w,\n/static/74810fdcda6635ab1726e3f6efdb8bcd/a2792/1634730960281-f260011b-285f-46eb-81fa-905e408f437f.png 1462w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><br />选择 DNS 验证<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/57436947bad94562180702536310316b/f291a/1634731043550-f0eb5793-d7b4-49a6-aec9-f586b475e088.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 72.97297297297297%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAABwElEQVR42qWT2Y7UMBBF8///wJ/wxgM8zAOaBiFmRXRnsTveEttZ7OQiVzJNyDQIQaSjKpdj++a6kr2/+Yh3H25w++UBZa1xYgI5/0eYQCaFwBQDxmHAOP4HwwDnLLIiL6CMRZxmzNOEGCNinDbsx2ttmjDtaK1FxjjHuRawzmMcR8zzvLyQ4jzTeFt7ya891jlkQiocTzmKooRUCtZaOOfhnKNoTEMne9/BeU95Wti0LQnYKrTWIePnM4RSaNOCrkPrHKz3C87TAZY2dxQvWEcH+A3pkOzz4YCH+3toZRCHHqHvFroOY98jhEBK/gbysHx8wvOnA0xxguMVLCvhOIPNj5gaTd7MGy//BHnI8xzPd3eQjEFxDlOfITmDYgxGSoQYX93m7yAPa6nRDSN81y/0P2PydO/TlqsePn07ohYKbdNASAml9IqCMYa8ueZjjIFUvfJQaU2NOqZFK2GNVbJhnQ8bUlMnRUobmpvXniUPayEouZi/NmnKX9TNu4tJT9/3ME1zGV8au6wY0qZJ0TUl+xoRlotKm13m06+XNkzfnczUxkA3za+k2r5uDClLfleMQ+oGvDiievsG6vtX/AAtSYmV2OmCtgAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/57436947bad94562180702536310316b/fcda8/1634731043550-f0eb5793-d7b4-49a6-aec9-f586b475e088.png\"\n        srcset=\"/static/57436947bad94562180702536310316b/12f09/1634731043550-f0eb5793-d7b4-49a6-aec9-f586b475e088.png 148w,\n/static/57436947bad94562180702536310316b/e4a3f/1634731043550-f0eb5793-d7b4-49a6-aec9-f586b475e088.png 295w,\n/static/57436947bad94562180702536310316b/fcda8/1634731043550-f0eb5793-d7b4-49a6-aec9-f586b475e088.png 590w,\n/static/57436947bad94562180702536310316b/efc66/1634731043550-f0eb5793-d7b4-49a6-aec9-f586b475e088.png 885w,\n/static/57436947bad94562180702536310316b/c83ae/1634731043550-f0eb5793-d7b4-49a6-aec9-f586b475e088.png 1180w,\n/static/57436947bad94562180702536310316b/f291a/1634731043550-f0eb5793-d7b4-49a6-aec9-f586b475e088.png 2258w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><br />然后根据提示，在 Cloudflare 的控制面板添加相应的 CNAME 以及 CAA 记录完成验证。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e7f3dd9552997c21a8a601a3954eb2f2/2cb21/1634731186397-bb4a9afd-a8f5-4253-a6c2-5e962c67f2ac.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 33.108108108108105%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAAA6ElEQVR42oWRi46DMAwE+/+/yR0BQni/QhJ8GvfSVlWlWloRBXuytm/jOEqMUYZhEO+9XNelWtdVnHPS973qPE/Ztk0VQpCmaZ75KUnldvFnlFvXdZJSEr7HcWgCsSyLWGulbVsFA+ERxLksSwUS1Pw0mxz+BUjhvu8P4DzPUte1QtE3YJGBtPPuEOEQZwg4ASy3XFXVy4iSlO2bQwoB5gCS3U3T9BjDZ4fp2TKtshSAJJPEAihm8PwHTg7f7NCYSs8p3Tv6tf/Aoih0dgABsHVgFBtjdI6ITrgnN4YgrrV6z0P3pawK/AMnLhzuOuWDEwAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/e7f3dd9552997c21a8a601a3954eb2f2/fcda8/1634731186397-bb4a9afd-a8f5-4253-a6c2-5e962c67f2ac.png\"\n        srcset=\"/static/e7f3dd9552997c21a8a601a3954eb2f2/12f09/1634731186397-bb4a9afd-a8f5-4253-a6c2-5e962c67f2ac.png 148w,\n/static/e7f3dd9552997c21a8a601a3954eb2f2/e4a3f/1634731186397-bb4a9afd-a8f5-4253-a6c2-5e962c67f2ac.png 295w,\n/static/e7f3dd9552997c21a8a601a3954eb2f2/fcda8/1634731186397-bb4a9afd-a8f5-4253-a6c2-5e962c67f2ac.png 590w,\n/static/e7f3dd9552997c21a8a601a3954eb2f2/efc66/1634731186397-bb4a9afd-a8f5-4253-a6c2-5e962c67f2ac.png 885w,\n/static/e7f3dd9552997c21a8a601a3954eb2f2/c83ae/1634731186397-bb4a9afd-a8f5-4253-a6c2-5e962c67f2ac.png 1180w,\n/static/e7f3dd9552997c21a8a601a3954eb2f2/2cb21/1634731186397-bb4a9afd-a8f5-4253-a6c2-5e962c67f2ac.png 2174w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><br /><strong>注意！这里的 CAA 记录，请参考如上截图全部加上，而不要相信 AWS 文档里说的只需要添加一种！更要注意 issuewild 和 issue 记录各添加 4 个！</strong></p>\n<p>在域名验证验证通过后，才可以进行下一步。</p>\n<p><a name=j6MPt></a></p>\n<h3>证书导入</h3>\n<p>AWS 控制面板提供了两种证书申请方式，即 AWS 颁发，或者自行导入。这里选择自行导入证书。然后就进入了非常迷惑的面板：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bd044b5a44b8bb334b31aec082a34453/5e703/1634731560802-189a3ced-bab6-4ad0-8565-184e9d944b39.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75.67567567567568%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAABpklEQVR42o2Uy27bMBBF8//rfkN/oevuWzRogVZ2E8BIY1tyLIvvN3mLoSvZTuU4BC6uQJGHnOGQd7t+wO7A8PinxcPTBsvVGsvVMxarNdr9AW3Xoe124EJASFn9muj/HX0wLrD4/YBfiyV+Ng2+fP2G++8/wM8ANPiWaFwFSqXwst+jaRo8bToYa2GMqf3WObgb8t7X8ROQ6IxxbLZb9IcBUkoopSGERIwROef/RP3nooUvgOMutdZQWh/DUBJczueLINRKKdVDjOchy5rHLSVfKQjaHbnWkNpATn5STOk6sIasLZgyUNZBGgvtA2IuFwrkBbAxw8X8NlBoC+0CQsoIqVT3iSamOnkU9ZkQ4eONHZKvty2UMVUUlvUeiQ4gvVZCzmUeOMJ8CPVHSqkq/vO5E65j8q2QpUTf99gPAi7ECZZeaQTmUipsAoZwApKojgwdhrEw1k1lMdfOQWOjVFyErI2pYVPVO5JzdZE50U063iAPaw2cYtBiABfy8lAY52DkbzwAp7st8NIPaJ9XaD99QPf5Y62UI/Cdl//qozAcwNlQX5u/mfWILJSpfycAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/bd044b5a44b8bb334b31aec082a34453/fcda8/1634731560802-189a3ced-bab6-4ad0-8565-184e9d944b39.png\"\n        srcset=\"/static/bd044b5a44b8bb334b31aec082a34453/12f09/1634731560802-189a3ced-bab6-4ad0-8565-184e9d944b39.png 148w,\n/static/bd044b5a44b8bb334b31aec082a34453/e4a3f/1634731560802-189a3ced-bab6-4ad0-8565-184e9d944b39.png 295w,\n/static/bd044b5a44b8bb334b31aec082a34453/fcda8/1634731560802-189a3ced-bab6-4ad0-8565-184e9d944b39.png 590w,\n/static/bd044b5a44b8bb334b31aec082a34453/efc66/1634731560802-189a3ced-bab6-4ad0-8565-184e9d944b39.png 885w,\n/static/bd044b5a44b8bb334b31aec082a34453/c83ae/1634731560802-189a3ced-bab6-4ad0-8565-184e9d944b39.png 1180w,\n/static/bd044b5a44b8bb334b31aec082a34453/5e703/1634731560802-189a3ced-bab6-4ad0-8565-184e9d944b39.png 1942w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>我们准备导入的是 Cloudflare 的证书，证书正文和私钥，都可以轻易地从 Cloudflare 控制面板获取。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/22d9479febe3dc4bdd71a5acd2590575/2cb21/1634731650340-2902dc60-9cb6-4f2e-bba2-30008be1b90f.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.70270270270271%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB8UlEQVR42o2Ra2vUQBSG888LFrFV6+UHFEXsHe3FViqIYKmLgvitandTunbXJtlkk0l2c5nJJI9MtiltPznwcDgnZ955c46133ExHHRcdjs+b/e+s7P1ke0jh+2jS/Y7s2g46DjsHTtsfhry/qvHuy8ubz5fcvjNY/fY4UdXYD1c7fFozebpps3i2jnzzz/wYGmDey+7LKzaPNmwWVjpsbjS4/G6zcLrLnPLv3m2dcbSus3c8s/m7v1X3eYxqypztEypVIbWBYVzQdbvoYSPVil1mUOtqHXRQC1v5VWZNVGrDJmnWGEY4QcB4/GYIAxxzs45PekxOO0x8jwiIZhOUybT6YzJLJra9E5M0xSL9tRXQSnKNKWS8vpTVVW30FojTZ/W1LVGVyYvKcsSSwiB4zhNk7pqquoKXVVIKRvqur7GHCkVsYgYD4f07Qvc/oDYc0izDMvYNYJGOAgCfN9HRBFhGDIajZq6cdW4bwVVSSYCur/+MP/ihMPjPrk3ZJJmWHmeNzPIsqyZgRGI45goihrHrVCLqRVSkoiIxPlL7LkknkMycsnzAitJkubfW25eNs5MzYzDYPLBYNC4NyMppaSUBaooMDrGVOPQOGu5u4C7FEVxY66zXSoNl66PEDFW+/LNDf4P7cIMpVKISUEuS/4B3y05x4BaLl4AAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/22d9479febe3dc4bdd71a5acd2590575/fcda8/1634731650340-2902dc60-9cb6-4f2e-bba2-30008be1b90f.png\"\n        srcset=\"/static/22d9479febe3dc4bdd71a5acd2590575/12f09/1634731650340-2902dc60-9cb6-4f2e-bba2-30008be1b90f.png 148w,\n/static/22d9479febe3dc4bdd71a5acd2590575/e4a3f/1634731650340-2902dc60-9cb6-4f2e-bba2-30008be1b90f.png 295w,\n/static/22d9479febe3dc4bdd71a5acd2590575/fcda8/1634731650340-2902dc60-9cb6-4f2e-bba2-30008be1b90f.png 590w,\n/static/22d9479febe3dc4bdd71a5acd2590575/efc66/1634731650340-2902dc60-9cb6-4f2e-bba2-30008be1b90f.png 885w,\n/static/22d9479febe3dc4bdd71a5acd2590575/c83ae/1634731650340-2902dc60-9cb6-4f2e-bba2-30008be1b90f.png 1180w,\n/static/22d9479febe3dc4bdd71a5acd2590575/2cb21/1634731650340-2902dc60-9cb6-4f2e-bba2-30008be1b90f.png 2174w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><br />点击创建证书后，通过下载即可以获取到证书正文和私钥，分别贴入 AWS ACM 控制面板。<strong>让人傻眼的是这个证书链，没有任何文档说明如何获取这个证书链。</strong></p>\n<p>通过各种信息的拼凑和反复试错，以下是正确的获取姿势：</p>\n<p><a name=H6L23></a></p>\n<h3>证书链</h3>\n<p>虽然 AWS 控制面板上说这是可选项，但是没有的话，根本导入不了。</p>\n<p><strong>证书链需要将上一步生成的源服务器证书内容，和 Cloudflare 根证书文本内容，拼在一起，并且要注意顺序！</strong></p>\n<p>从这个链接获取 Cloudflare 根证书的内容（RSA 格式）：<a href=\"https://developers.cloudflare.com/ssl/e2b9968022bf23b071d95229b5678452/origin_ca_rsa_root.pem\">https://developers.cloudflare.com/ssl/e2b9968022bf23b071d95229b5678452/origin_ca_rsa_root.pem</a></p>\n<p>shell\n-----BEGIN CERTIFICATE-----\nMIIEADCCAuigAwIBAgIID+rOSdTGfGcwDQYJKoZIhvcNAQELBQAwgYsxCzAJBgNV\nBAYTAlVTMRkwFwYDVQQKExBDbG91ZEZsYXJlLCBJbmMuMTQwMgYDVQQLEytDbG91\nZEZsYXJlIE9yaWdpbiBTU0wgQ2VydGlmaWNhdGUgQXV0aG9yaXR5MRYwFAYDVQQH\nEw1TYW4gRnJhbmNpc2NvMRMwEQYDVQQIEwpDYWxpZm9ybmlhMB4XDTE5MDgyMzIx\nMDgwMFoXDTI5MDgxNTE3MDAwMFowgYsxCzAJBgNVBAYTAlVTMRkwFwYDVQQKExBD\nbG91ZEZsYXJlLCBJbmMuMTQwMgYDVQQLEytDbG91ZEZsYXJlIE9yaWdpbiBTU0wg\nQ2VydGlmaWNhdGUgQXV0aG9yaXR5MRYwFAYDVQQHEw1TYW4gRnJhbmNpc2NvMRMw\nEQYDVQQIEwpDYWxpZm9ybmlhMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKC\nAQEAwEiVZ/UoQpHmFsHvk5isBxRehukP8DG9JhFev3WZtG76WoTthvLJFRKFCHXm\nV6Z5/66Z4S09mgsUuFwvJzMnE6Ej6yIsYNCb9r9QORa8BdhrkNn6kdTly3mdnykb\nOomnwbUfLlExVgNdlP0XoRoeMwbQ4598foiHblO2B/LKuNfJzAMfS7oZe34b+vLB\nyrP/1bgCSLdc1AxQc1AC0EsQQhgcyTJNgnG4va1c7ogPlwKyhbDyZ4e59N5lbYPJ\nSmXI/cAe3jXj1FBLJZkwnoDKe0v13xeF+nF32smSH0qB7aJX2tBMW4TWtFPmzs5I\nlwrFSySWAdwYdgxw180yKU0dvwIDAQABo2YwZDAOBgNVHQ8BAf8EBAMCAQYwEgYD\nVR0TAQH/BAgwBgEB/wIBAjAdBgNVHQ4EFgQUJOhTV118NECHqeuU27rhFnj8KaQw\nHwYDVR0jBBgwFoAUJOhTV118NECHqeuU27rhFnj8KaQwDQYJKoZIhvcNAQELBQAD\nggEBAHwOf9Ur1l0Ar5vFE6PNrZWrDfQIMyEfdgSKofCdTckbqXNTiXdgbHs+TWoQ\nwAB0pfJDAHJDXOTCWRyTeXOseeOi5Btj5CnEuw3P0oXqdqevM1/+uWp0CM35zgZ8\nVD4aITxity0djzE6Qnx3Syzz+ZkoBgTnNum7d9A66/V636x4vTeqbZFBr9erJzgz\nhhurjcoacvRNhnjtDRM0dPeiCJ50CP3wEYuvUzDHUaowOsnLCjQIkWbR7Ni6KEIk\nMOz2U0OBSif3FTkhCgZWQKOOLo1P42jHC3ssUZAtVNXrCk3fw9/E15k8NPkBazZ6\n0iykLhH1trywrKRMVw67F44IE8Y=\n-----END CERTIFICATE-----</p>\n<p>然后和自己生成的源服务器证书内容拼在一起粘贴到 AWS ACM 控制面板，注意上下顺序！</p>\n<p>shell\n-----BEGIN CERTIFICATE-----\nCloudflare 根证书内容\n-----END CERTIFICATE-----</p>\n<p>-----BEGIN CERTIFICATE-----\n源服务器证书内容\n-----END CERTIFICATE-----</p>\n<p>导入成功后，你就能在自定义域名开通面板选择到它了！</p>\n<p><a name=EJtv7></a></p>\n<h2>三、设置域名 CNAME 记录指向 API 网关的自定义域名</h2>\n<p>注意是 CNAME 到终端节点配置显示的 API Gateway 域名：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/912a824c53bf5eb64163a87e4d629cb6/dd615/1634732243510-755b40ab-3697-4043-88d3-8ecad8fff361.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.16216216216216%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABBElEQVR42l1Ri26DMAzk/79ybSlbR8nDeZAX3GQ3ILRIJzuxffJdhq/bDc9pgvcePgSQc7CWsCgFpTRCCGftmnOUe59RWsNYi0Fpg5wzamuCnAtSSvid30LMZ993tNbknfN92ySmnLBt21ljDOQDQozIpQixxFJgrYXr28R1PTfhnPtjXGGcOetrShIHkcgg6rByf30/MY4PLMsCshZEJIQcXe+ny5w2Bqx2OB6kuZPzwHt84Od+R/WETBbFarRWRR5vwpFlb11+rRUxxs+GJzo5Ey7ThNc4wqlFwKSHn/P8lg9hz9b14538Q63/CC9SqPuXuq8pF/GJCZiQJXofxOcD7O0fRQMcP/2RQjEAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/912a824c53bf5eb64163a87e4d629cb6/fcda8/1634732243510-755b40ab-3697-4043-88d3-8ecad8fff361.png\"\n        srcset=\"/static/912a824c53bf5eb64163a87e4d629cb6/12f09/1634732243510-755b40ab-3697-4043-88d3-8ecad8fff361.png 148w,\n/static/912a824c53bf5eb64163a87e4d629cb6/e4a3f/1634732243510-755b40ab-3697-4043-88d3-8ecad8fff361.png 295w,\n/static/912a824c53bf5eb64163a87e4d629cb6/fcda8/1634732243510-755b40ab-3697-4043-88d3-8ecad8fff361.png 590w,\n/static/912a824c53bf5eb64163a87e4d629cb6/efc66/1634732243510-755b40ab-3697-4043-88d3-8ecad8fff361.png 885w,\n/static/912a824c53bf5eb64163a87e4d629cb6/c83ae/1634732243510-755b40ab-3697-4043-88d3-8ecad8fff361.png 1180w,\n/static/912a824c53bf5eb64163a87e4d629cb6/dd615/1634732243510-755b40ab-3697-4043-88d3-8ecad8fff361.png 3266w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/70c8d26660db9e8e437d5a89cf43c05a/f1f01/1634731130385-2ba47b17-d4ba-4b03-9190-b04990195ac4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 22.2972972972973%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAyUlEQVR42lWOXUpDMRCFu/9FuAuXIJc+KYioD9JW2gdNNbn5v5kkn9yoFQ8chjkzfJwNgHOOeZ4ppVBrpfUOvaEPO+6nGx620/DTduLx7paX3Z7sZ9ysycuyIrCh4GNhsy7ee2KMhBBIKQ2oSCGcFU69kfQH8fNMcxZJcQCCUej30/hvrY1snRegMQYRubRcXWrFOo+xFhcC0hopZ0QqEi0SNMuSKUWIuVKkfgOttSil+FXvfRg6/9T73/0narVyPJ64ut7z/Or4AiwhNL39TRI/AAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/70c8d26660db9e8e437d5a89cf43c05a/fcda8/1634731130385-2ba47b17-d4ba-4b03-9190-b04990195ac4.png\"\n        srcset=\"/static/70c8d26660db9e8e437d5a89cf43c05a/12f09/1634731130385-2ba47b17-d4ba-4b03-9190-b04990195ac4.png 148w,\n/static/70c8d26660db9e8e437d5a89cf43c05a/e4a3f/1634731130385-2ba47b17-d4ba-4b03-9190-b04990195ac4.png 295w,\n/static/70c8d26660db9e8e437d5a89cf43c05a/fcda8/1634731130385-2ba47b17-d4ba-4b03-9190-b04990195ac4.png 590w,\n/static/70c8d26660db9e8e437d5a89cf43c05a/efc66/1634731130385-2ba47b17-d4ba-4b03-9190-b04990195ac4.png 885w,\n/static/70c8d26660db9e8e437d5a89cf43c05a/c83ae/1634731130385-2ba47b17-d4ba-4b03-9190-b04990195ac4.png 1180w,\n/static/70c8d26660db9e8e437d5a89cf43c05a/f1f01/1634731130385-2ba47b17-d4ba-4b03-9190-b04990195ac4.png 2212w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><a name=ISNyw></a></p>\n<h2>四、Cloudflare 页面 SSL 规则</h2>\n<p>注意需要设置这个新的 CNAME 域名所有的路径（*）的 SSL 规则为“<strong>完全</strong>”，否则，直接访问会报错。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 31.756756756756754%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA60lEQVR42pWQbW7DIBBEc/+zNReoa9VNbCfEHxCBHcCGV4GT1H+70tsRO2JYcQAoioKyLJFS0jQNRfHJ8fjBVQj+UzFGDqmdz+ccmMLquqb6qbmKPj+Q6PserTVKKYwxma7rMsMw4JzLYakOMQbGcaRtW4QQKDlyGzSDmvHeYa3FPh64pNbmy4k0e+H3galN84y633HeE5+rhxhY1sASAmvYNLNuvGZZl2W3obOI6pum/CJMmjCZN3HedDX6fY7TjuQbTfT+7w/DXaKqkkm02E5gu+sOwSwuyFOFuTSbf3t6Sfsbpj7h5PAO/AWqDs7rmHvXSAAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/0ec943a8e3644df7cb3e557a12d0be1f/fcda8/1634732325536-d864a562-5609-4429-bf8d-aeb586eb95d7.png\"\n        srcset=\"/static/0ec943a8e3644df7cb3e557a12d0be1f/12f09/1634732325536-d864a562-5609-4429-bf8d-aeb586eb95d7.png 148w,\n/static/0ec943a8e3644df7cb3e557a12d0be1f/e4a3f/1634732325536-d864a562-5609-4429-bf8d-aeb586eb95d7.png 295w,\n/static/0ec943a8e3644df7cb3e557a12d0be1f/fcda8/1634732325536-d864a562-5609-4429-bf8d-aeb586eb95d7.png 590w,\n/static/0ec943a8e3644df7cb3e557a12d0be1f/efc66/1634732325536-d864a562-5609-4429-bf8d-aeb586eb95d7.png 885w,\n/static/0ec943a8e3644df7cb3e557a12d0be1f/c83ae/1634732325536-d864a562-5609-4429-bf8d-aeb586eb95d7.png 1180w,\n/static/0ec943a8e3644df7cb3e557a12d0be1f/565cc/1634732325536-d864a562-5609-4429-bf8d-aeb586eb95d7.png 1806w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n<a name=v8GKb></a></p>\n<h2>五、Cloudflare 页面缓存规则</h2>\n<p>经历了以上九九八十一难，你的自定义域名终于通了，也就是说，可以通过你的已备案域名访问到 AWS lambda 的服务了！</p>\n<p>这个时候，不要忘记了我们的初衷，我们费了这么大劲，是要给 GraphQL 响应加上 CDN 缓存！</p>\n<p>这很简单，再加上两个规则即可，对于缓存级别，选择缓存所有内容；对于 TTL，选最长的。因为对于这个使用场景，是不需要它过期的，但是最长只能选到一个月。当有语雀文章更新时，是可以通过 Cloudflare API 主动清除缓存的。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/99f742a96c473f17a19bedf3941f4e4c/010dc/1634732565216-ce3c07c8-5825-4118-86ad-35830a2f993c.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 59.45945945945946%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAABjElEQVR42p2T3XKbMBCFefo+SZ+gr9DLXjRpO55xJnZwsF2IEAhJgNDf6ayAxHGai4SZb/bneI+Fdsicc7i7f4DoJPq+R9d1OJ1O2O12Kf/IE2NEZozB7e0N9vs9iqJAnufYbrfYbDaoqgrDMEBKmSL9IUVrbcqpv2re+2SaUXI8HnE4POJ8PuOpqnCsBFg7wtoJSql0UjJYoUOQkRAiobV+bXg5RFcwWQcz2ZST7kOY48LaDyEk1l4ypAbnHJ0QLwYpulQ/95ahVLsXba3JB3SHLgQ85DlYzREB+BgRLqDa0mAI7+p+0dIJbcuh/p4wcfZfRlahLQ5oHvOUX+umfoIuz7ANQxyH2bBiDG3TYDIG4zjCLIwLtICyLNFwnhZy/RvacqDX7lpkjjPUVQleljBawfb6FUZJ9KJNuKF/o09aoe8EXK8RRIPMK4ndn9+4+/kDUBxBSzjZwV9AtaWhq75Xs0YxKIk4GWQ+Arypsc1r/NrLdLmfZV6KdWBlgW/fC3z5ej+vHzF9Rp/hH6rEoVxN79jkAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/99f742a96c473f17a19bedf3941f4e4c/fcda8/1634732565216-ce3c07c8-5825-4118-86ad-35830a2f993c.png\"\n        srcset=\"/static/99f742a96c473f17a19bedf3941f4e4c/12f09/1634732565216-ce3c07c8-5825-4118-86ad-35830a2f993c.png 148w,\n/static/99f742a96c473f17a19bedf3941f4e4c/e4a3f/1634732565216-ce3c07c8-5825-4118-86ad-35830a2f993c.png 295w,\n/static/99f742a96c473f17a19bedf3941f4e4c/fcda8/1634732565216-ce3c07c8-5825-4118-86ad-35830a2f993c.png 590w,\n/static/99f742a96c473f17a19bedf3941f4e4c/efc66/1634732565216-ce3c07c8-5825-4118-86ad-35830a2f993c.png 885w,\n/static/99f742a96c473f17a19bedf3941f4e4c/c83ae/1634732565216-ce3c07c8-5825-4118-86ad-35830a2f993c.png 1180w,\n/static/99f742a96c473f17a19bedf3941f4e4c/010dc/1634732565216-ce3c07c8-5825-4118-86ad-35830a2f993c.png 1714w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><a name=Zz7Sv></a></p>\n<h1>大功告成！</h1>\n<p><a name=MdzEb></a></p>\n<h1>总结</h1>\n<p>少量开发（大量配置，好在一劳永逸）结合少量费用（基本免费），将极其缓慢的接口响应，变得快得不能再快，这就是免费架构！</p>\n<p>通过少量开发使得原本的 GraphQL HTTP Post 请求转变为 GET 请求，从而可以利用 Cloudflare 的页面规则来实现 CDN 缓存；又通过 API Gateway 的自定义域名，去掉了代理服务，最终将<strong>三慢合一</strong>中的两慢解决掉了，实现了小程序页面的秒开效果！</p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}},"menus":{}}},"staticQueryHashes":[],"slicesMap":{}}