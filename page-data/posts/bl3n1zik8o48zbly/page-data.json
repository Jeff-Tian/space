{"componentChunkName":"component---src-templates-post-js","path":"/posts/bl3n1zik8o48zbly/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/bl3n1zik8o48zbly","relativePath":"posts/bl3n1zik8o48zbly","frontmatter":{"title":"Keycloak 使用授权码换取令牌过程详解","stackbit_url_path":"posts/bl3n1zik8o48zbly","date":"2023-01-06T06:03:15","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p><a name=JhQpg></a></p>\n<h1>前情提要</h1>\n<p>在《<a href=\"https://zhuanlan.zhihu.com/p/488194876\">OAuth 2.0：对接 Keycloak 设备码授权流程 - Jeff Tian的文章 - 知乎 </a> 》里，科普了一下 OAuth 2.0 的常见授权许可类型，并详细说明了其中的设备码授权许可。</p>\n<p>今天，再来以 Keycloak 为例，详解一下其中最常见的“授权码许可”。\n<a name=mxh46></a></p>\n<h1>Keycloak 中的授权码许可</h1>\n<p>“授权码许可”是通过授权码 code 来获取用户级别的访问令牌，Keycloak 是 OAuth 2.0 协议的一个具体实现，我们今天用它做为例子详解其中的步骤。再次使用了我部署在 Heroku 上的 Keycloak 实例： <a href=\"https://keycloak.jiwai.win\">https://keycloak.jiwai.win</a> 。</p>\n<blockquote>\n<p>正如《<a href=\"https://zhuanlan.zhihu.com/p/567187898\">Free Arch: Bye-bye to Heroku - Jeff Tian的文章 - 知乎 </a>》提到的，Heroku 的免费 dyno 时代结束了。现在我用的是最低配置，每个月付 5 美元，可以享用 1000 小时的经济型 Dyno。所以，如果你发现 <a href=\"https://keycloak.jiwai.win\">https://keycloak.jiwai.win</a> 访问出错，那一定是当月额度已用完，需要等待下个月1号才能使用了。\n一开始，1000 小时是远远够用的，我一般到了月底，会收到 Heroku 发现的 80% 用量提醒。但现在似乎有越来越多的人在用了，导致在每个月的 20 号左右，就收到了 Heroku 的邮件，说 1000 小时全部用完，应用进入了休眠状态……</p>\n</blockquote>\n<p><a name=t6Xyw></a></p>\n<h2>涉及到的请求端点（url endpoint）</h2>\n<p>该授权许可，本质上是通过一个临时 code 来换取 token 信息，分别用到了两个请求端点</p>\n<ul>\n<li><strong>auth，用来获取 code。换取 code，需要登录 Keycloak</strong>。可以通过多种凭证登录，具体看该 Keycloak 的设置。我的 heroku 实例目前设置了用户名和密码，以及一些第三方登录方式。</li>\n<li><strong>token，用来获取 token 信息</strong>，需要带上前面一步所获取的到 code</li>\n</ul>\n<p>这两个端点的具体地址，可以通过打开 Keycloak 的 OIDC 发现接口来获取：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 49.32432432432432%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB00lEQVR42p2Sz2sTQRSA9yTiVQRvrSVFjGarSWqarUkspeBB8RRI6n/TNFEwPdg/IZdC6clTiRVavQoeRVAqocUa8sNkd7OzOzv7SXZj0OKh+OBj4M3Mx3szT9vZ3aXRaPBqe5v61ha15y/YqGyyWa2G60alQrVW42W9fiG0WCLJ7Nw8V69d59LlK+TzBZ6tr1MsFimXy1NKpdKF0FKZZfT0EolUhpt3krw9fMc4pJT8T2jG0zVWnqzy4HGOeEan2TwMN4QQjGyb7sCk3R8ysAU9c0Tfcvhpi2i1HLpDm/4k7wiBlirkKDxaI2kYzCXivD7aC4WDwRDLMrGEFwpM4WE6/2CSH58LggBNv5cleT+HnsxyI5Zgr7lDn2Pa7TaW6QA+KImUXog6hz9FRsJEcolsfpXM8gozsTgHzSMUFh+6+1ijDh/bHt+Hblh1EIDrB1McP8BXQSj6jbaQNkhn89xNG8zEbrPffBNePu584rP9ntbgjNPBCZbfxZQ9esKn4yj6QnE2UrhSoVTEtEI9leWWnmZ2fiw8iD5l5CFcQcc8ofXjC632V05735Cei5JyivyD6A1TWRaNh8QXFv8S+r4fjY/r44wEgQIUUWvj9iecH5tfFQB7Vj9ASBAAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/a5d0e7095c2b506ccb67d2e88abd2018/fcda8/1672982745948-6c5bf907-9d78-4625-8f71-0ac3045041e4.png\"\n        srcset=\"/static/a5d0e7095c2b506ccb67d2e88abd2018/12f09/1672982745948-6c5bf907-9d78-4625-8f71-0ac3045041e4.png 148w,\n/static/a5d0e7095c2b506ccb67d2e88abd2018/e4a3f/1672982745948-6c5bf907-9d78-4625-8f71-0ac3045041e4.png 295w,\n/static/a5d0e7095c2b506ccb67d2e88abd2018/fcda8/1672982745948-6c5bf907-9d78-4625-8f71-0ac3045041e4.png 590w,\n/static/a5d0e7095c2b506ccb67d2e88abd2018/efc66/1672982745948-6c5bf907-9d78-4625-8f71-0ac3045041e4.png 885w,\n/static/a5d0e7095c2b506ccb67d2e88abd2018/c83ae/1672982745948-6c5bf907-9d78-4625-8f71-0ac3045041e4.png 1180w,\n/static/a5d0e7095c2b506ccb67d2e88abd2018/1cc3c/1672982745948-6c5bf907-9d78-4625-8f71-0ac3045041e4.png 2322w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span><br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.810810810810814%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABU0lEQVR42lXP2WrbQBSAYb3/65RCSksLuepFiB3XiRfFGnnRYiu2NNYsmpGqv0gNWQ58/JybAycwxpJkJw7JkUspkVIhZf1JXWu0abB2YHGNo/Ue7z3OeZx/F5jGYpzBeD2yQ4fdaXSjxg4a13CxLaly5Lbj0kLdAfR8nOCkDsRZyK5YER1n7MpH9vKBbTVhW92/Oeo1qVqT6mcSNQhJVUhhBHX3Mh7r+56gkDmT+R33szuenqeIYsK6uGV5/MUi/8lj+oN58p3p/gsP+6/Mk5tX3/iT3LApflNoQW3PdH9bAq0MsYgRQiBETJpviQ9LDlnI+byjUhmVSilfVTr7TKV0nX9/WcqKxWLFJgpZhjNW0ZQ4mZPmK07lhkIKTnJo9L9XMXq5xih7xvoa3ZSo5jIKjDEkeUSSC5I8RtsrXe/wncG1Az1qBl697QPfWnzX0H7wDwsKD3Oe+OAPAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/7456b2361d1de6705a805b6abb7d8a46/fcda8/1672982788890-36cfe61f-a64f-4a85-8ea8-7b0f1e1fa43d.png\"\n        srcset=\"/static/7456b2361d1de6705a805b6abb7d8a46/12f09/1672982788890-36cfe61f-a64f-4a85-8ea8-7b0f1e1fa43d.png 148w,\n/static/7456b2361d1de6705a805b6abb7d8a46/e4a3f/1672982788890-36cfe61f-a64f-4a85-8ea8-7b0f1e1fa43d.png 295w,\n/static/7456b2361d1de6705a805b6abb7d8a46/fcda8/1672982788890-36cfe61f-a64f-4a85-8ea8-7b0f1e1fa43d.png 590w,\n/static/7456b2361d1de6705a805b6abb7d8a46/efc66/1672982788890-36cfe61f-a64f-4a85-8ea8-7b0f1e1fa43d.png 885w,\n/static/7456b2361d1de6705a805b6abb7d8a46/c83ae/1672982788890-36cfe61f-a64f-4a85-8ea8-7b0f1e1fa43d.png 1180w,\n/static/7456b2361d1de6705a805b6abb7d8a46/cbe7f/1672982788890-36cfe61f-a64f-4a85-8ea8-7b0f1e1fa43d.png 2420w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n<a name=PCq9I></a></p>\n<h2>流程图概览</h2>\n<p>整体流程如下所示，基本上是先通过 auth 请求端点，打开 Keycloak 登录页面。在登录完成后，Keycloak 回调指定的 redirect_uri，并在 url 上通过请求参数带上 code。接着，再通过 token 请求端点，带上拿到的 code，去换取 token 信息。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 134.45945945945945%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAbCAIAAADzvTiPAAAACXBIWXMAAAsTAAALEwEAmpwYAAADDklEQVR42o1Uz28TRxT2v9OqEpSKM/eilktJbhwQLWpKWlIpND1EgGT3ggQnwKhN1ENFJdpDheihcAJEEoTADorkGHDS2EsS22vvzszu7Px4b1616yQOsWnyNJrVfrPf+957++bl/ny8OVFcnpqpTs28migu33/eJqK7882JWyn442wK/jW3SUQPnvvni5Wp2erUbPV8sXLn0UZu/HrlyDcLn06/OD5d+nhs4fJvb4ho8ufqkXMLn10sHZ9+8cm5he9vLRNR/nbtgy+fHJt8dmzy2Udn58avV3Lf3awcHX96Mr84+tPi4bH5/O0aEf0wUz08Nj9SWPz8UunDr+Yu/FIlosLvtUNfz5+4VDpxuXR0/Om3Nyq54t/10UL5zLWlM9eWRgvlOw/XiejX+95IoXz66tLpq0tf5Msz/3hE9MejjZF8+dSVl6euvBwplIv36jnKDNBZcPSuWXAwABrrELfAXO8J4IxFInLZe283sOVxN6gtAm6BfeUe+R0RGBKOsdhX3oFYjIyLdrvdSc0XUVJvKW32etxR7pMtuC7XjHEhBOc8CALOuYhtFo5zzu0mDyiD2+wqxsLV1dXXr17XaitRJBKNg2EPUQZ0UoEF0kDKoBARYyzMVrZxqawyqAx2uNnxuE0GJzUai9qg0iCl9H3/TW3F8952ul0ppdJWW9QWW6HeS7bgWqHu+VbWJRo4592QBZl0kjKdMqnrWMGQgvlsm2xQKpuWLSNzxmRilHG9o1gBDua85z87lyLG4u5SE1GclmYg51BYIaG3ogT9Dms0GuvrG52AxdpFCUYKE+sabSU17qPca+NYahlHacGUijNLlN2O+j3k3mkgbH2DCc6CIPh3rR5m5ocJIO2vbLPeTpM3JkkSAHAOh/T2e8JGkUAQMs/zVlZWm81mJ2DNwByIbMElOv2w1WqvrdWDbhcddbnZJ+c9V9JaC5kNv5JDycrgekclCltt3/O8zWZLKggjCwfL2bHYOiIhokajwblwRFLDwcgHnCT/T3auPw+G3GfEIYMSsD8od4M7zf4f+DviNWfQUqsAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/1ee6f8d66e22b60557a17e0238117254/fcda8/1672982298215-5dbba916-5fb6-4359-beea-d78799915657.png\"\n        srcset=\"/static/1ee6f8d66e22b60557a17e0238117254/12f09/1672982298215-5dbba916-5fb6-4359-beea-d78799915657.png 148w,\n/static/1ee6f8d66e22b60557a17e0238117254/e4a3f/1672982298215-5dbba916-5fb6-4359-beea-d78799915657.png 295w,\n/static/1ee6f8d66e22b60557a17e0238117254/fcda8/1672982298215-5dbba916-5fb6-4359-beea-d78799915657.png 590w,\n/static/1ee6f8d66e22b60557a17e0238117254/50383/1672982298215-5dbba916-5fb6-4359-beea-d78799915657.png 740w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n<a name=E6ekj></a></p>\n<h2>步骤详解</h2>\n<p><a name=IxIO1></a></p>\n<h3>客户端配置</h3>\n<p>要使用该许可流程，需要先有一个客户端，并且开启标准流程。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2dc1578b35842224f4684b5d155fec84/f291a/1672983005694-5acf7c35-5b5b-4c83-800e-2b23732a8f0b.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.4054054054054%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB4UlEQVR42o2S62oTURSF5yH80YpGkVastSEXcyONNRQv7yaI0bRBRPCf10coiE/gL6WCoDQzsTGZzmQmc58zn5yTENJ6wQ2Ls/eCvc7e6xzt1Zt3vHz9lmfPX9Dp7nPw/gM/hj856vfRjQF93UA3DHTdoK/rGIOBqhWvG4zGY8amyWg8g7aRL3N1s8j69QLnzl/mwcPHZMBoNCKOY1RkksnmaTavZyGEWCATAq3c2KHR2qXabHPhyjU63R4pYE0cwjAkSRJ83ycIQ/wgUJyErANZR5HKJed5Hlrl9j1a7TvUttvk1jbo9p6qm6MownVd1eA4rhKWE5/FMi9zbatUp1xvUaw0Wcmt0XmyrwTljY7rgkjJEtmQqIazWBaVayvBVvsuO7v3Wb20zqO54NTzmNoWh1bIp7GnPEyX/PoTpL/ajWKVQqVJqbZ9akLTNJm6LhMvYHhi87+h5csNte5moToT7PYWgrZtk8QxvueRipQ0/TcWK8tXzpfrrFyUE84EJ/ZEgTTFd12CIFp6gOQ0koQoipWoErxZv8VWqcZqTnrYBRKG9oATZ8A3x+SLeUwgXOJUEIvsNyTyTAWpUB7WKFabyFMKdvb2CLD4ahwytL7z2Trm4/CIBGf2qWff+68e/gJkeOuvEI1DIAAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/2dc1578b35842224f4684b5d155fec84/fcda8/1672983005694-5acf7c35-5b5b-4c83-800e-2b23732a8f0b.png\"\n        srcset=\"/static/2dc1578b35842224f4684b5d155fec84/12f09/1672983005694-5acf7c35-5b5b-4c83-800e-2b23732a8f0b.png 148w,\n/static/2dc1578b35842224f4684b5d155fec84/e4a3f/1672983005694-5acf7c35-5b5b-4c83-800e-2b23732a8f0b.png 295w,\n/static/2dc1578b35842224f4684b5d155fec84/fcda8/1672983005694-5acf7c35-5b5b-4c83-800e-2b23732a8f0b.png 590w,\n/static/2dc1578b35842224f4684b5d155fec84/efc66/1672983005694-5acf7c35-5b5b-4c83-800e-2b23732a8f0b.png 885w,\n/static/2dc1578b35842224f4684b5d155fec84/c83ae/1672983005694-5acf7c35-5b5b-4c83-800e-2b23732a8f0b.png 1180w,\n/static/2dc1578b35842224f4684b5d155fec84/f291a/1672983005694-5acf7c35-5b5b-4c83-800e-2b23732a8f0b.png 2258w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>同时，需要配置好回调 url，它用来接收 Keycloak 传来的 code。由于我们现在是手动模式，可以随便配置一个，不用真的写代码去实现这个回调 url 页面，打不开并没有关系：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/511f3750254be41f225ea2190629d732/a1a4b/1672983047758-8794d2d4-178d-46fa-84b1-bca886f68602.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 23.64864864864865%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA50lEQVR42pWPy0rEQBRE8yfjYtzo1zjgLPQfRdyLiDs/QBjwsRB1Mul0uifdefTrSDrguHDjhYJbt4qibnF1fcPt3T2NUtRSsqsEtRC8flU8vZfI6SYEQkpq2WRPVdfZ1xpLPwx0/QHFYnnKan3JNFprtmWJloKXNvC46/nvFIvlCav1RSZN0+RQvd9DDPjO4GOABFV4Y4xd3lNKf2ISi6PjQ8MYI9ZajDF4HzCdhQifbsNmeIAA3rusee9/EMLMY0rzy2fnc0NrTG45BTrnUEqhpOajfaYdJcFFRjdm7TeC9whlsL3jG2Bjcagwun1cAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/511f3750254be41f225ea2190629d732/fcda8/1672983047758-8794d2d4-178d-46fa-84b1-bca886f68602.png\"\n        srcset=\"/static/511f3750254be41f225ea2190629d732/12f09/1672983047758-8794d2d4-178d-46fa-84b1-bca886f68602.png 148w,\n/static/511f3750254be41f225ea2190629d732/e4a3f/1672983047758-8794d2d4-178d-46fa-84b1-bca886f68602.png 295w,\n/static/511f3750254be41f225ea2190629d732/fcda8/1672983047758-8794d2d4-178d-46fa-84b1-bca886f68602.png 590w,\n/static/511f3750254be41f225ea2190629d732/efc66/1672983047758-8794d2d4-178d-46fa-84b1-bca886f68602.png 885w,\n/static/511f3750254be41f225ea2190629d732/c83ae/1672983047758-8794d2d4-178d-46fa-84b1-bca886f68602.png 1180w,\n/static/511f3750254be41f225ea2190629d732/a1a4b/1672983047758-8794d2d4-178d-46fa-84b1-bca886f68602.png 2054w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><a name=XeozE></a></p>\n<h3>调用 auth 端点</h3>\n<p>这一步，必须使用浏览器，输入这个端点 url。用 Postman 虽然可以打开页面，但在登录环节可能有问题。总之，授权码许可，就是用在浏览器场景的，所以使用浏览器打开这个端点，碰到的问题最少。</p>\n<p>这个端点需要一些参数，为了方便展示，这里仍然使用 Postman 截图：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/84a29e8946ceafbe665a2e6a5245293e/66632/1672983371921-2786b483-7bb8-43f7-add2-0cd835ac8bbc.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.08108108108109%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABg0lEQVR42qWS3W7cIBBG/f6P1btc5jJRs1Via+PE67+1YQAzcyrjTZP2qmqRjvgYmE8zQOVFcM4xjgPjODKU+dAfDDvDbX8YCn3fs64r3ntS9NydhG+PjspdF4IPuNXhnMevHrc4vBO88wSRgohHdh1CMflEwDL3deTuR6R6ef/OLD1iy2+4fGUKHQqsG0jm18jbhumXwBEFjVRPzQNLGvE64/OM12th3Sa665netfS+4znd06eOXmBOxpqMJSlrUpaij1h1envA2Yy3CWcTq44H20TjH4tRtz3T5RPztrAkSFnZ1MgKucyGmpHNqLwsxCQ4cYQoqGnBjFLxRZ/+aM1AM7olVDdyTmTd8DGTNqWaJqG7eJxbSSkdKbanWdFncTQ+cglGK8YQoRV49ca7KH1QJN+qVKNqzkLdxHKp+wvmnG+mVkgKIe9YeZiohw43ve+rfVZf1fUL5/MrbdvSNE35W18NS4t/wcf5qq47RCKqyv+OYti2PSKhLPZ2d+N/ZTf8CVySWbJ8TlONAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/84a29e8946ceafbe665a2e6a5245293e/fcda8/1672983371921-2786b483-7bb8-43f7-add2-0cd835ac8bbc.png\"\n        srcset=\"/static/84a29e8946ceafbe665a2e6a5245293e/12f09/1672983371921-2786b483-7bb8-43f7-add2-0cd835ac8bbc.png 148w,\n/static/84a29e8946ceafbe665a2e6a5245293e/e4a3f/1672983371921-2786b483-7bb8-43f7-add2-0cd835ac8bbc.png 295w,\n/static/84a29e8946ceafbe665a2e6a5245293e/fcda8/1672983371921-2786b483-7bb8-43f7-add2-0cd835ac8bbc.png 590w,\n/static/84a29e8946ceafbe665a2e6a5245293e/efc66/1672983371921-2786b483-7bb8-43f7-add2-0cd835ac8bbc.png 885w,\n/static/84a29e8946ceafbe665a2e6a5245293e/c83ae/1672983371921-2786b483-7bb8-43f7-add2-0cd835ac8bbc.png 1180w,\n/static/84a29e8946ceafbe665a2e6a5245293e/66632/1672983371921-2786b483-7bb8-43f7-add2-0cd835ac8bbc.png 1504w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>为了拿到 code，这时候，可以打开浏览器，并打开开发者工具面板，定位到网络标签页。这时在浏览器地址栏里打开上面的链接即可，比如：<br /><a href=\"https://keycloak.jiwai.win/auth/realms/UniHeart/protocol/openid-connect/auth?response_type=code&#x26;client_id=demoapp&#x26;redirect_uri=http%3A%2F%2Flocalhost%3A8080&#x26;state=1234&#x26;scope=openid\">https://keycloak.jiwai.win/auth/realms/UniHeart/protocol/openid-connect/auth?response_type=code&#x26;client_id=demoapp&#x26;redirect_uri=http%3A%2F%2Flocalhost%3A8080&#x26;state=1234&#x26;scope=openid</a><br />打开链接后，展示的是 Keycloak 的登录页面，登录完成后，会展示一个打不开的页面，如： <a href=\"http://localhost:8080/?state=1234&#x26;session_state=b4d51dd8-1328-4f48-a20f-49ddd86ed92f&#x26;code=0e267247-d1d5-408f-a743-521ec7117c93.b4d51dd8-1328-4f48-a20f-49ddd86ed92f.98ea8f07-a7f2-4607-ab56-b5208a90eaa1\">http://localhost:8080/?state=1234&#x26;session_state=b4d51dd8-1328-4f48-a20f-49ddd86ed92f&#x26;code=0e267247-d1d5-408f-a743-521ec7117c93.b4d51dd8-1328-4f48-a20f-49ddd86ed92f.98ea8f07-a7f2-4607-ab56-b5208a90eaa1</a> 。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.94594594594595%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABq0lEQVR42mWS224TMRRF8/9vgEgQSIEkTVIlpfQreEHiufQSlSjXmbFnPPZkbrYXykxCWzjSlo5ke3n7bHe+Xd8wnl3z8fKKT5M5vYs5/cmcwXTO58mMweSKy5sx/WmP3uioLt3BO97039IbvefDsMtwNGY6+8qX4QUdThUC5qRz+Re9rSqk0sTKIGSCSBRKGw5FickLispSO0+nLAsiISmtxzmH9w7nPGVtKau6kXOWRGmkTAikIEwExhi0ydDGkOrnvuO9RwhBLCVxHDd9FEVYa082W59Gp+yDkDhJCSNJGMYYnaESTaoMtnY461tgGEWEYYiUEqUSsixr3La8FqgSwd39A7tgy+P6lsfVHcv9gmW4INAbVC5QhWiBWZaTHG/TB7K8xJ1n6D3WtcA0TdhudwTBjlCtCeIVaSZ4qn6S2B25NRysbkPRWcEm0uyEITYVpnB/nZ1LqZjVesPhkL8KLbKbV/sah0VR4Gz9T6404O8PBaWFVCluf92zD4JmLa8duvZktW/OHTlHNQ7LqsK+mNnZ3RH4Y1FSHYGp4un3EhnH/32q59d4/gCG/Kacqgf2RQAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/84c3bbc37da1b06c754a54caceb35a90/fcda8/1672983661128-288fc1a2-7044-419c-8547-d8b4085f7895.png\"\n        srcset=\"/static/84c3bbc37da1b06c754a54caceb35a90/12f09/1672983661128-288fc1a2-7044-419c-8547-d8b4085f7895.png 148w,\n/static/84c3bbc37da1b06c754a54caceb35a90/e4a3f/1672983661128-288fc1a2-7044-419c-8547-d8b4085f7895.png 295w,\n/static/84c3bbc37da1b06c754a54caceb35a90/fcda8/1672983661128-288fc1a2-7044-419c-8547-d8b4085f7895.png 590w,\n/static/84c3bbc37da1b06c754a54caceb35a90/efc66/1672983661128-288fc1a2-7044-419c-8547-d8b4085f7895.png 885w,\n/static/84c3bbc37da1b06c754a54caceb35a90/c83ae/1672983661128-288fc1a2-7044-419c-8547-d8b4085f7895.png 1180w,\n/static/84c3bbc37da1b06c754a54caceb35a90/044a9/1672983661128-288fc1a2-7044-419c-8547-d8b4085f7895.png 3036w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span><br />这样，对 auth 端点的调用就完成了。\n<a name=HqxRJ></a></p>\n<h3>调用 token 端点</h3>\n<p>这是一个 POST 请求，通过浏览器就不方便手动操作了。可以使用 Postman，拼接如下的参数：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c646db64bd43731a4dbb9c23f0d4ac71/7db30/1672983941246-3d05c974-ac56-4ed1-bb10-81bc269969ec.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.13513513513513%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAAB+klEQVR42lWT63KbMBBGef836PP0R1+h0yR2YmJsAwJJSCChy+lIJGmjmTP77bI3wdCs64q1FqkUUkmknJFSoZRCa41z7hvbtn3z182Rg+PXyfHjp6ERQrAsmm07Gq/WsJXEj0EpJcrJOfN5Ys6ElEk19glsPtC0bYv3vhaU4pTyly4bluaffoyRFAOTS5yXTL9lJp8xe2aN4Lynud9u7PtOyolct/nYJOd6pTKsNMs51TzvHSEmTMhoH9lCIsSIj5l18zTzJOomSiukXjDG4pyvRXuIlaILMeUvysAYd0IMlW2PmNXTlOssy8bpKnnuNE+dqvbldvDUaf5cVbXPN12fne4L76Pl0ptq33pDO1oGaWnK7dQa+H09ii+D5SpsTSy2JFYGQzsc8faj2fmxcBkMnbB0YkXojaZ8KTtrHjfBbbKMyjMoV6laHvoxO3rpENojzf6FsoHNR9aC248rl/d36gZOveTlMVfeJ/1FKxSXUR2+0DzUwrgYxsXy0IbZrv8aphwRuuepG/hzF7z0E093wXmYOPUHRX9S/IuQXGdFJ8sQxfs80UnNvDiaRECsM5de8TpI3kZFKzRvg+ZcYr2iHTWX8YgVXgdVKbF2XGinmXaSzNrRhBRZ1MAwPmhnwWAUwi4oZ1jjig22soZDl1jR//sRd/xBMfIXj/yY+rGNy3gAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/c646db64bd43731a4dbb9c23f0d4ac71/fcda8/1672983941246-3d05c974-ac56-4ed1-bb10-81bc269969ec.png\"\n        srcset=\"/static/c646db64bd43731a4dbb9c23f0d4ac71/12f09/1672983941246-3d05c974-ac56-4ed1-bb10-81bc269969ec.png 148w,\n/static/c646db64bd43731a4dbb9c23f0d4ac71/e4a3f/1672983941246-3d05c974-ac56-4ed1-bb10-81bc269969ec.png 295w,\n/static/c646db64bd43731a4dbb9c23f0d4ac71/fcda8/1672983941246-3d05c974-ac56-4ed1-bb10-81bc269969ec.png 590w,\n/static/c646db64bd43731a4dbb9c23f0d4ac71/efc66/1672983941246-3d05c974-ac56-4ed1-bb10-81bc269969ec.png 885w,\n/static/c646db64bd43731a4dbb9c23f0d4ac71/c83ae/1672983941246-3d05c974-ac56-4ed1-bb10-81bc269969ec.png 1180w,\n/static/c646db64bd43731a4dbb9c23f0d4ac71/7db30/1672983941246-3d05c974-ac56-4ed1-bb10-81bc269969ec.png 1494w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><br />拼接好了请求，执行，就能拿到用户的 token 信息了。</p>\n<p>可以通过 jwt.io 来查看 id_token 的详情，比如：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a884dae6ef62077667768df4f6499381/91a65/1672984066957-9230f903-b712-4f5a-9ba9-4726c392aeed.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.89189189189189%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAACKklEQVR42m2SS0/bQBRGs4ZsbAxS2VM1LLqp1G2lkgdQiS5QI9of0D/bTam6KC2QF88QEhu/7Zl7qvE4UKTa+nRnYZ8598403r3f4fOXrxwefqJ/dES722Wn26li1rt7e/R6u3R7PXq7trY7HXba7Spmvb//gX6/z8HBRxprrsfbNx1aWy1ev2rhrDZxVlZxVpo4zSYbjsO65+F5Hhvr63iui+u6OFUc3DWXF5ubtLa3ebm1RSPJUh6GlwTfTvGPB0Q/xsTHI+Lvw2od/JkTBxFREpPMfJLhDcl0ThKEJP5DVaO5TzBfEIYhDQAdQDmwKUydQDG062IMKKpH5QUUJWSFTVpCriAtQEv1TUPQ5FNNciKkZ0J6XleTgZCNNDoTSlUShTF5oigzQSnN0ysorVFKGUOhmAnpL8jOhGwgpKdCeiJk5yagc8FsLDGUU8gvhXIm6FhQvqATYyeIUAPvheQnNcDGQM0G+Qh0KZWHCi2oXGBhYQ2MbbtPwDtjhDU7raGm5d/PDVUIxXUNyQSdWpiUS0OxwHJufn5umI3qOngCGrP8Sij92nRmLUUtDZfAwJrkEyEbmjbtLKuZ/msYYUH3FvRoWPwHmBrghTV7POGxkE1AFzXQh+JKKG7tQUh9nZbzq6+NoBeCOoN8KBQXoMagJsACCKla0ssZ3ko1R2NZmYs1e3YoiwfN9VQz8jWjWHOXaW4SzWWkuUs0SguidW1hhy/a5tGuNvwL5kiW8CTe1JQAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/a884dae6ef62077667768df4f6499381/fcda8/1672984066957-9230f903-b712-4f5a-9ba9-4726c392aeed.png\"\n        srcset=\"/static/a884dae6ef62077667768df4f6499381/12f09/1672984066957-9230f903-b712-4f5a-9ba9-4726c392aeed.png 148w,\n/static/a884dae6ef62077667768df4f6499381/e4a3f/1672984066957-9230f903-b712-4f5a-9ba9-4726c392aeed.png 295w,\n/static/a884dae6ef62077667768df4f6499381/fcda8/1672984066957-9230f903-b712-4f5a-9ba9-4726c392aeed.png 590w,\n/static/a884dae6ef62077667768df4f6499381/efc66/1672984066957-9230f903-b712-4f5a-9ba9-4726c392aeed.png 885w,\n/static/a884dae6ef62077667768df4f6499381/c83ae/1672984066957-9230f903-b712-4f5a-9ba9-4726c392aeed.png 1180w,\n/static/a884dae6ef62077667768df4f6499381/91a65/1672984066957-9230f903-b712-4f5a-9ba9-4726c392aeed.png 2476w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><a name=rrT3B></a></p>\n<h2>排障指南</h2>\n<p><a name=Cwiwv></a></p>\n<h3>token 结果里没有 id_token</h3>\n<p>虽然调用 token 端点时，指定了 openid scope，仍然没有返回 id_token 的结果。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.10810810810811%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAABqElEQVR42pWTaY7bMAyFdf9eqecoUHQyaJvEzuZVpFZKrxCdzEza/mgJfHgUTZM0IRt2jHlZsCwL5nnCPM/qN5xz8N4/EUJQHucUPa6Lx6fPjK+nBMPEYCJYa2HXFe1MRJpcS0Wtz5RSICLPsVoxUUZIAhNTQKkCKRlS5c1nR6q/WysWY/yjUU4BzjHMFE+gMsAqt4064DDusB928JG1QEpJtRVs1orgIwCc9zAhJSQRRUq9U0DMsEQIMSkxZsSmKSPlLV81C2IW+FQQQoRpLzFveO8gOeFfbFvNfUW1gEPWQYx3AZfB4jgwDjfC8cboRoducDjcWOkG1njLafGJIkYbMdlNGzMFiBQY6zO+7Bd861a89Ct2J4vXk8Wut3jpVuz6La7PmnZbziO/0fzvF9omZMvY9yPOM2O0QbsNa1B/uJ9va9BYo0030/tk1ie4kJVSKoxbGX0/YX8l7K+Mn1d6+9QHH+OnqV3koLSGCyfMvBVud9Ssy4gfxx6v1wHH0eI8eZ2gLflvkH/HR0GWgiRFtV0ls3CHkY64+DO8OEiB7uJ/7fEX/QKed6GZAkyM2gAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/bc95a5e7a0f79d47f28ffb19a3535c26/fcda8/1672984209199-227bd4d9-b6cd-476f-abcf-1eb74012c39a.png\"\n        srcset=\"/static/bc95a5e7a0f79d47f28ffb19a3535c26/12f09/1672984209199-227bd4d9-b6cd-476f-abcf-1eb74012c39a.png 148w,\n/static/bc95a5e7a0f79d47f28ffb19a3535c26/e4a3f/1672984209199-227bd4d9-b6cd-476f-abcf-1eb74012c39a.png 295w,\n/static/bc95a5e7a0f79d47f28ffb19a3535c26/fcda8/1672984209199-227bd4d9-b6cd-476f-abcf-1eb74012c39a.png 590w,\n/static/bc95a5e7a0f79d47f28ffb19a3535c26/efc66/1672984209199-227bd4d9-b6cd-476f-abcf-1eb74012c39a.png 885w,\n/static/bc95a5e7a0f79d47f28ffb19a3535c26/c83ae/1672984209199-227bd4d9-b6cd-476f-abcf-1eb74012c39a.png 1180w,\n/static/bc95a5e7a0f79d47f28ffb19a3535c26/fb4e7/1672984209199-227bd4d9-b6cd-476f-abcf-1eb74012c39a.png 1519w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span><br />这是由于前一步，调用 auth 端点时，没有指定 openid scope 造成的。解决办法详见“调用 auth 端点”中的截图，需要在调用 auth 端点时，就带上可选参数 scope。\n<a name=QK2Q6></a></p>\n<h3>调用 token 端点时，返回 invalid_grant</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3340ee16ee282b8ab2d7239a0e020083/c88ae/1672984278943-259cf597-c0f6-47d6-9334-d45cfda57dcd.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.810810810810814%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAAA6klEQVR42m1RW46DMAzM/S/R6+wl9o8PtBKhQGjwI5nKDmmpupZGthMzngxh2zYsy4IYI6Y4IToi5nlGSglEhOM4XrC+w3qmA8tOuP1k/P4JQs7ZL0TYh5gIIuK1ZYtaq6PXdldKaT1aVCEUFYRxHMHM5/B7QFWxrqvnN2nLRmboi0qtUG1nYRiGf5RUJ5qmCWaJKeovMdTG/Am0b0NKO0gEWsq5pTpEC/JBYBavr2BRsCrE0c5ImtJwv8+uYlk3rFtyJf2ZPeoFLx/Nc2WIipOnLC4oEDP48UDeMzKJb73+gG7BN+1n1NPXJ291JdSOaT16AAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/3340ee16ee282b8ab2d7239a0e020083/fcda8/1672984278943-259cf597-c0f6-47d6-9334-d45cfda57dcd.png\"\n        srcset=\"/static/3340ee16ee282b8ab2d7239a0e020083/12f09/1672984278943-259cf597-c0f6-47d6-9334-d45cfda57dcd.png 148w,\n/static/3340ee16ee282b8ab2d7239a0e020083/e4a3f/1672984278943-259cf597-c0f6-47d6-9334-d45cfda57dcd.png 295w,\n/static/3340ee16ee282b8ab2d7239a0e020083/fcda8/1672984278943-259cf597-c0f6-47d6-9334-d45cfda57dcd.png 590w,\n/static/3340ee16ee282b8ab2d7239a0e020083/efc66/1672984278943-259cf597-c0f6-47d6-9334-d45cfda57dcd.png 885w,\n/static/3340ee16ee282b8ab2d7239a0e020083/c83ae/1672984278943-259cf597-c0f6-47d6-9334-d45cfda57dcd.png 1180w,\n/static/3340ee16ee282b8ab2d7239a0e020083/c88ae/1672984278943-259cf597-c0f6-47d6-9334-d45cfda57dcd.png 1541w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><br />要么是因为 code 不正确。要么是 code 虽然正确，但是过期了。解决办法是，回到“调用 auth 端点”那一步，获取一个新的 code，并且粘贴至对 token 端点的调用处，立即执行，这一步手速要快呀。</p>\n<p><a name=DtJCY></a></p>\n<h1>自动完成以上的步骤</h1>\n<p>这只需要自己实现一个回调页面，从 url 里解析出 code，然后通过代码调用 token 端点即可。</p>\n<p><a name=AL8cF></a></p>\n<h2>服务器端实现示例</h2>\n<p>如果想在服务器端完成授权码许可流程，可以参考这个示例： <a href=\"http://uniheart.pa-ca.me/keycloak/login\">http://uniheart.pa-ca.me/keycloak/login</a>。它是一个 eggjs 服务器端，其详细介绍见： 《<a href=\"https://zhuanlan.zhihu.com/p/359057316\">在 eggjs 中集成 Keycloak 用户认证 - Jeff Tian的文章 - 知乎 </a> 》。</p>\n<p>在服务器端实现，是一个更推荐的做法，这时可以使用保密的客户端了，并在 auth 和 token 的调用时，除了传入 client_id，还需要传入 client_secret。</p>\n<p><a name=ePQ1o></a></p>\n<h2>纯客户端的实现示例</h2>\n<p>这就只能使用公开的客户端配置了，如下面这个客户端的配置， Access Type 需要为 public。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ea86f63d72485a3953ef67b925995ad2/c655d/1672984761656-38340b65-4e8e-4459-802e-5dc61e21eef9.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.4054054054054%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABoklEQVR42n2Q3WoTQRTH5ykEI5JiacQ2SbvbNJvEbO0qUl+uUENiREHwzs9HkOIzCFLBXtSdjU07m+zOdOdj50uSTb2J8cf/4pyBH3POAe8/fn734dPrN297/ZdfTr7+Hl/+CkMYRSGMYBRBGIUQRqPR/AVCGF0hhOK4CNjc3rtfdStbzq07946O+8oYhJCU0lprjLHGFEXBrNb6ptPAbe23/MfNh8Hd9Qe9wVBZO00x51xKSSnlnFPG+BwhBGNMCFG0WUbB3sGhHzz1usHaxuZg+MpaK0ROCGFcYEKUXJDnchlQ3203Oweu55fKlV5/aK3ljBFCtFbq38oCrTWou20/ONx/8qy0tpAzSjOc/JiK05jOdjQrAVXH22l0nGa3VN4oZITQNSFJxi7iqf0vYLvRcb3u1k7z79iTyQRjLPOcUTq77aoYA2qO53WD+m779s3PSZKmaaqVollG52fPlyLyXCoFam7L9fya65XKleeDgbXiYgpjHP1Mr76jEdNEKJMvRUijtJnJjfajqlPIL4TF5+MzhMPTZPztMlSWmNU7/wE42BGDn1GdMgAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/ea86f63d72485a3953ef67b925995ad2/fcda8/1672984761656-38340b65-4e8e-4459-802e-5dc61e21eef9.png\"\n        srcset=\"/static/ea86f63d72485a3953ef67b925995ad2/12f09/1672984761656-38340b65-4e8e-4459-802e-5dc61e21eef9.png 148w,\n/static/ea86f63d72485a3953ef67b925995ad2/e4a3f/1672984761656-38340b65-4e8e-4459-802e-5dc61e21eef9.png 295w,\n/static/ea86f63d72485a3953ef67b925995ad2/fcda8/1672984761656-38340b65-4e8e-4459-802e-5dc61e21eef9.png 590w,\n/static/ea86f63d72485a3953ef67b925995ad2/efc66/1672984761656-38340b65-4e8e-4459-802e-5dc61e21eef9.png 885w,\n/static/ea86f63d72485a3953ef67b925995ad2/c83ae/1672984761656-38340b65-4e8e-4459-802e-5dc61e21eef9.png 1180w,\n/static/ea86f63d72485a3953ef67b925995ad2/c655d/1672984761656-38340b65-4e8e-4459-802e-5dc61e21eef9.png 1586w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>示例见： <a href=\"https://umi-ckeditor5.vercel.app/\">https://umi-ckeditor5.vercel.app/</a>，其详细介绍见： 《<a href=\"https://zhuanlan.zhihu.com/p/572820262\">实战案例：在 Umi Js 项目中通过 umi-plugin-oauth2 插件对接 Keycloak - Jeff Tian的文章 - 知乎 </a> 》</p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}}}},"staticQueryHashes":[],"slicesMap":{}}