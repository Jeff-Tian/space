{"componentChunkName":"component---src-templates-post-js","path":"/posts/A-base-request-plugin-for-soap-msbin1-encoded-service/","result":{"data":{"sitePage":{"id":"SitePage /posts/A-base-request-plugin-for-soap-msbin1-encoded-service/"}},"pageContext":{"url":"/posts/A-base-request-plugin-for-soap-msbin1-encoded-service/","relativePath":"posts/A-base-request-plugin-for-soap-msbin1-encoded-service.md","relativeDir":"posts","base":"A-base-request-plugin-for-soap-msbin1-encoded-service.md","name":"A-base-request-plugin-for-soap-msbin1-encoded-service","frontmatter":{"title":"A base request plugin for soap+msbin1 encoded service","stackbit_url_path":"posts/A-base-request-plugin-for-soap-msbin1-encoded-service","date":"2012-01-29 03:56:00","excerpt":"","comments_count":0,"positive_reactions_count":0,"tags":["Visual Studio","request plugin","service","soap+msbin1","web test"],"canonical_url":"https://be-net.azurewebsites.net/post/2012/01/29/A-base-request-plugin-for-soap-msbin1-encoded-service","template":"post"},"html":"<h1><span style=\"color: #9b00d3\"><span style=\"font-weight: bold\">Problem:</span></span></h1>  <p>I need to create a web test for a service method, but the service only accepts <strong>soap+msbin1</strong> encoded message payload. That means even I pass a valid SOAP message to it, the service will still return an error response.</p>  <p>But the web test in Visual Studio 2010 can only pass the plain text message payload!</p>  <h1><span style=\"color: #9b00d3\"><span style=\"font-weight: bold\">Solution:</span></span></h1>  <p>To resolve this problem, we need to hook up the plain text message before sending the request out, and convert the plain text into the targeted soap+msbin1 encoded bytes. Then send the request with converted bytes.</p>  <p>We can create the above converter as a request plugin, and then plug it into the original web test.</p>  <h1><span style=\"color: #9b00d3\"><span style=\"font-weight: bold\">Steps:</span></span></h1>  <ol>   <li><strong><span style=\"font-size: small\">Create a web test request plugin.</span></strong> </li>    <ol>     <li>From Solution, we know we need a method to convert the plain text into a bytes array with a specified encoding method. This is the ConvertStringToMsBin1() method in the plug in source code, which will be present in the following section. </li>      <li>From Solution, we know we need to capture the plain text message before sending the request out, so we do the capturing work inside the PreRequest() method, which is one of the methods provided by the WebTestRequestPlugin base class (Our plug in will inherit from it!). </li>      <li>Source code (MsBin1Editor.cs): </li>      <ul>       <li><pre class=\"brush: csharp\">using System;\r\nusing System.Collections.Generic;\r\nusing System.Linq;\r\nusing System.Text;\r\nusing Microsoft.VisualStudio.TestTools.WebTesting;\r\nusing System.Windows.Forms;\r\nusing System.IO;\r\nusing System.Xml;\r\nusing System.ServiceModel.Channels;\n<p>namespace MsBin1Plugin\r\n{\r\npublic class MsBin1Editor : WebTestRequestPlugin\r\n{\r\npublic override void PreRequest(object sender, PreRequestEventArgs e)\r\n{\r\nStringHttpBody stringHttpBody = e.Request.Body as StringHttpBody;\r\nstring originalString = stringHttpBody.BodyString;</p>\n<pre><code>        //MessageBox.Show(stringHttpBody.BodyString);\r\n\r\n        BinaryHttpBody binaryHttpBody = new BinaryHttpBody();\r\n        binaryHttpBody.Data = ConvertStringToMsBin1(originalString);\r\n        binaryHttpBody.ContentType = stringHttpBody.ContentType;\r\n        e.Request.Body = binaryHttpBody;\r\n\r\n        //MessageBox.Show();\r\n\r\n        //MessageBox.Show(e.Request.BodyBytes.Length.ToString());\r\n\r\n        base.PreRequest(sender, e);\r\n    }\r\n\r\n    public byte[] ConvertStringToMsBin1(string text)\r\n    {\r\n        //MessageBox.Show(text);\r\n        try\r\n        {\r\n            MemoryStream memStream = new MemoryStream();\r\n            XmlWriter meWriter = XmlWriter.Create(memStream);\r\n            meWriter.WriteRaw(text);\r\n            meWriter.Flush();\r\n            memStream.Position = 0;\r\n\r\n            XmlReader meReader = XmlReader.Create(memStream);\r\n            System.ServiceModel.Channels.Message newMessage = System.ServiceModel.Channels.Message.CreateMessage(meReader, int.MaxValue, System.ServiceModel.Channels.MessageVersion.Soap12WSAddressing10);\r\n            var bindingElement = new BinaryMessageEncodingBindingElement();\r\n            var factory = bindingElement.CreateMessageEncoderFactory();\r\n\r\n            using (MemoryStream memoryStream = new MemoryStream())\r\n            {\r\n                factory.Encoder.WriteMessage(newMessage, memoryStream);\r\n                return memoryStream.ToArray();\r\n            }\r\n        }\r\n        catch (Exception ex)\r\n        {\r\n            MessageBox.Show(ex.Message);\r\n            throw ex;\r\n        }\r\n        finally\r\n        {\r\n        }\r\n    }\r\n\r\n}\n</code></pre>\n<p>}\r\n</pre></li>\r\n</ul></p>\n  </ol>\n  <li><span style=\"font-size: small\"><strong>Create the web test, and configure the plain text message payload via String Body node of the request.</strong></span> \n<pre><code>&#x3C;ul>\r\n  &#x3C;li>&#x3C;a href=\"https://raw.githubusercontent.com/Jeff-Tian/blogengine.net/master/Source/BlogEngine/BlogEngine.NET/App_Data/files/image_432.png\">&#x3C;img style=\"background-image: none; border-right-width: 0px; margin: 0px 10px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px\" title=\"A base request plugin for soap+msbin1 encoded service\" border=\"0\" alt=\"A base request plugin for soap+msbin1 encoded service\" src=\"https://raw.githubusercontent.com/Jeff-Tian/blogengine.net/master/Source/BlogEngine/BlogEngine.NET/App_Data/files/image_thumb_167.png\" width=\"622\" height=\"351\" />&#x3C;/a> &#x3C;/li>\r\n&#x3C;/ul>\n</code></pre>\n  </li>\n  <li><span style=\"font-size: small\"><strong>Add the plugin into the original request created at step 2.</strong></span> \n<pre><code>&#x3C;ul>\r\n  &#x3C;li>&#x3C;a href=\"https://raw.githubusercontent.com/Jeff-Tian/blogengine.net/master/Source/BlogEngine/BlogEngine.NET/App_Data/files/image_433.png\">&#x3C;img style=\"background-image: none; border-right-width: 0px; margin: 0px 10px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px\" title=\"A base request plugin for soap+msbin1 encoded service\" border=\"0\" alt=\"A base request plugin for soap+msbin1 encoded service\" src=\"https://raw.githubusercontent.com/Jeff-Tian/blogengine.net/master/Source/BlogEngine/BlogEngine.NET/App_Data/files/image_thumb_168.png\" width=\"381\" height=\"188\" />&#x3C;/a> &#x3C;/li>\r\n&#x3C;/ul>\n</code></pre>\n  </li>\n  <li><span style=\"font-size: small\"><strong>Done! You can run your web test now, it will work.</strong></span> </li>\r\n</ol>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","description":"Full Stack Developer, good at OAuth 2.0","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"本站源码","url":"https://github.com/Jeff-Tian/space","style":"link","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}},"menus":{}}},"staticQueryHashes":[]}