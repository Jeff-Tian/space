{"componentChunkName":"component---src-templates-post-js","path":"/posts/liegp9w5to7v2hzz/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/liegp9w5to7v2hzz","relativePath":"posts/liegp9w5to7v2hzz","frontmatter":{"title":"通过关联 VPC 让 AWS lambda 拥有固定出口 IP 地址","stackbit_url_path":"posts/liegp9w5to7v2hzz","date":"2023-10-03T09:14:18","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p>2023 年 7 月 25 日到 7 月 27 日，我去 AWS 公司参加了 AWS 的架构课，详见《<a href=\"https://zhuanlan.zhihu.com/p/656326003\">AWS 架构课整体回顾以及学习资源分享 - Jeff Tian的文章 - 知乎</a> 》。在学习该课程之前，我对 Serverless 用得较多，具体来说，就是对 AWS lambda 用得比较多。而对其他几乎一无所知。在三天的课程里，Serverless 只是其中一天的几个小时的内容，所以其他大多数内容，什么 VPC、Subnet、NAT、CIDR 等等对我来说都是全新的。本来觉得这些新的东西，对我来说没什么用，但没有想到今天就用到了！<br />我今天利用那天学习到的内容，解决了一个非常实际的问题，那就是让我的其中一个 <strong>lambda 函数，拥有固定的出口 IP 地址</strong>。\n<a name=WWlqY></a></p>\n<h1>非常长的前情提要：一次写作，多处发表</h1>\n<p>事情的起源是这样的：我很多年前就基于 AWS lambda，写了一个“万能 BFF”，见《<a href=\"https://zhuanlan.zhihu.com/p/646372965\">基于 AWS 构建 BFF 的架构说明 - Jeff Tian的文章 - 知乎 </a> 》。它帮我解决了很多问题，其中之一，是将我的语雀文章（是的，我一直使用语雀写文章），自动发布到知乎专栏（《<a href=\"https://zhuanlan.zhihu.com/p/551301145\">连点成线，拼凑软件 - Jeff Tian的文章 - 知乎 </a> 》）。<br />我简单说一下是怎么做的：在使用语雀会员的试用期间，我给自己语雀空间添加了两个 Webhook：一个是用来更新自己的静态站点（《<a href=\"https://zhuanlan.zhihu.com/p/359908165\">10 年前老博客以 JAM Stack 方式满血复活！ - Jeff Tian的文章 - 知乎 </a> 》），将新的文章同步上去。另一个是用来通知我的“万能 BFF”，让其再通知我的“叽歪同步助手”，将新的文章发布到知乎专栏上。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75.67567567567568%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAABwElEQVR42oWTiXKDMAxE+f/fJActFHP4tuztSMakySRTz2jsxOKx0oouhAjnA9SyYJx+MCuFWS34UQrLusE4B2NfwjnYp/BndMtuMakN3jvEGJFzBi8ikvNrUAZKwcfV7fuOcRwxTROcc0gpoZQiO0NfwXUVyXkXnbUWWmuBee8FwKsBOSmXCvsEeQKu64rr9QqlFEIIJ/As8a3CxypH/W3vjDEYhkFg2uhaMgpc9KKY++pTgA/13NrRWvMXdgLneZZkhnKiJFEGxaOPOZ/q+b6dm/oGlZIbkM1hFZJUCgY342JHWPJPD/zbQwayywxtpvDFanYovSKm+Bb4qZenKbf7XdxuvTFaw+xaynu3mklFJoBOaMfu9n0vCtdtO4abBM7jwi+c1QxjDZx34Io4h8eMRy4lgnERkYrMZ8cK6kWSRBmbAjjHriZ4X+/F4VyQiRUVeaFURBk+ASEdQE5sDvN3HVOAKQo6LbC0wtACkxb5vUcFTQohW1z6K/pLX0coAykfPayggBADYogI5LHSN76Xm0DG7Y4vdZHg/7Y4wdKO+23ANI2i1sZyKERVyMC2UyJkcKQPUWePe/swrJzf9y9YEJciEDp/oAAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/27bd575b333dd642496effe32641ba3b/fcda8/1696318471622-1191cfca-10e9-4349-9b80-f71e1938f3a1.png\"\n        srcset=\"/static/27bd575b333dd642496effe32641ba3b/12f09/1696318471622-1191cfca-10e9-4349-9b80-f71e1938f3a1.png 148w,\n/static/27bd575b333dd642496effe32641ba3b/e4a3f/1696318471622-1191cfca-10e9-4349-9b80-f71e1938f3a1.png 295w,\n/static/27bd575b333dd642496effe32641ba3b/fcda8/1696318471622-1191cfca-10e9-4349-9b80-f71e1938f3a1.png 590w,\n/static/27bd575b333dd642496effe32641ba3b/efc66/1696318471622-1191cfca-10e9-4349-9b80-f71e1938f3a1.png 885w,\n/static/27bd575b333dd642496effe32641ba3b/c83ae/1696318471622-1191cfca-10e9-4349-9b80-f71e1938f3a1.png 1180w,\n/static/27bd575b333dd642496effe32641ba3b/0ddab/1696318471622-1191cfca-10e9-4349-9b80-f71e1938f3a1.png 2220w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span><br />另外，“万能 BFF”收到语雀通知后，除了通知“叽歪同步助手”，还会发送通知给到企业微信机器人，在自己的小群里发布通知：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 216.89189189189187%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAArCAYAAAB4pah1AAAACXBIWXMAACE4AAAhOAFFljFgAAAGsElEQVR42pVW+28c1RWefwfxE+KZIgE/QAiIqhVUCAQSohKqQBUCJcFq1CZAwyM8fgKUBtRIIQ/ABgKij0RtISiOnR3bsY3XjyTeXe/u7M7jzvs9u2t/1TmzY6/rVSNGOrp3ztzz3fO493wj7do/gXv/MImHX5vC7oMy7tp3CaS7kdy57xLuOzCJX/15BrsPX8QD7/8dd49cgnTH3ku4/48lPP3+LB57a4YBCymMi/mgjuz2HJLx1LvzePjIBfzyk6+wa2QcUrHw5t9fxC0vjWPX/tzoF6/kevKE5jTeTePerQ1vfXmc5faXJ3Dbi5fZTnroVRm7Rkr49Ttl3PTiZTz53hwOf7GKAyevYt/xZYycWMGrn13H3r8u4/mjZbxwdBH3/6mE5z5cwPF/NRnkHk6ZzF5Lj7wus+t7XpvBPQdkPPrmNJ56dxqPvz2Nx94o4fG3ZDx5ZApPHJnGo4dLeOLIFB46NInfvCnjdx/9xLYPHixhz6ESdh8sQSqv6liqCSxWdKw2bVQUB9OLdaysCSxcVzG3okBeqGFmqQH5pyoWVlUsVVTMLNax2vKgiAhLVYMxlmsCkuO4cBwPtuPCD0J00gSea8P3XAS+B99zEPgu4igAPb1uBtsyUTy9bodtCYNE0k0HhulAFw4sx0ccJ3BcD4awYAgTSktFnCQwDBOu6+XfDJNBoihGknbYljFMBxJNhOWyggA7nQ5s24Fl2TAtGxQBAzkuPN9nnWU7iOMY3W4XWdZBgUEiFRNS2q6PJElgmrl3hiEYjN59P8jB+pt0Ol0GTNIMg07tAKSQDSFyDwnYEPB9vx+2QJZlCIIAqqqhrapIBwCHeBhwXppKC622CtejnOUhE5jF4do8b7XaPBKgLmxohgWlre8EDMMIjYYCVdOh6QaHTkCapqPRVNAkUVpoqxqvTbMO2pqAsF1cW61tB3S8gHOl6wZ7VniqGwJhGCIIcgmjiIvS6/UYsDghlVp9e5XJQ8oh7UwGFB4JzTc2NjDsGawyhc6AhZiWy1WjvNCYdbosadpBkmSIk3Sb0Bo/iIYXpfCSkks7FfK/74MOFDJozx62VIMTS8bFAtP2GGC1WketrrBU15q8ho0HRBBwfy5phok06yGM8/PU0m20NJM30QY8y72jg02pyYXmwiIvBzycmpnFyCv78OFHH/DuprKGyvWrWL5WgSks9pSK5XohhBOgqvloCg9N4aJhuNAYbAtUstUEJz/ej/FzJyDcDRwvLeLjU6fx1dgoPj99Cic+PYnTZz7DmTNn8OnnX+O7soaJdgTZSFAyMkyoATeFTQ9p5yAMEQcBVnQPL3wzg+W6BmyswwhpVxNRGHLToCvY1k1EUYL19fwYrdEVpMgGi6KbLmzLwZLu48JcGRtWixd7nof5+XkGoqeTdZElEXVBABsIohS11dpWoYrmkJ9BDw3dwIWFEgKrzQDj4xfx7DO/xd/+8zUiqHAjC/8uR/hHOcP5pRSjsosfrppQhbPl4Ragi4bu4MeL/4TRrjLgwsICjh07hrm5eQBdtMMK5toKyq0Yy60YFdHDj0oIxbChGxZU3SwAXZh0ZCwf1ZaNje760GuGHbevh7YXoqWJzUO/eVNIEYQxlGYDZ8+exbfffIuxsTGcO3cO58+fZwnCAN9//wOOHv0Lrl27nt/lNN1+9QYvth/GqNVqm0CTk5OoVCqo1+uoVqvccehdlmUIIRgw3tZgne2AjhfCsizMzl5hMOrMN3rS/8cpBUlRQxXC5KaapimTk24Ym2Q12Mp2UEBOoTbauoBpu9w8qb1Tt6ZGWzAg8YwwTW6wpCM6HQpIh7JoUURSxCnEbsK02JB4g0L3+8RE39ttlTclT3eEvL1j5zRK3hCXEA1Qxzb74DSnjShs0lF6shvlkGiScqX0wy5ySaREIJRTGolrhhZl2J8DGRSMRyOFSLxC4ZPXSZKitlZnHRG+fiNeLiiURdMZmDYiL+mdziPlk7pUp9sdXuWiKFRlpc+7RKPExaaVh0pVLkCpcLRJTqNbfCN5foggSuD6Ibwg4nAo8WRAfKz2janK9Dvi+QHnz/P8zRwWGDRKtLi8tMJG9Kyvr/NxGCb0bb1/qLvdHmprDVSqa+xAeXEZwrIh1RtNjE9c5o8/5yFAefoKJi7LqNbqmCxNYa3egBRSEXQDNBKpd/qScX6yoUJnj9bSfyIVLIoTLiBhSPRCfwA0kqIQ0nW6vc2/h0JIR9+o1RV/D4MY0iAQzYMwYqOZK7M4eeo0Rse+xBejoyw0Jx19ozW0dtAJAvwvf4IkIkw8gncAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/2dc4874a9b469f49cb95489f5eba03a0/fcda8/1696318728622-7ca63c2b-ed96-49bb-8db5-e21354205f7d.png\"\n        srcset=\"/static/2dc4874a9b469f49cb95489f5eba03a0/12f09/1696318728622-7ca63c2b-ed96-49bb-8db5-e21354205f7d.png 148w,\n/static/2dc4874a9b469f49cb95489f5eba03a0/e4a3f/1696318728622-7ca63c2b-ed96-49bb-8db5-e21354205f7d.png 295w,\n/static/2dc4874a9b469f49cb95489f5eba03a0/fcda8/1696318728622-7ca63c2b-ed96-49bb-8db5-e21354205f7d.png 590w,\n/static/2dc4874a9b469f49cb95489f5eba03a0/efc66/1696318728622-7ca63c2b-ed96-49bb-8db5-e21354205f7d.png 885w,\n/static/2dc4874a9b469f49cb95489f5eba03a0/d9199/1696318728622-7ca63c2b-ed96-49bb-8db5-e21354205f7d.png 960w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>总之，在语雀上写完后，会同步发布在：</p>\n<ul>\n<li>个人网站： <a href=\"https://jeff-tian.jiwai.win\">https://jeff-tian.jiwai.win</a></li>\n<li>知道专栏： <a href=\"https://www.zhihu.com/column/c_1329154484195344384\">https://www.zhihu.com/column/c_1329154484195344384</a></li>\n<li>企业微信</li>\n</ul>\n<p><a name=Y6l21></a></p>\n<h1>新需求</h1>\n<p>我希望再自动同步到一个渠道，即微信公众号里。看了一下开发文档，微信公众号有接口可以调用，这些接口都是通过 access_token 来鉴权。接口本身不难，很快就在“万能 BFF”里实现了，完整提交见： <a href=\"https://github.com/Jeff-Tian/serverless-space/commit/2f0a625a57dbc849a164f1314d8c24fa57cca398#diff-7c6e7fb3d1b35e4dbb2fa22a57d45d7788d3a97f7d5647ca607b9375219f9608\">https://github.com/Jeff-Tian/serverless-space/commit/2f0a625a57dbc849a164f1314d8c24fa57cca398#diff-7c6e7fb3d1b35e4dbb2fa22a57d45d7788d3a97f7d5647ca607b9375219f9608</a>。\n<a name=h8NhP></a></p>\n<h1>新难点</h1>\n<p>难点在于配置。为了获取微信公众号的 access_token，需要一个 appid 和 appsecret，这可以通过公众号后台的基本配置中的开发信息里获取：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 65.54054054054055%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsTAAALEwEAmpwYAAACBUlEQVR42m2RW2/iMBCF+f8PS0nscXwJ5GXfWqSqUiXU0JSEiktDof9id1sEaePcHMcVBHa72v008oPl4zNzprNYLB7CMAgmwSSchFE0fYym0zCKwjCahNHDJIymj/PF4r/V6V50v110EWAEmBDoHWGM8S+wE/RrUUo7QKBnW5QzJrjrutShQgjOOcYYAAgh7UkIoX8jhOgAIeAQJjjljAvhOI4QAgi5vr6ez+ez2Wx5Jo7jVXzg6enp+fn59va2gwn0rINzK+acDwYD20bL5VJrrZQy/9A0jTFms9l0wCGWbbdiccTzPIRwHMftu1rVjW6UUlrrtC6kKrXWxpj1en0QYwJMHMRuvz/wvIHnEULieGWM2aZyu9tud2+p/MiK7CNNijL/44wAW+jkzDlHCAEABrxZb7QpkjLZpW+v+x8fxb7QMlNpWu+ULo0xLy8vx7ZP4gMA0H4Rx6vaFFVV5nm+T/bJe5Llma51XstKFycxAnzR67VpCyEopd6x7dVqZUwjVZJWSVrt03Ivq0RW71IlSquTGDsEEdzOzDm3LIsxBgBtYFVZZTLPszyTWVGUaSozmVVVdXam0AWbnVcFAK7rIts+Ops22Ff1/v3t0f01+Vklh8tGn2cmxMbo96q4EG6/Txm7vLoKgsD3/fvxeOTfDUc3l6ObkX93Px77Yz8IguFw+AmqUUnEQhipoAAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/e488602322f6aed17fc7db3757598195/fcda8/1696319743618-068d1991-c5e4-496d-a0b9-ecde757e69b8.png\"\n        srcset=\"/static/e488602322f6aed17fc7db3757598195/12f09/1696319743618-068d1991-c5e4-496d-a0b9-ecde757e69b8.png 148w,\n/static/e488602322f6aed17fc7db3757598195/e4a3f/1696319743618-068d1991-c5e4-496d-a0b9-ecde757e69b8.png 295w,\n/static/e488602322f6aed17fc7db3757598195/fcda8/1696319743618-068d1991-c5e4-496d-a0b9-ecde757e69b8.png 590w,\n/static/e488602322f6aed17fc7db3757598195/efc66/1696319743618-068d1991-c5e4-496d-a0b9-ecde757e69b8.png 885w,\n/static/e488602322f6aed17fc7db3757598195/c83ae/1696319743618-068d1991-c5e4-496d-a0b9-ecde757e69b8.png 1180w,\n/static/e488602322f6aed17fc7db3757598195/f098e/1696319743618-068d1991-c5e4-496d-a0b9-ecde757e69b8.png 1506w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span><br />但是没完，还有下一步，必须配置 IP 白名单！否则获取 access_token 时会碰到错误。但是我的“万能 BFF”运行在 AWS lambda 上，并没有一个固定的 IP。我尝试绕过该机制：通过验证不配置、以及用 *、或者 0.0.0.0 之类的，都没有用，在获取 access_token 时都会得到一个 IP 地址不在白名单里的反馈。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.4054054054054%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABe0lEQVR42pVRa2uCUBj2/3/Ja2nefkFsf2CD7UsQ9Cl1MMjUFGqjVUO8ZT7jPc5ga23rhYej8J7nPBdOVVXIsgxNU6HrBnhBwGQyQZIkCIIAm80G+/0eu93uIrbbLdI0xWw2A2dZFmzbZqBvnufhOA5o6rrGNUMCOF3XoWkaIzRNC5Isw3NdtnA8HtE0zZ/oHvZ9v1VoWhZTRxAE8aSQCP8z3d58PgdnmCYMo4Vl21AUBY7bEgbvPm6DEeqiRl7kKIoCeZ6jLEtUVcX+CR0hU0h2e70eRFFEv9/HYDCA53lsITtkeM1eUJUVu/QbaBaLRZshNU0nWabGXafNsDk2V1lmhMPhkNk0DIMVQy1T/d9LOTQ1w0+lnCkkq6ZpMkIidz9bpvbYcnNZGeFLy12GkiSdFHYZdpPjAHV1D2V1h7dDijzNUFbl2QNRFLWWKTdSSraJeDweY71eI1pGSOIEfhTg5ukRI+8Bz+EcYRAiDEPEccywXC7Z/nQ6xQf2PhReT7FJAAAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/6f51097759bd97b9d2eeefd7d4afbfa6/fcda8/1696319595753-a3120c5d-b5bc-496a-9a80-e37f5dcfb0e6.png\"\n        srcset=\"/static/6f51097759bd97b9d2eeefd7d4afbfa6/12f09/1696319595753-a3120c5d-b5bc-496a-9a80-e37f5dcfb0e6.png 148w,\n/static/6f51097759bd97b9d2eeefd7d4afbfa6/e4a3f/1696319595753-a3120c5d-b5bc-496a-9a80-e37f5dcfb0e6.png 295w,\n/static/6f51097759bd97b9d2eeefd7d4afbfa6/fcda8/1696319595753-a3120c5d-b5bc-496a-9a80-e37f5dcfb0e6.png 590w,\n/static/6f51097759bd97b9d2eeefd7d4afbfa6/efc66/1696319595753-a3120c5d-b5bc-496a-9a80-e37f5dcfb0e6.png 885w,\n/static/6f51097759bd97b9d2eeefd7d4afbfa6/c83ae/1696319595753-a3120c5d-b5bc-496a-9a80-e37f5dcfb0e6.png 1180w,\n/static/6f51097759bd97b9d2eeefd7d4afbfa6/6f175/1696319595753-a3120c5d-b5bc-496a-9a80-e37f5dcfb0e6.png 2036w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n<a name=iVX2f></a></p>\n<h1>解决方案</h1>\n<p>无奈之下，只要寻找让 AWS lambda 拥有固定 IP 地址的方案，就找到了这篇文章： <a href=\"https://docs.aws.amazon.com/prescriptive-guidance/latest/patterns/generate-a-static-outbound-ip-address-using-a-lambda-function-amazon-vpc-and-a-serverless-architecture.html#generate-a-static-outbound-ip-address-using-a-lambda-function-amazon-vpc-and-a-serverless-architecture-prereqs\">https://docs.aws.amazon.com/prescriptive-guidance/latest/patterns/generate-a-static-outbound-ip-address-using-a-lambda-function-amazon-vpc-and-a-serverless-architecture.html</a><br />照着试了一下，用到了 VPC、子网、路由表等等，感觉又复习了一下《<a href=\"https://zhuanlan.zhihu.com/p/656326003\">AWS 架构课整体回顾以及学习资源分享 - Jeff Tian的文章 - 知乎</a> 》！里面的很多步骤，和当时上课时做的实验很像！这很令我兴奋，所以我要接合自己的实际操作，记录一下这个过程，并补充一些原文中没有的截图。\n<a name=WKrqN></a></p>\n<h2>摘要</h2>\n<p>该解决方案详述了如何使用无服务器架构生成固定的出口 IP 地址。该方案不仅让我这样的个人使用者受益，而且也能使企业使用者受益。不仅能用在对接微信服务的场景，也能用在其他场景。比如当企业间通过安全文件传输协议（SFTP）来发送文件时，接收文件的商业实体需要知道发送方的 IP 地址以便设置允许来自该 IP 的文件通过他们的防火墙。<br />该方案通过创建一个 AWS lambda 函数，并让它使用弹性 IP 地址作为出口 IP 地址。注意，弹性 IP 地址是固定不变的，我当时上架构课时被这个名称搞晕过，下意识认为弹性 IP 是一个动态 IP，因为只有动态才代表弹性嘛。老师说那就是一个名字，一旦生成是不变的。实测下来，的确如此。<br />原文中会指引如何创建 lambda，但我的“万能 BFF”里已经创建好了 lambda，因此只需要按照该文章创建 VPC，将出口流量使用静态的 IP 地址通过因特网网关即可。要使用静态 IP 地址，我需要将 Lambda 函数附加到 VPC 和相应的子网中。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.08108108108109%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAACEElEQVR42m2RaU5UQRSF3yKMCCwANiRDjNMS/GViotADPdCElhZM3Iu/jAmx2YEJSgT8Ib6xXk1v+kzVaxUTKzmpUyfn3nuqKphOT3hz/I7RcEK/02f3VYfeTpd+t8dep8d4b8B4PGEwmDAcjBkMDxjvTzk4POL10VuOpscczk4YTWa87O4TPHwxY/XBkLUnI9YeD1l/OmL90ZDlra7H6maHe9t9ljc6rGzucnery9J2nzsbOyxt9lnZ6LG83ef+8xnP9k4IQgsfv4TMvyWcfg35cB7y/vON1xxOL2LOrjLmlxmfLtt9fplydiWYXzkt9dr5zxxVQ1BYjUxjVJZQ6hyRRBgloTJQtmgKDZX9B41VUGqoW55nKUZrAm0MUZKgtEZrQ5IrYlUilEGIHCkVuTJEuSFRBamQKKUQUhMKQyoNxlrKqsL1CtwhimJvMsZQVTUNUDcNdV3TNA3aFlx8/8H1TYyQCq2U91R10/qbhqqufb1vGMcJeS69oIxFmBJjrE/sliv4jfbMgrdnt6qq+tswSVPSNPMpc6nIRO7jO0NRFP9HWVKWpefW2tZvLYHUmigVfoozSSkJw8g3d1NLrymf1hUrpf2eZhlSKc+dxzXzCZU2hHHqG0mfUBLFsf8QN9kZ3Ye5J3AF2vHFrRxcMmsLP3BxZfPnDV2qTAhEnvvdpXC4zdMFd9ptPcky/8u/ALc+FHV14uCjAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"WX20231003-150139@2x.png\"\n        title=\"WX20231003-150139@2x.png\"\n        src=\"/static/3b64994417c78e6bf11a37f1dbb96712/fcda8/1696320626672-cac463ca-fa82-454e-97fd-baa902e9851d.png\"\n        srcset=\"/static/3b64994417c78e6bf11a37f1dbb96712/12f09/1696320626672-cac463ca-fa82-454e-97fd-baa902e9851d.png 148w,\n/static/3b64994417c78e6bf11a37f1dbb96712/e4a3f/1696320626672-cac463ca-fa82-454e-97fd-baa902e9851d.png 295w,\n/static/3b64994417c78e6bf11a37f1dbb96712/fcda8/1696320626672-cac463ca-fa82-454e-97fd-baa902e9851d.png 590w,\n/static/3b64994417c78e6bf11a37f1dbb96712/efc66/1696320626672-cac463ca-fa82-454e-97fd-baa902e9851d.png 885w,\n/static/3b64994417c78e6bf11a37f1dbb96712/c83ae/1696320626672-cac463ca-fa82-454e-97fd-baa902e9851d.png 1180w,\n/static/3b64994417c78e6bf11a37f1dbb96712/24488/1696320626672-cac463ca-fa82-454e-97fd-baa902e9851d.png 2984w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n<a name=JWC3K></a></p>\n<h2>前置条件</h2>\n<p><a name=Dmag4></a></p>\n<h3>一个有效的 AWS 账号</h3>\n<p>我的是 jie_tian\n<a name=paMMS></a></p>\n<h3>创建和部署 Lambda 函数、以及来创建 VPC 和相应子网的AWS 身份与访问管理（IAM）权限。</h3>\n<p>这个我在很早前部署“万能 BFF”时已经有了，命名为 lambda-doc-rotary。<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.64864864864865%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAACB0lEQVR42nWRXU8TQRSG99dwAUIjIISCiaZo8NZ440/ESGIiYrvdfrfWQAKiV0YMH+220qVQdmc/urPbx+xsQWPiJE/mnGTmnfc9ox0cHtPePyRvVCgYZfYKOh/yOh8LRfLFkqJQLKEbZfJGWe16qUqx0kCfUijVKdc/0WgfoD3ZesXGi9es5l6yuJZjYSnH3GKWmcxjZheyzGeyzC1tMLu4wYO5Ryyvb/Jw/Rmzq8/JLOeYX3lKZm2TmZVN5rNbaG/evmN75z3bO7vUWvs0WofotRZ71X3y5TaGUWfPqCkn9VqTSqNNudHGqDapVhqUKzVq9SZ6rUm19RnNNE0Gl5eY3S53y7VDTs8vOO92Mfs9Op0O/cEAP5RIGRLKECklYSQJZYrqwxDN831czyeaRMQhiMDmi1Xi5OcJZ2fn9Pq/MHs9zP4l1yMb27G5tf+P5roewTiACBx5zZG3y6n4ijUYcjW8YjKZMJnExHFMNHWR7FEUqfpfNNu2icYwjDr8kE1ceUsgIoQrVAzf9/E8Dz8IFImQIwQ3NyNVpw/+QUuifLeOuPC/qfnFEoQnsKwrhRAC23ZwHIfRaEQQBCpaKhinQjAVBM0SI1yG9x+SuHI9j4FlqYuJu1TUvj8ThpJk9on7ROjvpQlHqCKZUyoYKYFgPFZufD9IY/s+42RO0x9N4ibIaX/Hb/vMv6Rb4suVAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/12a967e267929a9344d10371e9d6ecec/fcda8/1696320801364-866e6f7b-28cd-4fd0-b845-1c1453d02431.png\"\n        srcset=\"/static/12a967e267929a9344d10371e9d6ecec/12f09/1696320801364-866e6f7b-28cd-4fd0-b845-1c1453d02431.png 148w,\n/static/12a967e267929a9344d10371e9d6ecec/e4a3f/1696320801364-866e6f7b-28cd-4fd0-b845-1c1453d02431.png 295w,\n/static/12a967e267929a9344d10371e9d6ecec/fcda8/1696320801364-866e6f7b-28cd-4fd0-b845-1c1453d02431.png 590w,\n/static/12a967e267929a9344d10371e9d6ecec/efc66/1696320801364-866e6f7b-28cd-4fd0-b845-1c1453d02431.png 885w,\n/static/12a967e267929a9344d10371e9d6ecec/c83ae/1696320801364-866e6f7b-28cd-4fd0-b845-1c1453d02431.png 1180w,\n/static/12a967e267929a9344d10371e9d6ecec/3dfa7/1696320801364-866e6f7b-28cd-4fd0-b845-1c1453d02431.png 2028w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n<a name=c5MMJ></a></p>\n<h3>Lambda 的执行角色和用户权限配置</h3>\n<p>Lambda 是可以和 VPC 连接的，但是需要拥有相应的权限才行，否则会碰到如下错误：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0a717ca191bac1d63c61e647a598a673/e2cbf/1696321029705-6f3e4497-87f3-4abb-aeda-5ff86cb759e8.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 80.4054054054054%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAACy0lEQVR42oWTXW8bRRiF/YsKqFGaFkpIQ5FoaateccOP4fcgx4ndhLRIIBACrhCIFpLYju1udv29szuzsx/e2eRBM7UjpBoY6ei8O7Nz5rxnZ2vf//QL3/3wM4cvvqXRPGLvoMVX9X3qjQNX1w9a7Def0Wg+Y695yH7rkEbraxqHL6i3nlNvHtNoHbPXPObg6Btq2x895t5nn3P30y+4vfuYzfcfsnHnPjdufcw7G7tsbu7w7p1dbm7dY+vWDh9+8oSt3Sds3H3IB9sPuL3zgPe2H7F5/yk3tx9R63b7tLs9fv39T357ecJfZz1OOz1OOn1O2j3anT6n3T7d3ms8L3BsEQQjRsMR/cGA006X9nmPs+45NYC0WDCYCDr+FD9UBEIzjDRjmTGSObm54t9GVVVkeUae5w61xWKBUJoTb8If5z5n/ozeJOZ8HNGfSnpTSZyVbvPV1dWS39QWaZYRSUmsFLGU1MqyRCYJXjAmGE+RSYrUKbHjzLHOChZlSWkMZWkwxrhnO6wrqRQqSRycoFIJw9EEfzhmPJ0RxRIRRdeIohidpg5xLN267cw6XCtoXXT9CaeDgDNv5PK0bdoNl8vWLi8vqSyqymE13hK01tMsR+iCmcqJkhQhNdmi5L/GKs+1glmWMY8TRqF0LyRJ4sI2SzfmnzDmuraus7UO0xRjSipTYiMwLvw3tc1qhdWaRZ4X7nB78JqWM0Ih8IMhURRhlkJCCIqicI7tZqUUYSjQWrv5yph1ggtS22aaMQ+Fu1M2fNtSXizcR7Fs5/KiQEQxoYjI8sLNvSVo71YiQtL51HESzpGzqYOar3hGPJ242q7nMqJQktzeUamuBS3XyqpCzyZIb8Dc9wgvPKLgAhFcEPqeY4v5xWtCC98jmYwoxIxF8Ao9GSAT7eJQTnD5pyQ6JdH6f6FTjYgls9mY+Mcvke0jVGaQSjrBvwEpR5HJqXw+WAAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"WX20231003-142532@2x.png\"\n        title=\"WX20231003-142532@2x.png\"\n        src=\"/static/0a717ca191bac1d63c61e647a598a673/fcda8/1696321029705-6f3e4497-87f3-4abb-aeda-5ff86cb759e8.png\"\n        srcset=\"/static/0a717ca191bac1d63c61e647a598a673/12f09/1696321029705-6f3e4497-87f3-4abb-aeda-5ff86cb759e8.png 148w,\n/static/0a717ca191bac1d63c61e647a598a673/e4a3f/1696321029705-6f3e4497-87f3-4abb-aeda-5ff86cb759e8.png 295w,\n/static/0a717ca191bac1d63c61e647a598a673/fcda8/1696321029705-6f3e4497-87f3-4abb-aeda-5ff86cb759e8.png 590w,\n/static/0a717ca191bac1d63c61e647a598a673/efc66/1696321029705-6f3e4497-87f3-4abb-aeda-5ff86cb759e8.png 885w,\n/static/0a717ca191bac1d63c61e647a598a673/c83ae/1696321029705-6f3e4497-87f3-4abb-aeda-5ff86cb759e8.png 1180w,\n/static/0a717ca191bac1d63c61e647a598a673/e2cbf/1696321029705-6f3e4497-87f3-4abb-aeda-5ff86cb759e8.png 2138w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><br />AWS 允许 Lambda 函数连接到同样账号下的 VPC 中的私有子网。私有子网可以用在诸如数据库、缓存实例或者其他内部服务的资源上，所以借助 VPC 和私有子网，可以将运行着的 Lambda 函数连接到内部服务中。<br />AWS Lambda 使用了你的函数的权限来创建和管理网络接口，要连接到 VPC，你的函数的执行角色必须拥有如下权限。<br />执行角色权限：</p>\n<ul>\n<li><strong>ec2:CreateNetworkInterface</strong></li>\n<li><strong>ec2:DescribeNetworkInterfaces</strong></li>\n<li><strong>ec2:DeleteNetworkInterface</strong></li>\n</ul>\n<p>当你在配置 VPC 连接时，AWS Lambda 服务还会使用你的权限来验证网络资源，所以在配置 Lambda 连接到 VPC 时，那个操作者用户也需要拥有如下权限。<br />用户权限：</p>\n<ul>\n<li><strong>ec2:DescribeSecurityGroups</strong></li>\n<li><strong>ec2:DescribeSubnets</strong></li>\n<li><strong>ec2:DescribeVpcs</strong></li>\n</ul>\n<p>上面的截图，显示了函数的执行角色权限不够，用户（即我的账号 jie_tian）权限没有碰到问题。这是因为“万能 BFF”之前没有这个需求，没有开通这些权限，要修复，需要添加。由于“万能 BFF”使用了 serverless，因此只需要在 serverless.yml文件中添加如下内容：\nyaml\niamRoleStatements:\n- Effect: Allow\nAction:\n- ec2:CreateNetworkInterface\n- ec2:DescribeNetworkInterfaces\n- ec2:DeleteNetworkInterface\nResource: *</p>\n<p>详见提交： <a href=\"https://github.com/Jeff-Tian/serverless-space/commit/753f7aae3e59872dc14cd63be357dd87052339ad\">https://github.com/Jeff-Tian/serverless-space/commit/753f7aae3e59872dc14cd63be357dd87052339ad</a> 。\n<a name=zIDp1></a></p>\n<h2>使用 VPC 来为 Lambda 绑定静态出口 IP 地址的架构</h2>\n<p>可以用如下图表来展示这个解决方案的无服务器架构：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/79bf4109e4403d0d3daa96898d37774e/e8f1b/1696321893852-88ac343e-abda-4cc2-94d9-bbb97c00fae1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.78378378378378%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAACG0lEQVR42m2T2W7bMBRE/f+/lD4VbYEuL2njJHbiJbY2O7ZkSRR36hRk1NQFSmCIK8zVcHA5nH2df8F5h3cBqRXKaLTRqFinb0XwI8oYlJ64iY+1cw5jDCEE4pp933ymGWqejwtaJZFWoZ3GepcafAgsq3tO4kJvJMZrtDOEccSFqcf7v4JxKy85n54+cOgLqi6n6jJ63U2Cno+LG7b1M2WbJf4kjoxRcDo0uoyiSdAHh7aOiznzvNtxv9hyGHK6STD+KKygvBT8mm/Izhmv4oC17v8Oo3VtFY3MedjesSlXHPqMTrX8WYM9sy4fma/ukvtXUSXBaEYKjzEWrXWa5QxGNqeOm8WO4nKm6hvKrmawmmFQdIPkZpnzdDxQtGcOfcNJdDjnUVqyXdYoaSnLgizLmS0XD9w+7fhRCKrekHeG/UUhR8iWd+TbFd/ygW2tKDtDdlE0Bh4XS7YvG8IY0liqqmK9XjMz1iC15SQteasoOkXWSloTcHVBEDWdHclbmbjYcxQGqWISDOMIxtrrWx4ZtCNrY7NOyFpNPWjEIBFSUaVD1MQpql7jfMCPHu/Dv4JxsMpYxBWkC5wvLfP7Obe/flJ3PdJ5hHEJg3VJxAX7ntWrWw5T4u07rLMEHNlLw6FsccFgrCaO5w1vL2VkRIiBpmliwN4EYyiddVhrUxTsVMdsNeeethHJTYyF1uYKOjnb7/esVqv3zP4G88ua164bK7AAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/79bf4109e4403d0d3daa96898d37774e/fcda8/1696321893852-88ac343e-abda-4cc2-94d9-bbb97c00fae1.png\"\n        srcset=\"/static/79bf4109e4403d0d3daa96898d37774e/12f09/1696321893852-88ac343e-abda-4cc2-94d9-bbb97c00fae1.png 148w,\n/static/79bf4109e4403d0d3daa96898d37774e/e4a3f/1696321893852-88ac343e-abda-4cc2-94d9-bbb97c00fae1.png 295w,\n/static/79bf4109e4403d0d3daa96898d37774e/fcda8/1696321893852-88ac343e-abda-4cc2-94d9-bbb97c00fae1.png 590w,\n/static/79bf4109e4403d0d3daa96898d37774e/efc66/1696321893852-88ac343e-abda-4cc2-94d9-bbb97c00fae1.png 885w,\n/static/79bf4109e4403d0d3daa96898d37774e/c83ae/1696321893852-88ac343e-abda-4cc2-94d9-bbb97c00fae1.png 1180w,\n/static/79bf4109e4403d0d3daa96898d37774e/e8f1b/1696321893852-88ac343e-abda-4cc2-94d9-bbb97c00fae1.png 2246w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>以上图示展示了如下的工作流：</p>\n<ul>\n<li>③ Lambda 函数可以在私有子网 1 或者私有子网 2 中运行。调用外部服务（比如微信的 openapi）产生的出口流量离开 Lambda，到达私有子网。</li>\n<li>私有子网 1 和私有子网 2 将流量路由到公有子网中的 NAT 网关。</li>\n<li>① 在公有子网 1 中，出口流量离开 NAT 网关 1。</li>\n<li>② 在公有子网 2 中，出口流量离开 NAT 网关 2。</li>\n<li>⑤ NAT 网关（路由器）将出口流量从公有子网发送到互联网网关</li>\n<li>⑥ 出口流量从因特网网关传输到外部服务器。对于我的这种具体情况，上图中的外部服务器就是微信。</li>\n</ul>\n<p><a name=o3NNa></a></p>\n<h3>技术栈</h3>\n<p>这里用的技术栈分别是</p>\n<ul>\n<li>Lambda</li>\n<li>Amazon VPC （虚拟私有网络）</li>\n</ul>\n<p><a name=gNPy4></a></p>\n<h3>自动伸缩</h3>\n<p>为了确保高可用（HA），可以分别在不同的可用区中使用两个公有子网和两个私有子网（高可用就相当于要有备胎）。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 288px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 122.2972972972973%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAIAAAB1KUohAAAACXBIWXMAAAsTAAALEwEAmpwYAAAFJUlEQVR42h3UW1PaCAAF4PyCfWnXqVvFC5BIIEACIQnRhJAbCSFc0gTTEC7egCLUYrEude2NlrajtTPqTh9c7WX3gXZ93P+3U7/3M3NezgEoitJ13bKsTCajKIogCJlMhqIolmUFQSiVSpZliaLIcZxt26qqGobhum7nBkDTNEVRoiiyLCuKoiRLgiDQy/Qys4zj+MuXL6+urgzDqFQq0g3bttfX11ut1s+w4zgYhnW73eMPx9vb3epqVZWVXDZXypaMktFqt0ajkW3bsiyLoqhpmqIohUKh2Wy6rgvs7e2dn5+/e//u5fMX7U7b3DNgN0huk79fPn399nWpYBRLRUmS0uk0z/OO42xubvZ6vYuLi9FoBBwfH384+eA6bqO1ntrlio8K1obV3Nnqf9w9/Pfpxz9PPl9+Pjs/a7fakiQZhrG6umrb9pMnT3Z3d4HxeNzpdJzy/dKLot7MP9zeefbsxevRm8PBH+f/nL/6b3T51+XBwYGW05LJJE3THMcRBEHTtCzLQLfXffzwcaFdSG7SyTgVJ/BCsTgYDN4fvT96dbT/ebj5uvl0MHz+4nm1WkVRFEEQCIL8fj8IgkDJKK1VGplhDiaCQQgOBoMIgqiqur+/P9wfkmky0oitGlZ/t1+r1aLRKMMwyWSSIAgcxwFZklVdDVRC0Xg0Eo7QNM0wDIZhtm2Px2PTNH8Vf8vkZNet4IlEIBAIhUIoilIUJUkSIHBC5l5m0QDJBBWPxzEMIwgiFouxLLuzs9PabIJWUK8UttY2c3pO13XDMEzT1HWd53kgp+ZEMwOtItxKiktzJEmGw2EURXEcdyqO67h3M57l7Eq/16+4FV3XZVnO5/OSJHEcB2TkTDrD45sJlmfv2/dTqRTLsqFQCMMwLZtVVdWTX1B1pdVstdvtTqdTLpfr9XqlUslpOYAgCYZkIg00TIcqdsVxnHg8jiAIFsNyWY3LphdNXz6rN1vNTqfz4MGDra0tWZZhGIYgCKCSVCwcg/ngnOJNhIlao2ZaJp7Ao7GowPBLGozoUatorq2vNZvNbreradrMzMz09LTH4wFulsRHkKjP9s3jC1EoEsNi4XAYD+NRNjal3YlhMS6VymrZjY2NRr3BMAzP8zRNLy4uAiRJSrIUDARDRGS6OOtZXvQueb0B7yw9d2v9Ds7hZIwwy+b61ka9UbfKVm+n9/DRjrVq5XI5wO/3Q0tQMBD0z/l8Pu8M6/GWwUA5CKUCc4IvridS5IptlB+stWuVanur/ajTV9MKGoqKkgS4rqso6oIB/vJ4alqemcXn4GKAGJLEkCJqidmthYUWHNqPEmOa31NKr4z4XtzbhjziPE0mf9YWBTGioXe1uTlyYR5Z9IYW/CqU6OFEkbi9MnWbnb5FTXmURa1XuNc1xZ6IrIXBNEglk0C9Xi8Wi4qosAQTC2NIEAlAS+A8uOQBffM+aH7JN+v1e3wMyaxVG47lFJUiR6Vogv5Z+8uXL8fHx/VG/Z5lKqrCsixJkmgMRSIIDMN+yO8DfT7QR1JkrV5TVEWSRYZj03w6n88DV1dX19fXZ2dn47fjN2/eVKvVQqEgCMLy8jKGYTAMgyCIoqimadvb2+VyOZ/P27ZtmqbjOMDp6en19fVkMvn69eunT59OT0/Pzs4ODw8PDg72BnuiKKIoqiiK67r9fn84HI5Go8Fg0Ov1jo6Oft7Q9+/f/74xmUyub/z48WMymXz79u3k5KTZbPI8D8OwKIrVatWyrGw26zjOxcXF/1aAxAAYCWJJAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/db2226875b63ecf4f7aa6cae4382ac0a/477c9/1696322879151-a9d48354-1ada-4ae0-ba4b-21cc3862d6a2.png\"\n        srcset=\"/static/db2226875b63ecf4f7aa6cae4382ac0a/12f09/1696322879151-a9d48354-1ada-4ae0-ba4b-21cc3862d6a2.png 148w,\n/static/db2226875b63ecf4f7aa6cae4382ac0a/477c9/1696322879151-a9d48354-1ada-4ae0-ba4b-21cc3862d6a2.png 288w\"\n        sizes=\"(max-width: 288px) 100vw, 288px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span><br />这样就算是一个可用区挂了，整个架构方案仍然正常运作。\n<a name=TVrUA></a></p>\n<h2>工具链简介</h2>\n<ul>\n<li>AWS Lambda - AWS Lambda 是一种计算资源，可以在不用分配和管理服务器的情况下运行代码。Lambda 只在需要时运行（对于我的具体情况，就是只有我在语雀写了一篇文章点击发布时，才会运行），并且可以从一天只有几次请求自动伸缩到一秒几千次请求。你仅仅只需要为消费的计算时间付钱，当代码不运行时是不会产生费用的。事实上，由于 AWS 的天量免费额度，目前我的“万能 BFF”还从来没有产生过一分钱账单。</li>\n<li>Amazon VPC - 亚马逊虚拟私有网络是在 AWS 云中分配了一个逻辑隔离的分区，在这里你可以启动 AWS 资源，并运行在你自己定义的虚拟网络中。该虚拟网络和自有的数据中心里的传统网络非常近似，但是拥有更好的可伸缩性基础设施。（没想到普通个人也能拥有一个数据中心了！）</li>\n</ul>\n<p><a name=MfNCL></a></p>\n<h2>解决方案的实施步骤</h2>\n<p><a name=fneZr></a></p>\n<h3>创建一个新的 VPC</h3>\n<table>\n<thead>\n<tr>\n<th><strong>任务</strong></th>\n<th><strong>描述</strong></th>\n<th><strong>所需技能</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>创建新的 VPC。</td>\n<td>登录 AWS 管理控制台，打开 Amazon VPC 控制台，然后创建一个名为 Lambda VPC IPv4 CIDR 范围的 VPC。10.0.0.0/25</td>\n<td></td>\n</tr>\n<tr>\n<td>有关创建 VPC 的更多信息，请参阅 <a href=\"https://docs.aws.amazon.com/vpc/latest/userguide/vpc-getting-started.html#getting-started-create-vpc\">Amazon VPC 文档中的亚马逊 VPC 入门</a>。</td>\n<td>AWS 管理员</td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.27027027027027%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABqUlEQVR42nWQCWsbMRSE93c39WLv4dvx0aYkUPrTStPgrZ29JO19+SvSpg0UOjBI4unNm3nW6ctX7h++MVvumcwWfLA97mwfe+ozcRbmdBdbbH+H7W5x10f83QPe9jOr4yOr/SOb0xPL0xObwxOWN98zXZ7wN59wFgdsf8/E3eN6W+z5Dsdd46+PzJZHHG/L1FtxN98x8TX1oAOOd4+zPPDRP2IBNE3NHyRS8fPXhZfzmR/Pz1zDkCRNiOKIpm34H7q+Yxg6rDgVBNeQvCzJi4IgCHgJLkiVIYRAComUilQIsiynKAryXJ/l231kluemx1JFRZJXjE4b4jghSYX5rKFKSdmU7wlSQZaPtdvtRpKkVPXofBgGLJWNTnSxbprxQ1WZokYkFKFQfwVFVhKpkqYbTE+YKq5pRtN29H2HJaTk+hoaASOYpmRZZtwagbfI+t22rYld1++77LrO1DT13dK70C41qromlQqZlyZGXddmr1VVj01ti1IKbUKLawHDvqfve1O39HQdc7jdTNTgNeL7+coljIjihDCKiZLEiEilzHCzJjkK/8vf4YiFnB42zX4AAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/8a08a700835d23e1e906758e70390ad6/fcda8/1696323693357-dea0fa98-e244-402d-932d-7deb17fa1fad.png\"\n        srcset=\"/static/8a08a700835d23e1e906758e70390ad6/12f09/1696323693357-dea0fa98-e244-402d-932d-7deb17fa1fad.png 148w,\n/static/8a08a700835d23e1e906758e70390ad6/e4a3f/1696323693357-dea0fa98-e244-402d-932d-7deb17fa1fad.png 295w,\n/static/8a08a700835d23e1e906758e70390ad6/fcda8/1696323693357-dea0fa98-e244-402d-932d-7deb17fa1fad.png 590w,\n/static/8a08a700835d23e1e906758e70390ad6/efc66/1696323693357-dea0fa98-e244-402d-932d-7deb17fa1fad.png 885w,\n/static/8a08a700835d23e1e906758e70390ad6/c83ae/1696323693357-dea0fa98-e244-402d-932d-7deb17fa1fad.png 1180w,\n/static/8a08a700835d23e1e906758e70390ad6/d3bd3/1696323693357-dea0fa98-e244-402d-932d-7deb17fa1fad.png 2822w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n<a name=BPPQW></a></p>\n<h3>创建两个公有子网</h3>\n<table>\n<thead>\n<tr>\n<th><strong>任务</strong></th>\n<th><strong>描述</strong></th>\n<th><strong>所需技能</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>创建第一个公有子网。</td>\n<td><br />1. 在 Amazon VPC 控制台上，选择<strong>子网</strong>，然后选择<strong>创建子网</strong>。 <br />2. 对于<strong>名称标签</strong>，输入 public-one。<br />3. 对于 <strong>VPC</strong>，选择 Lambda VPC。<br />4. 选择一个可用区并进行记录。 <br />5. 对于 <strong>IPv4 CIDR 块</strong>，输入10.0.0.0/28然后选择<strong>创建</strong>子网。<br /></td>\n<td>AWS 管理员</td>\n</tr>\n<tr>\n<td>创建第二个公有子网。</td>\n<td><br />1. 在 Amazon VPC 控制台上，选择<strong>子网</strong>，然后选择<strong>创建子网</strong>。 <br />2. 对于<strong>名称标签</strong>，输入 public-two。<br />3. 对于 <strong>VPC</strong>，选择 Lambda VPC。<br />4. 选择一个可用区并进行记录。<strong>重要</strong>：您不能使用包含public-one子网的可用区。 <br />5. 对于 <strong>IPv4 CIDR 块</strong>，输入10.0.0.16/28然后选择<strong>创建</strong>子网。<br /></td>\n<td>AWS 管理员</td>\n</tr>\n</tbody>\n</table>\n<p><a name=oHkza></a></p>\n<h3>创建两个私有子网</h3>\n<table>\n<thead>\n<tr>\n<th><strong>任务</strong></th>\n<th><strong>描述</strong></th>\n<th><strong>所需技能</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>创建第一个私有子网。</td>\n<td></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<ol>\n<li>在 Amazon VPC 控制台上，选择<strong>子网</strong>，然后选择<strong>创建子网</strong>。</li>\n<li>对于<strong>名称标签</strong>，输入 private-one。</li>\n<li>对于 <strong>VPC</strong>，选择 Lambda VPC。</li>\n<li>选择包含您之前创建的public-one子网的可用区。</li>\n<li>对于 <strong>IPv4 CIDR 块</strong>，输入10.0.0.32/28然后选择<strong>创建</strong>子网。</li>\n</ol>\n<p>| AWS 管理员 |\n| 创建第二个私有子网。 |</p>\n<ol>\n<li>在 Amazon VPC 控制台上，选择<strong>子网</strong>，然后选择<strong>创建子网</strong>。</li>\n<li>对于<strong>名称标签</strong>，输入 private-two。</li>\n<li>对于 <strong>VPC</strong>，选择 Lambda VPC。</li>\n<li>选择包含您之前创建的public-two子网的相同可用区。</li>\n<li>对于 <strong>IPv4 CIDR 块</strong>，输入10.0.0.64/28然后选择<strong>创建</strong>子网。</li>\n</ol>\n<p>| AWS 管理员 |</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 30.405405405405407%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABXklEQVR42jWP627TQBSE/VYVKU1JobhNQASoVMEfnoon4hEqgSrKpSF17N2148tefNn1V8XASN/5MaMz0kQvl9ecv/3EYvWB48VrjuaXHM1XnJxeMnv+ipP5BYt4zdP4Pcdna07P3/AkfscsvmIWr3m2/MgivuZsecX8xYooSVJ+/LqnyCXbJOXm6y3f7jZstjtSoRBCIVVBJnOEkEgpEUqh8gIhFX+2CfebHQ8/b9h8+UyktaYoCoIfsG3HgyzYZjmq0hyyfVnStS1j8AzDQN/1BB8Yhh7GMHHIvA/4MBJVjSbLS9qunx6K/R5jLOM4EoLHupZEVaSVRbseVQkqU9IYR1oaRO3QtiXLBFVVE9WmpTKOgw4lSuUUxZ7/6nzgd+74LjSlDUi9m7A93ArNnTTUbkCKf4WHI6TEe0/f9zRNM011zmGdw1hHrQ21tmjraEwz8de3VJNvabRGG8Mj1+ai4z3/vlIAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/226b89315e1e1195c95c0ee555defa04/fcda8/1696323796005-1cc80cab-b1cc-4c9c-b9d8-d1d0c9b110df.png\"\n        srcset=\"/static/226b89315e1e1195c95c0ee555defa04/12f09/1696323796005-1cc80cab-b1cc-4c9c-b9d8-d1d0c9b110df.png 148w,\n/static/226b89315e1e1195c95c0ee555defa04/e4a3f/1696323796005-1cc80cab-b1cc-4c9c-b9d8-d1d0c9b110df.png 295w,\n/static/226b89315e1e1195c95c0ee555defa04/fcda8/1696323796005-1cc80cab-b1cc-4c9c-b9d8-d1d0c9b110df.png 590w,\n/static/226b89315e1e1195c95c0ee555defa04/efc66/1696323796005-1cc80cab-b1cc-4c9c-b9d8-d1d0c9b110df.png 885w,\n/static/226b89315e1e1195c95c0ee555defa04/c83ae/1696323796005-1cc80cab-b1cc-4c9c-b9d8-d1d0c9b110df.png 1180w,\n/static/226b89315e1e1195c95c0ee555defa04/38abd/1696323796005-1cc80cab-b1cc-4c9c-b9d8-d1d0c9b110df.png 2766w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n<a name=K5ujd></a></p>\n<h3>为 NAT 网关创建两个弹性 IP 地址</h3>\n<table>\n<thead>\n<tr>\n<th><strong>任务</strong></th>\n<th><strong>描述</strong></th>\n<th><strong>所需技能</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>创建第一个弹性 IP 地址。</td>\n<td><br />1. 在 Amazon VPC 控制台上，选择<strong>弹性 IP</strong>，然后选择<strong>分配新地址</strong>。<br />2. 选择<strong>分配，然后记录您新创建的弹性 IP 地址的分配 ID</strong>。<br /></td>\n<td></td>\n</tr>\n<tr>\n<td><strong>注意</strong>：此弹性 IP 地址用于您的第一个 NAT 网关。</td>\n<td>AWS 管理员</td>\n<td></td>\n</tr>\n<tr>\n<td>创建第二个弹性 IP 地址。</td>\n<td><br />1. 在 Amazon VPC 控制台上，选择<strong>弹性 IP</strong>，然后选择<strong>分配新地址</strong>。<br />2. 选择<strong>分配</strong>并记录第二个弹性 IP 地址的<strong>分配 ID</strong>。<br /></td>\n<td></td>\n</tr>\n<tr>\n<td><strong>注意</strong>：此弹性 IP 地址用于您的第二个 NAT 网关。</td>\n<td>AWS 管理员</td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.02702702702703%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAACcUlEQVR42m2RTUhUYRSG76ZVRJsIyooW6vRDEBQtgyJcmVgkUhBB0S4owhzCcma0wFQkq01BJUG0al2UGRUtoqRIzaLGMdNx7tzf7879nXvvPDG3NkEHHt5z3nMWLxzpUm6Q3qsjnL/Yx/nuXrov9NPV1Uf3hT+k01fo7sqRyw6T7btBb2aUTHaUy9lRMrmbpC8Pks4OkM4M0tM3hDQwMEr/0C0Gr9/lbG8PqY4tNHZsoflwE6kjzTR1pth+pJnmjkYaDm9kU1sDm9vXseHQRta2r2fvqQMcPXeazjMnOXbmBBKAsKy6MKtMsu9OioNju2l7sIfWsd203t/Fvtspdl5fw9ahlWwbXpWwY2Q1jddWcPxRCwPjPWTGL5F7kUEyTUFJlvE8D7Ni8urjBBMfnvPs3VNeTo4z+eM9078+8WVpiq/FGb4uTTO7OMXH/Ac+5Sd5PfOGt1OPefmwhSf39iPZto2sGrh+kKT03SqeUyXwInwvJA75f0UQVWvU6vtqBMoXKE8jua6LVbGTmziO8DwXx3XQNQXT0JJZWALPdxNMYaJqauLX78MwIAgCvBCcoIZkCsHiUhHf94lr4EcxXhjzXXGY11ycasySrKBbNvUwsmYwt7DIQrGUoBiCIAY/jHCDKpJlO8iKRhSGVKOIsmVTFg5v84LPixZqxeH7QpEFWUNzfApFmdm5nwkzPwrML8uoFZeysJHNCpJpe5QNiziqxw+RDQvZEBiWQDMFsi5QRQXFtJB1M1HNslEtG63iogiHkmGhij9e8hRdN4iiKGFe9yiUBfllLaEgG8yV9H/6wt85r7nkdZ9vqofixmhezG/wSZfDER4EtgAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"WX20231003-155817@2x.png\"\n        title=\"WX20231003-155817@2x.png\"\n        src=\"/static/75669ce106305651bc2333450d0c6726/fcda8/1696323896513-43fff320-0f95-4ec1-8c24-4d878ac7dd89.png\"\n        srcset=\"/static/75669ce106305651bc2333450d0c6726/12f09/1696323896513-43fff320-0f95-4ec1-8c24-4d878ac7dd89.png 148w,\n/static/75669ce106305651bc2333450d0c6726/e4a3f/1696323896513-43fff320-0f95-4ec1-8c24-4d878ac7dd89.png 295w,\n/static/75669ce106305651bc2333450d0c6726/fcda8/1696323896513-43fff320-0f95-4ec1-8c24-4d878ac7dd89.png 590w,\n/static/75669ce106305651bc2333450d0c6726/efc66/1696323896513-43fff320-0f95-4ec1-8c24-4d878ac7dd89.png 885w,\n/static/75669ce106305651bc2333450d0c6726/c83ae/1696323896513-43fff320-0f95-4ec1-8c24-4d878ac7dd89.png 1180w,\n/static/75669ce106305651bc2333450d0c6726/277c6/1696323896513-43fff320-0f95-4ec1-8c24-4d878ac7dd89.png 2522w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span><br />就是这两个弹性 IP 地址，我需要添加到微信后台的 IP 白名单中：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 70.94594594594594%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB9klEQVR42pWT24vaQBTG/evLPsmCmmRyMRezD4U+9n2f+rL4soWyWqgaFYuSTXNP1GS+ciaaGtht6YGPmRyGX75z5kxvMBrhw90d+vf3UHUdiqoKSYxBUpRGYv8XXc7KjKGnahpITFWFdF2HbhhwHAfuwwMmrgvHmcCZ/FuWbaOnGQY0TYMkSRgOhzAMA67rYrfbYbvdwvd9FEWBLMveVZqmKMsSs9kMPU3XBVCWZQFjjAnFcYz/jdVq1QCpTII0QFWsSZLgeDwiz3PkedGsZYkkzRDFGZI0R5bnwiHlKJbLZQMkGJXcOFWgqmrr8Hw+Iwh+IQxDxP4Br2EMP0oRRbH4IbWDRLFYLBogORqPx7AsS8BofwXyusZ+v8f+cAB/eQa+PgE7D6irtlTOedchOSOQZZmQFdYFco7j6YTqfAaiAPznBjwMRP6quq7/OKSRGZsmTNMUK42MaVkdYOvkjYvglL2caUumHo5GI3HTiqLAtp0OsKO67nyLUsMAfllg43nNHDJFwXAwEFAC0lC/B6x4LdQCOcepqro9pP6RO+od9ZMc061S1BdHok83NV9zV92UbHSANJO2bbejcBsJjmD7R3x8fXpzsNfrdVMywfr9viiX4KT5fC6eHh0ibdcbfF/9wKdvj/j88gXeJU/yPE881el0it/mq8QjxLEohAAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"WX20231003-155720@2x.png\"\n        title=\"WX20231003-155720@2x.png\"\n        src=\"/static/b618eb27c4b177a6523f0328d53769f1/fcda8/1696323912393-7c5fbd3f-a27c-4581-a0d0-0aac190ad2c8.png\"\n        srcset=\"/static/b618eb27c4b177a6523f0328d53769f1/12f09/1696323912393-7c5fbd3f-a27c-4581-a0d0-0aac190ad2c8.png 148w,\n/static/b618eb27c4b177a6523f0328d53769f1/e4a3f/1696323912393-7c5fbd3f-a27c-4581-a0d0-0aac190ad2c8.png 295w,\n/static/b618eb27c4b177a6523f0328d53769f1/fcda8/1696323912393-7c5fbd3f-a27c-4581-a0d0-0aac190ad2c8.png 590w,\n/static/b618eb27c4b177a6523f0328d53769f1/efc66/1696323912393-7c5fbd3f-a27c-4581-a0d0-0aac190ad2c8.png 885w,\n/static/b618eb27c4b177a6523f0328d53769f1/c83ae/1696323912393-7c5fbd3f-a27c-4581-a0d0-0aac190ad2c8.png 1180w,\n/static/b618eb27c4b177a6523f0328d53769f1/da893/1696323912393-7c5fbd3f-a27c-4581-a0d0-0aac190ad2c8.png 2130w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n<a name=vVboq></a></p>\n<h3>创建互联网网关</h3>\n<table>\n<thead>\n<tr>\n<th><strong>任务</strong></th>\n<th><strong>描述</strong></th>\n<th><strong>所需技能</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>创建互联网网关。</td>\n<td></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<ol>\n<li>在亚马逊 VPC 控制台上，选择<strong>互联网网关</strong>，然后选择<strong>创建互联网网关</strong>。</li>\n<li>输入名称Lambda internet gateway，然后选择<strong>创建互联网网关</strong>。确保记录互联网网关 ID。</li>\n</ol>\n<p>| AWS 管理员 |\n| 将互联网网关连接到 VPC。 | 选择刚刚创建的 Internet 网关，然后选择 <strong>Actions, Attach to VPC (操作，附加到 VPC)</strong>。 | AWS 管理员 |</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 22.972972972972975%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA8UlEQVR42lWQWW7DMAwFff8TpimaWNm8yo5ja5c8gZT2owQGJIHHR5BV2w1YveKdpZMT4tFxvDSI24OzEIjrlbbrGcax0A8Do5Qs68ryev1DzjNVFhujcc7R9T2HwxfH7x/OtaAWF5q2pc7G4lLy6Vxzu9/ZlGLdNrZfci2niaobJ7T1hBCKqGka5LKSdkgpEmMipVTqnPcUCyF4gvd4H8qs9x+PSi4bO5QmbxlHiZQStSnSnpi3CR8df7Eoy6wcq43YkHg+n4VsmKM63QeU9cQYPycohdIabQzWObTRGGvLSzIvbVDGFox1aK2Lvmi85w2Yc39+Y7wFJgAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/46b45ec1dd241369ef2722e1f5145f24/fcda8/1696323946666-0c877cf5-548b-49d2-93ad-a6594313ac35.png\"\n        srcset=\"/static/46b45ec1dd241369ef2722e1f5145f24/12f09/1696323946666-0c877cf5-548b-49d2-93ad-a6594313ac35.png 148w,\n/static/46b45ec1dd241369ef2722e1f5145f24/e4a3f/1696323946666-0c877cf5-548b-49d2-93ad-a6594313ac35.png 295w,\n/static/46b45ec1dd241369ef2722e1f5145f24/fcda8/1696323946666-0c877cf5-548b-49d2-93ad-a6594313ac35.png 590w,\n/static/46b45ec1dd241369ef2722e1f5145f24/efc66/1696323946666-0c877cf5-548b-49d2-93ad-a6594313ac35.png 885w,\n/static/46b45ec1dd241369ef2722e1f5145f24/c83ae/1696323946666-0c877cf5-548b-49d2-93ad-a6594313ac35.png 1180w,\n/static/46b45ec1dd241369ef2722e1f5145f24/7e23a/1696323946666-0c877cf5-548b-49d2-93ad-a6594313ac35.png 2850w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n<a name=fg23e></a></p>\n<h3><strong>创建两个 NAT 网关</strong></h3>\n<table>\n<thead>\n<tr>\n<th><strong>任务</strong></th>\n<th><strong>描述</strong></th>\n<th><strong>所需技能</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>创建第一个 NAT 网关。</td>\n<td><br />1. 在亚马逊 VPC 控制台上，选择 <strong>NAT 网关</strong>，然后选择<strong>创建 NAT 网关</strong>。<br />2. 输入 N nat-one AT 网关名称。<br />3. 选择public-one作为创建 NAT 网关的子网。<br />4. 对于 “<strong>连接类型</strong>”，选择 “<strong>公</strong>用”。<br />5. 对于<strong>弹性 IP 分配 ID</strong>，选择您之前创建的第一个弹性 IP 地址并将其与 NAT 网关关联。<br />6. 选择<strong>创建 NAT 网关</strong>。<br /></td>\n<td>AWS 管理员</td>\n</tr>\n<tr>\n<td>创建第二个 NAT 网关。</td>\n<td><br />1. 在亚马逊 VPC 控制台上，选择 <strong>NAT 网关</strong>，然后选择<strong>创建 NAT 网关</strong>。<br />2. 输入 N nat-two AT 网关名称。<br />3. 选择public-two作为创建 NAT 网关的子网。<br />4. 对于 “<strong>连接类型</strong>”，选择 “<strong>公</strong>用”。<br />5. 对于<strong>弹性 IP 分配 ID</strong>，选择您之前创建的第二个弹性 IP 地址并将其与 NAT 网关关联。<br />6. 选择<strong>创建 NAT 网关</strong>。<br /></td>\n<td>AWS 管理员</td>\n</tr>\n</tbody>\n</table>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 39.189189189189186%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABPUlEQVR42pWSTU7DMBCFc2BWXIV7sEUcgj0S4qdJF03S2GOP/0P60EyhQqgbLH3yeGw/z7PdWXIwxmBbC5bF4PXtHcOwx+IYta1oraHWhtqaxilnkHOQfd57hKc7HB5vMT7cID7foyNycM6htYpSKmJKSs4ZtRRFRVW4nsWrrC3nNa2h5IRSMmJM6KwlLMT43DZs2wZjLIgIbV3xcVjwsp/BqagL7xnEBMsGKWUwB5RasRsNQi4q2pHzcJ4hTSbFjghKPFLEsAT4mDUXQoSLDjYYdSOV5lJwoAjLUSvupCLhdDqpVQ5B8czw7BXn/feYNf4LMysqKDbkZGnGWhzGCeM0a2yJFCP8Gl/y9tzPxwX9sMc0H9EZeRQOKiiJXd+jHwYVuFbNNUR0mme9rm6yHpNxF8shRuXH4n+QL/UFdW5j2wrRkNoAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/b898ee529b7f8832a3455519a0eea539/fcda8/1696323979861-0d49b800-b26b-445c-8b48-05bdeb246c56.png\"\n        srcset=\"/static/b898ee529b7f8832a3455519a0eea539/12f09/1696323979861-0d49b800-b26b-445c-8b48-05bdeb246c56.png 148w,\n/static/b898ee529b7f8832a3455519a0eea539/e4a3f/1696323979861-0d49b800-b26b-445c-8b48-05bdeb246c56.png 295w,\n/static/b898ee529b7f8832a3455519a0eea539/fcda8/1696323979861-0d49b800-b26b-445c-8b48-05bdeb246c56.png 590w,\n/static/b898ee529b7f8832a3455519a0eea539/efc66/1696323979861-0d49b800-b26b-445c-8b48-05bdeb246c56.png 885w,\n/static/b898ee529b7f8832a3455519a0eea539/c83ae/1696323979861-0d49b800-b26b-445c-8b48-05bdeb246c56.png 1180w,\n/static/b898ee529b7f8832a3455519a0eea539/baf97/1696323979861-0d49b800-b26b-445c-8b48-05bdeb246c56.png 2942w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n<a name=YGgwY></a></p>\n<h3><strong>为公有子网和私有子网创建路由表</strong></h3>\n<table>\n<thead>\n<tr>\n<th><strong>任务</strong></th>\n<th><strong>描述</strong></th>\n<th><strong>所需技能</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>为 public-one 子网创建路由表。</td>\n<td></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<ol>\n<li>在 Amazon VPC 控制台上，选择<strong>路由表</strong>，然后选择<strong>创建路由表</strong>。</li>\n<li>输入public-one-subnet作为路由表名称，然后选择<strong>创建路由表</strong>。</li>\n<li>选择public-one-subnet路由表，选择<strong>编辑路由</strong>，然后选择<strong>添加路由</strong>。</li>\n<li>在 “<strong>目标</strong>” 框0.0.0.0中指定，然后在 “<strong>目标</strong>” 列表中选择 Internet 网关 ID。</li>\n<li>在<strong>子网关联</strong>选项卡上，选择<strong>编辑子网关联</strong>，选择具有 10.0.0.0/28 CIDR 范围的public-one子网，然后选择<strong>保存关联</strong>。</li>\n<li>选择 <strong>Save Changes</strong>（保存更改）。</li>\n</ol>\n<p>| AWS 管理员 |\n| 为 public-two 子网创建路由表。 |</p>\n<ol>\n<li>在 Amazon VPC 控制台上，选择<strong>路由表</strong>，然后选择<strong>创建路由表</strong>。</li>\n<li>输入public-two-subnet作为路由表名称，然后选择<strong>创建路由表</strong>。</li>\n<li>选择public-two-subnet路由表，选择<strong>编辑路由</strong>，然后选择<strong>添加路由</strong>。</li>\n<li>在 “<strong>目标</strong>” 框0.0.0.0中指定，然后在 “<strong>目标</strong>” 列表中选择 Internet 网关 ID。</li>\n<li>在<strong>子网关联</strong>选项卡上，选择<strong>编辑子网关联</strong>，选择具有 10.0.0.16/28 CIDR 范围的public-two子网，然后选择<strong>保存关联</strong>。</li>\n<li>选择 <strong>Save Changes</strong>（保存更改）。</li>\n</ol>\n<p>| AWS 管理员 |\n| 为私有子网创建路由表。 |</p>\n<ol>\n<li>在 Amazon VPC 控制台上，选择<strong>路由表</strong>，然后选择<strong>创建路由表</strong>。</li>\n<li>输入private-one-subnet作为路由表名称，然后选择<strong>创建路由表</strong>。</li>\n<li>选择private-one-subnet路由表，选择<strong>编辑路由</strong>，然后选择<strong>添加路由</strong>。</li>\n<li>0.0.0.0在<strong>目标</strong>框中指定，然后在<strong>目标</strong>列表的public-one子网中选择 NAT 网关。</li>\n<li>在<strong>子网关联</strong>选项卡上，选择<strong>编辑子网关联</strong>，选择具有 10.0.0.32/28 CIDR 范围的private-one子网，然后选择<strong>保存关联</strong>。</li>\n<li>选择 <strong>Save Changes</strong>（保存更改）。</li>\n</ol>\n<p>| AWS 管理员 |\n| 为私有二子网创建路由表。 |</p>\n<ol>\n<li>在 Amazon VPC 控制台上，选择<strong>路由表</strong>，然后选择<strong>创建路由表</strong>。</li>\n<li>输入private-two-subnet作为路由表名称，然后选择<strong>创建路由表</strong>。</li>\n<li>选择private-two-subnet路由表，选择<strong>编辑路由</strong>，然后选择<strong>添加路由</strong>。</li>\n<li>0.0.0.0在<strong>目标</strong>框中指定，然后在<strong>目标</strong>列表的public-two子网中选择 NAT 网关。</li>\n<li>在<strong>子网关联</strong>选项卡上，选择<strong>编辑子网关联</strong>，选择具有 10.0.0.64/28 CIDR 范围的private-two子网，然后选择<strong>保存关联</strong>。</li>\n<li>选择 <strong>Save Changes</strong>（保存更改）。</li>\n</ol>\n<p>| AWS 管理员 |</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.13513513513513%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABPElEQVR42k2R7XKDIBAAff/3a3+ZNE2TqkEUleNDwe1I0mmZ2eHu4HaGowohYMyE956cVqy1nE5nzucPOj2iJiF4jw+B4673L8KL48wHYoyFSg8Dn9cb82RIYUJ85NIo6mvDe33hrb5w7w0iju6hmOeZdV2LPIRY4oOUtrJXixVGY0oS1w3nA/040Tx6hmnBLBYJsQh6PXBrOsZpJsSIOMej16h+oFMaK0JlxrE0q3GGPZNyxonQti1d25VnlLXvuLjxoRbOytJOgS0lvrQttbqbkbBSqcnypRf2ZxvblookvOaTUiLvexH6NRXR3Xi6OZBzLjX3YkuZyjqP0gZrpQgPgXOOpmm537+L9HdJTJyUUCvhZjwp70V+0Y7r4HAxUY2jQWuNc8/GY5bHbAoiuPKLT45Y3B+/uf2X/wCDhhs26zHocQAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/d031b03cef1c076389695f3a2829b79a/fcda8/1696324048846-1de58362-6598-4253-8377-28e4d4445061.png\"\n        srcset=\"/static/d031b03cef1c076389695f3a2829b79a/12f09/1696324048846-1de58362-6598-4253-8377-28e4d4445061.png 148w,\n/static/d031b03cef1c076389695f3a2829b79a/e4a3f/1696324048846-1de58362-6598-4253-8377-28e4d4445061.png 295w,\n/static/d031b03cef1c076389695f3a2829b79a/fcda8/1696324048846-1de58362-6598-4253-8377-28e4d4445061.png 590w,\n/static/d031b03cef1c076389695f3a2829b79a/efc66/1696324048846-1de58362-6598-4253-8377-28e4d4445061.png 885w,\n/static/d031b03cef1c076389695f3a2829b79a/c83ae/1696324048846-1de58362-6598-4253-8377-28e4d4445061.png 1180w,\n/static/d031b03cef1c076389695f3a2829b79a/6297e/1696324048846-1de58362-6598-4253-8377-28e4d4445061.png 2044w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n<a name=pVieG></a></p>\n<h3>创建 Lambda 函数，将其添加到 VPC，然后测试解决方案</h3>\n<table>\n<thead>\n<tr>\n<th><strong>任务</strong></th>\n<th><strong>描述</strong></th>\n<th><strong>所需技能</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>新建 Lambda 函数。</td>\n<td><br />1. 打开 AWS Lambda 控制台并选择<strong>创建函数</strong>。<br />2. 在 “<strong>基本信息</strong>” Lambda test 下，在 “<strong>函数名称</strong>” 下输入，然后在 “<strong>运行时</strong>” 下选择您选择的语言。<br />3. 选择 <strong>Create function (创建函数)</strong>。<br /></td>\n<td>AWS 管理员</td>\n</tr>\n<tr>\n<td>将 Lambda 函数添加到您的 VPC。</td>\n<td><br />1. 在 AWS Lambda 控制台上，选择<strong>函</strong>数，然后选择您之前创建的函数。 <br />2. 选择 <strong>Configuration</strong>（配置），然后选择 <strong>VPC</strong>。<br />3. 选择<strong>编辑</strong>，Lambda VPC然后选择两个私有子网。<br />4. 选择 “用于测试目的的<strong>默认安全组</strong>”，然后选择 “<strong>保存</strong>”。<br /></td>\n<td>AWS 管理员</td>\n</tr>\n<tr>\n<td>编写调用外部服务的代码。</td>\n<td><br />1. 使用您选择的编程语言，编写代码来调用返回您的 IP 地址的外部服务。<br />2. 验证返回的 IP 地址是否与您的一个弹性 IP 地址相匹配。<br /></td>\n<td>AWS 管理员</td>\n</tr>\n</tbody>\n</table>\n<p>对于我的具体场景，我不需要再额外创建 Lambda 函数，也不需要编写额外的代码，仅需要将 Lambda 函数连接到 VPC 即可。见最开始的截图所示，最后成功连接后是这样：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.08108108108109%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB5UlEQVR42mVQ227TQBD1TwBpK56p+B8cFanAJ/DEA0KksRM3BqskhAj4G14KldJ+AjSqUiEI9dp7m5ndtRfWkRASR0ej2dHMnpkTvZku5ouPk0kxGo6OBkk6SMfJaJyk+TjL8yLLiuPsVTYp8tfT4uTtbPZ+ejKfLT7kxbsXSR4dPp/dfZjdezzZf3R8/0m2f5jt9Ie7/eFefLRzkPbi4V48uN1PegfprfhlLx7txsmdfvrg2expOo++c/qyYsur6mxVnq6qT1/Z58vy9NvN2VV9sRbLjhdrcb4WF9fyfM2XHVelZtpGllCLCgRvUFc3Gy25d+gddUTfGN9QiI687eqNaS1KXiPoCJHKqtYAAFhLqMEJjVxIpbUGrBRyMFIBIEiNTKIAIjLWOkCMiKgsGWiNiM45733b+rZtvfeAdHn9Y/2TCam1Um3rbdNa17Rt45oGESMkYlUlpUREhcS1QUQADL9437R/4f+Fcw6JgnJd15wLHQBKA5HZbmadM9Z2SRcbt62QCQJhWAOWtfDeG2uVUuEEABfanFIaEI0xAGCMEUIAhKe1lojCMCCWFVcqOCSl3Gx+cSHIGDJGaY1EiBTMJGKsYlWF3VIQpLeGMaZ08JsLIZUSUnIh/qcMCmqb15z/cfs3Wnk6IgHibwgAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/32dbd0fce7d192c2732fc6397566cb01/fcda8/1696324217038-fe55d61e-c2b4-47eb-80d8-bad5b21b5d46.png\"\n        srcset=\"/static/32dbd0fce7d192c2732fc6397566cb01/12f09/1696324217038-fe55d61e-c2b4-47eb-80d8-bad5b21b5d46.png 148w,\n/static/32dbd0fce7d192c2732fc6397566cb01/e4a3f/1696324217038-fe55d61e-c2b4-47eb-80d8-bad5b21b5d46.png 295w,\n/static/32dbd0fce7d192c2732fc6397566cb01/fcda8/1696324217038-fe55d61e-c2b4-47eb-80d8-bad5b21b5d46.png 590w,\n/static/32dbd0fce7d192c2732fc6397566cb01/efc66/1696324217038-fe55d61e-c2b4-47eb-80d8-bad5b21b5d46.png 885w,\n/static/32dbd0fce7d192c2732fc6397566cb01/c83ae/1696324217038-fe55d61e-c2b4-47eb-80d8-bad5b21b5d46.png 1180w,\n/static/32dbd0fce7d192c2732fc6397566cb01/f098e/1696324217038-fe55d61e-c2b4-47eb-80d8-bad5b21b5d46.png 1506w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span><br />完成之后，我只需要发布一篇语雀博文，就会自动出现在我的公众号里。\n<a name=qIyPT></a></p>\n<h1>方案验证</h1>\n<p>我现在就要写完这篇语雀博文了，在我点击发布之后，如果在公众号里也看到它，就说明这个方案完美运行了！<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/15dec28457ea74f0eff8f76065b468aa/319c6/1696324419006-248cf844-68e4-4884-aa5e-a2a0924ab3ca.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 64.1891891891892%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAACOklEQVR42o2S308TQRDH7z9Wgr75YNCEBxLjgwFNJPHFN/8C0SgiEGgrtiJi0YJI6F0tR+9u7/fufszs2aIxMU4y2ZnZ3e/Md2a89fYub9sddjptdtvbtFtv6HXW+bT3mi/dVwx6LznuvuD4/XO+fVjn5OMWg/0t+t1Neq0N3rW26O62WFp7wv21Z3gGAxaMMWht0I0rUXdObW0buzZgbHOKL5JzwRFdasArioLAP0fFEybhmDSZkKmIeBKSRKGzRaNJSKoUaaqI4wilEqqy5jIZcxBvoMsKXdZ4wWjMraVV5u+uMH9nmWu3HzC3sMz1hRXm7j7ixuJjbi6ucu/hU6Io5g+xcBhtk9axo6GNxqtrzd7hKdu9AZvdATv7J7QPTtn7fEbn8LuzWwen9E/OXVustMc2fH/oY87iI0x1lcOz1lJXBZj6t8yGvCixLmZnMXlrf/nKXDDSX9EV+P6QIAjIsqwBjOIYpVKyvKAsK6q6Js1yyqqi1tqpxK1UJoOxFb4+agaS5yRJ4sBkHp7QUKk4pQPOHWhJVVXugVKKoizJi8JVKCJUS5s1lSpFGIZXlI21pFlGomR6MXGSzM40Td2daF7k7kNkApRpACSBJBe6Aiy+J5UMh0MHIuWLCpBQmFY0ldwmRMafgYnI/2A0coBa62YP+/0+4/HYZRMwiQmgcnuXuh4VZUFqL5s+2gbQYN073/cZjUaOpRuKqKD/S43RV0tg7QxUipi+EdsN5X9lmrzZafvXvbTrJ/Qf3CO29yi5AAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/15dec28457ea74f0eff8f76065b468aa/fcda8/1696324419006-248cf844-68e4-4884-aa5e-a2a0924ab3ca.png\"\n        srcset=\"/static/15dec28457ea74f0eff8f76065b468aa/12f09/1696324419006-248cf844-68e4-4884-aa5e-a2a0924ab3ca.png 148w,\n/static/15dec28457ea74f0eff8f76065b468aa/e4a3f/1696324419006-248cf844-68e4-4884-aa5e-a2a0924ab3ca.png 295w,\n/static/15dec28457ea74f0eff8f76065b468aa/fcda8/1696324419006-248cf844-68e4-4884-aa5e-a2a0924ab3ca.png 590w,\n/static/15dec28457ea74f0eff8f76065b468aa/efc66/1696324419006-248cf844-68e4-4884-aa5e-a2a0924ab3ca.png 885w,\n/static/15dec28457ea74f0eff8f76065b468aa/c83ae/1696324419006-248cf844-68e4-4884-aa5e-a2a0924ab3ca.png 1180w,\n/static/15dec28457ea74f0eff8f76065b468aa/319c6/1696324419006-248cf844-68e4-4884-aa5e-a2a0924ab3ca.png 2980w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><a name=zZVc6></a></p>\n<h1>后续</h1>\n<p>好吧，一波三折，事实上并没有那么顺利。第一次测试，我应该写一篇短文才好，这么长一篇文章，导致超过了 Express 默认的 100kb 载荷限制了。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 41.21621621621622%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABmklEQVR42nWQ2W7TUBRF/adITdJU4AQhVBepj4h/YSix4wwmRTzwFUgghlI7nmc79UC80HVCpT5wpK19zr66+wyScvmS55evGE8VBmdPeTSSOTmdMjibcjKeMH7yjNOpwvDxOSP5nIGsMJQvGE4URvIFo2M9EPnkBdLVlc6b2Qrj+jP68iO68QlNM1D1NdrCYLXaoC43aPM16nyBtr5mphu805ao8w+o2orZYsNbdc3r9zoSQNs0PIzuyPuHdben6zroOv4XUlGU5HlBVdVkeU4Yx/wyHX7cOvw0XW4sj++/bRzXw/N9HM/DD0KSNCVOBBLi9MBCk6q6pmna3r3c7cjygm9mxJebkK9WcoAZEyYZeVH0EI2zLO9Z/BHYHVmqqzv2bXNvWJYlcRQSRwFJHFEWGb7vEgQBjuvieT6umNIPSNOUpm0RQwnUdY1U7Qp2RXYwLMu+q7W1Ma0ttuMQxQm3psVWaKbVQ+Rb2+5PkKbZwaxpeu5Xbts/9xOKlUR31/MJwpA0y/raD4J+OmEi3oQmaqH/O8NdVfEXV703fH4WOYcAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/9e8cecc95fa49bcb6d52ee6c16c4ddb1/fcda8/1696326160423-2f3a6661-00dd-457c-b9c1-d7b2d3905bf3.png\"\n        srcset=\"/static/9e8cecc95fa49bcb6d52ee6c16c4ddb1/12f09/1696326160423-2f3a6661-00dd-457c-b9c1-d7b2d3905bf3.png 148w,\n/static/9e8cecc95fa49bcb6d52ee6c16c4ddb1/e4a3f/1696326160423-2f3a6661-00dd-457c-b9c1-d7b2d3905bf3.png 295w,\n/static/9e8cecc95fa49bcb6d52ee6c16c4ddb1/fcda8/1696326160423-2f3a6661-00dd-457c-b9c1-d7b2d3905bf3.png 590w,\n/static/9e8cecc95fa49bcb6d52ee6c16c4ddb1/efc66/1696326160423-2f3a6661-00dd-457c-b9c1-d7b2d3905bf3.png 885w,\n/static/9e8cecc95fa49bcb6d52ee6c16c4ddb1/c83ae/1696326160423-2f3a6661-00dd-457c-b9c1-d7b2d3905bf3.png 1180w,\n/static/9e8cecc95fa49bcb6d52ee6c16c4ddb1/15e60/1696326160423-2f3a6661-00dd-457c-b9c1-d7b2d3905bf3.png 3034w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span><br />由于“万能 BFF”使用了 NestJs，并且底层 HTTP 框架是 Express Js，要让本篇长文通过这个测试，需要加大载荷限制。一篇长文，写了几个小时写完了，本以为就成功了，没想到最后碰到了一个“小”问题，花了额外的几倍时间才解决。\n<a name=yPz2T></a></p>\n<h2>暴露根因</h2>\n<p>首先，这个限制到底是多少？通过《<a href=\"https://zhuanlan.zhihu.com/p/642937928\">ChatGPT 教我如何修改 node_modules 里的代码 - Jeff Tian的文章 - 知乎 </a> 》介绍的方法，我用 postinstall 魔改了 raw-body，让它对外抛出这个限制数字，发现是 102400。\njavascript\nconst fs = require(fs);</p>\n<p>function patchFile(patch) {\nfs.readFile(patch, utf8, (err, data) => {\nif (err) {\nconsole.error(err);\nreturn;\n}</p>\n<pre><code>    const modifiedData = data.replace(\n        /returns+done(createError(413,s+requests+entitys+toos+large,s+{/g,\n        return done(createError(413, request entity too large:  + length + > + limit, {\n    );\n\n    fs.writeFile(patch, modifiedData, utf8, (err) => {\n        if (err) {\n            console.error(err);\n            return;\n        }\n\n        console.log(File modified successfully!  + patch);\n    });\n});\n</code></pre>\n<p>}</p>\n<p>patchFile(node_modules/raw-body/index.js);\npatchFile(node_modules/@nestjs/platform-express/node_modules/raw-body/index.js);</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/09d59f1d6c4de881be2963f95446fb55/a1ccc/1696339508370-9ec8e3e5-dc58-4681-ad0b-221722b62f4d.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.16216216216216%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABKElEQVR42k1Q2XKDMBDjR5LUXAZs4xMC5Hjp/3+TOlrSaR80q91Zy9JWF9VjdAmx7PB5w2gjbFjgwoo53RGXQ3py/0FaDgTup014rR3qsKGOO6pbM2CaszzkEsUp8CvCj4wvcHFFKAfi+pA97tNAyBvayaNJO9p8oLoqjW6YMdqEwUbh/TiLcD95aBOgpyAzlx/w2zeuqgeN3GpC49aOUCZCmYTqWmtxULYn0voQbv2Csr3EBSvnBN3SneomEftqxrP2Fm15oi2vMzKdzXGVmOR0dAqXM75fYOYsoPO6NyJKQUJ1Bo1fBdVFaYlGgcll4Yw3uSSPOT/FivS8N9Fo+4k8nJFtgXKFDkc5+Lq/JTY5RTIj/otc7k+Z5fvfaeTuJkBph259C34AKP3XPE6OtRUAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"WX20231003-192011@2x.png\"\n        title=\"WX20231003-192011@2x.png\"\n        src=\"/static/09d59f1d6c4de881be2963f95446fb55/fcda8/1696339508370-9ec8e3e5-dc58-4681-ad0b-221722b62f4d.png\"\n        srcset=\"/static/09d59f1d6c4de881be2963f95446fb55/12f09/1696339508370-9ec8e3e5-dc58-4681-ad0b-221722b62f4d.png 148w,\n/static/09d59f1d6c4de881be2963f95446fb55/e4a3f/1696339508370-9ec8e3e5-dc58-4681-ad0b-221722b62f4d.png 295w,\n/static/09d59f1d6c4de881be2963f95446fb55/fcda8/1696339508370-9ec8e3e5-dc58-4681-ad0b-221722b62f4d.png 590w,\n/static/09d59f1d6c4de881be2963f95446fb55/efc66/1696339508370-9ec8e3e5-dc58-4681-ad0b-221722b62f4d.png 885w,\n/static/09d59f1d6c4de881be2963f95446fb55/c83ae/1696339508370-9ec8e3e5-dc58-4681-ad0b-221722b62f4d.png 1180w,\n/static/09d59f1d6c4de881be2963f95446fb55/a1ccc/1696339508370-9ec8e3e5-dc58-4681-ad0b-221722b62f4d.png 2776w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>这个问题最根本的原因在于 body-parser 这个底层库，对 request body 默认限制了 102400 字节的大小，而且用了一个闭包技术读取配置的 limit，造成上层框架很难改掉这个默认 limit。<br />个人觉得这个 body-parser 实在太多事了，干嘛写这个限制？如果应用开发者想要限制，可以在网关层限制。做为 parser，就应该无脑 parse 就行。吐槽完毕，下面还是需要找个解决办法。由于各种传递 {limit: 10mb}等解决方案均不工作，最后不得已禁用了 bodyParser：\ndiff\nconst app = await NestFactory.create(AppModule, {\nlogger: [error, warn, log],\nsnapshot: true,</p>\n<ul>\n<li>\n<pre><code>   bodyParser: false,\n</code></pre>\n});</li>\n</ul>\n<p>然后，从 @Body 得到的 Buffer 自己完成 JSON 解析，完整提交见： <a href=\"https://github.com/Jeff-Tian/serverless-space/commit/6abd87a8f1612f9f9e7264fc571951671abc88b3\">https://github.com/Jeff-Tian/serverless-space/commit/6abd87a8f1612f9f9e7264fc571951671abc88b3</a> <br />等待 CICD 完成，再次发布测试。</p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}}}},"staticQueryHashes":[],"slicesMap":{}}