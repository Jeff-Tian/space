{"componentChunkName":"component---src-templates-post-js","path":"/posts/fg3fl7rfp97syxg3/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/fg3fl7rfp97syxg3","relativePath":"posts/fg3fl7rfp97syxg3","frontmatter":{"title":"令牌交换流程初体验","stackbit_url_path":"posts/fg3fl7rfp97syxg3","date":"2023-04-24T11:45:34","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p>有时候，会注意到在使用某些 App 时，明明已经登录了，但是打开了某个页面时，却要求再登录一次。这其实是因为该页面是一个 Web View。甚至，有时候会遇到明明在这个 Web View 里已经再次登录了，下次打开另一个页面（另一个 Web View）时，又要求登录。这是由于在手机上，使用了某些 Web View（如 WKWebView），而这个 WebView 在登录后，其登录信息保存在 ASWebAuthenticationSession 中，它既不能在 App 和 WebView 之间共享，也不能在多个不同的 WebView 实例间共享。更多信息，可以参考： <a href=\"https://learn.microsoft.com/en-us/azure/active-directory/develop/customize-webviews#in-app-browser\">https://learn.microsoft.com/en-us/azure/active-directory/develop/customize-webviews#in-app-browser</a> 和 <a href=\"https://developer.apple.com/documentation/authenticationservices/aswebauthenticationsession?language=objc\">https://developer.apple.com/documentation/authenticationservices/aswebauthenticationsession?language=objc</a>。\n<a name=Fcl0C></a></p>\n<h1>NONCE 模式</h1>\n<p>参考《<a href=\"https://zhuanlan.zhihu.com/p/446314134\">webview 复用微信小程序获取用户信息的解决方案 - Jeff Tian的文章 - 知乎 </a> 》，可以通过 authCode 方案解决（本质上，这是一个 OAuth 中的一个 NONCE 模式），其时序图如下：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.83783783783784%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsTAAALEwEAmpwYAAABv0lEQVR42m2Sy24UMRBF+19Z8UfZwYJsI5YgJJagsA1kmAliRjDut9t2+1F+lG3UbqYZRZyFVZJ1S8euqqyP2H1G+hDoV7d77etPYraCq5TyNcbYvp+c8zlnxua+Z0Koqu6m9ssN/Xanj+/5x5fy8fZMWF0PWyyVNoyJ/f6kNeScCen2+1NdDxWlY8/0yBWXIGyyGBG9UtJaCwDGGOfc2iJdyax1NQxD37dD3wnBHegUg/Oecz5fkFJqraWUzjkseO9DwJRyZYzZGscY11MpBQDee1ewBSGEUsoYo5Tyfnn83zBjrG1bQsjpdCKESCkBIISQrogxPtcGAESUUnrvp2k6HA7H47EvCCGK4cJa/D/MOffeA4AoTAVr7eYMANZaRAwhrK/7F3bOxRidc0IIKeX6VVrrzTnnrJTSWhtjNoUSDp6QMzmfJzqAWa5XNueLNq6ZGCMippSWcECEsjrKYkfnYejGcRBiXrVXiu0yJGttCB5xaVRRbuTDK/79rf75jn14oXdvmm5uGnr1N7mMQx4Ovy4b1j89/W6asQIXY38f2WNkO/xxG9p7OqmJ8me7rTU0zWjtsm3TNLftyLn8AyEQ5/+akUrdAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/bff1933d1acc314d1e1f26312d5649ea/fcda8/1682335965700-217350e2-b6dd-447a-90bc-4b601823faac.png\"\n        srcset=\"/static/bff1933d1acc314d1e1f26312d5649ea/12f09/1682335965700-217350e2-b6dd-447a-90bc-4b601823faac.png 148w,\n/static/bff1933d1acc314d1e1f26312d5649ea/e4a3f/1682335965700-217350e2-b6dd-447a-90bc-4b601823faac.png 295w,\n/static/bff1933d1acc314d1e1f26312d5649ea/fcda8/1682335965700-217350e2-b6dd-447a-90bc-4b601823faac.png 590w,\n/static/bff1933d1acc314d1e1f26312d5649ea/efc66/1682335965700-217350e2-b6dd-447a-90bc-4b601823faac.png 885w,\n/static/bff1933d1acc314d1e1f26312d5649ea/c83ae/1682335965700-217350e2-b6dd-447a-90bc-4b601823faac.png 1180w,\n/static/bff1933d1acc314d1e1f26312d5649ea/b67f3/1682335965700-217350e2-b6dd-447a-90bc-4b601823faac.png 1338w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>除了这个方案，也可以利用 OAuth 2.0 中的令牌交换流程来解决这个共享会话的问题。\n<a name=j9BsZ></a></p>\n<h1>令牌交换流程</h1>\n<p>详见： <a href=\"https://datatracker.ietf.org/doc/html/rfc8693\">https://datatracker.ietf.org/doc/html/rfc8693</a>，该流程可以使用一个客户端拿到的令牌，去换取另一个客户端的令牌。这一般可以用在委托目的，但不局限于此。比如，还可以用这个流程来改善 WebView 中的单点登录体验。</p>\n<p><a name=uKDRX></a></p>\n<h1>令牌交换流程在 Duende IdentityServer 中的一个实现</h1>\n<p><a name=FUoQe></a></p>\n<h2>在线体验</h2>\n<p>令牌交换，需要先得到一个令牌。可以利用昨天的《<a href=\"https://zhuanlan.zhihu.com/p/624224224\">我又做了一个网页版的设备码授权许可登录流程 - Jeff Tian的文章 - 知乎 </a> 》获取一个身份令牌。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50.67567567567568%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAACSUlEQVR42p2RWUsbYRSG50+2FG2x9rbgHyh4YZVqqzWLWmnRUmpat1jBIipGNK4kmm3UmSSjMbuaxCwuk8k3yVMMIpTe9cDD+3LOzXnPkXp63vHk6TNan7+g7WU7LS2tfOgfYHT0MyMjo9jtwwxarA/YsFhsj2qx2hi02rHY7NiHRxgb+4qkqipdXV1093Qz8HGA/v5+hCn435IOPAd0vO6g800nQ9Yh2ttekU1dNIcNAQ1dcHfs4aYQp5aJI07CCMNA1OuImIYIehGxCCJyhLiuIHlkD+PT40z9nsK57GRi7jvpSpRLoiTMIFlTJW9EKZtpzLoOpvm4zW29QKPxdxppLexiMbLIirbMkraMP7+PVt3lQj/julrkxihjGDWEUadWE9SEoGpUEYZJ/FbmWi+j31W5vbtD13WkeCyBHDgkqmgkThNoqsZZNIkWOUU5VgmrEe7vrKoKyj2KQigoIytB/Jk18vk8l5eXnJ+fk8vlkSrlInWzRql0RTKZIF/Ikc4kqVTKlIpXXFfKXBUKlIpFCvkctZrRjKZTJMXBv08JhRN45BMWd8P8XJVxbqg43WHmt7Wmn3OHmV1XmFk7aqrTrTK/GWVmQ8HhCjDpOmZ6XWXWHcW5qSF9mtvj7biL3olN3v/YadLn2Gpq78QWfY5t+h76gzNerHM+bL+CfFnwM+OSmVwJMLUawrHk49vCHlJAVvD6D9kPHLLr9Tf9jseH1y/j8YXY2w80CR6FiSWynCYyRGMpkqkMuYss2UyKi2yGbDpF6arAH+FBsGc6z2pUAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/f0776424d69f1743ae17d73caffc55da/fcda8/1682336390574-2d691d7d-3259-4c6b-97f8-5bd6769e3336.png\"\n        srcset=\"/static/f0776424d69f1743ae17d73caffc55da/12f09/1682336390574-2d691d7d-3259-4c6b-97f8-5bd6769e3336.png 148w,\n/static/f0776424d69f1743ae17d73caffc55da/e4a3f/1682336390574-2d691d7d-3259-4c6b-97f8-5bd6769e3336.png 295w,\n/static/f0776424d69f1743ae17d73caffc55da/fcda8/1682336390574-2d691d7d-3259-4c6b-97f8-5bd6769e3336.png 590w,\n/static/f0776424d69f1743ae17d73caffc55da/efc66/1682336390574-2d691d7d-3259-4c6b-97f8-5bd6769e3336.png 885w,\n/static/f0776424d69f1743ae17d73caffc55da/c83ae/1682336390574-2d691d7d-3259-4c6b-97f8-5bd6769e3336.png 1180w,\n/static/f0776424d69f1743ae17d73caffc55da/0f96c/1682336390574-2d691d7d-3259-4c6b-97f8-5bd6769e3336.png 2248w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>然后，打开 <a href=\"https://id6.azurewebsites.net/token-exchange-flow.html?lang=en-US\">https://id6.azurewebsites.net/token-exchange-flow.html?lang=en-US</a>，将上一步的身份令牌粘贴进去后，点击登录，即可获取到新的访问令牌：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 59.45945945945946%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAACbklEQVR42nWT2W/TShSH/e+jC4Wy6QqBBBTeAN1XtjfSbPW+hTiLszixYzdOnKVtks6HPCnwdEf6dH5nfHzmjPWzcv/+Cff+OeHF24+8++87bz98OfLxC2efvnL26RtvPnzm8fOXPHj4hJNHzzg5fcqD06cyPnz0jNMn//Ly1WvOzt6jjEYj+v0e8TRiEg2JxkOi0YBkGknGo/CYxzFZljKJxuyvDvzfUnRdp16vU6vXaTYv0DQdVVVpNpvUajV+/Kigqhplne3YGLpJvf+VcKeS7AbcDNrsWzb7ZMLhMkWxHYdGo0Gj2cC0TCzbwjANPN9jOBxKokkkJ0zTlCRJiBcjrkXBjgOiZULlG6LbQswzFEPXMTQN3/JxDRdbtzFVE0uz8GwP13JxHZefQYD/s00QBCzmy793zC8RWSylKK/c8X2GvR69XKWbNwjnBuPcZboImC1CssWYYpGyHfRYBy02yZTt1RVCCBBCNhGy21Er7SAgTTPWZORELIkpSCiYsSKV7MQGshkkEWzX3L3/p5n43VgIlPju2yzzFXm2ZL3cSP2b/HJJsVwdp7hbcrowAN9GdH2IQkTHg5trlDzP2W63xEnMNJ4yn18yS2fk+ZzysFLv9zvE7e1fyvb7WzY3KcX1BLE7wH7H7eGA0m63cV0Xz/MwTVNq3/exbRvHcTAMA8uyJK1WS+4f92wMR0c1NBzXxfU8wjBE0TSNarUqvVh6r9Tn5+cyLw8oLVX6sowXFxeSSqUi66rVmvRu+bwcrLSU/FPG4zH9fl9S+q7T6dDr9aTudrsyHwwGlLXr9VpSFAWr9YrVaiXzzWYj4y8rTmHifelnugAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/1dba2044b3127d7fefaaccecc4495bbc/fcda8/1682336529639-d8d6d908-872e-40a7-bb94-6b81af9f5905.png\"\n        srcset=\"/static/1dba2044b3127d7fefaaccecc4495bbc/12f09/1682336529639-d8d6d908-872e-40a7-bb94-6b81af9f5905.png 148w,\n/static/1dba2044b3127d7fefaaccecc4495bbc/e4a3f/1682336529639-d8d6d908-872e-40a7-bb94-6b81af9f5905.png 295w,\n/static/1dba2044b3127d7fefaaccecc4495bbc/fcda8/1682336529639-d8d6d908-872e-40a7-bb94-6b81af9f5905.png 590w,\n/static/1dba2044b3127d7fefaaccecc4495bbc/efc66/1682336529639-d8d6d908-872e-40a7-bb94-6b81af9f5905.png 885w,\n/static/1dba2044b3127d7fefaaccecc4495bbc/c83ae/1682336529639-d8d6d908-872e-40a7-bb94-6b81af9f5905.png 1180w,\n/static/1dba2044b3127d7fefaaccecc4495bbc/7d62e/1682336529639-d8d6d908-872e-40a7-bb94-6b81af9f5905.png 2368w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p><a name=G3juA></a></p>\n<h2>代码改动</h2>\n<p>完整的提交见： <a href=\"https://github.com/Jeff-Tian/IdentityServer/commit/aef89c5fe14527390753e68daa81783ac86d6db5\">https://github.com/Jeff-Tian/IdentityServer/commit/aef89c5fe14527390753e68daa81783ac86d6db5</a></p>\n<p>主要的改动是增加了这个文件： hosts/main/Validators/TokenExchangeGrantValidator.cs，并且在依赖注入中将其注入。</p>\n<p>csharp\nusing System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Text.Json;\nusing System.Text.Json.Serialization;\nusing System.Threading.Tasks;\nusing Duende.IdentityServer.Models;\nusing Duende.IdentityServer.Validation;\nusing IdentityModel;</p>\n<p>namespace IdentityServerHost.Validators;</p>\n<p>public class TokenExchangeGrantValidator : IExtensionGrantValidator\n{\nprivate readonly ITokenValidator _validator;</p>\n<pre><code>public TokenExchangeGrantValidator(ITokenValidator validator)\n{\n    _validator = validator;\n}\n\npublic string GrantType => OidcConstants.GrantTypes.TokenExchange;\n\npublic async Task ValidateAsync(ExtensionGrantValidationContext context)\n{\n    context.Result = new GrantValidationResult(TokenRequestErrors.InvalidRequest);\n\n    var subjectToken = context.Request.Raw.Get(OidcConstants.TokenRequest.SubjectToken);\n\n    var subjectTokenType = context.Request.Raw.Get(OidcConstants.TokenRequest.SubjectTokenType);\n\n    if (string.IsNullOrWhiteSpace(subjectToken))\n    {\n        await Console.Error.WriteLineAsync(subject_token is missing);\n        return;\n    }\n\n    if (!string.Equals(subjectTokenType, OidcConstants.TokenTypeIdentifiers.AccessToken,\n            StringComparison.OrdinalIgnoreCase))\n    {\n        await Console.Error.WriteLineAsync(subject_token_type is not access_token);\n        return;\n    }\n\n    var validationResult = await _validator.ValidateIdentityTokenAsync(subjectToken);\n\n    if (validationResult.IsError)\n    {\n        await Console.Error.WriteLineAsync($subject_token is invalid: {subjectToken});\n        await Console.Error.WriteLineAsync(validationResult.Error);\n        return;\n    }\n\n    await Console.Error.WriteLineAsync(JsonSerializer.Serialize(validationResult.Claims, new JsonSerializerOptions()\n    {\n        ReferenceHandler = ReferenceHandler.Preserve\n    }));\n\n    var sub = validationResult.Claims.FirstOrDefault(c => c.Type == JwtClaimTypes.Subject)?.Value ?? unknown-sub;\n    var clientId = validationResult.Claims.FirstOrDefault(c => c.Type == JwtClaimTypes.ClientId)?.Value ??\n                   validationResult.Claims.FirstOrDefault(c => c.Type == JwtClaimTypes.Audience)?.Value ??\n                   unknown-client;\n\n    context.Request.ClientId = clientId;\n    context.Result = new GrantValidationResult(sub, GrantType, validationResult.Claims, clientId,\n        new Dictionary&#x3C;string, object>\n        {\n            { OidcConstants.TokenResponse.IssuedTokenType, OidcConstants.TokenTypeIdentifiers.AccessToken },\n        });\n}\n</code></pre>\n<p>}</p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}}}},"staticQueryHashes":[],"slicesMap":{}}