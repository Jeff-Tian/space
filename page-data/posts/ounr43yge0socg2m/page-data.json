{"componentChunkName":"component---src-templates-post-js","path":"/posts/ounr43yge0socg2m/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/ounr43yge0socg2m","relativePath":"posts/ounr43yge0socg2m","frontmatter":{"title":"AWS API Gateway 踩坑记 -- Binary Media Types","stackbit_url_path":"posts/ounr43yge0socg2m","date":"2022-12-30T02:59:36","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p>很早以前，利用 AWS API Gateway，部署了一个“万能BFF”：《<a href=\"https://zhuanlan.zhihu.com/p/412196725\">一顿操作猛如虎，部署一个万能 BFF - Jeff Tian的文章 - 知乎</a> 》。除了可以复用很多已有代码外（《<a href=\"https://zhuanlan.zhihu.com/p/415577362\">使用万能 BFF，将语雀文章 GraphQL 服务化 - Jeff Tian的文章 - 知乎</a> 》），还可以自由联邦任意其他的 GraphQL 服务（<a href=\"https://zhuanlan.zhihu.com/p/583120262\">《Free Arch: GraphQL Federation 初体验（成功，且丝滑！） - Jeff Tian的文章 - 知乎</a> 》）。目前已经联邦了 nodejs, java, python 写的后端，本来感觉已经完美了，按这个方向可以一条路走到黑了，没想到在微信小程序的上传文件时被卡了壳。</p>\n<p>本来，GraphQL 不支持 form data 形式的文件上传，有个牛人搞了一套标准，现在多数大框架都支持，因此 GraphQL 也可以使用表单上传文件了。我用 Python 做了一个接收文件上传的 GraphQL Resolver 示例： <a href=\"https://github.com/JeffTrain/face-swap/blob/master/api/upload.py\">https://github.com/JeffTrain/face-swap/blob/master/api/upload.py</a>，将它联邦到了万能 BFF 中后，在 Web 端也成功使用 GraphQL 客户端将文件上传了。但是，在微信小程序端，发现仍然不能用，因为微信小程序对于文件上传，有一套专门的方法，而不再是普通的 ajax call。并且这个专门的方法，只能指定一个接收文件上传的后端接口 url，并不支持 GraphQL。</p>\n<p>也就是说，虽然通过使用 Apollo Server 的方式，可以联邦各种其他的 GraphQL 服务，但是，在微信小程序的文件上传问题上，必须要能够联邦其他的通过 http 后端服务，否则，就得针对该功能，在万能 BFF 里写定制化代码了。我还是希望能够用联邦的方式，这样更加灵活，可以少写代码。比如，前面的 Python 服务，不仅通过 GraphQL 提供了文件上传功能，同时也以普通 HTTP 的形式提供了文件上传：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4e2db62c8faba4ea53cdf35c064078cf/6fa81/1672368393312-b86ea614-b42a-4017-8081-3b5be5465ed4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 76.35135135135135%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAABvUlEQVR42p3RzW7UMBDA8bz/Q3DiLTghcYITqKXsVmyzSTbOl2MncWzHSfmjZEtVxNJSDj+Nx7LG9kxknUMpTVU3HJOUuzihbiRStjRSIltFqzStUiitUbpjtBZrHeMFkeoM+1hwd6pppEIUJdM0sSwL8zxfFEL4q2g98ANYlnuWZeb+fiGEaSu6CqvwJG6eKbg+//PVDekpZ5oCzk/4KTxa823vH0W5Crz9OPN+58lrzeHUEgv1qNSepg9U3UTV+RdFSS95E3/iXb5jlyTcZAm7PGMvTuzzjNsi32R9izCa/AVR63o+pFdciQNmsgzBMqxxGul/8SMmWMzsXhQZb9HjQOdH9GSojaZ1A11Y86cMyp/pZ0TKDlxnB/JWILqKfX7k2AjEIBF9c46DpDQt5ag2xdgiRonY4u+izhm+HPbEZYp0mkZJciEQRUEtG+pmVWPGET95vPcoN1BaRWX1H7aChWspnaKw59s3Vj1xKb8sGrylMR3r19emDsGdB/OftqGkVYFo6odpOsbZb9b1a0XaDtxWKcJIvqYHDvWJrK/Juvqh8a+zFUxUSWFadqeYb1nM9fE7tyLZGv9aPwH5PHlX4sF7RgAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/4e2db62c8faba4ea53cdf35c064078cf/fcda8/1672368393312-b86ea614-b42a-4017-8081-3b5be5465ed4.png\"\n        srcset=\"/static/4e2db62c8faba4ea53cdf35c064078cf/12f09/1672368393312-b86ea614-b42a-4017-8081-3b5be5465ed4.png 148w,\n/static/4e2db62c8faba4ea53cdf35c064078cf/e4a3f/1672368393312-b86ea614-b42a-4017-8081-3b5be5465ed4.png 295w,\n/static/4e2db62c8faba4ea53cdf35c064078cf/fcda8/1672368393312-b86ea614-b42a-4017-8081-3b5be5465ed4.png 590w,\n/static/4e2db62c8faba4ea53cdf35c064078cf/efc66/1672368393312-b86ea614-b42a-4017-8081-3b5be5465ed4.png 885w,\n/static/4e2db62c8faba4ea53cdf35c064078cf/c83ae/1672368393312-b86ea614-b42a-4017-8081-3b5be5465ed4.png 1180w,\n/static/4e2db62c8faba4ea53cdf35c064078cf/6fa81/1672368393312-b86ea614-b42a-4017-8081-3b5be5465ed4.png 1856w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>因此，理想的方式是不仅联邦它的 GraphQL 服务，也联邦它的 HTTP 服务！</p>\n<p><a name=RBfXm></a></p>\n<h1>AWS API Gateway</h1>\n<p>于是，我想到了使用 AWS API Gateway 来完成这件事，做了如下配置：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a303ebc6ea9935e4b28ee963f918519e/cdf95/1672368496795-19f9cd17-6404-49d4-8db1-dd1ea2585794.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50.67567567567568%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAABO0lEQVR42n2P2W4bMQxF/f8f19e2SJxkYluaGS0ktYythWLhKVwUQd3zRII4uJeHnLMxBhGmaQKAFfLZxAWSMUYpta6rtVZrrXastbXW8uBwX2pn5t47EXlAQKIQAwUE2KcIAH6HiEIIRBR3DmOMvBVjUUS896UUEQlE86I8gQPrwOSc+UH/i7vMPAiuzIKIrXUR4T5yo8/0/l190+FDnnAYwmvWL5cXV2ftLr3xn1urZV1X7z0zP5OHu5lXPUF1i9OtNiSkQClFg9eYcqv1P8m/a2/MAxFrra22GNP5fLEWamsiMh58lUXkemtqIR4DEXrrXYqN8/H0U9mP2Z20O7mwxBBTSl/8u1xqJ7qJCABwH9vAk3t90z+Oy1HhtITP2N3T5Fo6+G3sMhEBwvv0pucLpG2vPYaMf/78C3sCQGqquQDBAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/a303ebc6ea9935e4b28ee963f918519e/fcda8/1672368496795-19f9cd17-6404-49d4-8db1-dd1ea2585794.png\"\n        srcset=\"/static/a303ebc6ea9935e4b28ee963f918519e/12f09/1672368496795-19f9cd17-6404-49d4-8db1-dd1ea2585794.png 148w,\n/static/a303ebc6ea9935e4b28ee963f918519e/e4a3f/1672368496795-19f9cd17-6404-49d4-8db1-dd1ea2585794.png 295w,\n/static/a303ebc6ea9935e4b28ee963f918519e/fcda8/1672368496795-19f9cd17-6404-49d4-8db1-dd1ea2585794.png 590w,\n/static/a303ebc6ea9935e4b28ee963f918519e/efc66/1672368496795-19f9cd17-6404-49d4-8db1-dd1ea2585794.png 885w,\n/static/a303ebc6ea9935e4b28ee963f918519e/c83ae/1672368496795-19f9cd17-6404-49d4-8db1-dd1ea2585794.png 1180w,\n/static/a303ebc6ea9935e4b28ee963f918519e/cdf95/1672368496795-19f9cd17-6404-49d4-8db1-dd1ea2585794.png 2106w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>即，定义了一个 API 路径，将集成类型设置了 HTTP，并且将目标端点 URL 设置为 python 后端 URL。该服务有一个文字转图片的功能，我试了一下，直接访问该服务，和通过 AWS API Gateway 访问该服务，效果一样：</p>\n<ul>\n<li>直接访问： <a href=\"https://face-swap-jeff-tian.cloud.okteto.net/text2img?text=hello\">https://face-swap-jeff-tian.cloud.okteto.net/text2img?text=hello</a></li>\n<li>通过 AWS API Gateway 访问： <a href=\"https://sls.pa-ca.me/face-swap/text2img?text=hello\">https://sls.pa-ca.me/face-swap/text2img?text=hello</a></li>\n</ul>\n<p><a name=dTp7q></a></p>\n<h1>文件上传</h1>\n<p>接着，我就试着在微信小程序里调用 AWS API Gateway 集成进来的文件上传服务，发现很奇怪的现象，不能正常工作！通过各种探测发现，文件上传通过了 API Gateway 后，其请求体被放大了一倍，不清楚是经过了什么样的转换，总之，后端服务接收到后，就不能正常处理了。</p>\n<p>后来，找到了一些模糊的说明，说是需要对 AWS API Gateway 设置 Binary Media Types。一试，还真有效，总之，在 AWS API Gateway 的设置里，添加一个 multipart/form-data的 Binary Media Type 之后，文件上传就正常了：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/18f1514fbfd659d59489d1a203d68c08/1078c/1672369034940-8329f4d5-87b9-4de6-bf64-343ee7bdb8fc.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 72.97297297297297%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsTAAALEwEAmpwYAAACIklEQVR42o2SW2/TMBiG83OYJq7WMjYx7dBJg4tyCz+NsSExCpoYFHG4mIREEddwgcSkdceWJG3sxI4PSeycHKMk61Ztu+DRK8v6rPfT6882vvZ+fN7vvdj9st3pbu68e/by7ebO3uar989Ldbdef9jqdLc63e03n3b29nc/fpuWsbzSXtp48mDj6cLK48bio9nm6t259WZzdW7pYXNhfX5+7f5ae7HVnr23PtNszTSudKfRMsaW3T/tAwwoCQZ/reOT08PDY3Nouh4G0IXABS4aAWSOoDmG1kSjUo4R0NANzEB7WmuM0bnl2I5LiO/7uBbCBPqBS0LEJGIR5gKSCFNOiG8EPBxj0xFnWmulcqWKQt9ClqWMEc45C0IRhnXRYIyJSNrZQaFVkiQylkkSK6WumYuiyLIsz/NIyPDSrAqlC23nB7lOGWUAAAgh5zyukFLWq5QyTdMkSdI0zbKsLhqFLmMiNUT5UOc6zcqz+rgMUpnjOBZCQAg9zwMAEEKEEFdmX5mOOkqiHPuYUso5v3ntYoqL2LoyJ4UY5L8YZY7jwAqEkOd5eAIhhDFGKcUYly9RYdRNtdb99LuIQ1nGkUKIKIrCCiEEQsiyLNu2x+MxpTSYYFTW0jzIf47YGaeh7/uU0umB3wx8GfvC7KijP6wX+THCLiWk7s0r6s10peYqttCkD36fHA9PzwfIJ+o/MKZjsFCOPO6gwKXi2pxv+3X6H4x4H00VFglpAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/18f1514fbfd659d59489d1a203d68c08/fcda8/1672369034940-8329f4d5-87b9-4de6-bf64-343ee7bdb8fc.png\"\n        srcset=\"/static/18f1514fbfd659d59489d1a203d68c08/12f09/1672369034940-8329f4d5-87b9-4de6-bf64-343ee7bdb8fc.png 148w,\n/static/18f1514fbfd659d59489d1a203d68c08/e4a3f/1672369034940-8329f4d5-87b9-4de6-bf64-343ee7bdb8fc.png 295w,\n/static/18f1514fbfd659d59489d1a203d68c08/fcda8/1672369034940-8329f4d5-87b9-4de6-bf64-343ee7bdb8fc.png 590w,\n/static/18f1514fbfd659d59489d1a203d68c08/efc66/1672369034940-8329f4d5-87b9-4de6-bf64-343ee7bdb8fc.png 885w,\n/static/18f1514fbfd659d59489d1a203d68c08/c83ae/1672369034940-8329f4d5-87b9-4de6-bf64-343ee7bdb8fc.png 1180w,\n/static/18f1514fbfd659d59489d1a203d68c08/1078c/1672369034940-8329f4d5-87b9-4de6-bf64-343ee7bdb8fc.png 2180w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>在这个设置好后，无论以后是对接其他后端的 GraphQL 服务，还是普通的 HTTP 服务，前端都不需要再改变后端的根域名了。</p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}}}},"staticQueryHashes":[],"slicesMap":{}}