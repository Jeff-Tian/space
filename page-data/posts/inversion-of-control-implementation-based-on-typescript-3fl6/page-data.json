{
    "componentChunkName": "component---src-templates-post-js",
    "path": "/posts/inversion-of-control-implementation-based-on-typescript-3fl6",
    "result": {"data":{"sitePage":null},"pageContext":{"url":"posts/inversion-of-control-implementation-based-on-typescript-3fl6","relativePath":"posts/inversion-of-control-implementation-based-on-typescript-3fl6","frontmatter":{"title":"The Implementation of Inversion of Control based on TypeScript","stackbit_url_path":"posts/inversion-of-control-implementation-based-on-typescript-3fl6","date":"2020-11-30T11:02:34Z","excerpt":"","tags":"","categories":"","template":"post"},"html":"<h2>\n  <a name=\"ioc\" href=\"#ioc\" class=\"anchor\">\n  </a>\n  IoC\n</h2>\n<p>According to wikipedia, the Inversion of Control, also as known as IoC, is a design principal in Object Oriented Programming, which is used to decouple the code.</p>\n<p>In the traditional Object Oriented Programming, when a class depends on another class, then usually the other class's instance gets created inside that class. By doing so it leads to classes couple with each other, and the more complex the dependencies are, the more tight of the couplings, and consequently harder for modifications and unit testings for the tightly coupled code. The IoC are dedicatedly used for creating and searching the dependent objects by providing a container, and hand over the controlling of the dependent objects from inside the class to the container, by doing so the classes are being decoupled, and ensure that all classes are easy to be modified.</p>\n<h3>\n  <a name=\"coupling\" href=\"#coupling\" class=\"anchor\">\n  </a>\n  Coupling\n</h3>\n<p>What the hell is coupling? We can show it by a simple example. Say we have two classes, <code>A</code> and <code>B</code>, their dependency relationship is <code>A</code> depends on <code>B</code>: <code>A ‚ä• B</code>. This is a common scenario in daily development, which can be implemented in a traditional way as the following:<br>\n</p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight typescript\"><code><span class=\"c1\">// b.ts</span>\n<p><span class=\"kd\">class</span> <span class=\"nx\">B</span> <span class=\"p\">{</span>\n<span class=\"kd\">constructor</span> <span class=\"p\">()</span> <span class=\"p\">{</span>\n<span class=\"p\">}</span>\n<span class=\"p\">}</span></p>\n<p><span class=\"c1\">// a.ts</span></p>\n<p><span class=\"kd\">class</span> <span class=\"nx\">A</span> <span class=\"p\">{</span>\n<span class=\"nl\">b</span><span class=\"p\">:</span> <span class=\"nx\">B</span><span class=\"p\">;</span>\n<span class=\"kd\">constructor</span> <span class=\"p\">()</span> <span class=\"p\">{</span>\n<span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">b</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">B</span><span class=\"p\">();</span>\n<span class=\"p\">}</span>\n<span class=\"p\">}</span></p>\n<p><span class=\"c1\">// main.ts</span></p>\n<p><span class=\"kd\">const</span> <span class=\"nx\">a</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">A</span><span class=\"p\">();</span>\n</code></pre></p>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode</title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"></path>\n</svg>\n<pre><code>&#x3C;svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\">&#x3C;title>Exit fullscreen mode&#x3C;/title>\n&#x3C;path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\">&#x3C;/path>\n</code></pre>\n</svg>\n</div>\n</div>\n</div>\n<p>The above code looks good for now, but if we got a new requirement which requires the innermost <code>B</code> pass a parameter <code>p</code> in during the initialization:<br>\n</p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight typescript\"><code><span class=\"c1\">// b.ts</span>\n<p><span class=\"kd\">class</span> <span class=\"nx\">B</span> <span class=\"p\">{</span>\n<span class=\"nl\">p</span><span class=\"p\">:</span> <span class=\"kr\">number</span><span class=\"p\">;</span>\n<span class=\"kd\">constructor</span> <span class=\"p\">(</span><span class=\"nx\">p</span><span class=\"p\">:</span> <span class=\"kr\">number</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n<span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">p</span> <span class=\"o\">=</span> <span class=\"nx\">p</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></p>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode</title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"></path>\n</svg>\n<pre><code>&#x3C;svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\">&#x3C;title>Exit fullscreen mode&#x3C;/title>\n&#x3C;path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\">&#x3C;/path>\n</code></pre>\n</svg>\n</div>\n</div>\n</div>\n<p>After the modification, we got a new problem: since <code>B</code> is instantiated inside class <code>A</code>'s constructor, so we have to pass the <code>p</code> inside <code>A</code>'s constructor. Where is the <code>p</code> come from inside <code>A</code>? Obviously we can not hard code it, otherwise there is no need to add it as a parameter at the first place. So we have to add a parameter <code>p</code> for class <code>A</code>'s constructor, too, as following:<br>\n</p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight typescript\"><code><span class=\"c1\">// a.ts</span>\n<p><span class=\"kd\">class</span> <span class=\"nx\">A</span> <span class=\"p\">{</span>\n<span class=\"nl\">b</span><span class=\"p\">:</span> <span class=\"nx\">B</span><span class=\"p\">;</span>\n<span class=\"kd\">constructor</span> <span class=\"p\">(</span><span class=\"nx\">p</span><span class=\"p\">:</span> <span class=\"kr\">number</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n<span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">b</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">B</span><span class=\"p\">(</span><span class=\"nx\">p</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n<span class=\"p\">}</span></p>\n<p><span class=\"c1\">// main.ts</span>\n<span class=\"kd\">const</span> <span class=\"nx\">a</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">A</span><span class=\"p\">(</span><span class=\"mi\">10</span><span class=\"p\">);</span>\n<span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"nx\">a</span><span class=\"p\">);</span> <span class=\"c1\">// => A {b: B {p: 10}}</span>\n</code></pre></p>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode</title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"></path>\n</svg>\n<pre><code>&#x3C;svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\">&#x3C;title>Exit fullscreen mode&#x3C;/title>\n&#x3C;path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\">&#x3C;/path>\n</code></pre>\n</svg>\n</div>\n</div>\n</div>\n<p>What's more tedious, after we've changed <code>A</code>, we found that <code>B</code>'s new parameter <code>p</code> can't be a <code>number</code> actually, it needs to be a <code>string</code>. So we have to change the type decoration to parameter <code>p</code> inside <code>A</code> again. Let's imagine what if there were more upper classes that depend on <code>A</code>? With the same approach we need to change all the upper classes in the same way! This is the very problem caused by coupling, we have to change all the files in the dependent links only for a simple parameter change in the innermost class. When the application's dependencies become more complex to an extend, it's easy to encounter a phenomenon that affects the whole body, which causes huge troubles for application's maintenance.</p>\n<h3>\n  <a name=\"decoupling\" href=\"#decoupling\" class=\"anchor\">\n  </a>\n  Decoupling\n</h3>\n<p>In fact, we can find, in the above example, that only <code>B</code> needs the parameter <code>p</code>, and <code>A</code> is using <code>p</code> merely for instantiate the dependent object and cares nothing about <code>p</code>. So we can consider moving the instantiation for dependent objects out of the class itself, for example, we can rewrite the above example as:<br>\n</p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight typescript\"><code><span class=\"c1\">// b.ts</span>\n<span class=\"kd\">class</span> <span class=\"nx\">B</span> <span class=\"p\">{</span>\n  <span class=\"nl\">p</span><span class=\"p\">:</span> <span class=\"kr\">number</span><span class=\"p\">;</span>\n  <span class=\"kd\">constructor</span> <span class=\"p\">(</span><span class=\"nx\">p</span><span class=\"p\">:</span> <span class=\"kr\">number</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">p</span> <span class=\"o\">=</span> <span class=\"nx\">p</span><span class=\"p\">;</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n<p><span class=\"c1\">// a.ts</span>\n<span class=\"kd\">class</span> <span class=\"nx\">A</span> <span class=\"p\">{</span>\n<span class=\"k\">private</span> <span class=\"nx\">b</span><span class=\"p\">:</span> <span class=\"nx\">B</span><span class=\"p\">;</span>\n<span class=\"kd\">constructor</span><span class=\"p\">(</span><span class=\"nx\">b</span><span class=\"p\">:</span> <span class=\"nx\">B</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n<span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">b</span> <span class=\"o\">=</span> <span class=\"nx\">b</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n<span class=\"p\">}</span></p>\n<p><span class=\"c1\">// main.ts</span>\n<span class=\"kd\">const</span> <span class=\"nx\">b</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">B</span><span class=\"p\">(</span><span class=\"mi\">10</span><span class=\"p\">);</span>\n<span class=\"kd\">const</span> <span class=\"nx\">a</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">A</span><span class=\"p\">(</span><span class=\"nx\">b</span><span class=\"p\">);</span>\n<span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"nx\">a</span><span class=\"p\">);</span> <span class=\"c1\">// A => {b: B {p: 10}}</span>\n</code></pre></p>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode</title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"></path>\n</svg>\n<pre><code>&#x3C;svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\">&#x3C;title>Exit fullscreen mode&#x3C;/title>\n&#x3C;path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\">&#x3C;/path>\n</code></pre>\n</svg>\n</div>\n</div>\n</div>\n<p>In the above example, <code>A</code> is not accepting parameter <code>p</code>, instead, it accepts the dependent object, and doesn't care about where does the object get instantiated. This approach solved our previously problem in a effective way, now we only need to change <code>B</code> when we need to change the parameter <code>p</code>, without the need to modify <code>A</code>, so we decoupled the classes.</p>\n<h2>\n  <a name=\"containers\" href=\"#containers\" class=\"anchor\">\n  </a>\n  Containers\n</h2>\n<p>Even though we've implemented the decoupling, we need to instantiate all the classes by ourselves, and pass them by means of parameters in constructor. If exists a global container, and it <strong>pre-registered</strong> all the class definitions and initial parameters that we need, and every object has an unique key, then we can only tell the container its key when we need an object to <strong>get</strong> the instantiated object from the container directly. By doing so the developer won't need to care about how the objects get instantiated, neither pass them as constructor's parameters in the dependency links.</p>\n<p>In other words, our container must have two functions, <strong>registering the instances</strong> and <strong>get them</strong>. It's naturally to come up with <code>Map</code>, which can be used to implement a simple container:<br>\n</p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight typescript\"><code><span class=\"c1\">// container.ts</span>\n<p><span class=\"k\">export</span> <span class=\"kd\">class</span> <span class=\"nx\">Container</span> <span class=\"p\">{</span>\n<span class=\"nx\">bindMap</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nb\">Map</span><span class=\"p\">();</span></p>\n<p><span class=\"c1\">// Registering the instances</span>\n<span class=\"nx\">bind</span><span class=\"p\">(</span><span class=\"nx\">identifier</span><span class=\"p\">:</span> <span class=\"kr\">string</span><span class=\"p\">,</span> <span class=\"nx\">clazz</span><span class=\"p\">:</span> <span class=\"kr\">any</span><span class=\"p\">,</span> <span class=\"nx\">constructorArgs</span><span class=\"p\">:</span> <span class=\"nb\">Array</span><span class=\"o\">&#x3C;</span><span class=\"kr\">any</span><span class=\"o\">></span><span class=\"p\">)</span> <span class=\"p\">{</span>\n<span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">bindMap</span><span class=\"p\">.</span><span class=\"kd\">set</span><span class=\"p\">(</span><span class=\"nx\">identifier</span><span class=\"p\">,</span> <span class=\"p\">{</span><span class=\"nx\">clazz</span><span class=\"p\">,</span> <span class=\"nx\">constructorArgs</span><span class=\"p\">});</span>\n<span class=\"p\">}</span></p>\n<p><span class=\"c1\">// get the instances</span>\n<span class=\"kd\">get</span><span class=\"o\">&#x3C;</span><span class=\"nx\">T</span><span class=\"o\">></span><span class=\"p\">(</span><span class=\"nx\">identifier</span><span class=\"p\">:</span> <span class=\"kr\">string</span><span class=\"p\">)</span> <span class=\"p\">:</span> <span class=\"nx\">T</span> <span class=\"p\">{</span>\n<span class=\"kd\">const</span> <span class=\"nx\">target</span> <span class=\"o\">=</span> <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">bindMap</span><span class=\"p\">.</span><span class=\"kd\">get</span><span class=\"p\">(</span><span class=\"nx\">identifier</span><span class=\"p\">);</span>\n<span class=\"kd\">const</span> <span class=\"p\">{</span> <span class=\"nx\">clazz</span><span class=\"p\">,</span> <span class=\"nx\">constructorArgs</span> <span class=\"p\">}</span> <span class=\"o\">=</span> <span class=\"nx\">target</span><span class=\"p\">;</span>\n<span class=\"kd\">const</span> <span class=\"nx\">inst</span> <span class=\"o\">=</span> <span class=\"nb\">Reflect</span><span class=\"p\">.</span><span class=\"nx\">construct</span><span class=\"p\">(</span><span class=\"nx\">clazz</span><span class=\"p\">,</span> <span class=\"nx\">constructorArgs</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></p>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode</title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"></path>\n</svg>\n<pre><code>&#x3C;svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\">&#x3C;title>Exit fullscreen mode&#x3C;/title>\n&#x3C;path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\">&#x3C;/path>\n</code></pre>\n</svg>\n</div>\n</div>\n</div>\n<p>Here we used <code>Reflect.construct</code>, whose behavior is kind of similar to operator <code>new</code>, which helps us instantiate the object. By means of container, we can eventually abandon passing the parameters and implement the decoupling, for example:<br>\n</p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight typescript\"><code><span class=\"c1\">// b.ts</span>\n<p><span class=\"kd\">class</span> <span class=\"nx\">B</span> <span class=\"p\">{</span>\n<span class=\"kd\">constructor</span><span class=\"p\">(</span><span class=\"nx\">p</span><span class=\"p\">:</span> <span class=\"kr\">number</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n<span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">p</span> <span class=\"o\">=</span> <span class=\"nx\">p</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n<span class=\"p\">}</span></p>\n<p><span class=\"c1\">// a.ts</span>\n<span class=\"kd\">class</span> <span class=\"nx\">A</span> <span class=\"p\">{</span>\n<span class=\"nl\">b</span><span class=\"p\">:</span> <span class=\"nx\">B</span><span class=\"p\">;</span>\n<span class=\"kd\">constructor</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n<span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">b</span> <span class=\"o\">=</span> <span class=\"nx\">container</span><span class=\"p\">.</span><span class=\"kd\">get</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">b</span><span class=\"dl\">'</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n<span class=\"p\">}</span></p>\n<p><span class=\"c1\">// main.ts</span>\n<span class=\"kd\">const</span> <span class=\"nx\">container</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">Container</span><span class=\"p\">();</span>\n<span class=\"nx\">container</span><span class=\"p\">.</span><span class=\"nx\">bind</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">a</span><span class=\"dl\">'</span><span class=\"p\">,</span> <span class=\"nx\">A</span><span class=\"p\">);</span>\n<span class=\"nx\">container</span><span class=\"p\">.</span><span class=\"nx\">bind</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">b</span><span class=\"dl\">'</span><span class=\"p\">,</span> <span class=\"nx\">B</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"mi\">10</span><span class=\"p\">]);</span></p>\n<p><span class=\"c1\">// get a from container</span>\n<span class=\"kd\">const</span> <span class=\"nx\">a</span> <span class=\"o\">=</span> <span class=\"nx\">container</span><span class=\"p\">.</span><span class=\"kd\">get</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">a</span><span class=\"dl\">'</span><span class=\"p\">);</span>\n<span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"nx\">a</span><span class=\"p\">);</span> <span class=\"c1\">// A => {b: B { p: 10}}</span>\n</code></pre></p>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode</title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"></path>\n</svg>\n<pre><code>&#x3C;svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\">&#x3C;title>Exit fullscreen mode&#x3C;/title>\n&#x3C;path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\">&#x3C;/path>\n</code></pre>\n</svg>\n</div>\n</div>\n</div>\n<p>Actually till now we have basically implemented IoC, and decoupled classes based on container. But from the lines of code perspective, code looks no clearer than before, and in the contrary, the container initialization and classes registration make us feel tedious. If that part of code can be encapsulated into framework, and all the classes registration can be automatically wired up, in the same time all classes can get the dependent instances of the classes during the construction time without manually specify them inside constructor, then the developer's hands can be freed totally, and then only focus on the inner logic of the class. This is what DI(Dependency Injection) comes in handy.</p>\n<h2>\n  <a name=\"di\" href=\"#di\" class=\"anchor\">\n  </a>\n  DI\n</h2>\n<p>Many of us can't tell the difference between DI and IoC, so was I. IoC is only a principle, DI is a concrete implementation for IoC. Simply put, we can inject the dependencies to the caller, without the need for the caller to fetch explicitly. To implement DI, two issues need to be solved:</p>\n<ul>\n<li>The classes that need to be registered in the IoC container, they need to be able to register themselves automatically during program starts</li>\n<li>When instantiate the classes inside the IoC container, the dependent objects can be fetched directly without manually specifying them inside constructor</li>\n</ul>\n<p>Regarding the two problems there are different solutions, for example, the famous Java Spring needs developers define an XML file describing the dependency relationships, and then the framework do the instances' registration and dependency injections based on the XML file. But the XML based dependency management approach is too trivial, so Midway utilizes the decoration features provided by TypeScript, by decorating the meta data to identify the registration requirements and dependencies need to be injected, to implement the dependency injection.</p>\n<h3>\n  <a name=\"reflect-metadata\" href=\"#reflect-metadata\" class=\"anchor\">\n  </a>\n  Reflect Metadata\n</h3>\n<p>To use decoration to solve the above two problems, we need to know some basics about Reflect Metadata. Reflect Metadata is a proposal to ES7, mainly used to add and read the meta data during declaration phase, which was supported from TypeScript 1.5+.</p>\n<p>Meta data can be treated as descriptive information regarding to the classes or certain properties of classes, they don't affect class's behavior by nature, but you can get the predefined metadata to a class, and apply certain operations to the class based on the metadata.</p>\n<p>The usage of Reflect Metadata is rather simple, first of all you need to install the <code>reflect-metadata</code> library:<br>\n</p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight shell\"><code>npm i reflect-metadata <span class=\"nt\">--save</span>\n</code></pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode</title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"></path>\n</svg>\n<pre><code>&#x3C;svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\">&#x3C;title>Exit fullscreen mode&#x3C;/title>\n&#x3C;path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\">&#x3C;/path>\n</code></pre>\n</svg>\n</div>\n</div>\n</div>\n<p>And then in your <code>tsconfig.json</code>, the <code>emitDecoratorMetadata</code> needs to be configured to <code>true</code>.</p>\n<p>And then we can define and get the meta data using <code>Reflect.defineMetadata</code> and <code>Reflect.getMetadata</code>, for example:<br>\n</p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight typescript\"><code><span class=\"k\">import</span> <span class=\"dl\">'</span><span class=\"s1\">reflect-metadata</span><span class=\"dl\">'</span><span class=\"p\">;</span>\n<p><span class=\"kd\">const</span> <span class=\"nx\">CLASS_KEY</span> <span class=\"o\">=</span> <span class=\"dl\">'</span><span class=\"s1\">ioc:key</span><span class=\"dl\">'</span><span class=\"p\">;</span></p>\n<p><span class=\"kd\">function</span> <span class=\"nx\">ClassDecorator</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n<span class=\"k\">return</span> <span class=\"kd\">function</span> <span class=\"p\">(</span><span class=\"nx\">target</span><span class=\"p\">:</span> <span class=\"kr\">any</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n<span class=\"nb\">Reflect</span><span class=\"p\">.</span><span class=\"nx\">defineMetadata</span><span class=\"p\">(</span><span class=\"nx\">CLASS_KEY</span><span class=\"p\">,</span> <span class=\"p\">{</span>\n<span class=\"na\">metaData</span><span class=\"p\">:</span> <span class=\"dl\">'</span><span class=\"s1\">metaData</span><span class=\"dl\">'</span><span class=\"p\">,</span>\n<span class=\"p\">},</span> <span class=\"nx\">target</span><span class=\"p\">);</span></p>\n<pre><code>&#x3C;span class=\"k\">return&#x3C;/span> &#x3C;span class=\"nx\">target&#x3C;/span>&#x3C;span class=\"p\">;&#x3C;/span>\n</code></pre>\n<p><span class=\"p\">}</span>\n<span class=\"p\">}</span></p>\n<p><span class=\"p\">@</span><span class=\"nd\">ClassDecorator</span><span class=\"p\">()</span>\n<span class=\"kd\">class</span> <span class=\"nx\">D</span> <span class=\"p\">{</span>\n<span class=\"kd\">constructor</span><span class=\"p\">(){}</span>\n<span class=\"p\">}</span></p>\n<p><span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"nb\">Reflect</span><span class=\"p\">.</span><span class=\"nx\">getMetadata</span><span class=\"p\">(</span><span class=\"nx\">ClASS_KEY</span><span class=\"p\">,</span> <span class=\"nx\">D</span><span class=\"p\">));</span> <span class=\"c1\">// => {metaData: 'metaData'}</span>\n</code></pre></p>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode</title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"></path>\n</svg>\n<pre><code>&#x3C;svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\">&#x3C;title>Exit fullscreen mode&#x3C;/title>\n&#x3C;path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\">&#x3C;/path>\n</code></pre>\n</svg>\n</div>\n</div>\n</div>\n<p>With <code>Reflect</code>, we can tokenize any class, and apply special operations to the tokenized class. </p>\n<h3>\n  <a name=\"provider\" href=\"#provider\" class=\"anchor\">\n  </a>\n  Provider\n</h3>\n<p>Back to our initial problem, we need all classes get defined and parameters registration automatically during application starts, but not all classes need to be registered into the container, and we don't know what classes need to be registered, nor the initial parameters of them are like.</p>\n<p>We can introduce metadata to solve this issue, by appending some new special tokens to the class's metadata in the definition, we can identify them by scanning. With this bear in mind we implement a decorator to tokenize the classes need to be registered firstly, and name the decorator <code>Provider</code>, meaning it will be consumed by other classes as a provider.<br>\n</p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight typescript\"><code><span class=\"c1\">// provider.ts</span>\n<p><span class=\"k\">import</span> <span class=\"dl\">'</span><span class=\"s1\">reflect-metadata</span><span class=\"dl\">'</span><span class=\"p\">;</span></p>\n<p><span class=\"k\">export</span> <span class=\"kd\">const</span> <span class=\"nx\">CLASS_KEY</span> <span class=\"o\">=</span> <span class=\"dl\">'</span><span class=\"s1\">ioc:tagged_class</span><span class=\"dl\">'</span><span class=\"p\">;</span></p>\n<p><span class=\"k\">export</span> <span class=\"kd\">function</span> <span class=\"nx\">Provider</span><span class=\"p\">(</span><span class=\"nx\">identifier</span><span class=\"p\">:</span> <span class=\"kr\">string</span><span class=\"p\">,</span> <span class=\"nx\">args</span><span class=\"p\">?:</span> <span class=\"nb\">Array</span><span class=\"o\">&#x3C;</span><span class=\"kr\">any</span><span class=\"o\">></span><span class=\"p\">)</span> <span class=\"p\">{</span>\n<span class=\"k\">return</span> <span class=\"kd\">function</span> <span class=\"p\">(</span><span class=\"nx\">target</span><span class=\"p\">:</span> <span class=\"kr\">any</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n<span class=\"nb\">Reflect</span><span class=\"p\">.</span><span class=\"nx\">defineMetadata</span><span class=\"p\">(</span><span class=\"nx\">CLASS_KEY</span><span class=\"p\">,</span> <span class=\"p\">{</span>\n<span class=\"na\">id</span><span class=\"p\">:</span> <span class=\"nx\">identifier</span><span class=\"p\">,</span>\n<span class=\"na\">args</span><span class=\"p\">:</span> <span class=\"nx\">args</span> <span class=\"o\">||</span> <span class=\"p\">[]</span>\n<span class=\"p\">},</span> <span class=\"nx\">target</span><span class=\"p\">);</span>\n<span class=\"k\">return</span> <span class=\"nx\">target</span><span class=\"p\">;</span>\n<span class=\"p\">};</span>\n<span class=\"p\">}</span>\n</code></pre></p>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode</title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"></path>\n</svg>\n<pre><code>&#x3C;svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\">&#x3C;title>Exit fullscreen mode&#x3C;/title>\n&#x3C;path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\">&#x3C;/path>\n</code></pre>\n</svg>\n</div>\n</div>\n</div>\n<p>We can see there are <code>id</code> and <code>args</code> in the tokens, where <code>id</code> is the <code>key</code> used to register IoC container, and <code>args</code> are the needed parameters of instantiation. <code>Provider</code> can be used directly in a decoration fashion, as follow:<br>\n</p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight typescript\"><code><span class=\"c1\">// b.ts</span>\n<span class=\"k\">import</span> <span class=\"p\">{</span><span class=\"nx\">Provider</span><span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"dl\">'</span><span class=\"s1\">provider</span><span class=\"dl\">'</span><span class=\"p\">;</span>\n<p><span class=\"p\">@</span><span class=\"nd\">Provider</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">b</span><span class=\"dl\">'</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"mi\">10</span><span class=\"p\">])</span>\n<span class=\"k\">export</span> <span class=\"kd\">class</span> <span class=\"nx\">B</span> <span class=\"p\">{</span>\n<span class=\"kd\">constructor</span><span class=\"p\">(</span><span class=\"nx\">p</span><span class=\"p\">:</span> <span class=\"kr\">number</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n<span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">p</span> <span class=\"o\">=</span> <span class=\"nx\">p</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></p>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode</title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"></path>\n</svg>\n<pre><code>&#x3C;svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\">&#x3C;title>Exit fullscreen mode&#x3C;/title>\n&#x3C;path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\">&#x3C;/path>\n</code></pre>\n</svg>\n</div>\n</div>\n</div>\n<p>With tokenization done, another issue surfaces: How do we get these definitions during application starts?</p>\n<p>An easy way is scan all the files when starts, get all the classes exported by those files and bind them according to the metadata. For the simplicity we assume there were no nested directories, then the implementation is as follows:<br>\n</p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight typescript\"><code><span class=\"c1\">// load.ts</span>\n<p><span class=\"k\">import</span> <span class=\"o\">*</span> <span class=\"k\">as</span> <span class=\"nx\">fs</span> <span class=\"k\">from</span> <span class=\"dl\">'</span><span class=\"s1\">fs</span><span class=\"dl\">'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">CLASS_KEY</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"dl\">'</span><span class=\"s1\">./provider</span><span class=\"dl\">'</span><span class=\"p\">;</span></p>\n<p><span class=\"k\">export</span> <span class=\"kd\">function</span> <span class=\"nx\">load</span><span class=\"p\">(</span><span class=\"nx\">container</span><span class=\"p\">)</span> <span class=\"p\">{</span> <span class=\"c1\">// The container is the global IoC container</span>\n<span class=\"kd\">const</span> <span class=\"nx\">list</span> <span class=\"o\">=</span> <span class=\"nx\">fs</span><span class=\"p\">.</span><span class=\"nx\">readdirSync</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">./</span><span class=\"dl\">'</span><span class=\"p\">);</span>\n<span class=\"k\">for</span> <span class=\"p\">(</span><span class=\"kd\">const</span> <span class=\"nx\">file</span> <span class=\"k\">of</span> <span class=\"nx\">list</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n<span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"sr\">/</span><span class=\"se\">.</span><span class=\"sr\">ts$/</span><span class=\"p\">.</span><span class=\"nx\">test</span><span class=\"p\">(</span><span class=\"nx\">file</span><span class=\"p\">))</span> <span class=\"p\">{</span>\n<span class=\"kd\">const</span> <span class=\"nx\">exports</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s2\"><code>./&#x3C;/span>&#x3C;span class=\"p\">${&#x3C;/span>&#x3C;span class=\"nx\">file&#x3C;/span>&#x3C;span class=\"p\">}&#x3C;/span>&#x3C;span class=\"s2\"></code></span><span class=\"p\">);</span>\n<span class=\"k\">for</span> <span class=\"p\">(</span><span class=\"kd\">const</span> <span class=\"nx\">m</span> <span class=\"k\">in</span> <span class=\"nx\">exports</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n<span class=\"kd\">const</span> <span class=\"kr\">module</span> <span class=\"o\">=</span> <span class=\"nx\">exports</span><span class=\"p\">[</span><span class=\"nx\">m</span><span class=\"p\">];</span>\n<span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"k\">typeof</span> <span class=\"kr\">module</span> <span class=\"o\">===</span> <span class=\"dl\">'</span><span class=\"s1\">function</span><span class=\"dl\">'</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n<span class=\"kd\">const</span> <span class=\"nx\">metadata</span> <span class=\"o\">=</span> <span class=\"nb\">Reflect</span><span class=\"p\">.</span><span class=\"nx\">getMetadata</span><span class=\"p\">(</span><span class=\"nx\">CLASS_KEY</span><span class=\"p\">,</span> <span class=\"kr\">module</span><span class=\"p\">);</span>\n<span class=\"c1\">// register</span>\n<span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">metadata</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n<span class=\"nx\">container</span><span class=\"p\">.</span><span class=\"nx\">bind</span><span class=\"p\">(</span><span class=\"nx\">metadata</span><span class=\"p\">.</span><span class=\"nx\">id</span><span class=\"p\">,</span> <span class=\"kr\">module</span><span class=\"p\">,</span> <span class=\"nx\">metadata</span><span class=\"p\">.</span><span class=\"nx\">args</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n<span class=\"p\">}</span>\n<span class=\"p\">}</span>\n<span class=\"p\">}</span>\n<span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></p>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode</title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"></path>\n</svg>\n<pre><code>&#x3C;svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\">&#x3C;title>Exit fullscreen mode&#x3C;/title>\n&#x3C;path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\">&#x3C;/path>\n</code></pre>\n</svg>\n</div>\n</div>\n</div>\n<p>So now, we can finish all the work of binding the decorated class by just running the <code>load</code> inside <code>main</code>. What worth noting is that the logic of <code>load</code> and <code>Container</code> are totally generic, they can be encapsulated in to a package and then a simplified IoC framework is in its baby shape.<br>\n</p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight typescript\"><code><span class=\"k\">import</span> <span class=\"p\">{</span><span class=\"nx\">Container</span><span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"dl\">'</span><span class=\"s1\">./container</span><span class=\"dl\">'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"p\">{</span><span class=\"nx\">load</span><span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"dl\">'</span><span class=\"s1\">./load</span><span class=\"dl\">'</span><span class=\"p\">;</span>\n<p><span class=\"kd\">const</span> <span class=\"nx\">container</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">Container</span><span class=\"p\">();</span>\n<span class=\"nx\">load</span><span class=\"p\">(</span><span class=\"nx\">container</span><span class=\"p\">);</span></p>\n<p><span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"nx\">container</span><span class=\"p\">.</span><span class=\"kd\">get</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">a</span><span class=\"dl\">'</span><span class=\"p\">));</span> <span class=\"c1\">// A => {b: B {p: 10}}</span>\n</code></pre></p>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode</title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"></path>\n</svg>\n<pre><code>&#x3C;svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\">&#x3C;title>Exit fullscreen mode&#x3C;/title>\n&#x3C;path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\">&#x3C;/path>\n</code></pre>\n</svg>\n</div>\n</div>\n</div>\n<h3>\n  <a name=\"inject\" href=\"#inject\" class=\"anchor\">\n  </a>\n  Inject\n</h3>\n<p>With registration work done, we now check the 2nd issue mentioned above: How do we get all the dependent instances directly without explicitly pass them in the constructor. Actually the initiative is simple, since we have already put all required classes into the IoC container, so when we need some class we can iterate the properties of the class during fetching the class instance, by get the corresponding object and assign the value, then the dependency injection work is done.</p>\n<p>But another issue comes out, how do we tell which properties need to be injected? Similarly we can use metadata to solve it. By defining a decorator to tokenize which properties need to be injected and name this decorator as <code>Inject</code> to indicate this property needs to be injected, then we are good.<br>\n</p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight typescript\"><code><span class=\"c1\">// inject.ts</span>\n<p><span class=\"k\">import</span> <span class=\"dl\">'</span><span class=\"s1\">reflect-metadata</span><span class=\"dl\">'</span><span class=\"p\">;</span></p>\n<p><span class=\"k\">export</span> <span class=\"kd\">const</span> <span class=\"nx\">PROPS_KEY</span> <span class=\"o\">=</span> <span class=\"dl\">'</span><span class=\"s1\">ioc:inject_props</span><span class=\"dl\">'</span><span class=\"p\">;</span></p>\n<p><span class=\"k\">export</span> <span class=\"kd\">function</span> <span class=\"nx\">Inject</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n<span class=\"k\">return</span> <span class=\"kd\">function</span> <span class=\"p\">(</span><span class=\"nx\">target</span><span class=\"p\">:</span> <span class=\"kr\">any</span><span class=\"p\">,</span> <span class=\"nx\">targetKey</span><span class=\"p\">:</span> <span class=\"kr\">string</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n<span class=\"kd\">const</span> <span class=\"nx\">annotationTarget</span> <span class=\"o\">=</span> <span class=\"nx\">target</span><span class=\"p\">.</span><span class=\"kd\">constructor</span><span class=\"p\">;</span></p>\n<pre><code>&#x3C;span class=\"kd\">let&#x3C;/span> &#x3C;span class=\"nx\">props&#x3C;/span> &#x3C;span class=\"o\">=&#x3C;/span> &#x3C;span class=\"p\">{};&#x3C;/span>\n&#x3C;span class=\"k\">if&#x3C;/span> &#x3C;span class=\"p\">(&#x3C;/span>&#x3C;span class=\"nb\">Reflect&#x3C;/span>&#x3C;span class=\"p\">.&#x3C;/span>&#x3C;span class=\"nx\">hasOwnMetadata&#x3C;/span>&#x3C;span class=\"p\">(&#x3C;/span>&#x3C;span class=\"nx\">PROPS_KEY&#x3C;/span>&#x3C;span class=\"p\">,&#x3C;/span> &#x3C;span class=\"nx\">annotationTarget&#x3C;/span>&#x3C;span class=\"p\">))&#x3C;/span> &#x3C;span class=\"p\">{&#x3C;/span>\n  &#x3C;span class=\"nx\">props&#x3C;/span> &#x3C;span class=\"o\">=&#x3C;/span> &#x3C;span class=\"nb\">Reflect&#x3C;/span>&#x3C;span class=\"p\">.&#x3C;/span>&#x3C;span class=\"nx\">getMetadata&#x3C;/span>&#x3C;span class=\"p\">(&#x3C;/span>&#x3C;span class=\"nx\">PROPS_KEY&#x3C;/span>&#x3C;span class=\"p\">,&#x3C;/span> &#x3C;span class=\"nx\">annotationTarget&#x3C;/span>&#x3C;span class=\"p\">);&#x3C;/span>\n&#x3C;span class=\"p\">}&#x3C;/span>\n\n&#x3C;span class=\"nx\">props&#x3C;/span>&#x3C;span class=\"p\">[&#x3C;/span>&#x3C;span class=\"nx\">targetKey&#x3C;/span>&#x3C;span class=\"p\">]&#x3C;/span> &#x3C;span class=\"o\">=&#x3C;/span> &#x3C;span class=\"p\">{&#x3C;/span>\n  &#x3C;span class=\"na\">value&#x3C;/span>&#x3C;span class=\"p\">:&#x3C;/span> &#x3C;span class=\"nx\">targetKey&#x3C;/span>\n&#x3C;span class=\"p\">};&#x3C;/span>\n\n&#x3C;span class=\"nb\">Reflect&#x3C;/span>&#x3C;span class=\"p\">.&#x3C;/span>&#x3C;span class=\"nx\">defineMetadata&#x3C;/span>&#x3C;span class=\"p\">(&#x3C;/span>&#x3C;span class=\"nx\">PROPS_KEY&#x3C;/span>&#x3C;span class=\"p\">,&#x3C;/span> &#x3C;span class=\"nx\">props&#x3C;/span>&#x3C;span class=\"p\">,&#x3C;/span> &#x3C;span class=\"nx\">annotationTarget&#x3C;/span>&#x3C;span class=\"p\">);&#x3C;/span>\n</code></pre>\n<p><span class=\"p\">};</span>\n<span class=\"p\">}</span>\n</code></pre></p>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode</title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"></path>\n</svg>\n<pre><code>&#x3C;svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\">&#x3C;title>Exit fullscreen mode&#x3C;/title>\n&#x3C;path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\">&#x3C;/path>\n</code></pre>\n</svg>\n</div>\n</div>\n</div>\n<p>Need to attention that although we are decorating the properties, the actual metadata should be defined on class to maintain the property list need to be injected of the class. So we have to use <code>target.constructor</code> as the <code>target</code> to be operated. And here uses property name (<code>targetKey</code>) as the <code>key</code> to the instance in IoC container to be simple.</p>\n<p>Then we need to change the <code>get</code> method of IoC container, and inject all the properties recursively:<br>\n</p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight typescript\"><code><span class=\"c1\">// container.ts</span>\n<p><span class=\"k\">import</span> <span class=\"p\">{</span><span class=\"nx\">PROPS_KEY</span><span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"dl\">'</span><span class=\"s1\">./inject</span><span class=\"dl\">'</span><span class=\"p\">;</span></p>\n<p><span class=\"k\">export</span> <span class=\"kd\">class</span> <span class=\"nx\">Container</span> <span class=\"p\">{</span>\n<span class=\"nx\">bindMap</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nb\">Map</span><span class=\"p\">();</span></p>\n<p><span class=\"nx\">bind</span><span class=\"p\">(</span><span class=\"nx\">identifier</span><span class=\"p\">:</span> <span class=\"kr\">string</span><span class=\"p\">,</span> <span class=\"nx\">clazz</span><span class=\"p\">:</span> <span class=\"kr\">any</span><span class=\"p\">,</span> <span class=\"nx\">constructorArgs</span><span class=\"p\">?:</span> <span class=\"nb\">Array</span><span class=\"o\">&#x3C;</span><span class=\"kr\">any</span><span class=\"o\">></span><span class=\"p\">)</span> <span class=\"p\">{</span>\n<span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">bindMap</span><span class=\"p\">.</span><span class=\"kd\">set</span><span class=\"p\">(</span><span class=\"nx\">identifier</span><span class=\"p\">,</span> <span class=\"p\">{</span>\n<span class=\"nx\">clazz</span><span class=\"p\">,</span>\n<span class=\"na\">constructorArgs</span><span class=\"p\">:</span> <span class=\"nx\">constructorArgs</span> <span class=\"o\">||</span> <span class=\"p\">[]</span>\n<span class=\"p\">});</span>\n<span class=\"p\">}</span></p>\n<p><span class=\"kd\">get</span><span class=\"o\">&#x3C;</span><span class=\"nx\">T</span><span class=\"o\">></span><span class=\"p\">(</span><span class=\"nx\">identifier</span><span class=\"p\">:</span> <span class=\"kr\">string</span><span class=\"p\">)</span> <span class=\"p\">:</span> <span class=\"nx\">T</span> <span class=\"p\">{</span>\n<span class=\"kd\">const</span> <span class=\"nx\">target</span> <span class=\"o\">=</span> <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">bindMap</span><span class=\"p\">.</span><span class=\"kd\">get</span><span class=\"p\">(</span><span class=\"nx\">identifier</span><span class=\"p\">);</span>\n<span class=\"kd\">const</span> <span class=\"p\">{</span> <span class=\"nx\">clazz</span><span class=\"p\">,</span> <span class=\"nx\">constructorArgs</span> <span class=\"p\">}</span> <span class=\"o\">=</span> <span class=\"nx\">target</span><span class=\"p\">;</span>\n<span class=\"kd\">const</span> <span class=\"nx\">props</span> <span class=\"o\">=</span> <span class=\"nb\">Reflect</span><span class=\"p\">.</span><span class=\"nx\">getMetadata</span><span class=\"p\">(</span><span class=\"nx\">PROPS_KEY</span><span class=\"p\">,</span> <span class=\"nx\">clazz</span><span class=\"p\">);</span>\n<span class=\"kd\">const</span> <span class=\"nx\">inst</span> <span class=\"o\">=</span> <span class=\"nb\">Reflect</span><span class=\"p\">.</span><span class=\"nx\">construct</span><span class=\"p\">(</span><span class=\"nx\">clazz</span><span class=\"p\">,</span> <span class=\"nx\">constructorArgs</span><span class=\"p\">);</span>\n<span class=\"k\">for</span> <span class=\"p\">(</span><span class=\"kd\">let</span> <span class=\"nx\">prop</span> <span class=\"k\">in</span> <span class=\"nx\">props</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n<span class=\"kd\">const</span> <span class=\"nx\">identifier</span> <span class=\"o\">=</span> <span class=\"nx\">props</span><span class=\"p\">[</span><span class=\"nx\">prop</span><span class=\"p\">].</span><span class=\"nx\">value</span><span class=\"p\">;</span>\n<span class=\"c1\">// get injected object recursively</span>\n<span class=\"nx\">inst</span><span class=\"p\">[</span><span class=\"nx\">prop</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"kd\">get</span><span class=\"p\">(</span><span class=\"nx\">identier</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n<span class=\"k\">return</span> <span class=\"nx\">inst</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n<span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></p>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode</title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"></path>\n</svg>\n<pre><code>&#x3C;svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\">&#x3C;title>Exit fullscreen mode&#x3C;/title>\n&#x3C;path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\">&#x3C;/path>\n</code></pre>\n</svg>\n</div>\n</div>\n</div>\n<p>To use it you can just utilize <code>Inject</code> to decorate the needed properties.<br>\n</p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight typescript\"><code><span class=\"c1\">// a.ts</span>\n<p><span class=\"k\">import</span> <span class=\"p\">{</span><span class=\"nx\">Provider</span><span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"dl\">'</span><span class=\"s1\">provider</span><span class=\"dl\">'</span><span class=\"p\">;</span></p>\n<p><span class=\"p\">@</span><span class=\"nd\">Provider</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">a</span><span class=\"dl\">'</span><span class=\"p\">)</span>\n<span class=\"k\">export</span> <span class=\"kd\">class</span> <span class=\"nx\">A</span> <span class=\"p\">{</span>\n<span class=\"p\">@</span><span class=\"nd\">Inject</span><span class=\"p\">()</span>\n<span class=\"nx\">b</span><span class=\"p\">:</span> <span class=\"nx\">B</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></p>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode</title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"></path>\n</svg>\n<pre><code>&#x3C;svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\">&#x3C;title>Exit fullscreen mode&#x3C;/title>\n&#x3C;path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\">&#x3C;/path>\n</code></pre>\n</svg>\n</div>\n</div>\n</div>\n<h3>\n  <a name=\"final-code\" href=\"#final-code\" class=\"anchor\">\n  </a>\n  Final code\n</h3>\n<p>After the above adjustment, our final business code looks like this:<br>\n</p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight typescript\"><code><span class=\"c1\">// b.ts</span>\n<p><span class=\"p\">@</span><span class=\"nd\">Provider</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">b</span><span class=\"dl\">'</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"mi\">10</span><span class=\"p\">])</span>\n<span class=\"kd\">class</span> <span class=\"nx\">B</span> <span class=\"p\">{</span>\n<span class=\"kd\">constructor</span><span class=\"p\">(</span><span class=\"nx\">p</span><span class=\"p\">:</span> <span class=\"kr\">number</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n<span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">p</span> <span class=\"o\">=</span> <span class=\"nx\">p</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n<span class=\"p\">}</span></p>\n<p><span class=\"c1\">// a.ts</span></p>\n<p><span class=\"p\">@</span><span class=\"nd\">Provider</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">a</span><span class=\"dl\">'</span><span class=\"p\">)</span>\n<span class=\"kd\">class</span> <span class=\"nx\">A</span> <span class=\"p\">{</span>\n<span class=\"p\">@</span><span class=\"nd\">Inject</span><span class=\"p\">()</span>\n<span class=\"k\">private</span> <span class=\"nx\">b</span><span class=\"p\">:</span> <span class=\"nx\">B</span><span class=\"p\">;</span>\n<span class=\"p\">}</span></p>\n<p><span class=\"c1\">// main.ts</span>\n<span class=\"kd\">const</span> <span class=\"nx\">container</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">Container</span><span class=\"p\">();</span>\n<span class=\"nx\">load</span><span class=\"p\">(</span><span class=\"nx\">container</span><span class=\"p\">);</span></p>\n<p><span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"nx\">container</span><span class=\"p\">.</span><span class=\"kd\">get</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">a</span><span class=\"dl\">'</span><span class=\"p\">));</span>   <span class=\"c1\">// A => {b: B {p: 10}}</span>\n</code></pre></p>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode</title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"></path>\n</svg>\n<pre><code>&#x3C;svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\">&#x3C;title>Exit fullscreen mode&#x3C;/title>\n&#x3C;path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\">&#x3C;/path>\n</code></pre>\n</svg>\n</div>\n</div>\n</div>\n<p>We can see there is no more manually instantiation, and the framework layer can automatically handle whatever how many classes to be registered, and inject required properties when instantiation. All instances can be provided are maintained by the class itself, and if it needed to be changed it doesn't need to change other files.</p>\n<h2>\n  <a name=\"summary\" href=\"#summary\" class=\"anchor\">\n  </a>\n  Summary\n</h2>\n<p>This post starts from classes decoupling to describe why IoC is needed, and implemented a simplified IoC framework based TypeScript. In fact, besides decoupling, we can benefit much from IoC, for example, fast unit test based on container, analyzing the dependency relations between classes.</p>\n<p>Although the concept of IoC was initiated from server side, but nowadays there are also all kinds of applications in the front end, for example AngularJS has implemented their own IoC framework to improve development efficiency and the levels of modularization. </p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"ÂÖ≥‰∫é","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"ÂèΩÂèΩÊ≠™Ê≠™","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"Áü•‰πé","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"Á¥´Á´πÂèΩÊ≠™","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}},"menus":{}}},
    "staticQueryHashes": []}