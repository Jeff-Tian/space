{"componentChunkName":"component---src-templates-post-js","path":"/posts/zsld7g","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/zsld7g","relativePath":"posts/zsld7g","frontmatter":{"title":"将 axios 的请求记录打印成 cURL","stackbit_url_path":"posts/zsld7g","date":"2021-12-14T11:33:45","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p>正如 JSON 已经成为普遍的对象序列化格式一样，cURL 也应该是 HTTP 请求的普遍序列化格式。JSON 原本是为 JavaScript 使用的，其本名是 JavaScript Object Notation，但是各种语言都喜欢用它了，连 Java 这个强类型语言也总是要和它打交道，哪怕 JSON 里缺少类型信息，以至于在 Java 中会碰到各种不便。</p>\n<p>题外话，这种不便纯粹是强类型导致的，并不是说序列化和反序列化有多难。比如，对于 JavaScript 程序员来说，很熟悉 JSON.stringify 和 JSON.parse。对于 Java 来说，只要放松类型要求（统统 Object），很容易实现一个：</p>\n<p>java\npackage helpers;</p>\n<p>import com.google.gson.Gson;\nimport com.google.gson.GsonBuilder;</p>\n<p>public class JsonHelper {\nprivate static final Gson gson = new GsonBuilder().setPrettyPrinting().create();</p>\n<pre><code>public static String stringify(Object anything) {\n    return gson.toJson(anything);\n}\n\npublic static Object parse(String s) {\n    return gson.fromJson(s, Object.class);\n}\n</code></pre>\n<p>}</p>\n<p>package helpers;</p>\n<p>import org.junit.jupiter.api.Test;</p>\n<p>import java.util.Objects;</p>\n<p>import static org.junit.jupiter.api.Assertions.*;</p>\n<p>class JsonHelperTest {\n@Test\nvoid testStringify() {\nObject o = new Object();\nString res = JsonHelper.stringify(o);</p>\n<pre><code>    assertEquals({}, res);\n}\n</code></pre>\n<p>...</p>\n<p>总之，JSON 已经成为了编程语言中的对象的非常受欢迎的序列化形式。</p>\n<p>那么，对于 HTTP 请求，像 JSON 一样受欢迎的序列化形式，就应该是 cURL。</p>\n<p>关于 cURL，已经在一篇文章中推荐过：《<a href=\"https://zhuanlan.zhihu.com/p/375532394\">使用 cURL 提高前后端开发连调中的沟通效率</a>》，这里再补充一点。cURL 一旦拷贝出来，可以方便导入到 Postman，并转化成各种其他语言代码导出：<br /><img src=\"https://cdn.nlark.com/yuque/0/2021/png/221736/1639480446678-209c9454-dd8b-400b-8e10-e5d3f61dd7fa.png#clientId=u78719b24-fd3d-4&#x26;crop=0&#x26;crop=0&#x26;crop=1&#x26;crop=1&#x26;from=paste&#x26;height=197&#x26;id=uddc3cdf2&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=394&#x26;originWidth=713&#x26;originalType=binary%E2%88%B6=1&#x26;rotation=0&#x26;showTitle=false&#x26;size=29041&#x26;status=done&#x26;style=none&#x26;taskId=u22d19da0-6a17-4c0d-8773-ff8781e816a&#x26;title=&#x26;width=356.5\" alt=\"image.png\"><br /><img src=\"https://cdn.nlark.com/yuque/0/2021/png/221736/1639480660335-5ff6afa2-1457-4c38-a7c2-9c37d2b1dc00.png#clientId=u78719b24-fd3d-4&#x26;crop=0&#x26;crop=0&#x26;crop=1&#x26;crop=1&#x26;from=paste&#x26;height=840&#x26;id=u2365b7fe&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=1680&#x26;originWidth=2688&#x26;originalType=binary%E2%88%B6=1&#x26;rotation=0&#x26;showTitle=false&#x26;size=691905&#x26;status=done&#x26;style=none&#x26;taskId=u2570d8ec-2e25-4ed4-8a4f-b943e9f728f&#x26;title=&#x26;width=1344\" alt=\"image.png\"></p>\n<p>序列化成 cURL，就是方便重放。一般都可以从抓包工具或者开发者工具来以 cURL 复制前端发出的请求，但其实，很多“后端”也是要再次调用另外的后端服务的，这些请求，比较难以抓包（当然可以使用一些像 w2 这样的工具，但是有很强的代码侵入性，并且需要在部署上下点工夫）。对于后端发出的请求，比较自然的方式就是打印日志，但是分散打印，再手动拼装完全没有必要，应该实现在代码里，自动生成 cURL。</p>\n<p>对于 Java 服务，如果使用 FeignClient 来发请求，之前写过一篇《<a href=\"https://zhuanlan.zhihu.com/p/386126054\">将 FeignClient 的请求记录成 cURL 格式</a>》。而对于 node 服务，常见的是使用 axios 来发送 HTTP 请求，同样，也非常推荐将 axios 的请求记录成 cURL 格式。</p>\n<p>附上代码：</p>\n<p>TypeScript 版：\ntypescript\nimport { curlirize, Method } from ./curlirize</p>\n<p>describe(curlirize, () => {\nit(curlize axios requests, () => {\nconst config = {\nmethod: Method.GET,\nparams: { q: s },\nheaders: {},\nurl: url,\nbaseURL: base/,\n}</p>\n<pre><code>    const res = curlirize(config)\n    expect(res).toEqual(cURL to replay: curl -X GET base/url?q=s  )\n})\n</code></pre>\n<p>})</p>\n<p>import type { AxiosRequestConfig } from axios\nimport { pickBy, isPlainObject } from lodash</p>\n<p>export const curlirize = (config: AxiosRequestConfig) => {\nconst { headers: rawHeaders, method = GET, baseURL = , url, params: rawParams = {}, data } = config\nconst headers = {\n...rawHeaders?.common,\n...(isPlainObject(data)\n? { Content-Type: application/json }\n: rawHeaders\n? rawHeaders[method.toLowerCase()]\n: {}),\n...pickBy(rawHeaders, (_, key) => !Method[key] &#x26;&#x26; key !== common),\n}</p>\n<pre><code>const query = Array.from(Object.entries(rawParams)).reduce((query, [key, value]) => {\n    if (value === undefined) return query\n\n    if (typeof value === object) {\n        if (Array.isArray(value)) {\n            value.forEach((item) => query.append(key, item))\n        } else {\n            // undefined behavior\n        }\n    } else {\n        query.append(key, ${value})\n    }\n\n    return query\n}, new URLSearchParams())\n\nconst serializedHeaders = headers ? Object.keys(headers).map((key) => --header ${key}: ${headers[key]}) : []\n\nconst cmd = cURL to replay: curl -X ${method.toUpperCase()} ${baseURL}${url}${\n    query ? ?${query.toString()} : \n} ${serializedHeaders.join( )} \n\nif (isPlainObject(data)) {\n    return cmd + --data ${JSON.stringify(data)}\n} else {\n    return cmd\n}\n</code></pre>\n<p>}</p>\n<p>export enum Method {\nget = GET,\nGET = GET,\ndelete = DELETE,\nDELETE = DELETE,\nhead = HEAD,\nHEAD = HEAD,\noptions = OPTIONS,\nOPTIONS = OPTIONS,\npost = POST,\nPOST = POST,\nput = PUT,\nPUT = PUT,\npatch = PATCH,\nPATCH = PATCH,\npurge = PURGE,\nPURGE = PURGE,\nlink = LINK,\nLINK = LINK,\nunlink = UNLINK,\nUNLINK = UNLINK,\n}</p>\n<p>纯 JavaScript 版，可以参考这个（比较仓促，写得略简）： <a href=\"https://github.com/Jeff-Tian/serverless-space/blob/00064fa2dbd75a6daf48cb206491a35a3eae2ba1/src/common/curlirize.ts\">https://github.com/Jeff-Tian/serverless-space/blob/00064fa2dbd75a6daf48cb206491a35a3eae2ba1/src/common/curlirize.ts</a></p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}},"menus":{}}},"staticQueryHashes":[]}