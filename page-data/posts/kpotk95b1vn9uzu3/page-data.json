{"componentChunkName":"component---src-templates-post-js","path":"/posts/kpotk95b1vn9uzu3/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/kpotk95b1vn9uzu3","relativePath":"posts/kpotk95b1vn9uzu3","frontmatter":{"title":"联邦 strapi 4 graphql 实战","stackbit_url_path":"posts/kpotk95b1vn9uzu3","date":"2024-01-23T10:08:20","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p><a name=KdcuM></a></p>\n<h1>前情提要</h1>\n<p>我部署了一套 Strapi 4 并且开启了 GraphQL （详见《<a href=\"%5Bhttps://zhuanlan.zhihu.com/p/674864877%5D(https://zhuanlan.zhihu.com/p/674864877)\">借助 Bedrock SDK，全面释放内容生产力 - Jeff Tian的文章 - 知乎</a> 》），可以通过 <a href=\"https://strapi.brickverse.dev/graphql\">https://strapi.brickverse.dev/graphql</a> 打开 Playground：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.48648648648649%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAACWUlEQVR42o2RS0/bQBSFLSSoxCN2SJx4xoE4YMdxMrZDAgmExAlQKH3suumm2xYJKFUV0VJYddN9//BXxXER7Lo4OjMj3e+eo9Huf/9h+vCLi68/+HQ95fPNLVfTe66nD/+hey6/3XF1+5Ob7w98md6h6W6fZTtgsbTFolljKfOF9U00o4JmbDzxp6qwUKrzwnLRchJt1WKptI1W2I4pBl2KfpeC28Gsd1ndVLx6/5Hk3QdEa0AlnmBHyXOFQ0T7DLPRp+TvPM5q+a0Y3YvR3YhcVaE7itWNJrLZZzNOENEEGR9jRUOsdqbokHKwT63/hoLfo+yH5LcidCdEy9cidDfGqLczYJh6zokoNfYRaoSlRpSbB1jNQapycEDZ71M/v8AMBpQ8lQKNWpQlrIVzOSF6dQ6cvVutAVY4RHZeImZpd4aIboLojLDahzhvLymqA2RTYWTz2vp2G8NvY3gZeAZ0FIYTp4MyOUaOMh0eIUdHqdujCdbgFKPRxQxi9Kpiraqyyl6M4cbPKhtOhLUzxJ6cIJMMND6eL8iAInlN3utg+iEiUBTcLGEKyUBpbSckP0vYHWEfnaT6l2zmsyV2coQYnrPu71JuKEQjTGtrhtNCr7Ywaor1rYjVjQYrFZ+1zVb6o3IwQfTHc/USxP4YeTBB7idYvVN0dw8j/WFFrhqirUiPnKiTk3V020cXdXThka80EfEQ2Z8ge2Pk3njuj/cEa++MotdFBiGF7TADCpcVy2U504rwmL2t2T5Ffxcz7GOGPUzVm59Vj2J63qPYnmDVO9jBrN084V/3N2oggPWi5wAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/de2a26806c702f22ea5b026338c1ef5d/fcda8/1706002354546-77ad819e-74d6-4266-9c6e-ee0eced1b980.png\"\n        srcset=\"/static/de2a26806c702f22ea5b026338c1ef5d/12f09/1706002354546-77ad819e-74d6-4266-9c6e-ee0eced1b980.png 148w,\n/static/de2a26806c702f22ea5b026338c1ef5d/e4a3f/1706002354546-77ad819e-74d6-4266-9c6e-ee0eced1b980.png 295w,\n/static/de2a26806c702f22ea5b026338c1ef5d/fcda8/1706002354546-77ad819e-74d6-4266-9c6e-ee0eced1b980.png 590w,\n/static/de2a26806c702f22ea5b026338c1ef5d/efc66/1706002354546-77ad819e-74d6-4266-9c6e-ee0eced1b980.png 885w,\n/static/de2a26806c702f22ea5b026338c1ef5d/c83ae/1706002354546-77ad819e-74d6-4266-9c6e-ee0eced1b980.png 1180w,\n/static/de2a26806c702f22ea5b026338c1ef5d/b297c/1706002354546-77ad819e-74d6-4266-9c6e-ee0eced1b980.png 2844w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span><br />它工作得很好，为前端  <a href=\"https://taro.jefftian.dev/pages/subpages/brickverse/index\">https://taro.jefftian.dev/pages/subpages/brickverse/index</a> 提供了服务。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 105.40540540540542%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAABYlAAAWJQFJUiTwAAADQElEQVR42qVU17LiVhDk/7/E9ou9TuWyX7zc4JtBgIQkkhAgEEKZoNyuHhbKeB/3VHVpZs5Mn0mlVl3X8LwAc3sDTZ9B6RkYaBMBdVWbYGhYImvDKdThVHRjZEM3LPGzlx6CKMMuOKKV5QWCMIEfJHDWOyxXWzgbHxs3OOvOFlsvEn3leNhsA9HXG1/gbkP4QYo4yRAlJ7T4QqerQekb0E0LvYEJYzRHnBYwxxam1gJBdMTUWkE3p4jTDK4X4+m5A3NsI0oyBNEJfngUtMIkR5gWCOIMUVogORAl0mN1lvdnxGmOeJ8jPZZIDyWiND/fiVwi3p/RqmqgrBrUDVDVDYqiEuRFKaCNdxfkX+5obxqgLGuJJ2hrAUDTNEiSGGmagEOqqkrQNDWSJMFut0MYBIjCUOxkiuMYi4UtX94BjaBFMmKz2cDdbnF5gMQ8u52P+XyOxWKB1Wp1tXueB0VREAQBXHeLC49kWJYlvuVcKuJpXQwkLYpCspjNZpIRQdkwDIxGI8mKlei6LrbxeIw8z1HXzTWpG0KmTIKPjw/0ej1YloXBYID7+3spz3VdaJqGdruNp6cnvL29SQ//W+VNycPhUBwZ+M0lE3z95eVFiNM0lQnv93ucTiccDgf50u94PIoeRRGyLJNBXTO8TIf9mU6n0rfHx0cpW1VVPD8/y5eTZgtM0xT9/f1dfNhbxt8Q8rDMizMJ6Uhy9pCB/X4ftm2Lnf3kl8PhYC6Z3xCu12s8PDxIIIlJ5DiODInZvL6+YrlcXgfDaojJZCKT/oqQwXTkOpCA8H3/mhHLZW/5EG2sgtVQZj8vC3/toQSbJjS1B1Xti9P/V4p7ymyocxgslfY8L24zJMIwRBSn8OMaYXzC6XSUR2jnpDlR7hwDuQEkpJ1yVZdfl8wp9lUd5jyBZi6ll52OAqXXx0DVMNQNfG7fidzpKphMZxioAwwUA551QN1U8vf5kiEQ7DxMTBUTQ4GudjAb67BnJjbOHPOpge16geGgi173FYbWw8IaY6h24dgWsiRHWd2sTYORHeLT3RLf/2nih79G+PVhiZ8+z/GpPcfPd7bg938c/Pa4wo9/W3L/3R9D/PK4hhtXQH3O8F8IACeBpmW9ZwAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/5f430af8f7b18b21a6c67fbd443863af/fcda8/1706002726044-dd48819f-bbaf-428a-aa66-6d37a6f9bf5d.png\"\n        srcset=\"/static/5f430af8f7b18b21a6c67fbd443863af/12f09/1706002726044-dd48819f-bbaf-428a-aa66-6d37a6f9bf5d.png 148w,\n/static/5f430af8f7b18b21a6c67fbd443863af/e4a3f/1706002726044-dd48819f-bbaf-428a-aa66-6d37a6f9bf5d.png 295w,\n/static/5f430af8f7b18b21a6c67fbd443863af/fcda8/1706002726044-dd48819f-bbaf-428a-aa66-6d37a6f9bf5d.png 590w,\n/static/5f430af8f7b18b21a6c67fbd443863af/efc66/1706002726044-dd48819f-bbaf-428a-aa66-6d37a6f9bf5d.png 885w,\n/static/5f430af8f7b18b21a6c67fbd443863af/cc155/1706002726044-dd48819f-bbaf-428a-aa66-6d37a6f9bf5d.png 886w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span><br />另外，之前又部署了一个 GraphQL Gateway，详见《<a href=\"%5Bhttps://zhuanlan.zhihu.com/p/583120262%5D(https://zhuanlan.zhihu.com/p/583120262)\">Free Arch: GraphQL Federation 初体验（成功，且丝滑！） - Jeff Tian的文章 - 知乎</a> 》。现在，希望在原有的 GraphQL Gateway 里，将新部署的 Strapi GraphQL 联邦进来。<br />不过，这次就没有 GraphQL 联邦初体验那么丝滑了，花了整整两天时间才搞定！\n<a name=joWOH></a></p>\n<h1>最终效果</h1>\n<p>最终效果就是可以通过万能 BFF 的 GraphQL Gateway <a href=\"https://sls.pa-ca.me/stg/gateway\">https://sls.pa-ca.me/stg/gateway</a> 来访问 Strapi 的 GraphQL 服务了：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.810810810810814%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABg0lEQVR42o2T247aMBRF8/8/Vql/MB0uhUDihIDjy7EzAWdVNiC1VctMpCX7xUv7eDvV+WLReuTY9Gx3B+qDolEDx/ZUaNoTh6Z/geLQdbSqR3U91Wpds9ru2Pzcs97u+LHa8Pa+Zrvb877dszl0WGtwzuG8/yfee6xzNKqjMtbQ65HRObzIg0CIAe0CnRa4ekgTX/kq6wXjHOI9Yn1ZvTOIeLpBM1xMES63mWVZXlKEOfJpvCcMISAhlJS3OfLtrWfTjjA7UkrlQDn8W6Kn6CktQu0c1ntCjEiM+BC5zRPf1yPrxpD8QJrlj4P/HVlEuDjH2VpiFj5S5r31gUFbliknvGYd2fVSmNtxIoUsCg9pFmonnLSD2bKkWxn1s3usjL2n0w9xCH8LPSka0u3jay3nAsodihCnqSTMxCkylmdjuc5SSknLcl9fUBlrSyF59IwPUpAgaCvU54EpKtJ1+lRWhMemoTkeqeua/W6PahSqVfStKr/hKT/sD0O6Crwo4znyL82goahvZUBcAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/d5e4bcdfcd31f220986d0be50827cfcb/fcda8/1706003841710-a3b876c1-a388-4f17-a804-88e9812d1da8.png\"\n        srcset=\"/static/d5e4bcdfcd31f220986d0be50827cfcb/12f09/1706003841710-a3b876c1-a388-4f17-a804-88e9812d1da8.png 148w,\n/static/d5e4bcdfcd31f220986d0be50827cfcb/e4a3f/1706003841710-a3b876c1-a388-4f17-a804-88e9812d1da8.png 295w,\n/static/d5e4bcdfcd31f220986d0be50827cfcb/fcda8/1706003841710-a3b876c1-a388-4f17-a804-88e9812d1da8.png 590w,\n/static/d5e4bcdfcd31f220986d0be50827cfcb/efc66/1706003841710-a3b876c1-a388-4f17-a804-88e9812d1da8.png 885w,\n/static/d5e4bcdfcd31f220986d0be50827cfcb/c83ae/1706003841710-a3b876c1-a388-4f17-a804-88e9812d1da8.png 1180w,\n/static/d5e4bcdfcd31f220986d0be50827cfcb/ed358/1706003841710-a3b876c1-a388-4f17-a804-88e9812d1da8.png 2904w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p><a name=e7rv2></a></p>\n<h1>难点</h1>\n<p>本来，联邦 Strapi 的 GraphQL 就应该像联邦其他的 GraphQL 服务一样丝滑，然而，试了一下并不行。原因是 Strapi 4 的 GraphQL 并不支持被联邦。于是找到了一个大佬写的开源库： <a href=\"https://github.com/0xR/graphql-transform-federation\">https://github.com/0xR/graphql-transform-federation</a>，看上去是可以用作一个中间件，将一个原来不支持被联邦的 GraphQL 服务，包装成一个支持联邦的 GraphQL 服务。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 96.62162162162163%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAAD4klEQVR42pVUXUgjVxS+MUmrFpvIpoIvbaNQsa2wW3a7fSgU3/fZJ5/EFyFlW2TJwnariSj0NUrpiw8aJYgxKGptUDLLhhDyK/PnZGYyd2Yyk5n86IMS/xrLlDtrl6UouBe+uXfuOee755x7zgXglpFOp8HW1hYIh8NtgiD8IQjC72tra20YhgEcx8F7D03TrKqqAoZhnmiaZui6bhwcHDxRFAWUSqWW9yILBoPIC0s2mwXZbNYBIfxLFMU/k8mkI5/PA5IkLRsbG3cnXFhYMEkDgUALRVFtPp+v0+fzOfP5fPvS0pIlEomA9fX1uxNubm6C+fl5MDc31y7L8mtZlquqqlYkSXodiUQ+2t7eBolEwnInsr6+PmAYhmVwcBBgGOZQFOWIZVmD53lDkqQjhmGcgUDA1Onp6bmRAyXYdj1b+vv7zYQfHR2ZwmKxOC1JUlAUxUWO46bRXqPRMGW9vb2mzf8APgYAuAAA9u7ubivanJqa6ojFYo8zmcyjeDw+EAqFvllZWXmQSCQG0un0IwzDvvX7/cjO4nK5kDPWa9jBtXfmQGGQJAkEQbiPykRV1UtVVa8URfmnXC5fXa+btVrtiiTJh7lczrR5J1rrW8LV1VULjuO2SqWCCB+XSiWDpmmDYRiDoiiD4zjzHwHVJY7j38uyDAiCsO3u7v5HagPt7e02r9cLRFEEtVoNcBwHYrGYQ5bln6vV6lNJksYhhM94nv9FkqRnuq7/JMvy052dnU50+PHxMWBZFgwPDwO73W46Zw2Hwx+kUik3wzBugiDcqVTq05GRkXujo6OuiYmJzvHxcYdhGEi31ePxfOL3+12xWKxHVVU3RVHueDz+2ezsbIsZMlLkOO47COE5TdOnHMc1CoXCGc/zVyzLXjIMcwEhRKF/eX5+jp2dnaHc/q3r+qWmaWcnJycXFxcXjXg8/tA8FH14nv9BURQD5Q3lKplMGtls1kD1p6qqCYIgvmo2m9l6vY7WhiAIphzZNZtNpD/4ljCTyXyuKMqUpmleCOFzHMdf5HK5F6IoPi+Xy15RFGcwDLtXLpd/q1araU3TYtVq9ZWu61ilUnmFkEqlBkzCoaGhDwmCQBfxNU3TvkKh4C0UCi9pmv4VrVmW9UWj0S/QjSKD2zAzMwNsNpsNeDyeVvRMaZo2iXJFkqQZEppRuaCQFEUZPz09RYbW21q2q6vrTdmMjY217u/vAwjhj4eHh0atVjumKKrBMEyjXq+foL1isTgCIUSEN76D1xXwhrCjowO1i2V6erpzcXGxNxQKuff29tzRaNS9vLzsDgaDvZOTkw7U606n8902uwn2fwE9tsLxpEukVAAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/2611c029f394144f42507ef994dc5099/fcda8/1706004115185-dddf4b0d-6ccb-4806-a448-0a629da858e4.png\"\n        srcset=\"/static/2611c029f394144f42507ef994dc5099/12f09/1706004115185-dddf4b0d-6ccb-4806-a448-0a629da858e4.png 148w,\n/static/2611c029f394144f42507ef994dc5099/e4a3f/1706004115185-dddf4b0d-6ccb-4806-a448-0a629da858e4.png 295w,\n/static/2611c029f394144f42507ef994dc5099/fcda8/1706004115185-dddf4b0d-6ccb-4806-a448-0a629da858e4.png 590w,\n/static/2611c029f394144f42507ef994dc5099/efc66/1706004115185-dddf4b0d-6ccb-4806-a448-0a629da858e4.png 885w,\n/static/2611c029f394144f42507ef994dc5099/7a3d6/1706004115185-dddf4b0d-6ccb-4806-a448-0a629da858e4.png 990w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span><br />这正是我想要的！<br />不幸的是，通过实测，根本跑不起来。原因它依赖的很多 GraphQL 库的版本都太老了，看了一下其最新发版时间是在 4 年前，不能适应我的项目。\n<a name=rynsC></a></p>\n<h1>解决办法</h1>\n<p>我将它 fork 了过来，将相应的包升级后，发布了一个 @jeff-tian/graphql-transform-federation。通过在项目中使用  @jeff-tian/graphql-transform-federation，成功地将它联邦进来了！<br />这就是《<a href=\"%5Bhttps://zhuanlan.zhihu.com/p/668063944%5D(https://zhuanlan.zhihu.com/p/668063944)\">修改 node_modules 的三种方式，隆重推荐 patch-package - Jeff Tian的文章 - 知乎</a> 》中提到的修改 node_modules 的方式之一，对于修复第三方库的场景，真是屡试不爽，推荐你也使用！</p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}}}},"staticQueryHashes":[],"slicesMap":{}}