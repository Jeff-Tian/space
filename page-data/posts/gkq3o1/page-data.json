{"componentChunkName":"component---src-templates-post-js","path":"/posts/gkq3o1/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/gkq3o1","relativePath":"posts/gkq3o1","frontmatter":{"title":"关注公众号即登录插件适配 Keycloak 18","stackbit_url_path":"posts/gkq3o1","date":"2022-09-10T12:51:20","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p>在 2021 年 2 月份基于 Keycloak 7 实现了一个关注微信公众号即登录的插件，在当年 9 月份收到咨询说在最新版 Keycloak 中不能使用了。于是做了一个升级，当时是升级到了 Keycloak 15，详见：<br /><a href=\"https://zhuanlan.zhihu.com/p/407932327?\">https://zhuanlan.zhihu.com/p/407932327</a></p>\n<p>后来，又将 Keycloak 升级到了 16，发现插件不用做任何修改，也能适配使用。</p>\n<p>但是时间又过去了一整年，Keycloak 又出了新版本，而且改动特别大，本文记录一下在适配 Keycloak 18 时需要做的一些改动，以供更多网友参考。\n<a name=NfMRg></a></p>\n<h1>为什么再次升级？</h1>\n<p>其实也是在知乎上收到了咨询，才了解到 Keycloak 升级到 18 后，自定义的身份提供程序，需要以新的方式集成进去才行。由于客户的代码并不是开源的，需要保密，所以这里以开源的 Keycloak 微信插件举例说明要做的适配。因为这个关注公众号即登录插件，本质上就是 Keycloak 的一种自定义社交登录身份提供程序，所以具有普遍性，并且和我帮助客户的程序做的改动是一样的。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 83.78378378378379%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAACIUlEQVR42q1U2W7aUBT0j7SQBaIEJanaP+1nJErYDWo/oS99agQh2OyG2GbxAl5gqjnBiKaCvtTS6I6P75mzysrtpy+4uf2M02wOmYscsnvIZC9xlbvB5dU1PqbOtjhF+iQj/EPq9M2WPsdJKo2Ls3MohWIZNbWO+3wZxVIVqlrDY76AUrmCcqWKu7t71Gp1qGodlYqKx3wR9CHPF0piL5M/POBbTYWC//woURQhjmPwjKLtGccIggCz2QymZcPxI7GHYfiGLQ/CEOs4xNQJ8fV7iOrP4O8MN5uNnBS0TBOO48L1fBFg4PdYr2Msgxg/tBgtIzosuPR99PUXOI4D27bF+d/P5rAgM7JMC4ZhCIbDISaTCUajEcbjsXBjZKDb7aLf76PfH0g1BwWjKERH19FoNKBpGnS9g06ng8FggFarJfy5+YynX0/QdR3NRkOCHO1hr9cTZ2bXbrfRbDYlIwZgINparRfomib3LNs+LsgpMyphmuauVPaUXCYdBALf8+T9SMmRXEymmdj376zXa+E8iaOCq9UKvcEA8/lcsvM8b29f/8T+Gh2dMksejQwRpPB0OhXMF4vdOu1s8/nxDPmRDpZlyXrQwXVdCbJYOCJIm+/7AoquVgEUCrxHUjIbz73TNF2EGIAgpwAHlAQip/DBnwN7QycK0IGOzIpgP3ky6HK5lO8Uo49yqMm8mKwNy+YuEq+TVxFMRAjPdcXGrfgNWGPkLCahvnsAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/65ece33b3146a254b61cc79c286f30e5/fcda8/1662814351262-77d332b1-8ef0-4615-803d-1cd85248acb5.png\"\n        srcset=\"/static/65ece33b3146a254b61cc79c286f30e5/12f09/1662814351262-77d332b1-8ef0-4615-803d-1cd85248acb5.png 148w,\n/static/65ece33b3146a254b61cc79c286f30e5/e4a3f/1662814351262-77d332b1-8ef0-4615-803d-1cd85248acb5.png 295w,\n/static/65ece33b3146a254b61cc79c286f30e5/fcda8/1662814351262-77d332b1-8ef0-4615-803d-1cd85248acb5.png 590w,\n/static/65ece33b3146a254b61cc79c286f30e5/efc66/1662814351262-77d332b1-8ef0-4615-803d-1cd85248acb5.png 885w,\n/static/65ece33b3146a254b61cc79c286f30e5/c0ebd/1662814351262-77d332b1-8ef0-4615-803d-1cd85248acb5.png 1177w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n<a name=LBjFg></a></p>\n<h1>建立测试环境</h1>\n<p><a name=fVX78></a></p>\n<h2>插件源代码</h2>\n<p>源代码见： <a href=\"https://github.com/Jeff-Tian/keycloak-services-social-weixin\">https://github.com/Jeff-Tian/keycloak-services-social-weixin</a></p>\n<p>现在了解到不同的 Keycloak 版本可能表现不一样，为了方便测试，现在在项目代码中加入了 Dockerfile 和 docker-compose.yml 文件。这样可以随时切换不同的 Keycloak 版本。</p>\n<p><a name=DkO1n></a></p>\n<h2>Dockerfile</h2>\n<p>比如要验证 Keycloak 18，可以建立如下的 Dockerfile：</p>\n<p>dockerfile\nFROM quay.io/keycloak/keycloak:18.0.2</p>\n<p>COPY target/keycloak-services-social-weixin-0.1.1.jar /opt/keycloak/providers/</p>\n<p>CMD [start-dev, --hostname-strict=false]</p>\n<p>这里也展示了要适配 Keycloak 18，不用再像之前单独拷贝配置的 html 模板文件了。</p>\n<p><a name=o55Nc></a></p>\n<h2>docker-compose 文件</h2>\n<p>直接使用 docker run ... 的命令可以运行指定的 Keycloak 实例，但是要传递很多参数，还是有些不方便。如果能将需要的参数写在文件里就好了。其实这可以建立一个 docker-compose.yml 文件，从而每次要运行时，只需要执行 docker compose up 就可以了。这样的 docker-compose.yml 文件如下：</p>\n<p>yaml\nversion: 3</p>\n<p>services:\nkeycloak:\nbuild:\ncontext: .\ndockerfile: Dockerfile\nenvironment:\nKEYCLOAK_ADMIN: admin\nKEYCLOAK_ADMIN_PASSWORD: admin\nports:\n- 8080:8080\ncommand:\n- start-dev</p>\n<p>当然，如果你修改了 Dockerfile，需要在 docker compose up 之前，运行一下 docker compose build 。</p>\n<p>如果同时要验证多个版本的 Keycloak，可以建立多个 Dockerfile 和 docker-compose.yml。比如再建立一个 Dockerfile.19，以及 docker-compose.19.yml，并在该 yml 文件中指向 Dockerfile.19 这个文件。那么，当想启动 Keycloak 19 时，只需要 docker compose -f docker-compose.19.yml up 即可。</p>\n<p><a name=gHnm3></a></p>\n<h1>pom 文件改动</h1>\n<p>要适配 Keycloak 18，先需要在 pom 文件中把对 Keycloak 的依赖版本做个修改，如下：</p>\n<p>diff\n<modelVersion>4.0.0</modelVersion>\n<groupId>org.keycloak</groupId>\n<artifactId>keycloak-services-social-weixin</artifactId></p>\n<ul>\n<li><version>0.0.66</version></li>\n</ul>\n<ul>\n<li><version>0.1.0</version></li>\n</ul>\n<p><name>Keycloak Services Social WeiXin</name>\n<description/>\n<properties>\n&#x3C;maven.compiler.target>11&#x3C;/maven.compiler.target>\n&#x3C;maven.compiler.source>11&#x3C;/maven.compiler.source></p>\n<ul>\n<li>\n<pre><code>  &#x3C;keycloak.version>15.0.2&#x3C;/keycloak.version>\n</code></pre>\n</li>\n</ul>\n<ul>\n<li>\n<pre><code>  &#x3C;keycloak.version>18.0.2&#x3C;/keycloak.version>\n</code></pre>\n</li>\n</ul>\n</properties>\n<p><a name=bMdOd></a></p>\n<h1>模板文件的位置改动</h1>\n<p>按照之前的方式，模板文件会拷贝到  /opt/keycloak/themes/base/admin/resources/partials/realm-identity-provider-xxxx.html 这个位置，但是在 Keycloak 18 中，如果拷贝到这里，会导致 Admin Console 中出现资源找不到的错误。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a03ddaa5b71fad55bbc98c6fadb07b80/c3fd4/1662813065153-16f887d0-f522-4950-bc19-6f7dd3b78c76.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.94594594594595%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABKElEQVR42p2PzU7CQBSFZ8dSEhLjG/AjiBYtBGhpbQk0siK+BmBCIunG6Mb4psimtQ1UgrWfdmJZuYGbfDknd5Jzz4iubqH1LHqGjdJooqe+Z6I229QVFeW6yZVys0dpqFLLlRrFUpVq7ZLK+QWlck3uRL3RQdNMurqB2urI4KEzwhneUW8ZaOYA2x5g94e0Ozp67xbLHkhSPx7f4zgjDNPG7juIs2IFxbA4LRQ4yefJ5XIIIY7HfXrm5fWNxeIR13WZz+c8zGZMp1Mmk8nBCJKEbRSRju/7vK9WLJdLor/doSM2mw2e7xMEIZ7nydBUgyCQhGGmoSTzma7Xa+I43iO2u5gg2hF+fvER7Yi/E3kpSZKjEFnVRIZw3KRh2Zf/eT28WRb62/AHdDsRXQryd6oAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/a03ddaa5b71fad55bbc98c6fadb07b80/fcda8/1662813065153-16f887d0-f522-4950-bc19-6f7dd3b78c76.png\"\n        srcset=\"/static/a03ddaa5b71fad55bbc98c6fadb07b80/12f09/1662813065153-16f887d0-f522-4950-bc19-6f7dd3b78c76.png 148w,\n/static/a03ddaa5b71fad55bbc98c6fadb07b80/e4a3f/1662813065153-16f887d0-f522-4950-bc19-6f7dd3b78c76.png 295w,\n/static/a03ddaa5b71fad55bbc98c6fadb07b80/fcda8/1662813065153-16f887d0-f522-4950-bc19-6f7dd3b78c76.png 590w,\n/static/a03ddaa5b71fad55bbc98c6fadb07b80/c3fd4/1662813065153-16f887d0-f522-4950-bc19-6f7dd3b78c76.png 854w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>对应的服务器端日志是找不到 index.ftl 模板文件：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3f553f5f4d4b26beb97fb059a5d69be9/cb425/1662803485371-7e5580e6-551d-4f4f-8a5c-ac0cbaa47db2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.94594594594595%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABt0lEQVR42lWSW2/TQBCF/Q+wKtGAc0+Ec3MS+b67ttdrx60I9B/kiZS4TeAd+PUHzVhU4mE08mr2zHfO2vrz+xeez9/Qti/4cf2On7cWT09fEYchAt/HzvNwPH7B9XbD5XLhubZtcWlbPru+vuL5fMbpdOKypJTwPA9JmkJEIWLfR57nyJIEuVLQeY6iKBBFEc9Np1MMh0P0ej18dBx8uL/H+7s7vLNt2LYNKwxCbDYbNE0DYwxKY1iwrmt8Ph7RPDzweVVVOBwO3OM4xn6/x2q1xGw24wWj0YjLCsNOsCxL6KJgGhKgy7yg1LxMqQxpmrIYzbuui8VigfF4DMdxMBgM0O/3YSVJgu12yxeyLANFQJ1IqBOtMRJVlcCYAlqXTF/oAkop7HY7piRBKs6QBKMo5u2UVZwkEEIwURAGvExKASE6wiAI3uySTbL8Juj7PlsgIirOq67ZJpUuNR4fKzRNxd+VMRyL637iByK7/1kmEiIk60TEhHEMJSWfkS0lKRIfUiqkaUdPc+v1mrOcz+csxoQk0mWoOD8hJHetdff7UI5ZASkzGFPyIhJcLZdsdzKZcP8n+BfJ5iY3pbP2vgAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/3f553f5f4d4b26beb97fb059a5d69be9/fcda8/1662803485371-7e5580e6-551d-4f4f-8a5c-ac0cbaa47db2.png\"\n        srcset=\"/static/3f553f5f4d4b26beb97fb059a5d69be9/12f09/1662803485371-7e5580e6-551d-4f4f-8a5c-ac0cbaa47db2.png 148w,\n/static/3f553f5f4d4b26beb97fb059a5d69be9/e4a3f/1662803485371-7e5580e6-551d-4f4f-8a5c-ac0cbaa47db2.png 295w,\n/static/3f553f5f4d4b26beb97fb059a5d69be9/fcda8/1662803485371-7e5580e6-551d-4f4f-8a5c-ac0cbaa47db2.png 590w,\n/static/3f553f5f4d4b26beb97fb059a5d69be9/efc66/1662803485371-7e5580e6-551d-4f4f-8a5c-ac0cbaa47db2.png 885w,\n/static/3f553f5f4d4b26beb97fb059a5d69be9/c83ae/1662803485371-7e5580e6-551d-4f4f-8a5c-ac0cbaa47db2.png 1180w,\n/static/3f553f5f4d4b26beb97fb059a5d69be9/cb425/1662803485371-7e5580e6-551d-4f4f-8a5c-ac0cbaa47db2.png 1678w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>看了一下 Keycloak 18.0.2 的文档，原来主题资源有专门的文件夹了，是在 theme-resources/ 之下，虽然带来了破坏性的改动，但是的确让工程变得更加紧凑了。正如之前建立测试环境时提到的，以后要添加自定义的社交登录插件，只需要拷贝一个 jar 文件就行了，而不用再单独去拷贝模板文件，因为模板文件通过 theme-resources 打包在 jar 文件中了。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/97f9f07fa9255e21dc91aba514c24a6e/541fe/1662803318034-d9d2f059-980f-47af-a14f-9f707de7e7dc.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 36.486486486486484%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABKElEQVR42oVR2U7DMBDMr/EDSKhtGvciFMTn8sgjPHBUxE3i2w49Bu0atZV4YKWRd23PeHZdVGKB9f0jJmKJ1e0ai2UNMVtCiDnuViOMb64wHl2jnM4xnlQopzOIsoSoBNeVmDGHdOr6AYWUDZxz8N7jeDyCQmsNpXp49YygnrBLX/gvdvs9iF60XQvvHZyzMMawKD0ipUQjFYz7Rhp2iDEgxogYE1JKOQ8BIQSu214jxIRi2/VIKcJay6CwxnBujGbENCCkATFlsUsMw3DqjKJ4/dhAGQPvzoLuVzyLWhjrGNY53tPaMJRSDBoXOc6C7xu+6P1ZsOs6RtPk1mUjuW7b9gQeCZ9vmUf/cDgcULy8ff5xeEnKLg0TsjvNK7mi+QXv+Yxyav0H9vn33jxqpFUAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/97f9f07fa9255e21dc91aba514c24a6e/fcda8/1662803318034-d9d2f059-980f-47af-a14f-9f707de7e7dc.png\"\n        srcset=\"/static/97f9f07fa9255e21dc91aba514c24a6e/12f09/1662803318034-d9d2f059-980f-47af-a14f-9f707de7e7dc.png 148w,\n/static/97f9f07fa9255e21dc91aba514c24a6e/e4a3f/1662803318034-d9d2f059-980f-47af-a14f-9f707de7e7dc.png 295w,\n/static/97f9f07fa9255e21dc91aba514c24a6e/fcda8/1662803318034-d9d2f059-980f-47af-a14f-9f707de7e7dc.png 590w,\n/static/97f9f07fa9255e21dc91aba514c24a6e/efc66/1662803318034-d9d2f059-980f-47af-a14f-9f707de7e7dc.png 885w,\n/static/97f9f07fa9255e21dc91aba514c24a6e/c83ae/1662803318034-d9d2f059-980f-47af-a14f-9f707de7e7dc.png 1180w,\n/static/97f9f07fa9255e21dc91aba514c24a6e/541fe/1662803318034-d9d2f059-980f-47af-a14f-9f707de7e7dc.png 1654w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>具体来说，对于之前的配置界面模板，需要放置在项目的 resources/theme-resources/resources/partials 目录之下，比如，对于微信插件，就是：src/main/resources/theme-resources/resources/partials/realm-identity-provider-weixin-ext.html，迁移示例图如下：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 111.48648648648648%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsTAAALEwEAmpwYAAAEHUlEQVR42pWUXW/cRBSG/WMQVQVt07TJrr22x+Nve8Yfu/Z+J7vpp4JATSkRUlHFFULlAgkEvWhJkfilD7J3I9oLhLh4dM4cn3k9PrZfw4xrvOUX5O0Z8WSLp1fY2Yxh1GDGLWbcfMR1PWm2ROMNQXWCUIt+bWdzDMuVjPwY3S6JVIVMckYyxHR9TBH8Bx/3WCLAMG2BG8RMlhsSXWG6EtP1sIRPd7P/Q7fXGNqiT4JMU83XZGWNLUOGjtyJ7hkKn8E+Hn+QX0dz32fYfszQ9RkJHzursGZbcl1hy2j32K7fX3e7m7oe0pUkrkfgSry+JvuatX9swxEulm1iORZe6DOe1ui6Iis0UZpguQ6mEOSuxXx0RDU64sS6x9o6pB7dZ2Ud9jXbNhnZJsa95AFH+XP8+AEyfkgz/Yrt2SXL5TPmi4s+dtTtM0T8CC95hEwecjd/zi11yW31Tc8d9YID9QLjM/0Sq3nDUfM7B+1bnNVvFOdXFOd/ET28Qj39k+zJe9zT9wzmf3CnfYuof+Zg8oZP2itutO/4tH3HjelVj2E6NtI2yewBqT0gHg0pAp+2TJkXGdMsoc0Sljql0RlFIGhCQegLZCjxA0kYBbux2RZGP3QRMOgJGXoh9y2B3USkswlJ2aAnU4Jmwfe+zUYpktkaVTWUkxlJ3ZJWDYmucfwYo/tE+m+oe/WuZGi7JHpMsWwppw31ZIpIcrTn8evRTYQMEEHcx0GY8so6pHEdRlGG7QUYcexTKclTbbKaaubTgkL5FFmHpMwEfib5wf6cJ8GAIJPoxEUlLnHq8cvoJuvIJE4FKhUYeeYz1oJ1KbgYW2zXNdtVRVsFjJVLWfo8Ti1ei8/JtWSiXMZKUGnBIrf5SdyiVqKn6zeS2OsXs8LjeW1ydtKwXdVslhWbRcl8WfM6OOQ0MdHKo87dni4/SS1+FLdItWScu1S5wMgS2QvOC4+L2mS7HrOeKTbLksWq5jyzeSnvkl1v6k6zF3yQmLySB/9c6wTz1O+bZlrwdXnM6bJiNVX9CefTnO/EbWaZTbEX6jZ1MdceF+F9zqMBan/yXlDn3awcxrnDo0XG2bpmsyg42TRctgmXyqaqw93stOjpclVIvg3usU0tCr2bXz9D4fuEccB4NqOaLWimDeNmQhqHfCmGJEmEDH2EFHi+hycFUgpGgeSxe0wpHdxAIgOvx+hconMTJ0qJ2wJVt4S6plIF40zhJopYlcS6wu/ziiAviVPFeniMtXejawzHDzEdyUhKwpMUVU9IVEnRTMnrhqyoUdWkp6t3sRPXumSRZQy9YGewvR9KjJEXMHQ8nOkpeSdSjkmLmmLc9AJxXjDyfLq+D7G8AHMv1v2+1t5kjZ07e9iLB6hmjq4nqLrBi1IcP9o17u3937ju6Rz7b+VULHEI6iWHAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/0b35c04b6b757fbce4ef4803f031d778/fcda8/1662812452674-4d4d6505-92ef-40fb-a183-767147af1260.png\"\n        srcset=\"/static/0b35c04b6b757fbce4ef4803f031d778/12f09/1662812452674-4d4d6505-92ef-40fb-a183-767147af1260.png 148w,\n/static/0b35c04b6b757fbce4ef4803f031d778/e4a3f/1662812452674-4d4d6505-92ef-40fb-a183-767147af1260.png 295w,\n/static/0b35c04b6b757fbce4ef4803f031d778/fcda8/1662812452674-4d4d6505-92ef-40fb-a183-767147af1260.png 590w,\n/static/0b35c04b6b757fbce4ef4803f031d778/efc66/1662812452674-4d4d6505-92ef-40fb-a183-767147af1260.png 885w,\n/static/0b35c04b6b757fbce4ef4803f031d778/c83ae/1662812452674-4d4d6505-92ef-40fb-a183-767147af1260.png 1180w,\n/static/0b35c04b6b757fbce4ef4803f031d778/53639/1662812452674-4d4d6505-92ef-40fb-a183-767147af1260.png 1358w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n<a name=FymaU></a></p>\n<h1></h1>\n<p><a name=zQASM></a></p>\n<h1>Dockferfile 简化</h1>\n<p>如同之前提到的，可以删除拷贝模板文件的代码了，只保留 jar 文件的拷贝即可。同时留意所有带 jboss 路径的目录，需要删除 jboss。因为 Keycloak 18 不再基于 jboss。</p>\n<p>diff\nCOPY idps/wechat-mobile/keycloak-services-social-weixin.jar</p>\n<ul>\n<li>/opt/jboss/keycloak/providers/</li>\n</ul>\n<ul>\n<li>/opt/keycloak/providers/</li>\n</ul>\n<ul>\n<li>\n<p>COPY idps/wechat-mobile/templates/realm-identity-provider-weixin-ext.html</p>\n</li>\n<li>\n<p>/opt/jboss/keycloak/themes/base/admin/resources/partials</p>\n</li>\n<li>\n<p>COPY idps/wechat-mobile/templates/realm-identity-provider-weixin.html</p>\n</li>\n<li>\n<p>/opt/jboss/keycloak/themes/base/admin/resources/partials</p>\n</li>\n</ul>\n<p>Dockerfile 中只需要拷贝一个 jar 文件即可。但是在运行 Dockerfile 之前，要记得 mvn clean package以生成最新的 jar 文件以供 docker build 时拷贝。\n<a name=ZOk0k></a></p>\n<h1>验证效果</h1>\n<p>docker compose up 在本地启动  Keycloak  18.0.2，添加自定义身份提供程序，选择“微信”，出现配置界面，即之前的 404 的问题被解决了。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/64f1426ec58f69519380141319be8f3f/252a4/1662813568695-c3bcdafd-7b62-402e-9756-e6a00437c485.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.21621621621621%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACUUlEQVR42p2Sa08TQRSG9xP+ADVRoQUTCAkUur3R0hsgQY3xL2pMkIL6M/xkTNSYaAQBSUsvbCl7m730+pidso1Gv+gkT868O7NvzplzlPLWQ3LrRfKFMuWNLWKJLGoiTSKZYTWeJJnKkEimKRbLpFJr8tvScpy4mmJpaYXYiir3aixGNqmirOZLzExPc/PWbaambsg4NzdHNBqdEIlEJjEkvCN1cC8yw2w0gpLIFFiMJVlWM9ybXeDZ8xcIIWg0GrRaTTqdKyzLwjRNSbDXdZ3TkxNarQts256cGaaJksqWiKfzqJkC0/cXqRy8IViBqed5+L5Pt9uVMSTQ7XYb0zLp9XqEazAYoCSzJbKFLdR0njuReXb39uWhaRgIYSNsW2YREuoLrU2v12cwGDIYDhmOwPN8lNXUujQLmiENKwdjw+Bn10W4HsLzcHxfInyfXr+P2dFg2L3ObTTOsN9F2dx5wvajp5S3H7OwGOPVywr4Hla9jtOo49aqOGc/sL8fYR9+w/3yGe3wlLdHOu+qPT424UNzxPsGnF16KIm1IsXNHXKlB7Ipe3vXGeo6jmUhDINOq0Xr/JxWrYZWq9Koa3w60/na9DnV4bgz4vgKqpo1LnlZXRuXHP2lZMvCcRxEiCzfRTiu1J1Lja7nAEMYDWR0XRcleL+VZE6a3p1dYDfM0DRlpwNTiRATbdoCTTfpmDaGcDFsB912MGwxLjmVK40No38a/g3HEbiOI3GudYiSXt/4zXBv/7U0DGYtmKt/Rb5hUHJMGs5TOXg9GdL/WT8BDq8c8Ts342EAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/64f1426ec58f69519380141319be8f3f/fcda8/1662813568695-c3bcdafd-7b62-402e-9756-e6a00437c485.png\"\n        srcset=\"/static/64f1426ec58f69519380141319be8f3f/12f09/1662813568695-c3bcdafd-7b62-402e-9756-e6a00437c485.png 148w,\n/static/64f1426ec58f69519380141319be8f3f/e4a3f/1662813568695-c3bcdafd-7b62-402e-9756-e6a00437c485.png 295w,\n/static/64f1426ec58f69519380141319be8f3f/fcda8/1662813568695-c3bcdafd-7b62-402e-9756-e6a00437c485.png 590w,\n/static/64f1426ec58f69519380141319be8f3f/efc66/1662813568695-c3bcdafd-7b62-402e-9756-e6a00437c485.png 885w,\n/static/64f1426ec58f69519380141319be8f3f/c83ae/1662813568695-c3bcdafd-7b62-402e-9756-e6a00437c485.png 1180w,\n/static/64f1426ec58f69519380141319be8f3f/252a4/1662813568695-c3bcdafd-7b62-402e-9756-e6a00437c485.png 1314w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 54.72972972972974%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABm0lEQVR42oWR3U6DQBCFeSDp8tNiU1OvbEy8Mj5o34DYGovPoQHRhpa2sHSh0GPO2jUxRiX5MrDDnDk7YwXDMQbBCKOLSzj+EK4XwHX78PwAQngQTh+TqwkmV9cYnI/h94cIzkcQ7gA9dwDh+Joz24Hdc2GF9w8I7+cIwxCz2RyL6AmPUYRHxkWE2XyOKIownU5xc3uH8fgSnufD7gkI4UAIEx2c2Tasw+GAtm3x36OaBlmeY7vbQUqJulZQ6pP9fq/hu7XZbJDnOaqqQllVqN7foF6eodIEiu/Ld6gswyZ9xS7LoIoCtVIwRrquw/F4/MIyyvqg69AB32FR00BJiXWWoZISsiyx3W41rG+aRlPXNSza5yE7saOG3U8O2q7DoW11UwooVetiOjQ1jAaLV5Wy+pEwmHOKcDxkuVwijmMkCUkQx4mOzOkrl2X51fE3KMjb0Ol6vUaaplitVnr+hGLMfwpK+acgXXI+FGIRb1UUhTbCBswRvWUm+fGXu/Y0Qwqa/+n429xPaEEmueX/BLkUOqQ7RrNZs2XyAUhvEQY99+oIAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/693fbd2f387f6cf8f61296570e2b08c5/fcda8/1662813639259-0023ce83-b667-4267-9649-a900f80c2081.png\"\n        srcset=\"/static/693fbd2f387f6cf8f61296570e2b08c5/12f09/1662813639259-0023ce83-b667-4267-9649-a900f80c2081.png 148w,\n/static/693fbd2f387f6cf8f61296570e2b08c5/e4a3f/1662813639259-0023ce83-b667-4267-9649-a900f80c2081.png 295w,\n/static/693fbd2f387f6cf8f61296570e2b08c5/fcda8/1662813639259-0023ce83-b667-4267-9649-a900f80c2081.png 590w,\n/static/693fbd2f387f6cf8f61296570e2b08c5/efc66/1662813639259-0023ce83-b667-4267-9649-a900f80c2081.png 885w,\n/static/693fbd2f387f6cf8f61296570e2b08c5/c83ae/1662813639259-0023ce83-b667-4267-9649-a900f80c2081.png 1180w,\n/static/693fbd2f387f6cf8f61296570e2b08c5/cd213/1662813639259-0023ce83-b667-4267-9649-a900f80c2081.png 1753w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n<a name=uEMjb></a></p>\n<h1>Keycloak 19</h1>\n<p>遗憾的是，上面的方法，对于 Keycloak 19 不适用。Keycloak 19 带来了更大的更新，看起来 Keycloak 抛弃了我曾经吐槽过的 angular js，而是用 React 新写了 Keycloak 2 主题。之前多数的插件模板都是基于 angular js 写的，所以肯定在新的界面上不适用了。但是即使将 Realm 设置中的主题设置回 Keycloak 1，在添加自定义身份认证程序时，仍然会出现 404 页面。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e8d34d8a3232b70dd863b50439d4d30b/33d1d/1662813996691-5771295f-351f-434e-865f-5eedb5083936.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 70.27027027027026%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACgElEQVR42pWSTU8aURSGZ6fuXdQvEBAEPxEEtTWtTTQu2iZW06S/wB0u/Cn9Md30TzS1VRstiGisYWAYhvmeO08z12hKdONN3tx7z9w85z1njpKIx8nmC6xvbTOby5JOpxkeHmZoaIiBgQEGBwefJSUWnySWTJHKZInF4oyOjZNIptjf3+fw8JCDgwMqlYrc/1elche//3Z/VtLZGaans4yMjjE+EePFyCillTWur69ptVp4nsdzlpKbW2R2IU8ynWUqkyOenKJYWuXs7Axd19E0DcMw5Lnb7WJ0u+g9E1Xv0dENuvdxw5BS5vNF8oUS8WRaQicmUywtl7m4uJAZXddFVVUJbrfbaL0e2tUVzZsm7a4pY3fS5BvpMHI0M79IYmr6ETAIAnzPIxCCAPAbl4jTX2DoIAL8ICDwffkukjIzn5fATG7uAVhYXqFarcoSOp0OIeCZJtbxT7i9kXeh64gQwjDskzK7sEQE7S95hVq1Jss1LIug3cL7c4apqviR63aLQO8QhGGfO+lwbrFAsbzKZCrzAIwcnldrsuHq6QnGRQ3HcdF7PQkQV5eIIEAI8UjSYb5Y6gMulVc5Pz4m+HuD09FwfB/TdtEsD1vVcC4bWCHYrsDywj4pqXSWVCZHLDFFPJVhLJZgdalI/egIx7YwbVv+HLNn0tR03N8nOGpTJnFsG8dx+qQUyi9Ze/WayOlc5DY3y8b6G2r1uhxqy7IIQxCejdG6xYhgjiPjT0l5t/uZj7uf+LCzx+bWNhtvN3m/s0fjsiGdRbBoff3R5su3Kzqmi+P6T/ZP9lDOYXmN+cUCiXSW8fs5rNfv5lAIuVebDt8bFp4v8AMhM4VP6B9RozcLpYtQ5QAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/e8d34d8a3232b70dd863b50439d4d30b/fcda8/1662813996691-5771295f-351f-434e-865f-5eedb5083936.png\"\n        srcset=\"/static/e8d34d8a3232b70dd863b50439d4d30b/12f09/1662813996691-5771295f-351f-434e-865f-5eedb5083936.png 148w,\n/static/e8d34d8a3232b70dd863b50439d4d30b/e4a3f/1662813996691-5771295f-351f-434e-865f-5eedb5083936.png 295w,\n/static/e8d34d8a3232b70dd863b50439d4d30b/fcda8/1662813996691-5771295f-351f-434e-865f-5eedb5083936.png 590w,\n/static/e8d34d8a3232b70dd863b50439d4d30b/efc66/1662813996691-5771295f-351f-434e-865f-5eedb5083936.png 885w,\n/static/e8d34d8a3232b70dd863b50439d4d30b/33d1d/1662813996691-5771295f-351f-434e-865f-5eedb5083936.png 1150w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>通过查看 GitHub 上相关的讨论，发现 Keycloak 开发小组对此问题还没有达成一致，对于如何升级此关注公众号即登录插件以适配 Keycloak 19，未来再研究和分享。</p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}},"menus":{}}},"staticQueryHashes":[],"slicesMap":{}}