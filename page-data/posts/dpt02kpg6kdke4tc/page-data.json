{"componentChunkName":"component---src-templates-post-js","path":"/posts/dpt02kpg6kdke4tc/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/dpt02kpg6kdke4tc","relativePath":"posts/dpt02kpg6kdke4tc","frontmatter":{"title":"在 Cypress 中使用 cookie 登录站点实现自动化","stackbit_url_path":"posts/dpt02kpg6kdke4tc","date":"2023-06-28T09:41:14","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p><a name=QjTnl></a></p>\n<h1>问题</h1>\n<p><a name=tDpYe></a></p>\n<h2>自动化测试</h2>\n<p>有的团队使用 Cypress 对站点进行自动化测试，但是很多场景是用户在登录态下进行的，需要首先解决登录问题。尽管预先注册账号，并将密码保存在一个安全的地方，在运行测试时动态获取，然后操作页面模拟用户登录。但是一般登录页面都会带上防机器人的脚本，直接阻止这样的自动化登录。比如有的网站使用了 WAF 服务商提供的 js 脚本，其工作原理见《<a href=\"https://zhuanlan.zhihu.com/p/623558956\">网络应用防火墙（WAF）防机器刷流量的工作原理，以登录举例 - Jeff Tian的文章 - 知乎 </a> 》。</p>\n<p>尽管有些像黑客行为，但我仍然想提及接下来的解决方案。该方案要求正常人类用户先手动登录站点，获得 Cookie，然后在自动化脚本中直接使用该 Cookie 访问目标站点，从而直接进入登录态。</p>\n<p><a name=cSQS0></a></p>\n<h1>可能的解决方案</h1>\n<p>除了使用 Cookie 登录的方案，还有其他的方案。并且由于开发量较大，一般不建议使用该 Cookie 登录的方案。之所以列出来，一是因为有时候不得已时可以考虑；二是因为由于别的场景中已经实现了该方案，只不过正好也可以用来解决自动化测试的问题。所以，尽管开发量较大，但并不是为了自动化测试而专门开发的，于是边际成本变小了。\n<a name=vYj9l></a></p>\n<h2>一、使用特殊的 HTTP 标头</h2>\n<p>在目标站点的代码里，做一个小改动。当检测到请求头里有一个特殊的字段，并且其值为允许的值时（比如 X-Internal=a-jwt-token），直接放行，不要应用机器人检测。<br />这个方案改动量很小，比如：\njavascript\n// 如果头部 X-Internal 存在并且包含有效的访问令牌，则绕过机器人检测分析。\nif (request.headers[X-Internal]) {\nif (await validateInternalAuthToken(request, request.headers[X-Internal][0].value, lambdaContext, requestId))\nreturn request;\nelse\nreturn buildBlockResponse(request, requestId);\n}</p>\n<p>但是它要求允许的测试客户端小心地保存这个秘密值。不过，就算客户端保存得很好，但终究需要明文传输，总有可能会被暴露。</p>\n<p><a name=Lvl6t></a></p>\n<h2>二、IP 白名单</h2>\n<p>这能轻而易举地解决问题，但是给服务器侧维护这个白名单带来了工作量，尤其当 IP 可能变化时。</p>\n<p><a name=O7j5c></a></p>\n<h2>三、给目标站点添加多个入口域名，在内部域名访问时，去除机器人检测</h2>\n<p>可以给站点一个公开域名，以及一个内部域名。内部域名只能使用 VPN 访问，相当于是内网环境，不用检测机器人。而对于公开域名，可以通过某些 DNS 服务来动态添加机器人检测脚本（比如 Cloudflare 这样的提供商）。<br />自动化测试使用内部域名来做。\n<a name=SDNiB></a></p>\n<h1>Cookie 登录方案</h1>\n<p>有时候因为各种原因，以上可能的解决方案都不能用，那么可以考虑使用 Cookie 登录。这有点通过社会化工程，窃取终端用户的 Cookie，从而实现登录态。\n<a name=ogkWz></a></p>\n<h2>前情提要</h2>\n<p>最早在《<a href=\"https://www.zhihu.com/zvideo/1540033340190490624\">如何优雅地将 markdown 文档同步到知乎专栏（叽歪同步工具介绍） - Jeff Tian的视频 - 知乎 </a> 》以及《<a href=\"https://www.zhihu.com/zvideo/1542496376025296896\">如何优雅地将 markdown 文档同步到知乎专栏（叽歪同步工具介绍之有头模式） - Jeff Tian的视频 - 知乎 </a> 》中提到的“叽歪同步工具”自动化发布知乎专栏，就是使用了这个方案。由于该视频的点赞量还没有到 1000，所以并未开源整个解决方案。不过，今天会公开一下架构图和核心代码，因为它的用处不局限于自动化发布知乎专栏。</p>\n<p><a name=IYnzg></a></p>\n<h2>如何获取用户 Cookie？</h2>\n<p>如果是浏览器登录，一般可以通过 F12 打开开发者工具栏看到 Cookie：<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.16216216216216%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABQklEQVR42m2QW2+DMAyF+f+/adKe97Bp06T1Ai3lEkIC4doWEqBnshnSJs2SFceSP/scbxgGOOdgrcU8z1iWBVLmMFUFax1krlA1LZq2g9IlUqkQC4kwinEMzpBKQ2kNIRVUYeDhnzDGoGtbrnOlGeamCQf/hIMfQOkCaSaxPwbIcoWm6xkscw3v8XjwIL1bnYoMIpM/wIKBo3XY+wH8U8jDBHr7+ESUCHT9de1JtQKnecGyrLB5AZ7fczy9pnjxr/AjjbquMYwW50vMUnVpGHiJE5SmQt20fB3Z45FnJIfeLRKhsDsEuA0OmSp4aBhHxKngK0gyAUk2XU+5SlZ/Pdwka62QxDF12MMVaBGcLwijBKooGUjyqW67nv+U3ubdbw8zKfG12+F+H1CYigesm1jyKYx4AV2ZiAymqtHfbtyj5d/texJrq9ir7wAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/21cc379af64ee9a5a8e90e2e16a6b6e9/fcda8/1687944907723-74066688-e918-462a-b534-aa1dd7017dd9.png\"\n        srcset=\"/static/21cc379af64ee9a5a8e90e2e16a6b6e9/12f09/1687944907723-74066688-e918-462a-b534-aa1dd7017dd9.png 148w,\n/static/21cc379af64ee9a5a8e90e2e16a6b6e9/e4a3f/1687944907723-74066688-e918-462a-b534-aa1dd7017dd9.png 295w,\n/static/21cc379af64ee9a5a8e90e2e16a6b6e9/fcda8/1687944907723-74066688-e918-462a-b534-aa1dd7017dd9.png 590w,\n/static/21cc379af64ee9a5a8e90e2e16a6b6e9/efc66/1687944907723-74066688-e918-462a-b534-aa1dd7017dd9.png 885w,\n/static/21cc379af64ee9a5a8e90e2e16a6b6e9/c83ae/1687944907723-74066688-e918-462a-b534-aa1dd7017dd9.png 1180w,\n/static/21cc379af64ee9a5a8e90e2e16a6b6e9/7f486/1687944907723-74066688-e918-462a-b534-aa1dd7017dd9.png 3010w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span><br />对于自动化测试来说，你自己正常登录后，将 Cookie 手动保存下来即可。对于其他场景，你可能需要自已做一个站点，来收集用户的 Cookie。《<a href=\"https://www.zhihu.com/zvideo/1518236539352440833\">扫二维码登录一定安全吗？ - Jeff Tian的视频 - 知乎 </a> 》中有提到我开发的一个收集知乎 Cookie 的站点。</p>\n<p><a name=oGefs></a></p>\n<h2>架构图</h2>\n<p>大致如下：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 65.54054054054055%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA4klEQVR42oWS266EIAxF/f/fNMY3BYGBXigncWdwdHTOetBYWYXuMLQdO1NrJaJSiqraHbAGvHSnvhGR185nEWDlSa619n79LOu6hhDaGZzruvNFbq3N87wsy7d87IwPPHtLMxMRZiaiXkS97DDzIWM8IvLe55xrrSmlcRynaeIdImJmEdm2zTkXYzxkEVHVUkoIgZmRGWDmGKP3PqWEZRjbzIb2gKp674noUoeGgB5lMyOins0tQ08fIfXGiAD35JfMzAgsxphz7imEEJxzn2nfyMjje+Z+Vf859tPYT78g/wFwCgFXBsEP7gAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/e37a4049c2a7207b38f15f731de66a66/fcda8/1687945069574-a4fff620-cbf0-4092-87c3-72189dc3e7a0.png\"\n        srcset=\"/static/e37a4049c2a7207b38f15f731de66a66/12f09/1687945069574-a4fff620-cbf0-4092-87c3-72189dc3e7a0.png 148w,\n/static/e37a4049c2a7207b38f15f731de66a66/e4a3f/1687945069574-a4fff620-cbf0-4092-87c3-72189dc3e7a0.png 295w,\n/static/e37a4049c2a7207b38f15f731de66a66/fcda8/1687945069574-a4fff620-cbf0-4092-87c3-72189dc3e7a0.png 590w,\n/static/e37a4049c2a7207b38f15f731de66a66/efc66/1687945069574-a4fff620-cbf0-4092-87c3-72189dc3e7a0.png 885w,\n/static/e37a4049c2a7207b38f15f731de66a66/c83ae/1687945069574-a4fff620-cbf0-4092-87c3-72189dc3e7a0.png 1180w,\n/static/e37a4049c2a7207b38f15f731de66a66/cd78c/1687945069574-a4fff620-cbf0-4092-87c3-72189dc3e7a0.png 1236w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n<a name=lo09y></a></p>\n<h2>核心代码</h2>\n<p>Cypress 启动时，禁用浏览器安全：\njavascript\nconst {defineConfig} = require(cypress);</p>\n<p>module.exports = defineConfig({\nchromeWebSecurity: false,\n...\n}</p>\n<p>运行测试用例前，获取 Cookie：\njavascript\ndescribe(feature, ()=> {\nlet cookie</p>\n<p>before(() => {<br>\ncy.request(\nPOST,\nTHE_PROXY_API_FOR_GET_COOKIE,\n{\nquery: a graphql request body,\nvariables: {key: user-cookie-60808105033728}\n}\n).then((response) => {\ncookie = JSON.parse(response.body.data.cookie);\n})\n})</p>\n<p>it(should login automatically and do stuff, () => {\nlogin(cookie);\n...\n})\n})</p>\n<p>使用 Cookie 登录：\njavascript\nfunction login(cookie) {\n// 一开始未登录\ncy.visit(<a href=\"https://www.the.site\">https://www.the.site</a>)\ncy.clearCookies();\nCypress.Cookies.debug(true) // Cypress 替换 Cookie 时，会打印日志显示出来</p>\n<pre><code>JSON.parse(cookie).data.map(item => {\n    const cookie = Cookie.parse(item);\n\n    cy.setCookie(cookie.key, cookie.value, {\n        expiry: (!!cookie.expires &#x26;&#x26; cookie.expires !== Infinity) ? new Date(cookie.expires).getTime() / 1000 : undefined,\n        path: cookie.path,\n        domain: cookie.domain ? cookie.domain : undefined,\n        secure: cookie.secure,\n    })\n});\n\n// 现在是登录态了\ncy.visit(https://www.the.site)\n</code></pre>\n<p>}</p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}},"menus":{}}},"staticQueryHashes":[],"slicesMap":{}}