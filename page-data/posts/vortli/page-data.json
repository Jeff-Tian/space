{"componentChunkName":"component---src-templates-post-js","path":"/posts/vortli/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/vortli","relativePath":"posts/vortli","frontmatter":{"title":"OAuth 2.0：对接 Keycloak 设备码授权流程","stackbit_url_path":"posts/vortli","date":"2022-03-26T14:46:00","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p><a name=gtd4B></a></p>\n<h1>源代码</h1>\n<p><a href=\"https://github.com/jeff-tian/k8ss\">https://github.com/jeff-tian/k8ss</a>\n<a name=CjH9v></a></p>\n<h1>最终效果体验</h1>\n<p>本文以一个 nodejs 编写的命令行程序为例，详解了如何对接 Keycloak 的设备码授权登录流程。要体验，需要在安装了 nodejs 的环境里执行如下命令：\nshell\nnpm i -g k8ss\nk8ss login</p>\n<p>按照提示打开浏览器，并输入授权码，点击同意授权，关闭浏览器并回到命令行，便进入了登录态。</p>\n<p>整个过程的命令行输出如下所示，请关注“哈德韦”，跟踪后续视频演示和讲解。\nshell\nC:Usersjeffk8ss>npm i -g k8ss\nC:Usersjeffemsdknode14.18.2_64bitbink8ss -> C:Usersjeffemsdknode14.18.2_64bitbinnode_modulesk8sslibindex.js</p>\n<blockquote>\n<p><a href=\"mailto:k8ss@1.8.0\">k8ss@1.8.0</a> postinstall C:Usersjeffemsdknode14.18.2_64bitbinnode_modulesk8ss\necho Thanks for using k8ss!</p>\n</blockquote>\n<p>Thanks for using k8ss!</p>\n<ul>\n<li><a href=\"mailto:k8ss@1.8.0\">k8ss@1.8.0</a></li>\n</ul>\n<p>added 56 packages from 30 contributors in 41.292s</p>\n<p>C:Usersjeffk8ss>k8ss login\nlogging in...\ngetting user code and device code...\ncodes =  {\ndevice_code: 2FcwVn-ign8W93NVF6Wxe0Ippr2FBx4q5lVoKsREs-4,\nuser_code: ONKI-BWZU,\nverification_uri: <a href=\"https://keycloak.jiwai.win/auth/realms/UniHeart/device\">https://keycloak.jiwai.win/auth/realms/UniHeart/device</a>,\nverification_uri_complete: <a href=\"https://keycloak.jiwai.win/auth/realms/UniHeart/device?user_code=ONKI-BWZU\">https://keycloak.jiwai.win/auth/realms/UniHeart/device?user_code=ONKI-BWZU</a>,\nexpires_in: 600,\ninterval: 600\n}\n请打开浏览器并浏览至：  <a href=\"https://keycloak.jiwai.win/auth/realms/UniHeart/device\">https://keycloak.jiwai.win/auth/realms/UniHeart/device</a>  , 然后在打开的页面中输入  ONKI-BWZU</p>\n<p>等待输入授权码……\n开始查询登录结果……\n本次查询令牌的结果是：  {\naccess_token: eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI2Vk8wUU5Ka0hTWnlEN1BlSTU3VVZZd0NkX3ZvXzZxbS14eWtLbThpdWhnIn0.eyJleHAiOjE2NDgzMDYwNTAsImlhdCI6MTY0ODMwNTc1MCwiYXV0aF90aW1lIjoxNjQ4MzAwMzM1LCJqdGkiOiI5NmFlMmUzNy1hYTM5LTRlYTUtODg1Ny1lYzQ5YzBjYTY5ZjciLCJpc3MiOiJodHRwczovL2tleWNsb2FrLmppd2FpLndpbi9hdXRoL3JlYWxtcy9VbmlIZWFydCIsImF1ZCI6ImFjY291bnQiLCJzdWIiOiIyNWJkYzE4My1jMTQ1LTQ5NWItOThmZS1lOThiNWU0NzlkNDgiLCJ0eXAiOiJCZWFyZXIiLCJhenAiOiJkZW1vYXBwIiwic2Vzc2lvbl9zdGF0ZSI6IjdjYjNkOTdiLTMwM2ItNDg1Yi1iODM0LWJlYTMyYTc2MGFlYyIsImFjciI6IjAiLCJyZWFsbV9hY2Nlc3MiOnsicm9sZXMiOlsiZGVmYXVsdC1yb2xlcy11bmloZWFydCIsIm9mZmxpbmVfYWNjZXNzIiwidW1hX2F1dGhvcml6YXRpb24iXX0sInJlc291cmNlX2FjY2VzcyI6eyJkZW1vYXBwIjp7InJvbGVzIjpbInZpc2l0b3IiXX0sImFjY291bnQiOnsicm9sZXMiOlsibWFuYWdlLWFjY291bnQiLCJtYW5hZ2UtYWNjb3VudC1saW5rcyIsInZpZXctcHJvZmlsZSJdfX0sInNjb3BlIjoiZW1haWwgcHJvZmlsZSIsInNpZCI6IjdjYjNkOTdiLTMwM2ItNDg1Yi1iODM0LWJlYTMyYTc2MGFlYyIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJnZW5kZXIiOiIxIiwibmFtZSI6ImRhaGEg5ZOI5b636Z-mIiwicHJlZmVycmVkX3VzZXJuYW1lIjoidGlhbmppZSIsImdpdmVuX25hbWUiOiJkYWhhIiwiZmFtaWx5X25hbWUiOiLlk4jlvrfpn6YiLCJlbWFpbCI6ImRhaGFAaGR3OS53ZWNvbS53b3JrIn0.eVB5UES-wgsJ3Bw6NIQfCQLsiHoiRpno5ihKsA7_daNqTWtaF5juUOIxEiEKbUt19MDSODlepagBziYc-W7qLRrZDA2kWkyZSNjUplfnO6cpI9h92foxofkrq6G-EKok56y4u2NrzMpANEoJSzKRyQh8a_-tW5WUE-XHc4N7kshfIQM4BT7qgP6uHxZKC3RF-gM5mAuPLJYQb-0H70iX6LEd4gIRiCvW7DvF6zzaCrIooti0mf8sfCqW-bAvP3L2IKBIT30nnhyivE702CoawtoPLcxOXaKPWHkSg73O9kZO-4yFBPpDTsN_1HPA4UL5NZIU5ObCe971t1UUn6abrw,\nexpires_in: 300,\nrefresh_expires_in: 1800,\nrefresh_token: eyJhbGciOiJIUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI1NTlkMDM3ZC1kOGYwLTQ2ZDUtOTA5OS01YmFhMWU0NjllYmEifQ.eyJleHAiOjE2NDgzMDc1NTAsImlhdCI6MTY0ODMwNTc1MCwianRpIjoiMmZiODJhZDMtZjNlOS00ZDA3LWE0NzAtZjQyMDQ1Y2FiZDU1IiwiaXNzIjoiaHR0cHM6Ly9rZXljbG9hay5qaXdhaS53aW4vYXV0aC9yZWFsbXMvVW5pSGVhcnQiLCJhdWQiOiJodHRwczovL2tleWNsb2FrLmppd2FpLndpbi9hdXRoL3JlYWxtcy9VbmlIZWFydCIsInN1YiI6IjI1YmRjMTgzLWMxNDUtNDk1Yi05OGZlLWU5OGI1ZTQ3OWQ0OCIsInR5cCI6IlJlZnJlc2giLCJhenAiOiJkZW1vYXBwIiwic2Vzc2lvbl9zdGF0ZSI6IjdjYjNkOTdiLTMwM2ItNDg1Yi1iODM0LWJlYTMyYTc2MGFlYyIsInNjb3BlIjoiZW1haWwgcHJvZmlsZSIsInNpZCI6IjdjYjNkOTdiLTMwM2ItNDg1Yi1iODM0LWJlYTMyYTc2MGFlYyJ9.zEicrh0magZh8Az_HLNWrU0Vfu_qUUgHhioa0cq273M,\ntoken_type: Bearer,\nnot-before-policy: 1646995770,\nsession_state: 7cb3d97b-303b-485b-b834-bea32a760aec,\nscope: email profile\n}\n最终轮询结果是：  {\naccess_token: eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI2Vk8wUU5Ka0hTWnlEN1BlSTU3VVZZd0NkX3ZvXzZxbS14eWtLbThpdWhnIn0.eyJleHAiOjE2NDgzMDYwNTAsImlhdCI6MTY0ODMwNTc1MCwiYXV0aF90aW1lIjoxNjQ4MzAwMzM1LCJqdGkiOiI5NmFlMmUzNy1hYTM5LTRlYTUtODg1Ny1lYzQ5YzBjYTY5ZjciLCJpc3MiOiJodHRwczovL2tleWNsb2FrLmppd2FpLndpbi9hdXRoL3JlYWxtcy9VbmlIZWFydCIsImF1ZCI6ImFjY291bnQiLCJzdWIiOiIyNWJkYzE4My1jMTQ1LTQ5NWItOThmZS1lOThiNWU0NzlkNDgiLCJ0eXAiOiJCZWFyZXIiLCJhenAiOiJkZW1vYXBwIiwic2Vzc2lvbl9zdGF0ZSI6IjdjYjNkOTdiLTMwM2ItNDg1Yi1iODM0LWJlYTMyYTc2MGFlYyIsImFjciI6IjAiLCJyZWFsbV9hY2Nlc3MiOnsicm9sZXMiOlsiZGVmYXVsdC1yb2xlcy11bmloZWFydCIsIm9mZmxpbmVfYWNjZXNzIiwidW1hX2F1dGhvcml6YXRpb24iXX0sInJlc291cmNlX2FjY2VzcyI6eyJkZW1vYXBwIjp7InJvbGVzIjpbInZpc2l0b3IiXX0sImFjY291bnQiOnsicm9sZXMiOlsibWFuYWdlLWFjY291bnQiLCJtYW5hZ2UtYWNjb3VudC1saW5rcyIsInZpZXctcHJvZmlsZSJdfX0sInNjb3BlIjoiZW1haWwgcHJvZmlsZSIsInNpZCI6IjdjYjNkOTdiLTMwM2ItNDg1Yi1iODM0LWJlYTMyYTc2MGFlYyIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJnZW5kZXIiOiIxIiwibmFtZSI6ImRhaGEg5ZOI5b636Z-mIiwicHJlZmVycmVkX3VzZXJuYW1lIjoidGlhbmppZSIsImdpdmVuX25hbWUiOiJkYWhhIiwiZmFtaWx5X25hbWUiOiLlk4jlvrfpn6YiLCJlbWFpbCI6ImRhaGFAaGR3OS53ZWNvbS53b3JrIn0.eVB5UES-wgsJ3Bw6NIQfCQLsiHoiRpno5ihKsA7_daNqTWtaF5juUOIxEiEKbUt19MDSODlepagBziYc-W7qLRrZDA2kWkyZSNjUplfnO6cpI9h92foxofkrq6G-EKok56y4u2NrzMpANEoJSzKRyQh8a_-tW5WUE-XHc4N7kshfIQM4BT7qgP6uHxZKC3RF-gM5mAuPLJYQb-0H70iX6LEd4gIRiCvW7DvF6zzaCrIooti0mf8sfCqW-bAvP3L2IKBIT30nnhyivE702CoawtoPLcxOXaKPWHkSg73O9kZO-4yFBPpDTsN_1HPA4UL5NZIU5ObCe971t1UUn6abrw,\nexpires_in: 300,\nrefresh_expires_in: 1800,\nrefresh_token: eyJhbGciOiJIUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI1NTlkMDM3ZC1kOGYwLTQ2ZDUtOTA5OS01YmFhMWU0NjllYmEifQ.eyJleHAiOjE2NDgzMDc1NTAsImlhdCI6MTY0ODMwNTc1MCwianRpIjoiMmZiODJhZDMtZjNlOS00ZDA3LWE0NzAtZjQyMDQ1Y2FiZDU1IiwiaXNzIjoiaHR0cHM6Ly9rZXljbG9hay5qaXdhaS53aW4vYXV0aC9yZWFsbXMvVW5pSGVhcnQiLCJhdWQiOiJodHRwczovL2tleWNsb2FrLmppd2FpLndpbi9hdXRoL3JlYWxtcy9VbmlIZWFydCIsInN1YiI6IjI1YmRjMTgzLWMxNDUtNDk1Yi05OGZlLWU5OGI1ZTQ3OWQ0OCIsInR5cCI6IlJlZnJlc2giLCJhenAiOiJkZW1vYXBwIiwic2Vzc2lvbl9zdGF0ZSI6IjdjYjNkOTdiLTMwM2ItNDg1Yi1iODM0LWJlYTMyYTc2MGFlYyIsInNjb3BlIjoiZW1haWwgcHJvZmlsZSIsInNpZCI6IjdjYjNkOTdiLTMwM2ItNDg1Yi1iODM0LWJlYTMyYTc2MGFlYyJ9.zEicrh0magZh8Az_HLNWrU0Vfu_qUUgHhioa0cq273M,\ntoken_type: Bearer,\nnot-before-policy: 1646995770,\nsession_state: 7cb3d97b-303b-485b-b834-bea32a760aec,\nscope: email profile\n}\n登录成功！</p>\n<p><a name=AtdMY></a></p>\n<h1>科普</h1>\n<p>OAuth 2.0 是现在被广泛使用的开放授权协议，它通过一些授权许可类型，为第三方软件（客户端）颁发用户的访问令牌。第三方软件（客户端）拿到访问令牌后，就可以使用该令牌，去资源服务器获取用户的信息。</p>\n<p>这个令牌是 jwt 格式，因为 jwt 有内检机制，可以省去服务器端的存储，使用计算（时间）换取空间，因此使用起来更方便。但是服务器端仍然可以存储一些信息，以便做更复杂的控制。因为 jwt 一旦颁发就覆水难收了。</p>\n<p>刚才说了，使用 OAuth 2.0 协议，第三方软件（客户端）最终会获取到一个访问令牌来获取用户信息，但是获取令牌的方式有多种，这些方式即被称为授权许可类型。常见的授权许可类型如下：</p>\n<ul>\n<li><strong>授权码许可</strong>，它是通过授权码 code 获取用户级别的访问令牌。这是很常见的授权许可类型，在各种社交登录的场合会遇见。比如对接微信登录，在浏览器的跳转过程中，你就会见到 code 以 url 参数形式传递。在微信小程序里，也会有一个 code2session 接口，这里的 code，也是一种授权码，只是它用来换取用户和微信的 session 信息，算是授权码许可的一个小小变形，原因是由于在微信小程序环境，不是普通浏览器，不能做跳转，故需要变形。这个许可类型建议好好琢磨，从而可以灵活运用，推荐再看一看我写的《<a href=\"https://zhuanlan.zhihu.com/p/446314134\">webview 复用微信小程序获取用户信息的解决方案</a>》，其中的方案三本质上也是由于不能跳转，从而对授权码许可进行适当变形来应用。</li>\n</ul>\n<p>本篇介绍的设备码授权流程，其实也是对授权码许可的一种变形应用。它适合更加缺乏浏览器跳转的应用中，比如一个命令行应用。</p>\n<p><a href=\"https://zhuanlan.zhihu.com/p/446314134\">webview 复用微信小程序获取用户信息的解决方案</a></p>\n<ul>\n<li><strong>客户端凭据许可</strong>，它通过第三方软件的 app_id 和 app_secret 获取客户端的访问令牌。注意，这里拿到的访问令牌是客户端级别的，而不是授权码许可类型中的用户级访问令牌，因此相当于该客户端的访问令牌权限更广，不如授权码许可类型的粒度细致。也就是说，一旦授权服务器给了客户端这样一个客户端级别的访问令牌，那么，该客户端在令牌有效期内就可以获取任何用户的信息，不像授权码许可类型拿到的只是某个用户的访问令牌，只能获取该用户的信息。而且，在获取这个粗粒度令牌的过程中，是不需要用户参与的，也不需要用户授权。本质上，客户端凭据许可，就像普通的用户名密码登录一样，只是在这里，app_id 和 app_secret 是事先注册（备案）好的，只用在第一次换取访问令牌的过程中，后续操作（接口请求）全部使用访问令牌来决定是否有权限。这样的好处是将 app_id 和 app_secret 的暴露降至最低，从而减小攻击面。但是授权服务器仍然需要监控第三方软件（客户端）的行为，确保它不滥用访问令牌，如果发现滥用，可以吊销其 app_id 和 app_secret（黑名单）。</li>\n</ul>\n<p>在我写的《<a href=\"https://zhuanlan.zhihu.com/p/446314134\">webview 复用微信小程序获取用户信息的解决方案</a>》中的方案二，就是利用了这个许可类型，它实现起来比授权码许可类型工作量要小很多。</p>\n<ul>\n<li><strong>隐式许可</strong>，通过第三方软件（客户端）的 app_id 直接获取访问令牌。这种令牌也是客户端级别的，而且连 app_secret 都不需要，就像登录时只需要说自己是谁就行，不用验证密码。因此这种许可类型的安全级别不如以上两种类型，只适用于信任级别非常高的环境和客户端。就像你做一个微信小程序的后端，这个后端只要读到会话信息中的 unionId 或者 openid，就给该用户登录一样，不需要用户输入密码或者做其他验证。这是因为在拿到 unionId 或者 openid 前，微信服务器已经帮你做了验证，你的后端从微信服务器拿到的这个 unionId 或者 openid 是可靠的无法伪造的（还记得前面提到的那个 code2session 接口吗？unionId 或者  openid 是这个接口返回的）。</li>\n<li><strong>资源拥有者凭据许可</strong>，它是通过资源拥有者（即用户）的用户名和密码来获取用户级别的访问令牌。这相当于用户把自己的用户名和密码存储在了第三方软件（客户端）那里，所以这个第三方软件（客户端）必须是相当可靠的，不滥用用户的安全凭据信息。</li>\n<li><strong>设备码授权许可</strong>，这是本篇文章要介绍的，其实也算是授权码许可类型的一个变形。前面也提到了，如果要自己开始这个 OAuth 授权服务，那么授权码许可类型的开发量是最大的，而这个设备码授权许可，开发量比授权码许可类型还要再大一点。</li>\n</ul>\n<p>不过，今天我们并不是讲解如何自己开发一套设备码授权许可服务，而是对接 Keycloak 的设备码授权许可，这就很简单。比如以前也分享过如何对接 Keycloak 的授权码许可类型，只是当时没说这种许可类型，只是说接入 Keycloak 的单点登录功能，但因为那是一个浏览器应用，很自然地对接的是 Keycloak 的授权码许可类型。</p>\n<p><a href=\"https://zhuanlan.zhihu.com/p/480816990\">Free Arch: 如何在 Spring Boot 应用中集成 Keycloak？</a></p>\n<p>在上面的文章里，不仅在 Keycloak 实例里配置了一个 demoapp 的客户端，而且还写了一个 demo 工程，源代码在 GitHub，它是一个 Java Spring Boot 应用，也就是跑在浏览器环境，凡是浏览器应用，接入 Keycloak 的方式和上面的文章分享的步骤本质上都是相同的，和开发语言没有关系。</p>\n<p>但是今天，想在命令行里对接 Keycloak，拿我以前写的一个命令行工作 k8ss 举例，希望加入一个登录选项，直接复用 Keycloak 的登录功能。再详细点说，是希望在命令行里输入 k8ss login，自动打开一个浏览器，跳转到 Keycloak 登录页面，用户登录完成后，返回命令行，就在命令行环境进入了登录态。</p>\n<p>注意，由于要做到千人千面，即不同用户的登录态要彼此隔离，也不能让用户 A 去访问到用户 B 的信息，所以 Keycloak 做为授权服务器，给这个命令行工具颁发的令牌，必须是用户级别的访问令牌，而非客户端级别的访问令牌。又不想让这个命令行工具存储用户的安全凭据，自然只能用授权码许可类型了，但是如前所述，在非浏览器环境中，跳转没有那么好实现，于是，授权码许可类型需要灵活变形，即采用这个设备码授权许可类型。</p>\n<p>好在 Keycloak 从版本 13 开始支持这一许可类型，关于这一许可类型的 Keycloak 文档，可以参考：<a href=\"https://github.com/keycloak/keycloak-community/blob/main/design/oauth2-device-authorization-grant.md\">https://github.com/keycloak/keycloak-community/blob/main/design/oauth2-device-authorization-grant.md</a>。</p>\n<p>本质上呢，就是在配置好后发一些 HTTP 请求就可以了。\n<a name=oJL5r></a></p>\n<h1>配置</h1>\n<p>这次还是演示，所以直接找到《<a href=\"https://zhuanlan.zhihu.com/p/480816990\">Free Arch: 如何在 Spring Boot 应用中集成 Keycloak？</a>》里创建的 Keycloak 客户端 demoapp，开启设备码授权功能。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 70.27027027027026%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACF0lEQVR42p2T7W7SUBjHexubbllmICuFtrRAC4OCTncB3omJH/w63bKpt+KN6GeS4SbCIiFZFQqlpy9w2r85B8iQGVk8yT/P85ye/M7z0iNIWQUZSUYqLULMZJHNKZBVHYqqccmyClnJc8vOFjQNFcOAVaujUqmhUXoG67CKqtVA4+kRBFHWcZDTkJZUbO08wavXb/D95geazSba7Ta6nQ4699S987t/fhPyhTL0QhmKXsbOvoizi49gKwgC/M8Sjusv8PLoGHWzit2UhNMF0PM8LuL7GA4dfgHzfd+HRwjCMOQ+jz2PW3ZGMA0L9bIFo1TF430R784/cCD1fTjjMeh0ChqFoJQijunCxtwutYyZFaS8CdN6DqV4iK3dFE7O3s9zJwSEEIz8ELY/Q0xnmM3uxACr8XJPyGkmSpU6ZM3E9l4ab0/POS+0bUTeBD03xOf+GECC5CE9ZEBRLkBSS3i0l8bJAji5vcWw1wOlMwQTl5eTJMlGCSwztVhZAV5w4JR4+HV9hYhS+EGAKevlSt/+Jla2kM0bUApz4PYKMIgiOK1L0DBA4BM+wfWerYtdKjCYbtTuZegFIQZXLfT7P/HFJryH8YZy+ZQzShEsy/UMHdeF3e1g+K2Nr0MCsB4+ZCgHOfb0dA6dT3kOtG0brjPAZfMan1o234sTbB4KmzATA66W7IxGmLhjDLwAN240/20WwH9l+Bt2v4kl7YEdCwAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/dbac987cfd1c85a9ae92d84f28d78717/fcda8/1648283001579-9bcf0ade-0b86-4af2-b06f-cecc231fccbb.png\"\n        srcset=\"/static/dbac987cfd1c85a9ae92d84f28d78717/12f09/1648283001579-9bcf0ade-0b86-4af2-b06f-cecc231fccbb.png 148w,\n/static/dbac987cfd1c85a9ae92d84f28d78717/e4a3f/1648283001579-9bcf0ade-0b86-4af2-b06f-cecc231fccbb.png 295w,\n/static/dbac987cfd1c85a9ae92d84f28d78717/fcda8/1648283001579-9bcf0ade-0b86-4af2-b06f-cecc231fccbb.png 590w,\n/static/dbac987cfd1c85a9ae92d84f28d78717/efc66/1648283001579-9bcf0ade-0b86-4af2-b06f-cecc231fccbb.png 885w,\n/static/dbac987cfd1c85a9ae92d84f28d78717/c83ae/1648283001579-9bcf0ade-0b86-4af2-b06f-cecc231fccbb.png 1180w,\n/static/dbac987cfd1c85a9ae92d84f28d78717/bb27a/1648283001579-9bcf0ade-0b86-4af2-b06f-cecc231fccbb.png 1371w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p><a name=jlOeo></a></p>\n<h1>获取用户授权码和设备码</h1>\n<p>发送 POST 请求到 Keycloak 的设备授权接口端点，如下：</p>\n<p>shell\ncurl --location --request POST <a href=\"https://keycloak.jiwai.win/auth/realms/UniHeart/protocol/openid-connect/auth/device\">https://keycloak.jiwai.win/auth/realms/UniHeart/protocol/openid-connect/auth/device</a>\n--header Content-Type: application/x-www-form-urlencoded\n--data-urlencode client_id=demoapp</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ea718e047ef0d149e987859264c8e7c6/bb3ba/1648291850622-b5fcdc31-0ffb-4e8e-aecf-4bf40b5894d9.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.78378378378378%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAABgUlEQVR42qVS266cMAzk//+w6uPCnhJgIYltcgHmyKacou2R+lBLIzsXeyZ2GmbG6/UyzPMM7z2WZbE4hGBxjBHvdhzHX9j3Hc04jpaoSc45wzAMcArn0Pf9ub72nYPmENG3aFRhSgnqhQUhRpAwvJ8ROCKGAKIIsXM24pwztm37giq74kYPtRiLIFE8Y02cJ4gIJGdEWZFqBYnY0+6mxbSGerVGe6VST6YN+8W87zj08scT4ecP7F2LPQZoOd2/+qbFtGWlFFs32hdV9M78u/Oo4wBqHzimEdB7t4FcClXAZU2Ss4f6PE4CSasRmGKd3FX7wm2iq+ast7y8ovn17GxqkQg+BDARgl/ATPaFVorYcv72q2hRI72hKduOkjOy9ygU4aXC+QRaK4IU85IqohSksuFfZgV1ENS2hqkf8dEvcLOgm048RsZjYPPtyOgmhucMySeZkipMYa4VtRRw90R0PYg8jpxQSkVc/1yOazHFqlRjxdeZFHCq55Tfp/S/9glUUKdIUJIEFgAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/ea718e047ef0d149e987859264c8e7c6/fcda8/1648291850622-b5fcdc31-0ffb-4e8e-aecf-4bf40b5894d9.png\"\n        srcset=\"/static/ea718e047ef0d149e987859264c8e7c6/12f09/1648291850622-b5fcdc31-0ffb-4e8e-aecf-4bf40b5894d9.png 148w,\n/static/ea718e047ef0d149e987859264c8e7c6/e4a3f/1648291850622-b5fcdc31-0ffb-4e8e-aecf-4bf40b5894d9.png 295w,\n/static/ea718e047ef0d149e987859264c8e7c6/fcda8/1648291850622-b5fcdc31-0ffb-4e8e-aecf-4bf40b5894d9.png 590w,\n/static/ea718e047ef0d149e987859264c8e7c6/efc66/1648291850622-b5fcdc31-0ffb-4e8e-aecf-4bf40b5894d9.png 885w,\n/static/ea718e047ef0d149e987859264c8e7c6/bb3ba/1648291850622-b5fcdc31-0ffb-4e8e-aecf-4bf40b5894d9.png 1121w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><br />这样就拿到了 device_code 和 user_code。对于要接入的程序，只需要把上述请求翻译成对应的语言就行了。由于这里举例的 k8ss 是 nodejs 写的，于是直接在 Postman 里选择 nodejs，即可导出相应的代码：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9afe52dd94543c16429b166275a3b532/82c1e/1648292001726-f52f4e69-6285-4421-86b1-1d309a4bd8d5.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50.67567567567568%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABu0lEQVR42oWSzYrcMBCE/Zx5wTxFjjkFAiHJYUNgWbI743hsy7YsqVt/X5AmG/aWggYhqaurih6O42DbNtZ1xRjTq51b7fuOD4F1WViPwMPoMNcJ+fmD+fs38rrQUEoGKqUUhkbmve/Nt9vEsswsy8I8z3+JDcEaPjw43r23fHxUcBtmvOKtRbzDOUUCiEQGa+1dlTF4fxKjUkol59wnvoXXTLuRp0emz5+Yvn5he/6FPZWSGqEwNMvOOVJK1Aoxpv7wClXtDpotd1rseZIlsP8emWeDBMG7SJvdxAzNamt6RYyRIEIFUs5IVDQqMReC5k5YKVibGJ8z0zVh5sph4LR6zzCE0ElEAirSBwTv8cGhOSJJOSWxdyWVXAoaC7dLZbkVpmvlPJplZTi9x9kDtRbrAsYGrBPsGVBNSHyTYy3klEi5ESacBXdUxNd7XCkytO/Re+zLhfkycRkNo/GMW+Cyel4Wx3X1vc4Q+3p0+0E5DsH5u7uoGbdZhlxrJ1yvE/N2sJ+C9RGNmRBbhrln1yqmTK2FVEq3d5tOjs0TnBBjJqoytDzaijQ7/0Ot93VqCr0o1grnLv8Im/o/yisGuv9CorsAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/9afe52dd94543c16429b166275a3b532/fcda8/1648292001726-f52f4e69-6285-4421-86b1-1d309a4bd8d5.png\"\n        srcset=\"/static/9afe52dd94543c16429b166275a3b532/12f09/1648292001726-f52f4e69-6285-4421-86b1-1d309a4bd8d5.png 148w,\n/static/9afe52dd94543c16429b166275a3b532/e4a3f/1648292001726-f52f4e69-6285-4421-86b1-1d309a4bd8d5.png 295w,\n/static/9afe52dd94543c16429b166275a3b532/fcda8/1648292001726-f52f4e69-6285-4421-86b1-1d309a4bd8d5.png 590w,\n/static/9afe52dd94543c16429b166275a3b532/efc66/1648292001726-f52f4e69-6285-4421-86b1-1d309a4bd8d5.png 885w,\n/static/9afe52dd94543c16429b166275a3b532/c83ae/1648292001726-f52f4e69-6285-4421-86b1-1d309a4bd8d5.png 1180w,\n/static/9afe52dd94543c16429b166275a3b532/82c1e/1648292001726-f52f4e69-6285-4421-86b1-1d309a4bd8d5.png 1398w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><br />也可以选择引入一些库，比如著名的 axios，那么对应的代码是：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50.67567567567568%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABsUlEQVR42oWSzbITIRCF52l9OcvXcO9CN2o0RnOTycwwEJp/+CzIzS13dlVXQ0Mf+pxm2rYNpRTrur7FnuvRGIMVYVsXjovn41eNcQlz/MH5y2fCfCHNF6rZ6VZKYdJaE2NEG822rey7Yt/3AT7ivhPF8P6T490H4bBmynzm9u2AOp5Q338il2UA1g7Yi5ZlQe2K4IWYArVUcs601obXWoFGSumRA+w9sy6R68ViJQ/AfjZ1sBDCAOjmvR/7p/V9906nSyAio9DoO8ssBAc5N0rplBuTtXZceFrKeRT3VK6FlBO5ZEqFmCve+XHPWs/pEJjPcP3TuOtGTo2piz+6CIHQuxsderwTfHCEEgk5YlxG2TgeL63hfGC7BYxqbLdGDG3IMt1FCGIJxmDEs9uAkcBdAi5kfHx0OzSqZeiZSsU6R4iZf8g9NCydptbo4y/ml4XzrLkoz3lz/F6E0yKcV+Flc+OBMZxS2bVhuW4YI1jTdU6UUplyrURruV1urEbQNuBj16ySy8PTq/d1q5VSG+ZuUdcVrQSxfah1dD+NAbx+i/9ZL3hSlqF3wLn0NtRO+S/Wpweu1aSO4AAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/5fa660d45ef367a4e72d90302b61694d/fcda8/1648292062424-80f7e009-b351-475e-946b-a8cdbf908f2d.png\"\n        srcset=\"/static/5fa660d45ef367a4e72d90302b61694d/12f09/1648292062424-80f7e009-b351-475e-946b-a8cdbf908f2d.png 148w,\n/static/5fa660d45ef367a4e72d90302b61694d/e4a3f/1648292062424-80f7e009-b351-475e-946b-a8cdbf908f2d.png 295w,\n/static/5fa660d45ef367a4e72d90302b61694d/fcda8/1648292062424-80f7e009-b351-475e-946b-a8cdbf908f2d.png 590w,\n/static/5fa660d45ef367a4e72d90302b61694d/efc66/1648292062424-80f7e009-b351-475e-946b-a8cdbf908f2d.png 885w,\n/static/5fa660d45ef367a4e72d90302b61694d/c83ae/1648292062424-80f7e009-b351-475e-946b-a8cdbf908f2d.png 1180w,\n/static/5fa660d45ef367a4e72d90302b61694d/f1c64/1648292062424-80f7e009-b351-475e-946b-a8cdbf908f2d.png 1390w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span><br />对项目 k8ss 的具体代码改动见这个提交：  <a href=\"https://github.com/Jeff-Tian/k8ss/commit/8f191e78e10f0975bfe17f4780304f0afddb4ff9\">https://github.com/Jeff-Tian/k8ss/commit/8f191e78e10f0975bfe17f4780304f0afddb4ff9</a></p>\n<p>在本地命令行中运行的效果如下所示：\npowershell\nC:Usersjeffk8ss>yarn start login\nyarn run v1.22.10\n$ ts-node src/index.ts --  login\nlogging in...\ngetting user code and device code...\ncodes =  {\ndevice_code: dOx3jAg-7rbenbs-DyXpsr1ZTqEajVUXLmb-B4MfeX8,\nuser_code: RFQJ-DGFF,\nverification_uri: <a href=\"https://keycloak.jiwai.win/auth/realms/UniHeart/device\">https://keycloak.jiwai.win/auth/realms/UniHeart/device</a>,\nverification_uri_complete: <a href=\"https://keycloak.jiwai.win/auth/realms/UniHeart/device?user_code=RFQJ-DGFF\">https://keycloak.jiwai.win/auth/realms/UniHeart/device?user_code=RFQJ-DGFF</a>,\nexpires_in: 600,\ninterval: 600\n}\nDone in 6.25s.</p>\n<p><a name=Zvd7y></a></p>\n<h1>打开浏览器并浏览到 verification_uri</h1>\n<p>在上一步不仅拿到了 user_code 和 device_code，还拿到了打开浏览器后需要跳转到的 url，这就是 verification_uri。打开这个页面后，用户需要输入 user_code，而 device_code 是后续客户端程序需要拿来轮询用户是否完成了授权（即正确输入了 user_code）的。</p>\n<p>这个功能的代码提交见： <a href=\"https://github.com/Jeff-Tian/k8ss/commit/aa737e52521d950a77901523888dfc526a075303\">https://github.com/Jeff-Tian/k8ss/commit/aa737e52521d950a77901523888dfc526a075303</a></p>\n<p>其命令行输出如下：\npowershell\nC:Usersjeffk8ss>yarn start login\nyarn run v1.22.10\n$ ts-node src/index.ts --  login\nlogging in...\ngetting user code and device code...\ncodes =  {\ndevice_code: ClcqRCmHJTL4OR9LH7-4A1Zn5XLzLgiN2XCNihewRWw,\nuser_code: AIGL-WTKV,\nverification_uri: <a href=\"https://keycloak.jiwai.win/auth/realms/UniHeart/device\">https://keycloak.jiwai.win/auth/realms/UniHeart/device</a>,\nverification_uri_complete: <a href=\"https://keycloak.jiwai.win/auth/realms/UniHeart/device?user_code=AIGL-WTKV\">https://keycloak.jiwai.win/auth/realms/UniHeart/device?user_code=AIGL-WTKV</a>,\nexpires_in: 600,\ninterval: 600\n}\n请打开浏览器并浏览至：  <a href=\"https://keycloak.jiwai.win/auth/realms/UniHeart/device\">https://keycloak.jiwai.win/auth/realms/UniHeart/device</a>  , 然后在打开的页面中输入  AIGL-WTKV\nDone in 2.84s.</p>\n<p>打开浏览器后，页面会展示一个输入框给到用户来输入 user_code：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/97d9abe50aa281f4e686e593f2c6aaa9/b67f3/1648294502332-845face3-8a6d-4110-af6a-35c6c0a18e50.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 49.32432432432432%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAACU0lEQVR42n3SS08TURjG8fkaJCQkLNiJrUVqpy1toRdnqLRDuZRepswwrQQoDV0QNmwIG1wRUi5Rt34DY2IaJMFLkIXGpStMjInlUiguVf7mDDHGhZ7k2Zyc/PK85xxJlv0Egv34+4K478j0uj3cdnvo6emlu9vJjW4nNx0uXD1uArKHgVCYQCBENKTS7w7h9fmJRBXCEQVZ9iItLy+ztLREpVJhbm7OTqlUomhZlPQ8eV1H13Wy2SyZzASjo6OkUimSSY34YBxFUVAUlWg0SigURFpcXGRhYYFyuWxjs7OzlEpFrGKR+/kcpXyOjMAm0pimgWkYGJMFEokhBlUVVblLeGCAYDBoR6pWq8zPzzMzM2M3sywLwzAwTdNuZSY1NC1FfEhDjQ+hDN4jElPwB0L4g/14fH14ZC9+vw+v13cNilYCEohIoVAgPT6Obk7x4vker5/V2T14z+7LQ3ZfHVLfP6C+/5an9X323ryjXKnict1ClmWk33cmINFMYJlMhtTICJY1xRVAqwlXP/jXerC2RldXFy6XC2l6etrGxMXncjnS6TRjY2MkEgkKhUlOz075dtLg5NMRx2dnnByf0Gg0aDabXLRaNriyskJnZydOpxNJtBJQPp+3oesXTBKLxchmM3z+0uDo6wWty0tardZfOT8/t0HxUzo6OnA4HH9A0Wx4eNjG4vE44UgEQ8/x8fg7Tz785H9rdXWVtrY2e2xJjCqaCUjTNBtTVdX+X2Jvc7PG40cP2dnZYWtri1qtxsbGBuvr63a2t7ftc+3t7fbYvwB/Pd+pjGaxeQAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/97d9abe50aa281f4e686e593f2c6aaa9/fcda8/1648294502332-845face3-8a6d-4110-af6a-35c6c0a18e50.png\"\n        srcset=\"/static/97d9abe50aa281f4e686e593f2c6aaa9/12f09/1648294502332-845face3-8a6d-4110-af6a-35c6c0a18e50.png 148w,\n/static/97d9abe50aa281f4e686e593f2c6aaa9/e4a3f/1648294502332-845face3-8a6d-4110-af6a-35c6c0a18e50.png 295w,\n/static/97d9abe50aa281f4e686e593f2c6aaa9/fcda8/1648294502332-845face3-8a6d-4110-af6a-35c6c0a18e50.png 590w,\n/static/97d9abe50aa281f4e686e593f2c6aaa9/efc66/1648294502332-845face3-8a6d-4110-af6a-35c6c0a18e50.png 885w,\n/static/97d9abe50aa281f4e686e593f2c6aaa9/c83ae/1648294502332-845face3-8a6d-4110-af6a-35c6c0a18e50.png 1180w,\n/static/97d9abe50aa281f4e686e593f2c6aaa9/b67f3/1648294502332-845face3-8a6d-4110-af6a-35c6c0a18e50.png 1338w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><a name=EQbW8></a></p>\n<h1>等待用户授权</h1>\n<p>用户如果已经登录过 Keycloak 或者其他对接过用 keycloak 做单点登录的其他应用，那么，当他输入正确 user_code 之后，直接同意给命令行程序颁发令牌就完成了授权过程。否则，该用户输入正确 user_code 完毕后，需要先登录，并同意授权给该命令行程序颁发用户级别的访问令牌。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/11d09f337d68e16e54d1b133280c3136/d1882/1648295241184-86b0b450-3b78-4d66-b566-b8be883def1d.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.64864864864865%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAACSElEQVR42nWSbUtTYRiAz69QEBH9oBNFNwfTze1s5+xN19yrk+nG2ftLLpc0g6Ay7AWNED9EP6EQtVU/po/9giCMzK102xXnSfsg9MAF9/3Ac3Hfz31LgcASt4IhfP5FVNWDqriRXSqy7MIhu5CdCna7zPwVc9Z5ZmdtWCxzWGatGE1mnE4XUdXPoupC2t5+zNbWFhsbG9yt12mUS1TLZfKFAoV8gUw2SyaTQdM01tZSLC8vEwqFCAaDLCws4PF4kGUZl8OBU1GQdNnm5qYQrtdq3C4Wua+lyWiaeBwOLRGNhInHogK3quCUHczbrDidzn/Y7Q5sVitSo9GgVqtRKpUoFgpk8nlKq0nurSbZO3jD7v5rnr08YGd3nycvXvFwZ5dHT/d4sP0cj8eLzWYTWCwWZmZmkOr1OpVKhYLeoi7UNOKJBHfW17l5ejfySDTK9PQ0ZrNZyEwmE1K1WiWfz4s/SqVSJJNJIpEI5UqFdqvF99NTzs5+0Gqd0+126Ha7Qq3HgUCA8fFxjEYjk5OTGAwGpFwuJ2TpdJpEIkEsFsPv96Pft9ptfv485/Ly8koEvd7fOvXc6/ViGBtjYmKC0dFRgRDqlV3L9An6fD6y2Rzt1jm/f7XpdLt0Oh0h1tHji4sL3G43Q0NDjIyMMDw8LGJJl8XjcdHm9Sooqkq1mOPzV/jyrcf/jj7dgYEBIRwcHBSxtLKyQjgcFjK9BUVRxF5FwmHeHjV5d/SeTx8/0Gw2OTk54fj4WHB4eMjU1BT9/f1C1NfXJ/gDFrDUZJNSsWMAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/11d09f337d68e16e54d1b133280c3136/fcda8/1648295241184-86b0b450-3b78-4d66-b566-b8be883def1d.png\"\n        srcset=\"/static/11d09f337d68e16e54d1b133280c3136/12f09/1648295241184-86b0b450-3b78-4d66-b566-b8be883def1d.png 148w,\n/static/11d09f337d68e16e54d1b133280c3136/e4a3f/1648295241184-86b0b450-3b78-4d66-b566-b8be883def1d.png 295w,\n/static/11d09f337d68e16e54d1b133280c3136/fcda8/1648295241184-86b0b450-3b78-4d66-b566-b8be883def1d.png 590w,\n/static/11d09f337d68e16e54d1b133280c3136/efc66/1648295241184-86b0b450-3b78-4d66-b566-b8be883def1d.png 885w,\n/static/11d09f337d68e16e54d1b133280c3136/c83ae/1648295241184-86b0b450-3b78-4d66-b566-b8be883def1d.png 1180w,\n/static/11d09f337d68e16e54d1b133280c3136/d1882/1648295241184-86b0b450-3b78-4d66-b566-b8be883def1d.png 1562w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>如果用户输入错误的 user_code，会得到错误令牌反馈：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.83783783783784%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC00lEQVR42n2SXU8iVxzG53vohYkIQkXqNsZarCjDyyogr8PrIMMyvEQwa92r/Tr9Dnu/0rpRadPrtkmvmrQ3IoqCXRh+zTl0m/SmJ3nyTObid57//zzK5pdf82LTi9vzBWueTdyeF6y5P8ex+hkrdid2h4sVIbsLl8vNqnPt33+2FSe2ldV/5MDpcqOcnZ3RarVoNBo063UalQrHFQNd18nn8xSLJemaliWVShOPJ4jFjohEIoRCYVQ1QCAQkO5XVZTz83M6nVNOT0/pCNVNXr+q8qpWwzAMqWKxSLlclt/iolJJJ5EQ4BjRaJSDgwOCwQB+v3+esNPpcHJyQqvZpGqadKoGnWKBQqlEVsuQTMRJp1LkcznyuSy5rIaq+tnf8+Hz7eL1fsXu7i47Ozso7XYb0zSp1WpUq1UqlQq6YWBm0pyVK9S/eYvZfoPReo1ea1OqnZAt19HKJrnjBnmjSSSZkzCv14vSbDYl7JPEaHqpRCyZ4urdO7i9ZQJYwMSC6WwuccZ/TaT/8ONPbG1tsb29jSLSiVRCApbL5SgUCkQjET70evBwj/XbrwjGeDRiPB4zGj0xm1lMp3Ngr3fDxsYGHo8HRSxagMTiBUzTNDKZDOGXL/n+4gKsKZM//2D6+Ig1HmONRjCbR7QsS/rNzQ3r6+tzoBxR1yUonRa1iMvXEy/Wff+e6dMTg/t7hoMBQ+FCDw+MRiOen58l8OrqCqfTidvtRhGwbFZ0LCWrcHh4KKuwv7/PhUjIjMf7Prf9O+4GA6l+v89AXDAcypSXl5fY7XYcDgeKgCWTSQkUyQRQuOr3c9Ht8m1vyIdf7uSzfJxMmE6nUpPJ5D8JbTYby8vLKGJEkUg0X1VVqWAwKLvV7X7Hz334/e4j/3eur69ZWFhgaWkJ5ejoSCYKhUJyzL29Pek+n49YNMpxQSObThJPJOR+xQThcFhe+kmiMouLixL6N+Aufir+wLP2AAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/696f11c581eb71a1ad3993ada5be02c4/fcda8/1648295406465-00f5d491-abd5-4e75-95db-edcef010ec54.png\"\n        srcset=\"/static/696f11c581eb71a1ad3993ada5be02c4/12f09/1648295406465-00f5d491-abd5-4e75-95db-edcef010ec54.png 148w,\n/static/696f11c581eb71a1ad3993ada5be02c4/e4a3f/1648295406465-00f5d491-abd5-4e75-95db-edcef010ec54.png 295w,\n/static/696f11c581eb71a1ad3993ada5be02c4/fcda8/1648295406465-00f5d491-abd5-4e75-95db-edcef010ec54.png 590w,\n/static/696f11c581eb71a1ad3993ada5be02c4/efc66/1648295406465-00f5d491-abd5-4e75-95db-edcef010ec54.png 885w,\n/static/696f11c581eb71a1ad3993ada5be02c4/c83ae/1648295406465-00f5d491-abd5-4e75-95db-edcef010ec54.png 1180w,\n/static/696f11c581eb71a1ad3993ada5be02c4/b5dee/1648295406465-00f5d491-abd5-4e75-95db-edcef010ec54.png 1237w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n<a name=zfJrF></a></p>\n<h1>轮询令牌</h1>\n<p>打开浏览器后，就可以开始轮询令牌。轮询时需要带上 client_id 和前面拿到的 device_code，并且设置 grant_type 为 urn:ietf:params:oauth:grant-type:device_code，cURL 如下：</p>\n<p>shell\ncurl --location --request POST <a href=\"https://keycloak.jiwai.win/auth/realms/UniHeart/protocol/openid-connect/token\">https://keycloak.jiwai.win/auth/realms/UniHeart/protocol/openid-connect/token</a>\n--header Content-Type: application/x-www-form-urlencoded\n--data-urlencode grant_type=urn:ietf:params:oauth:grant-type:device_code\n--data-urlencode client_id=demoapp\n--data-urlencode device_code=9tDoVhtMME84R0YNcyZjid54EAaqOXTL-Uoml6WKbjQ</p>\n<p>如果 device_code 不正确，会得到这样的结果：</p>\n<p>json\n{\nerror: invalid_grant,\nerror_description: Device code not valid\n}</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a967c3bde07ded9e469cf7a4bbdb7331/416ee/1648295475554-c6bee2b4-2e43-48a1-aeea-ab5824c55d90.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.16216216216216%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAABzElEQVR42n1SOY7cMBDkHx35O/Y3HBnwK3Yf4HBSw8EEE+yMRIkSxfuqRfXswAtfBEokWs3q6i6qlBK2bcM8zwKtNdZ1FRhjsCyLgGfGWmsYY0DrGftuATQADsgGaAXqer0KyXEcAl5+T8ozwWIPcsanWSPYBV++O3z4uuPjN4uftwDFRCqMMSKEIEr0umAi0fqLgKQ8M5cwZkNyO55+JHx+9vj05PGyFygSOedgrRUysxmE6OH3Bblm9N7RekOtVfD3NQB0OSm2eblc7mTGYN93lFze8oYQ/nF9DIH8v28C5iq2cjqdhIwqGRQ1rQn5+XwG5zzTBLvLnB9qC1GK7CFE0GDlnMeiNbz3MkMmMJlussA0TbjdbphuE3LKqKXKnmJCqw29V2nZHVbyFUk6df9vDSDWjKMEuBzgUoBNDj5HbKFjPhqO2NBahWJbMsNtk3as3aXScVhxk8rprrX8v6HQoF7f0JBKh/UZMVeZq2Lf9jjgvEMtBTkXpFwQuacsVXPO6HzQ/3J5DNR6H5UiSelDLiWtEVaDdTaYtMXqWLkh5AafKlLtcnn8Bi4xpxQoflrvyCWj0wyqEUV0kfEmKJUz6kLAl/AejD0IXwEh8p94OCJ/TwAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/a967c3bde07ded9e469cf7a4bbdb7331/fcda8/1648295475554-c6bee2b4-2e43-48a1-aeea-ab5824c55d90.png\"\n        srcset=\"/static/a967c3bde07ded9e469cf7a4bbdb7331/12f09/1648295475554-c6bee2b4-2e43-48a1-aeea-ab5824c55d90.png 148w,\n/static/a967c3bde07ded9e469cf7a4bbdb7331/e4a3f/1648295475554-c6bee2b4-2e43-48a1-aeea-ab5824c55d90.png 295w,\n/static/a967c3bde07ded9e469cf7a4bbdb7331/fcda8/1648295475554-c6bee2b4-2e43-48a1-aeea-ab5824c55d90.png 590w,\n/static/a967c3bde07ded9e469cf7a4bbdb7331/efc66/1648295475554-c6bee2b4-2e43-48a1-aeea-ab5824c55d90.png 885w,\n/static/a967c3bde07ded9e469cf7a4bbdb7331/416ee/1648295475554-c6bee2b4-2e43-48a1-aeea-ab5824c55d90.png 930w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>轮询时，带上正确的 device_code，在用户授权之前，会得到如下结果：\njson\n{\nerror: authorization_pending,\nerror_description: The authorization request is still pending\n}</p>\n<p>程序在看到这样的响应时，只需要继续发起请求查询。注意，轮询不要太快，否则会得到这样的错误，并且不可恢复（故本示例命令行程序在轮询时，会间隔 20 秒才再次请求）：\njson\n{\nerror: slow_down,\nerror_description: Slow down\n}</p>\n<p>直到超时没有拿到令牌，就报错，提醒用户登录没有成功。判断是否超时，是看查询的结果是不是这样：\njson\n{\nerror: expired_token,\nerror_description: ...\n}</p>\n<p>或者终于成功拿到了令牌，就提醒用户登录成功！成功拿到令牌的结果响应就是正常的令牌，有效时间等：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/906052936de71e6572e00bd213865326/28e7f/1648300481676-f861a0db-2fcd-4d32-874f-6c141449d16e.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.567567567567565%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABWElEQVR42nWSaW7jMAyFffy5Sw/RM8zvtmmmSxzHcSRbC7W/glTSolPUwIdHy3okJXNwzkEp1blcRLXWAn8LIQhE9CspBvy5d7j7SxjMtiEQidk5C6JuNsZIohij0Fr7Aj+fWhtyqRjYVGsVbgaOuQAnDoGkYCkFaE1otcp7Ya1dc2lIKfUO1yvOeXjP5oraesWcS9dSrwmarKWckEpGKgmxZBjKiKlg2IzH/qDxNG54PKzYjSt2R4P9ZEQfxw3P13g3brLv38ni7ezwOnc45v2OuEPKeBi74emqt0T7yYr5+fi1fivGSZj3xWFShKMiBO7QKY3lOOOkLZYtQJkoejFM/IayHUsZLuRP5aPylfDdD+QDXkaN/cniZbZyPO5qvHgcFv/ZBcMxr88rd+QxacK8Bpy3CO34TisGqzTO04LTarH6AB+yVPs2Jv/BI8JwzD+IxyqnJPoB69S1qEKORl8AAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/906052936de71e6572e00bd213865326/fcda8/1648300481676-f861a0db-2fcd-4d32-874f-6c141449d16e.png\"\n        srcset=\"/static/906052936de71e6572e00bd213865326/12f09/1648300481676-f861a0db-2fcd-4d32-874f-6c141449d16e.png 148w,\n/static/906052936de71e6572e00bd213865326/e4a3f/1648300481676-f861a0db-2fcd-4d32-874f-6c141449d16e.png 295w,\n/static/906052936de71e6572e00bd213865326/fcda8/1648300481676-f861a0db-2fcd-4d32-874f-6c141449d16e.png 590w,\n/static/906052936de71e6572e00bd213865326/efc66/1648300481676-f861a0db-2fcd-4d32-874f-6c141449d16e.png 885w,\n/static/906052936de71e6572e00bd213865326/c83ae/1648300481676-f861a0db-2fcd-4d32-874f-6c141449d16e.png 1180w,\n/static/906052936de71e6572e00bd213865326/28e7f/1648300481676-f861a0db-2fcd-4d32-874f-6c141449d16e.png 1848w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>这个轮询令牌功能的代码提交见： <a href=\"https://github.com/Jeff-Tian/k8ss/commit/a3054be5a83c63386f74e56f40ee5f54e036f633\">https://github.com/Jeff-Tian/k8ss/commit/a3054be5a83c63386f74e56f40ee5f54e036f633</a></p>\n<p>一次正常的登录在命令行输出如下：\npowershell\nC:Usersjeffk8ss>yarn start login\nyarn run v1.22.10\n$ ts-node src/index.ts --  login\nlogging in...\ngetting user code and device code...\ncodes =  {\ndevice_code: s1rdwQO9LP6m-MDKrreVS7bIxrtTHdzR_qca2hhjurg,\nuser_code: IAMM-EVHC,\nverification_uri: <a href=\"https://keycloak.jiwai.win/auth/realms/UniHeart/device\">https://keycloak.jiwai.win/auth/realms/UniHeart/device</a>,\nverification_uri_complete: <a href=\"https://keycloak.jiwai.win/auth/realms/UniHeart/device?user_code=IAMM-EVHC\">https://keycloak.jiwai.win/auth/realms/UniHeart/device?user_code=IAMM-EVHC</a>,\nexpires_in: 600,\ninterval: 600\n}\n请打开浏览器并浏览至：  <a href=\"https://keycloak.jiwai.win/auth/realms/UniHeart/device\">https://keycloak.jiwai.win/auth/realms/UniHeart/device</a>  , 然后在打开的页面中输入  IAMM-EVHC</p>\n<p>等待输入授权码……\n开始查询登录结果……\n本次查询令牌的结果是：  {\naccess_token: eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI2Vk8wUU5Ka0hTWnlEN1BlSTU3VVZZd0NkX3ZvXzZxbS14eWtLbThpdWhnIn0.eyJleHAiOjE2NDgzMDU0MTYsImlhdCI6MTY0ODMwNTExNiwiYXV0aF90aW1lIjoxNjQ4MzAwMzM1LCJqdGkiOiIzMmUwMjE1Mi0yMmU1LTQ4MTgtOWI5Ni03YmJiMDJlMDFhMmUiLCJpc3MiOiJodHRwczovL2tleWNsb2FrLmppd2FpLndpbi9hdXRoL3JlYWxtcy9VbmlIZWFydCIsImF1ZCI6ImFjY291bnQiLCJzdWIiOiIyNWJkYzE4My1jMTQ1LTQ5NWItOThmZS1lOThiNWU0NzlkNDgiLCJ0eXAiOiJCZWFyZXIiLCJhenAiOiJkZW1vYXBwIiwic2Vzc2lvbl9zdGF0ZSI6IjdjYjNkOTdiLTMwM2ItNDg1Yi1iODM0LWJlYTMyYTc2MGFlYyIsImFjciI6IjAiLCJyZWFsbV9hY2Nlc3MiOnsicm9sZXMiOlsiZGVmYXVsdC1yb2xlcy11bmloZWFydCIsIm9mZmxpbmVfYWNjZXNzIiwidW1hX2F1dGhvcml6YXRpb24iXX0sInJlc291cmNlX2FjY2VzcyI6eyJkZW1vYXBwIjp7InJvbGVzIjpbInZpc2l0b3IiXX0sImFjY291bnQiOnsicm9sZXMiOlsibWFuYWdlLWFjY291bnQiLCJtYW5hZ2UtYWNjb3VudC1saW5rcyIsInZpZXctcHJvZmlsZSJdfX0sInNjb3BlIjoiZW1haWwgcHJvZmlsZSIsInNpZCI6IjdjYjNkOTdiLTMwM2ItNDg1Yi1iODM0LWJlYTMyYTc2MGFlYyIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJnZW5kZXIiOiIxIiwibmFtZSI6ImRhaGEg5ZOI5b636Z-mIiwicHJlZmVycmVkX3VzZXJuYW1lIjoidGlhbmppZSIsImdpdmVuX25hbWUiOiJkYWhhIiwiZmFtaWx5X25hbWUiOiLlk4jlvrfpn6YiLCJlbWFpbCI6ImRhaGFAaGR3OS53ZWNvbS53b3JrIn0.Y6g6oZmH19y97QDtWkJ8vckeXdglKtN0OXNvHY2i2EYQNnToYyehl696NA8APc4C14zBf0b8tgsIp09WRCOh9_AxZCG4uIAK9bzfTOLblLuQ_S2eB9IHgNV-Aa9PCeTbfiWVESBCo1BqO0lrsWb1oc8zrfdfTU0m746beoBS8imJSuuOTorkxWesov0aJkH0iy_jkPZngdRHOqJ83w3LPKaOHkEoTsYkyrTRVtSO5bZm9D_xAAa1RJ6OOwNyGwx2ueb7dNtnuQKjLsJ7fe3zEmbyLUzaErtO0gUU-1Q771P4uYDuboJqXwAHB48TCs9CxMYfD5krUbJYzjnij30ZJA,\nexpires_in: 300,\nrefresh_expires_in: 1800,\nrefresh_token: eyJhbGciOiJIUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI1NTlkMDM3ZC1kOGYwLTQ2ZDUtOTA5OS01YmFhMWU0NjllYmEifQ.eyJleHAiOjE2NDgzMDY5MTYsImlhdCI6MTY0ODMwNTExNiwianRpIjoiNDdlMDg1MjEtZTY3My00M2JlLTlkNTEtYmU2YTUyYTVkODE0IiwiaXNzIjoiaHR0cHM6Ly9rZXljbG9hay5qaXdhaS53aW4vYXV0aC9yZWFsbXMvVW5pSGVhcnQiLCJhdWQiOiJodHRwczovL2tleWNsb2FrLmppd2FpLndpbi9hdXRoL3JlYWxtcy9VbmlIZWFydCIsInN1YiI6IjI1YmRjMTgzLWMxNDUtNDk1Yi05OGZlLWU5OGI1ZTQ3OWQ0OCIsInR5cCI6IlJlZnJlc2giLCJhenAiOiJkZW1vYXBwIiwic2Vzc2lvbl9zdGF0ZSI6IjdjYjNkOTdiLTMwM2ItNDg1Yi1iODM0LWJlYTMyYTc2MGFlYyIsInNjb3BlIjoiZW1haWwgcHJvZmlsZSIsInNpZCI6IjdjYjNkOTdiLTMwM2ItNDg1Yi1iODM0LWJlYTMyYTc2MGFlYyJ9.N-yS5_c2T_njV_m-Zkuu4ZQt1K7yPigRV9VAIfh4HjM,\ntoken_type: Bearer,\nnot-before-policy: 1646995770,\nsession_state: 7cb3d97b-303b-485b-b834-bea32a760aec,\nscope: email profile\n}\n最终轮询结果是：  {\naccess_token: eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI2Vk8wUU5Ka0hTWnlEN1BlSTU3VVZZd0NkX3ZvXzZxbS14eWtLbThpdWhnIn0.eyJleHAiOjE2NDgzMDU0MTYsImlhdCI6MTY0ODMwNTExNiwiYXV0aF90aW1lIjoxNjQ4MzAwMzM1LCJqdGkiOiIzMmUwMjE1Mi0yMmU1LTQ4MTgtOWI5Ni03YmJiMDJlMDFhMmUiLCJpc3MiOiJodHRwczovL2tleWNsb2FrLmppd2FpLndpbi9hdXRoL3JlYWxtcy9VbmlIZWFydCIsImF1ZCI6ImFjY291bnQiLCJzdWIiOiIyNWJkYzE4My1jMTQ1LTQ5NWItOThmZS1lOThiNWU0NzlkNDgiLCJ0eXAiOiJCZWFyZXIiLCJhenAiOiJkZW1vYXBwIiwic2Vzc2lvbl9zdGF0ZSI6IjdjYjNkOTdiLTMwM2ItNDg1Yi1iODM0LWJlYTMyYTc2MGFlYyIsImFjciI6IjAiLCJyZWFsbV9hY2Nlc3MiOnsicm9sZXMiOlsiZGVmYXVsdC1yb2xlcy11bmloZWFydCIsIm9mZmxpbmVfYWNjZXNzIiwidW1hX2F1dGhvcml6YXRpb24iXX0sInJlc291cmNlX2FjY2VzcyI6eyJkZW1vYXBwIjp7InJvbGVzIjpbInZpc2l0b3IiXX0sImFjY291bnQiOnsicm9sZXMiOlsibWFuYWdlLWFjY291bnQiLCJtYW5hZ2UtYWNjb3VudC1saW5rcyIsInZpZXctcHJvZmlsZSJdfX0sInNjb3BlIjoiZW1haWwgcHJvZmlsZSIsInNpZCI6IjdjYjNkOTdiLTMwM2ItNDg1Yi1iODM0LWJlYTMyYTc2MGFlYyIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJnZW5kZXIiOiIxIiwibmFtZSI6ImRhaGEg5ZOI5b636Z-mIiwicHJlZmVycmVkX3VzZXJuYW1lIjoidGlhbmppZSIsImdpdmVuX25hbWUiOiJkYWhhIiwiZmFtaWx5X25hbWUiOiLlk4jlvrfpn6YiLCJlbWFpbCI6ImRhaGFAaGR3OS53ZWNvbS53b3JrIn0.Y6g6oZmH19y97QDtWkJ8vckeXdglKtN0OXNvHY2i2EYQNnToYyehl696NA8APc4C14zBf0b8tgsIp09WRCOh9_AxZCG4uIAK9bzfTOLblLuQ_S2eB9IHgNV-Aa9PCeTbfiWVESBCo1BqO0lrsWb1oc8zrfdfTU0m746beoBS8imJSuuOTorkxWesov0aJkH0iy_jkPZngdRHOqJ83w3LPKaOHkEoTsYkyrTRVtSO5bZm9D_xAAa1RJ6OOwNyGwx2ueb7dNtnuQKjLsJ7fe3zEmbyLUzaErtO0gUU-1Q771P4uYDuboJqXwAHB48TCs9CxMYfD5krUbJYzjnij30ZJA,\nexpires_in: 300,\nrefresh_expires_in: 1800,\nrefresh_token: eyJhbGciOiJIUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI1NTlkMDM3ZC1kOGYwLTQ2ZDUtOTA5OS01YmFhMWU0NjllYmEifQ.eyJleHAiOjE2NDgzMDY5MTYsImlhdCI6MTY0ODMwNTExNiwianRpIjoiNDdlMDg1MjEtZTY3My00M2JlLTlkNTEtYmU2YTUyYTVkODE0IiwiaXNzIjoiaHR0cHM6Ly9rZXljbG9hay5qaXdhaS53aW4vYXV0aC9yZWFsbXMvVW5pSGVhcnQiLCJhdWQiOiJodHRwczovL2tleWNsb2FrLmppd2FpLndpbi9hdXRoL3JlYWxtcy9VbmlIZWFydCIsInN1YiI6IjI1YmRjMTgzLWMxNDUtNDk1Yi05OGZlLWU5OGI1ZTQ3OWQ0OCIsInR5cCI6IlJlZnJlc2giLCJhenAiOiJkZW1vYXBwIiwic2Vzc2lvbl9zdGF0ZSI6IjdjYjNkOTdiLTMwM2ItNDg1Yi1iODM0LWJlYTMyYTc2MGFlYyIsInNjb3BlIjoiZW1haWwgcHJvZmlsZSIsInNpZCI6IjdjYjNkOTdiLTMwM2ItNDg1Yi1iODM0LWJlYTMyYTc2MGFlYyJ9.N-yS5_c2T_njV_m-Zkuu4ZQt1K7yPigRV9VAIfh4HjM,\ntoken_type: Bearer,\nnot-before-policy: 1646995770,\nsession_state: 7cb3d97b-303b-485b-b834-bea32a760aec,\nscope: email profile\n}\n登录成功！\nDone in 26.01s.</p>\n<p><a name=c8b4m></a></p>\n<h1>用户授权成功</h1>\n<p>如上所述，用户授权成功后，程序会显示登录成功，这时用户看到的界面如下，即可以关闭浏览器并返回命令行程序了。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/888a6137409169e8f6bc8c600bd9a752/32ac3/1648295286674-0fb23c2e-5e64-412f-9897-822f2a9633a9.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.24324324324324%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB/UlEQVR42l2SW2saURRG57+IEEjSeEli4q21JlZmRsVLNFaT0dGxIQpKyEveW2japvQSWkmIpQ/2L+XVp/TVeGtE6CrnoKV0w8fecM5ZfHvvo4TDEaJRjafhXfyBJ/gDj/H5g3h9AXzbPpzuDdzrm7jcGzhdC63jcLp5tOZiZdXByuraXA6Us7MzTk5OqNfrNBoNmS3LompZvDAMrGIBo1ymWCxSKBTI5XKk02mSySTxeBxVVYlGo1KRSATl9PSUVqslYf8ChYxSiUbhOVaxSDaf5/DwENOsYJqmrOOJBLFYDE3TJSwUCqE0Wy2azSbHx8ccHR1RrVblg0qlwsHBAZlMBvPZLklNRY3paKqKrmvs7ITxbm/h93nxeDbxeDwEg0EUARMgAREql8sYhiHb29/f5/WHNledH3x/ec77T9dcfP3Gu8sbzj9e8ebzNa8uvvD28gazVmdry4MinNVqNelISAAXsHw+z93dT2RMJvAw5f/4Pc/dbpfl5WUUARPORHtCAiIGv7e3RzabpdfryQe/plNGkwnj0YjxeCzzaDRiNpvJ806ng91uRymVSrJFAROuBETMLZFIyE3e3t7yMJ3S7/cZDocMBkIDBqIeDrm/v5fAdruNzWZDEe2JLyGcpVIpCdE07e93yM+3uxjBwv3irq7r8r7X62VpaYk/WaqlcSsnkYkAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/888a6137409169e8f6bc8c600bd9a752/fcda8/1648295286674-0fb23c2e-5e64-412f-9897-822f2a9633a9.png\"\n        srcset=\"/static/888a6137409169e8f6bc8c600bd9a752/12f09/1648295286674-0fb23c2e-5e64-412f-9897-822f2a9633a9.png 148w,\n/static/888a6137409169e8f6bc8c600bd9a752/e4a3f/1648295286674-0fb23c2e-5e64-412f-9897-822f2a9633a9.png 295w,\n/static/888a6137409169e8f6bc8c600bd9a752/fcda8/1648295286674-0fb23c2e-5e64-412f-9897-822f2a9633a9.png 590w,\n/static/888a6137409169e8f6bc8c600bd9a752/efc66/1648295286674-0fb23c2e-5e64-412f-9897-822f2a9633a9.png 885w,\n/static/888a6137409169e8f6bc8c600bd9a752/c83ae/1648295286674-0fb23c2e-5e64-412f-9897-822f2a9633a9.png 1180w,\n/static/888a6137409169e8f6bc8c600bd9a752/32ac3/1648295286674-0fb23c2e-5e64-412f-9897-822f2a9633a9.png 1249w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><a name=f9RBf></a></p>\n<h1>后续</h1>\n<p>程序有了令牌，可以访问用户令牌，比如获取用户名称，展示一个友好的欢迎令牌等等，不再赘述。</p>\n<p><a name=iVMwg></a></p>\n<h1>总结</h1>\n<p>本文先概览了 OAuth 2.0 主要的授权许可类型，然后详细讲解了如何对接 Keycloak 的设备码授权流程，并给出了每一步所需要的代码。首先，借助 Keycloak，使得授权服务完全不用开发，只需要做配置就行了。其次，对于第三方程序（客户端）的开发，以一个 nodejs 编写的命令行程序做为例子。</p>\n<p>本文还展示了一种对接服务开发的技巧，即采用 Postman 编写 HTTP 请求，再导出对应开发语言。所以，你可以举一反三，使用这种办法来开发其他非 nodejs 的应用，来对接其他的服务。</p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}},"menus":{}}},"staticQueryHashes":[],"slicesMap":{}}