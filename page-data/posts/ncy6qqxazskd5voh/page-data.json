{"componentChunkName":"component---src-templates-post-js","path":"/posts/ncy6qqxazskd5voh/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/ncy6qqxazskd5voh","relativePath":"posts/ncy6qqxazskd5voh","frontmatter":{"title":"给 Strapi Admin Portal 添加单点登录方式","stackbit_url_path":"posts/ncy6qqxazskd5voh","date":"2023-11-30T11:18:31","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p>Strapi 是一个无头内容管理系统，其管理界面默认提供了邮箱登录的方式。不过，其邮箱密码账户是其单独的用户系统，需要单独维护。对于一个组织来说，很可能已经有一个甚至多个现有的用户系统了，再额外增加一套用户系统，不仅增加了管理成本，对于终端用户使用也极为不便。所以，非常有必要为 Strapi 的管理界面提供一种单点登录的方式。<br />Strapi 系统其实是已经支持了单点登录的特性的，不过该功能并非免费，需要联系销售购买许可证。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d3f76d1fe7d03f37a41167fa1c534fc7/29114/1701320068296-1e27a8f8-5642-4ea0-81ed-8452ce8c6716.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 63.51351351351351%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC30lEQVR42p2R32rcRhTGlU3tbJ3WdknAbSEthTxAlrxAHiZ5hWAIjq216vVurF5kZZqA6xfoIxR6lb5AS6AlkKy72sar1ejfaCSNZuZ8ZeRCaC878OObM8w5nHM+Z2dz48Gt29ujrc8+3+/3b7o3+pvunTt33a+/uet+8eVX7tr6x67TW3OvXV93e711t/dR3+2tb7jX1vrujZub7tatHbf/yfb+xqfbo63t2w+cw+Ghf+J/h8nEx/F4gqPRMY6PJxiNxjgajTE8/BbDoXeFve/tw328i4PHuxg9dRFMTvDsYIhnozEOhp7vaK2HuDo1gPZ/YnOhyQydKIo8pTSk0rpuWprPMyp4Q63WVElFrVI0X+Q0X2TUGqIqyUhWNcVJRZfLnHL7V2ndpimi1cpzGIs9QwQCdCs1vZ0xcN50LSvdvWMeZvhznnZvbc6BtkWSCswuYgjREIi0zguwJPGceMU8gBDPSP/sE736HvhpTHj3i53FYO+PEI9ez/Do9Ts8eRNCcAXMfwR+ewj8vmuVTParNqUEY7bDmHm2j1qQziNQviJYakGotcG8bnFRSVwIiaXUaPISqoygm0uoOkZbXVLbNtoUHCxhtmDs2VEKbvT7qCbGG5TKoNYE3hossgZx0kAIhUYDdcZRpBneM4lUAEKDhCRtin9Gtju0exLS6ChtKCsVSkkQrUGjCKukwcWCgxXSJncFs7RCuBRgeQPeWPP0h4JxHHtEXQFVSjKlNMSlISENVcrQMm0oXAr6KxJUSKI655Smgt4uBM0WJbFSm0pDmc4U5jlJkhx17hmQHUmaDyi60taqBhqyLpeo0wJFVqFIBMq8QitqAudIs+zICcNwTwgBIcpMiJL/G9FpFKUdNi6zjJerFa8Y4xWLuWCxjbMyzxEuFnuO7/s7p6en96dBcC8IgsF/mQbB4Pnzacd0Oh0EL14MgvPzwfTsbDA9+6EjOD+/d/ry5X3/5GTnb8BqWZG+ks+sAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/d3f76d1fe7d03f37a41167fa1c534fc7/fcda8/1701320068296-1e27a8f8-5642-4ea0-81ed-8452ce8c6716.png\"\n        srcset=\"/static/d3f76d1fe7d03f37a41167fa1c534fc7/12f09/1701320068296-1e27a8f8-5642-4ea0-81ed-8452ce8c6716.png 148w,\n/static/d3f76d1fe7d03f37a41167fa1c534fc7/e4a3f/1701320068296-1e27a8f8-5642-4ea0-81ed-8452ce8c6716.png 295w,\n/static/d3f76d1fe7d03f37a41167fa1c534fc7/fcda8/1701320068296-1e27a8f8-5642-4ea0-81ed-8452ce8c6716.png 590w,\n/static/d3f76d1fe7d03f37a41167fa1c534fc7/efc66/1701320068296-1e27a8f8-5642-4ea0-81ed-8452ce8c6716.png 885w,\n/static/d3f76d1fe7d03f37a41167fa1c534fc7/c83ae/1701320068296-1e27a8f8-5642-4ea0-81ed-8452ce8c6716.png 1180w,\n/static/d3f76d1fe7d03f37a41167fa1c534fc7/29114/1701320068296-1e27a8f8-5642-4ea0-81ed-8452ce8c6716.png 1920w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><br />假设你已经有了 Strapi 的企业级许可证，那么你现在可以为 Strapi 的管理界面开启单点登录功能。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f8f8cd41e2ab5b2270715d52717c4eb6/529ea/1701320431597-804c53bf-1533-4633-a3b9-0181d492f993.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 30.405405405405407%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA7klEQVR42l2P4Y6EIAyEef9H1B+b3eRWDxUBKQIqc2n1Lt6SfCkt09JRbbvj3WmM4wzrFhjjoLXBMM6YjEOgFRSTRCFc0I0QMfsAaz2U/t4wTR7eR6S0wdqAtnmiaZ54PL5gjJcahYQYM9aYJX4SlhXzvECVktH3I7pOg+hscm7Bvh+oFdi2XeD8OCpyLpLXWiU/Od9Yo1jQvQNeL4dlKSAq0HoS63znxvthe0QRpWwynOGBrOOP1DTt6HuHvrcygChjGEhs5pyvTY6/jTh+8ntYp0qpGEcr/mM8LYdQsK5MvmoJKZV/9u+ctV22/gFHitGX69AJbAAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/f8f8cd41e2ab5b2270715d52717c4eb6/fcda8/1701320431597-804c53bf-1533-4633-a3b9-0181d492f993.png\"\n        srcset=\"/static/f8f8cd41e2ab5b2270715d52717c4eb6/12f09/1701320431597-804c53bf-1533-4633-a3b9-0181d492f993.png 148w,\n/static/f8f8cd41e2ab5b2270715d52717c4eb6/e4a3f/1701320431597-804c53bf-1533-4633-a3b9-0181d492f993.png 295w,\n/static/f8f8cd41e2ab5b2270715d52717c4eb6/fcda8/1701320431597-804c53bf-1533-4633-a3b9-0181d492f993.png 590w,\n/static/f8f8cd41e2ab5b2270715d52717c4eb6/efc66/1701320431597-804c53bf-1533-4633-a3b9-0181d492f993.png 885w,\n/static/f8f8cd41e2ab5b2270715d52717c4eb6/c83ae/1701320431597-804c53bf-1533-4633-a3b9-0181d492f993.png 1180w,\n/static/f8f8cd41e2ab5b2270715d52717c4eb6/529ea/1701320431597-804c53bf-1533-4633-a3b9-0181d492f993.png 3764w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><br />不过这还不够，在适配身份源时，还需要做更多工作。如果你的身份源不在 Strapi 默认的身份提供者列表里，那就还需要写一丢丢代码来做这个适配。本文正是针对这个场景，为在这方面碰到困难的读者们提供指引。</p>\n<p>:::success\n联系 Strapi 的销售购买许可证，不是一个能够立即完成的事情。如果你只想在测试环境快速验证一下该功能，那么建议你仔细阅读《<a href=\"%5Bhttps://zhuanlan.zhihu.com/p/668063944%5D(https://zhuanlan.zhihu.com/p/668063944)\">修改 node_modules 的三种方式，隆重推荐 patch-package - Jeff Tian的文章 - 知乎</a> 》一文，当你真正读懂了，你是完全可以在你的测试场景中使用 Strapi 完整的企业版功能的（请自觉不要正式使用）。\n:::</p>\n<p>本文将给出两个示例，分别是对接 Authing 和其他的 OIDC 身份提供者（比如 Keycloak、Duende IdentityServer 等）。其实对接 Authing 也是对接 OIDC 的一个特例，但是特别值得推荐，所以单独列出。\n<a name=avLmP></a></p>\n<h1>最终效果</h1>\n<p>我们实现的最终效果是可以在 Strapi 的管理界面上，在默认的邮箱登录方式之外增加两个额外的选项。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 95.94594594594595%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAABYlAAAWJQFJUiTwAAACQklEQVR42p2Uy04UQRSG5yG8xZ0miokLDW5MfCoTI0YiKENwYVwZYxADjiD4IAY3bBgDCiwkEYIwzAw9XV19qctnTs2AygzKWMmfPqf69N//uVSVrg7cZvDWHW7cHGTg2vWAS5evcO78Rc6cvdA3SmPlCUYflymPP6U8PsHo6BiPRp4wPDzC/aGHDB1D2HvQRq/3Je/BO3AdBL+D/1klpVJOQhxrisLgnMMYC1iiA8vzZ5bJVzbsOWex1oaYPC8oJUnG3yDBv68ognt3YXysW538oKR1zkloEzrA02xGRFGM1prNTcX2tmShUHGCUkl/hJLOysoGS0ufqVbXWF39ytraBsvLX8Le+vq3fhW2l9QoTXNSnYcai51lRX8pO+9pRTFxSwVb1B5fznm896dXKI0RNUmSkmV5+LgXTqfQeeI4oVar46xFxrMXWV81FBjjcRas9cE+hExVkrTjJe6fhMa4MNDOR3jfktZ0Kue7UBTHFcowd54CpTIpOYsfPS9fFEy/EVjm5+D9rKcy7ZmteKYmPdVlwo//IDwiEzstUCoPhJ8WYeo1zL2Dygx8WICFeXg7A7MVmJqEarUH4ZFCpdE7O+jdXUyjDnkTfAM4AFPHNrdwB9tgO3uuAWnzhJTTAi1HbG+PJDWdg09ogAyzxBnrQ3NSiZVmyE3VbGDkcuhWWKBbCr31HV2rY6MmqBY+jlC7P0j3a8EXZPX9X359D2NMN+FhDXWs0a2EXKeYLMdkGa4osHkRbIHYwU8zTFGQ54af8GVqgieraAMAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/11b6f3cc56607eeab46f2b8a009aba51/fcda8/1701319369706-867c4e3a-0e52-484f-8ed4-181f3d90cb72.png\"\n        srcset=\"/static/11b6f3cc56607eeab46f2b8a009aba51/12f09/1701319369706-867c4e3a-0e52-484f-8ed4-181f3d90cb72.png 148w,\n/static/11b6f3cc56607eeab46f2b8a009aba51/e4a3f/1701319369706-867c4e3a-0e52-484f-8ed4-181f3d90cb72.png 295w,\n/static/11b6f3cc56607eeab46f2b8a009aba51/fcda8/1701319369706-867c4e3a-0e52-484f-8ed4-181f3d90cb72.png 590w,\n/static/11b6f3cc56607eeab46f2b8a009aba51/efc66/1701319369706-867c4e3a-0e52-484f-8ed4-181f3d90cb72.png 885w,\n/static/11b6f3cc56607eeab46f2b8a009aba51/c83ae/1701319369706-867c4e3a-0e52-484f-8ed4-181f3d90cb72.png 1180w,\n/static/11b6f3cc56607eeab46f2b8a009aba51/912fc/1701319369706-867c4e3a-0e52-484f-8ed4-181f3d90cb72.png 1934w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span><br />不过目前由于 OIDC 对接了一个内网环境的提供者，暂时有 IP 白名单限制。\n<a name=zhKHo></a></p>\n<h1>Passport</h1>\n<p>首先要知道 Strapi 的管理后台的身份认证系统是基于 Passport 库的，Passport 是一个个人开发者开发的 nodejs 库，基于策略模式可以非常方便地适配各种不同的身份源，所以其生态特别丰富，基本上主流的身份平台都有对应的策略。\n:::success\n我也曾在 2019 年实现过一个 Passport 策略，用来对接花旗银行的开放 API，源代码见： <a href=\"https://github.com/Jeff-Tian/passport-citi\">https://github.com/Jeff-Tian/passport-citi</a> 。\n:::\n<a name=I3eTP></a></p>\n<h1>对接 Authing</h1>\n<p>在 Authing 的控制台里，通过添加集成应用到单点登录 SSO，可以直接选择 Strapi，就能看见一个非常棒的接入教程。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3be6397c45ea1679fd9badae7fc11170/1c2c3/1701320099223-f1a3bade-2a03-4b91-ae82-af3ff15f5b11.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40.54054054054054%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABK0lEQVR42o1RW07EMAzM/U/CCTgJHyysYLuLEGLbTfNy3hnktF0VvrA0smNb47EjnCN8X0fc5AyOrXMw1kFKA21Mz215hiPq8D4gpYyYElLOPeacmJWFcx4pF2ymZcPjg4KxGv+xkgOe3jwOlwIxSg9lI3zIaK0BaMi5YZI8NXUFMSb00l+iWjtyzvChIKYK8TVafF4tKJSVEN2HGODId4SYMJzPeD0e8X4a8Hx4wXC+wDoC+QAiDyJCraxwnDDPqq+8J+yNO8xK9zsrrbrn91JbyJg8lwIx3RS0cYgp3wl57VobUq6odcFWMdTu63MPo5S1pzWIWVtY5xHjQriRxhjBw9hvqlstOH1M/Te3HJv3vt+bTUySf5N2Cts6vaKUveqVtPFp6i/CvZAff3xwhXlA0xkAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/3be6397c45ea1679fd9badae7fc11170/fcda8/1701320099223-f1a3bade-2a03-4b91-ae82-af3ff15f5b11.png\"\n        srcset=\"/static/3be6397c45ea1679fd9badae7fc11170/12f09/1701320099223-f1a3bade-2a03-4b91-ae82-af3ff15f5b11.png 148w,\n/static/3be6397c45ea1679fd9badae7fc11170/e4a3f/1701320099223-f1a3bade-2a03-4b91-ae82-af3ff15f5b11.png 295w,\n/static/3be6397c45ea1679fd9badae7fc11170/fcda8/1701320099223-f1a3bade-2a03-4b91-ae82-af3ff15f5b11.png 590w,\n/static/3be6397c45ea1679fd9badae7fc11170/efc66/1701320099223-f1a3bade-2a03-4b91-ae82-af3ff15f5b11.png 885w,\n/static/3be6397c45ea1679fd9badae7fc11170/c83ae/1701320099223-f1a3bade-2a03-4b91-ae82-af3ff15f5b11.png 1180w,\n/static/3be6397c45ea1679fd9badae7fc11170/1c2c3/1701320099223-f1a3bade-2a03-4b91-ae82-af3ff15f5b11.png 3390w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><br />该教程基于 Passport 和 OAuth 2 策略，自行写了一个适配 Authing 的 OIDC 策略来实现。本文想给它做一个补充，即通过开源的 Authing 策略，用更少的代码接入。这个开源的 Authing Passport 策略库是： “passport-authing”。</p>\n<p>通过在 strapi 项目的 config/admin.js 添加一些代码，即可完成 strapi 与 Authing 的对接，代码如下：</p>\n<p>javascript\nconst AuthingStrategy = require(passport-authing).Strategy;</p>\n<p>module.exports = ({env}) => {\nconst authing = {\nuid: authing,\ndisplayName: Authing,\nicon: ,\ncreateStrategy: (strapi) => {\nreturn new AuthingStrategy({\n// 从 Authing 的控制面板里复制过来\ndomain: xt1o6lgf.authing.cn,<br>\n// 从 Authing 的控制面板复制具体的值，建议存储在环境变量里\nclientID: env(AUTHING_CLIENT_ID),\nclientSecret: env(AUTHING_CLIENT_SECRET),\nscope: [\nemail,\nprofile,\nopenid\n],\ncallbackURL: strapi.admin.services.passport.getStrategyCallbackURL(\nauthing // 需要与上面的 provider 一致\n),\n}, (request, accessToken, refreshToken, profile, done) => {\ndone(null, {\nemail: profile.emails[0].value,\nfirstname: profile.givenName ?? profile.displayName ?? profile.emails[0].value,\nlastname: profile.familyName ?? profile.nickname ?? profile.emails[0].value\n})\n});\n}\n};</p>\n<p>return ({\nauth: {\nsecret: env(ADMIN_JWT_SECRET),\nproviders: [\noidc\n]\n},\napiToken: {\nsalt: env(API_TOKEN_SALT),\n},\ntransfer: {\ntoken: {\nsalt: env(TRANSFER_TOKEN_SALT),\n},\n},\nflags: {\nnps: env.bool(FLAG_NPS, true),\npromoteEE: env.bool(FLAG_PROMOTE_EE, true),\n},\n});\n});</p>\n<p><a name=bdpml></a></p>\n<h1>对接其他的 OIDC 提供者</h1>\n<p>其实和对接 Authing 很像，但是为了展示如何做更多的定制化，我们先自己写一个 passport oidc 策略。更多的定制化功能，我们以 IP 白名单举例。这需要重载默认的授权方法，检测到用户的 IP 地址不在白名单里时，就拒绝进行授权。完整代码如下，注意获取用户的 IP 地址时，需要从 x-forwarded-forHTTP 头里获取，而不能使用 request.socket.remoteAddress 的方式。 因为请求从用户的出口 IP 到达 strapi 的服务，中间可能会经过多个代理服务器的跳转，所以只有使用 x-forwarded-for才能获取到用户的稳定出口 IP，而 request.socket.remoteAddress的值可能每次都不一样。除非用户的机器到 strapi 的服务只经过一跳，否则它们的值是不相等的。\njavascript\nconst util = require(util)\n// passport-oauth2 需要 npm/yarn 等安装\nconst OAuth2Strategy = require(passport-oauth2)\nconst InternalOAuthError = OAuth2Strategy.InternalOAuthError\nconst request = require(request);</p>\n<p>function Strategy(options, verify) {\noptions = options || {}</p>\n<p>options.scope = options.scope || openid profile email</p>\n<p>this.userInfoURL = options.userInfoURL;\n// 从选项中读取 IP 白名单列表\nthis.ipWhitelist = options.ipWhitelist ?? [];</p>\n<p>OAuth2Strategy.call(this, options, verify)</p>\n<p>this.name = options.provider || oidc\n}</p>\n<p>// 从 OAuth2Strategy 继承出 Strategy\nutil.inherits(Strategy, OAuth2Strategy)</p>\n<p>// 记住原有的授权方法\nconst authenticate = Strategy.prototype.authenticate;</p>\n<p>// 改造授权方法，以检测 IP 是否在白名单中\nStrategy.prototype.authenticate = function (req, options) {\nconst clientIp = req.get(x-forwarded-for);</p>\n<p>if (this.ipWhitelist.indexOf(clientIp) &#x3C; 0) {\nthrow this.fail({message: IP 地址 ${clientIp} 不在白名单中！});\n}</p>\n<p>return authenticate.call(this, req, options);\n};</p>\n<p>// 获取用户信息\nStrategy.prototype.userProfile = function (accessToken, done) {\nconst self = this</p>\n<p>const options = {\nmethod: GET,\nurl: self.userInfoURL,\nheaders: {\nAuthorization: Bearer  + accessToken\n}\n};</p>\n<p>request(options, function (err, response) {\nif (err) {\nreturn done(new InternalOAuthError(Failed to fetch user profile, err))\n}</p>\n<pre><code>try {\n  const json = JSON.parse(response.body)\n\n  done(null, json);\n} catch (ex) {\n  return done(new Error(Failed to parse user profile))\n}\n</code></pre>\n<p>});\n}</p>\n<p>// 对外暴露策略\nmodule.exports = {\nStrategy,\n}</p>\n<p>有了以上策略，我们就可以在 admin.js 中添加 OIDC 登录方式了，这里以对接我部署好的 Duende IdentityServer 为例：</p>\n<p>diff\nconst AuthingStrategy = require(passport-authing).Strategy;</p>\n<ul>\n<li>const OIDCStrategy = require(./passport-oidc).Strategy;</li>\n</ul>\n<p>module.exports = ({env}) => {</p>\n<ul>\n<li>const oidc = {</li>\n<li>uid: oidc,</li>\n<li>displayName: OIDC,</li>\n<li>icon: ,</li>\n<li>createStrategy: (strapi) => {</li>\n<li>\n<pre><code> return new OIDCStrategy({\n</code></pre>\n</li>\n<li></li>\n<li>\n<pre><code>   issuer: https://id6.azurewebsites.net/,\n</code></pre>\n</li>\n<li>\n<pre><code>   authorizationURL: https://id6.azurewebsites.net/connect/authorize,\n</code></pre>\n</li>\n<li>\n<pre><code>   tokenURL: https://id6.azurewebsites.net/connect/token,\n</code></pre>\n</li>\n<li>\n<pre><code>   userInfoURL: https://id6.azurewebsites.net/connect/userinfo,\n</code></pre>\n</li>\n<li></li>\n<li>\n<pre><code>   provider: oidc,\n</code></pre>\n</li>\n<li></li>\n<li>\n<pre><code>   clientID: strapi,\n</code></pre>\n</li>\n<li>\n<pre><code>   clientSecret: strapi,\n</code></pre>\n</li>\n<li>\n<pre><code>   callbackURL: strapi.admin.services.passport.getStrategyCallbackURL(\n</code></pre>\n</li>\n<li>\n<pre><code>     oidc // 需要与上面的 provider 一致\n</code></pre>\n</li>\n<li>\n<pre><code>   ),\n</code></pre>\n</li>\n<li></li>\n<li>\n<pre><code>   ipWhitelist: env(IP_WHITE_LIST, ).split(,).map(ip => ip.trim()).filter(ip => ip.length > 0),\n</code></pre>\n</li>\n<li>\n<pre><code> }, (request, accessToken, refreshToken, profile, done) => {\n</code></pre>\n</li>\n<li>\n<pre><code>   done(null, {\n</code></pre>\n</li>\n<li>\n<pre><code>     email: profile.email,\n</code></pre>\n</li>\n<li>\n<pre><code>     firstname: profile.givenName ?? profile.displayName ?? profile.email,\n</code></pre>\n</li>\n<li>\n<pre><code>     lastname: profile.familyName ?? profile.nickname ?? profile.email\n</code></pre>\n</li>\n<li>\n<pre><code>   })\n</code></pre>\n</li>\n<li>\n<pre><code> });\n</code></pre>\n</li>\n<li>}</li>\n<li>};</li>\n</ul>\n<p>return ({\nauth: {\nsecret: env(ADMIN_JWT_SECRET),\nproviders: [\nauthing,</p>\n<ul>\n<li>\n<pre><code>   oidc\n]\n</code></pre>\n},</li>\n</ul>\n<p><a name=i3v4v></a></p>\n<h1>总结</h1>\n<p>本文详细说明了如何使用 passport 策略给 Strapi 管理界面添加新的单点登录方式。</p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}}}},"staticQueryHashes":[],"slicesMap":{}}