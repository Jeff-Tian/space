{"componentChunkName":"component---src-templates-post-js","path":"/posts/gsn8f3k6b3e7nupt/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/gsn8f3k6b3e7nupt","relativePath":"posts/gsn8f3k6b3e7nupt","frontmatter":{"title":"免费架构：Heroku 不免费了，何去何从之 eggjs 的容器化部署之路","stackbit_url_path":"posts/gsn8f3k6b3e7nupt","date":"2023-03-03T10:49:08","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p><a name=TSrA8></a></p>\n<h1>前情提要</h1>\n<p>我好几年前，将自己的 eggjs 项目（<a href=\"https://github.com/Jeff-Tian/alpha\">https://github.com/Jeff-Tian/alpha</a>），部署在了 Heroku 上，运行得非常好。部署过程也非常丝滑，只需要添加一个 Procfile，内部写上：web: egg-scripts start就可以了。但是，Heroku 不再免费了（《<a href=\"https://zhuanlan.zhihu.com/p/567187898\">Free Arch: Bye-bye to Heroku - Jeff Tian的文章 - 知乎 </a> 》），做为免费架构的拥趸，我必须找一个替代方案。</p>\n<p><a name=x8pgg></a></p>\n<h1>在线演示</h1>\n<p>原来的 heroku 站点是： <a href=\"https://uniheart.pa-ca.me/\">https://uniheart.pa-ca.me/</a>，这个站点本来可以一直访问。后来知名度越来越高，导致访问额度用得比较快，导致月末会打不开，因为提前把额度用完了。最近我发现月中就打不开了……</p>\n<p>替代方案是： <a href=\"https://alpha-jeff-tian.cloud.okteto.net/\">https://alpha-jeff-tian.cloud.okteto.net/</a>，为了这个实现这个替代方案，需要对原有项目做一些改造，这正是本文接下来要详细讨论的。</p>\n<p><a name=d8HVX></a></p>\n<h1>为什么这次不是 Serverless？</h1>\n<p>之前有过将 NestJs 服务部署到 AWS Lambda 的经历：《<a href=\"https://zhuanlan.zhihu.com/p/412196725\">一顿操作猛如虎，部署一个万能 BFF - Jeff Tian的文章 - 知乎</a> 》；又有将 koa 服务部署到 Vercel Function 中的经历：《<a href=\"https://zhuanlan.zhihu.com/p/542130945\">Free Arch：将 Koa 服务部署到 Vercel - Jeff Tian的文章 - 知乎</a> 》。所以这一次如果要将 eggjs 部署成 Serverless，那是很连贯的。不料，网上已经有教程了，并且正好是将 eggjs 部署到阿里函数计算，有兴趣可以参考：《<a href=\"https://www.alibabacloud.com/help/en/function-compute/latest/deploy-an-egg-js-application-to-function-compute\">https://www.alibabacloud.com/help/en/function-compute/latest/deploy-an-egg-js-application-to-function-compute</a>》。将这三篇连起来看，不仅尝试了 nodejs 中不同的 web 框架，还体验了不同的云厂商提供的 Serverless 服务，可谓爽哉！</p>\n<p><a name=ARExn></a></p>\n<h1>起步</h1>\n<p>这是一个典型的 eggjs 项目（<a href=\"https://github.com/Jeff-Tian/alpha\">https://github.com/Jeff-Tian/alpha</a>），当你看到这篇文章时，它已经被容器化了。但是前不久，它还是一个很久没有更新了的代码库，可以说这一次又是一个复活老项目的例子。</p>\n<p>在容器化前，只要使用 nodejs 15.4.0，有 docker desktop 软件，下载到本地后，可以直接 yarn dev运行起来。当然现在仍然也是如此，总之，起步条件是该项目依赖 nodejs 15.4.0，依赖 mysql 数据库、以及 redis。\n<a name=Ml4Sq></a></p>\n<h1>容器化</h1>\n<p>这一次没有采用 Serverless，而是准备将 eggjs 项目容器化，再部署到 k8s 集群中。</p>\n<p><a name=JZqZO></a></p>\n<h2>Dockerfile</h2>\n<p>容器化的第一步，就是写一个 Dockerfile 出来。参考了 eggjs 官方的 docker，做了一些调整。因为我的 eggjs 项目，使用了 TypeScript 语言，所以要多一个构建过程。\ndockerfile\nFROM node:15.4.0-alpine</p>\n<p>ENV TIME_ZONE=Asia/Shanghai</p>\n<p>RUN\nmkdir -p /usr/src/app\n&#x26;&#x26; apk add --no-cache tzdata\n&#x26;&#x26; echo ${TIME_ZONE} > /etc/timezone\n&#x26;&#x26; ln -sf /usr/share/zoneinfo/${TIME_ZONE} /etc/localtime</p>\n<p>WORKDIR /usr/src/app</p>\n<h1>RUN npm i --registry=<a href=\"https://registry.npm.taobao.org\">https://registry.npm.taobao.org</a></h1>\n<p>COPY . /usr/src/app</p>\n<p>RUN yarn &#x26;&#x26; yarn build</p>\n<p>EXPOSE 7001</p>\n<p>CMD yarn eggstart</p>\n<p>注意，最后一行还使用了 yarn eggstart命令，这也是新加的，原本的项目中没有这个命令。因为 eggjs 默认是集群方式以守护进程模式运行，但是我们的目标是部署到 k8s 集群中，不需要集群模式，也不需要守护进程，并且希望在 pod 中保持一个实例就好，于是新加了 yarn eggstart专用在 k8s 集群中，它本质上是以下命令的快捷方式，定义在 package.json 文件中：</p>\n<p>json\neggstart: NODE_ENV=k8s EGG_SERVER_ENV=k8s eggctl start --workers=1 --no-daemon,</p>\n<p><a name=q73fH></a></p>\n<h3>小提示</h3>\n<p>在参考官方 dockerfile 时，发现官方的 Dockerfile 也有一些不太合理的地方，顺便提了个 PR 以改进： <a href=\"https://github.com/eggjs/docker/pull/3\">https://github.com/eggjs/docker/pull/3</a>。看到一些有改进空间的地方，顺手改一下，不仅方便他人；如果得到采纳，还能混个 Contributor 啥的。eggjs 算是 nodejs 生态中比较火的框架了，我就是一边使用一边在碰到问题时提出改进的 PR，就混了个 eggjs 的贡献者身份：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 90.54054054054053%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAABYlAAAWJQFJUiTwAAADbklEQVR42n2TWVPkZBiF8y+0rBqgO0mn01k73Z1eSa80a7OOw7A4gzQMBQwMUIWsgo4bMCqMVSqjTnlveeeN/+6xkgAOYHlx6v2Ser/znfMuQrG7SogatuOSL3q4uSJpN49hJxGlOFJMRZRVJDmM/wehNTZJc3CcnNeD7hTQnAJGqkCu1IczaCLZGqKSREvmSOWr2G43kmojKiZi3Arhf8dDCPnGOF5zlITlEtNTKEY6QCyRQUkb6P0yEckmpjuoVpa4mUHR0yGMNHIiGTwgqWEUzNIgVq5GNKbTJetEYgYRPyoGXVELsyWjuBpSzEEx08iag2JkiBsZVMsNFEau78UMBLdvlmxlCFExiCgm0WvETSKyhexo2A8lUm6dQqVJ3mtSqvWTL/cGinyS6Dv3BKt7CCtbJXr1gv/zOoqqSVeXhT0hoVdMFN1DTZdJZOooZi6oY/QOhHTjEW55ADkorHUj/UalFKrMzIkoqUGUdANRyxJRrnKvBNxY9gvr5CoYqeItdf9aN+jqtHEeiyTHPBRnGEnPEInp99QFCv2uFasDWJlwHP4rya+l4ugUNxLIZjlQLsWte3m+QyFuumS7ewJkinVimhN0+1aiapIwanjLFrWneexkD+93iHRKGg+iCTqDqTD5IKIiJOwsOa+JW2rg5MrB4PrjcEOmmHTKBhPNGmubK7S+NZiamWZ964BsqUq13ksy6RLXLB4PtxBU0yVf6cN2vRtl4jt2QkKd+YdjbC4tsfPdDC/32vzx6xs+nJzh6UidzcVZdjbb/Hl5ERLmyr2kC1X8893Z8sl9a+25Cd7+ss/50TFnB2u8Ot3i2cIyG7MjfLG7wN7ONisLq6Hl7voQyayHf45pqXuED0SN05Ov+en1GV8eHvD57jYnJ/usbx8yNfKIJ09WWX62yulGG8HfSX/p/W53iIn7Y3Nl+cXKCuOTi6wsfMTR3g67L9aYnxrks+d9nK31cHp2wezcQmi5UO0PLPuktwmtsIaSxuGnX/H96585fXnM+atL1ueX2Nwb5e+/fuSbg+fMTY/w8fJ6ONg+mQ9/8e8qDAl1lhcX+f23S+ZHG5zvbHG0f8zYdJs3Fz/wyfY2VS9Pe3oCwW+CX7trdbdW73qwFZO4atHoa5FJOtQ9j/7WCKVKnYHhCXqbA3RKBu91xPkHa1NdJl3++igAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/2c389ee874c9b4c118d80164f1496c1e/fcda8/1677757525298-67692f2a-846b-4910-8cc9-d7d5c7708f1c.png\"\n        srcset=\"/static/2c389ee874c9b4c118d80164f1496c1e/12f09/1677757525298-67692f2a-846b-4910-8cc9-d7d5c7708f1c.png 148w,\n/static/2c389ee874c9b4c118d80164f1496c1e/e4a3f/1677757525298-67692f2a-846b-4910-8cc9-d7d5c7708f1c.png 295w,\n/static/2c389ee874c9b4c118d80164f1496c1e/fcda8/1677757525298-67692f2a-846b-4910-8cc9-d7d5c7708f1c.png 590w,\n/static/2c389ee874c9b4c118d80164f1496c1e/efc66/1677757525298-67692f2a-846b-4910-8cc9-d7d5c7708f1c.png 885w,\n/static/2c389ee874c9b4c118d80164f1496c1e/c83ae/1677757525298-67692f2a-846b-4910-8cc9-d7d5c7708f1c.png 1180w,\n/static/2c389ee874c9b4c118d80164f1496c1e/b1ffc/1677757525298-67692f2a-846b-4910-8cc9-d7d5c7708f1c.png 1492w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>混到一些知名开源项目的贡献者，是有实际好处的，比如，可以得到 Copilot 的免费使用权：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8f74da9a89441bc9ab895ab846ce2609/d3b46/1677757653530-86bda078-042b-49f3-bbc2-9626ba694200.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.35135135135135%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB0UlEQVR42oWSyW4bMRBE9SWJx5qd+zKrxJFgx0mABMg1t/z/V7yAlJ1rDoXuJonuqi6eXFjZ0wt7emXZbxg/I3VAmkDTS87NSN2Jkv8PdSc5Va2mHh3n3vC5kXyuBU+NpGo0OiTsdKMdI0+14rk1VM0H9APtO0ptOJ0Hi5muKL8zmgXlNzoRaaxAJY9OEbk7+lnRL/o9KoZFM2yKftIFw6rpV8npudO0wtOKQDO6kp87RxN6ttcvpK8/2V+/c337gV0P3HZg14SKF6RK2LTh7mup1R44nXuLmRM6XsnNs+RMv/EjerrgpnuR7eY7Jh4l1/5AxoX1z0j8PSCWgNAXxik8GGa5fr2j44XBzFS1pp1GWqsZXESEicF6Rh8ZQ2S0MyJJ1K+KqpU8taIMEKvNDE1p8mFMPdrCsDYSe1+xtw2dlhLNsaKuM+oaUFtELyv2mLHHRBclTRwfpmRmKuw0wheHnzv1kK0SjU60BQedOehNou499eBoR0/dOc6tLb8go+xQh0uBsGvZY0bVKky8EPe8ux23JHoV+HQeHjIbURSF/YU5vbHeviH9lv+hotdTKaTbitv5LDfNA7JZwm2okPe70MpAJ+O/mN9Iv5f7TkX+AmfTNY8ITw4YAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/8f74da9a89441bc9ab895ab846ce2609/fcda8/1677757653530-86bda078-042b-49f3-bbc2-9626ba694200.png\"\n        srcset=\"/static/8f74da9a89441bc9ab895ab846ce2609/12f09/1677757653530-86bda078-042b-49f3-bbc2-9626ba694200.png 148w,\n/static/8f74da9a89441bc9ab895ab846ce2609/e4a3f/1677757653530-86bda078-042b-49f3-bbc2-9626ba694200.png 295w,\n/static/8f74da9a89441bc9ab895ab846ce2609/fcda8/1677757653530-86bda078-042b-49f3-bbc2-9626ba694200.png 590w,\n/static/8f74da9a89441bc9ab895ab846ce2609/efc66/1677757653530-86bda078-042b-49f3-bbc2-9626ba694200.png 885w,\n/static/8f74da9a89441bc9ab895ab846ce2609/c83ae/1677757653530-86bda078-042b-49f3-bbc2-9626ba694200.png 1180w,\n/static/8f74da9a89441bc9ab895ab846ce2609/d3b46/1677757653530-86bda078-042b-49f3-bbc2-9626ba694200.png 1690w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>如果没有免费特权，也极为推荐付费使用，实现编程自由（《<a href=\"https://zhuanlan.zhihu.com/p/592581927\">Copilot 与 ChatGPT，让程序员如虎添翼 —— 让 AI 们为我们打工！ - Jeff Tian的文章 - 知乎 </a> 》）。\n<a name=gINr5></a></p>\n<h2>构建脚本</h2>\n<p>有了 Dockerfile，就需要在每次的 CICD 过程中，构建它，测试它，并上传。以便最终在 k8s 集群中拉取上传的镜像，为此，可以写一个脚本文件：\nshell\ndocker build -t jefftian/alpha:$1 .\ndocker images\ndocker run --network host -e CI=true -d -p 127.0.0.1:7001:7001 --name alpha:$1\njefftian/alpha\ndocker ps | grep -q alpha\ndocker ps -aqf name=alpha$\ndocker push jefftian/alpha:$1\ndocker logs $(docker ps -aqf name=alpha$)\ncurl localhost:7001 || docker logs $(docker ps -aqf name=alpha$)\ndocker kill alpha || echo alpha killed\ndocker rm alpha || echo alpha removed</p>\n<p>不妨给该脚本文件起个名字叫 dockerize.sh。注意，它接受一个参数，是为了给镜像打 tag 用。它不仅可以在 CICD 过程中跑，如果需要在本地测试一下，也是可以的：\nshell\nsh ./dockerize.sh test-tag</p>\n<p><a name=ZAdVk></a></p>\n<h1>SOPS</h1>\n<p>安装 SOPS，通过 SOPS 加密它后再保存在代码库中。本地可以通过 brew install sops之类的方式来安装它，但是我样在 CICD 过程中，也需要用 SOPS 来解密，所以还需要在 CICD 流水线中安装它，命令如下，后面会用到：\nyaml</p>\n<ul>\n<li>run: wget <a href=\"https://github.com/mozilla/sops/releases/download/v3.7.3/sops-v3.7.3.linux.amd64\">https://github.com/mozilla/sops/releases/download/v3.7.3/sops-v3.7.3.linux.amd64</a></li>\n<li>run: sudo cp sops-v3.7.3.linux.amd64 /usr/local/bin/sops</li>\n<li>run: sudo chmod +x /usr/local/bin/sops</li>\n</ul>\n<p>在安装了 SOPS 后，要在项目中启用，还需要在项目根目录创建一个 .sops.yaml 文件，来定义规则，比如对哪个文件进行保护等等：</p>\n<p>yaml\ncreation_rules:</p>\n<h1>If assuming roles for another account use arn+role_arn.</h1>\n<h1>See Advanced usage</h1>\n<ul>\n<li>path_regex: k8s/secrets.yaml$\nkms: arn:aws:kms:us-east-1:443862765029:key/b1739688-ec15-407d-895d-d05ca1217a2f\naws_profile: lambda-doc-rotary</li>\n</ul>\n<p>以上配置定义了对 k8s/secrets.yaml 文件进行加密保护，并指定了采用 AWS KMS 的名为 lambda-doc-rotary 的秘钥进行加解密。为了使用该秘钥，还需要记下对应的 aws access_key 和 secret_key，并保存在 ~/.aws/config文件中：\nyaml\n[lambda-doc-rotary]\naws_access_key_id = xxx\naws_secret_access_key = yyy</p>\n<p>为了在 CICD 过程中成功连接 AWS KMS，可以使用命令行动态生成上述文件，比如：</p>\n<p>yaml</p>\n<ul>\n<li>run: mkdir ${HOME}/.aws</li>\n<li>run: echo -e [lambda-doc-rotary]naws_access_key_id = ${{secrets.AWS_ACCESS_KEY}}naws_secret_access_key = ${{secrets.AWS_SECRET_KEY}}n > ~/.aws/config</li>\n</ul>\n<p>配置好了 AWS KMS，加密文件只需要：</p>\n<p>shell\nsops -e -i k8s/secrets.yaml --aws-profile lambda-doc-rotary</p>\n<p>解密文件只需要：</p>\n<p>shell\nsops -d -i k8s/secrets.yaml --aws-profile lambda-doc-rotary</p>\n<p><a name=UMU42></a></p>\n<h1>配置 GitHub Actions Secrets</h1>\n<p>我们准备使用 GitHub Actions 来做 CICD。在 CICD 过程中需要连接一些使用密码的服务，这些密码，我们保存在 GitHub Actions 的 Secrets 里。对于我们要做的，将 eggjs 部署到 k8s 中，需要使用到如下的秘密值：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/23c6b8b52957cfc82fc960901154301a/6e52c/1677810242929-5db2324c-ec97-4aca-8e4e-717278ce09d6.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 102.02702702702702%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAABYlAAAWJQFJUiTwAAADAElEQVR42o1Uy66kNhTk/z8g+YPMIj8QadZZj2YTJYuZ27cbcAPGbwM2tis6pp9ZBamETVvV51TVcWP9AqkNLh1DxwZ01wHntgcbJgzTDHYdwYWqkNrWs7Sm36ZZwpoFRnqkULAtOxrnF1jnEWJE3BNC3LGFAL+sEFJhFgQJPosK2tOZZd2wx4QP0eE7+xt/8Z/4IS9orHVY1xX/fbZtA+czhBD1rZQCnyaImQMoQEn13NfTn/j1+xf88u03/P7PH2ic81iWBSkdB0op9e39gp4xdD1D23bohhntZHGZPH4yjR+9RnedILmA4goTm+CUQ6ONQd8zTJwjxvio0DqH86XF+XzBx+kTp88Lzv2Ij37G51XixGTVcZ5nCCmhtIZfFjTGWChtIJV+IwwhQNfvClrrCqM1xEztSxitqhxSKnjvEULEvu+HhqRPzrm2e28553KTImNdN/zfp6nOzeKh3x1ERPpSCggx7oj7/nzf1pQGAp0h9xttLGYhaouvptDhYRKPvK1hxxriC479yAWuIwcbOaxb0FyHEZ/nM6y1b4TU8pM8VpOoYsosyUR7AlVXbu3mUtAYa7Es7zl81fL4cPxByvmJ9AQR3T1ojHWVkBzatvDII01NNwy4DB1GNcGHFesWnwg0UQfuEmykIY1V23WQUta2iZielApG22MwHbgbIOIVMSXse8KejhFdt1BBa9KP1g3N5jBM4JR4bWoLZEjaMybbQwoFozxcEijIuAtGJiqlUTtcV5B0dAc02ji0bX9cECEeuBHO6xXKzbDewKQJpeSHtiQN5ZNIyLQamxDRkJiU+HV7D29OBdJxdOoDzJzgkgRx5ZthNGY076Q/3VRUKXnQUJukY3XpxWEi5I5h1D1GxSDDgIJn8ElLIqV2SaJKGG6EdDHQmL3lMBVMrq9Dr4SB3Maq4WOScr5l0dfKHoRCyHpNtV3/aJsqqRV6BuMMlDRQd8L8JKTqSMcj+P4gfJ3ft8shFcyeQZoZuSQskMjl6TJJREZQ22TGvcJ/AYTaCxoC6Z80AAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/23c6b8b52957cfc82fc960901154301a/fcda8/1677810242929-5db2324c-ec97-4aca-8e4e-717278ce09d6.png\"\n        srcset=\"/static/23c6b8b52957cfc82fc960901154301a/12f09/1677810242929-5db2324c-ec97-4aca-8e4e-717278ce09d6.png 148w,\n/static/23c6b8b52957cfc82fc960901154301a/e4a3f/1677810242929-5db2324c-ec97-4aca-8e4e-717278ce09d6.png 295w,\n/static/23c6b8b52957cfc82fc960901154301a/fcda8/1677810242929-5db2324c-ec97-4aca-8e4e-717278ce09d6.png 590w,\n/static/23c6b8b52957cfc82fc960901154301a/efc66/1677810242929-5db2324c-ec97-4aca-8e4e-717278ce09d6.png 885w,\n/static/23c6b8b52957cfc82fc960901154301a/c83ae/1677810242929-5db2324c-ec97-4aca-8e4e-717278ce09d6.png 1180w,\n/static/23c6b8b52957cfc82fc960901154301a/6e52c/1677810242929-5db2324c-ec97-4aca-8e4e-717278ce09d6.png 1948w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>其中 AWS_ACCESS_KEY 和 AWS_SECRET_KEY 是给 sops 加解密用的，而 DOCKER_USERNAME 和 DOCKER_PASSWORD 是用来推镜像使用。GH_TOKEN 后面会再次介绍，这是为了拉取我的私人仓库用的，这个仓库里保存了 k8s 集群的信息。</p>\n<p><a name=auLoW></a></p>\n<h1>配置 CICD 流水线</h1>\n<p>容器化完成后，就可以在 CICD 流水线中使用它了。先看一下最终效果：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/efb62f7516f77adaa342acc3a40523d4/8d294/1677811304732-e6b3cda9-664a-4fc4-9d30-01f513f7dd7b.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 54.72972972972974%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB40lEQVR42mWSWU8bMRRG50e3glKWCCgUKGWJCPBSVeoP6ksfkEoXITWZJMzmZWyPZ+ZUdkJQi6Wj796rK9/FTj59/sLw6oajD2ccf7xY6Ok5x6cXnA+vuRzdMhzdPuvVDWeXoxecD0cxP9nZP2Jt+4CNwXvebO2yEdjeY+/ghL3DE3bfHbF/eLJic7DP2tsd1jcHURcMeL2+xav1TZIOUA0IBz44y9P10PNM+5/f8/KEWFKIiizLkFJSVYKirCiLkjLPoy2kwhiLtW6FWWrTeFzTRILdeE8yzmb8fnggTWek6ZTJJGU6mzNJp4wnKXle0LXtcxd9v6Lrun/8QFKJOlaLY3WLQawxsVutNXkl0R6UWnQqpEQqRdu2eO+fqqwKJvMqIy8KhBCrBF3XCKmxrqG2DbXz0X7CxfHaiItj+5UdL3zMskWXy0pZXpLOHrGuRRtHHbANxvqoOrCM1UtbGRc1KSuBVHr1SuHUjWMyn1GIkvDwvu2olGZe5MR8XaNqSyYFWSkwoUu/KJ44a6mFoA+LD0vuOqzWqFJQyDHKzPGuRRmLrE28SBuLdh41naC/fcX8/I6RKnaeYA1M/9BnM5iO6cuM5v4O9+seFxJ/3GGKAuO7uD/jPGapNnwnpTEB42LsL6giI8z+P8psAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/efb62f7516f77adaa342acc3a40523d4/fcda8/1677811304732-e6b3cda9-664a-4fc4-9d30-01f513f7dd7b.png\"\n        srcset=\"/static/efb62f7516f77adaa342acc3a40523d4/12f09/1677811304732-e6b3cda9-664a-4fc4-9d30-01f513f7dd7b.png 148w,\n/static/efb62f7516f77adaa342acc3a40523d4/e4a3f/1677811304732-e6b3cda9-664a-4fc4-9d30-01f513f7dd7b.png 295w,\n/static/efb62f7516f77adaa342acc3a40523d4/fcda8/1677811304732-e6b3cda9-664a-4fc4-9d30-01f513f7dd7b.png 590w,\n/static/efb62f7516f77adaa342acc3a40523d4/efc66/1677811304732-e6b3cda9-664a-4fc4-9d30-01f513f7dd7b.png 885w,\n/static/efb62f7516f77adaa342acc3a40523d4/c83ae/1677811304732-e6b3cda9-664a-4fc4-9d30-01f513f7dd7b.png 1180w,\n/static/efb62f7516f77adaa342acc3a40523d4/8d294/1677811304732-e6b3cda9-664a-4fc4-9d30-01f513f7dd7b.png 2706w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>可以看到这个流水线配置了 3 个步骤，第一步是验证项目的功能正常，其中包括了测试和构建项目；如果这一步通过，那么就进行容器镜像的构建。容器构建完毕，会上传到 Docker Hub：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/78e85ddf6fc5d2ffe8e6b103614229c1/0e909/1677839365332-50d8aa86-8b48-4e48-92e3-ab5664a09a87.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.91891891891892%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABYUlEQVR42p2RXUscMRSG5896I70TvBC90ILYm/4Ii6CrrSurFfwJfrBWsFeKFnZn/aqdyexk8v2UZFdXoWDxwJO8JOecvEmyD18umV69YG7ziqVOn/l2zueDGz7tD1j+PmBl/4bFzoCZVo+ZzTGtHrNbfea385S/0M75uDtIOts4EawfC752BTvdgrVDwd65TLR/VLRPBd+6gvWj8hUbxyWtkxFxv3NWsX1akfEiftUOrYYU933EQw54/j8C4MisCxACdzIwtXvNz95vynLIY1GijMUHcD68iXU+8cqhcw6fEnh3ZMZYrHVobaiqimooEbVBKZ0OiOsx519YO6qdYMli4RNSmUSjLVJZtB07dj41H80THZvGunjoE1kc4qIxhrs/NfmD4LaQFNLT6OhQP1/He4/zk/eIjpRSSNlQlGXSzw3jXI9dEXz6KOcsw7pOblKz5MwlPSIQQki6aRRKa/4CnIGnkyh1G5kAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/78e85ddf6fc5d2ffe8e6b103614229c1/fcda8/1677839365332-50d8aa86-8b48-4e48-92e3-ab5664a09a87.png\"\n        srcset=\"/static/78e85ddf6fc5d2ffe8e6b103614229c1/12f09/1677839365332-50d8aa86-8b48-4e48-92e3-ab5664a09a87.png 148w,\n/static/78e85ddf6fc5d2ffe8e6b103614229c1/e4a3f/1677839365332-50d8aa86-8b48-4e48-92e3-ab5664a09a87.png 295w,\n/static/78e85ddf6fc5d2ffe8e6b103614229c1/fcda8/1677839365332-50d8aa86-8b48-4e48-92e3-ab5664a09a87.png 590w,\n/static/78e85ddf6fc5d2ffe8e6b103614229c1/efc66/1677839365332-50d8aa86-8b48-4e48-92e3-ab5664a09a87.png 885w,\n/static/78e85ddf6fc5d2ffe8e6b103614229c1/c83ae/1677839365332-50d8aa86-8b48-4e48-92e3-ab5664a09a87.png 1180w,\n/static/78e85ddf6fc5d2ffe8e6b103614229c1/0e909/1677839365332-50d8aa86-8b48-4e48-92e3-ab5664a09a87.png 3008w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>最后，该镜像会在部署到 k8s 集群时被拉取。</p>\n<p><a name=Fz6dR></a></p>\n<h2>准备 k8s 声明文件</h2>\n<p>创建一个 k8s 文件夹，用来存放所有 k8s 声明文件。\n<a name=Mxwcy></a></p>\n<h3>准备秘密文件</h3>\n<p>该项目依赖 MySQL 数据库和 REDIS，其连接信息要通过环境变量传入运行时，所以我们创建一个 secrets.yaml 文件，放在项目中新建的 k8s 目录下：\nyaml\napiVersion: v1\nkind: Secret\nmetadata:\nname: alpha-secrets\nlabels:\nbranch: main\ntype: Opaque\nstringData:\nMYSQL_HOST: alpha.xxxx.rds.cn-northwest-1.amazonaws.com.cn\nMYSQL_PORT: 3306\nMYSQL_USERNAME: admin\nMYSQL_PASSWORD: yyyy\nMYSQL_DATABASE: alpha\nREDIS_URI: redis://username:password@host:port</p>\n<p>这样的秘密文件，显然不能明文存储在代码库中，于是我们需要加密它。这就要用到前面提到的 sops，后面还会再次提到。</p>\n<p><a name=cDClO></a></p>\n<h3>准备 kustomization.yaml</h3>\n<p>yaml\napiVersion: kustomize.config.k8s.io/v1beta1\nkind: Kustomization</p>\n<p>bases: []\nresources:</p>\n<ul>\n<li>deployment.yaml</li>\n<li>service.yaml</li>\n</ul>\n<p><a name=R99bT></a></p>\n<h3>准备 service.yaml</h3>\n<p>yaml\napiVersion: v1\nkind: Service\nmetadata:\nname: alpha\nannotations:\ndev.okteto.com/auto-ingress: true\nspec:\ntype: ClusterIP\nports:\n- name: tcp\nport: 7001\nprotocol: TCP\ntargetPort: 7001\nselector:\napp: alpha\ntier: backend</p>\n<p><a name=hAMK4></a></p>\n<h3>准备 deployment.yaml</h3>\n<p>shell\napiVersion: apps/v1\nkind: Deployment\nmetadata:\nlabels:\napp: alpha\ntier: backend\ndeployedBy: deploy-node-app\nname: alpha\nspec:\nminReadySeconds: 5\nprogressDeadlineSeconds: 600\nreplicas: 2\nrevisionHistoryLimit: 10\nselector:\nmatchLabels:\napp: alpha\ntier: backend\nstrategy:\nrollingUpdate:\nmaxSurge: 1\nmaxUnavailable: 0\ntype: RollingUpdate\ntemplate:\nmetadata:\nlabels:\napp: alpha\ntier: backend\ndeployedBy: deploy-node-app\nspec:\ncontainers:\n- image: jefftian/alpha\nimagePullPolicy: Always\nname: alpha\nports:\n- containerPort: 7001\nname: http\nprotocol: TCP\nresources:\nlimits:\ncpu: 500m\nmemory: 512Mi\nrequests:\ncpu: 250m\nmemory: 256Mi\nenvFrom:\n- secretRef:\nname: alpha-secrets\nrestartPolicy: Always\nterminationGracePeriodSeconds: 30</p>\n<p><a name=M25jq></a></p>\n<h2>流水线第一步：验证项目</h2>\n<p>这一步是先安装依赖，再跑测试，最后验证构建。即 yarn install、yarn test、yarn build。</p>\n<p><a name=OHduw></a></p>\n<h2>流水线第二步：构建容器镜像</h2>\n<p>本质上是调用前面的容器化脚本，只不过，这里使用了 github.sha 做为参数传递给这个脚本。</p>\n<p>yaml\nbuild-docker-image:\nruns-on: ubuntu-latest\nneeds: build\nsteps:\n- uses: actions/checkout@v3\n- run: echo ${{secrets.DOCKER_PASSWORD}} | docker login -u ${{secrets.DOCKER_USERNAME}} --password-stdin\n- run: git_hash=$(git rev-parse ${{ github.sha }})\n- run: sh .github/dockerize.sh ${{ github.sha }}</p>\n<p><a name=IKdyz></a></p>\n<h2>流水线第三步：部署到 k8s 集群</h2>\n<p>按《<a href=\"https://zhuanlan.zhihu.com/p/571009896\">Free Arch: 使用 OAM 摆脱厂商锁定 - Jeff Tian的文章 - 知乎</a> 》提到的，可以同时部署到多个 k8s 集群。步骤是一样的，只是连接信息不同。这里再次以 Okteto 为例。</p>\n<p>本质上这里先使用 SOPS 解密秘密文件，并应用到 k8s secrets；然后，应用 k8s kustomization；最后，如果只是更新镜像，可以使用 kubectl set image deployment alpha alpha=jefftian/alpha:新Tag。</p>\n<p>yaml\ndeploy-okteto:\nruns-on: ubuntu-latest\nneeds: build-docker-image\nsteps:\n- uses: actions/checkout@v3</p>\n<pre><code>- run: mkdir ${HOME}/.aws\n- run: echo -e [lambda-doc-rotary]naws_access_key_id = ${{secrets.AWS_ACCESS_KEY}}naws_secret_access_key = ${{secrets.AWS_SECRET_KEY}}n > ~/.aws/config\n\n- run: wget https://github.com/mozilla/sops/releases/download/v3.7.3/sops-v3.7.3.linux.amd64\n- run: sudo cp sops-v3.7.3.linux.amd64 /usr/local/bin/sops\n- run: sudo chmod +x /usr/local/bin/sops\n\n- run: curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl\n- run: chmod +x ./kubectl\n- run: sudo mv ./kubectl /usr/local/bin/kubectl\n- run: mkdir ${HOME}/.kube\n- run: npm i -g k8ss\n- run: echo -e machine github.comn  login ${{secrets.GH_TOKEN}} > ~/.netrc\n- run: git clone https://github.com/Jeff-Tian/k8s-config.git ${HOME}/k8s-config\n- run: k8ss switch --cluster=okteto --namespace=jeff-tian\n- run: sops -d k8s/secrets.yaml --aws-profile lambda-doc-rotary | kubectl apply -f -\n- run: kubectl apply -k k8s\n- run: kubectl set image deployment alpha alpha=jefftian/alpha:${{ github.sha }}\n</code></pre>\n<p>完整的 CICD 流水线代码详见： <a href=\"https://github.com/Jeff-Tian/alpha/blob/master/.github/workflows/nodejs.yml\">https://github.com/Jeff-Tian/alpha/blob/master/.github/workflows/nodejs.yml</a>。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/04a298e523abac4c7139da2132a07026/b7a14/1677840443423-3e92804c-3f10-4139-b5c4-89e788a2fc41.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.27027027027027%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABpElEQVR42mWR224aQRBE+YUYO2aBvcz9srMLC4ttSBRHUfwY5SH//y0nmsFBivxQ6pamVTpVs5gvb9jhzDi/spu/MxxfmZ5/cHj5WXYVTh8k/fzfFG5GhxNud2FxurwxHr/h0jO2fyoPfjzjhzOdnWj1/ipznZ2ZUP6IsIdimO/i9BW3+4Lpn1j8+v2Hw3xm2yg2tWTzb75rvRVsalVmteloOoP1A1IHQpqRJmFcIu1faIRnkQ9cGItCHIlxV/aY9oR+h48j/TCV3YWhSGpP3Wqa7qpNLagbxcPjlkV2VXZAmURwA70faEVAuXQzi2nCh7Eo02Ui43qE8iVFTrdatywf1izqziJNj7IJ7xLRDwgVUbbH+lRIs7J5psxGrbDFpNTxXsWqarj/fDNMhTITpjAidY92A9rEK5FNKB1RJpbucryrSctj1ZSoWYWw6SydCtStQXYWLR3bxtAIS9PqQiOcRvUWFSwiGGS0mOTRvWW97UrcW+TcYStj+SFvAykmauGQuYIwEOKefk6IKGm9pLItlWnogmRjtnxarrhbVtzdV2X/CwjJA/RlHk3RAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/04a298e523abac4c7139da2132a07026/fcda8/1677840443423-3e92804c-3f10-4139-b5c4-89e788a2fc41.png\"\n        srcset=\"/static/04a298e523abac4c7139da2132a07026/12f09/1677840443423-3e92804c-3f10-4139-b5c4-89e788a2fc41.png 148w,\n/static/04a298e523abac4c7139da2132a07026/e4a3f/1677840443423-3e92804c-3f10-4139-b5c4-89e788a2fc41.png 295w,\n/static/04a298e523abac4c7139da2132a07026/fcda8/1677840443423-3e92804c-3f10-4139-b5c4-89e788a2fc41.png 590w,\n/static/04a298e523abac4c7139da2132a07026/efc66/1677840443423-3e92804c-3f10-4139-b5c4-89e788a2fc41.png 885w,\n/static/04a298e523abac4c7139da2132a07026/c83ae/1677840443423-3e92804c-3f10-4139-b5c4-89e788a2fc41.png 1180w,\n/static/04a298e523abac4c7139da2132a07026/b7a14/1677840443423-3e92804c-3f10-4139-b5c4-89e788a2fc41.png 2864w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}}}},"staticQueryHashes":[],"slicesMap":{}}