{"componentChunkName":"component---src-templates-post-js","path":"/posts/ssgxk1c230khqtuh/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/ssgxk1c230khqtuh","relativePath":"posts/ssgxk1c230khqtuh","frontmatter":{"title":"【已解决】spring-boot - 无效的 JWToken : kid is a required JOSE Header","stackbit_url_path":"posts/ssgxk1c230khqtuh","date":"2022-12-11T12:58:02","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p><a name=I91RU></a></p>\n<h1>前情提要</h1>\n<p>之前在《<a href=\"https://zhuanlan.zhihu.com/p/533197284\">使用 IdentityServer 保护 Web 应用（AntD Pro 前端 + SpringBoot 后端） - Jeff Tian的文章 - 知乎</a> 》中记录了如何使用 IdentityServer 保护 SpringBoot 后端服务，其中提到由于 IdentityServer 默认颁发的 jwt 类型是 at+jwt，不能被 SpringBoot 应用识别，所以需要额外对 IdentityServer 颁发 jwt 的代码做些小修改，以适配 SpringBoot 应用。</p>\n<p><a name=KXhcM></a></p>\n<h1>问题</h1>\n<p>使用 IdentityServer 做身份认证，还是需要写些代码的。而使用 Authing.cn，则基本上只需要配置即可。今天又折腾了一下使用 Authing.cn 来保护 SpringBoot 应用，没有碰到 at+jwt的问题，但是却碰到了另一个问题： 无效的 JWToken : kid is a required JOSE Header。</p>\n<p>json\n{\nerror: invalid_token,\nerror_description: Invalid JWT/JWS: kid is a required JOSE Header\n}</p>\n<p><a name=qcI0M></a></p>\n<h1>解决办法</h1>\n<p>使用 Authing.cn，基本上不需要写代码，但是需要做一些配置。以上的问题，就出在 Authing.cn 默认的 id token jwt 颁发时采用的签名算法，是 HS256。但它提供了 RS256 的选项，解决办法就很简单，选用 RS256 即可。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a186bd77ab21cc88aeae083c47ba6794/f3a19/1670757532821-f2ade27c-d752-44a8-abf9-295e698d65f2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 90.54054054054053%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC6ElEQVR42pVUTXPbNhDlf2ns2FHG+fBM+ud67kwPTazYkuUkM500/yH33HrtqTk00XiUUDRJkAAIECBB8GV2JTVy2kOKmdVSS/Jx374HJPdPTvHo8RPcmzzA0fF9nJ7+iJOHp/jh8B4O71JMcHB4jLtHExweTfiZyeQEB9v7dw6OuU736Tr5+ZczTJ/P8PTZczw7O8fV1StMLxb49XyBF1cvMb+8wnR6jtlsgdl8gcXiBX5//QYXF3PM5wucTS+4Pptf8nNJmmbIshxt6zECiPSzXX3fI8aI/7OSqlYoSgFjHYz1nPs+QDUeda1g2xbDMDDwMES+3sV+LYTAOamUQyEsvO84WtchxgFFHSAqDWDkzsdx5Ah7YLsa10PgWlLKgOssgLI0AZXu4fsRfWegRQa4lqnQS9+ufcDd/0SZgGVqsS4d6iagVIEmiXd/Ovz0m8bq7wxaSjTGQemGozEWjWn/e4bOdyiFQCkqtM4zZQJcph5v/6iRr25g8hyysailgpQaSm2A6V3nPI/KeQ9rWyQkwupTinWWw/meAfsQMcYA21SoihLy4xJFWSEvBEcpapRlBRJUVJIzRZ6XSKj1z2mGWmr4LsC2HStHtJQ2Gx5lDoT++2xDs6EOSyH/ASSVMxEhqgbGOTRZhu7TCm6I0LphpUl9oUZU0sEYw+NiUYhydlNAVGoD6DqEIbKpjW0RSUUy9/WSZxtvqf1V5Rg3OdFNy4C29TxD6nAcI1aZx00hYenroYf86wPWHwr4voNpLMZxgFDgDls2f9xRblkQ6nQnSggDC0M0MG6MPSiN8P496DXuhmojGGhncgakDglQyoYp7wBpjkTbdx1nXtdLjPkNoGqgFkCj/2X0RCqDdVbc7nA7Q601jLHste1pAcga1oM9CFFiHMKtrZkQwA5sH5CEUEozHQoC8MZgWKeoViVsmjIgvtmSDLiJzS4hcei0oc0ulWY/UpdkZCFqtkjvHRAHxO0hsR9fABXgMM7IdLvnAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/a186bd77ab21cc88aeae083c47ba6794/fcda8/1670757532821-f2ade27c-d752-44a8-abf9-295e698d65f2.png\"\n        srcset=\"/static/a186bd77ab21cc88aeae083c47ba6794/12f09/1670757532821-f2ade27c-d752-44a8-abf9-295e698d65f2.png 148w,\n/static/a186bd77ab21cc88aeae083c47ba6794/e4a3f/1670757532821-f2ade27c-d752-44a8-abf9-295e698d65f2.png 295w,\n/static/a186bd77ab21cc88aeae083c47ba6794/fcda8/1670757532821-f2ade27c-d752-44a8-abf9-295e698d65f2.png 590w,\n/static/a186bd77ab21cc88aeae083c47ba6794/efc66/1670757532821-f2ade27c-d752-44a8-abf9-295e698d65f2.png 885w,\n/static/a186bd77ab21cc88aeae083c47ba6794/f3a19/1670757532821-f2ade27c-d752-44a8-abf9-295e698d65f2.png 1086w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>问题就这样简单地解决了，但是要定位到这个地方，没有经验的话，还真不是那么简单直接的。</p>\n<p><a name=BbQUR></a></p>\n<h1>分析</h1>\n<p>根据错误提示，可以了解到是使用 Authing.cn 登录之后得到的 jwt 没有携带 Key Id 这个标头。jwt 是由三个部分组成的，使用点号分隔。可以使用 jwt.io 来查看解码后的内容。在 id_token  默认使用 HS256 签名算法时，可以看到其头部的确没有 kid 这个字段：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c1aace410c92cf4ab7a376d824d99298/6bfbb/1670757784099-72158280-510c-48b3-90af-e50c16333179.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 64.86486486486486%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACKElEQVR42m2S209TQRCHt7QQmuiTkURfjU9GoNcUWlpEiVGDmuC/r0KLUGihV7pnr5/ZPQcr6Jx82d2ZOZP5za5o779ld7dFuVLl1VaFcqUeqdYa1OoNms09arUG26Uq1XqDUrmWxXdoVCs0d3bjuVSuUKnUEUII1h8/4eWLOhsbz3m68QwhVhAiH8nn11hdK8a1UFhndbXISn4NkSuQEyvkcgWEKFAsPkr/fXd4yPHRF46/feXL5w5HH1u0W5t09pYc7Jcib9rbHHRK7Le3oj/ktZuv6bQ2+fB+h6NPLQTRLFadgx2CGwKj+/hrnL7MYjf/xoPPX8e4cM6B5555vySYMTCbS7T2f1L9fwgWO0yShKvBFTfjEdoatNH4B18wKRf0+xdMxmOM0SiVYHSW61NiwdClnS2wk1vcdBHxd4xvcdLEbrVWzOYzEqVIjMFYi/MepzXOmIhIJXpMX6N+alRPo07vUKgThTp3eBc6cJBo/PQWPxqFlmE8gh/fYTiA0c2yoB5C8itFdkH2lmc9SHNsGIdUuMkUPxykMhOJjyNiKTls1IVHdj3JWYo89ciT1KcHPko2xkS5zjtcNirnSWWHvXOIu2GqK0/S/atoL6PrUX2fSsbj5qBHHqc8VnpcIElrhLteSr6EpAvhOSZB7ikkZ5mvnz2jUFCmZzuHMNKHJqy1UYrsWxZnGeeWRS/b9yzyIs0xYYYLi5pY9NRgpMFoG2/XBqzlN6KyaBu+h6OzAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/c1aace410c92cf4ab7a376d824d99298/fcda8/1670757784099-72158280-510c-48b3-90af-e50c16333179.png\"\n        srcset=\"/static/c1aace410c92cf4ab7a376d824d99298/12f09/1670757784099-72158280-510c-48b3-90af-e50c16333179.png 148w,\n/static/c1aace410c92cf4ab7a376d824d99298/e4a3f/1670757784099-72158280-510c-48b3-90af-e50c16333179.png 295w,\n/static/c1aace410c92cf4ab7a376d824d99298/fcda8/1670757784099-72158280-510c-48b3-90af-e50c16333179.png 590w,\n/static/c1aace410c92cf4ab7a376d824d99298/efc66/1670757784099-72158280-510c-48b3-90af-e50c16333179.png 885w,\n/static/c1aace410c92cf4ab7a376d824d99298/c83ae/1670757784099-72158280-510c-48b3-90af-e50c16333179.png 1180w,\n/static/c1aace410c92cf4ab7a376d824d99298/6bfbb/1670757784099-72158280-510c-48b3-90af-e50c16333179.png 1514w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>在 Authing 控制面板里将这个签名算法改为 RS256 后，可以看到，已经有 kid 字段了：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3c4dec705e76398eea5c5d196f026675/7be33/1670763307239-494c5ace-4204-4c70-b822-00fb895507cb.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.48648648648649%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAAB1ElEQVR42q2Ry24TMRSGR3mCKCC6YAtLVHK/CZ6IJlEWUaAbVIl3hIrSXJuEIFXNZWzP2OdD9kxbRFdI2Pr1j491vvmPHLU772m3u5yWa7wpN6jVmlSqTeqNNq1Wl073HZVKI6+1KFfq1PxdvUG36WsdypVq6Dt9WyWKoojii1e8PHnNs+clCoWCL/6zisUipVKJ6OzsA5/PLzi/+MKnj2OGwyG9Xo9+v0+/n/lgMAjKak/le0ajEePxmIj/vCLnHLvdjpv1mv3hgDaGJE2xzj0oTVOMMWy3WzbrDSqO0UqhlAp31toHhYTOWtKjwsU6SIIMctTIUSHWIsBRxcRao5Mk/NSJPFEAik6Q7yvk8gb5tkSu1sjXBe7qJ/byF3LnoQkSK+R2h9ztEWPgbzmXJ9QOMzWYicFca8w8Ca7nDjUDe5sg2zWyWiGTGfJjmvm9pjNkPkfiOAcaQc1BTXP57wXopT8L9gCCECuF8Ul9j7jHUZ3DucwzYCKomaAXgpoI6lrQ/rzM6hnQYRNHuhdc4kP4ycDGIJI/sfAH0IMmBEDwKeh5Brf7DChWMBtI7yT0iAjiMg8z3D+KH9msJIyYJQO9yIBeIYUHOiHdQbp7BIZYOczv3xsTI7gxLFm7AAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/3c4dec705e76398eea5c5d196f026675/fcda8/1670763307239-494c5ace-4204-4c70-b822-00fb895507cb.png\"\n        srcset=\"/static/3c4dec705e76398eea5c5d196f026675/12f09/1670763307239-494c5ace-4204-4c70-b822-00fb895507cb.png 148w,\n/static/3c4dec705e76398eea5c5d196f026675/e4a3f/1670763307239-494c5ace-4204-4c70-b822-00fb895507cb.png 295w,\n/static/3c4dec705e76398eea5c5d196f026675/fcda8/1670763307239-494c5ace-4204-4c70-b822-00fb895507cb.png 590w,\n/static/3c4dec705e76398eea5c5d196f026675/efc66/1670763307239-494c5ace-4204-4c70-b822-00fb895507cb.png 885w,\n/static/3c4dec705e76398eea5c5d196f026675/c83ae/1670763307239-494c5ace-4204-4c70-b822-00fb895507cb.png 1180w,\n/static/3c4dec705e76398eea5c5d196f026675/7be33/1670763307239-494c5ace-4204-4c70-b822-00fb895507cb.png 1558w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><a name=ADcee></a></p>\n<h1>附</h1>\n<p>整个对接  Authing.cn 的步骤，和《<a href=\"https://zhuanlan.zhihu.com/p/533197284\">使用 IdentityServer 保护 Web 应用（AntD Pro 前端 + SpringBoot 后端） - Jeff Tian的文章 - 知乎</a> 》中列出的一模一样。只是配置有些区别，比如我的 application.yml是这样的：</p>\n<p>yaml</p>\n<p>security:\noauth2:\nresource:\nurl: 6389cf494b2e2b25f818ab6d\njwk:\nkey-set-uri: <a href=\"https://brickverse.authing.cn/oidc/.well-known/jwks.json\">https://brickverse.authing.cn/oidc/.well-known/jwks.json</a>\ntoken-type: Bearer\ntoken-info-uri: <a href=\"https://brickverse.authing.cn/oidc/token\">https://brickverse.authing.cn/oidc/token</a></p>\n<p>logging:\nlevel:\norg.springframework.security: TRACE</p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}},"menus":{}}},"staticQueryHashes":[],"slicesMap":{}}