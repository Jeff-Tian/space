{"componentChunkName":"component---src-templates-post-js","path":"/posts/znigq6/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/znigq6","relativePath":"posts/znigq6","frontmatter":{"title":"扩展 Keycloak 之添加自定义 restful 接口","stackbit_url_path":"posts/znigq6","date":"2023-03-15T04:17:00","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p><a name=uBMmN></a></p>\n<h1>什么是 Keycloak？</h1>\n<p>Keycloak 是基于 Java 的开放身份认证系统。基本上只需要部署它，就能开箱即用，无需编写代码。然而，如果希望扩展它，基于它做二次开发，也是完全可以的，它提供了丰富的扩展机制。</p>\n<p><a name=JUPiX></a></p>\n<h1>今天要扩展什么？</h1>\n<p>今天，我们来基于 Keycloak，增加一个自定义的 restful 接口，这个接口通过 GET 方式访问，返回一个 JSON。最后的效果是这样，你可以点击以下两个链接体验：</p>\n<ul>\n<li>基于 JBoss Keycloak 16.1.1，部署在 Heroku 上： <a href=\"https://keycloak.jiwai.win/auth/realms/master/my-rest-resource/hello\">https://keycloak.jiwai.win/auth/realms/master/my-rest-resource/hello</a></li>\n<li>基于 quay.io Keycloak 21.0.1，部署在 Okteto 上： <a href=\"https://keycloak-jeff-tian.cloud.okteto.net/realms/master/my-rest-resource/hello\">https://keycloak-jeff-tian.cloud.okteto.net/realms/master/my-rest-resource/hello</a></li>\n</ul>\n<p><a name=emmfm></a></p>\n<h1>源代码在哪里？</h1>\n<p><a href=\"https://github.com/Jeff-Tian/keycloak-heroku\">https://github.com/Jeff-Tian/keycloak-heroku</a>，今天聊的核心提交是： <a href=\"https://github.com/Jeff-Tian/keycloak-heroku/commit/50f18ba53ccea7eeda8ea34bd66a3b8f660b80cf\">https://github.com/Jeff-Tian/keycloak-heroku/commit/50f18ba53ccea7eeda8ea34bd66a3b8f660b80cf</a>。\n<a name=jcXSu></a></p>\n<h1>准备工作</h1>\n<p>在自定义前，先部署未自定义的版本，确保能够正常运行起来。这里准备了两个版本，对于终端用户来说，它们最大的区别是 url 路径中，老版本的 Keycloak 比新版的，多了一个开头的 /auth。后面的部分一模一样。</p>\n<p>如何部署，不再赘述。对于老版本的 Keycloak，我部署到了 Heroku，详见《<a href=\"https://zhuanlan.zhihu.com/p/554534245\">FreeArch: 一键拥有你自己的身份认证平台 Keycloak，完全免费！ - Jeff Tian的文章 - 知乎</a> 》。只是由于使用了最便宜的共享 dyno，在月度额度用完后，会访问不了，需要等到下一个月才能重新访问。<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 72.97297297297297%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAACMklEQVR42pWT24oTQRCG5/1fwzthL4RFVBRkFZcFDYsKrhDYTbJJzCSZ6fO5+5fqySTxgGDBRxU11dVdh2k22x6bDUPfGey3qrLbSux3g351NcGTizf4ejdDyoCxoWJdPOrRJhpjPaSwsDZAawcpLYzx0NpDKoueK6zbrto+JFB8OGjnKVk4+kJMaIKLUMIixQTnA6Q2iCnBh1htEm0sUsrwIUAqg1IKlLYIMdYzXGrkUmpsQ4Ex5XqAfETOpTLaJHTgcGb4BhzjRx/RKOPQbjsopcC5gOAcxmgIwSGlBGMcfc8ghETPGLqurz7GWI3p+w6cbM6rv6HShNS1LGMd2l2PxarFfLkBFwo5Z8SYkNJAPGjrE5RN0DZWjE81rgkhIEQPbQy897iefMPF83d4enmF6f3yrNwTQAEzGcs+Yc1ypdNDyxqa7Pur79i1ApIb8E5BMgMhdO0rCU1vXIvT2gS4c3yslzVKWdxcT9Fue+w76hHHbs/AuKzl0mviXxKeo0m7MCTEP4RmSUmJ9Bv1snKiVF3QGOMguIaUGrs9x8u3n/DsxQdcvr4BF8MelnE3ziSkghXL+MEHqIe5JowSj3qK1jxiJR9w+3CLj9MJPs+/YOsXcEXTU38ZCpFygQl5wGf4mIeSdRKY6Tus9QwrfY+Nm6F1c3RpiX1ewGRRE+aS/0gKjJwubKjhtNTWOTAhIZU+9m8s9bzk0Srl5BdeoDPd8OvVhqdD49PJ/h/GQdELfwLPfYujVBe8LAAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/0825ae8ddb6f03e429a0e4af041c5a31/fcda8/1678851645607-363361f1-7688-4fc3-96d4-3e0e5b19b66d.png\"\n        srcset=\"/static/0825ae8ddb6f03e429a0e4af041c5a31/12f09/1678851645607-363361f1-7688-4fc3-96d4-3e0e5b19b66d.png 148w,\n/static/0825ae8ddb6f03e429a0e4af041c5a31/e4a3f/1678851645607-363361f1-7688-4fc3-96d4-3e0e5b19b66d.png 295w,\n/static/0825ae8ddb6f03e429a0e4af041c5a31/fcda8/1678851645607-363361f1-7688-4fc3-96d4-3e0e5b19b66d.png 590w,\n/static/0825ae8ddb6f03e429a0e4af041c5a31/efc66/1678851645607-363361f1-7688-4fc3-96d4-3e0e5b19b66d.png 885w,\n/static/0825ae8ddb6f03e429a0e4af041c5a31/c83ae/1678851645607-363361f1-7688-4fc3-96d4-3e0e5b19b66d.png 1180w,\n/static/0825ae8ddb6f03e429a0e4af041c5a31/01a87/1678851645607-363361f1-7688-4fc3-96d4-3e0e5b19b66d.png 1288w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>对于新版本的 Keycloak，我部署到了 Okteto，详见《<a href=\"https://zhuanlan.zhihu.com/p/611823061\">【免费架构】Heroku 不免费了，何去何从之 Keycloak 的容器化部署之路 - Jeff Tian的文章 - 知乎</a> 》。<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 39.86486486486486%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABu0lEQVR42k2Q6WrcQBCE9RBx7NXqHGlGM9LoWt1arY+N45jgkL+BQN7/Lb6wgkB+FFV0Q3VVO91ypT6dKZsFW8+o/LSj6Tb8OMeLDMdQ7/in/5+lumFdO/JqJEwrnGZ8xrYbsWpJdEdWTqTFgKlmxu0Lwpyougt1/4guJ5rhCdued87rlUg2ZEVLVoyocsa5XH+wPH6g7EKkOvJmQ9oV3Q1Mr29U60YxLphqI28u1MML9vRE1b+g6zOm3kiKGVUuKDvjnF++M2xveyphOky7ktoZO4+8/vxgeH4kMLeKluS2r2ZkPqDLmUi1mHIia89k5UKie5z1/cJ4vRCXGt8kyNYSlop66vn1+w/SWA7HiPtDSBRrIqHxghSpG4Sq8MIUkRaovMP1Jc7l2zvz9StZ2yFsRTHO6HHiGCmCQCGzCp23GFsRS0WcKtwg5XAU+6GDG+F6AteLufvs4UzbO/b0jNAjIusx9Zms2vCinEAW+InB9ZLdTBpDmmncQBIKQ5xogkghUkOYGO4eAhyhe9J8JDG3H/YI3e3aFwWxLIjTgigx+HFCIAR+HPPpIeTopwSR3OuHscIPJXf3Pn8BKIHwWY4EK+QAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/c43d01a82da23f7baa9da844b8883c5a/fcda8/1678851720050-df49a4df-e0e1-4a22-989b-7bde4735f414.png\"\n        srcset=\"/static/c43d01a82da23f7baa9da844b8883c5a/12f09/1678851720050-df49a4df-e0e1-4a22-989b-7bde4735f414.png 148w,\n/static/c43d01a82da23f7baa9da844b8883c5a/e4a3f/1678851720050-df49a4df-e0e1-4a22-989b-7bde4735f414.png 295w,\n/static/c43d01a82da23f7baa9da844b8883c5a/fcda8/1678851720050-df49a4df-e0e1-4a22-989b-7bde4735f414.png 590w,\n/static/c43d01a82da23f7baa9da844b8883c5a/efc66/1678851720050-df49a4df-e0e1-4a22-989b-7bde4735f414.png 885w,\n/static/c43d01a82da23f7baa9da844b8883c5a/c83ae/1678851720050-df49a4df-e0e1-4a22-989b-7bde4735f414.png 1180w,\n/static/c43d01a82da23f7baa9da844b8883c5a/5ab15/1678851720050-df49a4df-e0e1-4a22-989b-7bde4735f414.png 2446w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p><a name=mAwUE></a></p>\n<h1>如何扩展？</h1>\n<p><a name=I9iWR></a></p>\n<h2>官方文档</h2>\n<p><a href=\"https://www.keycloak.org/docs/latest/server_development/#_extensions_rest\">https://www.keycloak.org/docs/latest/server_development/#_extensions_rest</a>。<br />重点在哪里？就是需要实现两个接口，分别是： RealmResourceProviderFactory 和 RealmResourceProvider。其中 RealmResourceProvider 最重要的一个方法是：Object getResource(); 它用来返回一个 JAX-RS 资源对象。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 29.054054054054056%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABAElEQVR42l2PjW7DIAyE8/7POG3tmnYJ2PylAQIkV+FM01RLn+58GCMG5xyYGcYYaK3FdyUi5JzR6zgOYd93HMd++l99Z/DegzRBqb6EZVH3alZgNjBsJLfWwhgLpvNxa52cn7mRezFGDMszgIwGG4KxLJ747Ltf1oCUI9b0FI1pPf0WEfOKvGWklOQ3pRQMcxgx0gUPvuJOF9z5gsnepP9Wn6Kd6/Qhc6P+EnrGcULGgv81cFC4TVf86DseeoR2M+xCIDdj4ge0nQXyCiYQ2Ctw0DKzloBUV7TaUGtFaw1DThuc9XAuwLuAuCbU0oRW9z//TikN21ax5YKcN6GUihe7CcusRTkFKwAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/e8a1d3bdeb812d7ea7fa5b9c405090d7/fcda8/1678851916554-d4ac12de-c1f0-469f-94fd-59c0b10adbc4.png\"\n        srcset=\"/static/e8a1d3bdeb812d7ea7fa5b9c405090d7/12f09/1678851916554-d4ac12de-c1f0-469f-94fd-59c0b10adbc4.png 148w,\n/static/e8a1d3bdeb812d7ea7fa5b9c405090d7/e4a3f/1678851916554-d4ac12de-c1f0-469f-94fd-59c0b10adbc4.png 295w,\n/static/e8a1d3bdeb812d7ea7fa5b9c405090d7/fcda8/1678851916554-d4ac12de-c1f0-469f-94fd-59c0b10adbc4.png 590w,\n/static/e8a1d3bdeb812d7ea7fa5b9c405090d7/efc66/1678851916554-d4ac12de-c1f0-469f-94fd-59c0b10adbc4.png 885w,\n/static/e8a1d3bdeb812d7ea7fa5b9c405090d7/c83ae/1678851916554-d4ac12de-c1f0-469f-94fd-59c0b10adbc4.png 1180w,\n/static/e8a1d3bdeb812d7ea7fa5b9c405090d7/20f38/1678851916554-d4ac12de-c1f0-469f-94fd-59c0b10adbc4.png 2818w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p><a name=TdpEh></a></p>\n<h2>举个例子</h2>\n<p>看完这一段，似乎懂了，但仍不知道如何下手，还是看个具体的实例吧：<a href=\"https://github.com/Jeff-Tian/keycloak-heroku/blob/master/src/main/java/net/brickverse/test/MyResourceProvider.java\">https://github.com/Jeff-Tian/keycloak-heroku/blob/master/src/main/java/net/brickverse/test/MyResourceProvider.java</a><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.24324324324324%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABjUlEQVR42m2R227bMBBE9f9/1RZpX5sCgftQwBWa2BItXpbixTJJnUJyCgRJBxjsA7Ezw51ujplDb3g8Cj+Ojsej5eGg+fw08e2n5uvhwsNh4svTfX76/ofDUdGfDS9TYNABPwdSSvw693TaWHLO3NFgbRgJ9INlMDNaItYnXMj4tBBiwsmMdh4fEjEvaCtYCRjr6WRO1Npobd20KLUSQsRdBD06ToNBW0+WmSzCHCIxJlLO+05tjVsplFKotdLpEGgUGnWf20NersQ4YfUZ6xXKDWg/kmPcDesr13XlPbreKcw8Mt8cC4FwE+I1IleFNQo7O/J1wVf9YXkTfM/OOs84aNRoEAm4bPaEIQvaXvDJk+vMsibYAr3lf9AN/sxgnlFyRvkTcjUsy4JJFpdlF7oRKaT9B9d14/yBeb2bdoN11La8WjZKqaQlouTC737g+XTicomcVUDiVmDZS6xvbvmPsTm6kJbXe9wj19KIORLKhPcjo31BOYWSCb0VlSYkCT45JAoSt2mRbInV8RdVZ7WV5KxN/wAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/163a5495583625b17f4f9fafb7bcc8f1/fcda8/1678852124233-57758d89-bf2b-45e1-beb9-8ccca2de46f6.png\"\n        srcset=\"/static/163a5495583625b17f4f9fafb7bcc8f1/12f09/1678852124233-57758d89-bf2b-45e1-beb9-8ccca2de46f6.png 148w,\n/static/163a5495583625b17f4f9fafb7bcc8f1/e4a3f/1678852124233-57758d89-bf2b-45e1-beb9-8ccca2de46f6.png 295w,\n/static/163a5495583625b17f4f9fafb7bcc8f1/fcda8/1678852124233-57758d89-bf2b-45e1-beb9-8ccca2de46f6.png 590w,\n/static/163a5495583625b17f4f9fafb7bcc8f1/efc66/1678852124233-57758d89-bf2b-45e1-beb9-8ccca2de46f6.png 885w,\n/static/163a5495583625b17f4f9fafb7bcc8f1/c83ae/1678852124233-57758d89-bf2b-45e1-beb9-8ccca2de46f6.png 1180w,\n/static/163a5495583625b17f4f9fafb7bcc8f1/900ee/1678852124233-57758d89-bf2b-45e1-beb9-8ccca2de46f6.png 2544w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span><br />比如，在 src/main 下添加一个包，并添加官方文档中提到的两个接口的具体实现。我们今天要做的是，增加一个 hello 接口，具体实现就在上图中。<br />另外，我们希望将 hello 接口放在 my-rest-resource 下，这个 my-rest-resource，实际上就是 MyResourceProviderFactory.java 中定义的一个名称：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.70270270270271%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABuUlEQVR42l1Ti27bMAz0///XPmJDm2Qp0CWWJUvU+3mFmMVdJoAgZclH8o5aQohYxQapFLQx2LXmeBUCUu0cb1Kxn2ePO4Z9iAkxJVjn4EOAIcIilYbzAXMNAH0MxBAghIAmC+sCyDpYH5BKQW0dvQ+2GbfekXKBIQdtLBayHrVWBuq9Y0zAlLFrghSSQZUmaHIw1vFZLg0xF7YJNve7Ib67bBQxen9UOAb7mbXmgio2CLFhXQVbSomttYbXNY5oEZRRckZr36ATsISA+PuK0/mC99MZp9MZ58sFb2/vuF4/oJRizmZ385+nLcYn5kupHaWUR5oGtDyQnIfzHiEEhBjZz70mAlkL5zxXfNTJgGRxuwu2zz93CHuDritW94FIGpEsq60NscrBOuRdwxo6kllrD+DlJgneO26z1Q7XFD7zL/wMP0B+RaaIHiNTQD7B+IKcK3zIMDYgl0fL/a8Oi7YBY/RXjivQCpB9hLpv2KWElBJ6qr37Y25n20TE1T0FXcRuMXr7R+WBUgsPbKsNkRyi8wdn7uA1clXPUTsAY/kGe36cyqWckXyEMR45d8T5KmJ8EeH/NUX5AmTbVT77fOVhAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/132b432105a7b1ea6d9ba537221f91d4/fcda8/1678852325761-97ad9d7e-cb67-4597-83ae-f53c47fcbd0b.png\"\n        srcset=\"/static/132b432105a7b1ea6d9ba537221f91d4/12f09/1678852325761-97ad9d7e-cb67-4597-83ae-f53c47fcbd0b.png 148w,\n/static/132b432105a7b1ea6d9ba537221f91d4/e4a3f/1678852325761-97ad9d7e-cb67-4597-83ae-f53c47fcbd0b.png 295w,\n/static/132b432105a7b1ea6d9ba537221f91d4/fcda8/1678852325761-97ad9d7e-cb67-4597-83ae-f53c47fcbd0b.png 590w,\n/static/132b432105a7b1ea6d9ba537221f91d4/efc66/1678852325761-97ad9d7e-cb67-4597-83ae-f53c47fcbd0b.png 885w,\n/static/132b432105a7b1ea6d9ba537221f91d4/c83ae/1678852325761-97ad9d7e-cb67-4597-83ae-f53c47fcbd0b.png 1180w,\n/static/132b432105a7b1ea6d9ba537221f91d4/fb458/1678852325761-97ad9d7e-cb67-4597-83ae-f53c47fcbd0b.png 2362w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n<a name=NuQFr></a></p>\n<h1>如何注册？</h1>\n<p>代码写好了，如何将自己写的代码注册到 Keycloak，让它在运行时加载我们的扩展呢？</p>\n<blockquote>\n<p>注意⚠️，这是非常重要的一步！很多人都疑惑，为什么我的代码写好了，正常打包了，并且把相应的 jar 包也拷贝到 Keycloak 的目录里了，Keycloak 也运行起来了，但是自己的接口却是 404 呢？就是因为少了这一步！<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/71b9248f173493d0421dcac22a073bb2/307e7/1678852559309-6c2a924f-beb8-48fd-925d-184cd3e46ba4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50.67567567567568%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABP0lEQVR42n2S2Y6CQBBF+f8P89kgm1FBQdkksoMicie3kiaoM/NwU0V196mF0uq6BlVV1ayyLN++lYqiwPV6RZZl4n+ek6PxgOqaGn3foe973O/32VJd14kYW/pt284gJS2OY9iWiTJy0bUtirKUKniY57no8XjMYEKaphG77G4GHo9HrFYrGMYGtm3D932cTieBns9n0e12Q5qmCMMQURQhSRKBcjS0b0AGdV2HaZoCtCxLoExEHQ4HbLdbuK4Lz/PgOA4Mw5DH0zQJ9K1lzo9ZWQmzDcOA1+uF5/OJcRzFKp9xWt7hGOh/zZCw9XqN3W4nrQZBgP1+LwlY3eVyAee8rJgdqG34miHnw1YJ5GMF4iO2SAgT0Gec54zxp7DKrwrZploHXqKW/jLGu/zragc/qxPgbwv8n9jmX4tP4A9WvPRqn+xb9QAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/71b9248f173493d0421dcac22a073bb2/fcda8/1678852559309-6c2a924f-beb8-48fd-925d-184cd3e46ba4.png\"\n        srcset=\"/static/71b9248f173493d0421dcac22a073bb2/12f09/1678852559309-6c2a924f-beb8-48fd-925d-184cd3e46ba4.png 148w,\n/static/71b9248f173493d0421dcac22a073bb2/e4a3f/1678852559309-6c2a924f-beb8-48fd-925d-184cd3e46ba4.png 295w,\n/static/71b9248f173493d0421dcac22a073bb2/fcda8/1678852559309-6c2a924f-beb8-48fd-925d-184cd3e46ba4.png 590w,\n/static/71b9248f173493d0421dcac22a073bb2/efc66/1678852559309-6c2a924f-beb8-48fd-925d-184cd3e46ba4.png 885w,\n/static/71b9248f173493d0421dcac22a073bb2/c83ae/1678852559309-6c2a924f-beb8-48fd-925d-184cd3e46ba4.png 1180w,\n/static/71b9248f173493d0421dcac22a073bb2/307e7/1678852559309-6c2a924f-beb8-48fd-925d-184cd3e46ba4.png 1354w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n</blockquote>\n<p>实际上，要注册是非常简单的，只需要在 /<a href=\"https://github.com/Jeff-Tian/keycloak-heroku/tree/master/src\">src</a>/<a href=\"https://github.com/Jeff-Tian/keycloak-heroku/tree/master/src/main\">main</a>/<a href=\"https://github.com/Jeff-Tian/keycloak-heroku/tree/master/src/main/resources\">resources</a>/<a href=\"https://github.com/Jeff-Tian/keycloak-heroku/tree/master/src/main/resources/META-INF\">META-INF</a>/<a href=\"https://github.com/Jeff-Tian/keycloak-heroku/tree/master/src/main/resources/META-INF/services\">services</a> 目录下添加一个文档即可，比如：<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.02702702702703%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB0klEQVR42k2SiXLbIBCG9f7v0+do3bSJ4/jIND5kCYlLCIQQX0e4k4aZb5Zj92d3oRpGT6M850bz+qflcOk53hSXWtCIjl4ZeqW/2AdSGxrRF651U+ikohLScDgLDreBX+fA88WzvXqkDVjn8dPMuBLiYx7igyky+IAdA9LYcuF6XrkxINoWYwda0dH1Em0s91ag9IDRDmscSg0Faz3WjGjtMGZkGAJaOYz1JctKr+mLroj5MJFSIs4zIUzoYHmq39lcT7zcT+zFiV37zrZZ18eHrY8c+yMmClJaqNZAaQbs4EjLQs6Qc2ZJmSFqtuffbD9e2N92HOpdsbvLltfz9t/eG6dmjwwN66hWVe0CYi2361FKE2MshzFEVNfhXWCeEsHPhTglpjCT5sznyLAsC5VzjjTHIiaVopcSKWUpeZojUg5c74K66+m1oVt9tKHtFb0ZMG4sj+f8VKistUgX0UqV7FZR50aWJcECtT+xlxsO9Q8OzYZ9/0TbCbr1SzVN8fc+lDatLavSkjGDL1lJ+RDVxhBDwiwNm/iNlD357SdL/c5nkUbB83cI/lFxzoVqmmL5KufLjcu1pr43fJxvCCG5pwNznj4Dilr+H/xg4Usn+QvbZPwO30oF9gAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/b3b77784bdd8660a2245a2952718112f/fcda8/1678853114752-a8246fac-93be-4ce0-bd19-8e83cfd6fa11.png\"\n        srcset=\"/static/b3b77784bdd8660a2245a2952718112f/12f09/1678853114752-a8246fac-93be-4ce0-bd19-8e83cfd6fa11.png 148w,\n/static/b3b77784bdd8660a2245a2952718112f/e4a3f/1678853114752-a8246fac-93be-4ce0-bd19-8e83cfd6fa11.png 295w,\n/static/b3b77784bdd8660a2245a2952718112f/fcda8/1678853114752-a8246fac-93be-4ce0-bd19-8e83cfd6fa11.png 590w,\n/static/b3b77784bdd8660a2245a2952718112f/efc66/1678853114752-a8246fac-93be-4ce0-bd19-8e83cfd6fa11.png 885w,\n/static/b3b77784bdd8660a2245a2952718112f/c83ae/1678853114752-a8246fac-93be-4ce0-bd19-8e83cfd6fa11.png 1180w,\n/static/b3b77784bdd8660a2245a2952718112f/6c68b/1678853114752-a8246fac-93be-4ce0-bd19-8e83cfd6fa11.png 1888w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span><br />虽然简单，但是却绝不能缺少。</p>\n<p><a name=n5uwb></a></p>\n<h1>如何打包和部署？</h1>\n<p>代码写好了，注册完毕了，就可以打包了。这一步可以通过 mvn clean install完成，然后就可以在 target目录里找到对应的 jar。我们已经部署过 Keycloak，现在需要修改一下部署脚本，将这个 jar 包拷贝到 Keycloak 的 deployments 目录下。以我的项目为例，对于老版本的 Keycloak，需要将 jar 包拷贝到 /opt/jboss/keycloak/deployments/ 目录；而对于新版本的 Keycloak，需要将 jar 包拷贝到 /opt/keycloak/deployments/ 目录（不再需要那个 jobss）。详见这个提交： <a href=\"https://github.com/Jeff-Tian/keycloak-heroku/commit/50f18ba53ccea7eeda8ea34bd66a3b8f660b80cf\">https://github.com/Jeff-Tian/keycloak-heroku/commit/50f18ba53ccea7eeda8ea34bd66a3b8f660b80cf</a>。</p>\n<p><a name=Ykz5M></a></p>\n<h2>本地验证</h2>\n<p>我的这个项目，分别写了两套 Dockerfile 以及 docker compose 文件。其中，Dockerfile 是针对老版本的，其对应的 docker compose 文件是 docker-compose.heroku.yml，在本地可以通过 docker compose -f docker-compose.heroku.yml up --build来运行。而 Dockerfile.test 是针对新版本的，其对应的 docker compose 文件是 docker-compose.yml，在本地可以通过 docker compose up --build来运行。启动后，可以从 8080 端口打开 Web 界面：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/10a100c5b375885cedb46a878b2f2689/58a91/1678853685517-b8bfede9-b104-4dde-a9df-b86e920cb13a.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 85.13513513513513%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAABYlAAAWJQFJUiTwAAACL0lEQVR42o2Ty24TMRSGs+ntAYhEd2XBAyDxCK3UKgH6bEisAAloggSoaVesEO/AqolQUuXWZC4ezz3NjP0hG7VqaNIw0i/7+Pj8/u05f+X8/JxWq0XjpMHbd+/58PETJ40mjeZnGs2mnRt8+fqN07MzTlsPo1KtVnm8u8vTZ8/Z23tCtfqInZ0dNjc32draYnt728LEGxsba1E5Pj6mXn9B7eUrarUa9Xqdo6MjDg8P7XhwcMD+/r6d/w8qAEEQMBoOcZwp8/ncLKG1tqOUEsdxbuN1nyWMogghhC3OZ7lNKKUMLXEcE0qJUiVaqzvQS2EJ4yhmll+berTSaIWFiZMkw3Brq5rbnDlwGSqZlrjxiLG4ZCQuSVVAqiVJKcgIccRvPNEmvx6RFi6JCshV/Jd8mcJEC9IkxRcevu/hei5ZlqJ1aa/u/frO5Mdrpj/fkE07di0u3ZXXrkTKQc5cvGRMNPeIC2HVGaU5IQO3y0T2bZwpSU5ErPyH39APfEbjETKUKK0oVUmpCjSKQAaIQDC7zkmzlCgOKYq5LV76hoYwz3OSJLFQSi+0zdXVFe12m163R6/XIwjkQmvdU7isv26SVr3vMxgMGI/H9uC7e1b24b+n3C0wREZZv98nyzJ7izRNF/bdU7gK5hsOh3Q6HS4uLphMJrbRjRFWEq6y0E3BdDql2+1aGLVrrbdOobGjUWb8bOxp/uRDNQte9jyPMAxvW+ImVxTFgvJVtjNt8we91Lz0TCvJiwAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/10a100c5b375885cedb46a878b2f2689/fcda8/1678853685517-b8bfede9-b104-4dde-a9df-b86e920cb13a.png\"\n        srcset=\"/static/10a100c5b375885cedb46a878b2f2689/12f09/1678853685517-b8bfede9-b104-4dde-a9df-b86e920cb13a.png 148w,\n/static/10a100c5b375885cedb46a878b2f2689/e4a3f/1678853685517-b8bfede9-b104-4dde-a9df-b86e920cb13a.png 295w,\n/static/10a100c5b375885cedb46a878b2f2689/fcda8/1678853685517-b8bfede9-b104-4dde-a9df-b86e920cb13a.png 590w,\n/static/10a100c5b375885cedb46a878b2f2689/efc66/1678853685517-b8bfede9-b104-4dde-a9df-b86e920cb13a.png 885w,\n/static/10a100c5b375885cedb46a878b2f2689/c83ae/1678853685517-b8bfede9-b104-4dde-a9df-b86e920cb13a.png 1180w,\n/static/10a100c5b375885cedb46a878b2f2689/58a91/1678853685517-b8bfede9-b104-4dde-a9df-b86e920cb13a.png 1990w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>如上图所示，从 provider 列表的 realm-restapi-extension 中能看到 my-rest-resource，就说明我们自定义代码已经被 Keycloak 成功加载了。\n<a name=Yo6sZ></a></p>\n<h2>在线验证</h2>\n<p>分别访问前面提到的 url，得到了期待的结果，大功告成！<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/25e6ea1ae33023ca85fba5ae95450871/161ec/1678853799464-df764ec3-8a5d-4090-958d-b4cba3308785.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 24.324324324324326%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAnUlEQVR42p2O3Q6DIAxGff/X3OYQQbIp5aeVbwGM8WJXNjnJafq16ZBSwue74vVWeDxHKK0bo1LQs4GxFrOxsItrVF83DwoRngJ8OKCAzROGECMms0Bpi2l2+KyXMIW23MPdK9XPuad2KGdGrSHljJwzRAQsGczV9xMWOVya914umd7vezkOpgTnHCgQtmiRmHC3SikYmPnv4A71wx83PYbioTIfygAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/25e6ea1ae33023ca85fba5ae95450871/fcda8/1678853799464-df764ec3-8a5d-4090-958d-b4cba3308785.png\"\n        srcset=\"/static/25e6ea1ae33023ca85fba5ae95450871/12f09/1678853799464-df764ec3-8a5d-4090-958d-b4cba3308785.png 148w,\n/static/25e6ea1ae33023ca85fba5ae95450871/e4a3f/1678853799464-df764ec3-8a5d-4090-958d-b4cba3308785.png 295w,\n/static/25e6ea1ae33023ca85fba5ae95450871/fcda8/1678853799464-df764ec3-8a5d-4090-958d-b4cba3308785.png 590w,\n/static/25e6ea1ae33023ca85fba5ae95450871/efc66/1678853799464-df764ec3-8a5d-4090-958d-b4cba3308785.png 885w,\n/static/25e6ea1ae33023ca85fba5ae95450871/c83ae/1678853799464-df764ec3-8a5d-4090-958d-b4cba3308785.png 1180w,\n/static/25e6ea1ae33023ca85fba5ae95450871/161ec/1678853799464-df764ec3-8a5d-4090-958d-b4cba3308785.png 1840w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b3faaa3738e4e6a2d29697f8129c38c5/5c744/1678853864343-7dc64de2-5b30-42ed-bab8-748a92203511.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 21.62162162162162%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAg0lEQVR42pXO3QrCMAwF4L7/Y7p1S5qupbZsk/4cWafohaAGPnJzOIkqpaC1hpwz9v0GFotBT7gMI4ZRY9QTZmbM9MIiYCMgY0BsMBHjGhPSukJ57+GcQwihs9ZiWRaklFBrRa3t3O2xPzgeelJHiYggxtgRUS/ctq0H/h31LfB+/Rd3AFw3mtd60ZUAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/b3faaa3738e4e6a2d29697f8129c38c5/fcda8/1678853864343-7dc64de2-5b30-42ed-bab8-748a92203511.png\"\n        srcset=\"/static/b3faaa3738e4e6a2d29697f8129c38c5/12f09/1678853864343-7dc64de2-5b30-42ed-bab8-748a92203511.png 148w,\n/static/b3faaa3738e4e6a2d29697f8129c38c5/e4a3f/1678853864343-7dc64de2-5b30-42ed-bab8-748a92203511.png 295w,\n/static/b3faaa3738e4e6a2d29697f8129c38c5/fcda8/1678853864343-7dc64de2-5b30-42ed-bab8-748a92203511.png 590w,\n/static/b3faaa3738e4e6a2d29697f8129c38c5/efc66/1678853864343-7dc64de2-5b30-42ed-bab8-748a92203511.png 885w,\n/static/b3faaa3738e4e6a2d29697f8129c38c5/c83ae/1678853864343-7dc64de2-5b30-42ed-bab8-748a92203511.png 1180w,\n/static/b3faaa3738e4e6a2d29697f8129c38c5/5c744/1678853864343-7dc64de2-5b30-42ed-bab8-748a92203511.png 1206w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}},"menus":{}}},"staticQueryHashes":[],"slicesMap":{}}