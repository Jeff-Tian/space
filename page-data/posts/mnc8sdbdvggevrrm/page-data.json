{"componentChunkName":"component---src-templates-post-js","path":"/posts/mnc8sdbdvggevrrm/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/mnc8sdbdvggevrrm","relativePath":"posts/mnc8sdbdvggevrrm","frontmatter":{"title":"OIDC （OAuth 2.0）授权码许可流程详解：纸上得来终觉浅，绝知此事得写个测试","stackbit_url_path":"posts/mnc8sdbdvggevrrm","date":"2023-04-12T12:07:34","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p>OAuth 2.0 的授权码许可流程，我自认为已经对它了如指掌了。不就是几个跳转流程嘛：要登录一个应用，先跳转到授权服务，展示一个登录界面。用户输入凭据后，拿到授权码返回到应用前端。应用服务从其前端的 url 上的查询字符串里获取到授权码，结合预先申请的客户端凭据向授权服务器换取用户的令牌。总之，其序列图如下：\n<img src=\"https://cdn.nlark.com/yuque/__mermaid_v3/7dcf170b5a375760377eb939c015aae6.svg#lake_card_v2=eyJ0eXBlIjoibWVybWFpZCIsImNvZGUiOiJzZXF1ZW5jZURpYWdyYW1cbiAgICBwYXJ0aWNpcGFudCBVQSBhcyDnlKjmiLdcbiAgICBwYXJ0aWNpcGFudCBDIGFzIOesrOS4ieaWueW6lOeUqFxuICAgIHBhcnRpY2lwYW50IEFTIGFzIOaOiOadg-acjeWKoe-8iElkZW50aXR5U2VydmVy77yJXG4gICAgcGFydGljaXBhbnQgUlMgYXMg6LWE5rqQ5pyN5YqhXG5cbiAgICBVQS0-PkM6IOiuv-mXruiiq-S_neaKpOmhtemdolxuICAgIEMtPj5BUzogIOivt-axguaOiOadg1xuICAgIEFTLT4-VUE6IOWxleekuueZu-W9lemhtemdolxuICAgIFVBLT4-QVM6IOi-k-WFpeeUqOaIt-WHreaNruW5tuaOiOadg1xuICAgIEFTLT4-Qzog6Lez6L2s5Zue5bqU55So6aG16Z2i77yM5bm25bim5LiK5o6I5p2D56CBXG4gICAgQy0-PkFTOiDnlKjmjojmnYPnoIHmjaLlj5bku6TniYxcbiAgICBBUy0-PkM6IOi_lOWbnuS7pOeJjFxuICAgIEMtPj5DOiDlrZjlgqjku6TniYxcbiAgICBDLT4-QVM6IOW4puS4iuS7pOeJjOivt-axgueUqOaIt-S_oeaBr1xuICAgIEFTLT4-Qzog6L-U5Zue55So5oi35L-h5oGvXG4gICAgQy0-PkM6IOWtmOWCqOeUqOaIt-S_oeaBr1xuICAgIEMtPj5SUzog5bim5LiK5Luk54mM5Lul55So5oi36Lqr5Lu96K-35rGC6KKr5L-d5oqk6LWE5rqQXG4gICAgUlMtPj5DOiDov5Tlm57ooqvkv53miqTotYTmupBcbiAgICBDLT4-VUE6IOWxleekuuWPl-S_neaKpOS_oeaBr1xuXG4iLCJ1cmwiOiJodHRwczovL2Nkbi5ubGFyay5jb20veXVxdWUvX19tZXJtYWlkX3YzLzdkY2YxNzBiNWEzNzU3NjAzNzdlYjkzOWMwMTVhYWU2LnN2ZyIsImlkIjoiaXludWQiLCJtYXJnaW4iOnsidG9wIjp0cnVlLCJib3R0b20iOnRydWV9LCJjYXJkIjoiZGlhZ3JhbSJ9\" alt=\"\">\n在实际情况下，上图的第三方应用包含了前端应用和后端应用。前端应用和用户打交道，而像换取令牌等步骤应该在后端完成以保证不泄露应用秘钥。不过，对于授权码流程来说，这个第三方应用就是授权服务器的客户端，在整个流程里，我们先将它做为一个整体来看待。</p>\n<p>画出这样的序列图，仍然是在纸上谈兵。能画出序列图，和能写出代码，是两回事。今天，我来写段代码，以让自己真的相信自己是完全搞懂了这个流程。其实之前已经写了大量的文章和示例应用来对接标准的 OAuth 2.0 授权服务器，虽然其示例都已经在线上运行，但或多或少利用了标准的 OAuth 2.0 客户端，自己只是做了一些配置而已。今天，想裸写一个客户端来和 OAuth 2.0 授权服务器打交道。</p>\n<p>另外，它不再是一个线上运行着的示例，而是一个可以重复运行的自动化测试用例。这样，也可以做为一个安全栅栏，方便自己后续迭代 OAuth 2.0 授权服务器时，不会带来功能性的破坏。</p>\n<p><a name=Ce1oU></a></p>\n<h1>授权服务器的选择</h1>\n<p>这一次，仍然针对的是 Duende IdentityServer。对于 Keycloak 的授权码流程详解，之前写过一篇文章《<a href=\"https://zhuanlan.zhihu.com/p/597052710\">Keycloak 使用授权码换取令牌过程详解 - Jeff Tian的文章 - 知乎 </a> 》介绍。</p>\n<p>针对 Duende IdentityServer 的挑战性在于，我对 ASP.NET 以及 C# 比较生疏，要写一个自动化的客户端测试，更加不知如何下手。好在有 ChatGPT 帮忙，虽然最终仍然费了九牛二虎之力，但是终于完成了！要是没有 ChatGPT，我可能需要一整年的时间才能完成（调研、学习、上手练）。不过，仅仅是可以跑起来了，代码质量并不算高（一个很长的方法）。但是，这是一个非常大的里程碑了，后面将代码重构得更好，只是锦上添花的事情了。\n<a name=Mu5mc></a></p>\n<h1>最终代码提交</h1>\n<p><a href=\"https://github.com/Jeff-Tian/IdentityServer/commit/31e35dd0526ad887aa7f3eec899990ae737fed9d\">https://github.com/Jeff-Tian/IdentityServer/commit/31e35dd0526ad887aa7f3eec899990ae737fed9d</a></p>\n<p><a name=znyKU></a></p>\n<h1>添加测试工程</h1>\n<p>要添加的自动化测试，会调用 Host.Main 下运行的 Web 服务，所以需要引用 Host.Main.csproj 工程。由于是测试工程，需要引用 Microsoft.NET.Test.Sdk。总之，最后的测试工程描述文件如下：</p>\n<p>xml\n<Project Sdk=Microsoft.NET.Sdk></p>\n<pre><code>&#x3C;PropertyGroup>\n    &#x3C;TargetFramework>net6.0&#x3C;/TargetFramework>\n    &#x3C;ImplicitUsings>enable&#x3C;/ImplicitUsings>\n    &#x3C;Nullable>enable&#x3C;/Nullable>\n\n    &#x3C;IsPackable>false&#x3C;/IsPackable>\n&#x3C;/PropertyGroup>\n\n&#x3C;ItemGroup>\n    &#x3C;PackageReference Include=Microsoft.NET.Test.Sdk Version=17.1.0 />\n    &#x3C;PackageReference Include=NUnit Version=3.13.3 />\n    &#x3C;PackageReference Include=NUnit3TestAdapter Version=4.2.1 />\n    &#x3C;PackageReference Include=NUnit.Analyzers Version=3.3.0 />\n    &#x3C;PackageReference Include=coverlet.collector Version=3.1.2 />\n    &#x3C;PackageReference Include=xunit.assert Version=2.4.2 />\n    &#x3C;PackageReference Include=xunit.extensibility.core Version=2.4.2 />\n    &#x3C;PackageReference Include=xunit.extensibility.execution Version=2.4.2 />\n    &#x3C;PackageReference Include=xunit.runner.visualstudio Version=2.4.5>\n      &#x3C;PrivateAssets>all&#x3C;/PrivateAssets>\n      &#x3C;IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive&#x3C;/IncludeAssets>\n    &#x3C;/PackageReference>\n&#x3C;/ItemGroup>\n\n&#x3C;ItemGroup>\n  &#x3C;ProjectReference Include=....hostsAspNetIdentityHost.AspNetIdentity.csproj />\n  &#x3C;ProjectReference Include=....hostsmainHost.Main.csproj />\n&#x3C;/ItemGroup>\n</code></pre>\n</Project>\n<p><a name=fOaMZ></a></p>\n<h1>添加测试类</h1>\n<p>这个测试会启动 Host.Main 主工程的 Web 服务，因此测试类需要实现 IClassFixture<WebApplicationFactory> 接口，一般单元测试是不用这样的。</p>\n<p>csharp\npublic class IdTokenTest : IClassFixture&#x3C;WebApplicationFactory<Program>> {\nprivate readonly ITestOutputHelper _testOutputHelper;\nprivate readonly HttpClient _client;</p>\n<pre><code>public IdTokenTest(WebApplicationFactory&#x3C;Program> factory, ITestOutputHelper testOutputHelper)    {\n    _testOutputHelper = testOutputHelper;\n    _client = _factory.CreateClient(new WebApplicationFactoryClientOptions\n    {\n        AllowAutoRedirect = false,\n    });\n}\n</code></pre>\n<p>}</p>\n<p>其中 Program 类，是主工程启动 Web 服务的入口类。由于 dotnet 允许入口文件不写类，所以如果你的入口文件可能是没有类的。但是如果要能够允许测试工程启动，就必须定义一个类，哪怕是一个空的 partial 类：</p>\n<p>csharp\npublic partial class Program {}</p>\n<p>另外，注意在实例化 _client 时，一定将选项中的 AllowAutoRedirect 设置为 false。它默认为 true，会自动跟踪 302 页面跳转。在很多时候，这会让我们更省心，少写很多代码。但是我们的测试中会涉及很多跳转，特别是将授权码回传给第三方应用时，需要拦截 url，并从查询字符串中提取这个授权码，所以一定不能使用默认的跟踪 302 页面跳转功能！这一点，卡了我很久很久……<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4027b428e2b16e1d9b4ab7b253e116e1/d50e7/1681297996762-9d4c115e-98bf-4406-8992-5777880eb2bc.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.02702702702703%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAACLklEQVR42n2SS2sTURiGBwQX3naxXatFrRalUFBcSDf+AH+AO3+BWzdediKtuBBBkFpbi+j/6AVLtU2axtwmk2RmMiZzvyWdPDJfFHce+HhfvnM47/ue8ylLy6948vQ5m1vbJOkQx/Xw/ADP93FdjyCMiJOEOE6Ik5RIMBGM4pgwigmCkDRJBJULF2c4dfosL5eWycZjDMPEth36/YGg7wcMBraUrv/bC8OQ4XBImqakwxFRMiTLMpRbt+9waeYy71dWCMOY/YMS1WqDcrlCsVim0VCp1RoUSxPe61mYZg/TtNANE72r07UcKmoP33NRbtycp3B+mq+fv5Av13VFPQgCHMfB8zzCMMLzfEajEf9b4/EY5crsdQqFKZ69eU0G9Ps2nhfgur5gfpnvh/KuvlT4pxfIG9u2K2L5+byvzF6bY2pqmhfv3mLZLpvbu+zuHXBYrlKu1NgvHlGpNtja2aN0+JNSuSq98lFN9ne+/RD+ff+QelObRD5zrsDa6hrHx5k4zNVzNXEShERRLC7yXwyCSfzc6cTlJInr+ZJCWVy8y8MH91hbXydJRjRVjVpdpam2saw+7Y5Bp2vQ7ujSM0yLltYR/qs/EK61dVpal65uoiwszPP40X02Nj4RJyOOKjWJqLY6cihHw7DQtI5wtdUWrNZVceg4k7mduA9Rrs7OceLkWT6sfiTLxtQbLVHKo+duVK1Df2BLzL+zmX9G7lprd2k0NQa2Q5oOZfh/A0RXvibOkF6nAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/4027b428e2b16e1d9b4ab7b253e116e1/fcda8/1681297996762-9d4c115e-98bf-4406-8992-5777880eb2bc.png\"\n        srcset=\"/static/4027b428e2b16e1d9b4ab7b253e116e1/12f09/1681297996762-9d4c115e-98bf-4406-8992-5777880eb2bc.png 148w,\n/static/4027b428e2b16e1d9b4ab7b253e116e1/e4a3f/1681297996762-9d4c115e-98bf-4406-8992-5777880eb2bc.png 295w,\n/static/4027b428e2b16e1d9b4ab7b253e116e1/fcda8/1681297996762-9d4c115e-98bf-4406-8992-5777880eb2bc.png 590w,\n/static/4027b428e2b16e1d9b4ab7b253e116e1/efc66/1681297996762-9d4c115e-98bf-4406-8992-5777880eb2bc.png 885w,\n/static/4027b428e2b16e1d9b4ab7b253e116e1/c83ae/1681297996762-9d4c115e-98bf-4406-8992-5777880eb2bc.png 1180w,\n/static/4027b428e2b16e1d9b4ab7b253e116e1/d50e7/1681297996762-9d4c115e-98bf-4406-8992-5777880eb2bc.png 2280w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/35dbeb58bce0cd1ef12a94e32698faba/43853/1681298016507-8372cd49-8774-4937-abbe-d87a3657b4d4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.70270270270271%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAACEUlEQVR42qVS624SURDe/5qqwdb0p0kvT+Yj+Agm1R8mJkZSEy9JoT98D02UUrkUWGCXhcLe9+yVvQCln5mh8AKeZPLNzPkyM2fOJ5XPP6N2VUcUJ3A9AeEH8IQPx/UQhBHSLMc8zXZG8TaXZhmSeYoojpEkc8RhBOnR4z18Kp+DDiWLvMBisWQsigWyLGcjP88LzOcpW5ZlyKnwLs6xXK0gHR2f4s3ZW6zX9+j3h5hMpjAMC4oywnSqY6RNoGkTzGYGZjOdMQhCxA9TeZ6AZTnw/YCHkg5eHKJSrXLQ7cpciExVNUZZHmAwULgZ4Wg0hmXZcF0Pum7AMEyOqRn50tNnJVxUKvzM+nWDd2fbDoTwEYYRDNPiqXivjgv9oQDtexsT1zQ3TaTS8wNcXlR4wtVqhf890v7+IV6/f4divYZtObBsF65HvyxgWg6b7XgwTBu+H3Ke7j0RcLzl6IbFSpFOjo9wVv4IESX4+auGP/Ummu0e2p0+/jY7+F1rQB6ouOkOoI4maLS66PUVjls3MnOIe3XdhqKOIX358Ao/Lqu4u7vHUNXgumInEdorIUlii2masU+cLY+QuHQvnZ68xNdv35EXS7TaPQwVjW2k3aLdkblrHCf8vCjaSMUwbJ56qI4x0y2o2i26ssJPl/aelLggHdqTEAH/NCHpi3SWpinrjPRHRoX9INzsNQiZTz7l/wH0iRmh+WjyXQAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/35dbeb58bce0cd1ef12a94e32698faba/fcda8/1681298016507-8372cd49-8774-4937-abbe-d87a3657b4d4.png\"\n        srcset=\"/static/35dbeb58bce0cd1ef12a94e32698faba/12f09/1681298016507-8372cd49-8774-4937-abbe-d87a3657b4d4.png 148w,\n/static/35dbeb58bce0cd1ef12a94e32698faba/e4a3f/1681298016507-8372cd49-8774-4937-abbe-d87a3657b4d4.png 295w,\n/static/35dbeb58bce0cd1ef12a94e32698faba/fcda8/1681298016507-8372cd49-8774-4937-abbe-d87a3657b4d4.png 590w,\n/static/35dbeb58bce0cd1ef12a94e32698faba/efc66/1681298016507-8372cd49-8774-4937-abbe-d87a3657b4d4.png 885w,\n/static/35dbeb58bce0cd1ef12a94e32698faba/c83ae/1681298016507-8372cd49-8774-4937-abbe-d87a3657b4d4.png 1180w,\n/static/35dbeb58bce0cd1ef12a94e32698faba/43853/1681298016507-8372cd49-8774-4937-abbe-d87a3657b4d4.png 2284w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e085000a58b29f718859020773f965bf/f0293/1681298040856-91237e77-8799-4de6-8cef-52c930c03a92.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.37837837837838%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAACPElEQVR42jVT227TQBD1FwCVSIFKvFAuL/BVfAmvSAgJEKIChARJRYsQ/wAIQkObNE7i2I6d+JLSJL7f7SQcNJOy0tHMjs+enZkdC2/evsP3Hz/h+QHmCweO62LhuJjNF/CDAFGcIIgitkmaIYxjpGmCNMsQJynHozhGGIbwPB/CpctbePr8BeI4gSgOIMsqJoYJSVLYV1UN/f6QoSgjtNtdNNsKhrIGSZL5O/NG+kbw9p17+PLpM2ilaYaqqhh5nqMsS6zXa8ZyueQ4xcJsiTwvUZWb/X/QEnZ2buLRy2co1mt4ro8giLiUJEnh+yHDpXgYIQxjLtH3iRcyl0DtKssKRVFCuFq7hsevX8EJI3z91sTR7w66vSGarTaaR22cdPo46fTQ6Q7wq9Vh/7gtModireMu++OJhdncgVDbvo6D/Y9YViuoozEs+wyGOWVMDBuW/YcxNiwsFi5nQSgvbJ4XnF2a5VyVUNu+gfcf6iirJd9imDZkRWdhElRUncVNi3AGfWyyOH0jf6RNGHSWHlbY3b2Fer2BLC9x2h1AVnUMhiqGigZZ0bgcEhX7Mvu9gYK+pELVJhw/FSV0RYn5LLj35CEODw+wWv3lLOzppkSy9vSc26DpBmehjU32SYj287nDPMOa8pksyyE8uH8XjcY+Z8ipGxZnSQepDLLnswXsi0uoFSPd4AzpMp04Y5NbEEYxhCtbNS6ZFv0djuvxa9G40KgQaD7pQVzX4+GlkaHRcj2fR8oPNtyiKPAPWDQPGFr541wAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/e085000a58b29f718859020773f965bf/fcda8/1681298040856-91237e77-8799-4de6-8cef-52c930c03a92.png\"\n        srcset=\"/static/e085000a58b29f718859020773f965bf/12f09/1681298040856-91237e77-8799-4de6-8cef-52c930c03a92.png 148w,\n/static/e085000a58b29f718859020773f965bf/e4a3f/1681298040856-91237e77-8799-4de6-8cef-52c930c03a92.png 295w,\n/static/e085000a58b29f718859020773f965bf/fcda8/1681298040856-91237e77-8799-4de6-8cef-52c930c03a92.png 590w,\n/static/e085000a58b29f718859020773f965bf/efc66/1681298040856-91237e77-8799-4de6-8cef-52c930c03a92.png 885w,\n/static/e085000a58b29f718859020773f965bf/c83ae/1681298040856-91237e77-8799-4de6-8cef-52c930c03a92.png 1180w,\n/static/e085000a58b29f718859020773f965bf/f0293/1681298040856-91237e77-8799-4de6-8cef-52c930c03a92.png 2250w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/489fb6b3c0f49f5f16346c97f7a344b0/d50e7/1681298058329-29f72caf-6897-4f0a-b01a-916bf8d2115c.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAACC0lEQVR42oVSS2sTURQeEBVRXCiJblUUrYqmFAU3di34L1zqSlwo7pWufCyljSZidwX9FzZoTJpM5p15pdM2ycwkM5nOI8kn9wyCWfXC4dzz3XMP5/vO4d68XcPLV6+x9f0HXM9HVzdh2T0YpkXWHwzh+SMMhi6CMESSpoiTZMHCcIIkSeiNu3T5Ck6cPIX3Hz6CHc/zEQQBxuOAEsMwRBCEiKII02yKow537/4DXL12HV8qVQJms9mRn+bz+YLPgzzm7i6voFi8iOfv1uCGExi6BVUzoKg6mdY10dUt6KZNnmHO3gHhu84+LKsHWdZg2bsUczeWbuHc+QI+lcuYRDH4jgTDtCFIKho7HbR5CfVGGx1BIYwVarYE8qKs0b3R5LHTFrC33we3dPM2CsULqFSqiKIY27U6JbR4EbwgQxBV6qrFS/jT5MF3ZLR5kUxWutSt6/o46A8xHofgSssrOH22gPX1MqazOURJhSRr0A0LptWDbTuwew50wyYpWJHBwKVBBWy6cYI0zZCmKQ4PY3Crqw/x9MkjfK1WkWXzXBfboc+MFqMhK/oCzoqzwqKkUff/tGU4VyrdwYtnj7G5+Q2uH+BnrU7a1H43sf2rQRqyZNYt+6BoBtE0zDxmnoZm2PC8Ua7hseNnsLHxmabPlpvt32QSES12Z3TYXrId9f0R7WaW5TT/tziO8RfBT7ihgQQKMQAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/489fb6b3c0f49f5f16346c97f7a344b0/fcda8/1681298058329-29f72caf-6897-4f0a-b01a-916bf8d2115c.png\"\n        srcset=\"/static/489fb6b3c0f49f5f16346c97f7a344b0/12f09/1681298058329-29f72caf-6897-4f0a-b01a-916bf8d2115c.png 148w,\n/static/489fb6b3c0f49f5f16346c97f7a344b0/e4a3f/1681298058329-29f72caf-6897-4f0a-b01a-916bf8d2115c.png 295w,\n/static/489fb6b3c0f49f5f16346c97f7a344b0/fcda8/1681298058329-29f72caf-6897-4f0a-b01a-916bf8d2115c.png 590w,\n/static/489fb6b3c0f49f5f16346c97f7a344b0/efc66/1681298058329-29f72caf-6897-4f0a-b01a-916bf8d2115c.png 885w,\n/static/489fb6b3c0f49f5f16346c97f7a344b0/c83ae/1681298058329-29f72caf-6897-4f0a-b01a-916bf8d2115c.png 1180w,\n/static/489fb6b3c0f49f5f16346c97f7a344b0/d50e7/1681298058329-29f72caf-6897-4f0a-b01a-916bf8d2115c.png 2280w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><a name=mwh0x></a></p>\n<h1>配置发现</h1>\n<p>自动从配置接口获取后面需要用到的 API 端点。\ncsharp\nvar response = await _client.GetAsync(/.well-known/openid-configuration);\nresponse.EnsureSuccessStatusCode();\njson.TryGetValue(token_endpoint, out _tokenEndpoint);\nAssert.Equal(<a href=\"https://localhost/connect/token\">https://localhost/connect/token</a>, _tokenEndpoint.ToString());\nvar userInfoEndpoint = json[userinfo_endpoint];\nAssert.Equal(<a href=\"https://localhost/connect/userinfo\">https://localhost/connect/userinfo</a>, userInfoEndpoint.ToString());</p>\n<p><a name=qWEEd></a></p>\n<h1>登录授权</h1>\n<p>这一步特别难，因为需要用户输入用户名密码，也就是需要将页面解析出来，并使用原始 HTTP 请求来模拟表单提交。\ncsharp\nconst string redirectUrl = <a href=\"http://localhost:3000/api/auth/callback/id6\">http://localhost:3000/api/auth/callback/id6</a>;</p>\n<pre><code>    var requestUri =\n        ${_authorizeEndpoint}?client_id=inversify&#x26;response_type=code&#x26;scope=openid%20profile&#x26;redirect_uri={redirectUrl}&#x26;state=123&#x26;nonce=xyz;\n    \n    var authPage =\n        await _client.GetAsync(\n            requestUri);\n    authPage.Headers.Location.Should().Be(\n        https://localhost/Account/Login?ReturnUrl=%2Fconnect%2Fauthorize%2Fcallback%3Fclient_id%3Dinversify%26response_type%3Dcode%26scope%3Dopenid%2520profile%26redirect_uri%3Dhttp%253A%252F%252Flocalhost%253A3000%252Fapi%252Fauth%252Fcallback%252Fid6%26state%3D123%26nonce%3Dxyz);\n\n    var redirectedAuthPage = await _client.GetAsync(authPage.Headers.Location);\n    var authPageContent = await redirectedAuthPage.Content.ReadAsStringAsync();\n\n    var doc = new HtmlDocument();\n    doc.LoadHtml(authPageContent);\n\n    var loginUrl = doc.DocumentNode.Descendants(form)\n        .FirstOrDefault()?.GetAttributeValue(action, );\n    loginUrl = $http://localhost{loginUrl};\n\n    if (string.IsNullOrEmpty(loginUrl))\n    {\n        throw new InvalidOperationException(Cannot find login URL.);\n    }\n\n    var inputs = doc.DocumentNode.Descendants(input)\n        .Where(i => i.GetAttributeValue(type, ).Equals(text) ||\n                    i.GetAttributeValue(type, ).Equals(password))\n        .ToDictionary(i => i.GetAttributeValue(name, ), i => i.GetAttributeValue(value, ));\n    inputs[Input.Username] = alice;\n    inputs[Input.Password] = alice;\n    inputs[Input.Button] = login;\n\n    var requestVerificationTokenInput = doc.DocumentNode.Descendants(input)\n        .FirstOrDefault(i => i.GetAttributeValue(name, ).Equals(__RequestVerificationToken));\n\n    if (requestVerificationTokenInput != null)\n    {\n        inputs[__RequestVerificationToken] = requestVerificationTokenInput.GetAttributeValue(value, );\n    }\n\n    var returnUrlInput = doc.DocumentNode.Descendants(input)\n        .FirstOrDefault(i => i.GetAttributeValue(name, ).Equals(Input.ReturnUrl));\n\n    if (returnUrlInput is not null)\n    {\n        var returnUrl = WebUtility.HtmlDecode(returnUrlInput.GetAttributeValue(value, ))\n            .Replace( , %20);\n        // returnUrl = Uri.EscapeDataString(returnUrl);\n\n        // Assert.Equal(\n        // %2Fconnect%2Fauthorize%2Fcallback%3Fclient_id%3Dinversify%26response_type%3Dcode%26scope%3Dopenid%2520profile%26redirect_uri%3Dhttp%253A%252F%252Flocalhost%253A3000%252Fapi%252Fauth%252Fcallback%252Fid6%26state%3D123%26nonce%3Dxyz,\n        // returnUrl);\n        inputs[Input.ReturnUrl] = returnUrl;\n    }\n\n    var loginRequest = new HttpRequestMessage(HttpMethod.Post, loginUrl)\n    {\n        Content = new FormUrlEncodedContent(inputs),\n    };\n\n    var loginResponse = await _client.SendAsync(loginRequest);\n    Assert.Equal(HttpStatusCode.Redirect, loginResponse.StatusCode);\n    var cookie = loginResponse.Headers.GetValues(Set-Cookie);\n    var cookieString = string.Join(;, cookie);\n    _testOutputHelper.WriteLine(cookieString);\n</code></pre>\n<p>首先，由于禁用了自动跟踪 302 跳转，这里不得不手动从响应头的 Location 字段获取跳转后的 URL 并再次请求该 URL；由于请求该 URL 后是一个需要用户交互的登录页面，所以接着使用了 HtmlDocument 去加载这个页面；然后要查询表单中的输入框以设置测试用户名和密码。不仅如此，还得寻找隐藏字段，并记录下来，在后面的表单提交中发送，不然的话，会得到 400 Bad Request。</p>\n<p>在后面的表单提交之后，**还得再次手动从响应头中的获取 Set-Cookie 字段的值，并保存下来，并在后面请求令牌时带上，不然会再次被跳转到登录页！**要不是写了这个测试，我还真不知道这一点。</p>\n<p><a name=vqSR8></a></p>\n<h1>处理回调以及提取授权码</h1>\n<p>登录成功后，登录响应不仅设置了 Cookie，还将授权码带在了跳转目标的 URL 上。在保存了 Cookie 之后，还得从登录响应头中的 Location 字段里提取授权码，虽然简单，但是琐碎，好在 ChatGPT 在这一点上，写的代码完全不用修改：\ncsharp</p>\n<pre><code>    var callbackRequest = new HttpRequestMessage(HttpMethod.Get, loginResponse.Headers.Location);\n    callbackRequest.Headers.Add(Cookie, cookieString);\n    var callbackResponse = await _client.SendAsync(callbackRequest);\n    Assert.Equal(HttpStatusCode.Redirect, callbackResponse.StatusCode);\n    Assert.Contains(redirectUrl, callbackResponse.Headers.Location?.ToString());\n\n    var loginContent = callbackResponse.Headers.Location?.ToString();\n\n    var start = loginContent.IndexOf(code=, StringComparison.Ordinal) + 5;\n    var end = loginContent.IndexOf(&#x26;, start, StringComparison.Ordinal);\n    var code = loginContent.Substring(start, end - start);\n    _testOutputHelper.WriteLine(code);\n</code></pre>\n<p><a name=Ys4bV></a></p>\n<h1>请求令牌</h1>\n<p>经过了上面的复杂过程，这一步就相对简单得多：\ncsharp\nvar tokenResponse = await _client.RequestAuthorizationCodeTokenAsync(new AuthorizationCodeTokenRequest\n{\nAddress = _tokenEndpoint.ToString(),\nClientId = inversify,\nClientSecret = id6_secret,\nRedirectUri = redirectUrl,\nCode = code\n});\ntokenResponse.AccessToken.Should().NotBeNullOrWhiteSpace();\ntokenResponse.IdentityToken.Should().NotBeNullOrWhiteSpace();</p>\n<p><a name=me3pP></a></p>\n<h1>请求用户信息</h1>\n<p>前面的测试，覆盖了 OAuth 2.0 的授权码协议部分。我们顺便再验证一下用户信息端点，验证 OIDC 能力。\ncsharp</p>\n<pre><code>    var userInfoResponse = await _client.GetUserInfoAsync(new UserInfoRequest\n    {\n        Address = userInfoEndpoint.ToString(),\n        Token = tokenResponse.AccessToken\n    });\n\n    _testOutputHelper.WriteLine(userInfoResponse.Json.ToString());\n    userInfoResponse.Json.ToString().Should().Be(\n</code></pre>\n<p>{name:Alice Smith,given_name:Alice,family_name:Smith,website:<a href=\"http://alice.com,sub:1%7D\">http://alice.com,sub:1}</a>\n);</p>\n<p><a name=tUhd7></a></p>\n<h1>总结</h1>\n<p>通过这个测试，不仅更加理解了整个授权码流程（比如 Cookie 的重要性！），还学会了如何写 dotnet Web 服务的集成测试。整个授权码流程中，主要有以下几个关键 API 端点被使用到了（之前各种对接使用的客户端，内置了对它们的发现和调用）：\n<a name=JI0LU></a></p>\n<h2>发现端点</h2>\n<p>一般标准的 OpenID Connect 协议的实现者，都会在 .well-known/openid-configuration 端点公开配置信息。比如 <a href=\"https://id6.azurewebsites.net/.well-known/openid-configuration\">https://id6.azurewebsites.net/.well-known/openid-configuration</a> 的响应如下：\njson\n{\nissuer: <a href=\"https://id6.azurewebsites.net\">https://id6.azurewebsites.net</a>,\njwks_uri: <a href=\"https://id6.azurewebsites.net/.well-known/openid-configuration/jwks\">https://id6.azurewebsites.net/.well-known/openid-configuration/jwks</a>,\nauthorization_endpoint: <a href=\"https://id6.azurewebsites.net/connect/authorize\">https://id6.azurewebsites.net/connect/authorize</a>,\ntoken_endpoint: <a href=\"https://id6.azurewebsites.net/connect/token\">https://id6.azurewebsites.net/connect/token</a>,\nuserinfo_endpoint: <a href=\"https://id6.azurewebsites.net/connect/userinfo\">https://id6.azurewebsites.net/connect/userinfo</a>,\nend_session_endpoint: <a href=\"https://id6.azurewebsites.net/connect/endsession\">https://id6.azurewebsites.net/connect/endsession</a>,\ncheck_session_iframe: <a href=\"https://id6.azurewebsites.net/connect/checksession\">https://id6.azurewebsites.net/connect/checksession</a>,\nrevocation_endpoint: <a href=\"https://id6.azurewebsites.net/connect/revocation\">https://id6.azurewebsites.net/connect/revocation</a>,\nintrospection_endpoint: <a href=\"https://id6.azurewebsites.net/connect/introspect\">https://id6.azurewebsites.net/connect/introspect</a>,\ndevice_authorization_endpoint: <a href=\"https://id6.azurewebsites.net/connect/deviceauthorization\">https://id6.azurewebsites.net/connect/deviceauthorization</a>,\nbackchannel_authentication_endpoint: <a href=\"https://id6.azurewebsites.net/connect/ciba\">https://id6.azurewebsites.net/connect/ciba</a>,\nfrontchannel_logout_supported: true,\nfrontchannel_logout_session_supported: true,\nbackchannel_logout_supported: true,\nbackchannel_logout_session_supported: true,\nscopes_supported: [\nopenid,\nprofile,\nemail,\ncustom.profile,\nIdentityServerApi,\nresource1.scope1,\nresource1.scope2,\nresource2.scope1,\nresource2.scope2,\nresource3.scope1,\nresource3.scope2,\nscope3,\nscope4,\nshared.scope,\ntransaction,\noffline_access\n],\nclaims_supported: [\nsub,\nname,\nfamily_name,\ngiven_name,\nmiddle_name,\nnickname,\npreferred_username,\nprofile,\npicture,\nwebsite,\ngender,\nbirthdate,\nzoneinfo,\nlocale,\nupdated_at,\nemail,\nemail_verified,\nlocation,\naddress\n],\ngrant_types_supported: [\nauthorization_code,\nclient_credentials,\nrefresh_token,\nimplicit,\npassword,\nurn:ietf:params:oauth:grant-type:device_code,\nurn:openid:params:grant-type:ciba,\ncustom,\ncustom.nosubject\n],\nresponse_types_supported: [\ncode,\ntoken,\nid_token,\nid_token token,\ncode id_token,\ncode token,\ncode id_token token\n],\nresponse_modes_supported: [\nform_post,\nquery,\nfragment\n],\ntoken_endpoint_auth_methods_supported: [\nclient_secret_basic,\nclient_secret_post,\nprivate_key_jwt\n],\nid_token_signing_alg_values_supported: [\nRS256\n],\nsubject_types_supported: [\npublic\n],\ncode_challenge_methods_supported: [\nplain,\nS256\n],\nrequest_parameter_supported: true,\nrequest_object_signing_alg_values_supported: [\nRS256,\nRS384,\nRS512,\nPS256,\nPS384,\nPS512,\nES256,\nES384,\nES512,\nHS256,\nHS384,\nHS512\n],\nrequest_uri_parameter_supported: true,\nauthorization_response_iss_parameter_supported: true,\nbackchannel_token_delivery_modes_supported: [\npoll\n],\nbackchannel_user_code_parameter_supported: true\n}</p>\n<p><a name=Xm5aJ></a></p>\n<h2>授权端点</h2>\n<p>这个页面会重定向至让用户输入凭据的页面，当用户输入正确的凭据后，授权服务会再次重定向回第三方应用：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0590d5b92c328ec471c88fe0f06b7676/10c1e/1681299554240-6f64fada-9b93-46ea-bc37-9da587893f90.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50.67567567567568%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAABgElEQVR42nWO6WrbQBSF/f6v0WcIFEoTWkMpxmmcWK6W0UiWZctaR5pFM3NntASl0OCSfhwO5893uSuldC/VtaiKsmk7SilrO9q2XdcxpUApkEorBVp/kJXgQitgTIheGTsaO2gNYKxSRmsjFSgN4zjOH7HinGuAjnFpOTUFg8aOQEVhrBoGsAMMo7HjMswgh9HcyLLvWYi8+/vT5kf48w7vHtoqTsmhZMeS4aTaJfWvM3k51U81i8HKG7kXQpA29v3AcZIgygsvLZ/2x88b9OlYbpP6MS43JQ214fM8/fs2Y4xz7iOEo+jw271kl4RsK4Fzhoi8JPVjkK+D6/fgupbQzcuB6UYWQjiO47rufv+CMcbpM75u3ezbPv2yi+5QtvazBy/7WnSI67oHYgd9I3tv+L7vL4ViHOZ5lNbPhJ8VsIrhiuOsPZQM99C+y+INjKM/IIRQiM7RieTNIMw0TvP/WVFKhRC+72EcYhxVVUUIaepGMG4lzNMiT0v/zbv8CriML6iqzFnEAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/0590d5b92c328ec471c88fe0f06b7676/fcda8/1681299554240-6f64fada-9b93-46ea-bc37-9da587893f90.png\"\n        srcset=\"/static/0590d5b92c328ec471c88fe0f06b7676/12f09/1681299554240-6f64fada-9b93-46ea-bc37-9da587893f90.png 148w,\n/static/0590d5b92c328ec471c88fe0f06b7676/e4a3f/1681299554240-6f64fada-9b93-46ea-bc37-9da587893f90.png 295w,\n/static/0590d5b92c328ec471c88fe0f06b7676/fcda8/1681299554240-6f64fada-9b93-46ea-bc37-9da587893f90.png 590w,\n/static/0590d5b92c328ec471c88fe0f06b7676/efc66/1681299554240-6f64fada-9b93-46ea-bc37-9da587893f90.png 885w,\n/static/0590d5b92c328ec471c88fe0f06b7676/c83ae/1681299554240-6f64fada-9b93-46ea-bc37-9da587893f90.png 1180w,\n/static/0590d5b92c328ec471c88fe0f06b7676/10c1e/1681299554240-6f64fada-9b93-46ea-bc37-9da587893f90.png 2090w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>调用这个端点时，需要传入 client_id 以及其他参数，比如：</p>\n<p>json\n<a href=\"https://authorization.server/connect/authorize?client_id=client_id&#x26;response_type=code&#x26;scope=openid%20profile%20email&#x26;redirect_uri=redirect_uri&#x26;state=123&#x26;nonce=xyz\">https://authorization.server/connect/authorize?client_id=client_id&#x26;response_type=code&#x26;scope=openid%20profile%20email&#x26;redirect_uri=redirect_uri&#x26;state=123&#x26;nonce=xyz</a></p>\n<p>用户登录并授权之后，授权码会以 URL 查询字符串形式传回第三方应用：</p>\n<p>json\n<a href=\"https://your.application.url/redirect_uri?code=8FCF7967CCAF7180156C4893A46A3C4D904C717E998FF52FF82E9C00ED16125F-1&#x26;scope=openid%20profile%20email&#x26;state=123&#x26;session_state=-A4y9wa8gx4btgTrVj3HCI6OhURL4PsiZBcOLYmx7Yk.3B809B07D68954DC3036C9D015E33C03&#x26;iss=https://authorization.server\">https://your.application.url/redirect_uri?code=8FCF7967CCAF7180156C4893A46A3C4D904C717E998FF52FF82E9C00ED16125F-1&#x26;scope=openid%20profile%20email&#x26;state=123&#x26;session_state=-A4y9wa8gx4btgTrVj3HCI6OhURL4PsiZBcOLYmx7Yk.3B809B07D68954DC3036C9D015E33C03&#x26;iss=https://authorization.server</a></p>\n<p><a name=USOju></a></p>\n<h2>令牌端点</h2>\n<p>第三方应用使用该端点来用授权码交换令牌：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/aec29998f2b4ee0034caea6be4c31981/6e52c/1681299826284-678904af-0099-43ae-9656-c4d4d3a9671f.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.16216216216216%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsTAAALEwEAmpwYAAABTklEQVR42k3NW0/CMACGYf7/r/DOG++MN4YgKBhEEILbUrq1rDvCaHfouo7uqGiMvPlun3wDKaVSiufiRGkuuZCSpqc4Y1yIsmqqpqubrq675md11SpVK1X9biCKoiwKDCGLQhIuvYPmHbY4mCcJTg87zvaUmSxBUWaFKaC5Xai0/2sghJCEmJMxGI3wbOosx2T96MIRNafxdnJcPsDFrb25P5F1IsNzJdqu/cec88szQhghE5pB4PlMd+MNE37VtvxMCV3vj+9O9BHnbtNU/VUXLMsSY4wwRsjCyD5lDo7extsbO1wB53mxu7OOryiaw/AlL2nf913fXWEpAQCaphmGoeuGTbDlbLX90ApnujME7iSWhNAVCJ489smEk8qgUMkFZ1lWlqVhGJqmQQgBALquQ2gFtp8mx5QHqYxo7iXSTwqf8j3NybkSdau+8RepxX10V0rrnAAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/aec29998f2b4ee0034caea6be4c31981/fcda8/1681299826284-678904af-0099-43ae-9656-c4d4d3a9671f.png\"\n        srcset=\"/static/aec29998f2b4ee0034caea6be4c31981/12f09/1681299826284-678904af-0099-43ae-9656-c4d4d3a9671f.png 148w,\n/static/aec29998f2b4ee0034caea6be4c31981/e4a3f/1681299826284-678904af-0099-43ae-9656-c4d4d3a9671f.png 295w,\n/static/aec29998f2b4ee0034caea6be4c31981/fcda8/1681299826284-678904af-0099-43ae-9656-c4d4d3a9671f.png 590w,\n/static/aec29998f2b4ee0034caea6be4c31981/efc66/1681299826284-678904af-0099-43ae-9656-c4d4d3a9671f.png 885w,\n/static/aec29998f2b4ee0034caea6be4c31981/c83ae/1681299826284-678904af-0099-43ae-9656-c4d4d3a9671f.png 1180w,\n/static/aec29998f2b4ee0034caea6be4c31981/6e52c/1681299826284-678904af-0099-43ae-9656-c4d4d3a9671f.png 1948w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><a name=QDepq></a></p>\n<h2>用户信息端点</h2>\n<p>有前面的端点，服务就是实现了 OAuth 2.0 的协议。而实现这个端点，就是提供了 OIDC 的能力了。通过它，第三方应用可以用令牌换取到用户的信息：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 33.108108108108105%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsTAAALEwEAmpwYAAABUElEQVR42k3P70+CQBwGcP//f6NXrdaWW1s1mzkdjpn5A+X8wgGnJ9Chdwgid4BSaav17Nnz7vPiaShVpPssiqIkSeM4ESLeci7ETohEykKp6tLyb6UspFQ/bSilwjBM04RnHkvw1HvW4XpoN/eKl6c8LxNZpkWVyTKV5T4vdtWx+PxNQx0ONiwoWfo+BjzAZOgGmkM7LDQEdzHV3UAjbLDejOlmLDJaVvIfxjbVNNLrOq8dNnz7MF642YnNrm+0djPNebslo3s6edhO2gWjZ1HX/3B+sAEshACZCxNtttSL+gZ50q27QMx1dINoC9Ztc/nsMV1Vh4uqf7FSjuMsADDG87kZMp9Eo7UwwhhkuWMpXvL3FR9524HD+pkSp/pYVHl1Oj9v5HkOAAghy7IuawOAS6wVM30xc5n+bjen7mN3egVBx/7okWggMppJ/o2/AINkeiVYPTgEAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/5cab0dd6d5f4f6b4d89b06a25261149d/fcda8/1681299985816-3caf9ac0-08d6-4c36-b87a-fcf1f0169f7d.png\"\n        srcset=\"/static/5cab0dd6d5f4f6b4d89b06a25261149d/12f09/1681299985816-3caf9ac0-08d6-4c36-b87a-fcf1f0169f7d.png 148w,\n/static/5cab0dd6d5f4f6b4d89b06a25261149d/e4a3f/1681299985816-3caf9ac0-08d6-4c36-b87a-fcf1f0169f7d.png 295w,\n/static/5cab0dd6d5f4f6b4d89b06a25261149d/fcda8/1681299985816-3caf9ac0-08d6-4c36-b87a-fcf1f0169f7d.png 590w,\n/static/5cab0dd6d5f4f6b4d89b06a25261149d/efc66/1681299985816-3caf9ac0-08d6-4c36-b87a-fcf1f0169f7d.png 885w,\n/static/5cab0dd6d5f4f6b4d89b06a25261149d/c83ae/1681299985816-3caf9ac0-08d6-4c36-b87a-fcf1f0169f7d.png 1180w,\n/static/5cab0dd6d5f4f6b4d89b06a25261149d/6e52c/1681299985816-3caf9ac0-08d6-4c36-b87a-fcf1f0169f7d.png 1948w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n<a name=KCxwo></a></p>\n<h1>彩蛋</h1>\n<p>写完这个测试，我顺便还研究了一下更多的相关的内容。\n<a name=Fnzyb></a></p>\n<h2>结束会话（退出登录）端点</h2>\n<p>前面都是用户会话的建立过程，对于结束会话（退出登录），第三方应用也需要和授权服务打交道（通知授权服务）。不然，仅仅应用内退出登录，是无效的。因为用户只要一点击登录，不需要输入凭据，就会自动进入登录状态。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/259fc326324a4cd7d5d3ca774c547a6f/00e09/1681300179253-7179605c-99f8-4f52-b39c-d1a90049ecff.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 39.86486486486486%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsTAAALEwEAmpwYAAABhUlEQVR42lWRS4/TMBRG+/9X7FghsWM1uwHKDIOAatR0GmlIaOI4cezEUWgezrR5ubbjuKgzQsDRp6tvc6SrexdCyL4f90VVlA2rW9Yca/bUNMeyYl0/jlxwLjmX4/N8KcN4eslCKdUwNgxDL4ryCPpxP2nRi8aY2Zj5bIyelZ7VpMWkpZr4NMvzHy4yCIIwQiSDHrHyChdthIr777u333ZvttGVl9/F1SZtHkltlx3isv0ry7ZNHSeybbixfwWQonuKvoL0xiu+4IMbktso+EDQXZU98iqb2+78DwvJ6tiy4HodWWt/taqhT8Mb7H+KVu/829fh8lWye0+CJfx5FfvXfQb/kyelEoxDAFAYAs/Ls5QWros/7vA1jD8HaLl/8qJ8lVY2KTYDZ7PRepZ6VhdZCJEkCSaEUpokCaUZJjHNcXmIiyGoRyR0S2o7LixSPeDqgbIfTU9bXhpjLgdDCG23WwCA4ziu6zquCwGkKO2amrcHbZTSoh+ZnMaTak+qu3zhee3fEgqw/ig7xL8AAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/259fc326324a4cd7d5d3ca774c547a6f/fcda8/1681300179253-7179605c-99f8-4f52-b39c-d1a90049ecff.png\"\n        srcset=\"/static/259fc326324a4cd7d5d3ca774c547a6f/12f09/1681300179253-7179605c-99f8-4f52-b39c-d1a90049ecff.png 148w,\n/static/259fc326324a4cd7d5d3ca774c547a6f/e4a3f/1681300179253-7179605c-99f8-4f52-b39c-d1a90049ecff.png 295w,\n/static/259fc326324a4cd7d5d3ca774c547a6f/fcda8/1681300179253-7179605c-99f8-4f52-b39c-d1a90049ecff.png 590w,\n/static/259fc326324a4cd7d5d3ca774c547a6f/efc66/1681300179253-7179605c-99f8-4f52-b39c-d1a90049ecff.png 885w,\n/static/259fc326324a4cd7d5d3ca774c547a6f/c83ae/1681300179253-7179605c-99f8-4f52-b39c-d1a90049ecff.png 1180w,\n/static/259fc326324a4cd7d5d3ca774c547a6f/00e09/1681300179253-7179605c-99f8-4f52-b39c-d1a90049ecff.png 1854w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>当应用退出登录时，需要将用户重定向至结束会话端点，并传入用户的身份令牌以及登录完成后的跳转链接。比如：</p>\n<p>json\n<a href=\"https://authorization.server/connect/endsession?id_token_hint=$%7Bid_token%7D&#x26;post_logout_redirect_uri=$%7BencodeURIComponent(application\">https://authorization.server/connect/endsession?id_token_hint=${id_token}&#x26;post_logout_redirect_uri=${encodeURIComponent(application</a> url)}</p>\n<p>这样，用户在退出登录时会看到这样的页面：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a558ef373a4d073ed8e52eb8bc6fd5bc/da893/1681300355116-40865277-5fbb-407f-bb06-af891bb77312.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.027027027027025%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAzElEQVR42nWNvYrCUBCF72MquvFG1JgoKLiFNr5RNJhC708iPoSFhSAIy7I2iqvi3MwdSQoLIR/fwDnNGfY9nraD4WA0cbuDSrNfbY0c3mtw3+FBrht8cb/GvRr36q5Xz0Mnr42O0/SZTjdSr4VMVipZiiRWItTRTC8iHUc6DmUUyvlKKalSoVJZKAqVXjMiMsacr7fb/fF/uZ4efzuzPcD+CIdf85MREFkqgSFiliGYDMBAfsY+LYJFQHwiIVkkLIF9jNnijyX7DlTOC0ts8+BEz4riAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/a558ef373a4d073ed8e52eb8bc6fd5bc/fcda8/1681300355116-40865277-5fbb-407f-bb06-af891bb77312.png\"\n        srcset=\"/static/a558ef373a4d073ed8e52eb8bc6fd5bc/12f09/1681300355116-40865277-5fbb-407f-bb06-af891bb77312.png 148w,\n/static/a558ef373a4d073ed8e52eb8bc6fd5bc/e4a3f/1681300355116-40865277-5fbb-407f-bb06-af891bb77312.png 295w,\n/static/a558ef373a4d073ed8e52eb8bc6fd5bc/fcda8/1681300355116-40865277-5fbb-407f-bb06-af891bb77312.png 590w,\n/static/a558ef373a4d073ed8e52eb8bc6fd5bc/efc66/1681300355116-40865277-5fbb-407f-bb06-af891bb77312.png 885w,\n/static/a558ef373a4d073ed8e52eb8bc6fd5bc/c83ae/1681300355116-40865277-5fbb-407f-bb06-af891bb77312.png 1180w,\n/static/a558ef373a4d073ed8e52eb8bc6fd5bc/da893/1681300355116-40865277-5fbb-407f-bb06-af891bb77312.png 2130w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><a name=kM4W4></a></p>\n<h2>排障指引</h2>\n<p><a name=pFPl1></a></p>\n<h3>为什么获取到的用户信息中，没有邮箱？</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 64.1891891891892%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAABvElEQVR42pVTS8+bMBDk//+knnrqtbceKAQIT4OxjTFvkql2v7gln1RVjTRar2OPd2eWwLkFQjhEUYX7vUBVVSiKAnVdc8zznPfKskTTNJBSMmgthEDf9xw7KWGkRDDPM4SQ0FrxwbZt+XDXdbwm0NrvHceBfd8Z27a9xfPx+CA0RvFLxhhM08SX6dAwDFBKMc7zxL9+DyKklrvOYhhGrOvKRERKlSzLwqB9yunC8/n8K16EK8zwwOiO35ufI4EqJFIPyn3rVwmCOMzw7esX1E2Le5axwF5wMsNaC+ccxnHk6EE5VX7VkPIgzwSS+DsaIdhJT0QOU/QmXSFeZ4n4nXBDoNTCgrrRsctaazaIKpN9j/blNv1HbXoJSI7PMmz7jkDWOeSsUZUlX0qShF+n6uqigLMDkxPILJoKwrX9ibDtUOEPBErkUK5hwiiOEYYh4ihC+DNCFYVo0gRJliFLU6Rpyg/ebjcefC9BS7oLAd11CNa+xRPAZA10TzOnuW2qyFgL9ZLA7/m5JN2u7rPrx4FgMT3mbcekBSZrcZ6kzft4eFxzb4bHR74icNPEomtj2aV5/qPT/4A+AIq/AGb645oC69hTAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/6a9ac4e8adf565bf27681ee0792f7f0b/fcda8/1681301010862-3e81f366-534e-413e-84e0-69a8a23b4248.png\"\n        srcset=\"/static/6a9ac4e8adf565bf27681ee0792f7f0b/12f09/1681301010862-3e81f366-534e-413e-84e0-69a8a23b4248.png 148w,\n/static/6a9ac4e8adf565bf27681ee0792f7f0b/e4a3f/1681301010862-3e81f366-534e-413e-84e0-69a8a23b4248.png 295w,\n/static/6a9ac4e8adf565bf27681ee0792f7f0b/fcda8/1681301010862-3e81f366-534e-413e-84e0-69a8a23b4248.png 590w,\n/static/6a9ac4e8adf565bf27681ee0792f7f0b/efc66/1681301010862-3e81f366-534e-413e-84e0-69a8a23b4248.png 885w,\n/static/6a9ac4e8adf565bf27681ee0792f7f0b/c83ae/1681301010862-3e81f366-534e-413e-84e0-69a8a23b4248.png 1180w,\n/static/6a9ac4e8adf565bf27681ee0792f7f0b/9685e/1681301010862-3e81f366-534e-413e-84e0-69a8a23b4248.png 1336w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span><br />检查一下在调用授权端点时，有没有传入 email 这个 scope？如果这一步没有传 email，而仅在之后的获取用户令牌以及获取用户信息时，传入 email scope 的话，是拿不到用户的 email 的。因为在之前的授权步骤，用户没有机会授权给你 email 。\n<a name=DiO3N></a></p>\n<h3>为什么请求令牌接口没有返回身份令牌？</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0512bd54bf18dd96f17434a8b53bb92f/07a9c/1681300890136-09532066-1d98-4597-9a3f-06817c108827.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.10810810810811%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAABgElEQVR42nWRXY7bMAyEffPerIdoH7q7KdrGSZzEjm39UKQokkohZ1ukQHfwYTAjQHwgu4TJP+Sc/yMiyv8T5SxMF0efPuPXS+kSJAAIIcbgIbWckarVZ5mZqj7VOkPJRTsu2aqoiVW1qmoCGNXk/iRVZebnF2EmxG7KR6+ja1w3xn7Z7ec3KihFRKSUYmb3f1VrJaKOSxFVEbVatZqaAaQQY2bOzFwKc0NES6MNZFEqwsxdjDEhAAARaSn3j6VmYqqmYga5qFpHSOPiTos/3NxxbqHl2R1md5r9sYX2sgJu0Aq4ALqE7XPA/KW/fDuNr8O0O7/zstUHb5vvzre/9WUYf1xnNesA0s/hOqxuCnALaQqwhcb07mmOOMf0qB4JiCGzVevAx9N57CfX39x+8421n9b9xuG2ntcwehg9LIAes085Elut3epv3w+/Xq/Dfl5OS1ji++AGcSROuflGDgkxM2YmZjPrZujHsB/wiJrM2ko/2nattR2ttOsXZhH5DQFhr3uu9eh6AAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/0512bd54bf18dd96f17434a8b53bb92f/fcda8/1681300890136-09532066-1d98-4597-9a3f-06817c108827.png\"\n        srcset=\"/static/0512bd54bf18dd96f17434a8b53bb92f/12f09/1681300890136-09532066-1d98-4597-9a3f-06817c108827.png 148w,\n/static/0512bd54bf18dd96f17434a8b53bb92f/e4a3f/1681300890136-09532066-1d98-4597-9a3f-06817c108827.png 295w,\n/static/0512bd54bf18dd96f17434a8b53bb92f/fcda8/1681300890136-09532066-1d98-4597-9a3f-06817c108827.png 590w,\n/static/0512bd54bf18dd96f17434a8b53bb92f/efc66/1681300890136-09532066-1d98-4597-9a3f-06817c108827.png 885w,\n/static/0512bd54bf18dd96f17434a8b53bb92f/c83ae/1681300890136-09532066-1d98-4597-9a3f-06817c108827.png 1180w,\n/static/0512bd54bf18dd96f17434a8b53bb92f/07a9c/1681300890136-09532066-1d98-4597-9a3f-06817c108827.png 1440w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><br />原因同上。</p>\n<p>检查一下在调用授权端点时，有没有传入 openid 这个 scope？如果这一步没有传 openid，而仅在之后的获取用户令牌时，传入 openid scope 的话，是拿不到用户的 id_token 的。因为在之前的授权步骤，用户没有机会授权给你 id_token。</p>\n<p>总之，要获取用户的哪部分信息，就得让用户授权相应的 scope。一般常用的 scope 是 openid profile email。\n<a name=TrM0R></a></p>\n<h3>为什么不能退出登录？</h3>\n<p>检查应用的退出登录，是否对接了结束会话这个端点。</p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}},"menus":{}}},"staticQueryHashes":[],"slicesMap":{}}