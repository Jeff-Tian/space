{"componentChunkName":"component---src-templates-post-js","path":"/posts/azl1phhstd3euu1w/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/azl1phhstd3euu1w","relativePath":"posts/azl1phhstd3euu1w","frontmatter":{"title":"基于 Keycloak 的关注微信公众号即登录方案再次升级：有意思的成长","stackbit_url_path":"posts/azl1phhstd3euu1w","date":"2024-01-29T05:06:34","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p>几年前出于个人兴趣，基于 Keycloak 做了一个关注微信公众号即登录的方案，见《<a href=\"%5Bhttps://zhuanlan.zhihu.com/p/349504145%5D(https://zhuanlan.zhihu.com/p/349504145)\">基于 keycloak 的关注公众号即登录功能的设计与实现 - Jeff Tian的文章 - 知乎</a> 》，它是基于一个大佬写的 <a href=\"https://github.com/jyqq163/keycloak-services-social-weixin\">https://github.com/jyqq163/keycloak-services-social-weixin</a> Keycloak 插件，进行了一番魔改而成的。日子一天一天过去，没想到，我的这个魔改版本，star 数量居然开始超过原版了。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 72.2972972972973%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAABrklEQVR42o2Ti46rMAxE+/9f2LulVSkFVJUA4ZmHw6xsCkupdnUtGYXEnEzG4TBNE/4K5xxutxviOIa1Vub4myX3ceBH8Xzi8vUPURTheDzidDrhfD7Le5IkICKEEGbIC7gEhQmtC6gHCzcOMzCOZwXX6xWXy0Ug9/tdlD0ejxWwBfG4dwGVIZgAkBkRxn4G1nUtKv4n/KLIkADx2iS0GhPRDFRKiVef/szFjiZoS5KNDTAUfpRyBgI19ewhK8vzHN77N+DiDythEENp14SlLgwdgjUzkI9bFMUbcDka+8OgPWS76eQdqKnWtQPDuAHcxS2QldGmGWtuagRWFW9NEw/LslwVcgw+iPHbDaadHcGMIF1i2glZu7w0xVJAbWk53wdIpsmDdPXh5aqQ7xp5B8e+jfR+xAXKqqyBbzU8K6NX3XLhXylArWsMjjD89hcGAvoWGPr13v0W869X1YiSXJR2XSeeZlmGtlSo0huS6AuVUmi7Dvc0lfW2baWmUIWM+erxtwLkDvddB601jDHo+158NeMIYy2yPIdSJawxAuN1rmt0g7RO8VRPZGkmwG/ohkaimm3QqAAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"star-history-2024129.png\"\n        title=\"star-history-2024129.png\"\n        src=\"/static/8d012a7e5948c1d30278a4e591848acc/fcda8/1706502201963-d6888950-aff6-47c5-b77e-2b705c4913d9.png\"\n        srcset=\"/static/8d012a7e5948c1d30278a4e591848acc/12f09/1706502201963-d6888950-aff6-47c5-b77e-2b705c4913d9.png 148w,\n/static/8d012a7e5948c1d30278a4e591848acc/e4a3f/1706502201963-d6888950-aff6-47c5-b77e-2b705c4913d9.png 295w,\n/static/8d012a7e5948c1d30278a4e591848acc/fcda8/1706502201963-d6888950-aff6-47c5-b77e-2b705c4913d9.png 590w,\n/static/8d012a7e5948c1d30278a4e591848acc/efc66/1706502201963-d6888950-aff6-47c5-b77e-2b705c4913d9.png 885w,\n/static/8d012a7e5948c1d30278a4e591848acc/c83ae/1706502201963-d6888950-aff6-47c5-b77e-2b705c4913d9.png 1180w,\n/static/8d012a7e5948c1d30278a4e591848acc/f1841/1706502201963-d6888950-aff6-47c5-b77e-2b705c4913d9.png 4016w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>由于自己主要使用语言是 nodejs，对于 Java 并不太熟悉，所以原版对我帮助很大，不然，我根本不知道如何下手开始为 Keycloak 写插件。虽然写得很烂，但的确有一定的商业价值，因为通过关注公众号登录，比起普通的扫码登录，无论是对用户，还是对开发，都更友好。<br />我想就是因为这个小小的商业价值，导致这个小插件，被越来越多的人关注，并被多家公司正式商用（比如“答疑家”）。由于有用户，所以我也陆续不断对它进行迭代升级，并在这个过程中，不断学习 Java 以及微信生态，这是一个<strong>有趣的成长过程</strong>。<br />更有趣的是，我最近尝试在自己的应用中加入 GenAI，其中之一就是在微信公众号中，利用 GenAI 进行自动回复（《<a href=\"%5Bhttps://zhuanlan.zhihu.com/p/674125115%5D(https://zhuanlan.zhihu.com/p/674125115)\">欢迎来调戏我：在公众号里对接 AWS Bedrock 服务 - Jeff Tian的文章 - 知乎</a> 》），因此稍稍学习了一下微信的消息接口，最终发现又可以将这个学习成果应用在本 Keycloak 微信插件当中，进一步提升开发者体验，这就是<strong>更加有趣的一点了</strong>。\n<a name=SrLDj></a></p>\n<h1>体验</h1>\n<p>可以通过这个链接 <a href=\"https://keycloak.jiwai.win/realms/Brickverse/account/#/\">https://keycloak.jiwai.win/realms/Brickverse/account/#/</a> 进行体验，在 PC Web 端选择微信登录方式即可。注意上述链接中使用了我个人的测试公众号，只能支持 100 个用户。\n<a name=gMf2v></a></p>\n<h1>现状</h1>\n<p>在《<a href=\"%5Bhttps://zhuanlan.zhihu.com/p/652566471%5D(https://zhuanlan.zhihu.com/p/652566471)\">【继续更新】尝试在 Keycloak 里打通整个微信生态 - Jeff Tian的文章 - 知乎</a> 》里，介绍了该 Keycloak 微信登录插件，支持三种登录方式，分别是 ① 关注公众号即登录；② 基于开放平台的 OAuth 2.0 扫码登录；③ 手机端基于公众号的 OAuth 2.0 方式登录。但是，对于第 ① 种方式，配置方式其实是很麻烦的，这是因为需要开发者自己去将微信服务器发送过来的带参二维码扫描或者关注的 xml 消息，转发给 keycloak 服务器。也就是说需要开发者自己实现和微信服务器的对接。<br />具体来说，需要开发者在接收到微信服务器发来的 xml 消息后，将消息原封不动地转发给 Keycloak 服务器的 /realms/<realm>/QrCodeResourceProviderFactory/mp-qr-scan-status接口，比如这样完整 URL：<a href=\"https://keycloak.jiwai.win/realms/Brickverse/QrCodeResourceProviderFactory/mp-qr-scan-status\">https://keycloak.jiwai.win/realms/Brickverse/QrCodeResourceProviderFactory/mp-qr-scan-status</a>。要注意的是，需要在微信公众号后台配置自己的消息处理服务接口，直接配置 Keycloak 的是不行的。因为以上 Keycloak 接口只用来接收微信扫码事件，并没有实现微信消息接口协议，直接配置上去微信是不认的，会报错：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 85.8108108108108%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAABYlAAAWJQFJUiTwAAACSklEQVR42nVTy47TQBD0N3LmE+DGCfFZIHFB4oQQHPYAEiB2pcSwm9iOMy9Pz9Mp1JNMNskGS62eZ7mquqfp+w1Wqw6jkAgxgbwH+fAYjuASIJdvsf3wDPLTS6gvryE/v4L6+gbi43OITy9AVoN8RHPbLvDt5w+0f+9hyME6fxbOJYxuwM30HnS2fxiThSUC+QzLgN0kIL2FMRZbqeBCPImAGIC1a/Fdv0OaCJP+A6vXoKkHTeuiwFqJSd6BdIfGu4DgA5z3SCnBs2TnDpmQ/Iwu32EIv4A8Y04Gu0xIJBHtBnOOyImQk8GcExprLdq2xe3vWyyXSywWixKr1Qptu8R92+HO3iAjAzOQyILGoUQkwuXXMJN5nsuEM7PkiDEipogYElQaMckeen0PPQ5IMWB3ANjtdmfROOeRcy6bDKS1hpAS4zhCSYXNOMIoAzFuYMy+kqcAB9TjuPEhFMB6IOeEnBLmeT+vrPkMr1VWdf+U5VFyDKFM+JIQsjALMcI7X6SffkdWF0BPGIbSIhFKGljrEGPYM2M/D74y26IipXL+GnBhSEQwxsCRg9yKwnK7HaG0hlYSUipIIUoTM2PuDKPNdckhPEpipkpPx4jxwCxnpLz3sfp9CXRsG+dcqaiUsjB9eFhhGIZ9hTebsl4qL0RR8H8v8eghe8PBcrjJGYRlMVCxwrmSa4EuC3EK3lyay2yZ6bFQMZbMoCz/GsMzyRWw+tH3Pbqug1KqvGcG4h9M01Tm/IP6sq6BPgHkS7xWcx1XMM71ZV0D/AeYxyhJ0JpPSQAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/49c1e5a48f81eca651d565836a1480b4/fcda8/1706504357304-8f7f6c17-f2e2-40d5-9619-989948693027.png\"\n        srcset=\"/static/49c1e5a48f81eca651d565836a1480b4/12f09/1706504357304-8f7f6c17-f2e2-40d5-9619-989948693027.png 148w,\n/static/49c1e5a48f81eca651d565836a1480b4/e4a3f/1706504357304-8f7f6c17-f2e2-40d5-9619-989948693027.png 295w,\n/static/49c1e5a48f81eca651d565836a1480b4/fcda8/1706504357304-8f7f6c17-f2e2-40d5-9619-989948693027.png 590w,\n/static/49c1e5a48f81eca651d565836a1480b4/efc66/1706504357304-8f7f6c17-f2e2-40d5-9619-989948693027.png 885w,\n/static/49c1e5a48f81eca651d565836a1480b4/c83ae/1706504357304-8f7f6c17-f2e2-40d5-9619-989948693027.png 1180w,\n/static/49c1e5a48f81eca651d565836a1480b4/ec5f6/1706504357304-8f7f6c17-f2e2-40d5-9619-989948693027.png 1852w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span><br />所以这就要求开发者自己实现和微信的消息对接，这可能需要一定的开发，所以是高级用法。当然，自己和微信消息对接<strong>也是有好处的，比如可以针对消息做更多的业务逻辑处理</strong>，只是同时需要将它转发给 Keycloak 而已。<br />但如果并没有高级需求，那么如果可以直接将 Keycloak 的 URL 配置上去，显然会更加方便，省去了自己的开发步骤。\n<a name=CigeI></a></p>\n<h1>改进</h1>\n<p>因为自己对微信的消息机制又了解得更多了，所以直接在 Keycloak 里对接了微信的消息接口，这样就可以进一步简化开发者的接入了。但同时，老的转发方式也还在，也就是变成了高级接入方式。通过高级接入，开发者可以基于微信的消息做更多的事情。<br />通过使用新版本 <a href=\"%5Bhttps://github.com/Jeff-Tian/keycloak-services-social-weixin/releases/tag/0.5.13%5D(https://github.com/Jeff-Tian/keycloak-services-social-weixin/releases/tag/0.5.13)\">0.5.13</a> 中，就可以省去自己开发微信消息接口的步骤，直接配置 Keycloak 插件里自带的，即：/realms/<realm>/QrCodeResourceProviderFactory/message接口。比如我在体验链接实例里，就是这样配置的：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 14.18918918918919%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAbUlEQVR42j3ISw7DIAwAUe5/xqpR2IF/2AugciBVicpbjSbEGF/vA1jN9GGrbNnHVE2LanmISO89pJTOMyIxAuScYRERAEgpAQD9YAaGUklrW2qt7h5aa5/emZmImBkR6W+3u19jXPMe897mnF8DBKlHzrqKvwAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/431bb75dbddc5a7a4e5f7979c67bbaf5/fcda8/1706504624416-0baa49a0-9b35-4417-b3c1-2b27a284227b.png\"\n        srcset=\"/static/431bb75dbddc5a7a4e5f7979c67bbaf5/12f09/1706504624416-0baa49a0-9b35-4417-b3c1-2b27a284227b.png 148w,\n/static/431bb75dbddc5a7a4e5f7979c67bbaf5/e4a3f/1706504624416-0baa49a0-9b35-4417-b3c1-2b27a284227b.png 295w,\n/static/431bb75dbddc5a7a4e5f7979c67bbaf5/fcda8/1706504624416-0baa49a0-9b35-4417-b3c1-2b27a284227b.png 590w,\n/static/431bb75dbddc5a7a4e5f7979c67bbaf5/efc66/1706504624416-0baa49a0-9b35-4417-b3c1-2b27a284227b.png 885w,\n/static/431bb75dbddc5a7a4e5f7979c67bbaf5/c83ae/1706504624416-0baa49a0-9b35-4417-b3c1-2b27a284227b.png 1180w,\n/static/431bb75dbddc5a7a4e5f7979c67bbaf5/9c2d2/1706504624416-0baa49a0-9b35-4417-b3c1-2b27a284227b.png 2226w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n<a name=hTp9D></a></p>\n<h1>待办事项</h1>\n<p>不过，这个关注公众号即登录，还有更多值得优化的地方，比如需要支持分布式缓存等。现在这个插件，只能用在单个 Keycloak 实例中，如果要横向扩展，就需要引入 Redis 或者其他数据库来对扫码状态做存储。</p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}}}},"staticQueryHashes":[],"slicesMap":{}}