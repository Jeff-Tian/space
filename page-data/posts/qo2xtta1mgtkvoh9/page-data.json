{"componentChunkName":"component---src-templates-post-js","path":"/posts/qo2xtta1mgtkvoh9/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/qo2xtta1mgtkvoh9","relativePath":"posts/qo2xtta1mgtkvoh9","frontmatter":{"title":"OAuth 2.0：对接 IdentityServer 设备码授权流程","stackbit_url_path":"posts/qo2xtta1mgtkvoh9","date":"2022-12-26T07:53:46","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p><a name=Y16qU></a></p>\n<h1>前情提要</h1>\n<p>《 <a href=\"https://zhuanlan.zhihu.com/p/488194876\">OAuth 2.0：对接 Keycloak 设备码授权流程 - Jeff Tian的文章 - 知乎</a>  》 里使用 k8ss login演示了命令行程序对接 Keycloak 的设备码授权流程。</p>\n<p>今天，再来扩充一下 k8ss login，它默认使用 Keycloak 的设备码授权流程，但是支持额外的参数让用户指定授权服务器，比如 IdentityServer。即 k8ss login identity-server，可以对接 IdentityServer 的设备码授权流程。</p>\n<p>在《<a href=\"https://zhuanlan.zhihu.com/p/482103322\">身份验证哪家强？IdentityServer 初体验 - Jeff Tian的文章 - 知乎</a> 》中，我部署了一个 IdentityServer 授权服务器到 <a href=\"https://id6.azurewebsites.net/Account/Login\">https://id6.azurewebsites.net/Account/Login</a>。</p>\n<p>又在《<a href=\"https://zhuanlan.zhihu.com/p/591856146\">Free Arch： 将 IdentityServer 部署到 Okteto - Jeff Tian的文章 - 知乎</a>  》中，将该 IdentityServer 再部署了一份到 Okteto： <a href=\"https://id6-jeff-tian.cloud.okteto.net/\">https://id6-jeff-tian.cloud.okteto.net/</a>。\n<a name=hRadp></a></p>\n<h1>流程概览</h1>\n<p>其实和对接 Keycloak 基本一样。</p>\n<p><a name=T1cpE></a></p>\n<h2>流程图</h2>\n<p><img src=\"https://cdn.nlark.com/yuque/__puml/552bb6b245e3ec1c4d06a170adde7b70.svg#lake_card_v2=eyJ0eXBlIjoicHVtbCIsImNvZGUiOiJgYGBwbGFudHVtbFxuQHN0YXJ0dW1sXG5hY3RvciBVc2VyIGFzIFwi55So5oi3XCJcbnBhcnRpY2lwYW50IENvbnNvbGUgYXMgXCLlkb3ku6TooYznqIvluo9cIlxucGFydGljaXBhbnQgXCIvY29ubmVjdC9kZXZpY2UvYXV0aG9yaXphdGlvblwiXG5wYXJ0aWNpcGFudCBcIi9jb25uZWN0L3Rva2VuXCJcbnBhcnRpY2lwYW50IFwiVXNlciBBZ2VudFwiXG5wYXJ0aWNpcGFudCBcIklkZW50aXR5IFNlcnZlclwiXG5cblVzZXIgLT4gQ29uc29sZTog55m75b2VXG5Db25zb2xlIC0-IFwiL2Nvbm5lY3QvZGV2aWNlL2F1dGhvcml6YXRpb25cIjogY2xpZW50X2lkLCBzY29wZVxuQ29uc29sZSA8LS0gXCIvY29ubmVjdC9kZXZpY2UvYXV0aG9yaXphdGlvblwiOiBkZXZpY2VfY29kZSwgdXNlcl9jb2RlLCB2ZXJpZmljYXRpb25fdXJpLCB2ZXJpZmljYXRpb25fdXJpX2NvbXBsZXRlXG5Db25zb2xlIC0tPiBVc2VyOiDlsZXnpLrkuoznu7TnoIHlubbkuJTlkozmjojmnYPnoIHov5vooYzpk77mjqVcblVzZXIgLT4gXCJVc2VyIEFnZW50XCI6IHVzZXJfY29kZSwgdmVyaWZpY2F0aW9uX3VyaSBvciBRUiBDb2RlICh2ZXJpZmljYXRpb25fdXJpX2NvbXBsZXRlKVxuXG5cIlVzZXIgQWdlbnRcIiAtPiBcIklkZW50aXR5IFNlcnZlclwiOiB1c2VyX2NvZGVcblwiVXNlciBBZ2VudFwiIDwtLSBcIklkZW50aXR5IFNlcnZlclwiIDogQXV0aCBjaGFsbGFuZ2VcblVzZXIgLT4gXCJVc2VyIEFnZW50XCI6IEVudGVyIGNyZWRlbnRpYWxzXG5cIlVzZXIgQWdlbnRcIiAtPiBcIklkZW50aXR5IFNlcnZlclwiOiBVc2VyIGF1dGhlbnRpY2F0ZXNcblxuYWx0IOi9ruivolxuICAgIENvbnNvbGUgLT4gXCIvY29ubmVjdC90b2tlblwiOiBjbGllbnRfaWQsIGRldmljZV9jb2RlXG4gICAgQ29uc29sZSA8LS0gXCIvY29ubmVjdC90b2tlblwiOiBhdXRob3JpemF0aW9uX3BlbmRpbmcsIHNsb3duX2Rvd25cbmVuZFxuXG5Db25zb2xlIC0-IFwiL2Nvbm5lY3QvdG9rZW5cIjogY2xpZW50X2lkLCBkZXZpY2VfY29kZVxuQ29uc29sZSA8LS0gXCIvY29ubmVjdC90b2tlblwiOiBhY2Nlc3NfdG9rZW4sIHJlZnJlc2hfdG9rZW4sIGlkX3Rva2VuXG5cbkBlbmR1bWxcbmBgYFxuIiwidXJsIjoiaHR0cHM6Ly9jZG4ubmxhcmsuY29tL3l1cXVlL19fcHVtbC81NTJiYjZiMjQ1ZTNlYzFjNGQwNmExNzBhZGRlN2I3MC5zdmciLCJpZCI6IkhmRnFuIiwibWFyZ2luIjp7InRvcCI6dHJ1ZSwiYm90dG9tIjp0cnVlfSwiY2FyZCI6ImRpYWdyYW0ifQ==\" alt=\"\"><a name=UUJhV></a></p>\n<h2>请求样例</h2>\n<p>shell\nURI: POST <a href=\"https://id6.azurewebsites.net/connect/deviceauthorization\">https://id6.azurewebsites.net/connect/deviceauthorization</a>\nBODY: client_id={clientId}&#x26;scope=openid+profile+offline_access\nRESPONSE: {\ndevice_code:CXhs2ccYCR5pHbr_3Re0YfmFJZyOsAVgMuc1AIfIw4E, // Code for polling on token endpoint\nuser_code:888083986, // Code user needs to input\nverification_uri:<a href=\"https://id6.azurewebsites.net/device\">https://id6.azurewebsites.net/device</a>, // Link user should enter manually, if cant scan QR\nverification_uri_complete:<a href=\"https://id6.azurewebsites.net/device?userCode=888083986\">https://id6.azurewebsites.net/device?userCode=888083986</a>, // Can be used for QR Code\nexpires_in:300, // When device code expires\ninterval:1 // How fast client can poll in seconds\n}</p>\n<p>URI: POST <a href=\"https://id6.azurewebsites.net/connect/token\">https://id6.azurewebsites.net/connect/token</a>\nBODY: client_id={clientId}&#x26;device_code={device_code}&#x26;grant_type=urn%3Aietf%3Aparams%3Aoauth%3Agrant-type%3Adevice_code\nRESPONSE: {error:authorization_pending} // User hasnt authenticated yet</p>\n<p>URI: POST <a href=\"https://id6.azurewebsites.net/connect/token\">https://id6.azurewebsites.net/connect/token</a>\nBODY: client_id={clientId}&#x26;device_code={device_code}&#x26;grant_type=urn%3Aietf%3Aparams%3Aoauth%3Agrant-type%3Adevice_code\nRESPONSE: {error:slow_down} // Exceding poll rate limit</p>\n<p>URI: POST <a href=\"https://id6.azurewebsites.net/connect/token\">https://id6.azurewebsites.net/connect/token</a>\nBODY: client_id={clientId}&#x26;device_code={device_code}&#x26;grant_type=urn%3Aietf%3Aparams%3Aoauth%3Agrant-type%3Adevice_code\nRESPONSE: {id_token:eyJhbGciOiJSUz...,access_token:eyJhbGciOiJS....,expires_in:3600,token_type:Bearer,refresh_token:bm9_....,scope:openid profile offline_access} // Successfull</p>\n<p><a name=Wep6P></a></p>\n<h1>准备工作</h1>\n<p><a name=H80Ro></a></p>\n<h2>配置重定向 URI</h2>\n<p>为了更多地使用最新部署的 Okteto 版本的 IdentityServer，在开发 k8ss login --idp=id6 时，决定使用 Okteto 的应用端点。另外，看过前面我写的集成 Azure AD 登录的相关文章的同学会记得，我在自己的 Azure 门户里，创建了一个名为 Keycloak 的应用。一开始集成了部署在 Azure 上的 <a href=\"https://id6.azurewebsites.net\">https://id6.azurewebsites.net</a> ，于是在 Keycloak 这个应用下的“身份验证”栏下的重定向 URI 里配置了 <a href=\"https://id6.azurewebsites.net/signin-add\">https://id6.azurewebsites.net/signin-add</a> 。</p>\n<p>今天，要让 k8ss login --idp=id6  对接 Okteto 应用端点，为了到时候能在 Okteto 上的 IdentityServer 应用采用 Azure AD 登录，需要再次利用这个名为 Keycloak 的 Azure 应用，在其重定向 URI 里，添加上 Okteto 应用端点的地址，即： <a href=\"https://id6-jeff-tian.cloud.okteto.net/signin-aad\">https://id6-jeff-tian.cloud.okteto.net/signin-aad</a> 。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b73d9074c916eb36d712382746852a05/d85e3/1672045038309-367251e7-c49d-43a4-930e-cb2591f0cf0c.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.08108108108109%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAACJUlEQVR42lWSy07bQBSGsy44QAix48tcPPb4kpjgXBCCthKv0E1XfQAWBdRSGkioirrgsb/KTimw+HT+M5r5dS7Tubm54Xa55OLigvVqxdPTE4+Pv1mv7lmvVy0P6/VGr1b8elhzd7fk8vIrV1dXXF9f8+37N+5vf/Bn+ZNObxgQJ5Yk1mgl6O/32NvdYXen+wrnre46dJ0tnK13ONsNWzjONr3eHp1yXJGlBtMYakWWWUQUEIU+4pkofEWACINWSymQUiKFaM+kiOiMR0Ur3MEBge8xnU4pyhIVG5RJUXGKlAohJUJIlNbEsUEqjTK2JQhC/KFHGPh0DusjqlGJVpIoCpmWivNFzvHEsqhL5lXKvBTMiohpFlDbgEniUekDqniDCFyGz4bzxYzFfEaaGLRU2MhlVsbUhabOJOPYJ9cuufbIlUsS7qNcBz3cQXtdtL9HFPgvFTYzbMwGB338cMB4VnB2fsLJ+wXVtCQpNSJSyP9olIiRQre5inMiofA9d2NYVBU2MQw9FyF9RtOScmwZzTXlkcHYCBm+oCLRopt5RoJY6XZU/vCfYTU5JLNpaxhrzfHshKoumHyMyW2GTRJsmrR3mhgGQwJ/iO977RKbVpu8oTWs65qyyOj395FhyOnpIWefLFmeYJqNatUu7Dk2P6J57A0GeO5bmqI6o2pMNR5htMSWMxZfPjP5UGNNRpFvyDP7JjaVJiYmMWZDYto8TRL+AuEvRFLALJjnAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/b73d9074c916eb36d712382746852a05/fcda8/1672045038309-367251e7-c49d-43a4-930e-cb2591f0cf0c.png\"\n        srcset=\"/static/b73d9074c916eb36d712382746852a05/12f09/1672045038309-367251e7-c49d-43a4-930e-cb2591f0cf0c.png 148w,\n/static/b73d9074c916eb36d712382746852a05/e4a3f/1672045038309-367251e7-c49d-43a4-930e-cb2591f0cf0c.png 295w,\n/static/b73d9074c916eb36d712382746852a05/fcda8/1672045038309-367251e7-c49d-43a4-930e-cb2591f0cf0c.png 590w,\n/static/b73d9074c916eb36d712382746852a05/efc66/1672045038309-367251e7-c49d-43a4-930e-cb2591f0cf0c.png 885w,\n/static/b73d9074c916eb36d712382746852a05/c83ae/1672045038309-367251e7-c49d-43a4-930e-cb2591f0cf0c.png 1180w,\n/static/b73d9074c916eb36d712382746852a05/d85e3/1672045038309-367251e7-c49d-43a4-930e-cb2591f0cf0c.png 2974w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>不做这一步的话，直接使用 Azure AD 登录，由于回调地址不对，会被 Azure AD 拦截：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.35135135135135%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB1ElEQVR42oWS247aMBRF+f9/6kM1RSpD2ikkThzH5ALk5oSZEsIl4bIqwrR9GWksLe0nL22f41GVrsmicCCNQ/JlMmCKnGa3p90f6PqeU9d9Qs/heGRUBy4b5VL7glq5VNqjUILGlBz3Nfv9K22753a78dnpzz0jIx2MOx8oPZvSF2TSYVeVRMuI8fiJy+X679Jd/BGDsO8YGc/GiBlG/KK8S6Ug9RwaU5BlGUII0iwlSZIhP2r6X9gzugtK1x5khWtT+C6pFLzlOZf+yqE9sn1raJs9u21Lf7pwOh/YdjW/jzW7/pUbjxd094a575FLdyC740vWnsQUCclG8d3+yrN4wol+YHljLHfMRH/B8r4xdcaI+IW8WtOdOs73GWZKkSqf1PcfGSiW0qcqU1abkHlgIcIXZmo68CInOIufuFIgfQ8V+MRxPDQchOtAswoCVipgeSfQRFLxampqs8GZC5bxisDXKD9AqwXRIkYHGsd2kJ7EcRxMaR5LWeqQJAiJg8U7IdrXbKoNeZ4xmUyYzWdYlsV0+oxwBbZtD8tyXXfI2WxG0zSPhrGOCXXMQkdoHQ8oFVKWNW3bUhQFVVVhjGG73XK9Xjmfz1wul2G7f/PxDzv+ABXL5e/c750iAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/95132644b9d3a7f295c2409716a2ad8f/fcda8/1672045725655-3ea0e36e-cd24-4a36-9bd4-3a306fde5be2.png\"\n        srcset=\"/static/95132644b9d3a7f295c2409716a2ad8f/12f09/1672045725655-3ea0e36e-cd24-4a36-9bd4-3a306fde5be2.png 148w,\n/static/95132644b9d3a7f295c2409716a2ad8f/e4a3f/1672045725655-3ea0e36e-cd24-4a36-9bd4-3a306fde5be2.png 295w,\n/static/95132644b9d3a7f295c2409716a2ad8f/fcda8/1672045725655-3ea0e36e-cd24-4a36-9bd4-3a306fde5be2.png 590w,\n/static/95132644b9d3a7f295c2409716a2ad8f/efc66/1672045725655-3ea0e36e-cd24-4a36-9bd4-3a306fde5be2.png 885w,\n/static/95132644b9d3a7f295c2409716a2ad8f/c83ae/1672045725655-3ea0e36e-cd24-4a36-9bd4-3a306fde5be2.png 1180w,\n/static/95132644b9d3a7f295c2409716a2ad8f/89557/1672045725655-3ea0e36e-cd24-4a36-9bd4-3a306fde5be2.png 1928w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n<a name=GMkYZ></a></p>\n<h2>设置 https</h2>\n<p>注意以上登录碰到问题的界面。在配置完重定向 URI 后，仍然遇到错误界面说实际重定向的地址，和已经配置的列表不匹配。仔细观察会发现，我们配置的是 https，但实际正在定向的地址，却是 http 的。通过打开自发现端点：<a href=\"https://id6-jeff-tian.cloud.okteto.net/.well-known/openid-configuration\">https://id6-jeff-tian.cloud.okteto.net/.well-known/openid-configuration</a>，观察到一个奇怪的现象，果然给出的所有端点地址都是 http 的：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.02702702702703%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAABiUlEQVR42oXObW/TMBQF4P7/H8Q3JKTRwtZ2azRS0jh1nNhpHMd5bd7saycTo4gNJDg6n6706NzVNClZZDRJU56XVV3VdVU3ddNWddO0134Yf3YcJ63hj65+XKEd9TAoZYw1YAGsMTMYq8EoBVqbSQEYs/yV1aSmqmh5eybdB96goo3rnsprJNuwnwpjFZgR7KTNMOnrqK9g1G+slPI8z3XdU7A/s3UkPgf8E0o3KF0HfHPmX1C68S93ROx5faq6RMHwDjPGfOQjFKZZeKk+xnJL8qdIPpF8h7N7InZh9hDlj1kTvJU3nCQJISHG54Rx0dyxckMLJymPtHiO5YEV36h0YnnAYlv36bIs82LnZb7hIAgcx3Fd93g8nvxnHD1ScR/JdZTvQ7F73f8aii0WD7E85A1uh0xBf8OUUs/zMMYIIc/zachKLoZOKt1pMyroFfQTdAr6Ubejbu1s5vnXMiERQgHGmBBCGb1Q1hSV6eH1tX9lBRq4pCH7Xpal1tpaCwDWmtna5X95AXEZMAAcldHSAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/4a008148449a66d44dee93fead80a54a/fcda8/1672105452054-3a5f0b58-17ff-4677-b091-01eb75badbae.png\"\n        srcset=\"/static/4a008148449a66d44dee93fead80a54a/12f09/1672105452054-3a5f0b58-17ff-4677-b091-01eb75badbae.png 148w,\n/static/4a008148449a66d44dee93fead80a54a/e4a3f/1672105452054-3a5f0b58-17ff-4677-b091-01eb75badbae.png 295w,\n/static/4a008148449a66d44dee93fead80a54a/fcda8/1672105452054-3a5f0b58-17ff-4677-b091-01eb75badbae.png 590w,\n/static/4a008148449a66d44dee93fead80a54a/efc66/1672105452054-3a5f0b58-17ff-4677-b091-01eb75badbae.png 885w,\n/static/4a008148449a66d44dee93fead80a54a/c83ae/1672105452054-3a5f0b58-17ff-4677-b091-01eb75badbae.png 1180w,\n/static/4a008148449a66d44dee93fead80a54a/a3c4c/1672105452054-3a5f0b58-17ff-4677-b091-01eb75badbae.png 2196w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>大概可以猜测虽然从外部视角看，我们使用了 https 去访问应用，但是 ingress 将流量转发到内部 pod 时，却卸载掉了 https：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6093f5cb144cf68152ad12e93b72b258/5df6d/1672105947652-2fb18473-8943-4852-a325-a502844c9335.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.16216216216216%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsTAAALEwEAmpwYAAABT0lEQVR42mWQS04bQRRFe2WQBRBWEiXbYIIyiZD4jDxCLIFRkDLKwA6W/G3b3f6BU66Pq15X1XuvOu5gMoJIZ3iPdO/NEppm7/fJpajfolLU7H8TrLh6IrcgWKLpB9nm6jnhIZ9ZtfrxcJ8PH1M078wUDbmSYUV2Ru5gghw7OfKyTbDkILJiNj79eHJ9dYFe1lFx1DWahLuEGm0RVYdhgm5pRE524vXImxxtTjAnV2Zfz88+HB99+fyp/fN7wyLs5ma7IFhHPYiqu9sO3XbIbmREIZ5ytiM0veQ3ZAu00+zutnVz+e3utjUe/GpqIC8RBFcbdGWQHSsHlRpGM7CyIDsNZuzNhF2ZgjjI+z03Td00/IchhcPUf7VrdFw9R91lKAhWYTdH0wM1ATWLuot2Sm6RRRDebiIIDur/twnW5MpXCnILNP2ou1St2W9f3v4LADR9ahRWNzwAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"1672105947652 2fb18473 8943 4852 a325 a502844c9335\"\n        title=\"1672105947652 2fb18473 8943 4852 a325 a502844c9335\"\n        src=\"/static/6093f5cb144cf68152ad12e93b72b258/1c72d/1672105947652-2fb18473-8943-4852-a325-a502844c9335.jpg\"\n        srcset=\"/static/6093f5cb144cf68152ad12e93b72b258/a80bd/1672105947652-2fb18473-8943-4852-a325-a502844c9335.jpg 148w,\n/static/6093f5cb144cf68152ad12e93b72b258/1c91a/1672105947652-2fb18473-8943-4852-a325-a502844c9335.jpg 295w,\n/static/6093f5cb144cf68152ad12e93b72b258/1c72d/1672105947652-2fb18473-8943-4852-a325-a502844c9335.jpg 590w,\n/static/6093f5cb144cf68152ad12e93b72b258/a8a14/1672105947652-2fb18473-8943-4852-a325-a502844c9335.jpg 885w,\n/static/6093f5cb144cf68152ad12e93b72b258/fbd2c/1672105947652-2fb18473-8943-4852-a325-a502844c9335.jpg 1180w,\n/static/6093f5cb144cf68152ad12e93b72b258/5df6d/1672105947652-2fb18473-8943-4852-a325-a502844c9335.jpg 1482w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>我们希望在 pod 中的服务，能够感知到这个 https 协议。通过查看微软官方的 aspnet 托管方面的文档（<a href=\"https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/proxy-load-balancer?source=recommendations&#x26;view=aspnetcore-6.0\">https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/proxy-load-balancer?source=recommendations&#x26;view=aspnetcore-6.0</a>），找到了解决方案：开启转发头，通过转发头中间件，让 aspnet 使用转发头来设置 http 上下文。</p>\n<p>首先，我给应用添加了一个显示所有请求头的路由：</p>\n<p>csharp\napp.MapGet(/all-headers, context =>\n{\nvar requestHeaders = context.Request.Headers.ToDictionary&#x3C;KeyValuePair&#x3C;string, StringValues>, string, string>(header => header.Key, header => header.Value);</p>\n<pre><code>        return context.Response.WriteAsJsonAsync(requestHeaders);\n    });\n</code></pre>\n<p>可以看到几个 X-Forwarded-XXX 的请求头：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ae76dafc6f55c0916040044b25496702/a88f6/1672106880887-dc212a10-939b-4a02-9c32-a0e23948a60e.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 72.2972972972973%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABYlAAAWJQFJUiTwAAACI0lEQVR42pWSCY7TQBBFc/8LcQAEiEEMZDRSEjuJ48RJnM1Le+nN7YfcDiMGCQZa+qpeqr5cfjXR2iCqmvR84ZCeyPKCLM8pypJSVLRSIZVGKvUHvX6bSCkpRE1WCK5ZiVQGbTqkNLRSIwcpQ1VLnOt5a02U0gxfaYzF9RZtJco0aNOOsq0/S1Ojh3s7Spl6zLMNUouXOGlaQZTMOGdb0nLOVWyo5Y1KXryEvNDq0idLU73I3933jcp9rFXGRGtFHG/YxGuO5w2XcsOtjjkVIcd8TlYn9wLh9dO8bE9U8urfhrvBbDCdGGNYrVbM5wueps/s9wnpLeKcR5zKJVV79cVDgWjPGKtwvaNzFjeo717JG4ZhyGw243DYs0sDgvgrx9uSojmSNweK5uBNO2fehqK1Jkl2LBZzdklMXqWcRcAhm1GIFGs0nbV01oAbi2QvqF1G25ce5LD6vvfyhqvlli8PUz59fGS/O3OrthRNSiy/EbYfeKrf8dS8Y6Hes7VT0i7g2sVkXYLtFfS/GYbBhofPUx4fnwmCNVV78zC27jupC1HUODos2se/tmy0IdnviKKIvEy5iIi8Pnh6znQ4a5FK+FEa5nCIwwwO41SrYbyGc+WB2c6MUJJk7w2DRcAu2ZFViQcyjIOn5+xIte/u0Y2EXXcnPVL3LY+GCUEQsAxX3PITVxHRKuET/nf5f3g8HlmtV0TRhrK6chFr39av9P5VPwAb8jTriGr+xAAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/ae76dafc6f55c0916040044b25496702/fcda8/1672106880887-dc212a10-939b-4a02-9c32-a0e23948a60e.png\"\n        srcset=\"/static/ae76dafc6f55c0916040044b25496702/12f09/1672106880887-dc212a10-939b-4a02-9c32-a0e23948a60e.png 148w,\n/static/ae76dafc6f55c0916040044b25496702/e4a3f/1672106880887-dc212a10-939b-4a02-9c32-a0e23948a60e.png 295w,\n/static/ae76dafc6f55c0916040044b25496702/fcda8/1672106880887-dc212a10-939b-4a02-9c32-a0e23948a60e.png 590w,\n/static/ae76dafc6f55c0916040044b25496702/efc66/1672106880887-dc212a10-939b-4a02-9c32-a0e23948a60e.png 885w,\n/static/ae76dafc6f55c0916040044b25496702/c83ae/1672106880887-dc212a10-939b-4a02-9c32-a0e23948a60e.png 1180w,\n/static/ae76dafc6f55c0916040044b25496702/a88f6/1672106880887-dc212a10-939b-4a02-9c32-a0e23948a60e.png 1900w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>其中转发头中间件需要的 3 个是：</p>\n<ul>\n<li><strong>X-Forwarded-For</strong>： 它保存了发起请求和后续代理中转的所有客户端，比如 IP 地址、端口号等等。在上面的截图中，只有一个 IP 地址，对应的是发起请求的客户端 IP；如果在集群里启用了 envoy，这里的值会是原始客户端 IP 后面跟着一个 envoy 的 IP 地址，并以逗号分隔。</li>\n<li><strong>X-Forwarded-Proto</strong>：原始请求协议值，比如 https。</li>\n<li><strong>X-Forwarded-Host</strong>：原始主机头的值。</li>\n</ul>\n<p>开启转发头的代码改动如下：\ncsharp\nbuilder.Services.Configure<ForwardedHeadersOptions>(options =>\n{\noptions.ForwardedHeaders = Microsoft.AspNetCore.HttpOverrides.ForwardedHeaders.XForwardedFor | Microsoft.AspNetCore.HttpOverrides.ForwardedHeaders.XForwardedProto;\n});\n...</p>\n<pre><code>internal static WebApplication ConfigurePipeline(this WebApplication app)\n{\n    app.UseForwardedHeaders();\n    ...\n</code></pre>\n<p>在应用这些改动后，再次访问自发现端点，发现没有效果。这一块儿还没弄太懂，为了保证让自发现端点给出的 url，是 https 的，还是通过参考微软的文档，强行设置了一下：</p>\n<p>csharp\napp.Use((context, next) =>\n{\ncontext.Request.Scheme = https;\nreturn next(context);\n});</p>\n<p>这时，再访问自发现端点，发现一切都是 https 了：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40.54054054054054%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABfUlEQVR42nWRiY7aMBRF+f+/ajtdNKjTYTpUIcTZgIRsBCjxku1U9lRUVVVLR/fJ1rt+y0JrQ9WcSHYHDnlBWdXUTUNzamnaP9w6SScVnXxTpTVKm39YSKVcIJXmphTjiMP0I8Mwu7jvJ6QyaNOjrOqe/52FNprr+UrTZezlM3UX0d4yLvJIeztwuu05dznDZJjmgXHqGaeBYTSOflBM0+jM5nlmYYwhDCPCOCDK1ojdC1mzIa1XJNUTcflEUj2zq1/Y1d9Jq2f3lrUe2emH+9wa3w3tDOM4xvM8Aj8kK1LSauUSk9/JSfWNuPzqiMql0/IiUObnvVVrdq8wCALW6zWv61eCbcjx7BNXS6Ji6cxspeL4mbB4dIjjF/zsg3vvB/33DK1hFEXOcLPx8H0fEXuI/YrIVfTINv+Inz8Q5J/YZO9dvM0f8A7vyNuNm/VVlvSjti1r0jRFCEGSJM5ciJB9uudUlFw6y5GLLFySXZDF3lm1S7vKys1xmkd+AQ+NWZ3dtJ0TAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/4903b60521fb3bf1f93b209b5a08a211/fcda8/1672111332122-e9deeed7-182e-458b-9b16-d59ec12f9541.png\"\n        srcset=\"/static/4903b60521fb3bf1f93b209b5a08a211/12f09/1672111332122-e9deeed7-182e-458b-9b16-d59ec12f9541.png 148w,\n/static/4903b60521fb3bf1f93b209b5a08a211/e4a3f/1672111332122-e9deeed7-182e-458b-9b16-d59ec12f9541.png 295w,\n/static/4903b60521fb3bf1f93b209b5a08a211/fcda8/1672111332122-e9deeed7-182e-458b-9b16-d59ec12f9541.png 590w,\n/static/4903b60521fb3bf1f93b209b5a08a211/efc66/1672111332122-e9deeed7-182e-458b-9b16-d59ec12f9541.png 885w,\n/static/4903b60521fb3bf1f93b209b5a08a211/c83ae/1672111332122-e9deeed7-182e-458b-9b16-d59ec12f9541.png 1180w,\n/static/4903b60521fb3bf1f93b209b5a08a211/1fa90/1672111332122-e9deeed7-182e-458b-9b16-d59ec12f9541.png 2118w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n<a name=c0POt></a></p>\n<h1>k8ss 代码改动</h1>\n<p>做好了上述的准备工作，现在可以开始给 k8ss 增加通过 IdentityServer 登录的代码了。完整的代码改动提交见： <a href=\"https://github.com/Jeff-Tian/k8ss/commit/f9c4f46c8aa999f7fe04b712da8836a49a512471\">https://github.com/Jeff-Tian/k8ss/commit/f9c4f46c8aa999f7fe04b712da8836a49a512471</a>。\n<a name=jFPd6></a></p>\n<h1>效果演示</h1>\n<p>csharp\nnpm i -g k8ss\nk8ss login --idp=id6</p>\n<p>其典型的输出如下：</p>\n<p>shell\ngetting user code and device code...\ncodes =  {\ndevice_code: B28BD0BF011D2DB6C416DFE14F0766DB5F8AE4EFA83A0C45B3D8B182370EEE85,\nuser_code: 122811764,\nverification_uri: <a href=\"https://id6-jeff-tian.cloud.okteto.net/device\">https://id6-jeff-tian.cloud.okteto.net/device</a>,\nverification_uri_complete: <a href=\"https://id6-jeff-tian.cloud.okteto.net/device?userCode=122811764\">https://id6-jeff-tian.cloud.okteto.net/device?userCode=122811764</a>,\nexpires_in: 300,\ninterval: 5\n}\n请打开浏览器并浏览至：  <a href=\"https://id6-jeff-tian.cloud.okteto.net/device\">https://id6-jeff-tian.cloud.okteto.net/device</a>  , 然后在打开的页面中输入  122811764\n▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄\n█ ▄▄▄▄▄ █▄▄▄ ▀ ▀█▄  ▀█▀ █ █ ▄▄▄▄▄ █\n█ █   █ ██▄▀ █   ▄▀█ ▀ ▄█▀█ █   █ █\n█ █▄▄▄█ ██▀▄ ▄███▀ ▄▄█▀█▀██ █▄▄▄█ █\n█▄▄▄▄▄▄▄█ ▀▄█ ▀▄▀▄█▄█▄█ █▄█▄▄▄▄▄▄▄█\n█▄ ▀▄ █▄▀█▄▀█▄██ ▀ ▄ ▄▀▀▀██▄▀▀█▀▀▄█\n█▀ ▀▄▀ ▄▀▀▄██▄▄▀ ▀▀██▀██▄█▄   ▀▀▄▄█\n██▀ █▄█▄▄█  █▀▀▄ ███▄▄█▀▀▄ ▄ ███▄▄█\n██▄▀█ █▄▄██▀█▀█ ▄▀██▄█▄▀█▄▀ ▀ █▀█▀█\n█▄▄▀▄▄█▄█ ▄  ▄▄   ▀█▀ █ █▄    ▄█  █\n█▀▄█▄ ▀▄▄▄▀█▀▄ ▀▄▀█▄▄█▄▀ ▀▀ ▄▀█▀▀ █\n█▀▄█▀▀▄▄█▀▄▀▄▀ ▀▀▀▄▀▀▀██▀▄██ ▀▀█▀██\n█ █▄█▀▄▄ █▀█ ▀ █▄▄ ██ ▄ ▄▄▀█▀██▀▄▄█\n█▄▄▄▄▄█▄▄▀██▄▄ ▀  ██▄█▀██ ▄▄▄ ▄█ ██\n█ ▄▄▄▄▄ ██▀  ▄▄█▄▄▄ ▄▄██▄ █▄█   █▀█\n█ █   █ █  ▄▀▀▀  █ ▀▀ ▀▀ ▄ ▄▄▄▄▀█▄█\n█ █▄▄▄█ █▀▀▄▄▀█▀ ▀█▄▄▄████ ▀▄ ▄ ▀ █\n█▄▄▄▄▄▄▄█▄▄██▄▄▄█▄▄█████▄▄███▄▄████</p>\n<p>如果使用的 mac 电脑，其中打开浏览器的过程是自动完成的。在选择使用 Azure AD 登录之后，会看到授权页面：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c072e3a240c9e46e17ec7fc940912ac4/21de8/1672111789441-d6773415-fc51-4491-ac4f-10e4313c5073.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 64.86486486486486%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAABxklEQVR42o2SW0/bQBCF/YtbCdSiIvUGJdCWtAnEgFpRqb+m5YFLQt+atg7Gt3i9vqyT2FknB+0kFo6ISEc6OqOR5vPOjDX96BRfTr+j3mzh04GO/cYhqdE6xufDIzT1Exx//UbeaJ2g3tRRP9BnXtGstwVtbf0V3mzvYav2Hjt7+3i3+xFvd2b5du0D5a+3anj24iXWnm/iyfoGnj4iDZUYjUYYj8eQUmIwGKAoCqrleY7/DW0ymVAylhIXl1c4P79A5/oXLq/aaHc6aHeu8ePnGf4ZPdiOB6N3A6Nnwry1YFo25ZbtwLJdCJFCm06nBFTgIOD34soDcs45fMbQ9334PkMcx4iiGCwI4PX7SNP0/oUlUHmSJIiVqCFCGIZUi+aAMIxoBctC9StpZaLC8/pwXJe+6nkehsMh7VRBsiwjV1J1JbXjav8DoHq6ad7ixjRhGD2Ccx5So5QFeVVV0MLIZWGUSyRC0M5EmlK9PNqy8VYCWSjQ/fMXv7tdGl/tkc+PwlgAHob0S1WhjwKzXCJNB3R+BYnjZD6unKtYeN1KYJoV8FkA3/fhuh6EEA9GLNegtBLoODYsyyIgY2zhsstU7rcKvAN+uL08ZsymgQAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/c072e3a240c9e46e17ec7fc940912ac4/fcda8/1672111789441-d6773415-fc51-4491-ac4f-10e4313c5073.png\"\n        srcset=\"/static/c072e3a240c9e46e17ec7fc940912ac4/12f09/1672111789441-d6773415-fc51-4491-ac4f-10e4313c5073.png 148w,\n/static/c072e3a240c9e46e17ec7fc940912ac4/e4a3f/1672111789441-d6773415-fc51-4491-ac4f-10e4313c5073.png 295w,\n/static/c072e3a240c9e46e17ec7fc940912ac4/fcda8/1672111789441-d6773415-fc51-4491-ac4f-10e4313c5073.png 590w,\n/static/c072e3a240c9e46e17ec7fc940912ac4/efc66/1672111789441-d6773415-fc51-4491-ac4f-10e4313c5073.png 885w,\n/static/c072e3a240c9e46e17ec7fc940912ac4/c83ae/1672111789441-d6773415-fc51-4491-ac4f-10e4313c5073.png 1180w,\n/static/c072e3a240c9e46e17ec7fc940912ac4/21de8/1672111789441-d6773415-fc51-4491-ac4f-10e4313c5073.png 2436w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c159e837468d6160049e919671369417/161ec/1672111793987-a6181325-66dd-4bf9-8980-24a0d776e7cf.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 89.86486486486487%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAABYlAAAWJQFJUiTwAAACBUlEQVR42o2Ua27TQBSFs0lWgNgOf+EHCJCAVkJlBxWPUhV20ER1GseOnfEkdVrHrxnbH5pxneYFyUjH1+N75+jcx7hXFAWL+wcmQYgXCJzbEUODkYs79hm5Y0IRcRcvWKYZSZqSWLsfPYCmaYxhkdW4foDv+zjO0BLf3DgopViP27eMz6DXBZmntgd3D1VVhdba2n3ofCvCjtTzPPr9ASPXxfN8xp5HHMfkeU6WZQexRdiQZAoRSYQQiCginE5tuv9Stq1yR2FS1IRCEkURUs4s8bFro4YdYZxWjP3Apm5SdsdjtK5Wwf9DXdfrhG1blK5ZLlNbs7IsSZLEBj5q2CDY7voWYeu4W1ZcDxyGw6Gdv+t+35Kb4FWX63pVt+57V78dwizLmU6FraEQEf5kwlSYvbTW+qS0DTMx3buUcs8cNs1KQf2Ig53d2u+mPJ/bdAeDAWEYUJj5S1Oy7Bisz2ErkVJp8rJFYaCq41BWlKqyHJtzmNe4YYwvYsJZQiAfmMh7PBGzSDWZgrTcRVLAsmgvx0YNS12TqxbrCsx3M1KqavZDN+iq7gjbdM1WzmMmoz6B6xAGga1nEEzW78OB28KTwlQ1PP8Kz07hxZni7acz3n085f3nL7z5cMKt620M8D48KaSh0PDqT8PLS3h9pTi/+M23n5d8v7ji/McvIjk7+E806y/qVXBE6oNFUwAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/c159e837468d6160049e919671369417/fcda8/1672111793987-a6181325-66dd-4bf9-8980-24a0d776e7cf.png\"\n        srcset=\"/static/c159e837468d6160049e919671369417/12f09/1672111793987-a6181325-66dd-4bf9-8980-24a0d776e7cf.png 148w,\n/static/c159e837468d6160049e919671369417/e4a3f/1672111793987-a6181325-66dd-4bf9-8980-24a0d776e7cf.png 295w,\n/static/c159e837468d6160049e919671369417/fcda8/1672111793987-a6181325-66dd-4bf9-8980-24a0d776e7cf.png 590w,\n/static/c159e837468d6160049e919671369417/efc66/1672111793987-a6181325-66dd-4bf9-8980-24a0d776e7cf.png 885w,\n/static/c159e837468d6160049e919671369417/c83ae/1672111793987-a6181325-66dd-4bf9-8980-24a0d776e7cf.png 1180w,\n/static/c159e837468d6160049e919671369417/161ec/1672111793987-a6181325-66dd-4bf9-8980-24a0d776e7cf.png 1840w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><br />点击蓝色的允许按钮后，就会展示登录成功页面：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d52bc94374d44453270278398b037ae0/bcec6/1672111813491-2cd1628c-83ac-4425-ae97-2b45b840af9f.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 39.189189189189186%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABSklEQVR42q2Oa0vCUBzG903qlV1QgiJIRE3SzC4fsky3qfOSGlGmtmnWpygVmrZNt7kX1tQnzonFkN4EPfDj+d/PYVqPHYhSG9WbWwjFMgqlCvKlMoTCFYrlKkqVa9qrNUTcN0XUHyTqDbFFY+JumI3NIALhBELRBCKHp9iPnSASP0MgEoc/HEM4ekwh8V4oiuDBEbzbfqxv7WLNt4MVjxerHt8PTDKVBcsL4LN5cNlvZ/kc2EyOulPjMgLN03wOKS6DZJqjnF+yuHDB4J/F2LaNT9vGfD7HZDJBU5QgtdroPD3jrlbHy2uXDpL+YrGgOPFsNgPZd8M4Q0RkQJYH6PX7eJNldHs9yIMBLMuCYRgwTROGadKHSU4OEDn79Ifug84vx+MxdN2ArutQVRXaaARFUaAoKjRNg6aNMBy+Yzr9+P3gcvEvWt77AiQxImVU0z4NAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/d52bc94374d44453270278398b037ae0/fcda8/1672111813491-2cd1628c-83ac-4425-ae97-2b45b840af9f.png\"\n        srcset=\"/static/d52bc94374d44453270278398b037ae0/12f09/1672111813491-2cd1628c-83ac-4425-ae97-2b45b840af9f.png 148w,\n/static/d52bc94374d44453270278398b037ae0/e4a3f/1672111813491-2cd1628c-83ac-4425-ae97-2b45b840af9f.png 295w,\n/static/d52bc94374d44453270278398b037ae0/fcda8/1672111813491-2cd1628c-83ac-4425-ae97-2b45b840af9f.png 590w,\n/static/d52bc94374d44453270278398b037ae0/efc66/1672111813491-2cd1628c-83ac-4425-ae97-2b45b840af9f.png 885w,\n/static/d52bc94374d44453270278398b037ae0/c83ae/1672111813491-2cd1628c-83ac-4425-ae97-2b45b840af9f.png 1180w,\n/static/d52bc94374d44453270278398b037ae0/bcec6/1672111813491-2cd1628c-83ac-4425-ae97-2b45b840af9f.png 1834w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><br />同时在命令行会看到登录成功的反馈，并打印出用户的信息：\nshell</p>\n<p>等待输入授权码……\n开始查询登录结果……\n{ error: authorization_pending }  未得到用户已授权的响应。 等待 5 秒，再查……\n{ error: authorization_pending }  未得到用户已授权的响应。 等待 5 秒，再查……\n{ error: authorization_pending }  未得到用户已授权的响应。 等待 5 秒，再查……\n{ error: authorization_pending }  未得到用户已授权的响应。 等待 5 秒，再查……\n{ error: authorization_pending }  未得到用户已授权的响应。 等待 5 秒，再查……\n{ error: authorization_pending }  未得到用户已授权的响应。 等待 5 秒，再查……\n{ error: authorization_pending }  未得到用户已授权的响应。 等待 5 秒，再查……\n{ error: authorization_pending }  未得到用户已授权的响应。 等待 5 秒，再查……\n本次查询令牌的结果是：  {\nid_token: eyJhbGciOiJSUzI1NiIsImtpZCI6IjRFMjRCMDgzNzAxRDg0MzBBNTRFQjBDNDdDNTBGODdGIiwidHlwIjoiSldUIn0.eyJpc3MiOiJodHRwczovL2lkNi1qZWZmLXRpYW4uY2xvdWQub2t0ZXRvLm5ldCIsIm5iZiI6MTY3MjExMTgwMiwiaWF0IjoxNjcyMTExODAyLCJleHAiOjE2NzIxMTIxMDIsImF1ZCI6ImRldmljZSIsImFtciI6WyJleHRlcm5hbCJdLCJhdF9oYXNoIjoiOXJfa2ppZ29RaVBNWm9yUTZHQ2R2dyIsInNpZCI6IkU3NEMxMjNDNTI1RjAwODQ3MTM2QzU4MjNGMjdEN0QxIiwic3ViIjoiMzFDNUE1QkFDRTNDNDQzNjI2RkQ0RTYyOURERkQ3Mzc5Rjc3MTExQTVEQkM2MDVGRENFQ0MzODVCMTNDRDVDQiIsImF1dGhfdGltZSI6MTY3MjExMTc1MywiaWRwIjoiYWFkIn0.lyBGueJwdF7Dw4FxqBijxqOVJK5TPES630YaFiEwqhtH0HEtFAArnLIhPJ8WSxUUQp3SMUtCfbdXkBs6UfbFh_Ikd7yU3iUa9R-YefXFUL63oBNrmduvm_kPLck1eXJ_Cya37xfZaj7VvPZ_V5b9oik9QmjyUSD7RogznaZN6PqUHSMZ9aVokjfY41ofr9-vxT4T2lS2zI2GdZDSF3sO6CRZtWqM75kJVuvRPSSNlEZ2oSnIJHM-yvMlmLk1786m0Mrl3JTlv3_ZyU20UcUopsfW6p3sWSu9pp5eie__NzBPisrA5lX7bvVcDN5VtuCCpF3ioaJHIBxQvFK3wsJXfQ,\naccess_token: eyJhbGciOiJSUzI1NiIsImtpZCI6IjRFMjRCMDgzNzAxRDg0MzBBNTRFQjBDNDdDNTBGODdGIiwidHlwIjoiYXQrand0In0.eyJpc3MiOiJodHRwczovL2lkNi1qZWZmLXRpYW4uY2xvdWQub2t0ZXRvLm5ldCIsIm5iZiI6MTY3MjExMTc5NywiaWF0IjoxNjcyMTExNzk3LCJleHAiOjE2NzIxMTUzOTcsImF1ZCI6WyJ1cm46cmVzb3VyY2UxIiwidXJuOnJlc291cmNlMiJdLCJzY29wZSI6Im9wZW5pZCBwcm9maWxlIGVtYWlsIHJlc291cmNlMS5zY29wZTEgcmVzb3VyY2UyLnNjb3BlMSBvZmZsaW5lX2FjY2VzcyIsImFtciI6WyJleHRlcm5hbCJdLCJjbGllbnRfaWQiOiJkZXZpY2UiLCJzdWIiOiIzMUM1QTVCQUNFM0M0NDM2MjZGRDRFNjI5RERGRDczNzlGNzcxMTFBNURCQzYwNUZEQ0VDQzM4NUIxM0NENUNCIiwiYXV0aF90aW1lIjoxNjcyMTExNzUzLCJpZHAiOiJhYWQiLCJlbWFpbCI6IkplZmYuVGlhbkBvdXRsb29rLmNvbSIsIm5hbWUiOiLnlLAg5p2wIiwic2lkIjoiRTc0QzEyM0M1MjVGMDA4NDcxMzZDNTgyM0YyN0Q3RDEiLCJqdGkiOiJDRTg3MEFDRTBCQUMyQ0M0ODVCNTJDQjJERjg2QzREMCJ9.MUolNN7nmIaksY0jS4GPX7pC1_ngqTWMJ62_q4n-lKP1mi-1LkZyEZ2MsMcQ5-zKfenvJ5eyGPSJ5ofb_V5RYFCVCar6A2m1kRSOmA0Wodhwi_P6WO8rbujqKyHj9Urflo3xhnI7ZNMKCHIZq2cIIskFHgPqpQ-havf1EjzLYlKfKxtzfEE751sxGgxmtYklk3t0-2WWgT1oKAkz14tAqkCm3rHPB6ug9MVT-vfveR0nvONnzgyeYUrhJdCNOVvhNkI-f2eMK4Uzn-VcdEAQ6UmkjRCYqBPZIJnBIyP80UKoef4jVDY3Fj6XRWDqREuOL6ZvkhRoI3vTGC9d0yeh4g,\nexpires_in: 3600,\ntoken_type: Bearer,\nrefresh_token: A6B4B892ADDF829C4F1C099D0E9DCE9CA472CC30BE7180505500A6AA3FC32C13-1,\nscope: openid profile email resource1.scope1 resource2.scope1 offline_access\n}\n最终轮询结果是：  {\nid_token: eyJhbGciOiJSUzI1NiIsImtpZCI6IjRFMjRCMDgzNzAxRDg0MzBBNTRFQjBDNDdDNTBGODdGIiwidHlwIjoiSldUIn0.eyJpc3MiOiJodHRwczovL2lkNi1qZWZmLXRpYW4uY2xvdWQub2t0ZXRvLm5ldCIsIm5iZiI6MTY3MjExMTgwMiwiaWF0IjoxNjcyMTExODAyLCJleHAiOjE2NzIxMTIxMDIsImF1ZCI6ImRldmljZSIsImFtciI6WyJleHRlcm5hbCJdLCJhdF9oYXNoIjoiOXJfa2ppZ29RaVBNWm9yUTZHQ2R2dyIsInNpZCI6IkU3NEMxMjNDNTI1RjAwODQ3MTM2QzU4MjNGMjdEN0QxIiwic3ViIjoiMzFDNUE1QkFDRTNDNDQzNjI2RkQ0RTYyOURERkQ3Mzc5Rjc3MTExQTVEQkM2MDVGRENFQ0MzODVCMTNDRDVDQiIsImF1dGhfdGltZSI6MTY3MjExMTc1MywiaWRwIjoiYWFkIn0.lyBGueJwdF7Dw4FxqBijxqOVJK5TPES630YaFiEwqhtH0HEtFAArnLIhPJ8WSxUUQp3SMUtCfbdXkBs6UfbFh_Ikd7yU3iUa9R-YefXFUL63oBNrmduvm_kPLck1eXJ_Cya37xfZaj7VvPZ_V5b9oik9QmjyUSD7RogznaZN6PqUHSMZ9aVokjfY41ofr9-vxT4T2lS2zI2GdZDSF3sO6CRZtWqM75kJVuvRPSSNlEZ2oSnIJHM-yvMlmLk1786m0Mrl3JTlv3_ZyU20UcUopsfW6p3sWSu9pp5eie__NzBPisrA5lX7bvVcDN5VtuCCpF3ioaJHIBxQvFK3wsJXfQ,\naccess_token: eyJhbGciOiJSUzI1NiIsImtpZCI6IjRFMjRCMDgzNzAxRDg0MzBBNTRFQjBDNDdDNTBGODdGIiwidHlwIjoiYXQrand0In0.eyJpc3MiOiJodHRwczovL2lkNi1qZWZmLXRpYW4uY2xvdWQub2t0ZXRvLm5ldCIsIm5iZiI6MTY3MjExMTc5NywiaWF0IjoxNjcyMTExNzk3LCJleHAiOjE2NzIxMTUzOTcsImF1ZCI6WyJ1cm46cmVzb3VyY2UxIiwidXJuOnJlc291cmNlMiJdLCJzY29wZSI6Im9wZW5pZCBwcm9maWxlIGVtYWlsIHJlc291cmNlMS5zY29wZTEgcmVzb3VyY2UyLnNjb3BlMSBvZmZsaW5lX2FjY2VzcyIsImFtciI6WyJleHRlcm5hbCJdLCJjbGllbnRfaWQiOiJkZXZpY2UiLCJzdWIiOiIzMUM1QTVCQUNFM0M0NDM2MjZGRDRFNjI5RERGRDczNzlGNzcxMTFBNURCQzYwNUZEQ0VDQzM4NUIxM0NENUNCIiwiYXV0aF90aW1lIjoxNjcyMTExNzUzLCJpZHAiOiJhYWQiLCJlbWFpbCI6IkplZmYuVGlhbkBvdXRsb29rLmNvbSIsIm5hbWUiOiLnlLAg5p2wIiwic2lkIjoiRTc0QzEyM0M1MjVGMDA4NDcxMzZDNTgyM0YyN0Q3RDEiLCJqdGkiOiJDRTg3MEFDRTBCQUMyQ0M0ODVCNTJDQjJERjg2QzREMCJ9.MUolNN7nmIaksY0jS4GPX7pC1_ngqTWMJ62_q4n-lKP1mi-1LkZyEZ2MsMcQ5-zKfenvJ5eyGPSJ5ofb_V5RYFCVCar6A2m1kRSOmA0Wodhwi_P6WO8rbujqKyHj9Urflo3xhnI7ZNMKCHIZq2cIIskFHgPqpQ-havf1EjzLYlKfKxtzfEE751sxGgxmtYklk3t0-2WWgT1oKAkz14tAqkCm3rHPB6ug9MVT-vfveR0nvONnzgyeYUrhJdCNOVvhNkI-f2eMK4Uzn-VcdEAQ6UmkjRCYqBPZIJnBIyP80UKoef4jVDY3Fj6XRWDqREuOL6ZvkhRoI3vTGC9d0yeh4g,\nexpires_in: 3600,\ntoken_type: Bearer,\nrefresh_token: A6B4B892ADDF829C4F1C099D0E9DCE9CA472CC30BE7180505500A6AA3FC32C13-1,\nscope: openid profile email resource1.scope1 resource2.scope1 offline_access\n}\n登录成功！\n✨  Done in 71.11s.</p>\n<p><a name=ySmqs></a></p>\n<h1>参考资料</h1>\n<ul>\n<li><a href=\"https://tools.ietf.org/html/rfc8628\">https://tools.ietf.org/html/rfc8628</a></li>\n<li><a href=\"https://darutk.medium.com/illustrated-device-flow-rfc-8628-d23d6d311acc\">https://darutk.medium.com/illustrated-device-flow-rfc-8628-d23d6d311acc</a></li>\n<li><a href=\"https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/proxy-load-balancer?source=recommendations&#x26;view=aspnetcore-6.0\">https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/proxy-load-balancer?source=recommendations&#x26;view=aspnetcore-6.0</a></li>\n</ul>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}}}},"staticQueryHashes":[],"slicesMap":{}}