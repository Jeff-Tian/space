{"componentChunkName":"component---src-templates-post-js","path":"/posts/eqh3cw2t5iw4g15i/","result":{"data":{"sitePage":null},"pageContext":{"url":"posts/eqh3cw2t5iw4g15i","relativePath":"posts/eqh3cw2t5iw4g15i","frontmatter":{"title":"通过 Bean 的方式扩展 Spring 应用，使其同时支持多个授权服务颁发的令牌。","stackbit_url_path":"posts/eqh3cw2t5iw4g15i","date":"2023-05-01T04:50:13","excerpt":"","tags":[],"categories":[],"template":"post"},"html":"<p>我在 Authing.cn 中建立了一个 Brickverse 用户池：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/83fc2b5f6ca8dae21913d2e33624dd40/332b4/1682912636049-09d7f456-7aa0-44be-ba60-7fe89945c3ef.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.5945945945946%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABrElEQVR42p2Ry27TYBCF/bxsql4UShrjFvEUPABiidgi2LCFIrFBQt2QtqnjJI79+7/fPmQHEN1ypKNzNKPRzOgUR6clVVVxfn7ObDajLEsWi8XkT05OOD4+nvT07IxnT2dclXMuqwXz+YIX85dcXVZcXCx4XpZUR08o6pb/RsqZEBM5Q06w/vaZ4mF1x5frr9QPNdl7glIEY4ijt5YwasqEcXjUlIgpEWKcdERMedKP1y2FlJpt2yHEgFYaow1GCFzXoXc7hrpBr9fYusY0a3TX45RGSYUeJDmEafmIHzc1hZY9WmxQWj96Jz/6LUGMYDRsN9DtQUmwFqw51J1jqO8obu4dbz/1NE1D2/Y4F9DGk1Og3nnefBBs2xapLTZETMw4Y/CDQmlJs92x3uyIQL2qKb7/NLx+v2ffdez7AWM9SjtSCtw2jlfvdnS9oBdy6o3LrFRYIVg17XTEZrvH+Uh9v6KI0ZOjxbrwe8ChtJ18jAHS6A9Xa+1QxmEGhR8kGxHo5IHaw3L5QDEm5EMijqnF9JcpjfzT+4djyt6ThCBKSRgGvBCgDZvlLb8AzpabiIICD3oAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/83fc2b5f6ca8dae21913d2e33624dd40/fcda8/1682912636049-09d7f456-7aa0-44be-ba60-7fe89945c3ef.png\"\n        srcset=\"/static/83fc2b5f6ca8dae21913d2e33624dd40/12f09/1682912636049-09d7f456-7aa0-44be-ba60-7fe89945c3ef.png 148w,\n/static/83fc2b5f6ca8dae21913d2e33624dd40/e4a3f/1682912636049-09d7f456-7aa0-44be-ba60-7fe89945c3ef.png 295w,\n/static/83fc2b5f6ca8dae21913d2e33624dd40/fcda8/1682912636049-09d7f456-7aa0-44be-ba60-7fe89945c3ef.png 590w,\n/static/83fc2b5f6ca8dae21913d2e33624dd40/efc66/1682912636049-09d7f456-7aa0-44be-ba60-7fe89945c3ef.png 885w,\n/static/83fc2b5f6ca8dae21913d2e33624dd40/c83ae/1682912636049-09d7f456-7aa0-44be-ba60-7fe89945c3ef.png 1180w,\n/static/83fc2b5f6ca8dae21913d2e33624dd40/332b4/1682912636049-09d7f456-7aa0-44be-ba60-7fe89945c3ef.png 1826w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>在这个用户池下创建了两个应用，一个名为 brickverse，一个名为“哈德韦的个人小程序”。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cdf45ebcde472e48a506e4759c54ead3/869d7/1682912680821-cd53a02d-55de-4e51-b529-924d10299dc1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.64864864864865%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABvElEQVR42o2R227aUBBF/a8QU0FiSNuoH9KnfkA/pC99rkpViUQ0mIKxwTbG536xdzUH0mseeqQt2ePxOnvPREkyxXQ2w9VVjOFwiMlkgiRJMB6PEccxRqPRTw0GgyDqfX0zwmx6g7vba7yYXONV/AZ3ty8RFfsD9ocKUhlo49B1Pf7n/N5lrYMyGkIqRFV9BBcKUlkwLqGUwmJxj/mXr3DePw/r+7+Qv05U1hzaGFjnsctzHI8N7h+WWH5bQWkNxgWkVFBKgzHqtQFG0OcUpblH2VicBLD6vgcXAr7rYYwNEQhgrAuiZ4oX3F0A/zhMM4aikuCqx3pTgHMe5kgA53yAk3tr/eW9g+3PgYlHvSSqB4eHskRZ1XC+w26XQwgJ1go0ZYbHdIPH1RpC6rA07zucWo73797i83yOxWKJzTZHmm6QF2W4JKICbdn5HtuMgAI14ygOLPx8bBiUNlDKBIdSaXz6+AHbLEPTCrRMhMuoTk4jgjSnNgCzXR4iC2lRNRJCOjBBszQ4MR3GQDNsRAcu/fmbsmi5ARMGXdchStcbVHXzBzAsxXoY87QMB6ldiEyylyU9SelzD83wBwDd5bnhAuthAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/cdf45ebcde472e48a506e4759c54ead3/fcda8/1682912680821-cd53a02d-55de-4e51-b529-924d10299dc1.png\"\n        srcset=\"/static/cdf45ebcde472e48a506e4759c54ead3/12f09/1682912680821-cd53a02d-55de-4e51-b529-924d10299dc1.png 148w,\n/static/cdf45ebcde472e48a506e4759c54ead3/e4a3f/1682912680821-cd53a02d-55de-4e51-b529-924d10299dc1.png 295w,\n/static/cdf45ebcde472e48a506e4759c54ead3/fcda8/1682912680821-cd53a02d-55de-4e51-b529-924d10299dc1.png 590w,\n/static/cdf45ebcde472e48a506e4759c54ead3/efc66/1682912680821-cd53a02d-55de-4e51-b529-924d10299dc1.png 885w,\n/static/cdf45ebcde472e48a506e4759c54ead3/c83ae/1682912680821-cd53a02d-55de-4e51-b529-924d10299dc1.png 1180w,\n/static/cdf45ebcde472e48a506e4759c54ead3/869d7/1682912680821-cd53a02d-55de-4e51-b529-924d10299dc1.png 1477w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>第一个应用的访问链接是： <a href=\"https://brickverse.net%EF%BC%8C%E7%AC%AC%E4%BA%8C%E4%B8%AA%E5%BA%94%E7%94%A8%EF%BC%8C%E8%99%BD%E7%84%B6%E6%98%AF%E5%B0%8F%E7%A8%8B%E5%BA%8F%EF%BC%8C%E4%BD%86%E4%B9%9F%E6%8F%90%E4%BE%9B%E4%BA%86%E7%BD%91%E9%A1%B5%E8%AE%BF%E9%97%AE%E6%96%B9%E5%BC%8F%EF%BC%9A\">https://brickverse.net，第二个应用，虽然是小程序，但也提供了网页访问方式：</a> <a href=\"https://taro.jefftian.dev\">https://taro.jefftian.dev</a> 。</p>\n<p>之前也写了一个 user-service 服务以供 <a href=\"https://brickverse.net\">https://brickverse.net</a> 使用，通过 spring-security-oauth2 来保护这个服务，后来将它升级到了 spring-boot-starter-oauth2-resource-server，具体细节见：《<a href=\"https://zhuanlan.zhihu.com/p/623303771\">升级 spring-security-oauth2 到 spring-boot-starter-oauth2-resource-serve - Jeff Tian的文章 - 知乎 </a>》。这时，user-service 是资源服务，而 spring-security-oauth2 也好，spring-boot-starter-oauth2-resource-server 也好，都只是一个 Java 包，是一个具体的程序。要保护资源服务，还得需要一个授权服务，这个授权服务，我就使用 Authing.cn，具体来说，是我在 Authing.cn 上创建的 brickverse 应用。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a750839424a483082dab790f5c5975c5/f4357/1682914501941-3ea9d4fa-6384-4baf-9db3-b3da4b48973c.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 18.91891891891892%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAABT0lEQVR42gFEAbv+ABcXF4kXFxeMFxcXih4dGyViTQMA6rYELPvDAUL0vQJC47EJGv//MwDFl4YJ97q5Pf6/vUH1uLg7oX5/CAAAAAI6NjYENDQ0Bj8/Pws0NDQEACoqKv8pKSn/JSUk/x8eG2BzWggA67YDuPC5A//wuQP/8rsFa//0NwDYpZEq9ri6/+ywtP/4ubv3/9TRFPa7uAAAAAAAOjo6AKKiowA7OzwAACEhIaIhISGgHx8foh0dGi1eSgwA7rgDP/K6Al/1vQFe9r4EJP//NwDrs50N9Le4WdKeoGXztrdXz5+dCoJWVQAPDQ0RLS0tlUBAQKUrKyuXADg4OAA5OTkALy8vACAfHACSbwAA7LcDAO23AwDyuwIA978FAP//NQGvh3cAAAAACwAAACkAAAAQDxobCL2zswIVFhYfKysr7EZFRvc1NTXtTeF3eLCKM0kAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/a750839424a483082dab790f5c5975c5/fcda8/1682914501941-3ea9d4fa-6384-4baf-9db3-b3da4b48973c.png\"\n        srcset=\"/static/a750839424a483082dab790f5c5975c5/12f09/1682914501941-3ea9d4fa-6384-4baf-9db3-b3da4b48973c.png 148w,\n/static/a750839424a483082dab790f5c5975c5/e4a3f/1682914501941-3ea9d4fa-6384-4baf-9db3-b3da4b48973c.png 295w,\n/static/a750839424a483082dab790f5c5975c5/fcda8/1682914501941-3ea9d4fa-6384-4baf-9db3-b3da4b48973c.png 590w,\n/static/a750839424a483082dab790f5c5975c5/efc66/1682914501941-3ea9d4fa-6384-4baf-9db3-b3da4b48973c.png 885w,\n/static/a750839424a483082dab790f5c5975c5/c83ae/1682914501941-3ea9d4fa-6384-4baf-9db3-b3da4b48973c.png 1180w,\n/static/a750839424a483082dab790f5c5975c5/f4357/1682914501941-3ea9d4fa-6384-4baf-9db3-b3da4b48973c.png 3583w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><br />而这个服务需要配置授权服务器，我的配置如下：<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cc0b9c586f458aabe9f6dc8fb4e3b09f/bb3b7/1682914643026-c91520f2-5637-40d4-ba46-b6a9cb7b8eb9.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75.67567567567568%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAACaklEQVR42nWS2XLjNhBF+SOTWBYJEiQ2gqskiiK12Rp7KpXJ/3/LSRFWXLZn8nCq0UDhovuio/14YJ6PjIcDbdtS1zX7YWAcR7q2o26asN80DVVdh3yJpfdUVU3ddpzHnvN+5LSfierhic10Y3f8jt9ecMMPyt0L5fCC68+4zcIVu3mm3V/ZzTe6/RVTDxTlBu23Advs8f1E5PuZZrjQjzdcO1FuTpT9EdfNIdpmxNQjphnD2rWHcLnsDuyOr2ynW3io3V9YtCKhKoSu0dsB6TvivCRRFUlRhRgXC/4XElUjyx5ZbpC2Q9qWVNdE68ySJArtS/ymRcqKVCjS5ANf80QhFuIisEoKHhIViFLpqIWiqjxNXWGlxaQKnRRo8RH1CSMUSmiqe/6QGh5TQ5RJGza+SUvaNMTOs8pLHuRn/kwNfwj9iW/CIIRGCRXOH4V+E/RC8bhWFM6jK4/2G0y9mD+FDyn7E8ptyXVDYToK25PrliSzQUx/FIwzh5WGyjpsqkMrgdRghMakGptZnLQhvq1dyMOZKEiFfmt5EVxnjkdpyduGxHgSUxIrR6wssapZLy0vHi2XvrC6C63uYkuMYulYZ4ZEL+NyFyos69yEEQoPCh0M/y3L2V3svcK4cKhth/Q7ivZEXh0CRTOTlTukH8I8rhJ1F9LvQr8IhgqXnx46inaL2T6humOgaCayckvmNiGmtv//Sv8bm6XCh0ST+grVT+TNTN5MyGpEmP7u4QfvwgAv/png4Vei/XRmPj8zX585335wff2H6+tPLi8/uXz/m/PtL6bT0zvz+Ua/m0gyhZD6nURqMuX4F2yu0QhpjIzcAAAAAElFTkSuQmCC'); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/cc0b9c586f458aabe9f6dc8fb4e3b09f/fcda8/1682914643026-c91520f2-5637-40d4-ba46-b6a9cb7b8eb9.png\"\n        srcset=\"/static/cc0b9c586f458aabe9f6dc8fb4e3b09f/12f09/1682914643026-c91520f2-5637-40d4-ba46-b6a9cb7b8eb9.png 148w,\n/static/cc0b9c586f458aabe9f6dc8fb4e3b09f/e4a3f/1682914643026-c91520f2-5637-40d4-ba46-b6a9cb7b8eb9.png 295w,\n/static/cc0b9c586f458aabe9f6dc8fb4e3b09f/fcda8/1682914643026-c91520f2-5637-40d4-ba46-b6a9cb7b8eb9.png 590w,\n/static/cc0b9c586f458aabe9f6dc8fb4e3b09f/efc66/1682914643026-c91520f2-5637-40d4-ba46-b6a9cb7b8eb9.png 885w,\n/static/cc0b9c586f458aabe9f6dc8fb4e3b09f/c83ae/1682914643026-c91520f2-5637-40d4-ba46-b6a9cb7b8eb9.png 1180w,\n/static/cc0b9c586f458aabe9f6dc8fb4e3b09f/bb3b7/1682914643026-c91520f2-5637-40d4-ba46-b6a9cb7b8eb9.png 1211w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>今天，我想让我的个人小程序，同样可以使用这个 user-service。如果直接调用，哪怕是已经登录过了，接口也会回复 401。原因很简单，我的个人小程序，在登录时，连接的是 Authing.cn 中的另一个 app，即“哈德韦的个人小程序”。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4b6cee4094e903eda4fca0273a48f697/92338/1682914803870-20af6ff6-e945-4d61-834d-9103717c08e0.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 68.24324324324324%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB80lEQVR42n1TW24TQRCcE3IJbMmOANvEkMgcwB/8IHEC+Ai34ARIkfiIFESEFCIRErPx7kzPe6ZQz9rO+gEjlVrb211d3dMjJi+PcTydYjweYzgcYjAYFMvo9/vo9XoF7J9NjkrcyfQ5nr0Y4/ToDWavTzCZjDEajTA7fQVx9fULqsVvpJSQc8b/zvrvOkw7gz/VElISlnWD828EcX11iftFjVplGGNgrYN1HtY5OOdhrC2+liiviuZCnlPeCGFLNkM0UqGRFj4AMcYV0o6Nj+qZNOUNeRdcSNzd3YOUQs7pYFDBSh0ZBxPTRm3XFtUZENVDjbqRINJFUQhxD6yQac4+fMT7t3OQC1sj6ELU9QOUojKnQhhjB22BFCN0Bj69m2P+9Al+3PwshDy33SOuf0ksqgaKNLyPcD7swYdY2q5ub/D94hxK0067HcKzzxa3FbeQVuvwj9XZSW5b3G9bEClYYw/mH7qYvLWveU+AqKoKWusyD1t2zsJ7v3eLbHkvnXPgi3Yhw3fgfEaIGYIJOIeXWkq+bYIxGooilN4mbKRsl98FLGtC3WgsG4JU7MsIIUNwRU5hVayUE5iwfQGPM2VCKVXZhhA8NCkYTeCR8fd6BOWlsEqWzKrIsLIIbVMBmQTj2qfFhDHF0iLHcGyLVHw8w7/+GyXGG/WFqwAAAABJRU5ErkJggg=='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/4b6cee4094e903eda4fca0273a48f697/fcda8/1682914803870-20af6ff6-e945-4d61-834d-9103717c08e0.png\"\n        srcset=\"/static/4b6cee4094e903eda4fca0273a48f697/12f09/1682914803870-20af6ff6-e945-4d61-834d-9103717c08e0.png 148w,\n/static/4b6cee4094e903eda4fca0273a48f697/e4a3f/1682914803870-20af6ff6-e945-4d61-834d-9103717c08e0.png 295w,\n/static/4b6cee4094e903eda4fca0273a48f697/fcda8/1682914803870-20af6ff6-e945-4d61-834d-9103717c08e0.png 590w,\n/static/4b6cee4094e903eda4fca0273a48f697/efc66/1682914803870-20af6ff6-e945-4d61-834d-9103717c08e0.png 885w,\n/static/4b6cee4094e903eda4fca0273a48f697/c83ae/1682914803870-20af6ff6-e945-4d61-834d-9103717c08e0.png 1180w,\n/static/4b6cee4094e903eda4fca0273a48f697/92338/1682914803870-20af6ff6-e945-4d61-834d-9103717c08e0.png 1411w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>因此，需要扩展 user-service 的安全组件，能够支持 uniheart（我给“哈德韦的个人小程序”app 在 Authing.cn 中起的名字） 公钥端点的 jwt token，即通过某个字段（比如 Issuer）来判断是否是受支持的，是则尝试解开 token，否则直接报错就行。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/050b8b969bed105333c0094fa354cbe2/895f3/1682915335775-8b2b42de-9231-4846-b1f8-64c6dca70413.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.02702702702703%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAACxklEQVR42k2QXUhTcRjGn53/2ZzHeeY5W0c3ye2ss80pbOqcH80c1VxaCV4ENWuG1AqiD4USCqKuCrWrgrzsRuguAtE2PyAVggikpIggIhJFwpy1pA+xNyZBvvDjhefiB88Dp9M5rmnatKZpz1TVmc4XHTvpuSh8SbFrqyl2J5Nmlx8NVJuICN/GRuPfRp8MZsdSgz/SaR+tf8fgpUsMAJLJJCfLMuByuai8vJy8Xi/t2uUi5O300Rpn/jrOvV9Ls831KW7+xYMq+Z9wODMytpEdTW3QzEzrxtQkcrkoigV2u72E53kBiqJELRbLYavV2q4oSsxktumBw6CXMNMbyPQRYldHkAEcoxfPhRuJuP/ehXMeWlnlDzEDCgTBEggE5ltbW//4/f7lnBBWq3WLYkWBUGgDcAw0B9A7YHHEAM1XzfZH9vAAOAB6AMZhQFe3N8o7HI58h8PREwwGB1RVvQ673c62UyCWggj4PQ3d0ohBl9snHKrhOxqDhpVECD9PhpLZk3X1i8dr0RupMdbuiTC3241YLAaPxwPYbDbuv9DGRKk058CvaeDT4zwAhFttDQa62wJKhs9STxvR+ejyj0RtBVClu7IvqM85wuEwr6oqgyRJuVG3kGUJBWKu8j7QB4AywHJKj5sHGg001AY6Ez79p/cg0cXYUvZEjY+GqvC+s57D9pMkKVpUVNRuNpvbZVmOSZYSPVALWoGRfkIgQl5Lk58dbQoZ1rrD2OgKdm0mqqs+J+pBg3W6kMeV0xgACFtf0zTy+XxUUVFBbrdGnLGskl4JlkyaLWRSjLKT3NuHtxUZiDOa03R01Q+gUd/dVJ0fPRJnJpNJCgQCbyORCFVWVq5AVdUJTdNm3W73rKqqo9Dbi4mgX5/S9WUnuP7fT9FDC+D7Trmwo2w3iPrwurNxq6YgmiEWirzX673Q0NBwv7k50v8Xu+7wMZYKhi0AAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/050b8b969bed105333c0094fa354cbe2/fcda8/1682915335775-8b2b42de-9231-4846-b1f8-64c6dca70413.png\"\n        srcset=\"/static/050b8b969bed105333c0094fa354cbe2/12f09/1682915335775-8b2b42de-9231-4846-b1f8-64c6dca70413.png 148w,\n/static/050b8b969bed105333c0094fa354cbe2/e4a3f/1682915335775-8b2b42de-9231-4846-b1f8-64c6dca70413.png 295w,\n/static/050b8b969bed105333c0094fa354cbe2/fcda8/1682915335775-8b2b42de-9231-4846-b1f8-64c6dca70413.png 590w,\n/static/050b8b969bed105333c0094fa354cbe2/efc66/1682915335775-8b2b42de-9231-4846-b1f8-64c6dca70413.png 885w,\n/static/050b8b969bed105333c0094fa354cbe2/c83ae/1682915335775-8b2b42de-9231-4846-b1f8-64c6dca70413.png 1180w,\n/static/050b8b969bed105333c0094fa354cbe2/895f3/1682915335775-8b2b42de-9231-4846-b1f8-64c6dca70413.png 2158w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><a name=Nscef></a></p>\n<h1>测试先行</h1>\n<p>说干就干，先加两个测试，第一个测试表明无效的令牌调用不了接口，第二个测试使用一个 uniheart token 调用接口，期待通过（现在这个用例会失败，因为还没有实现）。</p>\n<p>java\n@Test\npublic void testGraphQLEndpointsWorksWithWrongTokenForPublicAPIs() throws Exception {\nvar exception = assertThrows(com.auth0.jwt.exceptions.JWTDecodeException.class, () -> mockMvc.perform(MockMvcRequestBuilders.post(/graphql).content(friendListQuery).header(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE).header(HttpHeaders.AUTHORIZATION, Bearer 123)).andExpect(MockMvcResultMatchers.status().isBadRequest()).andReturn());</p>\n<pre><code>    assertEquals(The token was expected to have 3 parts, but got 1., exception.getMessage());\n}\n\n@Test\npublic void testGraphQLEndpointsWorksWithUniheartToken() throws Exception {\n    var uniheartToken = eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6IkNGTDZUZXN0X2xYZ0RHN1drSkphRVE3azd0Q0dzSEdua2xscy1vT3FqeUEifQ.eyJ1cGRhdGVkX2F0IjoiMjAyMy0wNC0xOVQxODoxMDo0NS4xNTRaIiwiYWRkcmVzcyI6eyJjb3VudHJ5IjoiIiwicG9zdGFsX2NvZGUiOm51bGwsInJlZ2lvbiI6bnVsbCwiZm9ybWF0dGVkIjpudWxsfSwicGhvbmVfbnVtYmVyX3ZlcmlmaWVkIjp0cnVlLCJwaG9uZV9udW1iZXIiOiIxMzA2MTkxMDI3MyIsImxvY2FsZSI6InpoX0NOIiwiem9uZWluZm8iOm51bGwsImJpcnRoZGF0ZSI6bnVsbCwiZ2VuZGVyIjoiTSIsImVtYWlsX3ZlcmlmaWVkIjpmYWxzZSwiZW1haWwiOm51bGwsIndlYnNpdGUiOm51bGwsInBpY3R1cmUiOiJodHRwczovL3RoaXJkd3gucWxvZ28uY24vbW1vcGVuL3ZpXzMyL1g1TFE3b2tibjdqZFlMTFFmNGljaWJpYVNjMHljT01FZ29qNk5TRnVLVWJLSlcwcHVpYXpvYTI4NGZzVFBCSUdCTEhmT0tpYlcwN3h4Uk9GNHN1Q2Q1alBpYjF3LzEzMiIsInByb2ZpbGUiOm51bGwsInByZWZlcnJlZF91c2VybmFtZSI6bnVsbCwibmlja25hbWUiOiLlk4jlvrfpn6bwn5SlIiwibWlkZGxlX25hbWUiOm51bGwsImZhbWlseV9uYW1lIjpudWxsLCJnaXZlbl9uYW1lIjpudWxsLCJuYW1lIjpudWxsLCJzdWIiOiI2Mzg5ZDQ4MzFkYjE2ZTU0MWRjOTQzYTMiLCJleHRlcm5hbF9pZCI6bnVsbCwidW5pb25pZCI6Im8wcHFFNkppNVhCRVJ4YkQ5XzJmWUpGZ1FXc00iLCJ1c2VybmFtZSI6IuWTiOW-t-mfpvCflKUiLCJkYXRhIjp7InR5cGUiOiJ1c2VyIiwidXNlclBvb2xJZCI6IjYyMDA5N2I2OWE5ZGFiNWU5NjdkMGM0NCIsImFwcElkIjoiNjIwMDk3YjdmN2M5NjQyMTBiOGY3NDMxIiwiaWQiOiI2Mzg5ZDQ4MzFkYjE2ZTU0MWRjOTQzYTMiLCJ1c2VySWQiOiI2Mzg5ZDQ4MzFkYjE2ZTU0MWRjOTQzYTMiLCJfaWQiOiI2Mzg5ZDQ4MzFkYjE2ZTU0MWRjOTQzYTMiLCJwaG9uZSI6IjEzMDYxOTEwMjczIiwiZW1haWwiOm51bGwsInVzZXJuYW1lIjoi5ZOI5b636Z-m8J-UpSIsInVuaW9uaWQiOiJvMHBxRTZKaTVYQkVSeGJEOV8yZllKRmdRV3NNIiwib3BlbmlkIjoibzFwOUg0MG12dUJiN18zTFJFRXE0TlZXVVdnQSIsImNsaWVudElkIjoiNjIwMDk3YjY5YTlkYWI1ZTk2N2QwYzQ0In0sInVzZXJwb29sX2lkIjoiNjIwMDk3YjY5YTlkYWI1ZTk2N2QwYzQ0IiwiYXVkIjoiNjIwMDk3YjdmN2M5NjQyMTBiOGY3NDMxIiwiZXhwIjoxNjg0MDQ4OTc2LCJpYXQiOjE2ODI4MzkzNzYsImlzcyI6Imh0dHBzOi8vdW5paGVhcnQuYXV0aGluZy5jbi9vaWRjIn0.D_UyVFD89dNzBtAgx-M9fTJlMTGxq_95cVOBN8fsD_0eQxSltr0Pktd25IdPB09JxZQBIEFb9f-maQXOq7YH2agSMk6IoNtO69TR4LNl8cGuIbkbI35jl7SGig9moK55luKnY5QjOWlUUQcTb7C0fVvBkx7K9wmuF8sVukHg8t_ComRNrhFxtqQuLWeXJSLhbLxMQzEta0Ofsu9paPzP0HPpVGmzYsS2FvkF7z4laRiz0JpyC01hw3i70qfFfOPUsxWUuSqUw_juc7heqMEFrJz2hO3c8oVovnMp48v2i-LWN8yRMbTDhsUmd9Ny0wovGdMhNFtMZ3cOhwFPp1bK6A;\n\n    mockMvc.perform(MockMvcRequestBuilders.post(/graphql).content(friendListQuery).header(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE).header(HttpHeaders.AUTHORIZATION, Bearer  + uniheartToken)).andExpect(MockMvcResultMatchers.status().isOk());\n}\n</code></pre>\n<p>你可能会问，还应有一个测试，传入 brickverse token 时，接口可以调通。但是这个测试在之前添加 brickverse 应用时，就已经写了，我们只需要在稍后改完代码后，保证它仍然是通过的就行了。</p>\n<p>第二个测试中先使用了一个硬编码的 uniheart token，后续可以替换成一个活的。<br /><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/df77c72bc6591831c63fd9e6ec13bb9a/f3015/1682915771233-7a6456b0-3d35-49a0-bc4f-2f1e53d3f4d1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.16216216216216%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABxElEQVR42k2N32tScRjGz6Rc5nS4ESNsOFhr9LuBzfJHGiuKEWsUdFFXXRTUVSzazAV14RKDLPq7gm4WxQqi6TY9x3OO6Y4e5/l+P6GT6IGHz8P7vryPkktEyF9NsRZP8jYxRz41TzZ6g+yVBbKx22QvLpCdvcPa7D1ykQcU4g95H39MIfGUj9ElPiSek7+8RD7ygk+pVyiF5Bz58CXeRWO8Phdmeeo8L0+ESZ+OsXoqyepEnEwoRSZ0jUzoJunxeVaCt1gJLrIcvEv62H3eTD4id/IZmYknKNMz1zk6NcPxM2cZOjKG4jmMy+tlwOPhoN+POzCMe8SPe8TX44FhLy7fIVxDgwz4BnEHvIyGxpi8ME1gfBSlWqqw/UWl+LlMZV1H+2airpto303UryZ60aRmGtQMA32za5PqRtcG1Z81tA0TvayjqRpG1UBhD5xtECo4FXC6LIOzs5+7+39qATbIXRA1EH/6s/+kdBoCuyRp9d38JWlt7mf7t8SpSwQSp9lmb8ei9cOiXbToaBYdw0I0LGS7jZQSIQSKsyuxi2BvSeytPkv0SuqqxG7KXrOoNxAVHVE2ERUTofZZMZCNRu+m+/QvqaWcdH0gfdgAAAAASUVORK5CYII='); background-size: cover; display: block; transition: opacity 0.5s 0.5s; pointer-events: none;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"image.png\"\n        src=\"/static/df77c72bc6591831c63fd9e6ec13bb9a/fcda8/1682915771233-7a6456b0-3d35-49a0-bc4f-2f1e53d3f4d1.png\"\n        srcset=\"/static/df77c72bc6591831c63fd9e6ec13bb9a/12f09/1682915771233-7a6456b0-3d35-49a0-bc4f-2f1e53d3f4d1.png 148w,\n/static/df77c72bc6591831c63fd9e6ec13bb9a/e4a3f/1682915771233-7a6456b0-3d35-49a0-bc4f-2f1e53d3f4d1.png 295w,\n/static/df77c72bc6591831c63fd9e6ec13bb9a/fcda8/1682915771233-7a6456b0-3d35-49a0-bc4f-2f1e53d3f4d1.png 590w,\n/static/df77c72bc6591831c63fd9e6ec13bb9a/efc66/1682915771233-7a6456b0-3d35-49a0-bc4f-2f1e53d3f4d1.png 885w,\n/static/df77c72bc6591831c63fd9e6ec13bb9a/c83ae/1682915771233-7a6456b0-3d35-49a0-bc4f-2f1e53d3f4d1.png 1180w,\n/static/df77c72bc6591831c63fd9e6ec13bb9a/f3015/1682915771233-7a6456b0-3d35-49a0-bc4f-2f1e53d3f4d1.png 1804w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;opacity:0;transition:opacity 0.5s;color:inherit;box-shadow:inset 0px 0px 0px 400px white;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>要让这两个测试都通过，需要让安全组件能够针对 token 的 iss 做分支判断，不同的 iss，走不同的逻辑。最简单的想法，是给 spring-boot-starter-oauth2-resource-server 配置多个 jwk-set-uri，从而不写一行代码。遗憾的是，spring-boot-starter-oauth2-resource-server 并不支持这样做，只能自己写一点代码了。</p>\n<p><a name=DwoDI></a></p>\n<h1>添加自定义的 jwt decoder</h1>\n<p>首先添加一个新文件： src/main/java/com/brickpets/user/security/BrickverseUniHeartJwtDecoder.java：</p>\n<p>java\npackage com.brickpets.user.security;</p>\n<p>import com.auth0.jwt.JWT;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.security.oauth2.jwt.Jwt;\nimport org.springframework.security.oauth2.jwt.JwtDecoder;\nimport org.springframework.security.oauth2.jwt.JwtException;\nimport org.springframework.security.oauth2.jwt.NimbusJwtDecoderJwkSupport;</p>\n<p>public class BrickverseUniHeartJwtDecoder implements JwtDecoder {\n@Value(${spring.security.oauth2.resourceserver.jwt.jwk-set-uri})\nprivate String jwkSetUri;</p>\n<pre><code>@Override\npublic Jwt decode(String token) throws JwtException {\n    var jwt = JWT.decode(token);\n    String issuer = jwt.getIssuer();\n\n    if (https://brickverse.authing.cn/oidc.equals(issuer)) {\n        return new NimbusJwtDecoderJwkSupport(jwkSetUri).decode(token);\n    }\n\n    return new NimbusJwtDecoderJwkSupport(https://uniheart.authing.cn/oidc/.well-known/jwks.json).decode(token);\n}\n</code></pre>\n<p>}</p>\n<p>这里主要就是从 token 中取出 issuer，如果是 brickverse 来的，就直接调用之前的配置。如果不是，就当做 uniheart token 来尝试（目前先写死 uniheart 的 jwks url）。</p>\n<p><a name=oK3c2></a></p>\n<h1>使用 Bean 将自定义 jwt decoder 注入</h1>\n<p>接着改造一下之前的 src/main/java/com/brickpets/user/config/CustomWebSecurityConfigurerAdapter.java 文件，将新增的 jwt decoder 放进去：</p>\n<p>diff\npackage com.brickpets.user.config;</p>\n<p>import com.brickpets.user.filters.TokenRemover;</p>\n<ul>\n<li>import com.brickpets.user.security.BrickverseUniHeartJwtDecoder;</li>\n</ul>\n<p>import org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.security.config.annotation.web.builders.HttpSecurity;</p>\n<ul>\n<li>import org.springframework.security.config.annotation.web.configurers.oauth2.server.resource.OAuth2ResourceServerConfigurer;</li>\n</ul>\n<ul>\n<li>import org.springframework.security.oauth2.jwt.JwtDecoder;</li>\n</ul>\n<p>import org.springframework.security.web.SecurityFilterChain;\nimport org.springframework.security.web.authentication.preauth.AbstractPreAuthenticatedProcessingFilter;</p>\n<p>@Configuration\npublic class CustomWebSecurityConfigurerAdapter {</p>\n<ul>\n<li>@Bean</li>\n<li>public JwtDecoder jwtDecoder() {</li>\n<li>\n<pre><code>   return new BrickverseUniHeartJwtDecoder();\n</code></pre>\n</li>\n<li>}</li>\n</ul>\n<pre><code>@Bean\npublic SecurityFilterChain filterChain(HttpSecurity http) throws Exception {\n    http.authorizeRequests()\n            .antMatchers(/user/preference/**).authenticated()\n            .anyRequest().permitAll()\n            .and()\n            .csrf().disable()\n</code></pre>\n<ul>\n<li>\n<pre><code>           .oauth2ResourceServer(OAuth2ResourceServerConfigurer::jwt).addFilterBefore(new TokenRemover(), AbstractPreAuthenticatedProcessingFilter.class);\n</code></pre>\n</li>\n</ul>\n<ul>\n<li>\n<pre><code>           .addFilterBefore(new TokenRemover(), AbstractPreAuthenticatedProcessingFilter.class)\n</code></pre>\n</li>\n<li>\n<pre><code>           .oauth2ResourceServer().jwt().decoder(jwtDecoder())\n  ;\n\n\n  return http.build();\n</code></pre>\n</li>\n</ul>\n<p>以上就是通过 Bean 的方式将我们新加的 jwt decoder 注入到了应用中去。</p>\n<p>有了以上的改动，测试就全通过了。提供代码上线，现在 <a href=\"https://taro.jefftian.dev\">https://taro.jefftian.dev</a> 也可以使用 user-service 了！</p>","pages":[],"site":{"siteMetadata":{"title":"Jeff Tian","author":"@zizhujy","description":"A wild full stack developer","palette":"yellow","header":{"title":"Jeff Tian","tagline":"A wild developer","logo_img":"https://images.ctfassets.net/qixg1o8tujmf/7z1ua3nTOC5B7DwwzAki8I/4e1a05f8db770c285a492eeb1eaa398f/imageedit_3_2509022194.png","background_img":"https://images.ctfassets.net/qixg1o8tujmf/7m0jrKYaDBwEvlc5lo8nt6/6d50a5050d9cdc0d4d2047e35feac292/10648733_696750647079056_2800539603462658695_o.jpg","has_nav":true,"nav_links":[{"label":"Home","url":"/","style":"link","type":"action"},{"label":"About","url":"/about","style":"link","type":"action"},{"label":"关于","url":"https://ggyy.pa-pa.me/about","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"},{"label":"Contact","url":"/contact","style":"link","type":"action"},{"label":"Support Me","url":"/support-me","style":"link","type":"action"},{"label":"叽叽歪歪","url":"https://ggyy.pa-pa.me/","style":"link","icon_class":"lorem-ipsum","new_window":true,"type":"action"}],"has_social":true,"social_links":[{"label":"Twitter","url":"https://twitter.com/zizhujy","style":"icon","icon_class":"fa-twitter","new_window":true,"type":"action"},{"label":"Instagram","url":"https://www.instagram.com/jefftian5","style":"icon","icon_class":"fa-instagram","new_window":true,"type":"action"},{"label":"GitHub","url":"https://github.com/jeff-tian","style":"icon","icon_class":"fa-github","new_window":true,"type":"action"},{"label":"LinkedIn","url":"https://www.linkedin.com/jeff~tian","style":"icon","icon_class":"fa-linkedin","new_window":true,"type":"action"},{"label":"DEV","url":"https://dev.to/jefftian","style":"icon","icon_class":"fa-dev","new_window":true,"type":"action"},{"label":"知乎","url":"https://www.zhihu.com/people/jefftian","style":"icon","icon_class":"fa-zhihu","new_window":true,"type":"action"}],"type":"header"},"footer":{"content":"&copy; All rights reserved.","links":[{"label":"Made with Stackbit.","url":"https://www.stackbit.com","style":"link","new_window":true,"type":"action"},{"label":"紫竹叽歪","url":"https://zizhujy.apphb.com","style":"link","icon_class":"http://zizhujy.apphb.com/Content/Images/logo.png","new_window":true,"type":"action"}],"type":"footer"}},"pathPrefix":"","data":{"data":{"author":{"name":"Jeff Tian","avatar":"https://res.cloudinary.com/practicaldev/image/fetch/s--a5qDZLv3--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/318420/3bfd2d99-430c-4049-8dd5-e2adc961e1e0.png"},"social":{"devto":{"username":"jefftian"},"twitter":{"username":"zizhujy"},"github":{"username":"Jeff-Tian"}}}}},"menus":{}}},"staticQueryHashes":[],"slicesMap":{}}